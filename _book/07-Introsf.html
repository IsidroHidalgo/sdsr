<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.38">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Spatial Data Science - 7&nbsp; Introduction to sf and stars</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./08-Large.html" rel="next">
<link href="./06-Cubes.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Data Science</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./00-part-1.html" class="sidebar-item-text sidebar-link">Spatial Data</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-hello.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting Started</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-Spaces.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Coordinates</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-Geometries.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Geometries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-Spherical.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Spherical Geometries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-Attributes.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Attributes and Support</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./06-part-2.html" class="sidebar-item-text sidebar-link">R for Spatial Data Science</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-Cubes.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Cubes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-Introsf.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-Large.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-Plotting.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Plotting spatial data</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./10-part-3.html" class="sidebar-item-text sidebar-link">Models for Spatial Data</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-Models.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Statistical modelling of spatial data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-PointPattern.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Point Pattern Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-Interpolation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatial Interpolation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-Geostatistics.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Multivariate and Spatiotemporal Geostatistics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-Areal.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Proximity and Areal Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18-SpatialRegression.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Spatial Regression</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30-sp-raster.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Older R Spatial Packages</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./97-allcode.html" class="sidebar-item-text sidebar-link">All R code in this book</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./98-rbascis.html" class="sidebar-item-text sidebar-link">R basics</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">Index</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-sfintro" id="toc-sec-sfintro" class="nav-link active" data-scroll-target="#sec-sfintro"> <span class="header-section-number">7.1</span> Package <code>sf</code></a>
  <ul class="collapse">
  <li><a href="#creation" id="toc-creation" class="nav-link" data-scroll-target="#creation">Creation</a></li>
  <li><a href="#reading-and-writing" id="toc-reading-and-writing" class="nav-link" data-scroll-target="#reading-and-writing">Reading and writing</a></li>
  <li><a href="#subsetting" id="toc-subsetting" class="nav-link" data-scroll-target="#subsetting">Subsetting</a></li>
  <li><a href="#binary-predicates" id="toc-binary-predicates" class="nav-link" data-scroll-target="#binary-predicates">Binary predicates</a></li>
  <li><a href="#tidyverse" id="toc-tidyverse" class="nav-link" data-scroll-target="#tidyverse">tidyverse</a></li>
  </ul></li>
  <li><a href="#spatial-joins" id="toc-spatial-joins" class="nav-link" data-scroll-target="#spatial-joins"> <span class="header-section-number">7.2</span> Spatial joins</a>
  <ul class="collapse">
  <li><a href="#sampling-gridding-interpolating" id="toc-sampling-gridding-interpolating" class="nav-link" data-scroll-target="#sampling-gridding-interpolating">Sampling, gridding, interpolating</a></li>
  </ul></li>
  <li><a href="#package-stars" id="toc-package-stars" class="nav-link" data-scroll-target="#package-stars"> <span class="header-section-number">7.3</span> Package <code>stars</code></a>
  <ul class="collapse">
  <li><a href="#reading-and-writing-raster-data" id="toc-reading-and-writing-raster-data" class="nav-link" data-scroll-target="#reading-and-writing-raster-data">Reading and writing raster data</a></li>
  <li><a href="#subsetting-stars-data-cubes" id="toc-subsetting-stars-data-cubes" class="nav-link" data-scroll-target="#subsetting-stars-data-cubes">Subsetting <code>stars</code> data cubes</a></li>
  <li><a href="#cropping" id="toc-cropping" class="nav-link" data-scroll-target="#cropping">Cropping</a></li>
  <li><a href="#redimensioning-stars-objects" id="toc-redimensioning-stars-objects" class="nav-link" data-scroll-target="#redimensioning-stars-objects">Redimensioning <code>stars</code> objects</a></li>
  <li><a href="#extracting-point-samples-aggregating" id="toc-extracting-point-samples-aggregating" class="nav-link" data-scroll-target="#extracting-point-samples-aggregating">Extracting point samples, aggregating</a></li>
  <li><a href="#predictive-models" id="toc-predictive-models" class="nav-link" data-scroll-target="#predictive-models">Predictive models</a></li>
  <li><a href="#plotting-raster-data" id="toc-plotting-raster-data" class="nav-link" data-scroll-target="#plotting-raster-data">Plotting raster data</a></li>
  <li><a href="#analysing-raster-data" id="toc-analysing-raster-data" class="nav-link" data-scroll-target="#analysing-raster-data">Analysing raster data</a></li>
  <li><a href="#curvilinear-rasters" id="toc-curvilinear-rasters" class="nav-link" data-scroll-target="#curvilinear-rasters">Curvilinear rasters</a></li>
  <li><a href="#gdal-utils" id="toc-gdal-utils" class="nav-link" data-scroll-target="#gdal-utils">GDAL utils</a></li>
  </ul></li>
  <li><a href="#vector-data-cube-examples" id="toc-vector-data-cube-examples" class="nav-link" data-scroll-target="#vector-data-cube-examples"> <span class="header-section-number">7.4</span> Vector data cube examples</a>
  <ul class="collapse">
  <li><a href="#example-aggregating-air-quality-time-series" id="toc-example-aggregating-air-quality-time-series" class="nav-link" data-scroll-target="#example-aggregating-air-quality-time-series">Example: aggregating air quality time series</a></li>
  <li><a href="#example-bristol-origin-destination-datacube" id="toc-example-bristol-origin-destination-datacube" class="nav-link" data-scroll-target="#example-bristol-origin-destination-datacube">Example: Bristol origin-destination datacube</a></li>
  <li><a href="#tidy-array-data" id="toc-tidy-array-data" class="nav-link" data-scroll-target="#tidy-array-data">Tidy array data</a></li>
  </ul></li>
  <li><a href="#sec-raster-to-vector" id="toc-sec-raster-to-vector" class="nav-link" data-scroll-target="#sec-raster-to-vector"> <span class="header-section-number">7.5</span> raster-to-vector, vector-to-raster</a>
  <ul class="collapse">
  <li><a href="#vector-to-raster" id="toc-vector-to-raster" class="nav-link" data-scroll-target="#vector-to-raster">vector-to-raster</a></li>
  </ul></li>
  <li><a href="#sec-projsf" id="toc-sec-projsf" class="nav-link" data-scroll-target="#sec-projsf"> <span class="header-section-number">7.6</span> Coordinate transformations and conversions</a>
  <ul class="collapse">
  <li><a href="#st_crs" id="toc-st_crs" class="nav-link" data-scroll-target="#st_crs"><code>st_crs</code></a></li>
  <li><a href="#st_transform-sf_project" id="toc-st_transform-sf_project" class="nav-link" data-scroll-target="#st_transform-sf_project"><code>st_transform</code>, <code>sf_project</code></a></li>
  <li><a href="#sf_proj_info" id="toc-sf_proj_info" class="nav-link" data-scroll-target="#sf_proj_info"><code>sf_proj_info</code></a></li>
  <li><a href="#proj.db-datum-grids-cdn.proj.org-local-cache" id="toc-proj.db-datum-grids-cdn.proj.org-local-cache" class="nav-link" data-scroll-target="#proj.db-datum-grids-cdn.proj.org-local-cache">proj.db, datum grids, cdn.proj.org, local cache</a></li>
  <li><a href="#sec-pipelines" id="toc-sec-pipelines" class="nav-link" data-scroll-target="#sec-pipelines">Transformation pipelines</a></li>
  <li><a href="#sec-axisorder" id="toc-sec-axisorder" class="nav-link" data-scroll-target="#sec-axisorder">Axis order</a></li>
  </ul></li>
  <li><a href="#sec-warp" id="toc-sec-warp" class="nav-link" data-scroll-target="#sec-warp"> <span class="header-section-number">7.7</span> Transforming and warping rasters</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"> <span class="header-section-number">7.8</span> Exercises</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-sf" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></span></h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>This chapter introduces R packages <code>sf</code> and <code>stars</code>. <code>sf</code> provides a table format for simple features, where feature geometries are carried in a list-column. R package <code>stars</code> was written to support raster and vector datacubes (<a href="06-Cubes.html"><span>Chapter&nbsp;6</span></a>), and has raster data stacks and feature time series as special cases. <code>sf</code> first appeared on CRAN in 2016, <code>stars</code> in 2018. Development of both packages received support from the R Consortium as well as strong community engagement. The packages were designed to work together.</p>
<p>All functions operating on <code>sf</code> or <code>stars</code> objects start with <code>st_</code>, making it easy to recognize them or to search for them when using command line completion.</p>
<section id="sec-sfintro" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="sec-sfintro"><span class="header-section-number">7.1</span> Package <code>sf</code></h2>
<p>Intended to succeed and replace R packages <code>sp</code>, <code>rgeos</code> and the vector parts of <code>rgdal</code>, R package <code>sf</code> <span class="citation" data-cites="rjsf">(<a href="references.html#ref-rjsf" role="doc-biblioref">Pebesma 2018</a>)</span> was developed to move spatial data analysis in R closer to standards-based approaches seen in the industry and open source projects, to build upon more modern versions of the open source geospatial software stack (<a href="01-hello.html#fig-gdal-fig-nodetails">Figure&nbsp;<span>1.7</span></a>), and to allow for integration of R spatial software with the tidyverse if desired.</p>
<p>To do so, R package <code>sf</code> provides simple features access <span class="citation" data-cites="herring2011opengis">(<a href="references.html#ref-herring2011opengis" role="doc-biblioref">Herring et al. 2011</a>)</span>, natively, to R. It provides an interface to several <code>tidyverse</code> packages, in particular to <code>ggplot2</code>, <code>dplyr</code> and <code>tidyr</code>. It can read and write data through GDAL, execute geometrical operations using GEOS (for projected coordinates) or s2geometry (for ellipsoidal coordinates), and carry out coordinate transformations or conversions using PROJ. External C++ libraries are interfaced using <code>Rcpp</code> <span class="citation" data-cites="eddelbuettel2013seamless">(<a href="references.html#ref-eddelbuettel2013seamless" role="doc-biblioref">Eddelbuettel 2013</a>)</span>.</p>
<p>Package <code>sf</code> represents sets of simple features in <code>sf</code> objects, a sub-class of a <code>data.frame</code> or tibble. <code>sf</code> objects contain at least one <em>geometry list-column</em> of class <code>sfc</code>, which for each element contains the geometry as an R object of class <code>sfg</code>. A geometry list-column acts as a variable in a <code>data.frame</code> or tibble, but has a more complex structure than e.g.&nbsp;numeric or character variables. Following the convention of <code>PostGIS</code>, all operations (functions, method) that operate on <code>sf</code> objects or related start with <code>st_</code>.</p>
<p>An <code>sf</code> object has the following meta-data:</p>
<ul>
<li>the name of the (active) geometry column, held in attribute <code>sf_column</code></li>
<li>for each non-geometry variable, the attribute-geometry relationship (<a href="05-Attributes.html#sec-agr"><span>Section&nbsp;5.1</span></a>), held in attribute <code>agr</code></li>
</ul>
<p>An <code>sfc</code> geometry list-column has the following meta-data:</p>
<ul>
<li>the coordinate reference system held in attribute <code>crs</code></li>
<li>the bounding box held in attribute <code>bbox</code></li>
<li>the precision held in attribute <code>precision</code></li>
<li>the number of empty geometries held in attribute <code>n_empty</code></li>
</ul>
<p>These attributes may best be accessed or set by using functions like <code>st_bbox</code>, <code>st_crs</code>, <code>st_set_crs</code>, <code>st_agr</code>, <code>st_set_agr</code>, <code>st_precision</code>, and <code>st_set_precision</code>.</p>
<section id="creation" class="level3">
<h3 class="anchored" data-anchor-id="creation">Creation</h3>
<p>One could create an <code>sf</code> object from scratch e.g.&nbsp;by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Linking to GEOS 3.10.2, GDAL 3.4.3, PROJ 8.2.0; sf_use_s2() is TRUE</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">7.35</span>, <span class="fl">52.42</span>))</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">7.22</span>, <span class="fl">52.18</span>))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">7.44</span>, <span class="fl">52.19</span>))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>sfc <span class="ot">&lt;-</span> <span class="fu">st_sfc</span>(<span class="fu">list</span>(p1, p2, p3), <span class="at">crs =</span> <span class="st">'OGC:CRS84'</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">st_sf</span>(<span class="at">elev =</span> <span class="fu">c</span>(<span class="fl">33.2</span>, <span class="fl">52.1</span>, <span class="fl">81.2</span>), <span class="at">marker =</span> <span class="fu">c</span>(<span class="st">"Id01"</span>, <span class="st">"Id02"</span>, <span class="st">"Id03"</span>),</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">geom =</span> sfc)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple feature collection with 3 features and 2 fields</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Geometry type: POINT</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimension:     XY</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Bounding box:  xmin: 7.22 ymin: 52.2 xmax: 7.44 ymax: 52.4</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Geodetic CRS:  WGS 84</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   elev marker              geom</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 33.2   Id01 POINT (7.35 52.4)</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 52.1   Id02 POINT (7.22 52.2)</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 81.2   Id03 POINT (7.44 52.2)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-sfobj" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/sf_obj.png" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption class="figure-caption">Figure 7.1: components of an <code>sf</code> object</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><a href="#fig-sfobj">Figure&nbsp;<span>7.1</span></a> gives an explanation of the components printed. Rather than creating objects from scratch, spatial data in R are typically read from an external source, which can be:</p>
<ul>
<li>an external file</li>
<li>a request to a web service</li>
<li>a dataset held in some form in another R package</li>
</ul>
<p>The next section introduces reading from files; <a href="08-Large.html#sec-largesf"><span>Section&nbsp;8.1</span></a> discusses handling of datasets too large to fit into working memory.</p>
</section>
<section id="reading-and-writing" class="level3">
<h3 class="anchored" data-anchor-id="reading-and-writing">Reading and writing</h3>
<p>Reading datasets from an external “data source” (file, web service, or even string) is done using <code>st_read</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>(file <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"gpkg/nc.gpkg"</span>, <span class="at">package =</span> <span class="st">"sf"</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "/home/edzer/R/x86_64-pc-linux-gnu-library/4.0/sf/gpkg/nc.gpkg"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>nc <span class="ot">&lt;-</span> <span class="fu">st_read</span>(file)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading layer `nc.gpkg' from data source </span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   `/home/edzer/R/x86_64-pc-linux-gnu-library/4.0/sf/gpkg/nc.gpkg' </span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   using driver `GPKG'</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple feature collection with 100 features and 14 fields</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimension:     XY</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Bounding box:  xmin: -84.3 ymin: 33.9 xmax: -75.5 ymax: 36.6</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Geodetic CRS:  NAD27</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, the file name and path <code>file</code> is read from the <code>sf</code> package, which has a different path on every machine, and hence is guaranteed to be present on every <code>sf</code> installation.</p>
<p>Command <code>st_read</code> has two arguments: the <em>data set name</em> (<code>dsn</code>) and the <em>layer</em>. In the example above, the <em>geopackage</em> (GPKG) file contains only a single layer that is being read. If it had contained multiple layers, then the first layer would have been read and a warning would have been emitted. The available layers of a data set can be queried by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_layers</span>(file)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Driver: GPKG </span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Available layers:</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   layer_name geometry_type features fields crs_name</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 1    nc.gpkg Multi Polygon      100     14    NAD27</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Simple feature objects can be written with <code>st_write</code>, as in</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>(<span class="at">file =</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".gpkg"</span>))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "/tmp/RtmphnKbwU/file75a333a72f063.gpkg"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(nc, file, <span class="at">layer =</span> <span class="st">"layer_nc"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Writing layer `layer_nc' to data source </span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   `/tmp/RtmphnKbwU/file75a333a72f063.gpkg' using driver `GPKG'</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Writing 100 features with 14 fields and geometry type Multi Polygon.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where the file format (GPKG) is derived from the file name extension.</p>
</section>
<section id="subsetting" class="level3">
<h3 class="anchored" data-anchor-id="subsetting">Subsetting</h3>
<p>A very common operation is to subset objects; base R can use <code>[</code> for this. The rules that apply to <code>data.frame</code> objects also apply to <code>sf</code> objects, e.g.&nbsp;that records 2-5 and columns 3-7 are selected by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>nc[<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">3</span><span class="sc">:</span><span class="dv">7</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>but with a few additional features, in particular:</p>
<ul>
<li>the <code>drop</code> argument is by default <code>FALSE</code> meaning that the geometry column is <em>always</em> selected, and an <code>sf</code> object is returned; when it is set to <code>TRUE</code> and the geometry column <em>not</em> selected, it is dropped and a <code>data.frame</code> is returned</li>
<li>selection with a spatial (<code>sf</code>, <code>sfc</code> or <code>sfg</code>) object as first argument leads to selection of the features that spatially <em>intersect</em> with that object (see next section); other predicates than <em>intersects</em> can be chosen by setting parameter <code>op</code> to a function such as <code>st_covers</code> or or any other binary predicate function listed in <a href="03-Geometries.html#sec-de9im"><span>Section&nbsp;3.2.2</span></a></li>
</ul>
</section>
<section id="binary-predicates" class="level3">
<h3 class="anchored" data-anchor-id="binary-predicates">Binary predicates</h3>
<p>Binary predicates like <code>st_intersects</code>, <code>st_covers</code> etc (<a href="03-Geometries.html#sec-de9im"><span>Section&nbsp;3.2.2</span></a>) take two sets of features or feature geometries and return for all pairs whether the predicate is <code>TRUE</code> or <code>FALSE</code>. For large sets this would potentially result in a huge matrix, typically filled mostly with <code>FALSE</code> values and for that reason a sparse representation is returned by default:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>nc5 <span class="ot">&lt;-</span> nc[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, ]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>nc7 <span class="ot">&lt;-</span> nc[<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, ]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>(i <span class="ot">&lt;-</span> <span class="fu">st_intersects</span>(nc5, nc7))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Sparse geometry binary predicate list of length 5, where</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># the predicate was `intersects'</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">#  1: 1, 2</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">#  2: 1, 2, 3</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">#  3: 2, 3</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">#  4: 4, 7</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">#  5: 5, 6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-fig57" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-fig57-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 7.2: First seven North Carolina counties</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><a href="#fig-fig57">Figure&nbsp;<span>7.2</span></a> shows how the intersections of the first five with the first seven counties can be understood. We can transform the sparse logical matrix into a dense matrix by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.matrix</span>(i)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">#       [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># [1,]  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># [2,]  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># [3,] FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># [4,] FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># [5,] FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The number of counties that each of <code>nc5</code> intersects with is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lengths</span>(i)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 2 3 2 2 2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and the other way around, the number of counties in <code>nc5</code> that intersect with each of the counties in <code>nc7</code> is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lengths</span>(<span class="fu">t</span>(i))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 2 3 2 1 1 1 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The object <code>i</code> is of class <code>sgbp</code> (sparse geometrical binary predicate), and is a list of integer vectors, with each element representing a row in the logical predicate matrix holding the column indices of the <code>TRUE</code> values for that row. It further holds some metadata like the predicate used, and the total number of columns. Methods available for <code>sgbp</code> objects include</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">methods</span>(<span class="at">class =</span> <span class="st">"sgbp"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  [1] as.data.frame as.matrix     coerce        dim          </span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  [5] initialize    Ops           print         show         </span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  [9] slotsFromS3   t            </span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># see '?methods' for accessing help and source code</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where the only <code>Ops</code> method available is <code>!</code>, the negation operation.</p>
</section>
<section id="tidyverse" class="level3">
<h3 class="anchored" data-anchor-id="tidyverse">tidyverse</h3>
<p>The tidyverse is a collection of data science packages that work together, described e.g.&nbsp;in <span class="citation" data-cites="r4ds welcome">(<a href="references.html#ref-r4ds" role="doc-biblioref">Wickham and Grolemund 2017</a>; <a href="references.html#ref-welcome" role="doc-biblioref">Wickham et al. 2019</a>)</span>. Package <code>sf</code> has tidyverse-style read and write functions, <code>read_sf</code> and <code>write_sf</code>, which return a tibble rather than a <code>data.frame</code>, do not print any output, and overwrite existing data by default.</p>
<p>Further <code>tidyverse</code> generics with methods for <code>sf</code> objects include <code>filter</code>, <code>select</code>, <code>group_by</code>, <code>ungroup</code>, <code>mutate</code>, <code>transmute</code>, <code>rowwise</code>, <code>rename</code>, <code>slice</code>, <code>summarise</code>, <code>distinct</code>, <code>gather</code>, <code>pivot_longer</code>, <code>spread</code>, <code>nest</code>, <code>unnest</code>, <code>unite</code>, <code>separate</code>, <code>separate_rows</code>, <code>sample_n</code>, and <code>sample_frac</code>. Most of these methods simply manage the metadata of <code>sf</code> objects, and make sure the geometry remains present. In case a user wants the geometry to be removed, one can use <code>st_drop_geometry()</code> or simply coerce to a <code>tibble</code> or <code>data.frame</code> before selecting:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Attaching packages ───────────────────────── tidyverse 1.3.1 ──</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ✔ ggplot2 3.3.6     ✔ purrr   0.3.4</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ✔ tibble  3.1.7     ✔ dplyr   1.0.9</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ✔ tidyr   1.2.0     ✔ stringr 1.4.0</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ✔ readr   2.1.2     ✔ forcats 0.5.1</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ── Conflicts ──────────────────────────── tidyverse_conflicts() ──</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ✖ dplyr::filter() masks stats::filter()</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ✖ dplyr::lag()    masks stats::lag()</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>nc <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(BIR74) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">3</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co"># # A tibble: 3 × 1</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   BIR74</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   &lt;dbl&gt;</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 1  1091</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 2   487</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 3  3188</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>summarise</code> method for <code>sf</code> objects has two special arguments:</p>
<ul>
<li><code>do_union</code> (default <code>TRUE</code>) determines whether grouped geometries are unioned on return, so that they form a valid geometry</li>
<li><code>is_coverage</code> (default <code>FALSE</code>) in case the geometries grouped form a coverage (do not have overlaps), setting this to <code>TRUE</code> speeds up the unioning</li>
</ul>
<p>The <code>distinct</code> method selects distinct records, where <code>st_equals</code> is used to evaluate distinctness of geometries.</p>
<p><code>filter</code> can be used with the usual predicates; when one wants to use it with a spatial predicate, e.g.&nbsp;to select all counties less than 50 km away from Orange county, one could use</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>orange <span class="ot">&lt;-</span> nc <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">"Orange"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>wd <span class="ot">&lt;-</span> <span class="fu">st_is_within_distance</span>(nc, orange, units<span class="sc">::</span><span class="fu">set_units</span>(<span class="dv">50</span>, km))</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>o50 <span class="ot">&lt;-</span> nc <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">lengths</span>(wd) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(o50)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 17</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(where we use <code>dplyr::filter</code> rather than <code>filter</code> to avoid confusion with <code>filter</code> from base R.)</p>
<p><a href="#fig-orangebuffer">Figure&nbsp;<span>7.3</span></a> shows the results of this analysis, and in addition a buffer around the county borders; note that this buffer serves for illustration, it was <em>not</em> used to select the counties.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-orangebuffer" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-orangebuffer-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 7.3: Orange county (orange), counties within a 50 km radius (black), a 50 km buffer around Orange county (brown), and remaining counties (grey)</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="spatial-joins" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="spatial-joins"><span class="header-section-number">7.2</span> Spatial joins</h2>
<p>In regular (left, right or inner) joins, <em>joined</em> records from a pair of tables are reported when one or more selected attributes match (are identical) in both tables. A spatial join is similar, but the criterion to join records is not equality of attributes but a spatial predicate. This leaves a wide variety of options in order to define <em>spatially</em> matching records, using binary predicates listed in <a href="03-Geometries.html#sec-de9im"><span>Section&nbsp;3.2.2</span></a>. The concepts of “left”, “right”, “inner” or “full” joins remain identical to the non-spatial join as the options for handling records that have no spatial match.</p>
<p>When using spatial joins, each record may have several matched records, yielding a large result table. A way to reduce this complexity may be to select from the matching records the one with the largest overlap with the target geometry. An example of this is shown (visually) in <a href="#fig-largest">Figure&nbsp;<span>7.4</span></a> ; this is done using <code>st_join</code> with argument <code>largest = TRUE</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># example of largest = TRUE:</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>nc <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(<span class="fu">read_sf</span>(<span class="fu">system.file</span>(<span class="st">"shape/nc.shp"</span>, <span class="at">package=</span><span class="st">"sf"</span>)), <span class="dv">2264</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">label =</span> <span class="fu">apply</span>(<span class="fu">expand.grid</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, LETTERS[<span class="dv">10</span><span class="sc">:</span><span class="dv">1</span>])[,<span class="dv">2</span><span class="sc">:</span><span class="dv">1</span>], <span class="dv">1</span>, paste0, <span class="at">collapse =</span> <span class="st">" "</span>),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">geom =</span> <span class="fu">st_make_grid</span>(nc))</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>gr<span class="sc">$</span>col <span class="ot">&lt;-</span> <span class="fu">sf.colors</span>(<span class="dv">10</span>, <span class="at">categorical =</span> <span class="cn">TRUE</span>, <span class="at">alpha =</span> .<span class="dv">3</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># cut, to check, NA's work out:</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>gr <span class="ot">&lt;-</span> gr[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>),]</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressWarnings</span>(nc_j <span class="ot">&lt;-</span> <span class="fu">st_join</span>(nc, gr, <span class="at">largest =</span> <span class="cn">TRUE</span>))</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co"># the two datasets:</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>opar <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>), <span class="at">mar =</span> <span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(nc_j))</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(gr), <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">col =</span> gr<span class="sc">$</span>col)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="fu">st_coordinates</span>(<span class="fu">st_centroid</span>(<span class="fu">st_geometry</span>(gr))), <span class="at">labels =</span> gr<span class="sc">$</span>label)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co"># the joined dataset:</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(nc_j), <span class="at">border =</span> <span class="st">'black'</span>, <span class="at">col =</span> nc_j<span class="sc">$</span>col)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="fu">st_coordinates</span>(<span class="fu">st_centroid</span>(<span class="fu">st_geometry</span>(nc_j))), <span class="at">labels =</span> nc_j<span class="sc">$</span>label, <span class="at">cex =</span> .<span class="dv">8</span>)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(gr), <span class="at">border =</span> <span class="st">'green'</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(opar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-largest" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-largest-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure 7.4: example of <code>st_join</code> with <code>largest = TRUE</code>: the label of the polygon in the top figure with the largest intersection with polygons in the bottom figure is assigned to the polygons of the bottom figure.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Another way to reduce the result set is to use <code>aggregate</code> after a join, all matching records, and union their geometries; see <a href="05-Attributes.html#sec-updownscaling"><span>Section&nbsp;5.4</span></a>.</p>
<section id="sampling-gridding-interpolating" class="level3">
<h3 class="anchored" data-anchor-id="sampling-gridding-interpolating">Sampling, gridding, interpolating</h3>
<p>Several convenience functions are available in package <code>sf</code>, some of which will be discussed here. Function <code>st_sample</code> generates a sample of points randomly sampled from target geometries, where target geometries can be point, line or polygon geometries. Sampling strategies can be (completely) random, regular or (with polygons) triangular. <a href="13-PointPattern.html"><span>Chapter&nbsp;11</span></a> explains how spatial sampling (or point pattern simulation) methods available in package <code>spatstat</code> are interfaced through <code>st_sample</code>.</p>
<p>Function <code>st_make_grid</code> creates a square, rectangular or hexagonal grid over a region, or points with the grid centers or corners. It was used to create the rectangular grid in <a href="#fig-largest">Figure&nbsp;<span>7.4</span></a> .</p>
<p>Function <code>st_interpolate_aw</code> “interpolates” area values to new areas, as explained in <a href="05-Attributes.html#sec-area-weighted"><span>Section&nbsp;5.3</span></a>, both for intensive and extensive variables.</p>
</section>
</section>
<section id="package-stars" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="package-stars"><span class="header-section-number">7.3</span> Package <code>stars</code></h2>
<p>Although package <code>sp</code> has always had limited support for raster data, over the last decade R package <code>raster</code> <span class="citation" data-cites="R-raster">(<a href="references.html#ref-R-raster" role="doc-biblioref">Hijmans 2022a</a>)</span> has clearly been dominant as the prime package for powerful, flexible and scalable raster analysis. The raster data model of package <code>raster</code> (and its successor, <code>terra</code> <span class="citation" data-cites="R-terra">(<a href="references.html#ref-R-terra" role="doc-biblioref">Hijmans 2022b</a>)</span>) is that of a 2D regular raster, or a set of raster layers (a “raster stack”). This aligns with the classical static “GIS world view”, where the world is modelled as a set of layers, each representing a different theme. A lot of data available today however is dynamic, and comes as time series of rasters or raster stacks. A raster stack does not meaningfully reflect this, requiring the user to keep a register of which layer represents what.</p>
<p>Also, the <code>raster</code> package, and its successor <code>terra</code> do an excellent job in scaling computations up to data sizes no larger than the local storage (the computer’s hard drives), and doing this fast. Recent datasets however, including satellite imagery, climate model or weather forecasting data, often no longer fit in local storage (<a href="08-Large.html"><span>Chapter&nbsp;8</span></a>). Package <code>spacetime</code> <span class="citation" data-cites="spacetime2012">(<a href="references.html#ref-spacetime2012" role="doc-biblioref">Pebesma 2012</a>)</span> addresses the analysis of time series of vector geometries or raster grid cells, but does not extend to higher-dimensional arrays.</p>
<p>Here, we introduce package <code>stars</code> for analysing raster and vector data cubes. The package:</p>
<ul>
<li>allows for representing dynamic (time varying) raster stacks</li>
<li>aims at being scalable, also beyond local disk size</li>
<li>provides a strong integration of raster functions in the GDAL library</li>
<li>in addition to regular grids handles rotated, sheared, rectilinear and curvilinear rasters (<a href="01-hello.html#fig-rastertypes01">Figure&nbsp;<span>1.6</span></a>)</li>
<li>provides a tight integration with package <code>sf</code></li>
<li>also handles array data with non-raster spatial dimensions, the <em>vector data cubes</em></li>
<li>follows the tidyverse design principles</li>
</ul>
<p>Vector data cubes include for instance time series for simple features, or spatial graph data such as potentially dynamic origin-destination matrices. The concept of spatial vector and raster data cubes was explained in <a href="06-Cubes.html"><span>Chapter&nbsp;6</span></a>.</p>
<section id="reading-and-writing-raster-data" class="level3">
<h3 class="anchored" data-anchor-id="reading-and-writing-raster-data">Reading and writing raster data</h3>
<p>Raster data typically are read from a file. We use a dataset containing a section of Landsat 7 scene, with the 6 30m-resolution bands (bands 1-5 and 7) for a region covering the city of Olinda, Brazil. We can read the example GeoTIFF file holding a regular, non-rotated grid from the package <code>stars</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>tif <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"tif/L7_ETMs.tif"</span>, <span class="at">package =</span> <span class="st">"stars"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Loading required package: abind</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>(r <span class="ot">&lt;-</span> <span class="fu">read_stars</span>(tif))</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif     1      54     69 68.9      86  255</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to  offset delta            refsys point values x/y</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># x       1 349  288776  28.5 SIRGAS 2000 / ... FALSE   NULL [x]</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE   NULL [y]</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"># band    1   6      NA    NA                NA    NA   NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where we see the offset, cell size, coordinate reference system, and dimensions. The dimension table reports the following for each dimension:</p>
<ul>
<li><code>from</code>: the starting index</li>
<li><code>to</code>: the ending index</li>
<li><code>offset</code>: the dimension value at the start (edge) of the first pixel</li>
<li><code>delta</code>: the cell size; negative <code>delta</code> values indicate that pixel index increases with decreasing dimension values</li>
<li><code>refsys</code>: the reference system</li>
<li><code>point</code>: boolean, indicating whether cell values have point support or cell support</li>
<li><code>values</code>: a list with values or labels associated with each of the dimension’s values</li>
<li><code>x/y</code>: an indicator whether a dimension is associated with a spatial raster x- or y-axis</li>
</ul>
<p>For regular, rotated or sheared grids or other regularly discretized dimensions (e.g.&nbsp;time), <code>offset</code> and <code>delta</code> are not <code>NA</code> and <code>values</code> is <code>NULL</code>; for other cases, <code>offset</code> and <code>delta</code> are <code>NA</code> and <code>values</code> contains one of:</p>
<ul>
<li>the sequence of values, or intervals, in case of a rectlinear spatial raster or irregular time dimension</li>
<li>in case of a vector data cube, geometries associated with the spatial dimension</li>
<li>in case of a curvilinear raster, the matrix with coordinate values for each raster cell</li>
<li>in case of a discrete dimension, the band names or labels associated with the dimension values</li>
</ul>
<p>The object <code>r</code> is of class <code>stars</code> and is a simple list of length one, holding a three-dimensional array:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(r)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 1</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(r[[<span class="dv">1</span>]])</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "array"</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(r[[<span class="dv">1</span>]])</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">#    x    y band </span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">#  349  352    6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and in addition holds an attribute with a dimensions table with all the metadata required to know what the array dimensions refer to, obtained by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_dimensions</span>(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can get the spatial extent of the array by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_bbox</span>(r)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">#    xmin    ymin    xmax    ymax </span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  288776 9110729  298723 9120761</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Raster data can be written to local disk using <code>write_stars</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>tf <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".tif"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stars</span>(r, tf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where again the data format (in this case, GeoTIFF) is derived from the file extension. As for simple features, reading and writing uses the GDAL library; the list of available drivers for raster data is obtained by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_drivers</span>(<span class="st">"raster"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="subsetting-stars-data-cubes" class="level3">
<h3 class="anchored" data-anchor-id="subsetting-stars-data-cubes">Subsetting <code>stars</code> data cubes</h3>
<p>Data cubes can be subsetted using <code>[</code>, or using tidyverse verbs. The first options, <code>[</code> uses for the arguments: attributes first, followed by dimension. This means that <code>r[1:2, 101:200, , 5:10]</code> selects from <code>r</code> attributes 1-2, index 101-200 for dimension 1, and index 5-10 for dimension 3; omitting dimension 2 means that no subsetting takes place. For attributes, attributes names or logical vectors can be used. For dimensions, logical vectors are not supported; Selecting discontinuous ranges supported when it is a regular sequence. By default, <code>drop</code> is FALSE, when set to <code>TRUE</code> dimensions with a single value are dropped:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>r[,<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">250</span>, <span class="dv">5</span>), <span class="dv">4</span>] <span class="sc">|&gt;</span> <span class="fu">dim</span>()</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">#    x    y band </span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  100   50    1</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>r[,<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">250</span>, <span class="dv">5</span>), <span class="dv">4</span>, drop <span class="ot">=</span> <span class="cn">TRUE</span>] <span class="sc">|&gt;</span> <span class="fu">dim</span>()</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   x   y </span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 100  50</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For selecting particular ranges of dimension <em>values</em>, one can use <code>filter</code> (after loading <code>dplyr</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(r, x <span class="sc">&gt;</span> <span class="dv">289000</span>, x <span class="sc">&lt;</span> <span class="dv">290000</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif     5      51     63 64.3      75  242</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to  offset delta            refsys point values x/y</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"># x       1  35  289004  28.5 SIRGAS 2000 / ... FALSE   NULL [x]</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE   NULL [y]</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co"># band    1   6       1     1                NA    NA   NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which changes the offset of the <span class="math inline">\(x\)</span> dimension. Particular cube slices can also be obtained with <code>slice</code>, e.g.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">slice</span>(r, band, <span class="dv">3</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif    21      49     63 64.4      77  255</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   from  to  offset delta            refsys point values x/y</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># x    1 349  288776  28.5 SIRGAS 2000 / ... FALSE   NULL [x]</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co"># y    1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE   NULL [y]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which drops the singular dimension. <code>mutate</code> can be used on <code>stars</code> objects to add new arrays as functions of existing ones, <code>transmute</code> drops existing ones.</p>
</section>
<section id="cropping" class="level3">
<h3 class="anchored" data-anchor-id="cropping">Cropping</h3>
<p>Further subsetting can be done using spatial objects of class <code>sf</code>, <code>sfc</code> or <code>bbox</code>, e.g.&nbsp;when using the sample raster,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(r) <span class="sc">|&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_centroid</span>() <span class="sc">|&gt;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_buffer</span>(units<span class="sc">::</span><span class="fu">set_units</span>(<span class="dv">500</span>, m))</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>r[b]</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max. NA's</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif    22      54     66 67.7    78.2  174 2184</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to  offset delta            refsys point values x/y</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co"># x     157 193  288776  28.5 SIRGAS 2000 / ... FALSE   NULL [x]</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co"># y     159 194 9120761 -28.5 SIRGAS 2000 / ... FALSE   NULL [y]</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co"># band    1   6      NA    NA                NA    NA   NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>selects the circular center region with a diameter of 500 metre, for the first band shown in <a href="#fig-circr">Figure&nbsp;<span>7.5</span></a> ,</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-circr" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-circr-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Figure 7.5: circular center region of the Landsat 7 scene (band 1)</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>where we see that pixels outside the spatial object are assigned <code>NA</code> values. This object still has dimension indexes relative to the <code>offset</code> and <code>delta</code> values of <code>r</code>; we can reset these to a new <code>offset</code> with</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>r[b] <span class="sc">|&gt;</span> <span class="fu">st_normalize</span>() <span class="sc">|&gt;</span> <span class="fu">st_dimensions</span>()</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co">#      from to  offset delta            refsys point values x/y</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># x       1 37  293222  28.5 SIRGAS 2000 / ... FALSE   NULL [x]</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># y       1 36 9116258 -28.5 SIRGAS 2000 / ... FALSE   NULL [y]</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># band    1  6      NA    NA                NA    NA   NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By default, the resulting raster is cropped to the extent of the selection object; an object with the same dimensions as the input object is obtained with</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>r[b, crop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.   NA's</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif    22      54     66 67.7    78.2  174 731280</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to  offset delta            refsys point values x/y</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># x       1 349  288776  28.5 SIRGAS 2000 / ... FALSE   NULL [x]</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE   NULL [y]</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># band    1   6      NA    NA                NA    NA   NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Cropping a <code>stars</code> object can alternatively be done directly with <code>st_crop</code>, as in</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crop</span>(r, b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="redimensioning-stars-objects" class="level3">
<h3 class="anchored" data-anchor-id="redimensioning-stars-objects">Redimensioning <code>stars</code> objects</h3>
<p>Package <code>stars</code> uses package <code>abind</code> <span class="citation" data-cites="R-abind">(<a href="references.html#ref-R-abind" role="doc-biblioref">Plate and Heiberger 2016</a>)</span> for a number of array manipulations. One of them is <code>aperm</code> which transposes an array by permuting it. A method for <code>stars</code> objects is provided, and</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">aperm</span>(r, <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif     1      54     69 68.9      86  255</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to  offset delta            refsys point values x/y</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co"># band    1   6      NA    NA                NA    NA   NULL    </span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co"># x       1 349  288776  28.5 SIRGAS 2000 / ... FALSE   NULL [x]</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE   NULL [y]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>permutes the order of dimensions of the resulting object.</p>
<p>Attributes and dimensions can be swapped, using <code>split</code> and <code>merge</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>(rs <span class="ot">&lt;-</span> <span class="fu">split</span>(r))</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 2 dimensions and 6 attributes</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># X1    47      67     78 79.1      89  255</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># X2    32      55     66 67.6      79  255</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># X3    21      49     63 64.4      77  255</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co"># X4     9      52     63 59.2      75  255</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co"># X5     1      63     89 83.2     112  255</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co"># X6     1      32     60 60.0      88  255</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   from  to  offset delta            refsys point values x/y</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co"># x    1 349  288776  28.5 SIRGAS 2000 / ... FALSE   NULL [x]</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co"># y    1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE   NULL [y]</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="fu">merge</span>(rs)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="co">#                    Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="co"># X1.X2.X3.X4.X5.X6     1      54     69 68.9      86  255</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="co">#            from  to  offset delta            refsys point</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="co"># x             1 349  288776  28.5 SIRGAS 2000 / ... FALSE</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="co"># y             1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="co"># attributes    1   6      NA    NA                NA    NA</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a><span class="co">#               values x/y</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="co"># x               NULL [x]</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="co"># y               NULL [y]</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="co"># attributes X1,...,X6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>split distributes the <code>band</code> dimension over 6 attributes of a 2-dimensional array, <code>merge</code> reverses this operation. <code>st_redimension</code> can be used for more generic operations, such as splitting a single array dimension over two new dimensions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_redimension</span>(r, <span class="fu">c</span>(<span class="dv">349</span>, <span class="dv">352</span>, <span class="dv">3</span>, <span class="dv">2</span>))</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 4 dimensions and 1 attribute</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif     1      54     69 68.9      86  255</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">#    from  to  offset delta            refsys point values</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co"># X1    1 349  288776  28.5 SIRGAS 2000 / ... FALSE   NULL</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># X2    1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE   NULL</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co"># X3    1   3      NA    NA                NA    NA   NULL</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co"># X4    1   2      NA    NA                NA    NA   NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="extracting-point-samples-aggregating" class="level3">
<h3 class="anchored" data-anchor-id="extracting-point-samples-aggregating">Extracting point samples, aggregating</h3>
<p>A very common use case for raster data cube analysis is the extraction of values at certain locations, or computing aggregations over certain geometries. <code>st_extract</code> extracts point values. We will do this for a few randomly sampled points over the bounding box of <code>r</code>:</p>
<div class="cell">

</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>pts <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(r) <span class="sc">|&gt;</span> <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> <span class="fu">st_sample</span>(<span class="dv">20</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>(e <span class="ot">&lt;-</span> <span class="fu">st_extract</span>(r, pts))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif    12    41.8     63   61    80.5  145</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co">#          from to offset delta            refsys point</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co"># geometry    1 20     NA    NA SIRGAS 2000 / ...  TRUE</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co"># band        1  6     NA    NA                NA    NA</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                     values</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co"># geometry POINT (293002 9115516),...,POINT (290941 9114128)</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co"># band                                                  NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which results in a vector data cube with 20 points and 6 bands.</p>
<p>Another way of extracting information from data cubes is by aggregating it. One way of doing is by spatial aggregation, e.g.&nbsp;to values for spatial polygons or lines (<a href="06-Cubes.html#sec-vectordatacubes"><span>Section&nbsp;6.4</span></a>). We can for instance compute the maximum pixel value for each band for each of the circles shown in figure <a href="01-hello.html#fig-ras">Figure&nbsp;<span>1.4</span></a> (d) by</p>
<div class="cell">

</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>circles <span class="ot">&lt;-</span> <span class="fu">st_sample</span>(<span class="fu">st_as_sfc</span>(<span class="fu">st_bbox</span>(r)), <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_buffer</span>(<span class="dv">500</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">aggregate</span>(r, circles, max)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif    73    94.2    117  121     142  205</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">#          from to offset delta            refsys point</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co"># geometry    1  3     NA    NA SIRGAS 2000 / ... FALSE</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co"># band        1  6     NA    NA                NA    NA</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                                                                  values</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co"># geometry POLYGON ((291330 9114499, 2..., POLYGON ((290519 9119219, 2..., POLYGON ((292193 9116038, 2...</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co"># band                                                                                               NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which gives a data cube with 3 geometries and 6 bands. Aggregation over a temporal dimension is done by passing a time variable as the second argument to <code>aggregate</code>, as</p>
<ul>
<li>a set of time stamps indicating the start of time intervals or</li>
<li>a time period like <code>"weeks"</code>, <code>"5 days"</code> or <code>"years"</code></li>
</ul>
</section>
<section id="predictive-models" class="level3">
<h3 class="anchored" data-anchor-id="predictive-models">Predictive models</h3>
<p>The typical model prediction workflow in R is as follows:</p>
<ul>
<li>use a <code>data.frame</code> with response and predictor variables (covariates)</li>
<li>create a model object based on this <code>data.frame</code></li>
<li>call <code>predict</code> with this model object and the <code>data.frame</code> with target predictor variable values</li>
</ul>
<p>Package <code>stars</code> provides a <code>predict</code> method for <code>stars</code> objects that essentially wraps the last step, by creating the <code>data.frame</code>, calling the <code>predict</code> method for that, and reconstructing a <code>stars</code> object with the predicted values.</p>
<p>We will illustrate this with a trivial two-class example mapping land from sea in the example Landsat data set, using the sample points extracted above, shown in <a href="#fig-rsample">Figure&nbsp;<span>7.6</span></a> .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r[,,,<span class="dv">1</span>], <span class="at">reset =</span> <span class="cn">FALSE</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>col <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">"green"</span>, <span class="dv">20</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>col[<span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">14</span>, <span class="dv">15</span>, <span class="dv">18</span>, <span class="dv">19</span>)] <span class="ot">=</span> <span class="st">"red"</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">st_as_sf</span>(e) <span class="sc">|&gt;</span> <span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span> <span class="fu">text</span>(<span class="at">labels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">col =</span> col)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-rsample" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-rsample-1.png" style="height:80.0%" width="672" class="figure-img"></p>
<p></p><figcaption class="figure-caption">Figure 7.6: randomly chosen sample locations for training data; red: water, green: land</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>From this figure, we read “by eye” that the points 8, 14, 15, 18 and 19 are on water, the others on land. Using a linear discriminant (“maximum likelihood”) classifier, we find model predictions as shown in <a href="#fig-lda">Figure&nbsp;<span>7.7</span></a> .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>rs <span class="ot">&lt;-</span> <span class="fu">split</span>(r)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>trn <span class="ot">&lt;-</span> <span class="fu">st_extract</span>(rs, pts)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>trn<span class="sc">$</span>cls <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">"land"</span>, <span class="dv">20</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>trn<span class="sc">$</span>cls[<span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">14</span>, <span class="dv">15</span>, <span class="dv">18</span>, <span class="dv">19</span>)] <span class="ot">=</span> <span class="st">"water"</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">lda</span>(cls <span class="sc">~</span> ., <span class="fu">st_drop_geometry</span>(trn))</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>pr <span class="ot">&lt;-</span> <span class="fu">predict</span>(rs, model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, we used the <code>MASS::</code> prefix to avoid loading <code>MASS</code>, as that would mask <code>select</code> from <code>dplyr</code>. Another way would be to load <code>MASS</code> and unload it later on with <code>detach()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pr[<span class="dv">1</span>], <span class="at">key.pos =</span> <span class="dv">4</span>, <span class="at">key.width =</span> <span class="fu">lcm</span>(<span class="fl">3.5</span>), <span class="at">key.length =</span> <span class="fu">lcm</span>(<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-lda" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-lda-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Figure 7.7: Linear discriminant classifier for land/water, based on training data of <a href="#fig-rsample">Figure&nbsp;<span>7.6</span></a></figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>We also see that the layer plotted in <a href="#fig-lda">Figure&nbsp;<span>7.7</span></a> is a <code>factor</code> variable, with class labels.</p>
</section>
<section id="plotting-raster-data" class="level3">
<h3 class="anchored" data-anchor-id="plotting-raster-data">Plotting raster data</h3>
<p>We can use the base <code>plot</code> method for <code>stars</code> objects, where the plot created with <code>plot(r)</code> is shown in <a href="#fig-firststars">Figure&nbsp;<span>7.8</span></a> .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-firststars" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-firststars-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 7.8: six 30m Landsat bands downsampled to 90m for Olinda, Br.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>is shown in <a href="#fig-firststars">Figure&nbsp;<span>7.8</span></a> . The default color scale uses grey tones, and stretches these such that color breaks correspond to data quantiles over all bands (“histogram equalization”). A more familiar view is the RGB or false color composite shown in <a href="#fig-starsrgb">Figure&nbsp;<span>7.9</span></a> .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r, <span class="at">rgb =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="at">reset =</span> <span class="cn">FALSE</span>, <span class="at">main =</span> <span class="st">"RGB"</span>)    <span class="co"># rgb</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r, <span class="at">rgb =</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>), <span class="at">main =</span> <span class="st">"False color (NIR-R-G)"</span>) <span class="co"># false color</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-starsrgb" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-starsrgb-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption class="figure-caption">Figure 7.9: two color composites</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Further details and options are given in <a href="09-Plotting.html"><span>Chapter&nbsp;9</span></a>.</p>
</section>
<section id="analysing-raster-data" class="level3">
<h3 class="anchored" data-anchor-id="analysing-raster-data">Analysing raster data</h3>
<p>Element-wise mathematical functions (<a href="06-Cubes.html#sec-applydimension"><span>Section&nbsp;6.3.2</span></a>) on <code>stars</code> objects are just passed on to the arrays. This means that we can call functions and create expressions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">log</span>(r)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif     0    3.99   4.23 4.12    4.45 5.54</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to  offset delta            refsys point values x/y</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># x       1 349  288776  28.5 SIRGAS 2000 / ... FALSE   NULL [x]</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE   NULL [y]</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co"># band    1   6      NA    NA                NA    NA   NULL</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>r <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">log</span>(r)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif     1      62   77.5 77.1    94.9  266</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to  offset delta            refsys point values x/y</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="co"># x       1 349  288776  28.5 SIRGAS 2000 / ... FALSE   NULL [x]</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE   NULL [y]</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co"># band    1   6      NA    NA                NA    NA   NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>or even mask out certain values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>r2 <span class="ot">&lt;-</span> r</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>r2[r <span class="sc">&lt;</span> <span class="dv">50</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>r2</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.   NA's</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif    50      64     75   79      90  255 149170</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to  offset delta            refsys point values x/y</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co"># x       1 349  288776  28.5 SIRGAS 2000 / ... FALSE   NULL [x]</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE   NULL [y]</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co"># band    1   6      NA    NA                NA    NA   NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>or un-mask areas:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>r2[<span class="fu">is.na</span>(r2)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>r2</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif     0      54     69   63      86  255</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to  offset delta            refsys point values x/y</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="co"># x       1 349  288776  28.5 SIRGAS 2000 / ... FALSE   NULL [x]</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co"># y       1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE   NULL [y]</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co"># band    1   6      NA    NA                NA    NA   NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Dimension-wise, we can apply functions to selected array dimensions (<a href="06-Cubes.html#sec-reducedimension"><span>Section&nbsp;6.3.3</span></a>)) of stars objects similar to how <code>apply</code> does this to arrays. For instance, we can compute for each pixel the mean of the 6 band values by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_apply</span>(r, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), mean)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">#       Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co"># mean  25.5    53.3   68.3 68.9      82  255</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   from  to  offset delta            refsys point values x/y</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co"># x    1 349  288776  28.5 SIRGAS 2000 / ... FALSE   NULL [x]</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co"># y    1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE   NULL [y]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A more meaningful function would e.g.&nbsp;compute the NDVI (normalized differenced vegetation index):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>ndvi <span class="ot">&lt;-</span> <span class="cf">function</span>(b1, b2, b3, b4, b5, b6) (b4 <span class="sc">-</span> b3)<span class="sc">/</span>(b4 <span class="sc">+</span> b3)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_apply</span>(r, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), ndvi)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co">#         Min. 1st Qu.  Median    Mean 3rd Qu.  Max.</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ndvi  -0.753  -0.203 -0.0687 -0.0643   0.187 0.587</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   from  to  offset delta            refsys point values x/y</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co"># x    1 349  288776  28.5 SIRGAS 2000 / ... FALSE   NULL [x]</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co"># y    1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE   NULL [y]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Alternatively, one could have defined</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>ndvi2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) (x[<span class="dv">4</span>]<span class="sc">-</span>x[<span class="dv">3</span>])<span class="sc">/</span>(x[<span class="dv">4</span>]<span class="sc">+</span>x[<span class="dv">3</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which is more convenient if the number of bands is large, but which is also much slower than <code>ndvi</code> as it needs to be called for every pixel whereas <code>ndvi</code> can be called once for all pixels, or for large chunks of pixels. The mean for each band over the whole image is computed by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">st_apply</span>(r, <span class="fu">c</span>(<span class="st">"band"</span>), mean))</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   band mean</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1    1 79.1</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2    2 67.6</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 3    3 64.4</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 4    4 59.2</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 5    5 83.2</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 6    6 60.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>the result of which is small enough to be printed here as a <code>data.frame</code>. In these two examples, entire dimensions disappear. Sometimes, this does not happen (<a href="06-Cubes.html#sec-applydimension"><span>Section&nbsp;6.3.2</span></a>); we can for instance compute the three quartiles for each band</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_apply</span>(r, <span class="fu">c</span>(<span class="st">"band"</span>), quantile, <span class="fu">c</span>(.<span class="dv">25</span>, .<span class="dv">5</span>, .<span class="dv">75</span>))</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif    32    60.8   66.5 69.8    78.8  112</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co">#          from to offset delta refsys point        values</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="co"># quantile    1  3     NA    NA     NA    NA 25%, 50%, 75%</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="co"># band        1  6     NA    NA     NA    NA          NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and see that this <em>creates</em> a new dimension, <code>quantile</code>, with three values. Alternatively, the three quantiles over the 6 bands for each pixel are obtained by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_apply</span>(r, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), quantile, <span class="fu">c</span>(.<span class="dv">25</span>, .<span class="dv">5</span>, .<span class="dv">75</span>))</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif     4      55   69.2 67.2    81.2  255</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co">#          from  to  offset delta            refsys point</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co"># quantile    1   3      NA    NA                NA    NA</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="co"># x           1 349  288776  28.5 SIRGAS 2000 / ... FALSE</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="co"># y           1 352 9120761 -28.5 SIRGAS 2000 / ... FALSE</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="co">#                 values x/y</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="co"># quantile 25%, 50%, 75%    </span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="co"># x                 NULL [x]</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="co"># y                 NULL [y]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="curvilinear-rasters" class="level3">
<h3 class="anchored" data-anchor-id="curvilinear-rasters">Curvilinear rasters</h3>
<p>There are several reasons why non-regular rasters occur (<a href="01-hello.html#fig-rastertypes01">Figure&nbsp;<span>1.6</span></a>). For one, when the data is Earth-bound, a regular raster does not fit the Earth’s surface, which is curved. Other reasons are:</p>
<ul>
<li>when we convert or transform a regular raster data into another coordinate reference system, it will become curvilinear unless we resample (warp; <a href="#sec-warp"><span>Section&nbsp;7.7</span></a>); warping always goes at the cost of some loss of data and is not reversible</li>
<li>observation may lead to irregular rasters; e.g.&nbsp;for satellite swaths, we may have a regular raster in the direction of the satellite (not aligned with <span class="math inline">\(x\)</span> or <span class="math inline">\(y\)</span>), and rectilinear in the direction perpendicular to that (e.g.&nbsp;if the sensor discretizes the viewing <em>angle</em> in equal sections)</li>
</ul>
</section>
<section id="gdal-utils" class="level3">
<h3 class="anchored" data-anchor-id="gdal-utils">GDAL utils</h3>
<p>The GDAL library is typically shipped with a number of executable binaries, the GDAL command line utilities for data translation and processing. A package like <code>gdalUtils</code> <span class="citation" data-cites="R-gdalUtils">(<a href="references.html#ref-R-gdalUtils" role="doc-biblioref">Greenberg and Mattiuzzi 2020</a>)</span> provides R functions that actually call these binaries, using R’s <code>system()</code> call mechanism. This requires that these binaries are properly installed, and findable by R, which is something that an R package by itself cannot guarantee.</p>
<p>Several of these utilities (all except for those written in Python) are also available as C functions in the GDAL library, through the “GDAL Algorithms C API”. If an R package like <code>sf</code> that links to the GDAL library uses these C API algorithms, it means that the user no longer needs to install any GDAL binary command line utilities in addition to the R package.</p>
<p>Package <code>sf</code> allows calling these C API algorithms through function <code>gdal_utils()</code>, where the first argument is the name of the utility (stripped from the <code>gdal</code> prefix):</p>
<ul>
<li><code>info</code> prints information on GDAL (raster) datasets</li>
<li><code>warp</code> warps a raster to a new raster, possibly in another CRS</li>
<li><code>rasterize</code> rasterizes a vector dataset</li>
<li><code>translate</code> translates a raster file to another format</li>
<li><code>vectortranslate</code> (for ogr2ogr) translates a vector file to another format</li>
<li><code>buildvrt</code> creates a virtual raster tile (a raster created from several files)</li>
<li><code>demprocessing</code> does varios processing steps of digital elevation models (dems)</li>
<li><code>nearblack</code> converts nearly black/white borders to black</li>
<li><code>grid</code> creates a regular grid from scattered data</li>
<li><code>mdiminfo</code> prints information on a multidimensional array</li>
<li><code>mdimtranslate</code> translates a multidimensional array into another format</li>
</ul>
<p>These utilities work on files, and not not directly on <code>sf</code> or <code>stars</code> objects. However, <code>stars_proxy</code> objects are essentially pointers to files, and other objects can be written to file. Several of these utilities are (always or optionally) used, e.g.&nbsp;by <code>st_mosaic</code>, <code>st_warp</code> or <code>st_write</code>.</p>
</section>
</section>
<section id="vector-data-cube-examples" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="vector-data-cube-examples"><span class="header-section-number">7.4</span> Vector data cube examples</h2>
<section id="example-aggregating-air-quality-time-series" class="level3">
<h3 class="anchored" data-anchor-id="example-aggregating-air-quality-time-series">Example: aggregating air quality time series</h3>
<p>Air quality data from package <code>spacetime</code> were obtained from the <a href="https://www.eea.europa.eu/data-and-maps/data/aqereporting-8">airBase European air quality data base</a>. Daily average PM<span class="math inline">\(_{10}\)</span> values were downloaded for rural background stations in Germany, 1998-2009.</p>
<p>We can create a <code>stars</code> object from the <code>air</code> matrix, the <code>dates</code> Date vector and the <code>stations</code> <code>SpatialPoints</code> objects by</p>
<div class="cell">

</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spacetime)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(air) <span class="co"># this loads several datasets in .GlobalEnv</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(air)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co"># space  time </span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co">#    70  4383</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">st_dimensions</span>(<span class="at">station =</span> <span class="fu">st_as_sfc</span>(stations), <span class="at">time =</span> dates)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>(aq <span class="ot">&lt;-</span> <span class="fu">st_as_stars</span>(<span class="fu">list</span>(<span class="at">PM10 =</span> air), <span class="at">dimensions =</span> d))</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="co">#       Min. 1st Qu. Median Mean 3rd Qu. Max.   NA's</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="co"># PM10     0    9.92   14.8 17.7      22  274 157659</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="co">#         from   to     offset  delta            refsys point</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="co"># station    1   70         NA     NA +proj=longlat ...  TRUE</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="co"># time       1 4383 1998-01-01 1 days              Date FALSE</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="co">#                                          values</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="co"># station POINT (9.59 53.7),...,POINT (9.45 49.2)</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="co"># time                                       NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see from <a href="#fig-airst">Figure&nbsp;<span>7.10</span></a> that the time series are quite long, but also have large missing value gaps. <a href="#fig-airmap">Figure&nbsp;<span>7.11</span></a> shows the spatial distribution measurement stations and mean PM<span class="math inline">\(_{10}\)</span> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(<span class="fu">aperm</span>(<span class="fu">log</span>(aq), <span class="dv">2</span><span class="sc">:</span><span class="dv">1</span>), <span class="at">main =</span> <span class="st">"NA pattern (white) in PM10 station time series"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-airst" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-airst-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 7.10: space-time diagram of PM<span class="math inline">\(_{10}\)</span> measurements by time and station</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_as_sf</span>(<span class="fu">st_apply</span>(aq, <span class="dv">1</span>, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), <span class="at">reset =</span> <span class="cn">FALSE</span>, <span class="at">pch =</span> <span class="dv">16</span>,</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">st_bbox</span>(DE)[<span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>)])</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(DE, <span class="at">add=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-airmap" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-airmap-1.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Figure 7.11: locations of PM<span class="math inline">\(_{10}\)</span> measurement stations, showing mean values</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>We can aggregate these station time series to area means, mostly as a simple exercise. For this, we use the <code>aggregate</code> method for <code>stars</code> objects</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>(a <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(aq, <span class="fu">st_as_sf</span>(DE_NUTS1), mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co">#       Min. 1st Qu. Median Mean 3rd Qu. Max.  NA's</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co"># PM10  1.08    10.9   15.3 17.9    21.8  172 25679</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="co">#          from   to     offset  delta            refsys point</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co"># geometry    1   16         NA     NA +proj=longlat ... FALSE</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="co"># time        1 4383 1998-01-01 1 days              Date FALSE</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                                     values</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="co"># geometry MULTIPOLYGON (((9.65 49.8, ...,...,MULTIPOLYGON (((10.8 51.6, ...</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="co"># time                                                                  NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and we can now for instance show the maps for six arbitrarily chosen days (<a href="#fig-airagg">Figure&nbsp;<span>7.12</span></a>) , using</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>a <span class="sc">|&gt;</span> <span class="fu">filter</span>(time <span class="sc">&gt;=</span> <span class="st">"2008-01-01"</span>, time <span class="sc">&lt;</span> <span class="st">"2008-01-07"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="at">key.pos =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-airagg" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-airagg-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 7.12: areal mean PM<span class="math inline">\(_{10}\)</span> values, for six days</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>or create a time series plot of mean values for a single state (<a href="#fig-airts">Figure&nbsp;<span>7.13</span></a>) by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(xts))</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">as.xts</span>(a)[,<span class="dv">4</span>], <span class="at">main =</span> DE_NUTS1<span class="sc">$</span>NAME_1[<span class="dv">4</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-airts" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-airts-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 7.13: areal mean PM<span class="math inline">\(_{10}\)</span> values, for six days</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="example-bristol-origin-destination-datacube" class="level3">
<h3 class="anchored" data-anchor-id="example-bristol-origin-destination-datacube">Example: Bristol origin-destination datacube</h3>
<p>The data used for this example come from <span class="citation" data-cites="geocomp">Lovelace, Nowosad, and Muenchow (<a href="references.html#ref-geocomp" role="doc-biblioref">2019</a>)</span>, and concern origin-destination (OD) counts: the number of persons going from region A to region B, by transportation mode. We have feature geometries for the 102 origin and destination regions, shown in <a href="#fig-bristol1">Figure&nbsp;<span>7.14</span></a> .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spDataLarge)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(bristol_zones), <span class="at">axes =</span> <span class="cn">TRUE</span>, <span class="at">graticule =</span> <span class="cn">TRUE</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(bristol_zones)[<span class="dv">33</span>], <span class="at">col =</span> <span class="st">'red'</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-bristol1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-bristol1-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 7.14: origin destination data zones for Bristol, UK, with zone 33 (E02003043) colored red</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>and the OD counts come in a table with OD pairs as records, and transportation mode as variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(bristol_od)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="co"># # A tibble: 6 × 7</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   o         d           all bicycle  foot car_driver train</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 E02002985 E02002985   209       5   127         59     0</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 E02002985 E02002987   121       7    35         62     0</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 E02002985 E02003036    32       2     1         10     1</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 E02002985 E02003043   141       1     2         56    17</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 E02002985 E02003049    56       2     4         36     0</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 E02002985 E02003054    42       4     0         21     0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that many combinations of origin and destination are implicit zeroes, otherwise these two numbers would have been similar:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(bristol_zones)<span class="sc">^</span><span class="dv">2</span> <span class="co"># all combinations</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 10404</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(bristol_od) <span class="co"># non-zero combinations</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 2910</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will form a three-dimensional vector datacube with origin, destination and transportation mode as dimensions. For this, we first “tidy” the <code>bristol_od</code> table to have origin (o), destination (d), transportation mode (mode), and count (n) as variables, using <code>pivot_longer</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create O-D-mode array:</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>bristol_tidy <span class="ot">&lt;-</span> bristol_od <span class="sc">|&gt;</span> </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>all) <span class="sc">|&gt;</span> </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="dv">3</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">names_to =</span> <span class="st">"mode"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(bristol_tidy)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="co"># # A tibble: 6 × 4</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   o         d         mode           n</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;      &lt;dbl&gt;</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 E02002985 E02002985 bicycle        5</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 E02002985 E02002985 foot         127</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 E02002985 E02002985 car_driver    59</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 E02002985 E02002985 train          0</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 5 E02002985 E02002987 bicycle        7</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 6 E02002985 E02002987 foot          35</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we form the three-dimensional array <code>a</code>, filled with zeroes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>od <span class="ot">&lt;-</span> bristol_tidy <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="st">"o"</span>) <span class="sc">|&gt;</span> <span class="fu">unique</span>()</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>nod <span class="ot">&lt;-</span> <span class="fu">length</span>(od)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>mode <span class="ot">&lt;-</span> bristol_tidy <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="st">"mode"</span>) <span class="sc">|&gt;</span> <span class="fu">unique</span>()</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>nmode <span class="ot">=</span> <span class="fu">length</span>(mode)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>a <span class="ot">=</span> <span class="fu">array</span>(0L,  <span class="fu">c</span>(nod, nod, nmode), </span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="at">o =</span> od, <span class="at">d =</span> od, <span class="at">mode =</span> mode))</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(a)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 102 102   4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that the dimensions are named with the zone names (o, d) and the transportation mode name (mode). Every row of <code>bristol_tidy</code> denotes an array entry, and we can use this to to fill the non-zero entries of the <code>bristol_tidy</code> table with their appropriate value (<code>n</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>a[<span class="fu">as.matrix</span>(bristol_tidy[<span class="fu">c</span>(<span class="st">"o"</span>, <span class="st">"d"</span>, <span class="st">"mode"</span>)])] <span class="ot">=</span> bristol_tidy<span class="sc">$</span>n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To be sure that there is not an order mismatch between the zones in <code>bristol_zones</code> and the zone names in <code>bristol_tidy</code>, we can get the right set of zones by:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>order <span class="ot">&lt;-</span> <span class="fu">match</span>(od, bristol_zones<span class="sc">$</span>geo_code) <span class="co"># it happens this equals 1:102</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>zones <span class="ot">&lt;-</span> <span class="fu">st_geometry</span>(bristol_zones)[order]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(It happens that the order is already correct, but it is good practice to not assume this).</p>
<p>Next, with zones and modes we can create a stars dimensions object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>(d <span class="ot">&lt;-</span> <span class="fu">st_dimensions</span>(<span class="at">o =</span> zones, <span class="at">d =</span> zones, <span class="at">mode =</span> mode))</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to offset delta refsys point</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co"># o       1 102     NA    NA WGS 84 FALSE</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="co"># d       1 102     NA    NA WGS 84 FALSE</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="co"># mode    1   4     NA    NA     NA FALSE</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                                 values</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="co"># o    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="co"># d    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="co"># mode                                                 bicycle,...,train</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and finally build or stars object from <code>a</code> and <code>d</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>(odm <span class="ot">&lt;-</span> <span class="fu">st_as_stars</span>(<span class="fu">list</span>(<span class="at">N =</span> a), <span class="at">dimensions =</span> d))</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co">#    Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="co"># N     0       0      0  4.8       0 1296</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to offset delta refsys point</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="co"># o       1 102     NA    NA WGS 84 FALSE</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="co"># d       1 102     NA    NA WGS 84 FALSE</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="co"># mode    1   4     NA    NA     NA FALSE</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                                 values</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="co"># o    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="co"># d    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="co"># mode                                                 bicycle,...,train</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can take a single slice through from this three-dimensional array, e.g.&nbsp;for zone 33 (<a href="#fig-bristol1">Figure&nbsp;<span>7.14</span></a>) , by <code>odm[,,33]</code>, and plot it with</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">adrop</span>(odm[,,<span class="dv">33</span>]) <span class="sc">+</span> <span class="dv">1</span>, <span class="at">logz =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-odm33" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-odm33-1.png" class="img-fluid figure-img" style="width:80.0%"></p>
<p></p><figcaption class="figure-caption">Figure 7.15: OD matrix sliced for destination zone 33, by transportation mode</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>the result of which is shown in <a href="#fig-odm33">Figure&nbsp;<span>7.15</span></a> . Subsetting this way, we take all attributes (there is only one: N) since the first argument is empty, we take all origin regions (second argument empty), we take destination zone 33 (third argument), and all transportation modes (fourth argument empty, or missing).</p>
<p>We plotted this particular zone because it has the largest number of travelers as its destination. We can find this out by summing all origins and travel modes by destination:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">st_apply</span>(odm, <span class="dv">2</span>, sum)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">which.max</span>(d[[<span class="dv">1</span>]])</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 33</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Other aggregations we can carry out include: total transportation by OD (102 x 102):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_apply</span>(odm, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, sum)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co">#      Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co"># sum     0       0      0 19.2      19 1434</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   from  to offset delta refsys point</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="co"># o    1 102     NA    NA WGS 84 FALSE</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="co"># d    1 102     NA    NA WGS 84 FALSE</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                              values</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="co"># o MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="co"># d MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Origin totals, by mode:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_apply</span>(odm, <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), sum)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co">#      Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co"># sum     1    57.5    214  490     771 2903</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to offset delta refsys point</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="co"># o       1 102     NA    NA WGS 84 FALSE</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co"># mode    1   4     NA    NA     NA FALSE</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                                 values</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="co"># o    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="co"># mode                                                 bicycle,...,train</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Destination totals, by mode:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_apply</span>(odm, <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), sum)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 2 dimensions and 1 attribute</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co">#      Min. 1st Qu. Median Mean 3rd Qu.  Max.</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="co"># sum     0      13    104  490     408 12948</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to offset delta refsys point</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="co"># d       1 102     NA    NA WGS 84 FALSE</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="co"># mode    1   4     NA    NA     NA FALSE</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                                 values</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="co"># d    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="co"># mode                                                 bicycle,...,train</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Origin totals, summed over modes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>o <span class="ot">&lt;-</span> <span class="fu">st_apply</span>(odm, <span class="dv">1</span>, sum)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Destination totals, summed over modes (we had this):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">st_apply</span>(odm, <span class="dv">2</span>, sum)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We plot <code>o</code> and <code>d</code> together after joining them by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> (<span class="fu">c</span>(o, d, <span class="at">along =</span> <span class="fu">list</span>(<span class="at">od =</span> <span class="fu">c</span>(<span class="st">"origin"</span>, <span class="st">"destination"</span>))))</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, <span class="at">logz =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-odjoined" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-odjoined-1.png" style="height:90.0%" width="672" class="figure-img"></p>
<p></p><figcaption class="figure-caption">Figure 7.16: total commutes, summed by origin (left) or destination (right).</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>the result of which is shown in <a href="#fig-odjoined">Figure&nbsp;<span>7.16</span></a> .</p>
<p>There is something to say for the argument that such maps give the wrong message, as both amount (color) and polygon size give an impression of amount. To take out the amount in the count, we can compute densities (count / km<span class="math inline">\(^2\)</span>), by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(units)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">set_units</span>(<span class="fu">st_area</span>(<span class="fu">st_as_sf</span>(o)), km<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>o<span class="sc">$</span>sum_km <span class="ot">&lt;-</span> o<span class="sc">$</span>sum <span class="sc">/</span> a</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>sum_km <span class="ot">&lt;-</span> d<span class="sc">$</span>sum <span class="sc">/</span> a</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>od <span class="ot">&lt;-</span> <span class="fu">c</span>(o[<span class="st">"sum_km"</span>], d[<span class="st">"sum_km"</span>], <span class="at">along =</span> <span class="fu">list</span>(<span class="at">od =</span> <span class="fu">c</span>(<span class="st">"origin"</span>, <span class="st">"destination"</span>)))</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(od, <span class="at">logz =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-odbykm" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-odbykm-1.png" style="height:90.0%" width="672" class="figure-img"></p>
<p></p><figcaption class="figure-caption">Figure 7.17: total commutes per square km, by area of origin (left) or destination (right)</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>shown in <a href="#fig-odbykm">Figure&nbsp;<span>7.17</span></a> . Another way to normalize these totals would be to divide them by population size.</p>
</section>
<section id="tidy-array-data" class="level3">
<h3 class="anchored" data-anchor-id="tidy-array-data">Tidy array data</h3>
<p>The <em>tidy data</em> paper <span class="citation" data-cites="tidy">(<a href="references.html#ref-tidy" role="doc-biblioref">Wickham 2014</a>)</span> may suggest that such array data should be processed not as an array, but in a long table where each row holds (region, class, year, value), and it is always good to be able to do this. For primary handling and storage however, this is often not an option, because:</p>
<ul>
<li>a lot of array data are collected or generated as array data, e.g. by imagery or other sensory devices, or e.g.&nbsp;by climate models</li>
<li>it is easier to derive the long table form from the array than vice versa</li>
<li>the long table form requires much more memory, since the space occupied by dimension values is <span class="math inline">\(O(nmp)\)</span>, rather than <span class="math inline">\(O(n+m+p)\)</span></li>
<li>when missing-valued cells are dropped, the long table form loses the implicit indexing of the array form</li>
</ul>
<p>To put this argument to the extreme, consider for instance that all image, video and sound data are stored in array form; few people would make a real case for storing them in a long table form instead. Nevertheless, R packages like <code>tsibble</code> take this approach, and have to deal with ambiguous ordering of multiple records with identical time steps for different spatial features and index them, which is solved for both <em>automatically</em> by using the array form – at the cost of using dense arrays, in package <code>stars</code>.</p>
<p>Package <code>stars</code> tries to follow the <a href="https://cran.r-project.org/web/packages/tidyverse/vignettes/manifesto.html">tidy manifesto</a> to handle array sets, and has particularly developed support for the case where one or more of the dimensions refer to space, and/or time.</p>
</section>
</section>
<section id="sec-raster-to-vector" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="sec-raster-to-vector"><span class="header-section-number">7.5</span> raster-to-vector, vector-to-raster</h2>
<p>@sec-rasterize already showed some examples of raster-to-vector and vector-to-raster conversions, this section will add some code details and examples.</p>
<section id="vector-to-raster" class="level3">
<h3 class="anchored" data-anchor-id="vector-to-raster">vector-to-raster</h3>
<p><code>st_as_stars</code> is meant as a method to transform objects into <code>stars</code> objects. However, not all stars objects are <code>raster</code> objects, and the method for <code>sf</code> objects creates a vector data cube with the geometry as its spatial (vector) dimension, and attributes as attributes. When given a feature <em>geometry</em> (<code>sfc</code>) object, <code>st_as_stars</code> will rasterize it, as shown in <a href="#sec-warp"><span>Section&nbsp;7.7</span></a>, and in <a href="#fig-asstars">Figure&nbsp;<span>7.18</span></a> .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>(file <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"gpkg/nc.gpkg"</span>, <span class="at">package=</span><span class="st">"sf"</span>))</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "/home/edzer/R/x86_64-pc-linux-gnu-library/4.0/sf/gpkg/nc.gpkg"</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(file) <span class="sc">|&gt;</span> </span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_stars</span>() <span class="sc">|&gt;</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-asstars" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-asstars-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 7.18: rasterizing vector geometry using <code>st_as_stars</code></figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Here, <code>st_as_stars</code> can be parameterized to control cell size, number of cells, and/or extent. The cell values returned are 0 for cells with center point outside the geometry and 1 for cell with center point inside or on the border of the geometry. Rasterizing existing features is done using <code>st_rasterize</code>, as also shown in <a href="01-hello.html#fig-vectoras">Figure&nbsp;<span>1.5</span></a> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(file) <span class="sc">|&gt;</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">as.factor</span>(NAME)) <span class="sc">|&gt;</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(SID74, SID79, name) <span class="sc">|&gt;</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_rasterize</span>()</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 2 dimensions and 3 attributes</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="co">#      SID74           SID79            name       </span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="co">#  Min.   : 0      Min.   : 0      Sampson :  655  </span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="co">#  1st Qu.: 3      1st Qu.: 3      Columbus:  648  </span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a><span class="co">#  Median : 5      Median : 6      Robeson :  648  </span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a><span class="co">#  Mean   : 8      Mean   :10      Bladen  :  604  </span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a><span class="co">#  3rd Qu.:10      3rd Qu.:13      Wake    :  590  </span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a><span class="co">#  Max.   :44      Max.   :57      (Other) :30952  </span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a><span class="co">#  NA's   :30904   NA's   :30904   NA's    :30904  </span></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   from  to   offset      delta refsys point values x/y</span></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a><span class="co"># x    1 461 -84.3239  0.0192484  NAD27 FALSE   NULL [x]</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a><span class="co"># y    1 141  36.5896 -0.0192484  NAD27 FALSE   NULL [y]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Similarly, line and point geometries can be rasterized, as shown in <a href="#fig-lineras">Figure&nbsp;<span>7.19</span></a> .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_sf</span>(file) <span class="sc">|&gt;</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_cast</span>(<span class="st">"MULTILINESTRING"</span>) <span class="sc">|&gt;</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(CNTY_ID) <span class="sc">|&gt;</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_rasterize</span>() <span class="sc">|&gt;</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-lineras" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="07-Introsf_files/figure-html/fig-lineras-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 7.19: rasterization of North Carolina boundaries</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sec-projsf" class="level2" data-number="7.6">
<h2 data-number="7.6" class="anchored" data-anchor-id="sec-projsf"><span class="header-section-number">7.6</span> Coordinate transformations and conversions</h2>
<section id="st_crs" class="level3">
<h3 class="anchored" data-anchor-id="st_crs"><code>st_crs</code></h3>
<p>Spatial objects of class <code>sf</code> or <code>stars</code> contain a coordinate reference system that can be get or replaced with <code>st_crs</code>, or be set or replaced in a pipe with <code>st_set_crs</code>. Coordinate reference systems can be set with an EPSG code, like <code>st_crs(4326)</code> which will be converted to <code>st_crs('EPSG:4326')</code>, or with a PROJ.4 string like <code>"+proj=utm +zone=25 +south"</code>, a name like “WGS84”, or a name preceded by an authority like “OGC:CRS84”; alternatives include a coordinate reference system definition in WKT, WKT-2 (<a href="02-Spaces.html#sec-wkt2"><span>Section&nbsp;2.5</span></a>) or <a href="https://proj.org/specifications/projjson.html">PROJJSON</a>.</p>
<p>The object returned contains two fields:</p>
<ul>
<li><code>wkt</code> with the WKT-2 representation</li>
<li><code>input</code> with the user input, if any, or a human readable description of the coordinate reference system, if available</li>
</ul>
<p>Note that PROJ.4 strings can be used to <em>define</em> some coordinate reference systems, but they cannot be used to <em>represent</em> coordinate reference systems. Conversion of a WKT-2 in a <code>crs</code> object to a proj4string using the <code>$proj4string</code> method, as in</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(<span class="st">"OGC:CRS84"</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>proj4string</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "+proj=longlat +datum=WGS84 +no_defs"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>may succeed but is not in general lossless or invertible. Using PROJ.4 strings, for instance to <em>define</em> a parameterized, projected coordinate reference system is fine as long as it is associated with the WGS84 datum.</p>
</section>
<section id="st_transform-sf_project" class="level3">
<h3 class="anchored" data-anchor-id="st_transform-sf_project"><code>st_transform</code>, <code>sf_project</code></h3>
<p>Coordinate transformations or conversions (<a href="02-Spaces.html#sec-projlib"><span>Section&nbsp;2.4</span></a>) for <code>sf</code> or <code>stars</code> objects are carried out with <code>st_transform</code>, which takes as its first argument a spatial object of class <code>sf</code> or <code>stars</code> that has a coordinate reference system set, and as a second argument with an <code>crs</code> object (or something that can be converted to it with <code>st_crs</code>). When PROJ finds more than one possibility to transform or convert from the source <code>crs</code> to the target <code>crs</code>, it chooses the one with the highest declared accuracy. More fine-grained control over the options is explained in <a href="#sec-pipelines"><span>Section&nbsp;7.6.5</span></a>.</p>
<p>A lower-level function to transform or convert coordinates <em>not</em> in <code>sf</code> or <code>stars</code> objects is <code>sf_project</code>: it takes a matrix with coordinates and a source and target <code>crs</code>, and returns transformed or converted coordinates.</p>
</section>
<section id="sf_proj_info" class="level3">
<h3 class="anchored" data-anchor-id="sf_proj_info"><code>sf_proj_info</code></h3>
<p>Function <code>sf_proj_info</code> can be used to query available projections, ellipsoids, units and prime meridians available in the PROJ software. It takes a single parameter, <code>type</code>, which can have the following values:</p>
<ul>
<li><code>type = "proj"</code> lists the short and long names of available projections; short names can be used in a “+proj=name” string</li>
<li><code>type = "ellps"</code> lists available ellipses, with name, long name, and ellipsoidal parameters</li>
<li><code>type = "units"</code> lists the available length units, with conversion constant to meters</li>
<li><code>type = "prime_meridians"</code> lists the prime meridians with their position with respect to the Greenwich meridian</li>
</ul>
</section>
<section id="proj.db-datum-grids-cdn.proj.org-local-cache" class="level3">
<h3 class="anchored" data-anchor-id="proj.db-datum-grids-cdn.proj.org-local-cache">proj.db, datum grids, cdn.proj.org, local cache</h3>
<p>Datum grids (<a href="02-Spaces.html#sec-projlib"><span>Section&nbsp;2.4</span></a>) can be installed locally, or be read from the PROJ datum grid CDN at https://cdn.proj.org/. If installed locally, they are read from the PROJ search path, which is shown by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_proj_search_paths</span>()</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "/home/edzer/.local/share/proj"</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="co"># [2] "/usr/share/proj"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The main PROJ database is <code>proj.db</code>, an sqlite3 database typically found at</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">paste0</span>(<span class="fu">tail</span>(<span class="fu">sf_proj_search_paths</span>(), <span class="dv">1</span>), .Platform<span class="sc">$</span>file.sep, <span class="st">"proj.db"</span>)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "/usr/share/proj/proj.db"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which can be read. The version of the snapshot of the EPSG database included in each PROJ release is stated in the <code>"metadata"</code> table of <code>proj.db</code>; the version of the PROJ runtime used by <strong>sf</strong> is shown by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_extSoftVersion</span>()[<span class="st">"PROJ"</span>]</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="co">#    PROJ </span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="co"># "8.2.0"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If for a particular coordinate transformation datum grids are not locally found, PROJ will search for online datum grids in the PROJ CDN when</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_proj_network</span>()</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>returns <code>TRUE</code>. By default it is set to <code>FALSE</code>, but</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_proj_network</span>(<span class="cn">TRUE</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "https://cdn.proj.org"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>sets it to <code>TRUE</code> and returns the URL of the network resource used; this resource can also be set to another resource, that may be faster or less limited.</p>
<p>After querying a datum grid on the CDN, PROJ writes the <em>portion</em> of the grid queried (not, by default, the entire grid) to a local cache, which is another sqlite3 database found locally in a user directory, e.g.&nbsp;at</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list.files</span>(<span class="fu">sf_proj_search_paths</span>()[<span class="dv">1</span>], <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "/home/edzer/.local/share/proj/cache.db"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>that will be searched first in subsequent datum grid queries.</p>
</section>
<section id="sec-pipelines" class="level3">
<h3 class="anchored" data-anchor-id="sec-pipelines">Transformation pipelines</h3>
<p>Internally, PROJ uses a so-called <em>coordinate operation pipeline</em>, to represent the sequence of operations to get from a source CRS to a target CRS. Given multiple options to go from source to target, <code>st_transform</code> chooses the one with highest accuracy. We can query the options available by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>(p <span class="ot">&lt;-</span> <span class="fu">sf_proj_pipelines</span>(<span class="st">"OGC:CRS84"</span>, <span class="st">"EPSG:22525"</span>))</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Candidate coordinate operations found:  5 </span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Strict containment:     FALSE </span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Axis order auth compl:  FALSE </span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Source:  OGC:CRS84 </span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Target:  EPSG:22525 </span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Best instantiable operation has accuracy: 2 m</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Description: axis order change (2D) + Inverse of Corrego Alegre</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="co">#              1970-72 to WGS 84 (2) + UTM zone 25S</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Definition:  +proj=pipeline +step +proj=unitconvert +xy_in=deg</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="co">#              +xy_out=rad +step +inv</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a><span class="co">#              +proj=hgridshift</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a><span class="co">#              +grids=br_ibge_CA7072_003.tif +step</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a><span class="co">#              +proj=utm +zone=25 +south +ellps=intl</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and see that pipeline with the highest accuracy is summarised; we can see that it specifies use of a datum grid. Had we not switched on the network search, we would have obtained a different result:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_proj_network</span>(<span class="cn">FALSE</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="co"># character(0)</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sf_proj_pipelines</span>(<span class="st">"OGC:CRS84"</span>, <span class="st">"EPSG:22525"</span>)</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Candidate coordinate operations found:  5 </span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Strict containment:     FALSE </span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Axis order auth compl:  FALSE </span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Source:  OGC:CRS84 </span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Target:  EPSG:22525 </span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Best instantiable operation has accuracy: 5 m</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Description: axis order change (2D) + Inverse of Corrego Alegre</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="co">#              1970-72 to WGS 84 (4) + UTM zone 25S</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Definition:  +proj=pipeline +step +proj=unitconvert +xy_in=deg</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a><span class="co">#              +xy_out=rad +step +proj=push +v_3</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a><span class="co">#              +step +proj=cart +ellps=WGS84 +step</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a><span class="co">#              +proj=helmert +x=206.05 +y=-168.28</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a><span class="co">#              +z=3.82 +step +inv +proj=cart</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a><span class="co">#              +ellps=intl +step +proj=pop +v_3 +step</span></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a><span class="co">#              +proj=utm +zone=25 +south +ellps=intl</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Operation 4 is lacking 1 grid with accuracy 2 m</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Missing grid: br_ibge_CA7072_003.tif </span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a><span class="co"># URL: https://cdn.proj.org/br_ibge_CA7072_003.tif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and a report that a datum grid is missing. The object returned by <code>sf_proj_pipelines</code> is a sub-classed <code>data.frame</code>, with columns</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(p)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "id"           "description"  "definition"   "has_inverse" </span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="co"># [5] "accuracy"     "axis_order"   "grid_count"   "instantiable"</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co"># [9] "containment"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and we can list for instance the accuracies by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>p<span class="sc">$</span>accuracy</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1]  5  5  8  2 NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, <code>NA</code> refers to “ballpark accuracy”, which may be anything in the 30-120 m range:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>p[<span class="fu">is.na</span>(p<span class="sc">$</span>accuracy),]</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Candidate coordinate operations found:  1 </span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Strict containment:     FALSE </span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Axis order auth compl:  FALSE </span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Source:  OGC:CRS84 </span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Target:  EPSG:22525 </span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Best instantiable operation has only ballpark accuracy </span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Description: Ballpark geographic offset from WGS 84 (CRS84) to</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="co">#              Corrego Alegre 1970-72 + UTM zone 25S</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Definition:  +proj=pipeline +step +proj=unitconvert +xy_in=deg</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="co">#              +xy_out=rad +step +proj=utm +zone=25</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a><span class="co">#              +south +ellps=intl</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The default, most accurate pipeline chosen by <code>st_transform</code> can be overriden by specifying <code>pipeline</code> argument, as selected from the set of options in <code>p$definition</code>.</p>
</section>
<section id="sec-axisorder" class="level3">
<h3 class="anchored" data-anchor-id="sec-axisorder">Axis order</h3>
<p>As mentioned in <a href="02-Spaces.html#sec-wkt2"><span>Section&nbsp;2.5</span></a>, <code>EPSG:4326</code> defines the first axis to be associated with latitude and the second with longitude; this is also the case for a number of other ellipsoidal coordinate reference systems. Although this is how the authority (EPSG) prescribes this, it is not how most datasets are currently stored! As most other software, package <code>sf</code> by default ignores this, and interprets ellipsoidal coordinate pairs as (longitude, latitude) by default. If however data needs to be read e.g.&nbsp;from a WFS service that wants to be compliant to the authority, one can set</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_axis_order</span>(<span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>to globally instruct <code>sf</code>, when calling GDAL and PROJ routines, that authority compliance (latitude, longitude order) is assumed. It is anticipated that problems may happen in case of authority compliance, e.g.&nbsp;with plotting data. The <code>plot</code> method for <code>sf</code> objects respects the axis order flag and will swap coordinates using the transformation pipeline <code>"+proj=pipeline +step +proj=axisswap +order=2,1"</code> before plotting them, but e.g.&nbsp;<code>geom_sf()</code> in <code>ggplot2</code> has not been modified to do this. As mentioned earlier, the axis order ambiguity of <code>EPSG:4326</code> is resolved by replacing it with <code>OGC:CRS84</code>.</p>
</section>
</section>
<section id="sec-warp" class="level2" data-number="7.7">
<h2 data-number="7.7" class="anchored" data-anchor-id="sec-warp"><span class="header-section-number">7.7</span> Transforming and warping rasters</h2>
<p>When using <code>st_transform</code> on a raster data set, as e.g.&nbsp;in</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>tif <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"tif/L7_ETMs.tif"</span>, <span class="at">package =</span> <span class="st">"stars"</span>)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">read_stars</span>(tif) <span class="sc">|&gt;</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="st">'OGC:CRS84'</span>)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max.</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif     1      54     69 68.9      86  255</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to offset delta refsys point</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="co"># x       1 349     NA    NA WGS 84 FALSE</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="co"># y       1 352     NA    NA WGS 84 FALSE</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a><span class="co"># band    1   6     NA    NA     NA    NA</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a><span class="co">#                               values x/y</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a><span class="co"># x    [349x352] -34.9165,...,-34.8261 [x]</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a><span class="co"># y     [349x352] -8.0408,...,-7.94995 [y]</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a><span class="co"># band                            NULL    </span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a><span class="co"># curvilinear grid</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>we see that a <em>curvilinear</em> is created, which means that for every grid cell the coordinates are computed in the new CRS, which no longer form a <em>regular</em> grid. Plotting such data is extremely slow, as small polygons are computed for every grid cell and then plotted. The advantage of this is that no information is lost: grid cell values remain identical after the projection.</p>
<p>When we start with a raster on a regular grid and want to obtain a <em>regular</em> grid in a new coordinate reference system, we need to <em>warp</em> the grid: we need to recreate a grid at new locations, and use some rule to assign values to new grid cells. Rules can involve using the nearest value, or using some form of interpolation. This operation is not lossless and not invertible.</p>
<p>The best options for warping is to specify the target grid as a <code>stars</code> object. When only a target CRS is specified, default options for the target grid are picked that may be completely inappropriate for the problem at hand. An example workflow that uses only a target CRS is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_stars</span>(tif) <span class="sc">|&gt;</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_warp</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="st">'OGC:CRS84'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_dimensions</span>()</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to   offset        delta refsys point values x/y</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="co"># x       1 350 -34.9166  0.000259243 WGS 84    NA   NULL [x]</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="co"># y       1 352 -7.94982 -0.000259243 WGS 84    NA   NULL [y]</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a><span class="co"># band    1   6       NA           NA     NA    NA   NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which creates a pretty close raster, but then the transformation is also relatively modest. For a workflow that creates a target raster first, here with exactly the same number of rows and columns as the original raster one could use:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">read_stars</span>(tif)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>grd <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(r) <span class="sc">|&gt;</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_transform</span>(<span class="st">'OGC:CRS84'</span>) <span class="sc">|&gt;</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_bbox</span>() <span class="sc">|&gt;</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_as_stars</span>(<span class="at">nx =</span> <span class="fu">dim</span>(r)[<span class="st">"x"</span>], <span class="at">ny =</span> <span class="fu">dim</span>(r)[<span class="st">"y"</span>])</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a><span class="fu">st_warp</span>(r, grd)</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a><span class="co"># stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute(s):</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a><span class="co">#              Min. 1st Qu. Median Mean 3rd Qu. Max. NA's</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a><span class="co"># L7_ETMs.tif     1      54     69 68.9      86  255 6180</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a><span class="co">#      from  to   offset        delta refsys point values x/y</span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a><span class="co"># x       1 349 -34.9166  0.000259666 WGS 84    NA   NULL [x]</span></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a><span class="co"># y       1 352 -7.94982 -0.000258821 WGS 84    NA   NULL [y]</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a><span class="co"># band    1   6       NA           NA     NA    NA   NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exercises" class="level2" data-number="7.8">
<h2 data-number="7.8" class="anchored" data-anchor-id="exercises"><span class="header-section-number">7.8</span> Exercises</h2>
<p>Use R to solve the following exercises.</p>
<ol type="1">
<li>Find the names of the <code>nc</code> counties that intersect <code>LINESTRING(-84 35,-78 35)</code>; use <code>[</code> for this, and as an alternative use <code>st_join()</code> for this.</li>
<li>Repeat this after setting <code>sf_use_s2(FALSE)</code>, and <em>compute</em> the difference (hint: use <code>setdiff()</code>), and color the counties of the difference using color ‘#88000088’.</li>
<li>Plot the two different lines in a single plot; note that R will plot a straight line always straight in the projection currently used; <code>st_segmentize</code> can be used to add points on straight line, or on a great circle for ellipsoidal coordinates.</li>
<li>NDVI, normalized differenced vegetation index, is computed as <code>(NIR-R)/(NIR+R)</code>, with NIR the near infrared and R the red band. Read the <code>L7_ETMs.tif</code> file into object <code>x</code>, and distribute the band dimensions over attributes by <code>split(x, "band")</code>. Then, add attribute NDVI to this object by using an expression that uses the NIR (band 4) and R (band 3) attributes directly.</li>
<li>Compute NDVI for the <code>L7_ETMs.tif</code> image by reducing the band dimension, using <code>st_apply</code> and an a function <code>ndvi = function(x) { (x[4]-x[3])/(x[4]+x[3]) }</code>. Plot the result, and write the result to a GeoTIFF.</li>
<li>Use <code>st_transform</code> to transform the <code>stars</code> object read from <code>L7_ETMs.tif</code> to <code>OGC:CRS84</code>. Print the object. Is this a regular grid? Plot the first band using arguments <code>axes=TRUE</code> and <code>border=NA</code>, and explain why this takes such a long time.</li>
<li>Use <code>st_warp</code> to warp the <code>L7_ETMs.tif</code> object to <code>OGC:CRS84</code>, and plot the resulting object with <code>axes=TRUE</code>. Why is the plot created much faster than after <code>st_transform</code>?</li>
<li>Using a vector representation of the raster <code>L7_ETMs</code>, plot the intersection with a circular area around <code>POINT(293716 9113692)</code> with radius 75 m, and compute the area-weighted mean pixel values for this circle. Compare the area-weighted values with those obtained by <code>aggregate</code> using the vector data, and by <code>aggregate</code> using the raster data, using <code>exact=FALSE</code> (default) and <code>exact=FALSE</code>. Explain the differences.</li>
</ol>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-eddelbuettel2013seamless" class="csl-entry" role="doc-biblioentry">
Eddelbuettel, Dirk. 2013. <em>Seamless r and c++ Integration with Rcpp</em>. Springer.
</div>
<div id="ref-R-gdalUtils" class="csl-entry" role="doc-biblioentry">
Greenberg, Jonathan Asher, and Matteo Mattiuzzi. 2020. <em>gdalUtils: Wrappers for the Geospatial Data Abstraction Library (GDAL) Utilities</em>. <a href="https://CRAN.R-project.org/package=gdalUtils">https://CRAN.R-project.org/package=gdalUtils</a>.
</div>
<div id="ref-herring2011opengis" class="csl-entry" role="doc-biblioentry">
Herring, John et al. 2011. <span>“Opengis<span></span> Implementation Standard for Geographic Information-Simple Feature Access-Part 1: Common Architecture [Corrigendum].”</span>
</div>
<div id="ref-R-raster" class="csl-entry" role="doc-biblioentry">
Hijmans, Robert J. 2022a. <em>Raster: Geographic Data Analysis and Modeling</em>. <a href="https://rspatial.org/raster">https://rspatial.org/raster</a>.
</div>
<div id="ref-R-terra" class="csl-entry" role="doc-biblioentry">
———. 2022b. <em>Terra: Spatial Data Analysis</em>. <a href="https://rspatial.org/terra/">https://rspatial.org/terra/</a>.
</div>
<div id="ref-geocomp" class="csl-entry" role="doc-biblioentry">
Lovelace, Robin, Jakub Nowosad, and Jannes Muenchow. 2019. <em>Geocomputation with <span>R</span></em>. Chapman; Hall/CRC.<a href=" https://geocompr.robinlovelace.net/ ">https://geocompr.robinlovelace.net/ </a>.
</div>
<div id="ref-spacetime2012" class="csl-entry" role="doc-biblioentry">
Pebesma, Edzer. 2012. <span>“<span class="nocase">spacetime</span>: Spatio-Temporal Data in <span>R</span>.”</span> <em>Journal of Statistical Software</em> 51 (7): 1–30. <a href="https://www.jstatsoft.org/v51/i07/">https://www.jstatsoft.org/v51/i07/</a>.
</div>
<div id="ref-rjsf" class="csl-entry" role="doc-biblioentry">
———. 2018. <span>“<span class="nocase">Simple Features for R: Standardized Support for Spatial Vector Data</span>.”</span> <em><span>The R Journal</span></em> 10 (1): 439–46. <a href="https://doi.org/10.32614/RJ-2018-009">https://doi.org/10.32614/RJ-2018-009</a>.
</div>
<div id="ref-R-abind" class="csl-entry" role="doc-biblioentry">
Plate, Tony, and Richard Heiberger. 2016. <em>Abind: Combine Multidimensional Arrays</em>. <a href="https://CRAN.R-project.org/package=abind">https://CRAN.R-project.org/package=abind</a>.
</div>
<div id="ref-tidy" class="csl-entry" role="doc-biblioentry">
Wickham, Hadley. 2014. <span>“Tidy Data.”</span> <em>Journal of Statistical Software</em> 59 (1).<a href=" https://www.jstatsoft.org/article/view/v059i10 ">https://www.jstatsoft.org/article/view/v059i10 </a>.
</div>
<div id="ref-welcome" class="csl-entry" role="doc-biblioentry">
Wickham, Hadley, Mara Averick, Jennifer Bryan, Winston Chang, Lucy D’Agostino McGowan, Romain François, Garrett Grolemund, et al. 2019. <span>“Welcome to the Tidyverse.”</span> <em>Journal of Open Source Software</em> 4 (43): 1686. <a href="https://joss.theoj.org/papers/10.21105/joss.01686">https://joss.theoj.org/papers/10.21105/joss.01686</a>.
</div>
<div id="ref-r4ds" class="csl-entry" role="doc-biblioentry">
Wickham, Hadley, and Garret Grolemund. 2017. <em>R for Data Science</em>. O’Reilly. <a href="http://r4ds.had.co.nz/">http://r4ds.had.co.nz/</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./06-Cubes.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Cubes</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./08-Large.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>