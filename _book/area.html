<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 14 Proximity and Areal Data | Spatial Data Science</title>
  <meta name="description" content="description_xx" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 14 Proximity and Areal Data | Spatial Data Science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="description_xx" />
  <meta name="github-repo" content="edzer/sdsr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 14 Proximity and Areal Data | Spatial Data Science" />
  
  <meta name="twitter:description" content="description_xx" />
  

<meta name="author" content="Edzer Pebesma, Roger Bivand" />


<meta name="date" content="2021-12-28" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="stgeostatistics.html"/>
<link rel="next" href="spatautocorr.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />

<script>
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan');
  rCodeBlocks.each(function() {

    // if code block has been labeled with class `fold-show`, show the code on init!
    var classList = $(this).attr('class').split(/\s+/);
    for (var i = 0; i < classList.length; i++) {
    if (classList[i] === 'fold-show') {
        show = true;
      }
    }

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // hack: return show to false, otherwise all next codeBlocks will be shown!
    show = false;

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<script>
/* ========================================================================
 * Bootstrap: dropdown.js v3.3.7
 * http://getbootstrap.com/javascript/#dropdowns
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // DROPDOWN CLASS DEFINITION
  // =========================

  var backdrop = '.dropdown-backdrop'
  var toggle   = '[data-toggle="dropdown"]'
  var Dropdown = function (element) {
    $(element).on('click.bs.dropdown', this.toggle)
  }

  Dropdown.VERSION = '3.3.7'

  function getParent($this) {
    var selector = $this.attr('data-target')

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7
    }

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  }

  function clearMenus(e) {
    if (e && e.which === 3) return
    $(backdrop).remove()
    $(toggle).each(function () {
      var $this         = $(this)
      var $parent       = getParent($this)
      var relatedTarget = { relatedTarget: this }

      if (!$parent.hasClass('open')) return

      if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

      $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this.attr('aria-expanded', 'false')
      $parent.removeClass('open').trigger($.Event('hidden.bs.dropdown', relatedTarget))
    })
  }

  Dropdown.prototype.toggle = function (e) {
    var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    clearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $(document.createElement('div'))
          .addClass('dropdown-backdrop')
          .insertAfter($(this))
          .on('click', clearMenus)
      }

      var relatedTarget = { relatedTarget: this }
      $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this
        .trigger('focus')
        .attr('aria-expanded', 'true')

      $parent
        .toggleClass('open')
        .trigger($.Event('shown.bs.dropdown', relatedTarget))
    }

    return false
  }

  Dropdown.prototype.keydown = function (e) {
    if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName)) return

    var $this = $(this)

    e.preventDefault()
    e.stopPropagation()

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    if (!isActive && e.which != 27 || isActive && e.which == 27) {
      if (e.which == 27) $parent.find(toggle).trigger('focus')
      return $this.trigger('click')
    }

    var desc = ' li:not(.disabled):visible a'
    var $items = $parent.find('.dropdown-menu' + desc)

    if (!$items.length) return

    var index = $items.index(e.target)

    if (e.which == 38 && index > 0)                 index--         // up
    if (e.which == 40 && index < $items.length - 1) index++         // down
    if (!~index)                                    index = 0

    $items.eq(index).trigger('focus')
  }


  // DROPDOWN PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this = $(this)
      var data  = $this.data('bs.dropdown')

      if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  var old = $.fn.dropdown

  $.fn.dropdown             = Plugin
  $.fn.dropdown.Constructor = Dropdown


  // DROPDOWN NO CONFLICT
  // ====================

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  // APPLY TO STANDARD DROPDOWN ELEMENTS
  // ===================================

  $(document)
    .on('click.bs.dropdown.data-api', clearMenus)
    .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
    .on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown)
    .on('keydown.bs.dropdown.data-api', '.dropdown-menu', Dropdown.prototype.keydown)

}(jQuery);
</script>
<style type="text/css">
.code-folding-btn {
  margin-bottom: 4px;
}

.row { display: flex; }
.collapse { display: none; }
.in { display:block }
.pull-right > .dropdown-menu {
    right: 0;
    left: auto;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    font-size: 14px;
    text-align: left;
    list-style: none;
    background-color: #fff;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    border: 1px solid #ccc;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
    box-shadow: 0 6px 12px rgba(0,0,0,.175);
}

.open > .dropdown-menu {
    display: block;
    color: #ffffff;
    background-color: #ffffff;
    background-image: none;
    border-color: #92897e;
}

.dropdown-menu > li > a {
  display: block;
  padding: 3px 20px;
  clear: both;
  font-weight: 400;
  line-height: 1.42857143;
  color: #000000;
  white-space: nowrap;
}

.dropdown-menu > li > a:hover,
.dropdown-menu > li > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
}

.dropdown-menu > .active > a,
.dropdown-menu > .active > a:hover,
.dropdown-menu > .active > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
  outline: 0;
}
.dropdown-menu > .disabled > a,
.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  color: #aea79f;
}

.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  text-decoration: none;
  cursor: not-allowed;
  background-color: transparent;
  background-image: none;
  filter: progid:DXImageTransform.Microsoft.gradient(enabled = false);
}

.btn {
  display: inline-block;
  margin-bottom: 1;
  font-weight: normal;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  -ms-touch-action: manipulation;
      touch-action: manipulation;
  cursor: pointer;
  background-image: none;
  border: 1px solid transparent;
  padding: 4px 8px;
  font-size: 14px;
  line-height: 1.42857143;
  border-radius: 4px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.btn:focus,
.btn:active:focus,
.btn.active:focus,
.btn.focus,
.btn:active.focus,
.btn.active.focus {
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px;
}
.btn:hover,
.btn:focus,
.btn.focus {
  color: #ffffff;
  text-decoration: none;
}
.btn:active,
.btn.active {
  background-image: none;
  outline: 0;
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn.disabled,
.btn[disabled],
fieldset[disabled] .btn {
  cursor: not-allowed;
  filter: alpha(opacity=65);
  opacity: 0.65;
  box-shadow: none;
}
a.btn.disabled,
fieldset[disabled] a.btn {
  pointer-events: none;
}
.btn-default {
  color: #ffffff;
  background-color: #aea79f; #important
  border-color: #aea79f;
}

.btn-default:focus,
.btn-default.focus {
  color: #ffffff;
  background-color: #978e83;
  border-color: #6f675e;
}

.btn-default:hover {
  color: #ffffff;
  background-color: #978e83;
  border-color: #92897e;
}
.btn-default:active,
.btn-default.active,
.btn-group > .btn:not(:first-child):not(:last-child):not(.dropdown-toggle) {
  border-radius: 0;
}
.btn-group > .btn:first-child {
  margin-left: 0;
}
.btn-group > .btn:first-child:not(:last-child):not(.dropdown-toggle) {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn:last-child:not(:first-child),
.btn-group > .dropdown-toggle:not(:first-child) {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group > .btn-group {
  float: left;
}
.btn-group > .btn-group:not(:first-child):not(:last-child) > .btn {
  border-radius: 0;
}
.btn-group > .btn-group:first-child:not(:last-child) > .btn:last-child,
.btn-group > .btn-group:first-child:not(:last-child) > .dropdown-toggle {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn-group:last-child:not(:first-child) > .btn:first-child {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group .dropdown-toggle:active,
.btn-group.open .dropdown-toggle {
  outline: 0;
}
.btn-group > .btn + .dropdown-toggle {
  padding-right: 8px;
  padding-left: 8px;
}
.btn-group > .btn-lg + .dropdown-toggle {
  padding-right: 12px;
  padding-left: 12px;
}
.btn-group.open .dropdown-toggle {
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn-group.open .dropdown-toggle.btn-link {
  box-shadow: none;
}

</style>
<script>
var str = '<div class="btn-group pull-right" style="position: fixed; right: 50px; top: 10px; z-index: 200"><button type="button" class="btn btn-default btn-xs dropdown-toggle" id="allCodeButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast=""><span>Code</span> <span class="caret"></span></button><ul class="dropdown-menu" style="min-width: 50px;"><li><a id="rmd-show-all-code" href="#">Show All Code</a></li><li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li></ul></div>';
document.write(str);
</script>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatial Data Science</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="part"><span><b>I Spatial Data</b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Getting Started</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#a-first-map"><i class="fa fa-check"></i><b>1.1</b> A first map</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#coordinate-reference-systems"><i class="fa fa-check"></i><b>1.2</b> Coordinate reference systems</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#rasterize"><i class="fa fa-check"></i><b>1.3</b> Raster and vector data</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#raster-types"><i class="fa fa-check"></i><b>1.4</b> Raster types</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#time-series-arrays-data-cubes"><i class="fa fa-check"></i><b>1.5</b> Time series, arrays, data cubes</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#support"><i class="fa fa-check"></i><b>1.6</b> Support</a></li>
<li class="chapter" data-level="1.7" data-path="intro.html"><a href="intro.html#spatial-data-science-software"><i class="fa fa-check"></i><b>1.7</b> Spatial data science software</a></li>
<li class="chapter" data-level="1.8" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>1.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cs.html"><a href="cs.html"><i class="fa fa-check"></i><b>2</b> Coordinates</a><ul>
<li class="chapter" data-level="2.1" data-path="cs.html"><a href="cs.html#units"><i class="fa fa-check"></i><b>2.1</b> Quantities, units, datum</a></li>
<li class="chapter" data-level="2.2" data-path="cs.html"><a href="cs.html#ellipsoidal-coordinates"><i class="fa fa-check"></i><b>2.2</b> Ellipsoidal coordinates</a></li>
<li class="chapter" data-level="2.3" data-path="cs.html"><a href="cs.html#crs"><i class="fa fa-check"></i><b>2.3</b> Coordinate Reference Systems</a></li>
<li class="chapter" data-level="2.4" data-path="cs.html"><a href="cs.html#projlib"><i class="fa fa-check"></i><b>2.4</b> PROJ and mapping accuracy</a></li>
<li class="chapter" data-level="2.5" data-path="cs.html"><a href="cs.html#wkt2"><i class="fa fa-check"></i><b>2.5</b> WKT-2</a></li>
<li class="chapter" data-level="2.6" data-path="cs.html"><a href="cs.html#exercises-1"><i class="fa fa-check"></i><b>2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="geometries.html"><a href="geometries.html"><i class="fa fa-check"></i><b>3</b> Geometries</a><ul>
<li class="chapter" data-level="3.1" data-path="geometries.html"><a href="geometries.html#simplefeatures"><i class="fa fa-check"></i><b>3.1</b> Simple feature geometries</a></li>
<li class="chapter" data-level="3.2" data-path="geometries.html"><a href="geometries.html#opgeom"><i class="fa fa-check"></i><b>3.2</b> Operations on geometries</a></li>
<li class="chapter" data-level="3.3" data-path="geometries.html"><a href="geometries.html#precision"><i class="fa fa-check"></i><b>3.3</b> Precision</a></li>
<li class="chapter" data-level="3.4" data-path="geometries.html"><a href="geometries.html#coverages"><i class="fa fa-check"></i><b>3.4</b> Coverages: tessellations and rasters</a></li>
<li class="chapter" data-level="3.5" data-path="geometries.html"><a href="geometries.html#networks"><i class="fa fa-check"></i><b>3.5</b> Networks</a></li>
<li class="chapter" data-level="3.6" data-path="geometries.html"><a href="geometries.html#exercises-2"><i class="fa fa-check"></i><b>3.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spherical.html"><a href="spherical.html"><i class="fa fa-check"></i><b>4</b> Spherical Geometries</a><ul>
<li class="chapter" data-level="4.1" data-path="spherical.html"><a href="spherical.html#straight-lines"><i class="fa fa-check"></i><b>4.1</b> Straight lines</a></li>
<li class="chapter" data-level="4.2" data-path="spherical.html"><a href="spherical.html#ring-direction"><i class="fa fa-check"></i><b>4.2</b> Ring direction</a></li>
<li class="chapter" data-level="4.3" data-path="spherical.html"><a href="spherical.html#full-polygon"><i class="fa fa-check"></i><b>4.3</b> Full polygon</a></li>
<li class="chapter" data-level="4.4" data-path="spherical.html"><a href="spherical.html#bounding-box-rectangle-and-cap"><i class="fa fa-check"></i><b>4.4</b> Bounding box, rectangle, and cap</a></li>
<li class="chapter" data-level="4.5" data-path="spherical.html"><a href="spherical.html#validity-on-the-sphere"><i class="fa fa-check"></i><b>4.5</b> Validity on the sphere</a></li>
<li class="chapter" data-level="4.6" data-path="spherical.html"><a href="spherical.html#exercises-3"><i class="fa fa-check"></i><b>4.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="featureattributes.html"><a href="featureattributes.html"><i class="fa fa-check"></i><b>5</b> Attributes and Support</a><ul>
<li class="chapter" data-level="5.1" data-path="featureattributes.html"><a href="featureattributes.html#agr"><i class="fa fa-check"></i><b>5.1</b> Attribute-geometry relationships and support</a></li>
<li class="chapter" data-level="5.2" data-path="featureattributes.html"><a href="featureattributes.html#aggregating-and-summarising"><i class="fa fa-check"></i><b>5.2</b> Aggregating and summarising</a></li>
<li class="chapter" data-level="5.3" data-path="featureattributes.html"><a href="featureattributes.html#area-weighted"><i class="fa fa-check"></i><b>5.3</b> Area-weighted interpolation</a></li>
<li class="chapter" data-level="5.4" data-path="featureattributes.html"><a href="featureattributes.html#updownscaling"><i class="fa fa-check"></i><b>5.4</b> Up- and Downscaling</a></li>
<li class="chapter" data-level="5.5" data-path="featureattributes.html"><a href="featureattributes.html#exercises-4"><i class="fa fa-check"></i><b>5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="datacube.html"><a href="datacube.html"><i class="fa fa-check"></i><b>6</b> Data Cubes</a><ul>
<li class="chapter" data-level="6.1" data-path="datacube.html"><a href="datacube.html#a-four-dimensional-data-cube"><i class="fa fa-check"></i><b>6.1</b> A four-dimensional data cube</a></li>
<li class="chapter" data-level="6.2" data-path="datacube.html"><a href="datacube.html#dimensions-attributes-and-support"><i class="fa fa-check"></i><b>6.2</b> Dimensions, attributes, and support</a></li>
<li class="chapter" data-level="6.3" data-path="datacube.html"><a href="datacube.html#dcoperations"><i class="fa fa-check"></i><b>6.3</b> Operations on data cubes</a></li>
<li class="chapter" data-level="6.4" data-path="datacube.html"><a href="datacube.html#vectordatacubes"><i class="fa fa-check"></i><b>6.4</b> Aggregating raster to vector cubes</a></li>
<li class="chapter" data-level="6.5" data-path="datacube.html"><a href="datacube.html#switching"><i class="fa fa-check"></i><b>6.5</b> Switching dimension with attributes</a></li>
<li class="chapter" data-level="6.6" data-path="datacube.html"><a href="datacube.html#otherdynamic"><i class="fa fa-check"></i><b>6.6</b> Other dynamic spatial data</a></li>
<li class="chapter" data-level="6.7" data-path="datacube.html"><a href="datacube.html#exercises-5"><i class="fa fa-check"></i><b>6.7</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II R for Spatial Data Science</b></span></li>
<li class="chapter" data-level="7" data-path="sf.html"><a href="sf.html"><i class="fa fa-check"></i><b>7</b> Introduction to sf and stars</a><ul>
<li class="chapter" data-level="7.1" data-path="sf.html"><a href="sf.html#sfintro"><i class="fa fa-check"></i><b>7.1</b> Package <code>sf</code></a></li>
<li class="chapter" data-level="7.2" data-path="sf.html"><a href="sf.html#spatial-joins"><i class="fa fa-check"></i><b>7.2</b> Spatial joins</a></li>
<li class="chapter" data-level="7.3" data-path="sf.html"><a href="sf.html#package-stars"><i class="fa fa-check"></i><b>7.3</b> Package <code>stars</code></a></li>
<li class="chapter" data-level="7.4" data-path="sf.html"><a href="sf.html#vector-data-cube-examples"><i class="fa fa-check"></i><b>7.4</b> Vector data cube examples</a></li>
<li class="chapter" data-level="7.5" data-path="sf.html"><a href="sf.html#raster-to-vector"><i class="fa fa-check"></i><b>7.5</b> raster-to-vector, vector-to-raster</a></li>
<li class="chapter" data-level="7.6" data-path="sf.html"><a href="sf.html#projsf"><i class="fa fa-check"></i><b>7.6</b> Coordinate transformations and conversions</a></li>
<li class="chapter" data-level="7.7" data-path="sf.html"><a href="sf.html#warp"><i class="fa fa-check"></i><b>7.7</b> Transforming and warping rasters</a></li>
<li class="chapter" data-level="7.8" data-path="sf.html"><a href="sf.html#exercises-6"><i class="fa fa-check"></i><b>7.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="large.html"><a href="large.html"><i class="fa fa-check"></i><b>8</b> Large data sets</a><ul>
<li class="chapter" data-level="8.1" data-path="large.html"><a href="large.html#largesf"><i class="fa fa-check"></i><b>8.1</b> Vector data: <code>sf</code></a></li>
<li class="chapter" data-level="8.2" data-path="large.html"><a href="large.html#raster-data-stars"><i class="fa fa-check"></i><b>8.2</b> Raster data: <code>stars</code></a></li>
<li class="chapter" data-level="8.3" data-path="large.html"><a href="large.html#very-large-data-cubes"><i class="fa fa-check"></i><b>8.3</b> Very large data cubes</a></li>
<li class="chapter" data-level="8.4" data-path="large.html"><a href="large.html#exercises-7"><i class="fa fa-check"></i><b>8.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>9</b> Plotting spatial data</a><ul>
<li class="chapter" data-level="9.1" data-path="plotting.html"><a href="plotting.html#transform"><i class="fa fa-check"></i><b>9.1</b> Every plot is a projection</a></li>
<li class="chapter" data-level="9.2" data-path="plotting.html"><a href="plotting.html#plotting-points-lines-polygons-grid-cells"><i class="fa fa-check"></i><b>9.2</b> Plotting points, lines, polygons, grid cells</a></li>
<li class="chapter" data-level="9.3" data-path="plotting.html"><a href="plotting.html#base-plot"><i class="fa fa-check"></i><b>9.3</b> Base <code>plot</code></a></li>
<li class="chapter" data-level="9.4" data-path="plotting.html"><a href="plotting.html#geomsf"><i class="fa fa-check"></i><b>9.4</b> Maps with <code>ggplot2</code></a></li>
<li class="chapter" data-level="9.5" data-path="plotting.html"><a href="plotting.html#tmap"><i class="fa fa-check"></i><b>9.5</b> Maps with <code>tmap</code></a></li>
<li class="chapter" data-level="9.6" data-path="plotting.html"><a href="plotting.html#interactive-maps-leaflet-mapview-tmap"><i class="fa fa-check"></i><b>9.6</b> Interactive maps: <code>leaflet</code>, <code>mapview</code>, <code>tmap</code></a></li>
<li class="chapter" data-level="9.7" data-path="plotting.html"><a href="plotting.html#exercises-8"><i class="fa fa-check"></i><b>9.7</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>III Models for Spatial Data</b></span></li>
<li class="chapter" data-level="10" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html"><i class="fa fa-check"></i><b>10</b> Statistical modelling of spatial data</a><ul>
<li class="chapter" data-level="10.1" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#design"><i class="fa fa-check"></i><b>10.1</b> Design-based and model-based inference</a></li>
<li class="chapter" data-level="10.2" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#predictive-models-with-coordinates"><i class="fa fa-check"></i><b>10.2</b> Predictive models with coordinates</a></li>
<li class="chapter" data-level="10.3" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#further-reading"><i class="fa fa-check"></i><b>10.3</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="pointpatterns.html"><a href="pointpatterns.html"><i class="fa fa-check"></i><b>11</b> Point Pattern Analysis</a><ul>
<li class="chapter" data-level="11.1" data-path="pointpatterns.html"><a href="pointpatterns.html#observation-window"><i class="fa fa-check"></i><b>11.1</b> Observation window</a></li>
<li class="chapter" data-level="11.2" data-path="pointpatterns.html"><a href="pointpatterns.html#coordinate-reference-systems-1"><i class="fa fa-check"></i><b>11.2</b> Coordinate reference systems</a></li>
<li class="chapter" data-level="11.3" data-path="pointpatterns.html"><a href="pointpatterns.html#marked-point-patterns-points-on-linear-networks"><i class="fa fa-check"></i><b>11.3</b> Marked point patterns, points on linear networks</a></li>
<li class="chapter" data-level="11.4" data-path="pointpatterns.html"><a href="pointpatterns.html#spatial-sampling-and-simulating-a-point-process"><i class="fa fa-check"></i><b>11.4</b> Spatial sampling and simulating a point process</a></li>
<li class="chapter" data-level="11.5" data-path="pointpatterns.html"><a href="pointpatterns.html#simulating-points-on-the-globe"><i class="fa fa-check"></i><b>11.5</b> Simulating points on the globe</a></li>
<li class="chapter" data-level="11.6" data-path="pointpatterns.html"><a href="pointpatterns.html#exercises-9"><i class="fa fa-check"></i><b>11.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="interpolation.html"><a href="interpolation.html"><i class="fa fa-check"></i><b>12</b> Spatial Interpolation</a><ul>
<li class="chapter" data-level="12.1" data-path="interpolation.html"><a href="interpolation.html#a-first-dataset"><i class="fa fa-check"></i><b>12.1</b> A first dataset</a></li>
<li class="chapter" data-level="12.2" data-path="interpolation.html"><a href="interpolation.html#sample-variogram"><i class="fa fa-check"></i><b>12.2</b> Sample variogram</a></li>
<li class="chapter" data-level="12.3" data-path="interpolation.html"><a href="interpolation.html#fitting-variogram-models"><i class="fa fa-check"></i><b>12.3</b> Fitting variogram models</a></li>
<li class="chapter" data-level="12.4" data-path="interpolation.html"><a href="interpolation.html#kriging"><i class="fa fa-check"></i><b>12.4</b> Kriging interpolation</a></li>
<li class="chapter" data-level="12.5" data-path="interpolation.html"><a href="interpolation.html#blockkriging"><i class="fa fa-check"></i><b>12.5</b> Areal means: block kriging</a></li>
<li class="chapter" data-level="12.6" data-path="interpolation.html"><a href="interpolation.html#conditional-simulation"><i class="fa fa-check"></i><b>12.6</b> Conditional simulation</a></li>
<li class="chapter" data-level="12.7" data-path="interpolation.html"><a href="interpolation.html#trend-models"><i class="fa fa-check"></i><b>12.7</b> Trend models</a></li>
<li class="chapter" data-level="12.8" data-path="interpolation.html"><a href="interpolation.html#exercises-10"><i class="fa fa-check"></i><b>12.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="stgeostatistics.html"><a href="stgeostatistics.html"><i class="fa fa-check"></i><b>13</b> Multivariate and Spatiotemporal Geostatistics</a><ul>
<li class="chapter" data-level="13.1" data-path="stgeostatistics.html"><a href="stgeostatistics.html#preparing"><i class="fa fa-check"></i><b>13.1</b> Preparing the air quality dataset</a></li>
<li class="chapter" data-level="13.2" data-path="stgeostatistics.html"><a href="stgeostatistics.html#cokriging"><i class="fa fa-check"></i><b>13.2</b> Multivariable geostatistics</a></li>
<li class="chapter" data-level="13.3" data-path="stgeostatistics.html"><a href="stgeostatistics.html#spatiotemporal-geostatistics"><i class="fa fa-check"></i><b>13.3</b> Spatiotemporal geostatistics</a></li>
<li class="chapter" data-level="13.4" data-path="stgeostatistics.html"><a href="stgeostatistics.html#exercises-11"><i class="fa fa-check"></i><b>13.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="area.html"><a href="area.html"><i class="fa fa-check"></i><b>14</b> Proximity and Areal Data</a><ul>
<li class="chapter" data-level="14.1" data-path="area.html"><a href="area.html#representing-proximity-in-spdep"><i class="fa fa-check"></i><b>14.1</b> Representing proximity in <strong>spdep</strong></a></li>
<li class="chapter" data-level="14.2" data-path="area.html"><a href="area.html#contiguous-neighbours"><i class="fa fa-check"></i><b>14.2</b> Contiguous neighbours</a></li>
<li class="chapter" data-level="14.3" data-path="area.html"><a href="area.html#graph-based-neighbours"><i class="fa fa-check"></i><b>14.3</b> Graph-based neighbours</a></li>
<li class="chapter" data-level="14.4" data-path="area.html"><a href="area.html#distance-based-neighbours"><i class="fa fa-check"></i><b>14.4</b> Distance-based neighbours</a></li>
<li class="chapter" data-level="14.5" data-path="area.html"><a href="area.html#weights-specification"><i class="fa fa-check"></i><b>14.5</b> Weights specification</a></li>
<li class="chapter" data-level="14.6" data-path="area.html"><a href="area.html#higher-order-neighbours"><i class="fa fa-check"></i><b>14.6</b> Higher order neighbours</a></li>
<li class="chapter" data-level="14.7" data-path="area.html"><a href="area.html#exercises-12"><i class="fa fa-check"></i><b>14.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="spatautocorr.html"><a href="spatautocorr.html"><i class="fa fa-check"></i><b>15</b> Measures of spatial autocorrelation</a><ul>
<li class="chapter" data-level="15.1" data-path="spatautocorr.html"><a href="spatautocorr.html#measures-and-process-mis-specification"><i class="fa fa-check"></i><b>15.1</b> Measures and process mis-specification</a></li>
<li class="chapter" data-level="15.2" data-path="spatautocorr.html"><a href="spatautocorr.html#global-measures"><i class="fa fa-check"></i><b>15.2</b> Global measures</a></li>
<li class="chapter" data-level="15.3" data-path="spatautocorr.html"><a href="spatautocorr.html#local-measures"><i class="fa fa-check"></i><b>15.3</b> Local measures</a></li>
<li class="chapter" data-level="15.4" data-path="spatautocorr.html"><a href="spatautocorr.html#exercises-13"><i class="fa fa-check"></i><b>15.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="spatglmm.html"><a href="spatglmm.html"><i class="fa fa-check"></i><b>16</b> Spatial Regression</a><ul>
<li class="chapter" data-level="16.1" data-path="spatglmm.html"><a href="spatglmm.html#markov-random-field-and-multilevel-models-with-spatial-weights"><i class="fa fa-check"></i><b>16.1</b> Markov random field and multilevel models with spatial weights</a></li>
<li class="chapter" data-level="16.2" data-path="spatglmm.html"><a href="spatglmm.html#multilevel-models-of-the-boston-data-set"><i class="fa fa-check"></i><b>16.2</b> Multilevel models of the Boston data set</a></li>
<li class="chapter" data-level="16.3" data-path="spatglmm.html"><a href="spatglmm.html#exercises-14"><i class="fa fa-check"></i><b>16.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="spatecon.html"><a href="spatecon.html"><i class="fa fa-check"></i><b>17</b> Spatial econometrics models</a><ul>
<li class="chapter" data-level="17.1" data-path="spatecon.html"><a href="spatecon.html#spatial-econometric-models-definitions"><i class="fa fa-check"></i><b>17.1</b> Spatial econometric models: definitions</a></li>
<li class="chapter" data-level="17.2" data-path="spatecon.html"><a href="spatecon.html#maximum-likelihood-estimation-in-spatialreg"><i class="fa fa-check"></i><b>17.2</b> Maximum likelihood estimation in <strong>spatialreg</strong></a></li>
<li class="chapter" data-level="17.3" data-path="spatecon.html"><a href="spatecon.html#impacts"><i class="fa fa-check"></i><b>17.3</b> Impacts</a></li>
<li class="chapter" data-level="17.4" data-path="spatecon.html"><a href="spatecon.html#spateconpred"><i class="fa fa-check"></i><b>17.4</b> Predictions</a></li>
<li class="chapter" data-level="17.5" data-path="spatecon.html"><a href="spatecon.html#exercises-15"><i class="fa fa-check"></i><b>17.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="older.html"><a href="older.html"><i class="fa fa-check"></i><b>18</b> Older R Spatial Packages</a><ul>
<li class="chapter" data-level="18.1" data-path="older.html"><a href="older.html#retire"><i class="fa fa-check"></i><b>18.1</b> Retiring <code>rgdal</code> and <code>rgeos</code></a></li>
<li class="chapter" data-level="18.2" data-path="older.html"><a href="older.html#links-and-differences-between-sf-and-sp"><i class="fa fa-check"></i><b>18.2</b> Links and differences between sf and sp</a></li>
<li class="chapter" data-level="18.3" data-path="older.html"><a href="older.html#migration-code-and-packages"><i class="fa fa-check"></i><b>18.3</b> Migration code and packages</a></li>
<li class="chapter" data-level="18.4" data-path="older.html"><a href="older.html#package-raster-and-terra"><i class="fa fa-check"></i><b>18.4</b> Package raster and terra</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="all-r-code-in-this-book.html"><a href="all-r-code-in-this-book.html"><i class="fa fa-check"></i>All R code in this book</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html"><i class="fa fa-check"></i>R basics</a><ul>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#pipes"><i class="fa fa-check"></i>Pipes</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#data-structures"><i class="fa fa-check"></i>Data structures</a></li>
<li><a href="r-basics.html#dissecting-a-multipolygon">dissecting a <code>MULTIPOLYGON</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="area" class="section level1">
<h1><span class="header-section-number">Chapter 14</span> Proximity and Areal Data</h1>
<p>Areal units of observation are very often used when simultaneous observations are aggregated within non-overlapping boundaries. The boundaries may be those of administrative entities, and may be related to underlying spatial processes, such as commuting flows, but are usually arbitrary. If they do not match the underlying and unobserved spatial processes in one or more variables of interest, proximate areal units will contain parts of the underlying processes, engendering spatial autocorrelation. By proximity, we mean <em>closeness</em> in ways that make sense for the data generation processes thought to be involved. In cross-sectional geostatistical analysis with point support, measured distance makes sense for typical data generation processes. In similar analysis of areal data, sharing a border may make more sense, because that is what we do know, but we cannot measure the distance between the areas in as adequate a way.</p>
<p>With support of data we mean the physical size (length, area, volume) associated with an individual observational unit (measurement). It is possible to represent the support of areal data by a point, despite the fact that the data have polygonal support. The centroid of the polygon may be taken as a representative point, or the centroid of the largest polygon in a multi-polygon object. When data with intrinsic point support are treated as areal data, the change of support goes the other way, from the known point to a non-overlapping tessellation such as a Voronoi diagram or Dirichlet tessellation or Thiessen polygons often through a Delaunay triangulation using projected coordinates. Here, different metrics may also be chosen, or distances measured on a network rather than on the plane. There is also a literature using weighted Voronoi diagrams in local spatial analysis <span class="citation">(see for example Boots and Okabe <a href="#ref-doi:10.1080/13658810601034267">2007</a>; Okabe et al. <a href="#ref-doi:10.1080/13658810701587891">2008</a>; She et al. <a href="#ref-SHE201570">2015</a>)</span>.</p>
<p>When the intrinsic support of the data is represented as points, but the underlying process is between proximate observations rather than driven chiefly by distance however measured between observations, the data may be aggregate counts or totals (polling stations, retail turnover) or represent a directly observed characteristic of the observation (opening hours of the polling station). Obviously, the risk of mis-representing the footprint of the underlying spatial processes remains in all of these cases, not least because the observations are taken as encompassing the entirety of the underlying process in the case of tessellation of the whole area of interest. This is distinct from the geostatistical setting in which observations are rather samples taken using some scheme within the area of interest. It is also partly distinct from the practice of taking areal sample plots within the area of interest but covering only a small proportion of the area, typically used in ecological and environmental research.</p>
<p>In order to explore and analyse areal data of these kinds in chapters <a href="spatautocorr.html#spatautocorr">15</a>, <a href="spatglmm.html#spatglmm">16</a> and <a href="spatecon.html#spatecon">17</a>, methods are needed to represent the proximity of observations. This chapter then considers a subset of the such methods, where the spatial processes are considered as working through proximity understood in the first instance as contiguity, as a graph linking observations taken as neighbours. This graph is typically undirected and unweighted, but may be directed and/or weighted in certain settings, which then leads to further issues with regard to symmetry. In principle, proximity would be expected to operate symmetrically in space, that is that the influence of <span class="math inline">\(i\)</span> on <span class="math inline">\(j\)</span> and of <span class="math inline">\(j\)</span> on <span class="math inline">\(i\)</span> based on their relative positions should be equivalent. Edge effects are not considered in standard treatments.</p>
<div id="representing-proximity-in-spdep" class="section level2">
<h2><span class="header-section-number">14.1</span> Representing proximity in <strong>spdep</strong></h2>
<p>Handling spatial autocorrelation using relationships to neighbours on a graph takes the graph as given, chosen by the analyst. This differs from the geostatistical approach in which the analyst chooses the binning of the empirical variogram and function used, and then the way the variogram is fitted. Both involve a priori choices, but represent the underlying correlation in different ways <span class="citation">(Wall <a href="#ref-wall:04">2004</a>)</span>. In Bavaud <span class="citation">(<a href="#ref-bavaud:98">1998</a>)</span> and work citing his contribution, attempts have been made to place graph-based neighbours in a broader context.</p>
<p>One issue arising in the creation of objects representing neighbourhood relationships is that of no-neighbour areal units <span class="citation">(Bivand and Portnov <a href="#ref-bivand+portnov:04">2004</a>)</span>. Islands or units separated by rivers may not be recognised as neighbours when the units have areal support and when using topological relationships such as shared boundaries. In some settings, for example <code>mrf</code> (Markov Random Field) terms in <code>mgcv::gam()</code> and similar model fitting functions that require undirected connected graphs, a requirement which is violated when there are disconnected subgraphs.</p>
<p>No-neighbour observations can also occur when a distance threshold is used between points, where the threshold is smaller than the maximum nearest neighbour distance. Shared boundary contiguities are not affected by using geographical, unprojected coordinates, but all point-based approaches use distance in one way or another, and need to calculate distances in an appropriate way.</p>
<p>The <strong>spdep</strong> package provides an <code>nb</code> class for neighbours, a list of length equal to the number of observations, with integer vector components. No-neighbours are encoded as an integer vector with a single element <code>0L</code>, and observations with neighbours as sorted integer vectors containing values in <code>1L:n</code> pointing to the neighbouring observations. This is a typical row-oriented sparse representation of neighbours. <strong>spdep</strong> provides many ways of constructing <code>nb</code> objects, and the representation and construction functions are widely used in other packages.</p>
<p><strong>spdep</strong> builds on the <code>nb</code> representation (undirected or directed graphs) with the <code>listw</code> object, a list with three components, an <code>nb</code> object, a matching list of numerical weights, and a single element character vector containing the single letter name of the way in which the weights were calculated. The most frequently used approach in the social sciences is calculating weights by row standardization, so that all the non-zero weights for one observation will be the inverse of the cardinality of its set of neighbours (<code>1/card(nb[[i]])</code>).</p>
<p>We will be using election data from the 2015 Polish Presidential election in this chapter, with 2495 municipalities and Warsaw boroughs (see figure <a href="area.html#fig:plotpolpres15">14.1</a> for a <strong>tmap</strong> map (section <a href="plotting.html#tmap">9.5</a>) of the municipality types), and complete count data from polling stations aggregated to these areal units. The data are an <strong>sf</strong> <code>sf</code> object:</p>
<div class="sourceCode" id="cb448"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb448-1" title="1"><span class="kw">library</span>(sf)</a></code></pre></div>
<div class="sourceCode" id="cb449"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb449-1" title="1"><span class="kw">data</span>(pol_pres15, <span class="dt">package =</span> <span class="st">&quot;spDataLarge&quot;</span>)</a>
<a class="sourceLine" id="cb449-2" title="2">pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb449-3" title="3"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select =</span> <span class="kw">c</span>(TERYT, name, types)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb449-4" title="4"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code># Simple feature collection with 6 features and 3 fields
# Geometry type: MULTIPOLYGON
# Dimension:     XY
# Bounding box:  xmin: 235000 ymin: 367000 xmax: 281000 ymax: 413000
# Projected CRS: ETRS89 / Poland CS92
#    TERYT                name       types                       geometry
# 1 020101         BOLESŁAWIEC       Urban MULTIPOLYGON (((261089 3855...
# 2 020102         BOLESŁAWIEC       Rural MULTIPOLYGON (((254150 3837...
# 3 020103            GROMADKA       Rural MULTIPOLYGON (((275346 3846...
# 4 020104        NOWOGRODZIEC Urban/rural MULTIPOLYGON (((251770 3770...
# 5 020105          OSIECZNICA       Rural MULTIPOLYGON (((263424 4060...
# 6 020106 WARTA BOLESŁAWIECKA       Rural MULTIPOLYGON (((267031 3870...</code></pre>

<div class="sourceCode" id="cb451"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb451-1" title="1"><span class="kw">library</span>(tmap)</a>
<a class="sourceLine" id="cb451-2" title="2"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;types&quot;</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:plotpolpres15"></span>
<img src="sds_files/figure-html/plotpolpres15-1.png" alt="Polish municipality types 2015" width="100%" />
<p class="caption">
Figure 14.1: Polish municipality types 2015
</p>
</div>
<p>For safety’s sake, we impose topological validity:</p>
<div class="sourceCode" id="cb452"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb452-1" title="1"><span class="cf">if</span> (<span class="op">!</span><span class="kw">all</span>(<span class="kw">st_is_valid</span>(pol_pres15))) pol_pres15 &lt;-<span class="st"> </span><span class="kw">st_make_valid</span>(pol_pres15)</a></code></pre></div>
<p>Between early 2002 and April 2019, <strong>spdep</strong> contained functions for constructing and handling neighbour and spatial weights objects, tests for spatial autocorrelation, and model fitting functions. The latter have been split out into <strong>spatialreg</strong>, and will be discussed in the next chapter. <strong>spdep</strong> <span class="citation">(R. Bivand <a href="#ref-R-spdep">2021</a><a href="#ref-R-spdep">b</a>)</span> now accommodates objects represented using <strong>sf</strong> classes and <strong>sp</strong> classes directly.</p>
<div class="sourceCode" id="cb453"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb453-1" title="1"><span class="kw">library</span>(spdep)</a></code></pre></div>
</div>
<div id="contiguous-neighbours" class="section level2">
<h2><span class="header-section-number">14.2</span> Contiguous neighbours</h2>
<p>The <code>poly2nb()</code> function in <strong>spdep</strong> takes the boundary points making up the polygon boundaries in the object passed as the <code>pl=</code> argument, typically an <code>"sf"</code> or <code>"sfc"</code> object with <code>"POLYGON"</code> or <code>"MULTIPOLYGON"</code> geometries. For each observation, the function checks whether at least one (<code>queen=TRUE</code>, default), or at least two (rook, <code>queen=FALSE</code>) points are within <code>snap=</code> distance units of each other. The distances are planar in the raw coordinate units, ignoring geographical projections. Once the required number of sufficiently close points is found, the search is stopped.</p>
<div class="sourceCode" id="cb454"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb454-1" title="1"><span class="kw">args</span>(poly2nb)</a></code></pre></div>
<pre><code># function (pl, row.names = NULL, snap = sqrt(.Machine$double.eps), 
#     queen = TRUE, useC = TRUE, foundInBox = NULL) 
# NULL</code></pre>
<p>From <strong>spdep</strong> 1.1-7, the GEOS interface of the <strong>sf</strong> package is used within <code>poly2nb()</code> if <code>foundInBox=NULL</code> to find the candidate neighbours and populate <code>foundInBox</code> internally. In this case, this use of spatial indexing (STRtree queries) in GEOS through <strong>sf</strong> is the default:</p>
<div class="sourceCode" id="cb456"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb456-1" title="1"><span class="kw">system.time</span>(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">poly2nb</span>(<span class="dt">queen =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>nb_q)</a></code></pre></div>
<pre><code>#    user  system elapsed 
#   0.654   0.000   0.655</code></pre>
<p>Earlier, <code>foundInBox=</code> accepted the output of the <strong>rgeos</strong> <code>gUnarySTRtreeQuery()</code> function to list candidate neighbours, that is polygons whose bounding boxes intersect the bounding boxes of other polygons. The print method shows the summary structure of the neighbour object:</p>
<div class="sourceCode" id="cb458"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb458-1" title="1">nb_q</a></code></pre></div>
<pre><code># Neighbour list object:
# Number of regions: 2495 
# Number of nonzero links: 14242 
# Percentage nonzero weights: 0.229 
# Average number of links: 5.71</code></pre>
<p>From <strong>sf</strong> version 1.0-0, the <strong>s2</strong> package <span class="citation">(Dunnington, Pebesma, and Rubak <a href="#ref-R-s2">2021</a>)</span> is used by default for spherical geometries, as <code>st_intersects()</code> used in <code>poly2nb()</code> passes calculation to <code>s2::s2_intersects_matrix()</code> (see chapter <a href="spherical.html#spherical">4</a>). From <strong>spdep</strong> version 1.1-9, if <code>sf_use_s2()</code>is <code>TRUE</code>, spherical intersection is used to find candidate neighbours; as with GEOS, the underlying <code>s2</code> library uses fast spatial indexing.</p>
<div class="sourceCode" id="cb460"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb460-1" title="1"><span class="kw">sf_use_s2</span>(<span class="ot">TRUE</span>)</a></code></pre></div>
<div class="sourceCode" id="cb461"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb461-1" title="1">(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;OGC:CRS84&quot;</span>) -&gt;<span class="st"> </span>pol_pres15_ll) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb461-2" title="2"><span class="st">    </span><span class="kw">poly2nb</span>(<span class="dt">queen =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>nb_q_s2</a></code></pre></div>
<p>Spherical and planar intersection of the input polygons yield the same contiguity neighbours in this case; in both cases valid input geometries are desirable:</p>
<div class="sourceCode" id="cb462"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb462-1" title="1"><span class="kw">all.equal</span>(nb_q, nb_q_s2, <span class="dt">check.attributes=</span><span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code># [1] TRUE</code></pre>
<p>Note that <code>nb</code> objects record both symmetric neighbour relationships, because these objects admit asymmetric relationships as well, but these duplications are not needed for object construction.</p>
<p>Most of the <strong>spdep</strong> functions for constructing neighbour objects take a <code>row.names=</code> argument, the value of which is stored as a <code>region.id</code> attribute. If not given, the values are taken from <code>row.names()</code> of the first argument. These can be used to check that the neighbours object is in the same order as data. If <code>nb</code> objects are subsetted, the indices change to continue to be within <code>1:length(subsetted_nb)</code>, but the <code>region.id</code> attribute values point back to the object from which it was constructed. This is used in out-of-sample prediction from spatial regression models discussed briefly in section <a href="spatecon.html#spateconpred">17.4</a>.</p>
<p>We can also check that this undirected graph is connected using the <code>n.comp.nb()</code> function; while some model estimation techniques do not support graphs that are not connected, it is helpful to be aware of possible problems <span class="citation">(Freni-Sterrantino, Ventrucci, and Rue <a href="#ref-FRENISTERRANTINO201825">2018</a>)</span>:</p>
<div class="sourceCode" id="cb464"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb464-1" title="1">(nb_q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>())<span class="op">$</span>nc</a></code></pre></div>
<pre><code># [1] 1</code></pre>
<p>This approach is equivalent to treating the neighbour object as a graph and using graph analysis on that graph <span class="citation">(Csardi and Nepusz <a href="#ref-csardi+nepusz:06">2006</a>; file. <a href="#ref-R-igraph">2021</a>)</span>, by first coercing to a binary sparse matrix <span class="citation">(D. Bates and Maechler <a href="#ref-R-Matrix">2021</a>)</span>:</p>
<div class="sourceCode" id="cb466"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb466-1" title="1"><span class="kw">library</span>(Matrix, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb466-2" title="2">nb_q <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb466-3" title="3"><span class="st">    </span><span class="kw">nb2listw</span>(<span class="dt">style =</span> <span class="st">&quot;B&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb466-4" title="4"><span class="st">    </span><span class="kw">as</span>(<span class="st">&quot;CsparseMatrix&quot;</span>) -&gt;<span class="st"> </span>smat</a>
<a class="sourceLine" id="cb466-5" title="5"><span class="kw">library</span>(igraph, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb466-6" title="6">(smat <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb466-7" title="7"><span class="st">        </span><span class="kw">graph.adjacency</span>() -&gt;<span class="st"> </span>g1) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb466-8" title="8"><span class="st">    </span><span class="kw">count_components</span>()</a></code></pre></div>
<pre><code># [1] 1</code></pre>
<p>Neighbour objects may be exported and imported in GAL format for exchange with other software, using <code>write.nb.gal()</code> and <code>read.gal()</code>:</p>
<div class="sourceCode" id="cb468"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb468-1" title="1">tf &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">&quot;.gal&quot;</span>)</a>
<a class="sourceLine" id="cb468-2" title="2"><span class="kw">write.nb.gal</span>(nb_q, tf)</a></code></pre></div>
</div>
<div id="graph-based-neighbours" class="section level2">
<h2><span class="header-section-number">14.3</span> Graph-based neighbours</h2>
<p>If areal units are an appropriate representation, but only points on the plane have been observed, contiguity relationships may be approximated using graph-based neighbours. In this case, the imputed boundaries tessellate the plane such that points closer to one observation than any other fall within its polygon. The simplest form is by using triangulation, here using the <code>deldir()</code> function in the <strong>deldir</strong> package. Because the function returns from <span class="math inline">\(i\)</span> and to <span class="math inline">\(j\)</span> identifiers, it is easy to construct a long representation of a <code>listw</code> object, as used in the S-Plus SpatialStats module and the <code>sn2listw()</code> function internally to construct an <code>nb</code> object (ragged wide representation). Alternatives such as GEOS often fail to return sufficient information to permit the neighbours to be identified.</p>
<p>The output of these functions is then converted to the <code>nb</code> representation using <code>graph2nb()</code>, with the possible use of the <code>sym=</code> argument to coerce to symmetry. We take the centroids of the largest component polygon for each observation as the point representation; population-weighted centroids might have been a better choice if they were available:</p>
<div class="sourceCode" id="cb469"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb469-1" title="1">pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb469-2" title="2"><span class="st">    </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb469-3" title="3"><span class="st">    </span><span class="kw">st_centroid</span>(<span class="dt">of_largest_polygon =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>coords </a>
<a class="sourceLine" id="cb469-4" title="4">(coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tri2nb</span>() -&gt;<span class="st"> </span>nb_tri)</a></code></pre></div>
<pre><code># Neighbour list object:
# Number of regions: 2495 
# Number of nonzero links: 14930 
# Percentage nonzero weights: 0.24 
# Average number of links: 5.98</code></pre>
<p>The average number of neighbours is similar to the Queen boundary contiguity case, but if we look at the distribution of edge lengths using <code>nbdists()</code>, we can see that although the upper quartile is about 15 km, the maximum is almost 300 km, an edge along much of one side of the convex hull. The short minimum distance is also of interest, as many centroids of urban municipalities are very close to the centroids of their surrounding rural counterparts.</p>
<div class="sourceCode" id="cb471"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb471-1" title="1">nb_tri <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb471-2" title="2"><span class="st">    </span><span class="kw">nbdists</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb471-3" title="3"><span class="st">    </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb471-4" title="4"><span class="st">    </span><span class="kw">summary</span>()</a></code></pre></div>
<pre><code>#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#     247    9847   12151   13485   14994  296974</code></pre>
<p>Triangulated neighbours also yield a connected graph:</p>
<div class="sourceCode" id="cb473"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb473-1" title="1">(nb_tri <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>())<span class="op">$</span>nc</a></code></pre></div>
<pre><code># [1] 1</code></pre>
<p>Graph-based approaches include <code>soi.graph()</code> - discussed here, <code>relativeneigh()</code> and <code>gabrielneigh()</code>.</p>
<p>The Sphere of Influence <code>soi.graph()</code> function takes triangulated neighbours and prunes off neighbour relationships represented by edges that are unusually long for each point, especially around the convex hull <span class="citation">(Avis and Horton <a href="#ref-avis+horton:1985">1985</a>)</span>.</p>
<div class="sourceCode" id="cb475"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb475-1" title="1">(nb_tri <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb475-2" title="2"><span class="st">        </span><span class="kw">soi.graph</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb475-3" title="3"><span class="st">        </span><span class="kw">graph2nb</span>() -&gt;<span class="st"> </span>nb_soi)</a></code></pre></div>
<pre><code># Neighbour list object:
# Number of regions: 2495 
# Number of nonzero links: 12792 
# Percentage nonzero weights: 0.205 
# Average number of links: 5.13</code></pre>
<p>Unpicking the triangulated neighbours does however remove the connected character of the underlying graph:</p>
<div class="sourceCode" id="cb477"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb477-1" title="1">(nb_soi <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>() -&gt;<span class="st"> </span>n_comp)<span class="op">$</span>nc</a></code></pre></div>
<pre><code># [1] 16</code></pre>
<p>The algorithm has stripped out longer edges leading to urban and rural municipality pairs where their centroids are very close to each other because the rural ones completely surround the urban, giving 15 pairs of neighbours unconnected to the main graph:</p>
<div class="sourceCode" id="cb479"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb479-1" title="1"><span class="kw">table</span>(n_comp<span class="op">$</span>comp.id)</a></code></pre></div>
<pre><code># 
#    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15   16 
# 2465    2    2    2    2    2    2    2    2    2    2    2    2    2    2    2</code></pre>
<p>The largest length edges along the convex hull have been removed, but “holes” have appeared where the unconnected pairs of neighbours have appeared. The differences between <code>nb_tri</code> and <code>nb_soi</code> are shown in orange in Figure <a href="area.html#fig:plotnbdiff">14.2</a>.</p>

<div class="sourceCode" id="cb481"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb481-1" title="1">opar &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)<span class="op">+</span><span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb481-2" title="2">pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb481-3" title="3"><span class="st">    </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb481-4" title="4"><span class="st">    </span><span class="kw">plot</span>(<span class="dt">border =</span> <span class="st">&quot;grey&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb481-5" title="5">nb_soi <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb481-6" title="6"><span class="st">    </span><span class="kw">plot</span>(<span class="dt">coords =</span> coords, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">points =</span> <span class="ot">FALSE</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb481-7" title="7">nb_tri <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb481-8" title="8"><span class="st">    </span><span class="kw">diffnb</span>(nb_soi) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb481-9" title="9"><span class="st">    </span><span class="kw">plot</span>(<span class="dt">coords =</span> coords, <span class="dt">col =</span> <span class="st">&quot;orange&quot;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">points =</span> <span class="ot">FALSE</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:plotnbdiff"></span>
<img src="sds_files/figure-html/plotnbdiff-1.png" alt="Triangulated (orange + black) and sphere of influence neighbours (black)" width="100%" />
<p class="caption">
Figure 14.2: Triangulated (orange + black) and sphere of influence neighbours (black)
</p>
</div>
<div class="sourceCode" id="cb482"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb482-1" title="1"><span class="kw">par</span>(opar)</a></code></pre></div>
</div>
<div id="distance-based-neighbours" class="section level2">
<h2><span class="header-section-number">14.4</span> Distance-based neighbours</h2>
<p>Distance-based neighbours can be constructed using <code>dnearneigh()</code>, with a distance band with lower <code>d1=</code> and upper <code>d2=</code> bounds controlled by the <code>bounds=</code> argument. If spherical coordinates are used and either specified in the coordinates object <code>x</code> or with <code>x</code> as a two column matrix and <code>longlat=TRUE</code>, great circle distances in km will be calculated assuming the WGS84 reference ellipsoid, or if <code>use_s2=TRUE</code>, a 200-cell <code>s2</code> buffer is constructed around each point, points falling within the buffer chosen, and then chosen points beyond <code>d2=</code> dropped. From tests, it appears that spherical spatial indexing is not used, and so is slower than the legacy brute-force approach (see chapter <a href="spherical.html#spherical">4</a>).</p>
<p>From <strong>spdep</strong> 1.1-7, two arguments have been added, to use functionality in the <strong>dbscan</strong> package <span class="citation">(Hahsler and Piekenbrock <a href="#ref-R-dbscan">2021</a>)</span> for finding neighbours using planar spatial indexing in two or three dimensions by default, and not to test the symmetry of the output neighbour object.</p>
<p>The <code>knearneigh()</code> function for <span class="math inline">\(k\)</span>-nearest neighbours returns a <code>knn</code> object, converted to an <code>nb</code> object using <code>knn2nb()</code>. It can also use great circle distances, not least because nearest neighbours may differ when uprojected coordinates are treated as planar. <code>k=</code> should be a small number. For projected coordinates, the <strong>dbscan</strong> package is used to compute nearest neighbours more efficiently. Note that <code>nb</code> objects constructed in this way are most unlikely to be symmetric, hence <code>knn2nb()</code> has a <code>sym=</code> argument to permit the imposition of symmetry, which will mean that all units have at least <code>k=</code> neighbours, not that all units will have exactly <code>k=</code> neighbours. From <strong>spdep</strong> version 1.1-9 and when <code>sf_use_s2()</code> is <code>TRUE</code>, <code>knearneigh()</code> will use fast spherical spatial indexing when the input object is of class <code>"sf"</code> or <code>"sfc"</code>.</p>
<p>The <code>nbdists()</code> function returns the length of neighbour relationship edges in the units of the coordinates if the coordinates are projected, in km otherwise. In order to set the upper limit for distance bands, one may first find the maximum first nearest neighbour distance, using <code>unlist()</code> to remove the list structure of the returned object. From <strong>spdep</strong> version 1.1-9 and when <code>sf_use_s2()</code> is <code>TRUE</code>, <code>nbdists()</code> will use fast spherical distance calculations when the input object is of class <code>"sf"</code> or <code>"sfc"</code>.</p>
<div class="sourceCode" id="cb483"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb483-1" title="1">coords <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb483-2" title="2"><span class="st">    </span><span class="kw">knearneigh</span>(<span class="dt">k =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb483-3" title="3"><span class="st">    </span><span class="kw">knn2nb</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb483-4" title="4"><span class="st">    </span><span class="kw">nbdists</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb483-5" title="5"><span class="st">    </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb483-6" title="6"><span class="st">    </span><span class="kw">summary</span>()</a></code></pre></div>
<pre><code>#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#     247    6663    8538    8275   10124   17979</code></pre>
<p>Here the largest first nearest neighbour distance is just under 18 km, so using this as the upper threshold gives certainty that all units will have at least one neighbour:</p>
<div class="sourceCode" id="cb485"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb485-1" title="1"><span class="kw">system.time</span>(coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">18000</span>) -&gt;<span class="st"> </span>nb_d18)</a></code></pre></div>
<pre><code>#    user  system elapsed 
#   0.176   0.000   0.176</code></pre>
<p>For this moderate number of observations, use of spatial indexing does not yield advantages in run times:</p>
<div class="sourceCode" id="cb487"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb487-1" title="1"><span class="kw">system.time</span>(coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">18000</span>, <span class="dt">use_kd_tree =</span> <span class="ot">FALSE</span>) -&gt;<span class="st"> </span>nb_d18a)</a></code></pre></div>
<pre><code>#    user  system elapsed 
#   0.169   0.000   0.169</code></pre>
<p>and the output objects are the same:</p>
<div class="sourceCode" id="cb489"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb489-1" title="1"><span class="kw">all.equal</span>(nb_d18, nb_d18a, <span class="dt">check.attributes =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code># [1] TRUE</code></pre>
<div class="sourceCode" id="cb491"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb491-1" title="1">nb_d18</a></code></pre></div>
<pre><code># Neighbour list object:
# Number of regions: 2495 
# Number of nonzero links: 20358 
# Percentage nonzero weights: 0.327 
# Average number of links: 8.16</code></pre>
<p>However, even though there are no no-neighbour observations (their presence is reported by the print method for <code>nb</code> objects), the graph is not connected, as a pair of observations are each others’ only neighbours.</p>
<div class="sourceCode" id="cb493"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb493-1" title="1">(nb_d18 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>() -&gt;<span class="st"> </span>n_comp)<span class="op">$</span>nc</a></code></pre></div>
<pre><code># [1] 2</code></pre>
<div class="sourceCode" id="cb495"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb495-1" title="1"><span class="kw">table</span>(n_comp<span class="op">$</span>comp.id)</a></code></pre></div>
<pre><code># 
#    1    2 
# 2493    2</code></pre>
<p>Adding 300 m to the threshold gives us a neighbour object with no no-neighbour units, and all units can be reached from all others across the graph.</p>
<div class="sourceCode" id="cb497"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb497-1" title="1">(coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">18300</span>) -&gt;<span class="st"> </span>nb_d183)</a></code></pre></div>
<pre><code># Neighbour list object:
# Number of regions: 2495 
# Number of nonzero links: 21086 
# Percentage nonzero weights: 0.339 
# Average number of links: 8.45</code></pre>
<div class="sourceCode" id="cb499"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb499-1" title="1">(nb_d183 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>())<span class="op">$</span>nc</a></code></pre></div>
<pre><code># [1] 1</code></pre>
<p>One characteristic of distance-based neighbours is that more densely settled areas, with units which are smaller in terms of area (Warsaw boroughs are much smaller on average, but have almost 30 neighbours). Having many neighbours smooths the neighbour relationship across more neighbours.</p>
<p>For use later, we also construct a neighbour object with no-neighbour units, using a threshold of 16 km:</p>
<div class="sourceCode" id="cb501"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb501-1" title="1">(coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">16000</span>) -&gt;<span class="st"> </span>nb_d16)</a></code></pre></div>
<pre><code># Neighbour list object:
# Number of regions: 2495 
# Number of nonzero links: 15850 
# Percentage nonzero weights: 0.255 
# Average number of links: 6.35 
# 7 regions with no links:
# 569 1371 1522 2374 2385 2473 2474</code></pre>
<p>It is possible to control the numbers of neighbours directly using <span class="math inline">\(k\)</span>-nearest neighbours, either accepting asymmetric neighbours:</p>
<div class="sourceCode" id="cb503"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb503-1" title="1">((coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">knearneigh</span>(<span class="dt">k =</span> <span class="dv">6</span>) -&gt;<span class="st"> </span>knn_k6) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">knn2nb</span>() -&gt;<span class="st"> </span>nb_k6)</a></code></pre></div>
<pre><code># Neighbour list object:
# Number of regions: 2495 
# Number of nonzero links: 14970 
# Percentage nonzero weights: 0.24 
# Average number of links: 6 
# Non-symmetric neighbours list</code></pre>
<p>or imposing symmetry:</p>
<div class="sourceCode" id="cb505"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb505-1" title="1">(knn_k6 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">knn2nb</span>(<span class="dt">sym =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>nb_k6s)</a></code></pre></div>
<pre><code># Neighbour list object:
# Number of regions: 2495 
# Number of nonzero links: 16810 
# Percentage nonzero weights: 0.27 
# Average number of links: 6.74</code></pre>
<p>Here the size of <code>k=</code> is sufficient to ensure connectedness, although the graph is not planar as edges cross at locations other than nodes, which is not the case for contiguous or graph-based neighbours.</p>
<div class="sourceCode" id="cb507"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb507-1" title="1">(nb_k6s <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>())<span class="op">$</span>nc</a></code></pre></div>
<pre><code># [1] 1</code></pre>
<p>In the case of points on the sphere (see chapter <a href="spherical.html#spherical">4</a>), the output of <code>st_centroid()</code> will differ, so rather than inverse projecting the points, we extract points as geographical coordinates from the inverse projected polygon geometries:</p>
<div class="sourceCode" id="cb509"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb509-1" title="1"><span class="kw">sf_use_s2</span>(<span class="ot">TRUE</span>)</a></code></pre></div>
<div class="sourceCode" id="cb510"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb510-1" title="1">pol_pres15_ll <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb510-2" title="2"><span class="st">    </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb510-3" title="3"><span class="st">    </span><span class="kw">st_centroid</span>(<span class="dt">of_largest_polygon =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>coords_ll</a></code></pre></div>
<p>From <strong>spdep</strong> version 1.1-9, fast spatial indexing in <strong>s2</strong> is used to find the nearest neighbours:</p>
<div class="sourceCode" id="cb511"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb511-1" title="1">(coords_ll <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">knearneigh</span>(<span class="dt">k =</span> <span class="dv">6</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">knn2nb</span>() -&gt;<span class="st"> </span>nb_k6_ll)</a></code></pre></div>
<pre><code># Neighbour list object:
# Number of regions: 2495 
# Number of nonzero links: 14970 
# Percentage nonzero weights: 0.24 
# Average number of links: 6 
# Non-symmetric neighbours list</code></pre>
<p>These neighbours differ from the planar <code>k=6</code> nearest neighbours as would be expected:</p>
<div class="sourceCode" id="cb513"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb513-1" title="1"><span class="kw">isTRUE</span>(<span class="kw">all.equal</span>(nb_k6, nb_k6_ll, <span class="dt">check.attributes =</span> <span class="ot">FALSE</span>))</a></code></pre></div>
<pre><code># [1] FALSE</code></pre>
<p>The <code>nbdists()</code> function also uses <strong>s2</strong> to find distances on the sphere when the <code>"sf"</code> or <code>"sfc"</code>input object is in geographical coordinates (distances returned in kilometres):</p>
<div class="sourceCode" id="cb515"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb515-1" title="1">nb_q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nbdists</span>(coords_ll) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summary</span>()</a></code></pre></div>
<pre><code>#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#     0.2     9.8    12.2    12.6    15.1    33.0</code></pre>
<p>These differ a little for the same weights object when planar coordinates are used (distances returned in the metric of the points):</p>
<div class="sourceCode" id="cb517"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb517-1" title="1">nb_q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nbdists</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summary</span>()</a></code></pre></div>
<pre><code>#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#     247    9822   12173   12651   15117   33102</code></pre>
</div>
<div id="weights-specification" class="section level2">
<h2><span class="header-section-number">14.5</span> Weights specification</h2>
<p>Once neighbour objects are available, further choices need to made in specifying the weights objects. The <code>nb2listw()</code> function is used to create a <code>listw</code> weights object with an <code>nb</code> object, a matching list of weights vectors, and a style specification. Because handling no-neighbour observations now begins to matter, the <code>zero.policy=</code> argument is introduced. By default, this is <code>FALSE</code>, indicating that no-neighbour observations will cause an error, as the spatially lagged value for an observation with no neighbours is not available. By convention, zero is substituted for the lagged value, as the cross product of a vector of zero-valued weights and a data vector, hence the name of <code>zero.policy</code>.</p>
<div class="sourceCode" id="cb519"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb519-1" title="1"><span class="kw">args</span>(nb2listw)</a></code></pre></div>
<pre><code># function (neighbours, glist = NULL, style = &quot;W&quot;, zero.policy = NULL) 
# NULL</code></pre>
<p>We will be using the helper function <code>spweights.constants()</code> below to show some consequences of varying style choices. It returns constants for a <code>listw</code> object, <span class="math inline">\(n\)</span> is the number of observations, <code>n1</code> to <code>n3</code> are <span class="math inline">\(n-1, \ldots\)</span>, <code>nn</code> is <span class="math inline">\(n^2\)</span> and <span class="math inline">\(S_0\)</span>, <span class="math inline">\(S_1\)</span> and <span class="math inline">\(S_2\)</span> are constants, <span class="math inline">\(S_0\)</span> being the sum of the weights. There is a full discussion of the constants in Bivand and Wong <span class="citation">(<a href="#ref-Bivand2018">2018</a>)</span>.</p>
<div class="sourceCode" id="cb521"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb521-1" title="1"><span class="kw">args</span>(spweights.constants)</a></code></pre></div>
<pre><code># function (listw, zero.policy = NULL, adjust.n = TRUE) 
# NULL</code></pre>
<p>The <code>"B"</code> binary style gives a weight of unity to each neighbour relationship, and typically upweights units with no boundaries on the edge of the study area.</p>
<div class="sourceCode" id="cb523"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb523-1" title="1">(nb_q <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb523-2" title="2"><span class="st">        </span><span class="kw">nb2listw</span>(<span class="dt">style =</span> <span class="st">&quot;B&quot;</span>) -&gt;<span class="st"> </span>lw_q_B) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb523-3" title="3"><span class="st">    </span><span class="kw">spweights.constants</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb523-4" title="4"><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb523-5" title="5"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select =</span> <span class="kw">c</span>(n, S0, S1, S2))</a></code></pre></div>
<pre><code>#      n    S0    S1     S2
# 1 2495 14242 28484 357280</code></pre>
<p>The <code>"W"</code> row-standardized style upweights units around the edge of the study area that necessarily have fewer neighbours. This style first gives a weight of unity to each neighbour relationship, then divides these weights by the per unit sums of weights. Naturally this leads to division by zero where there are no neighbours, a not-a-number result, unless the chosen policy is to permit no-neighbour observations. We can see that <span class="math inline">\(S_0\)</span> is now equal to <span class="math inline">\(n\)</span>.</p>
<div class="sourceCode" id="cb525"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb525-1" title="1">(nb_q <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb525-2" title="2"><span class="st">        </span><span class="kw">nb2listw</span>(<span class="dt">style =</span> <span class="st">&quot;W&quot;</span>) -&gt;<span class="st"> </span>lw_q_W) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb525-3" title="3"><span class="st">    </span><span class="kw">spweights.constants</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb525-4" title="4"><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb525-5" title="5"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select =</span> <span class="kw">c</span>(n, S0, S1, S2))</a></code></pre></div>
<pre><code>#      n   S0  S1    S2
# 1 2495 2495 958 10406</code></pre>
<p>Inverse distance weights are used in a number of scientific fields. Some use dense inverse distance matrices, but many of the inverse distances are close to zero, so have little practical contribution, especially as the spatial process matrix is itself dense. Inverse distance weights may be constructed by taking the lengths of edges, changing units to avoid most weights being too large or small (here from m to km), taking the inverse, and passing through the <code>glist=</code> argument to <code>nb2listw()</code>:</p>
<div class="sourceCode" id="cb527"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb527-1" title="1">nb_d183 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb527-2" title="2"><span class="st">    </span><span class="kw">nbdists</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb527-3" title="3"><span class="st">    </span><span class="kw">lapply</span>(<span class="cf">function</span>(x) <span class="dv">1</span><span class="op">/</span>(x<span class="op">/</span><span class="dv">1000</span>)) -&gt;<span class="st"> </span>gwts</a>
<a class="sourceLine" id="cb527-4" title="4">(nb_d183 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nb2listw</span>(<span class="dt">glist=</span>gwts, <span class="dt">style=</span><span class="st">&quot;B&quot;</span>) -&gt;<span class="st"> </span>lw_d183_idw_B) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb527-5" title="5"><span class="st">    </span><span class="kw">spweights.constants</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb527-6" title="6"><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb527-7" title="7"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select=</span><span class="kw">c</span>(n, S0, S1, S2))</a></code></pre></div>
<pre><code>#      n   S0  S1   S2
# 1 2495 1841 534 7265</code></pre>
<p>No-neighbour handling is by default to prevent the construction of a weights object, making the analyst take a position on how to proceed.</p>
<div class="sourceCode" id="cb529"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb529-1" title="1"><span class="kw">try</span>(nb_d16 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nb2listw</span>(<span class="dt">style=</span><span class="st">&quot;B&quot;</span>) -&gt;<span class="st"> </span>lw_d16_B)</a></code></pre></div>
<pre><code># Error in nb2listw(., style = &quot;B&quot;) : Empty neighbour sets found</code></pre>
<p>Use can be made of the <code>zero.policy=</code> argument to many functions used with <code>nb</code> and <code>listw</code> objects.</p>
<div class="sourceCode" id="cb531"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb531-1" title="1">nb_d16 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb531-2" title="2"><span class="st">    </span><span class="kw">nb2listw</span>(<span class="dt">style=</span><span class="st">&quot;B&quot;</span>, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb531-3" title="3"><span class="st">    </span><span class="kw">spweights.constants</span>(<span class="dt">zero.policy=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb531-4" title="4"><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb531-5" title="5"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select=</span><span class="kw">c</span>(n, S0, S1, S2))</a></code></pre></div>
<pre><code>#      n    S0    S1     S2
# 1 2488 15850 31700 506480</code></pre>
<p>Note that by default the <code>adjust.n=</code> argument to <code>spweights.constants()</code> is set by default to <code>TRUE</code>, subtracting the count of no-neighbour observations from the observation count, so <span class="math inline">\(n\)</span> is smaller with possible consequences for inference. The complete count can be retrieved by changing the argument.</p>
</div>
<div id="higher-order-neighbours" class="section level2">
<h2><span class="header-section-number">14.6</span> Higher order neighbours</h2>
<p>We recall the characteristics of the neighbour object based on Queen contiguities:</p>
<div class="sourceCode" id="cb533"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb533-1" title="1">nb_q</a></code></pre></div>
<pre><code># Neighbour list object:
# Number of regions: 2495 
# Number of nonzero links: 14242 
# Percentage nonzero weights: 0.229 
# Average number of links: 5.71</code></pre>
<p>If we wish to create an object showing <span class="math inline">\(i\)</span> to <span class="math inline">\(k\)</span> neighbours, where <span class="math inline">\(i\)</span> is a neighbour of <span class="math inline">\(j\)</span>, and <span class="math inline">\(j\)</span> in turn is a neighbour of <span class="math inline">\(k\)</span>, so taking two steps on the neighbour graph, we can use <code>nblag()</code>, which automatically removes <span class="math inline">\(i\)</span> to <span class="math inline">\(i\)</span> self-neighbours:</p>
<div class="sourceCode" id="cb535"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb535-1" title="1">(nb_q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nblag</span>(<span class="dv">2</span>) -&gt;<span class="st"> </span>nb_q2)[[<span class="dv">2</span>]]</a></code></pre></div>
<pre><code># Neighbour list object:
# Number of regions: 2495 
# Number of nonzero links: 32930 
# Percentage nonzero weights: 0.529 
# Average number of links: 13.2</code></pre>
<p>The <code>nblag_cumul()</code> function cumulates the list of neighbours for the whole list of lags:</p>
<div class="sourceCode" id="cb537"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb537-1" title="1"><span class="kw">nblag_cumul</span>(nb_q2)</a></code></pre></div>
<pre><code># Neighbour list object:
# Number of regions: 2495 
# Number of nonzero links: 47172 
# Percentage nonzero weights: 0.758 
# Average number of links: 18.9</code></pre>
<p>while the set operation <code>union.nb()</code> takes two objects, giving here the same outcome:</p>
<div class="sourceCode" id="cb539"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb539-1" title="1"><span class="kw">union.nb</span>(nb_q2[[<span class="dv">2</span>]], nb_q2[[<span class="dv">1</span>]])</a></code></pre></div>
<pre><code># Neighbour list object:
# Number of regions: 2495 
# Number of nonzero links: 47172 
# Percentage nonzero weights: 0.758 
# Average number of links: 18.9</code></pre>
<p>Returning to the graph representation of the same neighbour object, we can ask how many steps might be needed to traverse the graph:</p>
<div class="sourceCode" id="cb541"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb541-1" title="1"><span class="kw">diameter</span>(g1)</a></code></pre></div>
<pre><code># [1] 52</code></pre>
<p>We step out from each observation across the graph to establish the number of steps needed to reach each other observation by the shortest path, once again finding the same count, and that the municipality is called Lutowiska, close to the Ukrainian border in the far south east of the country.</p>
<div class="sourceCode" id="cb543"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb543-1" title="1">g1 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">shortest.paths</span>() -&gt;<span class="st"> </span>sps</a>
<a class="sourceLine" id="cb543-2" title="2">(sps <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">apply</span>(<span class="dv">2</span>, max) -&gt;<span class="st"> </span>spmax) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">max</span>()</a></code></pre></div>
<pre><code># [1] 52</code></pre>
<div class="sourceCode" id="cb545"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb545-1" title="1">mr &lt;-<span class="st"> </span><span class="kw">which.max</span>(spmax)</a>
<a class="sourceLine" id="cb545-2" title="2">pol_pres15<span class="op">$</span>name0[mr]</a></code></pre></div>
<pre><code># [1] &quot;Lutowiska&quot;</code></pre>
<p>Figure <a href="area.html#fig:shortestpath">14.3</a> shows that contiguity neighbours represent the same kinds of relationships with other observations as distance. Some approaches prefer distance neighbours on the basis that, for example, inverse distance neighbours show clearly how all observations are related to each other. However, the development of tests for spatial autocorrelation and spatial regression models has involved the inverse of a spatial process model, which in turn can be represented as the sum of a power series of the product of a coefficient and a spatial weights matrix, so intrinsically acknowledging the relationships of all observations with all other. Sparse contiguity neighbour objects accommodate rich dependency structures without the need to make the structures explicit.</p>

<div class="sourceCode" id="cb547"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb547-1" title="1">gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(<span class="kw">tmap_grob</span>(tm1), g1, <span class="dt">nrow=</span><span class="dv">1</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:shortestpath"></span>
<img src="sds_files/figure-html/shortestpath-1.png" alt="Relationship of shortest paths to distance for Lutowiska; left panel: shortest path counts from Lutowiska; right panel: plot of shortest paths from Lutowiska to other observations and distances (km) from Lutowiska to other observations" width="100%" />
<p class="caption">
Figure 14.3: Relationship of shortest paths to distance for Lutowiska; left panel: shortest path counts from Lutowiska; right panel: plot of shortest paths from Lutowiska to other observations and distances (km) from Lutowiska to other observations
</p>
</div>
</div>
<div id="exercises-12" class="section level2">
<h2><span class="header-section-number">14.7</span> Exercises</h2>
<ol style="list-style-type: decimal">
<li>Which kinds of geometry support are appropriate for which functions creating neighbour objects?</li>
<li>Which functions creating neighbour objects are only appropriate for planar representations?</li>
<li>What difference might the choice of <code>rook</code> rather than <code>queen</code> contiguities make on a chessboard?</li>
<li>What are the relationships between neighbour set cardinalities (neighbour counts) and row-standardized weights, and how do they open analyses up to edge effects? Use the chessboard you constructed in exercise 3 for both <code>rook</code> and <code>queen</code> neighbours.</li>
</ol>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-avis+horton:1985">
<p>Avis, D., and J. Horton. 1985. “Remarks on the Sphere of Influence Graph.” In <em>Discrete Geometry and Convexity</em>, edited by J. E. Goodman, 323–27. New York: New York Academy of Sciences, New York.</p>
</div>
<div id="ref-R-Matrix">
<p>Bates, Douglas, and Martin Maechler. 2021. <em>Matrix: Sparse and Dense Matrix Classes and Methods</em>. <a href="https://CRAN.R-project.org/package=Matrix">https://CRAN.R-project.org/package=Matrix</a>.</p>
</div>
<div id="ref-bavaud:98">
<p>Bavaud, F. 1998. “Models for Spatial Weights: A Systematic Look.” <em>Geographical Analysis</em> 30: 153–71. <a href="https://doi.org/10.1111/j.1538-4632.1998.tb00394.x">https://doi.org/10.1111/j.1538-4632.1998.tb00394.x</a>.</p>
</div>
<div id="ref-R-spdep">
<p>Bivand, Roger. 2021b. <em>Spdep: Spatial Dependence: Weighting Schemes, Statistics</em>. <a href="https://CRAN.R-project.org/package=spdep">https://CRAN.R-project.org/package=spdep</a>.</p>
</div>
<div id="ref-Bivand2018">
<p>Bivand, Roger S., and David W. S. Wong. 2018. “Comparing Implementations of Global and Local Indicators of Spatial Association.” <em>TEST</em> 27 (3): 716–48. <a href="https://doi.org/10.1007/s11749-018-0599-x">https://doi.org/10.1007/s11749-018-0599-x</a>.</p>
</div>
<div id="ref-bivand+portnov:04">
<p>Bivand, R. S., and B. A. Portnov. 2004. “Exploring Spatial Data Analysis Techniques Using R: The Case of Observations with No Neighbours.” In <em>Advances in Spatial Econometrics: Methodology, Tools, Applications</em>, edited by L. Anselin, R. J. G. M. Florax, and S. J. Rey, 121–42. Berlin: Springer.</p>
</div>
<div id="ref-doi:10.1080/13658810601034267">
<p>Boots, B., and A. Okabe. 2007. “Local Statistical Spatial Analysis: Inventory and Prospect.” <em>International Journal of Geographical Information Science</em> 21 (4): 355–75. <a href="https://doi.org/10.1080/13658810601034267">https://doi.org/10.1080/13658810601034267</a>.</p>
</div>
<div id="ref-csardi+nepusz:06">
<p>Csardi, Gabor, and Tamas Nepusz. 2006. “The Igraph Software Package for Complex Network Research.” <em>InterJournal</em> Complex Systems: 1695. <a href="https://igraph.org">https://igraph.org</a>.</p>
</div>
<div id="ref-R-s2">
<p>Dunnington, Dewey, Edzer Pebesma, and Ege Rubak. 2021. <em>S2: Spherical Geometry Operators Using the S2 Geometry Library</em>.</p>
</div>
<div id="ref-R-igraph">
<p>file., See AUTHORS. 2021. <em>Igraph: Network Analysis and Visualization</em>. <a href="https://igraph.org">https://igraph.org</a>.</p>
</div>
<div id="ref-FRENISTERRANTINO201825">
<p>Freni-Sterrantino, Anna, Massimo Ventrucci, and Håvard Rue. 2018. “A Note on Intrinsic Conditional Autoregressive Models for Disconnected Graphs.” <em>Spatial and Spatio-Temporal Epidemiology</em> 26: 25–34. <a href="https://doi.org/https://doi.org/10.1016/j.sste.2018.04.002">https://doi.org/https://doi.org/10.1016/j.sste.2018.04.002</a>.</p>
</div>
<div id="ref-R-dbscan">
<p>Hahsler, Michael, and Matthew Piekenbrock. 2021. <em>Dbscan: Density Based Clustering of Applications with Noise (Dbscan) and Related Algorithms</em>. <a href="https://github.com/mhahsler/dbscan">https://github.com/mhahsler/dbscan</a>.</p>
</div>
<div id="ref-doi:10.1080/13658810701587891">
<p>Okabe, A., T. Satoh, T. Furuta, A. Suzuki, and K. Okano. 2008. “Generalized Network Voronoi Diagrams: Concepts, Computational Methods, and Applications.” <em>International Journal of Geographical Information Science</em> 22 (9): 965–94. <a href="https://doi.org/10.1080/13658810701587891">https://doi.org/10.1080/13658810701587891</a>.</p>
</div>
<div id="ref-SHE201570">
<p>She, Bing, Xinyan Zhu, Xinyue Ye, Wei Guo, Kehua Su, and Jay Lee. 2015. “Weighted Network Voronoi Diagrams for Local Spatial Analysis.” <em>Computers, Environment and Urban Systems</em> 52: 70–80. <a href="https://doi.org/https://doi.org/10.1016/j.compenvurbsys.2015.03.005">https://doi.org/https://doi.org/10.1016/j.compenvurbsys.2015.03.005</a>.</p>
</div>
<div id="ref-wall:04">
<p>Wall, M. M. 2004. “A Close Look at the Spatial Structure Implied by the CAR and SAR Models.” <em>Journal of Statistical Planning and Inference</em> 121: 311–24.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="stgeostatistics.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="spatautocorr.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/edzer/sdsr/edit/master/17-Areal.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
