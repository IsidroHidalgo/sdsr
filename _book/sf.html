<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 7 Introduction to sf and stars | Spatial Data Science</title>
  <meta name="description" content="description_xx" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 7 Introduction to sf and stars | Spatial Data Science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="description_xx" />
  <meta name="github-repo" content="edzer/sdsr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 7 Introduction to sf and stars | Spatial Data Science" />
  
  <meta name="twitter:description" content="description_xx" />
  

<meta name="author" content="Edzer Pebesma, Roger Bivand" />


<meta name="date" content="2021-05-24" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="datacube.html"/>
<link rel="next" href="large.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>
<script src="libs/FlatGeoBuf-3.3.3/fgb.js"></script>
<script src="libs/FlatGeoBuf-3.3.3/flatgeobuf-geojson.min.js"></script>
<script src="libs/chromajs-2.1.0/chroma.min.js"></script>
<link id="nc_32119-BIR74-1-attachment" rel="attachment" href="libs/nc_32119-BIR74-0.0.1/nc_32119-BIR74_layer.fgb"/>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />

<script>
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan');
  rCodeBlocks.each(function() {

    // if code block has been labeled with class `fold-show`, show the code on init!
    var classList = $(this).attr('class').split(/\s+/);
    for (var i = 0; i < classList.length; i++) {
    if (classList[i] === 'fold-show') {
        show = true;
      }
    }

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // hack: return show to false, otherwise all next codeBlocks will be shown!
    show = false;

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<script>
/* ========================================================================
 * Bootstrap: dropdown.js v3.3.7
 * http://getbootstrap.com/javascript/#dropdowns
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // DROPDOWN CLASS DEFINITION
  // =========================

  var backdrop = '.dropdown-backdrop'
  var toggle   = '[data-toggle="dropdown"]'
  var Dropdown = function (element) {
    $(element).on('click.bs.dropdown', this.toggle)
  }

  Dropdown.VERSION = '3.3.7'

  function getParent($this) {
    var selector = $this.attr('data-target')

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7
    }

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  }

  function clearMenus(e) {
    if (e && e.which === 3) return
    $(backdrop).remove()
    $(toggle).each(function () {
      var $this         = $(this)
      var $parent       = getParent($this)
      var relatedTarget = { relatedTarget: this }

      if (!$parent.hasClass('open')) return

      if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

      $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this.attr('aria-expanded', 'false')
      $parent.removeClass('open').trigger($.Event('hidden.bs.dropdown', relatedTarget))
    })
  }

  Dropdown.prototype.toggle = function (e) {
    var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    clearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $(document.createElement('div'))
          .addClass('dropdown-backdrop')
          .insertAfter($(this))
          .on('click', clearMenus)
      }

      var relatedTarget = { relatedTarget: this }
      $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this
        .trigger('focus')
        .attr('aria-expanded', 'true')

      $parent
        .toggleClass('open')
        .trigger($.Event('shown.bs.dropdown', relatedTarget))
    }

    return false
  }

  Dropdown.prototype.keydown = function (e) {
    if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName)) return

    var $this = $(this)

    e.preventDefault()
    e.stopPropagation()

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    if (!isActive && e.which != 27 || isActive && e.which == 27) {
      if (e.which == 27) $parent.find(toggle).trigger('focus')
      return $this.trigger('click')
    }

    var desc = ' li:not(.disabled):visible a'
    var $items = $parent.find('.dropdown-menu' + desc)

    if (!$items.length) return

    var index = $items.index(e.target)

    if (e.which == 38 && index > 0)                 index--         // up
    if (e.which == 40 && index < $items.length - 1) index++         // down
    if (!~index)                                    index = 0

    $items.eq(index).trigger('focus')
  }


  // DROPDOWN PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this = $(this)
      var data  = $this.data('bs.dropdown')

      if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  var old = $.fn.dropdown

  $.fn.dropdown             = Plugin
  $.fn.dropdown.Constructor = Dropdown


  // DROPDOWN NO CONFLICT
  // ====================

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  // APPLY TO STANDARD DROPDOWN ELEMENTS
  // ===================================

  $(document)
    .on('click.bs.dropdown.data-api', clearMenus)
    .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
    .on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown)
    .on('keydown.bs.dropdown.data-api', '.dropdown-menu', Dropdown.prototype.keydown)

}(jQuery);
</script>
<style type="text/css">
.code-folding-btn {
  margin-bottom: 4px;
}

.row { display: flex; }
.collapse { display: none; }
.in { display:block }
.pull-right > .dropdown-menu {
    right: 0;
    left: auto;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    font-size: 14px;
    text-align: left;
    list-style: none;
    background-color: #fff;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    border: 1px solid #ccc;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
    box-shadow: 0 6px 12px rgba(0,0,0,.175);
}

.open > .dropdown-menu {
    display: block;
    color: #ffffff;
    background-color: #ffffff;
    background-image: none;
    border-color: #92897e;
}

.dropdown-menu > li > a {
  display: block;
  padding: 3px 20px;
  clear: both;
  font-weight: 400;
  line-height: 1.42857143;
  color: #000000;
  white-space: nowrap;
}

.dropdown-menu > li > a:hover,
.dropdown-menu > li > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
}

.dropdown-menu > .active > a,
.dropdown-menu > .active > a:hover,
.dropdown-menu > .active > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
  outline: 0;
}
.dropdown-menu > .disabled > a,
.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  color: #aea79f;
}

.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  text-decoration: none;
  cursor: not-allowed;
  background-color: transparent;
  background-image: none;
  filter: progid:DXImageTransform.Microsoft.gradient(enabled = false);
}

.btn {
  display: inline-block;
  margin-bottom: 1;
  font-weight: normal;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  -ms-touch-action: manipulation;
      touch-action: manipulation;
  cursor: pointer;
  background-image: none;
  border: 1px solid transparent;
  padding: 4px 8px;
  font-size: 14px;
  line-height: 1.42857143;
  border-radius: 4px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.btn:focus,
.btn:active:focus,
.btn.active:focus,
.btn.focus,
.btn:active.focus,
.btn.active.focus {
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px;
}
.btn:hover,
.btn:focus,
.btn.focus {
  color: #ffffff;
  text-decoration: none;
}
.btn:active,
.btn.active {
  background-image: none;
  outline: 0;
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn.disabled,
.btn[disabled],
fieldset[disabled] .btn {
  cursor: not-allowed;
  filter: alpha(opacity=65);
  opacity: 0.65;
  box-shadow: none;
}
a.btn.disabled,
fieldset[disabled] a.btn {
  pointer-events: none;
}
.btn-default {
  color: #ffffff;
  background-color: #aea79f; #important
  border-color: #aea79f;
}

.btn-default:focus,
.btn-default.focus {
  color: #ffffff;
  background-color: #978e83;
  border-color: #6f675e;
}

.btn-default:hover {
  color: #ffffff;
  background-color: #978e83;
  border-color: #92897e;
}
.btn-default:active,
.btn-default.active,
.btn-group > .btn:not(:first-child):not(:last-child):not(.dropdown-toggle) {
  border-radius: 0;
}
.btn-group > .btn:first-child {
  margin-left: 0;
}
.btn-group > .btn:first-child:not(:last-child):not(.dropdown-toggle) {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn:last-child:not(:first-child),
.btn-group > .dropdown-toggle:not(:first-child) {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group > .btn-group {
  float: left;
}
.btn-group > .btn-group:not(:first-child):not(:last-child) > .btn {
  border-radius: 0;
}
.btn-group > .btn-group:first-child:not(:last-child) > .btn:last-child,
.btn-group > .btn-group:first-child:not(:last-child) > .dropdown-toggle {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn-group:last-child:not(:first-child) > .btn:first-child {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group .dropdown-toggle:active,
.btn-group.open .dropdown-toggle {
  outline: 0;
}
.btn-group > .btn + .dropdown-toggle {
  padding-right: 8px;
  padding-left: 8px;
}
.btn-group > .btn-lg + .dropdown-toggle {
  padding-right: 12px;
  padding-left: 12px;
}
.btn-group.open .dropdown-toggle {
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn-group.open .dropdown-toggle.btn-link {
  box-shadow: none;
}

</style>
<script>
var str = '<div class="btn-group pull-right" style="position: fixed; right: 50px; top: 10px; z-index: 200"><button type="button" class="btn btn-default btn-xs dropdown-toggle" id="allCodeButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast=""><span>Code</span> <span class="caret"></span></button><ul class="dropdown-menu" style="min-width: 50px;"><li><a id="rmd-show-all-code" href="#">Show All Code</a></li><li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li></ul></div>';
document.write(str);
</script>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatial Data Science</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="part"><span><b>I Spatial Data</b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Getting Started</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#a-first-map"><i class="fa fa-check"></i><b>1.1</b> A first map</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#coordinate-reference-systems"><i class="fa fa-check"></i><b>1.2</b> Coordinate reference systems</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#rasterize"><i class="fa fa-check"></i><b>1.3</b> Raster and vector data</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#raster-types"><i class="fa fa-check"></i><b>1.4</b> Raster types</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#time-series-arrays-data-cubes"><i class="fa fa-check"></i><b>1.5</b> Time series, arrays, data cubes</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#support"><i class="fa fa-check"></i><b>1.6</b> Support</a></li>
<li class="chapter" data-level="1.7" data-path="intro.html"><a href="intro.html#spatial-data-science-software"><i class="fa fa-check"></i><b>1.7</b> Spatial data science software</a></li>
<li class="chapter" data-level="1.8" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>1.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cs.html"><a href="cs.html"><i class="fa fa-check"></i><b>2</b> Coordinates</a><ul>
<li class="chapter" data-level="2.1" data-path="cs.html"><a href="cs.html#units"><i class="fa fa-check"></i><b>2.1</b> Quantities, units, datum</a></li>
<li class="chapter" data-level="2.2" data-path="cs.html"><a href="cs.html#ellipsoidal-coordinates"><i class="fa fa-check"></i><b>2.2</b> Ellipsoidal coordinates</a></li>
<li class="chapter" data-level="2.3" data-path="cs.html"><a href="cs.html#crs"><i class="fa fa-check"></i><b>2.3</b> Coordinate Reference Systems</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#proj"><i class="fa fa-check"></i><b>2.4</b> PROJ and mapping accuracy</a></li>
<li class="chapter" data-level="2.5" data-path="cs.html"><a href="cs.html#wkt2"><i class="fa fa-check"></i><b>2.5</b> WKT-2</a></li>
<li class="chapter" data-level="2.6" data-path="cs.html"><a href="cs.html#exercises-1"><i class="fa fa-check"></i><b>2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="geometries.html"><a href="geometries.html"><i class="fa fa-check"></i><b>3</b> Geometries</a><ul>
<li class="chapter" data-level="3.1" data-path="geometries.html"><a href="geometries.html#simplefeatures"><i class="fa fa-check"></i><b>3.1</b> Simple feature geometries</a></li>
<li class="chapter" data-level="3.2" data-path="geometries.html"><a href="geometries.html#opgeom"><i class="fa fa-check"></i><b>3.2</b> Operations on geometries</a></li>
<li class="chapter" data-level="3.3" data-path="geometries.html"><a href="geometries.html#precision"><i class="fa fa-check"></i><b>3.3</b> Precision</a></li>
<li class="chapter" data-level="3.4" data-path="geometries.html"><a href="geometries.html#coverages"><i class="fa fa-check"></i><b>3.4</b> Coverages: tessellations and rasters</a></li>
<li class="chapter" data-level="3.5" data-path="geometries.html"><a href="geometries.html#networks"><i class="fa fa-check"></i><b>3.5</b> Networks</a></li>
<li class="chapter" data-level="3.6" data-path="geometries.html"><a href="geometries.html#exercises-2"><i class="fa fa-check"></i><b>3.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spherical.html"><a href="spherical.html"><i class="fa fa-check"></i><b>4</b> Spherical Geometries</a><ul>
<li class="chapter" data-level="4.1" data-path="spherical.html"><a href="spherical.html#straight-lines"><i class="fa fa-check"></i><b>4.1</b> Straight lines</a></li>
<li class="chapter" data-level="4.2" data-path="spherical.html"><a href="spherical.html#ring-direction"><i class="fa fa-check"></i><b>4.2</b> Ring direction</a></li>
<li class="chapter" data-level="4.3" data-path="spherical.html"><a href="spherical.html#full-polygon"><i class="fa fa-check"></i><b>4.3</b> Full polygon</a></li>
<li class="chapter" data-level="4.4" data-path="spherical.html"><a href="spherical.html#bounding-box-rectangle-and-cap"><i class="fa fa-check"></i><b>4.4</b> Bounding box, rectangle, and cap</a></li>
<li class="chapter" data-level="4.5" data-path="spherical.html"><a href="spherical.html#validity-on-the-sphere"><i class="fa fa-check"></i><b>4.5</b> Validity on the sphere</a></li>
<li class="chapter" data-level="4.6" data-path="spherical.html"><a href="spherical.html#exercises-3"><i class="fa fa-check"></i><b>4.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="featureattributes.html"><a href="featureattributes.html"><i class="fa fa-check"></i><b>5</b> Attributes and Support</a><ul>
<li class="chapter" data-level="5.1" data-path="featureattributes.html"><a href="featureattributes.html#agr"><i class="fa fa-check"></i><b>5.1</b> Attribute-geometry relationships and support</a></li>
<li class="chapter" data-level="5.2" data-path="featureattributes.html"><a href="featureattributes.html#aggregating-and-summarising"><i class="fa fa-check"></i><b>5.2</b> Aggregating and Summarising</a></li>
<li class="chapter" data-level="5.3" data-path="featureattributes.html"><a href="featureattributes.html#area-weighted"><i class="fa fa-check"></i><b>5.3</b> Area-weighted interpolation</a></li>
<li class="chapter" data-level="5.4" data-path="featureattributes.html"><a href="featureattributes.html#updownscaling"><i class="fa fa-check"></i><b>5.4</b> Up- and Downscaling</a></li>
<li class="chapter" data-level="5.5" data-path="featureattributes.html"><a href="featureattributes.html#exercises-4"><i class="fa fa-check"></i><b>5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="datacube.html"><a href="datacube.html"><i class="fa fa-check"></i><b>6</b> Data Cubes</a><ul>
<li class="chapter" data-level="6.1" data-path="datacube.html"><a href="datacube.html#a-four-dimensional-data-cube"><i class="fa fa-check"></i><b>6.1</b> A four-dimensional data cube</a></li>
<li class="chapter" data-level="6.2" data-path="datacube.html"><a href="datacube.html#dimensions-attributes-and-support"><i class="fa fa-check"></i><b>6.2</b> Dimensions, attributes, and support</a></li>
<li class="chapter" data-level="6.3" data-path="datacube.html"><a href="datacube.html#dcoperations"><i class="fa fa-check"></i><b>6.3</b> Operations on data cubes</a></li>
<li class="chapter" data-level="6.4" data-path="datacube.html"><a href="datacube.html#vectordatacubes"><i class="fa fa-check"></i><b>6.4</b> Aggregating raster to vector cubes</a></li>
<li class="chapter" data-level="6.5" data-path="datacube.html"><a href="datacube.html#switching"><i class="fa fa-check"></i><b>6.5</b> Switching dimension with attributes</a></li>
<li class="chapter" data-level="6.6" data-path="datacube.html"><a href="datacube.html#otherdynamic"><i class="fa fa-check"></i><b>6.6</b> Other dynamic data</a></li>
<li class="chapter" data-level="6.7" data-path="datacube.html"><a href="datacube.html#exercises-5"><i class="fa fa-check"></i><b>6.7</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II R for Spatial Data Science</b></span></li>
<li class="chapter" data-level="7" data-path="sf.html"><a href="sf.html"><i class="fa fa-check"></i><b>7</b> Introduction to sf and stars</a><ul>
<li class="chapter" data-level="7.1" data-path="sf.html"><a href="sf.html#sfintro"><i class="fa fa-check"></i><b>7.1</b> Package <code>sf</code></a></li>
<li class="chapter" data-level="7.2" data-path="sf.html"><a href="sf.html#spatial-joins"><i class="fa fa-check"></i><b>7.2</b> Spatial joins</a></li>
<li class="chapter" data-level="7.3" data-path="sf.html"><a href="sf.html#package-stars"><i class="fa fa-check"></i><b>7.3</b> Package <code>stars</code></a></li>
<li class="chapter" data-level="7.4" data-path="sf.html"><a href="sf.html#vector-data-cube-examples"><i class="fa fa-check"></i><b>7.4</b> Vector data cube examples</a></li>
<li class="chapter" data-level="7.5" data-path="sf.html"><a href="sf.html#raster-to-vector"><i class="fa fa-check"></i><b>7.5</b> raster-to-vector, vector-to-raster</a></li>
<li class="chapter" data-level="7.6" data-path="sf.html"><a href="sf.html#projsf"><i class="fa fa-check"></i><b>7.6</b> Coordinate transformations and conversions</a></li>
<li class="chapter" data-level="7.7" data-path="sf.html"><a href="sf.html#warp"><i class="fa fa-check"></i><b>7.7</b> transforming and warping rasters</a></li>
<li class="chapter" data-level="7.8" data-path="sf.html"><a href="sf.html#exercises-6"><i class="fa fa-check"></i><b>7.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="large.html"><a href="large.html"><i class="fa fa-check"></i><b>8</b> Large data sets</a><ul>
<li class="chapter" data-level="8.1" data-path="large.html"><a href="large.html#largesf"><i class="fa fa-check"></i><b>8.1</b> Vector data: <code>sf</code></a></li>
<li class="chapter" data-level="8.2" data-path="large.html"><a href="large.html#raster-data-stars"><i class="fa fa-check"></i><b>8.2</b> Raster data: <code>stars</code></a></li>
<li class="chapter" data-level="8.3" data-path="large.html"><a href="large.html#very-large-data-cubes"><i class="fa fa-check"></i><b>8.3</b> Very large data cubes</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>9</b> Plotting spatial data</a><ul>
<li class="chapter" data-level="9.1" data-path="plotting.html"><a href="plotting.html#transform"><i class="fa fa-check"></i><b>9.1</b> Every plot is a projection</a></li>
<li class="chapter" data-level="9.2" data-path="plotting.html"><a href="plotting.html#plotting-points-lines-polygons-grid-cells"><i class="fa fa-check"></i><b>9.2</b> Plotting points, lines, polygons, grid cells</a></li>
<li class="chapter" data-level="9.3" data-path="plotting.html"><a href="plotting.html#base-plot"><i class="fa fa-check"></i><b>9.3</b> Base <code>plot</code></a></li>
<li class="chapter" data-level="9.4" data-path="plotting.html"><a href="plotting.html#maps-with-ggplot2"><i class="fa fa-check"></i><b>9.4</b> Maps with <code>ggplot2</code></a></li>
<li class="chapter" data-level="9.5" data-path="plotting.html"><a href="plotting.html#tmap"><i class="fa fa-check"></i><b>9.5</b> Maps with <code>tmap</code></a></li>
<li class="chapter" data-level="9.6" data-path="plotting.html"><a href="plotting.html#interactive-maps-leaflet-mapview-tmap"><i class="fa fa-check"></i><b>9.6</b> Interactive maps: <code>leaflet</code>, <code>mapview</code>, <code>tmap</code></a></li>
</ul></li>
<li class="part"><span><b>III Models for Spatial Data</b></span></li>
<li class="chapter" data-level="10" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html"><i class="fa fa-check"></i><b>10</b> Statistical modelling of spatial data</a><ul>
<li class="chapter" data-level="10.1" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#design"><i class="fa fa-check"></i><b>10.1</b> Design-based and model-based inference</a></li>
<li class="chapter" data-level="10.2" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#predictive-models-with-coordinates"><i class="fa fa-check"></i><b>10.2</b> Predictive models with coordinates</a></li>
<li class="chapter" data-level="10.3" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#model-based-inference"><i class="fa fa-check"></i><b>10.3</b> Model-based inference</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="pointpatterns.html"><a href="pointpatterns.html"><i class="fa fa-check"></i><b>11</b> Point Pattern Analysis</a></li>
<li class="chapter" data-level="12" data-path="interpolation.html"><a href="interpolation.html"><i class="fa fa-check"></i><b>12</b> Interpolation and Geostatistics</a><ul>
<li class="chapter" data-level="12.1" data-path="interpolation.html"><a href="interpolation.html#preparing-the-air-quality-dataset"><i class="fa fa-check"></i><b>12.1</b> Preparing the air quality dataset</a></li>
<li class="chapter" data-level="12.2" data-path="interpolation.html"><a href="interpolation.html#sample-variogram"><i class="fa fa-check"></i><b>12.2</b> Sample variogram</a></li>
<li class="chapter" data-level="12.3" data-path="interpolation.html"><a href="interpolation.html#fitting-variogram-models"><i class="fa fa-check"></i><b>12.3</b> Fitting variogram models</a></li>
<li class="chapter" data-level="12.4" data-path="interpolation.html"><a href="interpolation.html#kriging"><i class="fa fa-check"></i><b>12.4</b> Kriging interpolation</a></li>
<li class="chapter" data-level="12.5" data-path="interpolation.html"><a href="interpolation.html#blockkriging"><i class="fa fa-check"></i><b>12.5</b> Areal means: block kriging</a></li>
<li class="chapter" data-level="12.6" data-path="interpolation.html"><a href="interpolation.html#conditional-simulation"><i class="fa fa-check"></i><b>12.6</b> Conditional simulation</a></li>
<li class="chapter" data-level="12.7" data-path="interpolation.html"><a href="interpolation.html#trend-models"><i class="fa fa-check"></i><b>12.7</b> Trend models</a></li>
<li class="chapter" data-level="12.8" data-path="interpolation.html"><a href="interpolation.html#multivariable-geostatistics"><i class="fa fa-check"></i><b>12.8</b> Multivariable geostatistics</a></li>
<li class="chapter" data-level="12.9" data-path="interpolation.html"><a href="interpolation.html#spatiotemporal-interpolation"><i class="fa fa-check"></i><b>12.9</b> Spatiotemporal interpolation</a></li>
<li class="chapter" data-level="12.10" data-path="interpolation.html"><a href="interpolation.html#atpk"><i class="fa fa-check"></i><b>12.10</b> Area-to-point kriging</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="area.html"><a href="area.html"><i class="fa fa-check"></i><b>13</b> Area Data and Spatial Autocorrelation</a><ul>
<li class="chapter" data-level="13.1" data-path="area.html"><a href="area.html#spatial-autocorrelation"><i class="fa fa-check"></i><b>13.1</b> Spatial autocorrelation</a></li>
<li class="chapter" data-level="13.2" data-path="area.html"><a href="area.html#spatial-weight-matrices"><i class="fa fa-check"></i><b>13.2</b> Spatial weight matrices</a></li>
<li class="chapter" data-level="13.3" data-path="area.html"><a href="area.html#measures-of-spatial-autocorrelation"><i class="fa fa-check"></i><b>13.3</b> Measures of spatial autocorrelation</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="spatial-regression.html"><a href="spatial-regression.html"><i class="fa fa-check"></i><b>14</b> Spatial Regression</a><ul>
<li class="chapter" data-level="14.1" data-path="spatial-regression.html"><a href="spatial-regression.html#spatial-regression-with-spatial-weights"><i class="fa fa-check"></i><b>14.1</b> Spatial regression with spatial weights</a></li>
<li class="chapter" data-level="14.2" data-path="spatial-regression.html"><a href="spatial-regression.html#estimators"><i class="fa fa-check"></i><b>14.2</b> Estimators</a></li>
<li class="chapter" data-level="14.3" data-path="spatial-regression.html"><a href="spatial-regression.html#implementation-details"><i class="fa fa-check"></i><b>14.3</b> Implementation details</a></li>
<li class="chapter" data-level="14.4" data-path="spatial-regression.html"><a href="spatial-regression.html#markov-random-field-and-multilevel-models-with-spatial-weights"><i class="fa fa-check"></i><b>14.4</b> Markov random field and multilevel models with spatial weights</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="sp-and-raster.html"><a href="sp-and-raster.html"><i class="fa fa-check"></i><b>15</b> sp and raster</a><ul>
<li class="chapter" data-level="15.1" data-path="sp-and-raster.html"><a href="sp-and-raster.html#links-and-differences-between-sf-and-sp"><i class="fa fa-check"></i><b>15.1</b> links and differences between sf and sp</a></li>
<li class="chapter" data-level="15.2" data-path="sp-and-raster.html"><a href="sp-and-raster.html#migration-packages"><i class="fa fa-check"></i><b>15.2</b> migration packages</a></li>
<li class="chapter" data-level="15.3" data-path="sp-and-raster.html"><a href="sp-and-raster.html#raster-stars-and-sf"><i class="fa fa-check"></i><b>15.3</b> raster, stars and sf</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="all-r-code-in-this-book.html"><a href="all-r-code-in-this-book.html"><i class="fa fa-check"></i>All R code in this book</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html"><i class="fa fa-check"></i>R basics</a><ul>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#pipes"><i class="fa fa-check"></i>Pipes</a></li>
<li class="chapter" data-level="15.4" data-path="r-basics.html"><a href="r-basics.html#data-structures"><i class="fa fa-check"></i><b>15.4</b> Data structures</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sf" class="section level1">
<h1><span class="header-section-number">Chapter 7</span> Introduction to sf and stars</h1>
<p>This chapter introduces R packages <code>sf</code> and <code>stars</code>. <code>sf</code> provides
a table format for simple features, where feature geometries are
carried in a list-column. R package <code>stars</code> was written to support
raster and vector datacubes (Chapter <a href="datacube.html#datacube">6</a>), and has
raster data stacks and feature time series as special cases. <code>sf</code>
first appeared on CRAN in 2016, <code>stars</code> in 2018. Development of both
packages received support from the R Consortium as well as strong
community engagement. The packages were designed to work together.</p>
<p>All functions operating on <code>sf</code> or <code>stars</code> objects start with <code>st_</code>,
making it easy to recognize them or to search for them when using
command line completion.</p>
<div id="sfintro" class="section level2">
<h2><span class="header-section-number">7.1</span> Package <code>sf</code></h2>
<p>Intended to succeed and replace R packages <code>sp</code>, <code>rgeos</code> and the
vector parts of <code>rgdal</code>, R Package <code>sf</code> <span class="citation">(Pebesma <a href="#ref-rjsf">2018</a>)</span> was developed to
move spatial data analysis in R closer to standards-based approaches
seen in the industry and open source projects, to build upon more
modern versions of the open source geospatial software stack (figure
<a href="intro.html#fig:gdal-fig-nodetails">1.6</a>), and to allow for integration of R
spatial software with the tidyverse if desired.</p>
<p>To do so, R package <code>sf</code> provides simple features access
<span class="citation">(J. Herring and others <a href="#ref-herring2011opengis">2011</a>)</span>, natively, to R. It provides an interface
to several <code>tidyverse</code> packages, in particular to <code>ggplot2</code>,
<code>dplyr</code> and <code>tidyr</code>. It can read and write data through GDAL, execute
geometrical operations using GEOS (for projected coordinates)
or s2geometry (for ellipsoidal coordinates), and carry out
coordinate transformations or conversions using PROJ. External C++
libraries are interfaced using <code>Rcpp</code> <span class="citation">(Eddelbuettel <a href="#ref-eddelbuettel2013seamless">2013</a>)</span>.</p>
<p>Package <code>sf</code> represents sets of simple features in <code>sf</code> objects,
a sub-class of a <code>data.frame</code> or tibble. <code>sf</code> objects contain at
least one <em>geometry list-column</em> of class <code>sfc</code>, which for each
element contains the geometry as an R object of class <code>sfg</code>.
A geometry list-column acts as a variable in a <code>data.frame</code>
or tibble, but has a more complex structure than e.g. numeric or
character variables. Following the convention of <code>PostGIS</code>, all
operations (functions, method) that operate on <code>sf</code> objects or
related start with <code>st_</code>.</p>
<p>An <code>sf</code> object has the following meta-data:</p>
<ul>
<li>the name of the (active) geometry column, held in attribute <code>sf_column</code></li>
<li>for each non-geometry variable, the attribute-geometry
relationships (section <a href="featureattributes.html#agr">5.1</a>), held in attribute <code>agr</code></li>
</ul>
<p>An <code>sfc</code> geometry list-column has the following meta-data:</p>
<ul>
<li>the coordinate reference system held in attribute <code>crs</code></li>
<li>the bounding box held in attribute <code>bbox</code></li>
<li>the precision held in attribute <code>precision</code></li>
<li>the number of empty geometries held in attribute <code>n_empty</code></li>
</ul>
<p>These attributes may best be accessed or set by using
functions like <code>st_bbox</code>, <code>st_crs</code>, <code>st_set_crs</code>, <code>st_agr</code>,
<code>st_set_agr</code>, <code>st_precision</code>, and <code>st_set_precision</code>.</p>
<div id="creation" class="section level3">
<h3><span class="header-section-number">7.1.1</span> Creation</h3>
<p>One could create an <code>sf</code> object from scratch e.g. by</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" title="1"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb82-2" title="2">p1 =<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">7.35</span>, <span class="fl">52.42</span>))</a>
<a class="sourceLine" id="cb82-3" title="3">p2 =<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">7.22</span>, <span class="fl">52.18</span>))</a>
<a class="sourceLine" id="cb82-4" title="4">p3 =<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">7.44</span>, <span class="fl">52.19</span>))</a>
<a class="sourceLine" id="cb82-5" title="5">sfc =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">list</span>(p1, p2, p3), <span class="dt">crs =</span> <span class="st">&#39;OGC:CRS84&#39;</span>)</a>
<a class="sourceLine" id="cb82-6" title="6"><span class="kw">st_sf</span>(<span class="dt">elev =</span> <span class="kw">c</span>(<span class="fl">33.2</span>, <span class="fl">52.1</span>, <span class="fl">81.2</span>), <span class="dt">marker =</span> <span class="kw">c</span>(<span class="st">&quot;Id01&quot;</span>, <span class="st">&quot;Id02&quot;</span>, <span class="st">&quot;Id03&quot;</span>),</a>
<a class="sourceLine" id="cb82-7" title="7">      <span class="dt">geom =</span> sfc)</a></code></pre></div>
<pre><code># Simple feature collection with 3 features and 2 fields
# Geometry type: POINT
# Dimension:     XY
# Bounding box:  xmin: 7.22 ymin: 52.2 xmax: 7.44 ymax: 52.4
# Geodetic CRS:  WGS 84
#   elev marker              geom
# 1 33.2   Id01 POINT (7.35 52.4)
# 2 52.1   Id02 POINT (7.22 52.2)
# 3 81.2   Id03 POINT (7.44 52.2)</code></pre>
(ref:sfcomp) components of an <code>sf</code> object
<div class="figure" style="text-align: center"><span id="fig:sfobj"></span>
<img src="images/sf_obj.png" alt="(ref:sfcomp)" width="100%" />
<p class="caption">
Figure 7.1: (ref:sfcomp)
</p>
</div>
<p>Figure <a href="sf.html#fig:sfobj">7.1</a> gives an explanation of the components
printed. Rather than creating objects from scratch, spatial data
in R are typically read from an external source, which can be</p>
<ul>
<li>an external file,</li>
<li>a request to a web service, or</li>
<li>a dataset held in some form in another R package.</li>
</ul>
<p>The next section introduces reading from files; section
<a href="large.html#largesf">8.1</a> discusses handling of datasets too large to fit into
working memory.</p>
</div>
<div id="reading-and-writing" class="section level3">
<h3><span class="header-section-number">7.1.2</span> Reading and writing</h3>
<p>Reading datasets from an exteral “data source” (file, web service,
or even string) is done using <code>st_read</code>:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" title="1"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb84-2" title="2">(<span class="dt">file =</span> <span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>))</a></code></pre></div>
<pre><code># [1] &quot;/home/edzer/R/x86_64-pc-linux-gnu-library/4.0/sf/gpkg/nc.gpkg&quot;</code></pre>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" title="1">nc =<span class="st"> </span><span class="kw">st_read</span>(file)</a></code></pre></div>
<pre><code># Reading layer `nc.gpkg&#39; from data source `/home/edzer/R/x86_64-pc-linux-gnu-library/4.0/sf/gpkg/nc.gpkg&#39; using driver `GPKG&#39;
# Simple feature collection with 100 features and 14 fields
# Geometry type: MULTIPOLYGON
# Dimension:     XY
# Bounding box:  xmin: -84.3 ymin: 33.9 xmax: -75.5 ymax: 36.6
# Geodetic CRS:  NAD27</code></pre>
<p>Here, the file name and path <code>file</code> is read from the <code>sf</code> package,
which has a different path on every machine, and hence is guaranteed
to be present on every <code>sf</code> installation.</p>
<p>Command <code>st_read</code> has two arguments: the <em>data set name</em> (<code>dsn</code>)
and the <em>layer</em>. In the example above, the <em>geopackage</em> file
contains only a single layer that is being read. If it had contained
multiple layers, then the first layer would have been read and a
warning would have been emitted. The available layers of a data
set can be queried by</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" title="1"><span class="kw">st_layers</span>(file)</a></code></pre></div>
<pre><code># Driver: GPKG 
# Available layers:
#   layer_name geometry_type features fields
# 1    nc.gpkg Multi Polygon      100     14</code></pre>
<p>Simple feature objects can be written with <code>st_write</code>, as in</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb90-1" title="1">(<span class="dt">file =</span> <span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">&quot;.gpkg&quot;</span>))</a></code></pre></div>
<pre><code># [1] &quot;/tmp/Rtmpe52Cs5/file2d911432cc85.gpkg&quot;</code></pre>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" title="1"><span class="kw">st_write</span>(nc, file, <span class="dt">layer =</span> <span class="st">&quot;layer_nc&quot;</span>)</a></code></pre></div>
<pre><code># Writing layer `layer_nc&#39; to data source `/tmp/Rtmpe52Cs5/file2d911432cc85.gpkg&#39; using driver `GPKG&#39;
# Writing 100 features with 14 fields and geometry type Multi Polygon.</code></pre>
<p>where the file format (GPKG) is derived from the file name extension.</p>
</div>
<div id="subsetting" class="section level3">
<h3><span class="header-section-number">7.1.3</span> Subsetting</h3>
<p>A very common operation is to subset objects; base R can use <code>[</code>
for this. The rules that apply to <code>data.frame</code> objects also apply to
<code>sf</code> objects, e.g. that records 2-5 and columns 3-7 are selected by</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" title="1">nc[<span class="dv">2</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">3</span><span class="op">:</span><span class="dv">7</span>]</a></code></pre></div>
<p>but with a few additional features, in particular</p>
<ul>
<li>the <code>drop</code> argument is by default <code>FALSE</code> meaning that the
geometry column is <em>always</em> selected, and an <code>sf</code> object is
returned; when it is set to <code>TRUE</code> and the geometry column <em>not</em> selected,
it is dropped and a <code>data.frame</code> is returned;</li>
<li>selection with a spatial (<code>sf</code>, <code>sfc</code> or <code>sfg</code>) object as first argument leads to
selection of the features that spatially <em>intersect</em> with that
object (see next section); other predicates than <em>intersects</em> can be chosen by setting
parameter <code>op</code> to a function such as <code>st_covers</code> or or any other
binary predicate function listed in section <a href="geometries.html#de9im">3.2.2</a></li>
</ul>
</div>
<div id="binary-predicates" class="section level3">
<h3><span class="header-section-number">7.1.4</span> Binary predicates</h3>
<p>Binary predicates like <code>st_intersects</code>, <code>st_covers</code> etc (section
<a href="geometries.html#de9im">3.2.2</a>) take two sets of features or feature geometries and return for
all pairs whether the predicate is <code>TRUE</code> or <code>FALSE</code>. For large
sets this would potentially result in a huge matrix, typically filled
mostly with <code>FALSE</code> values and for that reason a sparse representation
is returned by default:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb95-1" title="1">nc5 =<span class="st"> </span>nc[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, ]</a>
<a class="sourceLine" id="cb95-2" title="2">nc7 =<span class="st"> </span>nc[<span class="dv">1</span><span class="op">:</span><span class="dv">7</span>, ]</a>
<a class="sourceLine" id="cb95-3" title="3">(<span class="dt">i =</span> <span class="kw">st_intersects</span>(nc5, nc7))</a></code></pre></div>
<pre><code># Sparse geometry binary predicate list of length 5, where the predicate was `intersects&#39;
#  1: 1, 2
#  2: 1, 2, 3
#  3: 2, 3
#  4: 4, 7
#  5: 5, 6</code></pre>
<pre><code># Warning in st_centroid.sf(nc7): st_centroid assumes attributes are constant over
# geometries of x</code></pre>
<div class="figure" style="text-align: center"><span id="fig:fig57"></span>
<img src="sds_files/figure-html/fig57-1.png" alt="First seven North Carolina counties" width="672" />
<p class="caption">
Figure 7.2: First seven North Carolina counties
</p>
</div>
<p>Figure <a href="sf.html#fig:fig57">7.2</a> shows how the intersections of the first
five with the first seven counties can be understood.
We can transform the sparse logical matrix into a dense matrix by</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb98-1" title="1"><span class="kw">as.matrix</span>(i)</a></code></pre></div>
<pre><code>#       [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]
# [1,]  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE
# [2,]  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE
# [3,] FALSE  TRUE  TRUE FALSE FALSE FALSE FALSE
# [4,] FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE
# [5,] FALSE FALSE FALSE FALSE  TRUE  TRUE FALSE</code></pre>
<p>The number of countries that each of <code>nc5</code> intersects with is</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb100-1" title="1"><span class="kw">lengths</span>(i)</a></code></pre></div>
<pre><code># [1] 2 3 2 2 2</code></pre>
<p>and the other way around, the number of counties in <code>nc5</code> that
intersect with each of the counties in <code>nc7</code> is</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb102-1" title="1"><span class="kw">lengths</span>(<span class="kw">t</span>(i))</a></code></pre></div>
<pre><code># [1] 2 3 2 1 1 1 1</code></pre>
<p>The object <code>i</code> is of class <code>sgbp</code> (sparse geometrical binary
predicate), and is a list of integer vectors, with each element
representing a row in the logical predicate matrix holding the column
indices of the <code>TRUE</code> values for that row. It further holds some
metadata like the predicate used, and the total number of columns.
Methods available for <code>sgbp</code> objects include</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb104-1" title="1"><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">&quot;sgbp&quot;</span>)</a></code></pre></div>
<pre><code># [1] as.data.frame as.matrix     dim           Ops           print        
# [6] t            
# see &#39;?methods&#39; for accessing help and source code</code></pre>
<p>where the only <code>Ops</code> method available is <code>!</code>, the negation operation.</p>
</div>
<div id="tidyverse" class="section level3">
<h3><span class="header-section-number">7.1.5</span> tidyverse</h3>
<p>The tidyverse is a collection of data science packages that work
together, described e.g. in <span class="citation">(Wickham and Grolemund <a href="#ref-r4ds">2017</a>; Wickham et al. <a href="#ref-welcome">2019</a>)</span>. Package <code>sf</code> has
tidyverse-style read and write functions, <code>read_sf</code> and <code>write_sf</code>,
which return a tibble rather than a <code>data.frame</code>, do not print any
output, and overwrite existing data by default.</p>
<p>Further <code>tidyverse</code> generics with methods for <code>sf</code> objects include
<code>filter</code>, <code>select</code>, <code>group_by</code>, <code>ungroup</code>, <code>mutate</code>, <code>transmute</code>,
<code>rowwise</code>, <code>rename</code>, <code>slice</code> and <code>summarise</code>, <code>distinct</code>, <code>gather</code>,
<code>spread</code>, <code>nest</code>, <code>unnest</code>, <code>unite</code>, <code>separate</code>, <code>separate_rows</code>,
<code>sample_n</code>, and <code>sample_frac</code>. Most of these methods simply manage
the metadata of <code>sf</code> objects, and make sure the geometry remains
present. In case a user wants the geometry to be removed, one can
use <code>st_set_geometry(nc, NULL)</code> or simply coerce to a tibble before
selecting:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb106-1" title="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb106-2" title="2">nc <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">as_tibble</span>() <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">select</span>(BIR74) <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</a></code></pre></div>
<pre><code># # A tibble: 3 x 1
#   BIR74
#   &lt;dbl&gt;
# 1  1091
# 2   487
# 3  3188</code></pre>
<p>The <code>summarise</code> method for <code>sf</code> objects has two special arguments:</p>
<ul>
<li><code>do_union</code> (default <code>TRUE</code>) determines whether grouped geometries are unioned on return, so that they form a valid geometry;</li>
<li><code>is_coverage</code> (default <code>FALSE</code>) in case the geometries grouped form a coverage (do not have overlaps), setting this to <code>TRUE</code> speeds up the unioning</li>
</ul>
<p>The <code>distinct</code> method selects distinct records, where <code>st_equals</code>
is used to evaluate distinctness of geometries.</p>
<p><code>filter</code> can be used with the usual predicates; when one wants to
use it with a spatial predicate, e.g. to select all counties less
than 50 km away from Orange county, one could use</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb108-1" title="1"><span class="kw">sf_use_s2</span>(<span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb108-2" title="2">orange &lt;-<span class="st"> </span>nc <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">filter</span>(NAME <span class="op">==</span><span class="st"> &quot;Orange&quot;</span>)</a>
<a class="sourceLine" id="cb108-3" title="3">wd =<span class="st"> </span><span class="kw">st_is_within_distance</span>(nc, orange, units<span class="op">::</span><span class="kw">set_units</span>(<span class="dv">50</span>, km))</a>
<a class="sourceLine" id="cb108-4" title="4">o50 &lt;-<span class="st"> </span>nc <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">filter</span>(<span class="kw">lengths</span>(wd) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb108-5" title="5"><span class="kw">nrow</span>(o50)</a></code></pre></div>
<pre><code># [1] 17</code></pre>
<p>Figure <a href="sf.html#fig:orangebuffer">7.3</a> shows the results of this analysis,
and in addition a buffer around the county borders; note that this buffer
serves for illustration, it was <em>not</em> used to select the counties.</p>
<div class="figure" style="text-align: center"><span id="fig:orangebuffer"></span>
<img src="sds_files/figure-html/orangebuffer-1.png" alt="Orange county (orange), counties within a 50 km radius (black), a 50 km buffer around Orange county (brown), and remaining counties (grey)" width="672" />
<p class="caption">
Figure 7.3: Orange county (orange), counties within a 50 km radius (black), a 50 km buffer around Orange county (brown), and remaining counties (grey)
</p>
</div>
</div>
</div>
<div id="spatial-joins" class="section level2">
<h2><span class="header-section-number">7.2</span> Spatial joins</h2>
<p>In regular (left, right or inner) joins, <em>joined</em> records from a
pair of tables are reported when one or more selected attributes
match (are identical) in both tables. A spatial join is similar,
but the criterion to join records is not equality of attributes but
a spatial predicate. This leaves a wide variety of options in order
to define <em>spatially</em> matching records, using binary predicates
listed in section <a href="geometries.html#de9im">3.2.2</a>. The concepts of “left”, “right”,
“inner” or “full” joins remain identical to the non-spatial join
as the options for handling records that have no spatial match.</p>
<p>When using spatial joins, each record may have several matched
records, yielding a large result table. A way to reduce this
complexity may be to select from the matching records the one with
the largest overlap with the target geometry. An example of this
is shown (visually) in figure <a href="sf.html#fig:largest">7.4</a>; this is done using
<code>st_join</code> with argument <code>largest = TRUE</code>.</p>

<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb110-1" title="1"><span class="co"># example of largest = TRUE:</span></a>
<a class="sourceLine" id="cb110-2" title="2">nc &lt;-<span class="st"> </span><span class="kw">st_transform</span>(<span class="kw">read_sf</span>(<span class="kw">system.file</span>(<span class="st">&quot;shape/nc.shp&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>)), <span class="dv">2264</span>)</a>
<a class="sourceLine" id="cb110-3" title="3">gr =<span class="st"> </span><span class="kw">st_sf</span>(</a>
<a class="sourceLine" id="cb110-4" title="4">         <span class="dt">label =</span> <span class="kw">apply</span>(<span class="kw">expand.grid</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, LETTERS[<span class="dv">10</span><span class="op">:</span><span class="dv">1</span>])[,<span class="dv">2</span><span class="op">:</span><span class="dv">1</span>], <span class="dv">1</span>, paste0, <span class="dt">collapse =</span> <span class="st">&quot; &quot;</span>),</a>
<a class="sourceLine" id="cb110-5" title="5">         <span class="dt">geom =</span> <span class="kw">st_make_grid</span>(nc))</a>
<a class="sourceLine" id="cb110-6" title="6">gr<span class="op">$</span>col =<span class="st"> </span><span class="kw">sf.colors</span>(<span class="dv">10</span>, <span class="dt">categorical =</span> <span class="ot">TRUE</span>, <span class="dt">alpha =</span> <span class="fl">.3</span>)</a>
<a class="sourceLine" id="cb110-7" title="7"><span class="co"># cut, to check, NA&#39;s work out:</span></a>
<a class="sourceLine" id="cb110-8" title="8">gr =<span class="st"> </span>gr[<span class="op">-</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">30</span>),]</a>
<a class="sourceLine" id="cb110-9" title="9"><span class="kw">suppressWarnings</span>(nc_j &lt;-<span class="st"> </span><span class="kw">st_join</span>(nc, gr, <span class="dt">largest =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb110-10" title="10"><span class="co"># the two datasets:</span></a>
<a class="sourceLine" id="cb110-11" title="11">opar =<span class="st"> </span><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>), <span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb110-12" title="12"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc_j))</a>
<a class="sourceLine" id="cb110-13" title="13"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(gr), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> gr<span class="op">$</span>col)</a>
<a class="sourceLine" id="cb110-14" title="14"><span class="kw">text</span>(<span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(gr))), <span class="dt">labels =</span> gr<span class="op">$</span>label)</a>
<a class="sourceLine" id="cb110-15" title="15"><span class="co"># the joined dataset:</span></a>
<a class="sourceLine" id="cb110-16" title="16"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc_j), <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">col =</span> nc_j<span class="op">$</span>col)</a>
<a class="sourceLine" id="cb110-17" title="17"><span class="kw">text</span>(<span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(nc_j))), <span class="dt">labels =</span> nc_j<span class="op">$</span>label, <span class="dt">cex =</span> <span class="fl">.8</span>)</a>
<a class="sourceLine" id="cb110-18" title="18"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(gr), <span class="dt">border =</span> <span class="st">&#39;green&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:largest"></span>
<img src="sds_files/figure-html/largest-1.png" alt="example of st_join with largest = TRUE: the label of the polygon in the top figure with the largest intersection with polygons in the bottom figure is assigned to the polygons of the bottom figure." width="60%" />
<p class="caption">
Figure 7.4: example of <code>st_join</code> with <code>largest = TRUE</code>: the label of the polygon in the top figure with the largest intersection with polygons in the bottom figure is assigned to the polygons of the bottom figure.
</p>
</div>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb111-1" title="1"><span class="kw">par</span>(opar)</a></code></pre></div>
<p>Another way to reduce the result set is to use <code>aggregate</code> after a
join, all matching records, and union their geometries; see Section
<a href="featureattributes.html#updownscaling">5.4</a>.</p>
<div id="sampling-gridding-interpolating" class="section level3">
<h3><span class="header-section-number">7.2.1</span> sampling, gridding, interpolating</h3>
<p>Several convenience functions are available in package <code>sf</code>, some
of which will be discussed here. Function <code>st_sample</code> generates
a sample of points randomly sampled from target geometries, where
target geometries can be point, line or polygon geometries. Sampling
strategies can be (completely) random, regular or (with polygons)
triangular. Chapter <a href="pointpatterns.html#pointpatterns">11</a> explains how spatial sampling
(or point pattern simulation) methods available in package <code>spatstat</code>
are interfaced through <code>st_sample</code>.</p>
<p>Function <code>st_make_grid</code> creates a square, rectangular or hexagonal
grid over a region, or points with the grid centers or corners. It
was used to create the rectangular grid in figure <a href="sf.html#fig:largest">7.4</a>.</p>
<p>Function <code>st_interpolate_aw</code> “interpolates” area values to new areas,
as explained in section <a href="featureattributes.html#area-weighted">5.3</a>, both for intensive
and extensive variables.</p>
</div>
</div>
<div id="package-stars" class="section level2">
<h2><span class="header-section-number">7.3</span> Package <code>stars</code></h2>
<p>Athough package <code>sp</code> has always had limited support for raster data,
over the last decade R package <code>raster</code> <span class="citation">(Hijmans <a href="#ref-R-raster">2021</a><a href="#ref-R-raster">a</a>)</span> has clearly been
dominant as the prime package for powerful, flexible and scalable
raster analysis. The raster data model of package <code>raster</code> (and
its successor, <code>terra</code> <span class="citation">(Hijmans <a href="#ref-R-terra">2021</a><a href="#ref-R-terra">b</a>)</span>) is that of a 2D regular raster,
or a set of raster layers (a “raster stack”). This aligns with
the classical static “GIS world view”, where the world is modelled
as a set of layers, each representing a different theme. A lot of
data available today however is dynamic, and comes as time series
of rasters or raster stacks. A raster stack does not meaningfully
reflect this, requiring the user to keep a register of which layer
represents what.</p>
<p>Also, the <code>raster</code> package, and its successer <code>terra</code> do an excellent
job in scaling computations up to datasizes no larger than the local
storage (the computer’s hard drives), and doing this fast. Recent
datasets however, including satellite imagery, climate model or
weather forecasting data, often no longer fit in local storage
(chapter <a href="large.html#large">8</a>). Package <code>spacetime</code> <span class="citation">(Pebesma <a href="#ref-spacetime2012">2012</a>)</span>
addresses the analysis of time series of vector geometries or raster
grid cells, but does not extend to higher-dimensional arrays.</p>
<p>Here, we introduce package <code>stars</code> for analysing raster and vector
data cubes. The package</p>
<ul>
<li>allows for representing dynamic (time varying) raster stacks,</li>
<li>aims at being scalable, also beyond local disk size,</li>
<li>provides a strong integration of raster functions in the GDAL
library</li>
<li>in addition to regular grids handles rotated, sheared, rectilinear and curvilinear rasters (figure <a href="intro.html#fig:rastertypes01">1.5</a>),</li>
<li>provides a tight integration with package <code>sf</code>,</li>
<li>also handles array data with non-raster spatial dimensions, the <em>vector data cubes</em>, and</li>
<li>follows the tidyverse design principles.</li>
</ul>
<p>Vector data cubes include for instance time series for simple
features, or spatial graph data such as potentially dynamic
origin-destination matrices. The concept of spatial vector and
raster data cubes was explained in chapter <a href="datacube.html#datacube">6</a>.</p>
<div id="reading-and-writing-raster-data" class="section level3">
<h3><span class="header-section-number">7.3.1</span> Reading and writing raster data</h3>
<p>Raster data typically are read from a file. We use a dataset
containing a section of Landsat 7 scene, with the 6 30m-resolution
bands (bands 1-5 and 7) for a region covering the city of Olinda,
Brazil. We can read the example GeoTIFF file holding a regular,
non-rotated grid from the package <code>stars</code>:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb112-1" title="1">tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</a>
<a class="sourceLine" id="cb112-2" title="2"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb112-3" title="3">(<span class="dt">r =</span> <span class="kw">read_stars</span>(tif))</a></code></pre></div>
<pre><code># stars object with 3 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif   
#  Min.   :  1.0  
#  1st Qu.: 54.0  
#  Median : 69.0  
#  Mean   : 68.9  
#  3rd Qu.: 86.0  
#  Max.   :255.0  
# dimension(s):
#      from  to  offset delta                       refsys point values x/y
# x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]
# y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]
# band    1   6      NA    NA                           NA    NA   NULL</code></pre>
<p>where we see the offset, cellsize, coordinate reference system,
and dimensions. The dimension table reports the following for
each dimension:</p>
<ul>
<li><code>from</code>: the starting index</li>
<li><code>to</code>: the ending index</li>
<li><code>offset</code>: the dimension value at the start (edge) of the first pixel</li>
<li><code>delta</code>: the cell size; negative <code>delta</code> values indicate that pixel index increases with decreasing dimension values</li>
<li><code>refsys</code>: the reference system</li>
<li><code>point</code>: boolean, indicating whether cell values have point support or cell support</li>
<li><code>values</code>: a list with values or labels associated with each of the dimension’s values</li>
<li><code>x/y</code>: an indicator whether a dimension is associated with a spatial raster x- or y-axis</li>
</ul>
<p>For regular, rotated or sheared grids or other regularly discretized
dimensions (e.g. time), <code>offset</code> and <code>delta</code> are not <code>NA</code> and values
and <code>values</code> is <code>NULL</code>; for other cases, <code>offset</code> and <code>delta</code> are
<code>NA</code> and <code>values</code> contains one of:</p>
<ul>
<li>the sequence of values, or intervals, in case of a rectlinear spatial raster or irregular time dimension</li>
<li>in case of a vector data cube, geometries associated with the spatial dimension</li>
<li>in case of a curvilinear raster, the matrix with coordinate values for each raster cell</li>
<li>in case of a discrete dimension, the band names or labels associated with the dimension values</li>
</ul>
<p>The object <code>r</code> is of class <code>stars</code> and is a simple list of length
one, holding a three-dimensional array:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb114-1" title="1"><span class="kw">length</span>(r)</a></code></pre></div>
<pre><code># [1] 1</code></pre>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb116-1" title="1"><span class="kw">class</span>(r[[<span class="dv">1</span>]])</a></code></pre></div>
<pre><code># [1] &quot;array&quot;</code></pre>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb118-1" title="1"><span class="kw">dim</span>(r[[<span class="dv">1</span>]])</a></code></pre></div>
<pre><code>#    x    y band 
#  349  352    6</code></pre>
<p>and in addition holds an attribute with a dimensions table with all the metadata
required to know what the array dimensions refer to, obtained by</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb120-1" title="1"><span class="kw">st_dimensions</span>(r)</a></code></pre></div>
<p>We can get the spatial extent of the array by</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb121-1" title="1"><span class="kw">st_bbox</span>(r)</a></code></pre></div>
<pre><code>#    xmin    ymin    xmax    ymax 
#  288776 9110729  298723 9120761</code></pre>
<p>Raster data can be written to local disk using <code>write_stars</code>:</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb123-1" title="1">tf =<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">&quot;.tif&quot;</span>)</a>
<a class="sourceLine" id="cb123-2" title="2"><span class="kw">write_stars</span>(r, tf)</a></code></pre></div>
<p>where again the data format (in this case, GeoTIFF) is derived from the file
extension. As for simple features, reading and writing uses the GDAL
library; the list of available drivers for raster data is obtained
by</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb124-1" title="1"><span class="kw">st_drivers</span>(<span class="st">&quot;raster&quot;</span>)</a></code></pre></div>
</div>
<div id="subsetting-stars-data-cubes" class="section level3">
<h3><span class="header-section-number">7.3.2</span> Subsetting <code>stars</code> data cubes</h3>
<p>Data cubes can be subsetted using <code>[</code>, or using tidyverse verbs. The
first options, <code>[</code> uses for the arguments: attributes first,
followed by dimension. This means that <code>r[1:2, 101:200, , 5:10]</code>
selects from <code>r</code> attributes 1-2, index 101-200 for dimension 1, and index
5-10 for dimension 3; omitting dimension 2 means that no subsetting
takes place. For attributes, attributes names or logical vectors
can be used. For dimensions, logical vectors are not supported;
Selecting discontinuous ranges supported when it it is a regular
sequence. By default, <code>drop</code> is FALSE, when set to <code>TRUE</code> dimensions
with a single value are dropped:</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb125-1" title="1">r[,<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>, <span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">250</span>, <span class="dv">5</span>), <span class="dv">4</span>] <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">dim</span>()</a></code></pre></div>
<pre><code>#    x    y band 
#  100   50    1</code></pre>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb127-1" title="1">r[,<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>, <span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">250</span>, <span class="dv">5</span>), <span class="dv">4</span>, drop =<span class="st"> </span><span class="ot">TRUE</span>] <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">dim</span>()</a></code></pre></div>
<pre><code>#   x   y 
# 100  50</code></pre>
<p>For selecting particular ranges of dimension <em>values</em>, one can use
<code>filter</code> (after loading <code>dplyr</code>):</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb129-1" title="1"><span class="kw">library</span>(dplyr, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb129-2" title="2"><span class="kw">filter</span>(r, x <span class="op">&gt;</span><span class="st"> </span><span class="dv">289000</span>, x <span class="op">&lt;</span><span class="st"> </span><span class="dv">290000</span>)</a></code></pre></div>
<pre><code># stars object with 3 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif   
#  Min.   :  5.0  
#  1st Qu.: 51.0  
#  Median : 63.0  
#  Mean   : 64.3  
#  3rd Qu.: 75.0  
#  Max.   :242.0  
# dimension(s):
#      from  to  offset delta                       refsys point values x/y
# x       1  35  289004  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]
# y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]
# band    1   6       1     1                           NA    NA   NULL</code></pre>
<p>which changes the offset of the <span class="math inline">\(x\)</span> dimension. Particular cube slices
can also be obtained with <code>slice</code>, e.g.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb131-1" title="1"><span class="kw">slice</span>(r, band, <span class="dv">3</span>)</a></code></pre></div>
<pre><code># stars object with 2 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif   
#  Min.   : 21.0  
#  1st Qu.: 49.0  
#  Median : 63.0  
#  Mean   : 64.4  
#  3rd Qu.: 77.0  
#  Max.   :255.0  
# dimension(s):
#   from  to  offset delta                       refsys point values x/y
# x    1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]
# y    1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</code></pre>
<p>which drops the singular dimension. <code>mutate</code> can be used on <code>stars</code>
objects to add new arrays as functions of existing ones, <code>transmute</code>
drops existing ones.</p>
</div>
<div id="cropping" class="section level3">
<h3><span class="header-section-number">7.3.3</span> Cropping</h3>
<p>Further subsetting can be done using spatial objects of class <code>sf</code>, <code>sfc</code>
or <code>bbox</code>, e.g. when using the sample raster,</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb133-1" title="1">b =<span class="st"> </span><span class="kw">st_bbox</span>(r) <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb133-2" title="2"><span class="st">    </span><span class="kw">st_as_sfc</span>() <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb133-3" title="3"><span class="st">    </span><span class="kw">st_centroid</span>() <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb133-4" title="4"><span class="st">    </span><span class="kw">st_buffer</span>(units<span class="op">::</span><span class="kw">set_units</span>(<span class="dv">500</span>, m))</a>
<a class="sourceLine" id="cb133-5" title="5">r[b]</a></code></pre></div>
<pre><code># stars object with 3 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif  
#  Min.   : 22   
#  1st Qu.: 54   
#  Median : 66   
#  Mean   : 68   
#  3rd Qu.: 78   
#  Max.   :174   
#  NA&#39;s   :2184  
# dimension(s):
#      from  to  offset delta                       refsys point values x/y
# x     157 193  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]
# y     159 194 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]
# band    1   6      NA    NA                           NA    NA   NULL</code></pre>
selects the circular center region with a diameter of 500 metre, for
the first band shown in figure <a href="sf.html#fig:circr">7.5</a>,
<div class="figure" style="text-align: center"><span id="fig:circr"></span>
<img src="sds_files/figure-html/circr-1.png" alt="circular center region of the Landsat 7 scene (band 1)" width="672" />
<p class="caption">
Figure 7.5: circular center region of the Landsat 7 scene (band 1)
</p>
</div>
<p>where we see that pixels outside the spatial object are assigned <code>NA</code> values.
This object still has dimension indexes relative to the <code>offset</code> and <code>delta</code>
values of <code>r</code>; we can reset these to a new <code>offset</code> with</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb135-1" title="1">r[b] <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">st_normalize</span>() <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">st_dimensions</span>()</a></code></pre></div>
<pre><code>#      from to  offset delta                       refsys point values x/y
# x       1 37  293222  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]
# y       1 36 9116258 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]
# band    1  6      NA    NA                           NA    NA   NULL</code></pre>
<p>By default, the resulting raster is cropped to the extent of the
selection object; an object with the same dimensions as the input
object is obtained with</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb137-1" title="1">r[b, crop =<span class="st"> </span><span class="ot">FALSE</span>]</a></code></pre></div>
<pre><code># stars object with 3 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif    
#  Min.   : 22     
#  1st Qu.: 54     
#  Median : 66     
#  Mean   : 68     
#  3rd Qu.: 78     
#  Max.   :174     
#  NA&#39;s   :731280  
# dimension(s):
#      from  to  offset delta                       refsys point values x/y
# x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]
# y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]
# band    1   6      NA    NA                           NA    NA   NULL</code></pre>
<p>Cropping a <code>stars</code> object can alternatively be done directly with <code>st_crop</code>, as in</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb139-1" title="1"><span class="kw">st_crop</span>(r, b)</a></code></pre></div>
</div>
<div id="redimensioning-stars-objects" class="section level3">
<h3><span class="header-section-number">7.3.4</span> redimensioning <code>stars</code> objects</h3>
<p>Package <code>stars</code> uses package <code>abind</code> <span class="citation">(Plate and Heiberger <a href="#ref-R-abind">2016</a>)</span> for a number of
array manipulations. One of them is <code>aperm</code> which transposes an
array by permuting it. A method for <code>stars</code> objects is provided, and</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb140-1" title="1"><span class="kw">aperm</span>(r, <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>))</a></code></pre></div>
<pre><code># stars object with 3 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif   
#  Min.   :  1.0  
#  1st Qu.: 54.0  
#  Median : 69.0  
#  Mean   : 68.9  
#  3rd Qu.: 86.0  
#  Max.   :255.0  
# dimension(s):
#      from  to  offset delta                       refsys point values x/y
# band    1   6      NA    NA                           NA    NA   NULL    
# x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]
# y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</code></pre>
<p>permutes the order of dimensions of the resulting object.</p>
<p>Attributes and dimensions can be swapped, using <code>merge</code> and <code>split</code>:</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb142-1" title="1">(<span class="dt">rs =</span> <span class="kw">split</span>(r))</a></code></pre></div>
<pre><code># stars object with 2 dimensions and 6 attributes
# attribute(s):
#       X1              X2              X3              X4        
#  Min.   : 47.0   Min.   : 32.0   Min.   : 21.0   Min.   :  9.0  
#  1st Qu.: 67.0   1st Qu.: 55.0   1st Qu.: 49.0   1st Qu.: 52.0  
#  Median : 78.0   Median : 66.0   Median : 63.0   Median : 63.0  
#  Mean   : 79.1   Mean   : 67.6   Mean   : 64.4   Mean   : 59.2  
#  3rd Qu.: 89.0   3rd Qu.: 79.0   3rd Qu.: 77.0   3rd Qu.: 75.0  
#  Max.   :255.0   Max.   :255.0   Max.   :255.0   Max.   :255.0  
#       X5              X6      
#  Min.   :  1.0   Min.   :  1  
#  1st Qu.: 63.0   1st Qu.: 32  
#  Median : 89.0   Median : 60  
#  Mean   : 83.2   Mean   : 60  
#  3rd Qu.:112.0   3rd Qu.: 88  
#  Max.   :255.0   Max.   :255  
# dimension(s):
#   from  to  offset delta                       refsys point values x/y
# x    1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]
# y    1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</code></pre>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb144-1" title="1"><span class="kw">merge</span>(rs)</a></code></pre></div>
<pre><code># stars object with 3 dimensions and 1 attribute
# attribute(s):
#        X        
#  Min.   :  1.0  
#  1st Qu.: 54.0  
#  Median : 69.0  
#  Mean   : 68.9  
#  3rd Qu.: 86.0  
#  Max.   :255.0  
# dimension(s):
#            from  to  offset delta                       refsys point    values
# x             1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE      NULL
# y             1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE      NULL
# attributes    1   6      NA    NA                           NA    NA X1,...,X6
#            x/y
# x          [x]
# y          [y]
# attributes</code></pre>
<p>split distributes the <code>band</code> dimension over 6 attributes of a
2-dimensional array, <code>merge</code> reverses this operation. <code>st_redimension</code>
can be used for more generic operations, such as splitting a single array
dimension over two new dimensions:</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb146-1" title="1"><span class="kw">st_redimension</span>(r, <span class="kw">c</span>(<span class="dv">349</span>, <span class="dv">352</span>, <span class="dv">3</span>, <span class="dv">2</span>))</a></code></pre></div>
<pre><code># stars object with 4 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif   
#  Min.   :  1.0  
#  1st Qu.: 54.0  
#  Median : 69.0  
#  Mean   : 68.9  
#  3rd Qu.: 86.0  
#  Max.   :255.0  
# dimension(s):
#    from  to  offset delta                       refsys point values
# X1    1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL
# X2    1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL
# X3    1   3      NA    NA                           NA    NA   NULL
# X4    1   2      NA    NA                           NA    NA   NULL</code></pre>
</div>
<div id="extracting-point-samples-aggregating" class="section level3">
<h3><span class="header-section-number">7.3.5</span> extracting point samples, aggregating</h3>
<p>A very common use case for raster data cube analysis is the extraction
of values at certain locations, or computing aggregations over certain
geometries. <code>st_extract</code> extracts point values. We will do this
for a few randomly sampled points over the bounding box of <code>r</code>:</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb148-1" title="1">pts =<span class="st"> </span><span class="kw">st_bbox</span>(r) <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">st_as_sfc</span>() <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">st_sample</span>(<span class="dv">20</span>)</a>
<a class="sourceLine" id="cb148-2" title="2">(<span class="dt">e =</span> <span class="kw">st_extract</span>(r, pts))</a></code></pre></div>
<pre><code># stars object with 2 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif   
#  Min.   : 12.0  
#  1st Qu.: 41.8  
#  Median : 63.0  
#  Mean   : 61.0  
#  3rd Qu.: 80.5  
#  Max.   :145.0  
# dimension(s):
#          from to offset delta                       refsys point
# geometry    1 20     NA    NA UTM Zone 25, Southern Hem...  TRUE
# band        1  6     NA    NA                           NA    NA
#                                                     values
# geometry POINT (293002 9115516),...,POINT (290941 9114128)
# band                                                  NULL</code></pre>
<p>which results in a vector data cube with 4 points and 6 bands.</p>
</div>
<div id="predictive-models" class="section level3">
<h3><span class="header-section-number">7.3.6</span> Predictive models</h3>
<p>The typical model prediction workflow in R works as follows:</p>
<ul>
<li>use a <code>data.frame</code> with response and predictor variables (covariates)</li>
<li>create a model object based on this <code>data.frame</code></li>
<li>call <code>predict</code> with this model object and the <code>data.frame</code> with target predictor variable values</li>
</ul>
<p>Package <code>stars</code> provides a <code>predict</code> method for <code>stars</code> objects
that essentially wraps the last step, by creating the <code>data.frame</code>,
calling the <code>predict</code> method for that, and reconstructing a <code>stars</code>
object with the predicted values.</p>
<p>We will illustrate this with a trivial two-class example mapping
land from sea in the example Landsat data set, using the sample
points extracted above, shown in figure <a href="sf.html#fig:rsample">7.6</a>.</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb150-1" title="1"><span class="kw">plot</span>(r[,,,<span class="dv">1</span>], <span class="dt">reset =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb150-2" title="2">col =<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;green&quot;</span>, <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb150-3" title="3">col[<span class="kw">c</span>(<span class="dv">8</span>, <span class="dv">14</span>, <span class="dv">15</span>, <span class="dv">18</span>, <span class="dv">19</span>)] =<span class="st"> &quot;red&quot;</span></a>
<a class="sourceLine" id="cb150-4" title="4"><span class="kw">st_as_sf</span>(e) <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">st_coordinates</span>() <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">text</span>(<span class="dt">labels =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">20</span>, <span class="dt">col =</span> col)</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:rsample"></span>
<img src="sds_files/figure-html/rsample-1.png" alt="randomly chosen sample locations for training data; red: water, green: land" width="672" />
<p class="caption">
Figure 7.6: randomly chosen sample locations for training data; red: water, green: land
</p>
</div>
<p>From this figure, we read “by eye” that the points 8, 14, 15, 18 and
19 are on water, the others on land. Using a linear discriminant
(“maximum likelihood”) classifier, we find model predictions as
shown in figure <a href="sf.html#fig:lda">7.7</a>.</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb151-1" title="1">rs =<span class="st"> </span><span class="kw">split</span>(r)</a>
<a class="sourceLine" id="cb151-2" title="2">trn =<span class="st"> </span><span class="kw">st_extract</span>(rs, pts)</a>
<a class="sourceLine" id="cb151-3" title="3">trn<span class="op">$</span>cls =<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;land&quot;</span>, <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb151-4" title="4">trn<span class="op">$</span>cls[<span class="kw">c</span>(<span class="dv">8</span>, <span class="dv">14</span>, <span class="dv">15</span>, <span class="dv">18</span>, <span class="dv">19</span>)] =<span class="st"> &quot;water&quot;</span></a>
<a class="sourceLine" id="cb151-5" title="5">model =<span class="st"> </span>MASS<span class="op">::</span><span class="kw">lda</span>(cls <span class="op">~</span><span class="st"> </span>., <span class="kw">st_set_geometry</span>(trn, <span class="ot">NULL</span>))</a>
<a class="sourceLine" id="cb151-6" title="6">pr =<span class="st"> </span><span class="kw">predict</span>(rs, model)</a></code></pre></div>
<p>Here, we used the <code>MASS::</code> prefix to avoid loading <code>MASS</code>, as that
would mask <code>select</code> from <code>dplyr</code>. Another way would be to load
<code>MASS</code> and unload it later on with <code>detach()</code>.</p>

<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb152-1" title="1"><span class="kw">plot</span>(pr[<span class="dv">1</span>], <span class="dt">key.pos =</span> <span class="dv">4</span>, <span class="dt">key.width =</span> <span class="kw">lcm</span>(<span class="fl">3.5</span>), <span class="dt">key.length =</span> <span class="kw">lcm</span>(<span class="dv">2</span>))</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:lda"></span>
<img src="sds_files/figure-html/lda-1.png" alt="Linear discriminant classifier for land/water, based on training data of figure 7.6" width="672" />
<p class="caption">
Figure 7.7: Linear discriminant classifier for land/water, based on training data of figure <a href="sf.html#fig:rsample">7.6</a>
</p>
</div>
<p>We also see that the layer plotted in figure <a href="sf.html#fig:lda">7.7</a> is a
<code>factor</code> variable, with class labels.</p>
</div>
<div id="gdal-utils" class="section level3">
<h3><span class="header-section-number">7.3.7</span> GDAL utils</h3>
</div>
<div id="plotting-raster-data" class="section level3">
<h3><span class="header-section-number">7.3.8</span> Plotting raster data</h3>
<p>We can use the base <code>plot</code> method for <code>stars</code> objects, where the plot created with
<code>plot(r)</code> is shown in figure <a href="sf.html#fig:firststars">7.8</a>.</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb153-1" title="1"><span class="kw">plot</span>(r)</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:firststars"></span>
<img src="sds_files/figure-html/firststars-1.png" alt="6 30m Landsat bands downsampled to 90m for Olinda, Br." width="672" />
<p class="caption">
Figure 7.8: 6 30m Landsat bands downsampled to 90m for Olinda, Br.
</p>
</div>
<p>is shown in figure <a href="sf.html#fig:firststars">7.8</a>.
The default color scale uses grey tones, and stretches these such
that color breaks correspond to data quantiles over all bands
(“histogram equalization”). A more familiar view is the RGB or
false color composite shown in figure <a href="sf.html#fig:starsrgb">7.9</a>.</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb154-1" title="1"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb154-2" title="2"><span class="kw">plot</span>(r, <span class="dt">rgb =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">&quot;RGB&quot;</span>)    <span class="co"># rgb</span></a>
<a class="sourceLine" id="cb154-3" title="3"><span class="kw">plot</span>(r, <span class="dt">rgb =</span> <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>), <span class="dt">main =</span> <span class="st">&quot;False color (NIR-R-G)&quot;</span>) <span class="co"># false color</span></a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:starsrgb"></span>
<img src="sds_files/figure-html/starsrgb-1.png" alt="Two color composites" width="100%" />
<p class="caption">
Figure 7.9: Two color composites
</p>
</div>
<p>Further details and options are given in Chapter <a href="plotting.html#plotting">9</a>.</p>
</div>
<div id="analysing-raster-data" class="section level3">
<h3><span class="header-section-number">7.3.9</span> Analysing raster data</h3>
<p>Element-wise mathematical functions (section <a href="datacube.html#applydimension">6.3.2</a>)
on <code>stars</code> objects are just passed on to the arrays. This means
that we can call functions and create expressions:</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb155-1" title="1"><span class="kw">log</span>(r)</a></code></pre></div>
<pre><code># stars object with 3 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif  
#  Min.   :0.00  
#  1st Qu.:3.99  
#  Median :4.23  
#  Mean   :4.12  
#  3rd Qu.:4.45  
#  Max.   :5.54  
# dimension(s):
#      from  to  offset delta                       refsys point values x/y
# x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]
# y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]
# band    1   6      NA    NA                           NA    NA   NULL</code></pre>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb157-1" title="1">r <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">log</span>(r)</a></code></pre></div>
<pre><code># stars object with 3 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif   
#  Min.   :  1.0  
#  1st Qu.: 62.0  
#  Median : 77.5  
#  Mean   : 77.1  
#  3rd Qu.: 94.9  
#  Max.   :266.1  
# dimension(s):
#      from  to  offset delta                       refsys point values x/y
# x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]
# y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]
# band    1   6      NA    NA                           NA    NA   NULL</code></pre>
<p>or even mask out certain values:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb159-1" title="1">r2 =<span class="st"> </span>r</a>
<a class="sourceLine" id="cb159-2" title="2">r2[r <span class="op">&lt;</span><span class="st"> </span><span class="dv">50</span>] =<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb159-3" title="3">r2</a></code></pre></div>
<pre><code># stars object with 3 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif    
#  Min.   : 50     
#  1st Qu.: 64     
#  Median : 75     
#  Mean   : 79     
#  3rd Qu.: 90     
#  Max.   :255     
#  NA&#39;s   :149170  
# dimension(s):
#      from  to  offset delta                       refsys point values x/y
# x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]
# y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]
# band    1   6      NA    NA                           NA    NA   NULL</code></pre>
<p>or un-mask areas:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb161-1" title="1">r2[<span class="kw">is.na</span>(r2)] =<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb161-2" title="2">r2</a></code></pre></div>
<pre><code># stars object with 3 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif 
#  Min.   :  0  
#  1st Qu.: 54  
#  Median : 69  
#  Mean   : 63  
#  3rd Qu.: 86  
#  Max.   :255  
# dimension(s):
#      from  to  offset delta                       refsys point values x/y
# x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]
# y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]
# band    1   6      NA    NA                           NA    NA   NULL</code></pre>
<p>Dimension-wise, we can apply functions to selected array dimensions
(section <a href="datacube.html#reducedimension">6.3.3</a>)
of stars objects similar to how <code>apply</code> does this to arrays. For
instance, we can compute for each pixel the mean of the 6 band values by</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb163-1" title="1"><span class="kw">st_apply</span>(r, <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), mean)</a></code></pre></div>
<pre><code># stars object with 2 dimensions and 1 attribute
# attribute(s):
#      mean       
#  Min.   : 25.5  
#  1st Qu.: 53.3  
#  Median : 68.3  
#  Mean   : 68.9  
#  3rd Qu.: 82.0  
#  Max.   :255.0  
# dimension(s):
#   from  to  offset delta                       refsys point values x/y
# x    1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]
# y    1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</code></pre>
<p>A more meaningful function would e.g. compute the NDVI (normalized
differenced vegetation index):</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb165-1" title="1">ndvi =<span class="st"> </span><span class="cf">function</span>(b1, b2, b3, b4, b5, b6) (b4 <span class="op">-</span><span class="st"> </span>b3)<span class="op">/</span>(b4 <span class="op">+</span><span class="st"> </span>b3)</a>
<a class="sourceLine" id="cb165-2" title="2"><span class="kw">st_apply</span>(r, <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), ndvi)</a></code></pre></div>
<pre><code># stars object with 2 dimensions and 1 attribute
# attribute(s):
#      ndvi        
#  Min.   :-0.753  
#  1st Qu.:-0.203  
#  Median :-0.069  
#  Mean   :-0.064  
#  3rd Qu.: 0.187  
#  Max.   : 0.587  
# dimension(s):
#   from  to  offset delta                       refsys point values x/y
# x    1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]
# y    1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</code></pre>
<p>Alternatively, one could have defined</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb167-1" title="1">ndvi2 =<span class="st"> </span><span class="cf">function</span>(x) (x[<span class="dv">4</span>]<span class="op">-</span>x[<span class="dv">3</span>])<span class="op">/</span>(x[<span class="dv">4</span>]<span class="op">+</span>x[<span class="dv">3</span>])</a></code></pre></div>
<p>which is more convenient if the number of bands is large,
but which is also much slower than <code>ndvi</code> as it
needs to be called for every pixel whereas <code>ndvi</code> can be called
once for all pixels, or for large chunks of pixels.
The mean for each band over the whole image is computed by</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb168-1" title="1"><span class="kw">as.data.frame</span>(<span class="kw">st_apply</span>(r, <span class="kw">c</span>(<span class="st">&quot;band&quot;</span>), mean))</a></code></pre></div>
<pre><code>#   band mean
# 1    1 79.1
# 2    2 67.6
# 3    3 64.4
# 4    4 59.2
# 5    5 83.2
# 6    6 60.0</code></pre>
<p>the result of which is small enough to be printed here as a <code>data.frame</code>. In these
two examples, entire dimensions disappear. Sometimes, this does not
happen (section <a href="datacube.html#applydimension">6.3.2</a>); we can for instance compute the three quartiles for each band</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb170-1" title="1"><span class="kw">st_apply</span>(r, <span class="kw">c</span>(<span class="st">&quot;band&quot;</span>), quantile, <span class="kw">c</span>(.<span class="dv">25</span>, <span class="fl">.5</span>, <span class="fl">.75</span>))</a></code></pre></div>
<pre><code># stars object with 2 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif   
#  Min.   : 32.0  
#  1st Qu.: 60.8  
#  Median : 66.5  
#  Mean   : 69.8  
#  3rd Qu.: 78.8  
#  Max.   :112.0  
# dimension(s):
#          from to offset delta refsys point        values
# quantile    1  3     NA    NA     NA    NA 25%, 50%, 75%
# band        1  6     NA    NA     NA    NA          NULL</code></pre>
<p>and see that this <em>creates</em> a new dimension, <code>quantile</code>, with three values.
Alternatively, the three quantiles over the 6 bands for each pixel are
obtained by</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb172-1" title="1"><span class="kw">st_apply</span>(r, <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), quantile, <span class="kw">c</span>(.<span class="dv">25</span>, <span class="fl">.5</span>, <span class="fl">.75</span>))</a></code></pre></div>
<pre><code># stars object with 3 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif   
#  Min.   :  4.0  
#  1st Qu.: 55.0  
#  Median : 69.2  
#  Mean   : 67.2  
#  3rd Qu.: 81.2  
#  Max.   :255.0  
# dimension(s):
#          from  to  offset delta                       refsys point
# quantile    1   3      NA    NA                           NA    NA
# x           1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE
# y           1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE
#                 values x/y
# quantile 25%, 50%, 75%    
# x                 NULL [x]
# y                 NULL [y]</code></pre>
</div>
<div id="curvilinear-rasters" class="section level3">
<h3><span class="header-section-number">7.3.10</span> Curvilinear rasters</h3>
<p>There are several reasons why non-regular rasters occur (figure
<a href="intro.html#fig:rastertypes01">1.5</a>). For one, when the data is Earth-bound,
a regular raster does not fit the Earth’s surface, which is
curved. Other reasons are:</p>
<ul>
<li>when we convert or transform a regular raster data into another
coordinate reference system, it will become curvilinear unless we
resample (warp; section <a href="sf.html#warp">7.7</a>); warping always goes at the
cost of some loss of data and is not reversible.</li>
<li>observation may lead to irregular rasters; e.g. for satellite swaths, we
may have a regular raster in the direction of the satellite (not
aligned with <span class="math inline">\(x\)</span> or <span class="math inline">\(y\)</span>), and rectilinear in the direction perpendicular to that
(e.g. if the sensor discretizes the viewing <em>angle</em> in equal sections)</li>
</ul>
</div>
</div>
<div id="vector-data-cube-examples" class="section level2">
<h2><span class="header-section-number">7.4</span> Vector data cube examples</h2>
<div id="example-aggregating-air-quality-time-series" class="section level3">
<h3><span class="header-section-number">7.4.1</span> Example: aggregating air quality time series</h3>
<p>Air quality data from package <code>spacetime</code> were
obtained from the <a href="https://www.eea.europa.eu/data-and-maps/data/aqereporting-8">airBase European air quality data
base</a>.
Daily average PM<span class="math inline">\(_{10}\)</span> values were downloaded for rural background
stations in Germany, 1998-2009.</p>
<p>We can create a <code>stars</code> object from the <code>air</code> matrix, the <code>dates</code>
Date vector and the <code>stations</code> <code>SpatialPoints</code> objects by</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb174-1" title="1"><span class="kw">library</span>(spacetime)</a>
<a class="sourceLine" id="cb174-2" title="2"><span class="kw">data</span>(air) <span class="co"># this loads several datasets in .GlobalEnv</span></a>
<a class="sourceLine" id="cb174-3" title="3"><span class="kw">dim</span>(air)</a></code></pre></div>
<pre><code># space  time 
#    70  4383</code></pre>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb176-1" title="1">d =<span class="st"> </span><span class="kw">st_dimensions</span>(<span class="dt">station =</span> <span class="kw">st_as_sfc</span>(stations), <span class="dt">time =</span> dates)</a>
<a class="sourceLine" id="cb176-2" title="2">(<span class="dt">aq =</span> <span class="kw">st_as_stars</span>(<span class="kw">list</span>(<span class="dt">PM10 =</span> air), <span class="dt">dimensions =</span> d))</a></code></pre></div>
<pre><code># stars object with 2 dimensions and 1 attribute
# attribute(s):
#      PM10        
#  Min.   :  0     
#  1st Qu.: 10     
#  Median : 15     
#  Mean   : 18     
#  3rd Qu.: 22     
#  Max.   :274     
#  NA&#39;s   :157659  
# dimension(s):
#         from   to     offset  delta                       refsys point
# station    1   70         NA     NA +proj=longlat +datum=WGS8...  TRUE
# time       1 4383 1998-01-01 1 days                         Date FALSE
#                                          values
# station POINT (9.59 53.7),...,POINT (9.45 49.2)
# time                                       NULL</code></pre>
<p>We can see from figure <a href="sf.html#fig:airst">7.10</a> that the time series are
quite long, but also have large missing value gaps.
Figure <a href="sf.html#fig:airmap">7.11</a> shows the spatial distribution measurement stations and
mean PM<span class="math inline">\(_{10}\)</span> values.</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb178-1" title="1"><span class="kw">image</span>(<span class="kw">aperm</span>(<span class="kw">log</span>(aq), <span class="dv">2</span><span class="op">:</span><span class="dv">1</span>), <span class="dt">main =</span> <span class="st">&quot;NA pattern (white) in PM10 station time series&quot;</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:airst"></span>
<img src="sds_files/figure-html/airst-1.png" alt="space-time diagram of PM$_{10}$ measurements by time and station" width="672" />
<p class="caption">
Figure 7.10: space-time diagram of PM<span class="math inline">\(_{10}\)</span> measurements by time and station
</p>
</div>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb179-1" title="1"><span class="kw">plot</span>(<span class="kw">st_as_sf</span>(<span class="kw">st_apply</span>(aq, <span class="dv">1</span>, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)), <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">pch =</span> <span class="dv">16</span>,</a>
<a class="sourceLine" id="cb179-2" title="2">    <span class="dt">ylim =</span> <span class="kw">st_bbox</span>(DE)[<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>)])</a></code></pre></div>
<pre><code># Warning in sp::proj4string(obj): CRS object has comment, which is lost in output</code></pre>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb181-1" title="1"><span class="kw">plot</span>(DE, <span class="dt">add=</span><span class="ot">TRUE</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:airmap"></span>
<img src="sds_files/figure-html/airmap-1.png" alt="locations of PM$_{10}$ measurement stations, showing mean values" width="672" />
<p class="caption">
Figure 7.11: locations of PM<span class="math inline">\(_{10}\)</span> measurement stations, showing mean values
</p>
</div>
<p>We can aggregate these station time series to area means, mostly
as a simple exercise. For this, we use the <code>aggregate</code> method for
<code>stars</code> objects</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb182-1" title="1">(<span class="dt">a =</span> <span class="kw">aggregate</span>(aq, <span class="kw">st_as_sf</span>(DE_NUTS1), mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
<pre><code># stars object with 2 dimensions and 1 attribute
# attribute(s):
#      PM10       
#  Min.   :  1    
#  1st Qu.: 11    
#  Median : 15    
#  Mean   : 18    
#  3rd Qu.: 22    
#  Max.   :172    
#  NA&#39;s   :25679  
# dimension(s):
#          from   to     offset  delta                       refsys point
# geometry    1   16         NA     NA +proj=longlat +datum=WGS8... FALSE
# time        1 4383 1998-01-01 1 days                         Date FALSE
#                                                                     values
# geometry MULTIPOLYGON (((9.65 49.8, ...,...,MULTIPOLYGON (((10.8 51.6, ...
# time                                                                  NULL</code></pre>
<p>and we can now for instance show the maps for six arbitrarily chosen days
(figure <a href="sf.html#fig:airagg">7.12</a>), using</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb184-1" title="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb184-2" title="2">a <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">filter</span>(time <span class="op">&gt;=</span><span class="st"> &quot;2008-01-01&quot;</span>, time <span class="op">&lt;</span><span class="st"> &quot;2008-01-07&quot;</span>) <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb184-3" title="3"><span class="st">    </span><span class="kw">plot</span>(<span class="dt">key.pos =</span> <span class="dv">4</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:airagg"></span>
<img src="sds_files/figure-html/airagg-1.png" alt="areal mean PM$_{10}$ values, for six days" width="672" />
<p class="caption">
Figure 7.12: areal mean PM<span class="math inline">\(_{10}\)</span> values, for six days
</p>
</div>
<p>or create a time series plot of mean values for a single state
(figure <a href="sf.html#fig:airts">7.13</a>) by</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb185-1" title="1"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(xts))</a>
<a class="sourceLine" id="cb185-2" title="2"><span class="kw">plot</span>(<span class="kw">as.xts</span>(a)[,<span class="dv">4</span>], <span class="dt">main =</span> DE_NUTS1<span class="op">$</span>NAME_<span class="dv">1</span>[<span class="dv">4</span>])</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:airts"></span>
<img src="sds_files/figure-html/airts-1.png" alt="areal mean PM$_{10}$ values, for six days" width="672" />
<p class="caption">
Figure 7.13: areal mean PM<span class="math inline">\(_{10}\)</span> values, for six days
</p>
</div>
</div>
<div id="example-bristol-origin-destination-datacube" class="section level3">
<h3><span class="header-section-number">7.4.2</span> Example: Bristol origin-destination datacube</h3>
<p>The data used for this example come from <span class="citation">(Lovelace, Nowosad, and Muenchow <a href="#ref-geocomp">2019</a>)</span>, and concern
origin-destination (OD) counts: the number of persons going from
region A to region B, by transportation mode. We have feature
geometries for the 102 origin and destination regions, shown in figure <a href="sf.html#fig:bristol1">7.14</a>.</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb186-1" title="1"><span class="kw">library</span>(spDataLarge)</a>
<a class="sourceLine" id="cb186-2" title="2"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(bristol_zones), <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">graticule =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb186-3" title="3"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(bristol_zones)[<span class="dv">33</span>], <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:bristol1"></span>
<img src="sds_files/figure-html/bristol1-1.png" alt="Origin destination data zones for Bristol, UK, with zone 33 (E02003043) colored red" width="672" />
<p class="caption">
Figure 7.14: Origin destination data zones for Bristol, UK, with zone 33 (E02003043) colored red
</p>
</div>
<p>and the OD counts come in a table
with OD pairs as records, and transportation mode as variables:</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb187-1" title="1"><span class="kw">head</span>(bristol_od)</a></code></pre></div>
<pre><code># # A tibble: 6 x 7
#   o         d           all bicycle  foot car_driver train
#   &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;
# 1 E02002985 E02002985   209       5   127         59     0
# 2 E02002985 E02002987   121       7    35         62     0
# 3 E02002985 E02003036    32       2     1         10     1
# 4 E02002985 E02003043   141       1     2         56    17
# 5 E02002985 E02003049    56       2     4         36     0
# 6 E02002985 E02003054    42       4     0         21     0</code></pre>
<p>We see that many combinations of origin and destination are implicit
zeroes, otherwise these two numbers would have been similar:</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb189-1" title="1"><span class="kw">nrow</span>(bristol_zones)<span class="op">^</span><span class="dv">2</span> <span class="co"># all combinations</span></a></code></pre></div>
<pre><code># [1] 10404</code></pre>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb191-1" title="1"><span class="kw">nrow</span>(bristol_od) <span class="co"># non-zero combinations</span></a></code></pre></div>
<pre><code># [1] 2910</code></pre>
<p>We will form a three-dimensional vector datacube with origin,
destination and transportation mode as dimensions. For this, we
first “tidy” the <code>bristol_od</code> table to have origin (o), destination (d),
transportation mode (mode), and count (n) as variables, using <code>gather</code>:</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb193-1" title="1"><span class="co"># create O-D-mode array:</span></a>
<a class="sourceLine" id="cb193-2" title="2">bristol_tidy &lt;-<span class="st"> </span>bristol_od <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb193-3" title="3"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>all) <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb193-4" title="4"><span class="st">    </span><span class="kw">gather</span>(<span class="st">&quot;mode&quot;</span>, <span class="st">&quot;n&quot;</span>, <span class="op">-</span>o, <span class="op">-</span>d)</a>
<a class="sourceLine" id="cb193-5" title="5"><span class="kw">head</span>(bristol_tidy)</a></code></pre></div>
<pre><code># # A tibble: 6 x 4
#   o         d         mode        n
#   &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;   &lt;dbl&gt;
# 1 E02002985 E02002985 bicycle     5
# 2 E02002985 E02002987 bicycle     7
# 3 E02002985 E02003036 bicycle     2
# 4 E02002985 E02003043 bicycle     1
# 5 E02002985 E02003049 bicycle     2
# 6 E02002985 E02003054 bicycle     4</code></pre>
<p>Next, we form the three-dimensional array <code>a</code>, filled with zeroes:</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb195-1" title="1">od =<span class="st"> </span>bristol_tidy <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">pull</span>(<span class="st">&quot;o&quot;</span>) <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">unique</span>()</a>
<a class="sourceLine" id="cb195-2" title="2">nod =<span class="st"> </span><span class="kw">length</span>(od)</a>
<a class="sourceLine" id="cb195-3" title="3">mode =<span class="st"> </span>bristol_tidy <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">pull</span>(<span class="st">&quot;mode&quot;</span>) <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">unique</span>()</a>
<a class="sourceLine" id="cb195-4" title="4">nmode =<span class="st"> </span><span class="kw">length</span>(mode)</a>
<a class="sourceLine" id="cb195-5" title="5">a =<span class="st"> </span><span class="kw">array</span>(0L,  <span class="kw">c</span>(nod, nod, nmode), </a>
<a class="sourceLine" id="cb195-6" title="6">    <span class="dt">dimnames =</span> <span class="kw">list</span>(<span class="dt">o =</span> od, <span class="dt">d =</span> od, <span class="dt">mode =</span> mode))</a>
<a class="sourceLine" id="cb195-7" title="7"><span class="kw">dim</span>(a)</a></code></pre></div>
<pre><code># [1] 102 102   4</code></pre>
<p>We see that the dimensions are named with the zone names (o, d)
and the transportation mode name (mode).
Every row of <code>bristol_tidy</code> denotes an array entry, and we can
use this to to fill the non-zero entries of the <code>bristol_tidy</code> table
with their appropriate value (<code>n</code>):</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb197-1" title="1">a[<span class="kw">as.matrix</span>(bristol_tidy[<span class="kw">c</span>(<span class="st">&quot;o&quot;</span>, <span class="st">&quot;d&quot;</span>, <span class="st">&quot;mode&quot;</span>)])] =<span class="st"> </span>bristol_tidy<span class="op">$</span>n</a></code></pre></div>
<p>To be sure that there is not an order mismatch between the zones
in <code>bristol_zones</code> and the zone names in <code>bristol_tidy</code>, we can
get the right set of zones by:</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb198-1" title="1">order =<span class="st"> </span><span class="kw">match</span>(od, bristol_zones<span class="op">$</span>geo_code) <span class="co"># it happens this equals 1:102</span></a>
<a class="sourceLine" id="cb198-2" title="2">zones =<span class="st"> </span><span class="kw">st_geometry</span>(bristol_zones)[order]</a></code></pre></div>
<p>(It happens that the order is already correct, but it is good
practice to not assume this).</p>
<p>Next, with zones and modes we can create a stars dimensions object:</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb199-1" title="1"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb199-2" title="2">(<span class="dt">d =</span> <span class="kw">st_dimensions</span>(<span class="dt">o =</span> zones, <span class="dt">d =</span> zones, <span class="dt">mode =</span> mode))</a></code></pre></div>
<pre><code>#      from  to offset delta refsys point
# o       1 102     NA    NA WGS 84 FALSE
# d       1 102     NA    NA WGS 84 FALSE
# mode    1   4     NA    NA     NA FALSE
#                                                                 values
# o    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...
# d    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...
# mode                                                 bicycle,...,train</code></pre>
<p>and finally build or stars object from <code>a</code> and <code>d</code>:</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb201-1" title="1">(<span class="dt">odm =</span> <span class="kw">st_as_stars</span>(<span class="kw">list</span>(<span class="dt">N =</span> a), <span class="dt">dimensions =</span> d))</a></code></pre></div>
<pre><code># stars object with 3 dimensions and 1 attribute
# attribute(s):
#        N       
#  Min.   :   0  
#  1st Qu.:   0  
#  Median :   0  
#  Mean   :   5  
#  3rd Qu.:   0  
#  Max.   :1296  
# dimension(s):
#      from  to offset delta refsys point
# o       1 102     NA    NA WGS 84 FALSE
# d       1 102     NA    NA WGS 84 FALSE
# mode    1   4     NA    NA     NA FALSE
#                                                                 values
# o    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...
# d    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...
# mode                                                 bicycle,...,train</code></pre>
<p>We can take a single slice through from this three-dimensional
array, e.g. for zone 33 (figure <a href="sf.html#fig:bristol1">7.14</a>), by <code>odm[,,33]</code>,
and plot it with</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb203-1" title="1"><span class="kw">plot</span>(odm[,,<span class="dv">33</span>] <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">logz =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code># Warning in st_as_sf.stars(x): working on the first sfc dimension only</code></pre>
<pre><code># Warning in st_bbox.dimensions(st_dimensions(obj), ...): returning the bounding
# box of the first geometry dimension

# Warning in st_bbox.dimensions(st_dimensions(obj), ...): returning the bounding
# box of the first geometry dimension</code></pre>
<div class="figure" style="text-align: center"><span id="fig:odm33"></span>
<img src="sds_files/figure-html/odm33-1.png" alt="OD matrix sliced for destination zone 33, by transportation mode" width="672" />
<p class="caption">
Figure 7.15: OD matrix sliced for destination zone 33, by transportation mode
</p>
</div>
<p>the result of which is shown in figure <a href="sf.html#fig:odm33">7.15</a>.
Subsetting this way, we take all attributes (there is only one: N)
since the first argument is empty, we take all origin regions (second
argument empty), we take destination zone 33 (third argument),
and all transportation modes (fourth argument empty, or missing).</p>
<p>We plotted this particular zone because it has the largest number of travelers
as its destination. We can find this out by summing all origins and
travel modes by destination:</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb206-1" title="1">d =<span class="st"> </span><span class="kw">st_apply</span>(odm, <span class="dv">2</span>, sum)</a>
<a class="sourceLine" id="cb206-2" title="2"><span class="kw">which.max</span>(d[[<span class="dv">1</span>]])</a></code></pre></div>
<pre><code># [1] 33</code></pre>
<p>Other aggregations we can carry out include: total transportation
by OD (102 x 102):</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb208-1" title="1"><span class="kw">st_apply</span>(odm, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, sum)</a></code></pre></div>
<pre><code># stars object with 2 dimensions and 1 attribute
# attribute(s):
#       sum      
#  Min.   :   0  
#  1st Qu.:   0  
#  Median :   0  
#  Mean   :  19  
#  3rd Qu.:  19  
#  Max.   :1434  
# dimension(s):
#   from  to offset delta refsys point
# o    1 102     NA    NA WGS 84 FALSE
# d    1 102     NA    NA WGS 84 FALSE
#                                                              values
# o MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...
# d MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...</code></pre>
<p>Origin totals, by mode:</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb210-1" title="1"><span class="kw">st_apply</span>(odm, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), sum)</a></code></pre></div>
<pre><code># stars object with 2 dimensions and 1 attribute
# attribute(s):
#       sum      
#  Min.   :   1  
#  1st Qu.:  58  
#  Median : 214  
#  Mean   : 490  
#  3rd Qu.: 771  
#  Max.   :2903  
# dimension(s):
#      from  to offset delta refsys point
# o       1 102     NA    NA WGS 84 FALSE
# mode    1   4     NA    NA     NA FALSE
#                                                                 values
# o    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...
# mode                                                 bicycle,...,train</code></pre>
<p>Destination totals, by mode:</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb212-1" title="1"><span class="kw">st_apply</span>(odm, <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), sum)</a></code></pre></div>
<pre><code># stars object with 2 dimensions and 1 attribute
# attribute(s):
#       sum       
#  Min.   :    0  
#  1st Qu.:   13  
#  Median :  104  
#  Mean   :  490  
#  3rd Qu.:  408  
#  Max.   :12948  
# dimension(s):
#      from  to offset delta refsys point
# d       1 102     NA    NA WGS 84 FALSE
# mode    1   4     NA    NA     NA FALSE
#                                                                 values
# d    MULTIPOLYGON (((-2.51 51.4,...,...,MULTIPOLYGON (((-2.55 51.5,...
# mode                                                 bicycle,...,train</code></pre>
<p>Origin totals, summed over modes:</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb214-1" title="1">o =<span class="st"> </span><span class="kw">st_apply</span>(odm, <span class="dv">1</span>, sum)</a></code></pre></div>
<p>Destination totals, summed over modes (we had this):</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb215-1" title="1">d =<span class="st"> </span><span class="kw">st_apply</span>(odm, <span class="dv">2</span>, sum)</a></code></pre></div>
<p>We plot <code>o</code> and <code>d</code> together after joining them by</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb216-1" title="1">x =<span class="st"> </span>(<span class="kw">c</span>(o, d, <span class="dt">along =</span> <span class="kw">list</span>(<span class="dt">od =</span> <span class="kw">c</span>(<span class="st">&quot;origin&quot;</span>, <span class="st">&quot;destination&quot;</span>))))</a>
<a class="sourceLine" id="cb216-2" title="2"><span class="kw">plot</span>(x, <span class="dt">logz =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:odjoined"></span>
<img src="sds_files/figure-html/odjoined-1.png" alt="total commutes, summed by origin (left) or destination (right)." width="672" />
<p class="caption">
Figure 7.16: total commutes, summed by origin (left) or destination (right).
</p>
</div>
<p>the result of which is shown in figure <a href="sf.html#fig:odjoined">7.16</a>.</p>
<p>There is something to say for the argument that such maps
give the wrong message, as both amount (color) and polygon
size give an impression of amount. To take out the amount
in the count, we can compute densities (count / km<span class="math inline">\(^2\)</span>), by</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb217-1" title="1"><span class="kw">library</span>(units)</a></code></pre></div>
<pre><code># udunits database from /usr/share/xml/udunits/udunits2.xml</code></pre>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb219-1" title="1">a =<span class="st"> </span><span class="kw">set_units</span>(<span class="kw">st_area</span>(<span class="kw">st_as_sf</span>(o)), km<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb219-2" title="2">o<span class="op">$</span>sum_km =<span class="st"> </span>o<span class="op">$</span>sum <span class="op">/</span><span class="st"> </span>a</a>
<a class="sourceLine" id="cb219-3" title="3">d<span class="op">$</span>sum_km =<span class="st"> </span>d<span class="op">$</span>sum <span class="op">/</span><span class="st"> </span>a</a>
<a class="sourceLine" id="cb219-4" title="4">od =<span class="st"> </span><span class="kw">c</span>(o[<span class="st">&quot;sum_km&quot;</span>], d[<span class="st">&quot;sum_km&quot;</span>], <span class="dt">along =</span> <span class="kw">list</span>(<span class="dt">od =</span> <span class="kw">c</span>(<span class="st">&quot;origin&quot;</span>, <span class="st">&quot;destination&quot;</span>)))</a>
<a class="sourceLine" id="cb219-5" title="5"><span class="kw">plot</span>(od, <span class="dt">logz =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:odbykm"></span>
<img src="sds_files/figure-html/odbykm-1.png" alt="total commutes per square km, by area of origin (left) or destination (right)" width="672" />
<p class="caption">
Figure 7.17: total commutes per square km, by area of origin (left) or destination (right)
</p>
</div>
<p>shown in figure <a href="sf.html#fig:odbykm">7.17</a>. Another way to normalize these
totals would be to divide them by population size.</p>
</div>
<div id="tidy-array-data" class="section level3">
<h3><span class="header-section-number">7.4.3</span> Tidy array data</h3>
<p>The <em>tidy data</em> paper <span class="citation">(Wickham <a href="#ref-tidy">2014</a><a href="#ref-tidy">b</a>)</span> may suggest that such array data
should be processed not as an array, but in a long table where
each row holds (region, class, year, value), and it is always good
to be able to do this. For primary handling and storage however,
this is often not an option, because</p>
<ul>
<li>a lot of array data are collected or generated as array data, e.g.
by imagery or other sensory devices, or e.g. by climate models</li>
<li>it is easier to derive the long table form from the array than
vice versa</li>
<li>the long table form requires much more memory, since the space
occupied by dimension values is <span class="math inline">\(O(nmp)\)</span>, rather than <span class="math inline">\(O(n+m+p)\)</span></li>
<li>when missing-valued cells are dropped, the long table form loses
the implicit indexing of the array form</li>
</ul>
<p>To put this argument to the extreme, consider for instance that
all image, video and sound data are stored in array form; few
people would make a real case for storing them in a long table
form instead. Nevertheless, R packages like <code>tsibble</code> take this
approach, and have to deal with ambiguous ordering of multiple records
with identical time steps for different spatial features and index
them, which is solved for both <em>automatically</em> by using the array
form – at the cost of using dense arrays, in package <code>stars</code>.</p>
<p>Package <code>stars</code> tries to follow the <a href="https://cran.r-project.org/web/packages/tidyverse/vignettes/manifesto.html">tidy
manifesto</a>
to handle array sets, and has particularly developed support for the
case where one or more of the dimensions refer to space, and/or time.</p>
</div>
</div>
<div id="raster-to-vector" class="section level2">
<h2><span class="header-section-number">7.5</span> raster-to-vector, vector-to-raster</h2>
<p>Section <a href="intro.html#rasterize">1.3</a> already showed some examples of
raster-to-vector and vector-to-raster conversions, this section
will add some code details and examples.</p>
<div id="vector-to-raster" class="section level3">
<h3><span class="header-section-number">7.5.1</span> vector-to-raster</h3>
<p><code>st_as_stars</code> is meant as a method to transform objects into <code>stars</code>
objects. However, not all stars objects are <code>raster</code> objects,
and the method for <code>sf</code> objects creates a vector data cube with
the geometry as its spatial (vector) dimension, and attributes
as attributes. When given a feature <em>geometry</em> (<code>sfc</code>) object,
<code>st_as_stars</code> will rasterize it, as shown in section <a href="sf.html#warp">7.7</a>,
and in figure <a href="sf.html#fig:asstars">7.18</a>.</p>

<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb220-1" title="1"><span class="kw">sf_use_s2</span>(<span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb220-2" title="2">(<span class="dt">file =</span> <span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>))</a></code></pre></div>
<pre><code># [1] &quot;/home/edzer/R/x86_64-pc-linux-gnu-library/4.0/sf/gpkg/nc.gpkg&quot;</code></pre>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb222-1" title="1"><span class="kw">read_sf</span>(file) <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span></a>
<a class="sourceLine" id="cb222-2" title="2"><span class="st">    </span><span class="kw">st_geometry</span>() <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb222-3" title="3"><span class="st">    </span><span class="kw">st_as_stars</span>() <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb222-4" title="4"><span class="st">    </span><span class="kw">plot</span>()</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:asstars"></span>
<img src="sds_files/figure-html/asstars-1.png" alt="rasterizing vector geometry using st_as_stars" width="672" />
<p class="caption">
Figure 7.18: rasterizing vector geometry using <code>st_as_stars</code>
</p>
</div>
<p>Here, <code>st_as_stars</code> can be parameterized to control cell size,
number of cells, and/or extent. The cell values returned are 0 for
cells with center point outside the geometry and 1 for cell with
center point inside or on the border of the geometry. Rasterizing
existing features is done using <code>st_rasterize</code>, as also shown in
figure <a href="intro.html#fig:vectoras">1.4</a>:</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb223-1" title="1"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb223-2" title="2"><span class="kw">read_sf</span>(file) <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb223-3" title="3"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="kw">as.factor</span>(NAME)) <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb223-4" title="4"><span class="st">    </span><span class="kw">select</span>(SID74, SID79, name) <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb223-5" title="5"><span class="st">    </span><span class="kw">st_rasterize</span>()</a></code></pre></div>
<pre><code># stars object with 2 dimensions and 1 attribute
# attribute(s):
#      SID74      
#  Min.   : 0     
#  1st Qu.: 3     
#  Median : 5     
#  Mean   : 8     
#  3rd Qu.:10     
#  Max.   :44     
#  NA&#39;s   :30904  
# dimension(s):
#   from  to   offset      delta refsys point values x/y
# x    1 461 -84.3239  0.0192484  NAD27 FALSE   NULL [x]
# y    1 141  36.5896 -0.0192484  NAD27 FALSE   NULL [y]</code></pre>
<p>Similarly, line and point geometries can be rasterized, as shown
in figure <a href="sf.html#fig:lineras">7.19</a>.</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb225-1" title="1"><span class="kw">read_sf</span>(file) <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb225-2" title="2"><span class="st">    </span><span class="kw">st_cast</span>(<span class="st">&quot;MULTILINESTRING&quot;</span>) <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb225-3" title="3"><span class="st">    </span><span class="kw">select</span>(CNTY_ID) <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb225-4" title="4"><span class="st">    </span><span class="kw">st_rasterize</span>() <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb225-5" title="5"><span class="st">    </span><span class="kw">plot</span>()</a></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:lineras"></span>
<img src="sds_files/figure-html/lineras-1.png" alt="rasterization of North Carolina boundaries" width="672" />
<p class="caption">
Figure 7.19: rasterization of North Carolina boundaries
</p>
</div>
</div>
</div>
<div id="projsf" class="section level2">
<h2><span class="header-section-number">7.6</span> Coordinate transformations and conversions</h2>
<div id="st_crs" class="section level3">
<h3><span class="header-section-number">7.6.1</span> <code>st_crs</code></h3>
<p>Spatial objects of class <code>sf</code> or <code>stars</code> contain a coordinate
reference system that can be get or replaced with <code>st_crs</code>, or be
set or replaced in a pipe with <code>st_set_crs</code>. Coordinate reference
systems can be set with an EPSG code, like <code>st_crs(4326)</code> which
will be converted to <code>st_crs('EPSG:4326')</code>, or with a PROJ.4 string
like <code>""+proj=utm +zone=25 +south"</code>, a name like “WGS84”, or a name
preceded by an authority like “OGC:CRS84”; alternatives include
a coordinate reference system definition in WKT, WKT2 (section
<a href="cs.html#wkt2">2.5</a>) or PROJJSON.</p>
<p>The object returned contains two fields, <code>wkt</code> with the WKT2
representation, and <code>input</code> with the user input, if any, or else
a copy of the wkt field. Note that PROJ.4 strings can be used to
<em>define</em> some coordinate reference systems, but they cannot be used
to <em>represent</em> coordinate reference systems. Conversion of a
WKT2 in a <code>crs</code> object to a proj4string using the <code>$proj4string</code>
method, as in</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb226-1" title="1">x =<span class="st"> </span><span class="kw">st_crs</span>(<span class="st">&quot;OGC:CRS84&quot;</span>)</a>
<a class="sourceLine" id="cb226-2" title="2">x<span class="op">$</span>proj4string</a></code></pre></div>
<pre><code># [1] &quot;+proj=longlat +datum=WGS84 +no_defs&quot;</code></pre>
<p>may succeed but is not in general lossless or invertible.</p>
</div>
<div id="st_transform-sf_project" class="section level3">
<h3><span class="header-section-number">7.6.2</span> <code>st_transform</code>, <code>sf_project</code></h3>
<p>Coordinate transformations or conversions (section <a href="intro.html#proj">1.7.2</a>)
for <code>sf</code> or <code>stars</code> objects are carried out with <code>st_transform</code>,
which takes as its first argument a spatial object of class <code>sf</code> or
<code>stars</code> that has a coordinate reference system set, and as a second
argument with an <code>crs</code> object (or something that can be converted
to it with <code>st_crs</code>). When PROJ finds more than one possibility
to transform or convert from the source <code>crs</code> to the target <code>crs</code>,
it chooses the one with the highest declared accuracy. More fine-grained
control over the options is explained in section <a href="sf.html#pipelines">7.6.5</a>.</p>
<p>A lower-level function to transform or convert coordinates <em>not</em>
in <code>sf</code> or <code>stars</code> objects is <code>sf_project</code>: it takes a matrix with
coordinates and a source and target <code>crs</code>, and returns transformed
or converted coordinates.</p>
</div>
<div id="sf_proj_info" class="section level3">
<h3><span class="header-section-number">7.6.3</span> <code>sf_proj_info</code></h3>
<p>Function <code>sf_proj_info</code> can be used to query available projections,
ellipsoids, units and prime meridians available in the PROJ
software. It takes a single parameter, <code>type</code>, which can have the
following values:</p>
<ul>
<li><code>type = "proj"</code> lists the short and long names of available
projections; short names can be used in a “+proj=name” string.</li>
<li><code>type = "ellps"</code> lists available ellipses, with name, long name,
and ellipsoidal parameters.</li>
<li><code>type = "units"</code> lists the available length units, with conversion
constant to meters</li>
<li><code>type = "prime_meridians"</code> lists the prime meridians with their
position with respect to the Greenwich meridian.</li>
</ul>
</div>
<div id="proj.db-datum-grids-cdn.proj.org-local-cache" class="section level3">
<h3><span class="header-section-number">7.6.4</span> proj.db, datum grids, cdn.proj.org, local cache</h3>
<p>Datum grids (section <a href="intro.html#proj">1.7.2</a>) can be installed locally, or
be read from the PROJ datum grid CDN at <a href="https://cdn.proj.org/" class="uri">https://cdn.proj.org/</a>. If
installed locally, they are read from the PROJ search path, which
is shown by</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb228-1" title="1"><span class="kw">sf_proj_search_paths</span>()</a></code></pre></div>
<pre><code># [1] &quot;/home/edzer/.local/share/proj&quot; &quot;/usr/share/proj&quot;</code></pre>
<p>The main PROJ database is <code>proj.db</code>, an sqlite3 database typically
found at</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb230-1" title="1"><span class="kw">paste0</span>(<span class="kw">tail</span>(<span class="kw">sf_proj_search_paths</span>(), <span class="dv">1</span>), .Platform<span class="op">$</span>file.sep, <span class="st">&quot;proj.db&quot;</span>)</a></code></pre></div>
<pre><code># [1] &quot;/usr/share/proj/proj.db&quot;</code></pre>
<p>which can be read. The version of the snapshot of the EPSG database
included in each PROJ release is stated in the <code>"metadata"</code> table of
<code>proj.db</code>; the version of the PROJ runtime used by <strong>sf</strong> is shown by</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb232-1" title="1"><span class="kw">sf_extSoftVersion</span>()[<span class="st">&quot;PROJ&quot;</span>]</a></code></pre></div>
<pre><code># &lt;NA&gt; 
#   NA</code></pre>
<p>If for a particular coordinate transformation datum grids are not
locally found, PROJ will search for online datum grids in the PROJ
CDN when</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb234-1" title="1"><span class="kw">sf_proj_network</span>()</a></code></pre></div>
<pre><code># [1] FALSE</code></pre>
<p>returns <code>TRUE</code>. By default it is set to <code>FALSE</code>, but</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb236-1" title="1"><span class="kw">sf_proj_network</span>(<span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code># [1] &quot;https://cdn.proj.org&quot;</code></pre>
<p>sets it to <code>TRUE</code> and returns the URL of the network resource used;
this resource can also be set to another resource, that may be
faster or less limited.</p>
<p>After querying a datum grid on the CDN, PROJ writes the <em>portion</em> of
the grid queried (not, by default, the entire grid) to a local cache,
which is another sqlite3 database found locally in a user directory,
e.g. at</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb238-1" title="1"><span class="kw">list.files</span>(<span class="kw">sf_proj_search_paths</span>()[<span class="dv">1</span>], <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code># [1] &quot;/home/edzer/.local/share/proj/cache.db&quot;</code></pre>
<p>that will be searched first in subsequent datum grid queries.</p>
</div>
<div id="pipelines" class="section level3">
<h3><span class="header-section-number">7.6.5</span> transformation pipelines</h3>
<p>Internally, PROJ uses a so-called <em>coordinate operation pipeline</em>,
to represent the sequence of operations to get from a source CRS to
a target CRS. Given multiple options to go from source to target,
<code>st_transform</code> chooses the one with highest accuracy. We can query
the options available by</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb240-1" title="1">(<span class="dt">p =</span> <span class="kw">sf_proj_pipelines</span>(<span class="st">&quot;EPSG:4326&quot;</span>, <span class="st">&quot;EPSG:22525&quot;</span>))</a></code></pre></div>
<pre><code># Candidate coordinate operations found:  5 
# Strict containment:     FALSE 
# Axis order auth compl:  FALSE 
# Source:  EPSG:4326 
# Target:  EPSG:22525 
# Best instantiable operation has accuracy: 2 m
# Description: axis order change (2D) + Inverse of Corrego Alegre 1970-72 to
#              WGS 84 (2) + UTM zone 25S
# Definition:  +proj=pipeline +step +proj=unitconvert +xy_in=deg +xy_out=rad
#              +step +inv +proj=hgridshift
#              +grids=br_ibge_CA7072_003.tif +step +proj=utm
#              +zone=25 +south +ellps=intl</code></pre>
<p>and see that pipeline with the highest accuracy is summarised; we
can see that it specifies use of a datum grid. Had we not switched
on the network search, we would have obtained a different result:</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb242-1" title="1"><span class="kw">sf_proj_network</span>(<span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code># character(0)</code></pre>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb244-1" title="1"><span class="kw">sf_proj_pipelines</span>(<span class="st">&quot;EPSG:4326&quot;</span>, <span class="st">&quot;EPSG:22525&quot;</span>)</a></code></pre></div>
<pre><code># Candidate coordinate operations found:  5 
# Strict containment:     FALSE 
# Axis order auth compl:  FALSE 
# Source:  EPSG:4326 
# Target:  EPSG:22525 
# Best instantiable operation has accuracy: 5 m
# Description: axis order change (2D) + Inverse of Corrego Alegre 1970-72 to
#              WGS 84 (4) + UTM zone 25S
# Definition:  +proj=pipeline +step +proj=unitconvert +xy_in=deg +xy_out=rad
#              +step +proj=push +v_3 +step +proj=cart
#              +ellps=WGS84 +step +proj=helmert +x=206.05
#              +y=-168.28 +z=3.82 +step +inv +proj=cart
#              +ellps=intl +step +proj=pop +v_3 +step +proj=utm
#              +zone=25 +south +ellps=intl
# Operation 4 is lacking 1 grid with accuracy 2 m
# Missing grid: br_ibge_CA7072_003.tif 
# URL: https://cdn.proj.org/br_ibge_CA7072_003.tif</code></pre>
<p>and a report that a datum grid is missing
The object returned by <code>sf_proj_pipelines</code> is a sub-classed <code>data.frame</code>, with columns</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb246-1" title="1"><span class="kw">names</span>(p)</a></code></pre></div>
<pre><code># [1] &quot;id&quot;           &quot;description&quot;  &quot;definition&quot;   &quot;has_inverse&quot;  &quot;accuracy&quot;    
# [6] &quot;axis_order&quot;   &quot;grid_count&quot;   &quot;instantiable&quot; &quot;containment&quot;</code></pre>
<p>and we can list for instance the accuracies by</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb248-1" title="1">p<span class="op">$</span>accuracy</a></code></pre></div>
<pre><code># [1]  5  5  8  2 NA</code></pre>
<p>Here, <code>NA</code> refers to “ballpark accuracy”, which may be anything in the
30-100 m range:</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb250-1" title="1">p[<span class="kw">is.na</span>(p<span class="op">$</span>accuracy),]</a></code></pre></div>
<pre><code># Candidate coordinate operations found:  1 
# Strict containment:     FALSE 
# Axis order auth compl:  FALSE 
# Source:  EPSG:4326 
# Target:  EPSG:22525 
# Best instantiable operation has only ballpark accuracy 
# Description: axis order change (2D) + Ballpark geographic offset from WGS 84
#              to Corrego Alegre 1970-72 + UTM zone 25S
# Definition:  +proj=pipeline +step +proj=unitconvert +xy_in=deg +xy_out=rad
#              +step +proj=utm +zone=25 +south +ellps=intl</code></pre>
<p>The default, most accurate pipeline chosen by <code>st_transform</code> can
be overriden by specifying <code>pipeline</code> argument, as selected from
the set of options in <code>p$definition</code>.</p>
</div>
</div>
<div id="warp" class="section level2">
<h2><span class="header-section-number">7.7</span> transforming and warping rasters</h2>
<p>When using <code>st_transform</code> on a raster data set, as e.g. in</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb252-1" title="1">tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</a>
<a class="sourceLine" id="cb252-2" title="2"><span class="kw">read_stars</span>(tif) <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb252-3" title="3"><span class="st">    </span><span class="kw">st_transform</span>(<span class="dv">4326</span>)</a></code></pre></div>
<pre><code># stars object with 3 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif   
#  Min.   :  1.0  
#  1st Qu.: 54.0  
#  Median : 69.0  
#  Mean   : 68.9  
#  3rd Qu.: 86.0  
#  Max.   :255.0  
# dimension(s):
#      from  to offset delta refsys point                          values x/y
# x       1 349     NA    NA WGS 84 FALSE [349x352] -34.9165,...,-34.8261 [x]
# y       1 352     NA    NA WGS 84 FALSE  [349x352] -8.0408,...,-7.94995 [y]
# band    1   6     NA    NA     NA    NA                            NULL    
# curvilinear grid</code></pre>
<p>we see that a <em>curvilinear</em> is created, which means that for every
grid cell the coordinates are computed in the new CRS, which no
longer form a <em>regular</em> grid. Plotting such data is extremely slow,
as small polygons are computed for every grid cell and then plotted.
The advantage of this is that no information is lost: grid cell
values remain identical after the projection.</p>
<p>When we start with a raster on a regular grid and want to obtain
a <em>regular</em> grid in a new coordinate reference system, we need
to <em>warp</em> the grid: we need to recreate a grid at new locations,
and use some rule to assign values to new grid cells. Rules can
involve using the nearest value, or using some form of interpolation.
This operation is not lossless and not invertible.</p>
<p>The best options for warping is to specify the target grid as a
<code>stars</code> object. When only a target CRS is specified, default options
for the target grid are picked that may be completely inappropriate
for the problem at hand. An example workflow that uses only a
target CRS is</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb254-1" title="1"><span class="kw">read_stars</span>(tif) <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb254-2" title="2"><span class="st">    </span><span class="kw">st_warp</span>(<span class="dt">crs =</span> <span class="kw">st_crs</span>(<span class="dv">4326</span>)) <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb254-3" title="3"><span class="st">    </span><span class="kw">st_dimensions</span>()</a></code></pre></div>
<pre><code>#      from  to   offset        delta refsys point values x/y
# x       1 350 -34.9166  0.000259243 WGS 84    NA   NULL [x]
# y       1 352 -7.94982 -0.000259243 WGS 84    NA   NULL [y]
# band    1   6       NA           NA     NA    NA   NULL</code></pre>
<p>which creates a pretty close raster, but then the transformation
is also relatively modest. For a workflow that creates a target
raster first, here with exactly the same number of rows and columns
as the original raster one could use:</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb256-1" title="1">r =<span class="st"> </span><span class="kw">read_stars</span>(tif)</a>
<a class="sourceLine" id="cb256-2" title="2">grd =<span class="st"> </span><span class="kw">st_bbox</span>(r) <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb256-3" title="3"><span class="st">        </span><span class="kw">st_as_sfc</span>() <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb256-4" title="4"><span class="st">        </span><span class="kw">st_transform</span>(<span class="dv">4326</span>) <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb256-5" title="5"><span class="st">        </span><span class="kw">st_bbox</span>() <span class="op">|</span><span class="er">&gt;</span></a>
<a class="sourceLine" id="cb256-6" title="6"><span class="st">        </span><span class="kw">st_as_stars</span>(<span class="dt">nx =</span> <span class="kw">dim</span>(r)[<span class="st">&quot;x&quot;</span>], <span class="dt">ny =</span> <span class="kw">dim</span>(r)[<span class="st">&quot;y&quot;</span>])</a>
<a class="sourceLine" id="cb256-7" title="7"><span class="kw">st_warp</span>(r, grd)</a></code></pre></div>
<pre><code># stars object with 3 dimensions and 1 attribute
# attribute(s):
#   L7_ETMs.tif  
#  Min.   :  1   
#  1st Qu.: 54   
#  Median : 69   
#  Mean   : 69   
#  3rd Qu.: 86   
#  Max.   :255   
#  NA&#39;s   :6180  
# dimension(s):
#      from  to   offset        delta refsys point values x/y
# x       1 349 -34.9166  0.000259666 WGS 84    NA   NULL [x]
# y       1 352 -7.94982 -0.000258821 WGS 84    NA   NULL [y]
# band    1   6       NA           NA     NA    NA   NULL</code></pre>
</div>
<div id="exercises-6" class="section level2">
<h2><span class="header-section-number">7.8</span> Exercises</h2>
<ol style="list-style-type: decimal">
<li>NDVI, normalized differenced vegetation index, is coputed as (NIR-R)/(NIR+R), with NIR the near infrared and R the red band. Read the <code>L7_ETMs.tif</code> file into object <code>x</code>, and distribute the band dimensions over attributes by <code>split(x, "band")</code>. Then, compute NDVI by using an expression that uses the NIR (band 4) and R (band 3) attributes directly.</li>
<li>Compute NDVI for the S2 image, using <code>st_apply</code> and an a function <code>ndvi = function(x) (x[4]-x[3])/(x[4]+x[3])</code>. Plot the result, and write the result to a GeoTIFF. Explain the difference in runtime between plotting and writing.</li>
<li>Use <code>st_transform</code> to transform the <code>stars</code> object read from <code>L7_ETMs.tif</code> to EPSG 4326. Print the object. Is this a regular grid? Plot the first band using arguments <code>axes=TRUE</code> and <code>border=NA</code>, and explain why this takes such a long time.</li>
<li>Use <code>st_warp</code> to warp the <code>L7_ETMs.tif</code> object to EPSG 4326, and plot the resulting object with <code>axes=TRUE</code>. Why is the plot created much faster than after <code>st_transform</code>?</li>
</ol>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-eddelbuettel2013seamless">
<p>Eddelbuettel, Dirk. 2013. <em>Seamless R and C++ Integration with Rcpp</em>. Springer.</p>
</div>
<div id="ref-herring2011opengis">
<p>Herring, John, and others. 2011. “Opengis Implementation Standard for Geographic Information-Simple Feature Access-Part 1: Common Architecture [Corrigendum].”</p>
</div>
<div id="ref-R-raster">
<p>Hijmans, Robert J. 2021a. <em>Raster: Geographic Data Analysis and Modeling</em>. <a href="https://rspatial.org/raster">https://rspatial.org/raster</a>.</p>
</div>
<div id="ref-R-terra">
<p>Hijmans, Robert J. 2021b. <em>Terra: Spatial Data Analysis</em>. <a href="https://rspatial.org/terra">https://rspatial.org/terra</a>.</p>
</div>
<div id="ref-geocomp">
<p>Lovelace, Robin, Jakub Nowosad, and Jannes Muenchow. 2019. <em>Geocomputation with R</em>. Chapman; Hall/CRC. <a href=" https://geocompr.robinlovelace.net/ ">https://geocompr.robinlovelace.net/</a>.</p>
</div>
<div id="ref-spacetime2012">
<p>Pebesma, Edzer. 2012. “spacetime: Spatio-Temporal Data in R.” <em>Journal of Statistical Software</em> 51 (7): 1–30. <a href="https://www.jstatsoft.org/v51/i07/">https://www.jstatsoft.org/v51/i07/</a>.</p>
</div>
<div id="ref-rjsf">
<p>Pebesma, Edzer. 2018. “Simple Features for R: Standardized Support for Spatial Vector Data.” <em>The R Journal</em> 10 (1): 439–46. <a href="https://doi.org/10.32614/RJ-2018-009">https://doi.org/10.32614/RJ-2018-009</a>.</p>
</div>
<div id="ref-R-abind">
<p>Plate, Tony, and Richard Heiberger. 2016. <em>Abind: Combine Multidimensional Arrays</em>. <a href="https://CRAN.R-project.org/package=abind">https://CRAN.R-project.org/package=abind</a>.</p>
</div>
<div id="ref-tidy">
<p>Wickham, Hadley. 2014b. “Tidy Data.” <em>Journal of Statistical Software</em> 59 (1). <a href=" https://www.jstatsoft.org/article/view/v059i10 ">https://www.jstatsoft.org/article/view/v059i10</a>.</p>
</div>
<div id="ref-welcome">
<p>Wickham, Hadley, Mara Averick, Jennifer Bryan, Winston Chang, Lucy D’Agostino McGowan, Romain François, Garrett Grolemund, et al. 2019. “Welcome to the Tidyverse.” <em>Journal of Open Source Software</em> 4 (43): 1686.</p>
</div>
<div id="ref-r4ds">
<p>Wickham, Hadley, and Garret Grolemund. 2017. <em>R for Data Science</em>. O’Reilly. <a href="http://r4ds.had.co.nz/">http://r4ds.had.co.nz/</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="datacube.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="large.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/edzer/sdsr/edit/master/07-Introsf.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
