<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Plotting spatial data | Spatial Data Science</title>
  <meta name="description" content="description_xx" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Plotting spatial data | Spatial Data Science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="description_xx" />
  <meta name="github-repo" content="edzer/sdsr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Plotting spatial data | Spatial Data Science" />
  
  <meta name="twitter:description" content="description_xx" />
  

<meta name="author" content="Edzer Pebesma, Roger Bivand" />


<meta name="date" content="2022-02-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="large.html"/>
<link rel="next" href="statistical-modelling-of-spatial-data.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />

<script>
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan');
  rCodeBlocks.each(function() {

    // if code block has been labeled with class `fold-show`, show the code on init!
    var classList = $(this).attr('class').split(/\s+/);
    for (var i = 0; i < classList.length; i++) {
    if (classList[i] === 'fold-show') {
        show = true;
      }
    }

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // hack: return show to false, otherwise all next codeBlocks will be shown!
    show = false;

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<script>
/* ========================================================================
 * Bootstrap: dropdown.js v3.3.7
 * http://getbootstrap.com/javascript/#dropdowns
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // DROPDOWN CLASS DEFINITION
  // =========================

  var backdrop = '.dropdown-backdrop'
  var toggle   = '[data-toggle="dropdown"]'
  var Dropdown = function (element) {
    $(element).on('click.bs.dropdown', this.toggle)
  }

  Dropdown.VERSION = '3.3.7'

  function getParent($this) {
    var selector = $this.attr('data-target')

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7
    }

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  }

  function clearMenus(e) {
    if (e && e.which === 3) return
    $(backdrop).remove()
    $(toggle).each(function () {
      var $this         = $(this)
      var $parent       = getParent($this)
      var relatedTarget = { relatedTarget: this }

      if (!$parent.hasClass('open')) return

      if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

      $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this.attr('aria-expanded', 'false')
      $parent.removeClass('open').trigger($.Event('hidden.bs.dropdown', relatedTarget))
    })
  }

  Dropdown.prototype.toggle = function (e) {
    var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    clearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $(document.createElement('div'))
          .addClass('dropdown-backdrop')
          .insertAfter($(this))
          .on('click', clearMenus)
      }

      var relatedTarget = { relatedTarget: this }
      $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this
        .trigger('focus')
        .attr('aria-expanded', 'true')

      $parent
        .toggleClass('open')
        .trigger($.Event('shown.bs.dropdown', relatedTarget))
    }

    return false
  }

  Dropdown.prototype.keydown = function (e) {
    if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName)) return

    var $this = $(this)

    e.preventDefault()
    e.stopPropagation()

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    if (!isActive && e.which != 27 || isActive && e.which == 27) {
      if (e.which == 27) $parent.find(toggle).trigger('focus')
      return $this.trigger('click')
    }

    var desc = ' li:not(.disabled):visible a'
    var $items = $parent.find('.dropdown-menu' + desc)

    if (!$items.length) return

    var index = $items.index(e.target)

    if (e.which == 38 && index > 0)                 index--         // up
    if (e.which == 40 && index < $items.length - 1) index++         // down
    if (!~index)                                    index = 0

    $items.eq(index).trigger('focus')
  }


  // DROPDOWN PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this = $(this)
      var data  = $this.data('bs.dropdown')

      if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  var old = $.fn.dropdown

  $.fn.dropdown             = Plugin
  $.fn.dropdown.Constructor = Dropdown


  // DROPDOWN NO CONFLICT
  // ====================

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  // APPLY TO STANDARD DROPDOWN ELEMENTS
  // ===================================

  $(document)
    .on('click.bs.dropdown.data-api', clearMenus)
    .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
    .on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown)
    .on('keydown.bs.dropdown.data-api', '.dropdown-menu', Dropdown.prototype.keydown)

}(jQuery);
</script>
<style type="text/css">
.code-folding-btn {
  margin-bottom: 4px;
}

.row { display: flex; }
.collapse { display: none; }
.in { display:block }
.pull-right > .dropdown-menu {
    right: 0;
    left: auto;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    font-size: 14px;
    text-align: left;
    list-style: none;
    background-color: #fff;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    border: 1px solid #ccc;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
    box-shadow: 0 6px 12px rgba(0,0,0,.175);
}

.open > .dropdown-menu {
    display: block;
    color: #ffffff;
    background-color: #ffffff;
    background-image: none;
    border-color: #92897e;
}

.dropdown-menu > li > a {
  display: block;
  padding: 3px 20px;
  clear: both;
  font-weight: 400;
  line-height: 1.42857143;
  color: #000000;
  white-space: nowrap;
}

.dropdown-menu > li > a:hover,
.dropdown-menu > li > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
}

.dropdown-menu > .active > a,
.dropdown-menu > .active > a:hover,
.dropdown-menu > .active > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
  outline: 0;
}
.dropdown-menu > .disabled > a,
.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  color: #aea79f;
}

.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  text-decoration: none;
  cursor: not-allowed;
  background-color: transparent;
  background-image: none;
  filter: progid:DXImageTransform.Microsoft.gradient(enabled = false);
}

.btn {
  display: inline-block;
  margin-bottom: 1;
  font-weight: normal;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  -ms-touch-action: manipulation;
      touch-action: manipulation;
  cursor: pointer;
  background-image: none;
  border: 1px solid transparent;
  padding: 4px 8px;
  font-size: 14px;
  line-height: 1.42857143;
  border-radius: 4px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.btn:focus,
.btn:active:focus,
.btn.active:focus,
.btn.focus,
.btn:active.focus,
.btn.active.focus {
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px;
}
.btn:hover,
.btn:focus,
.btn.focus {
  color: #ffffff;
  text-decoration: none;
}
.btn:active,
.btn.active {
  background-image: none;
  outline: 0;
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn.disabled,
.btn[disabled],
fieldset[disabled] .btn {
  cursor: not-allowed;
  filter: alpha(opacity=65);
  opacity: 0.65;
  box-shadow: none;
}
a.btn.disabled,
fieldset[disabled] a.btn {
  pointer-events: none;
}
.btn-default {
  color: #ffffff;
  background-color: #aea79f; #important
  border-color: #aea79f;
}

.btn-default:focus,
.btn-default.focus {
  color: #ffffff;
  background-color: #978e83;
  border-color: #6f675e;
}

.btn-default:hover {
  color: #ffffff;
  background-color: #978e83;
  border-color: #92897e;
}
.btn-default:active,
.btn-default.active,
.btn-group > .btn:not(:first-child):not(:last-child):not(.dropdown-toggle) {
  border-radius: 0;
}
.btn-group > .btn:first-child {
  margin-left: 0;
}
.btn-group > .btn:first-child:not(:last-child):not(.dropdown-toggle) {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn:last-child:not(:first-child),
.btn-group > .dropdown-toggle:not(:first-child) {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group > .btn-group {
  float: left;
}
.btn-group > .btn-group:not(:first-child):not(:last-child) > .btn {
  border-radius: 0;
}
.btn-group > .btn-group:first-child:not(:last-child) > .btn:last-child,
.btn-group > .btn-group:first-child:not(:last-child) > .dropdown-toggle {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn-group:last-child:not(:first-child) > .btn:first-child {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group .dropdown-toggle:active,
.btn-group.open .dropdown-toggle {
  outline: 0;
}
.btn-group > .btn + .dropdown-toggle {
  padding-right: 8px;
  padding-left: 8px;
}
.btn-group > .btn-lg + .dropdown-toggle {
  padding-right: 12px;
  padding-left: 12px;
}
.btn-group.open .dropdown-toggle {
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn-group.open .dropdown-toggle.btn-link {
  box-shadow: none;
}

</style>
<script>
var str = '<div class="btn-group pull-right" style="position: fixed; right: 50px; top: 10px; z-index: 200"><button type="button" class="btn btn-default btn-xs dropdown-toggle" id="allCodeButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast=""><span>Code</span> <span class="caret"></span></button><ul class="dropdown-menu" style="min-width: 50px;"><li><a id="rmd-show-all-code" href="#">Show All Code</a></li><li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li></ul></div>';
document.write(str);
</script>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatial Data Science</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="part"><span><b>I Spatial Data</b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Getting Started</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#a-first-map"><i class="fa fa-check"></i><b>1.1</b> A first map</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#coordinate-reference-systems"><i class="fa fa-check"></i><b>1.2</b> Coordinate reference systems</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#rasterize"><i class="fa fa-check"></i><b>1.3</b> Raster and vector data</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#raster-types"><i class="fa fa-check"></i><b>1.4</b> Raster types</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#time-series-arrays-data-cubes"><i class="fa fa-check"></i><b>1.5</b> Time series, arrays, data cubes</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#support"><i class="fa fa-check"></i><b>1.6</b> Support</a></li>
<li class="chapter" data-level="1.7" data-path="intro.html"><a href="intro.html#spatial-data-science-software"><i class="fa fa-check"></i><b>1.7</b> Spatial data science software</a></li>
<li class="chapter" data-level="1.8" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>1.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cs.html"><a href="cs.html"><i class="fa fa-check"></i><b>2</b> Coordinates</a><ul>
<li class="chapter" data-level="2.1" data-path="cs.html"><a href="cs.html#units"><i class="fa fa-check"></i><b>2.1</b> Quantities, units, datum</a></li>
<li class="chapter" data-level="2.2" data-path="cs.html"><a href="cs.html#ellipsoidal-coordinates"><i class="fa fa-check"></i><b>2.2</b> Ellipsoidal coordinates</a></li>
<li class="chapter" data-level="2.3" data-path="cs.html"><a href="cs.html#crs"><i class="fa fa-check"></i><b>2.3</b> Coordinate Reference Systems</a></li>
<li class="chapter" data-level="2.4" data-path="cs.html"><a href="cs.html#projlib"><i class="fa fa-check"></i><b>2.4</b> PROJ and mapping accuracy</a></li>
<li class="chapter" data-level="2.5" data-path="cs.html"><a href="cs.html#wkt2"><i class="fa fa-check"></i><b>2.5</b> WKT-2</a></li>
<li class="chapter" data-level="2.6" data-path="cs.html"><a href="cs.html#exercises-1"><i class="fa fa-check"></i><b>2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="geometries.html"><a href="geometries.html"><i class="fa fa-check"></i><b>3</b> Geometries</a><ul>
<li class="chapter" data-level="3.1" data-path="geometries.html"><a href="geometries.html#simplefeatures"><i class="fa fa-check"></i><b>3.1</b> Simple feature geometries</a></li>
<li class="chapter" data-level="3.2" data-path="geometries.html"><a href="geometries.html#opgeom"><i class="fa fa-check"></i><b>3.2</b> Operations on geometries</a></li>
<li class="chapter" data-level="3.3" data-path="geometries.html"><a href="geometries.html#precision"><i class="fa fa-check"></i><b>3.3</b> Precision</a></li>
<li class="chapter" data-level="3.4" data-path="geometries.html"><a href="geometries.html#coverages"><i class="fa fa-check"></i><b>3.4</b> Coverages: tessellations and rasters</a></li>
<li class="chapter" data-level="3.5" data-path="geometries.html"><a href="geometries.html#networks"><i class="fa fa-check"></i><b>3.5</b> Networks</a></li>
<li class="chapter" data-level="3.6" data-path="geometries.html"><a href="geometries.html#exercises-2"><i class="fa fa-check"></i><b>3.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spherical.html"><a href="spherical.html"><i class="fa fa-check"></i><b>4</b> Spherical Geometries</a><ul>
<li class="chapter" data-level="4.1" data-path="spherical.html"><a href="spherical.html#straight-lines"><i class="fa fa-check"></i><b>4.1</b> Straight lines</a></li>
<li class="chapter" data-level="4.2" data-path="spherical.html"><a href="spherical.html#ring-direction"><i class="fa fa-check"></i><b>4.2</b> Ring direction</a></li>
<li class="chapter" data-level="4.3" data-path="spherical.html"><a href="spherical.html#full-polygon"><i class="fa fa-check"></i><b>4.3</b> Full polygon</a></li>
<li class="chapter" data-level="4.4" data-path="spherical.html"><a href="spherical.html#bounding-box-rectangle-and-cap"><i class="fa fa-check"></i><b>4.4</b> Bounding box, rectangle, and cap</a></li>
<li class="chapter" data-level="4.5" data-path="spherical.html"><a href="spherical.html#validity-on-the-sphere"><i class="fa fa-check"></i><b>4.5</b> Validity on the sphere</a></li>
<li class="chapter" data-level="4.6" data-path="spherical.html"><a href="spherical.html#exercises-3"><i class="fa fa-check"></i><b>4.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="featureattributes.html"><a href="featureattributes.html"><i class="fa fa-check"></i><b>5</b> Attributes and Support</a><ul>
<li class="chapter" data-level="5.1" data-path="featureattributes.html"><a href="featureattributes.html#agr"><i class="fa fa-check"></i><b>5.1</b> Attribute-geometry relationships and support</a></li>
<li class="chapter" data-level="5.2" data-path="featureattributes.html"><a href="featureattributes.html#aggregating-and-summarising"><i class="fa fa-check"></i><b>5.2</b> Aggregating and summarising</a></li>
<li class="chapter" data-level="5.3" data-path="featureattributes.html"><a href="featureattributes.html#area-weighted"><i class="fa fa-check"></i><b>5.3</b> Area-weighted interpolation</a></li>
<li class="chapter" data-level="5.4" data-path="featureattributes.html"><a href="featureattributes.html#updownscaling"><i class="fa fa-check"></i><b>5.4</b> Up- and Downscaling</a></li>
<li class="chapter" data-level="5.5" data-path="featureattributes.html"><a href="featureattributes.html#exercises-4"><i class="fa fa-check"></i><b>5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="datacube.html"><a href="datacube.html"><i class="fa fa-check"></i><b>6</b> Data Cubes</a><ul>
<li class="chapter" data-level="6.1" data-path="datacube.html"><a href="datacube.html#a-four-dimensional-data-cube"><i class="fa fa-check"></i><b>6.1</b> A four-dimensional data cube</a></li>
<li class="chapter" data-level="6.2" data-path="datacube.html"><a href="datacube.html#dimensions-attributes-and-support"><i class="fa fa-check"></i><b>6.2</b> Dimensions, attributes, and support</a></li>
<li class="chapter" data-level="6.3" data-path="datacube.html"><a href="datacube.html#dcoperations"><i class="fa fa-check"></i><b>6.3</b> Operations on data cubes</a></li>
<li class="chapter" data-level="6.4" data-path="datacube.html"><a href="datacube.html#vectordatacubes"><i class="fa fa-check"></i><b>6.4</b> Aggregating raster to vector cubes</a></li>
<li class="chapter" data-level="6.5" data-path="datacube.html"><a href="datacube.html#switching"><i class="fa fa-check"></i><b>6.5</b> Switching dimension with attributes</a></li>
<li class="chapter" data-level="6.6" data-path="datacube.html"><a href="datacube.html#otherdynamic"><i class="fa fa-check"></i><b>6.6</b> Other dynamic spatial data</a></li>
<li class="chapter" data-level="6.7" data-path="datacube.html"><a href="datacube.html#exercises-5"><i class="fa fa-check"></i><b>6.7</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II R for Spatial Data Science</b></span></li>
<li class="chapter" data-level="7" data-path="sf.html"><a href="sf.html"><i class="fa fa-check"></i><b>7</b> Introduction to sf and stars</a><ul>
<li class="chapter" data-level="7.1" data-path="sf.html"><a href="sf.html#sfintro"><i class="fa fa-check"></i><b>7.1</b> Package <code>sf</code></a></li>
<li class="chapter" data-level="7.2" data-path="sf.html"><a href="sf.html#spatial-joins"><i class="fa fa-check"></i><b>7.2</b> Spatial joins</a></li>
<li class="chapter" data-level="7.3" data-path="sf.html"><a href="sf.html#package-stars"><i class="fa fa-check"></i><b>7.3</b> Package <code>stars</code></a></li>
<li class="chapter" data-level="7.4" data-path="sf.html"><a href="sf.html#vector-data-cube-examples"><i class="fa fa-check"></i><b>7.4</b> Vector data cube examples</a></li>
<li class="chapter" data-level="7.5" data-path="sf.html"><a href="sf.html#raster-to-vector"><i class="fa fa-check"></i><b>7.5</b> raster-to-vector, vector-to-raster</a></li>
<li class="chapter" data-level="7.6" data-path="sf.html"><a href="sf.html#projsf"><i class="fa fa-check"></i><b>7.6</b> Coordinate transformations and conversions</a></li>
<li class="chapter" data-level="7.7" data-path="sf.html"><a href="sf.html#warp"><i class="fa fa-check"></i><b>7.7</b> Transforming and warping rasters</a></li>
<li class="chapter" data-level="7.8" data-path="sf.html"><a href="sf.html#exercises-6"><i class="fa fa-check"></i><b>7.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="large.html"><a href="large.html"><i class="fa fa-check"></i><b>8</b> Large data sets</a><ul>
<li class="chapter" data-level="8.1" data-path="large.html"><a href="large.html#largesf"><i class="fa fa-check"></i><b>8.1</b> Vector data: <code>sf</code></a></li>
<li class="chapter" data-level="8.2" data-path="large.html"><a href="large.html#raster-data-stars"><i class="fa fa-check"></i><b>8.2</b> Raster data: <code>stars</code></a></li>
<li class="chapter" data-level="8.3" data-path="large.html"><a href="large.html#very-large-data-cubes"><i class="fa fa-check"></i><b>8.3</b> Very large data cubes</a></li>
<li class="chapter" data-level="8.4" data-path="large.html"><a href="large.html#exercises-7"><i class="fa fa-check"></i><b>8.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>9</b> Plotting spatial data</a><ul>
<li class="chapter" data-level="9.1" data-path="plotting.html"><a href="plotting.html#transform"><i class="fa fa-check"></i><b>9.1</b> Every plot is a projection</a></li>
<li class="chapter" data-level="9.2" data-path="plotting.html"><a href="plotting.html#plotting-points-lines-polygons-grid-cells"><i class="fa fa-check"></i><b>9.2</b> Plotting points, lines, polygons, grid cells</a></li>
<li class="chapter" data-level="9.3" data-path="plotting.html"><a href="plotting.html#base-plot"><i class="fa fa-check"></i><b>9.3</b> Base <code>plot</code></a></li>
<li class="chapter" data-level="9.4" data-path="plotting.html"><a href="plotting.html#geomsf"><i class="fa fa-check"></i><b>9.4</b> Maps with <code>ggplot2</code></a></li>
<li class="chapter" data-level="9.5" data-path="plotting.html"><a href="plotting.html#tmap"><i class="fa fa-check"></i><b>9.5</b> Maps with <code>tmap</code></a></li>
<li class="chapter" data-level="9.6" data-path="plotting.html"><a href="plotting.html#interactive-maps-leaflet-mapview-tmap"><i class="fa fa-check"></i><b>9.6</b> Interactive maps: <code>leaflet</code>, <code>mapview</code>, <code>tmap</code></a></li>
<li class="chapter" data-level="9.7" data-path="plotting.html"><a href="plotting.html#exercises-8"><i class="fa fa-check"></i><b>9.7</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>III Models for Spatial Data</b></span></li>
<li class="chapter" data-level="10" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html"><i class="fa fa-check"></i><b>10</b> Statistical modelling of spatial data</a><ul>
<li class="chapter" data-level="10.1" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#design"><i class="fa fa-check"></i><b>10.1</b> Design-based and model-based inference</a></li>
<li class="chapter" data-level="10.2" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#predictive-models-with-coordinates"><i class="fa fa-check"></i><b>10.2</b> Predictive models with coordinates</a></li>
<li class="chapter" data-level="10.3" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#further-reading"><i class="fa fa-check"></i><b>10.3</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="pointpatterns.html"><a href="pointpatterns.html"><i class="fa fa-check"></i><b>11</b> Point Pattern Analysis</a><ul>
<li class="chapter" data-level="11.1" data-path="pointpatterns.html"><a href="pointpatterns.html#observation-window"><i class="fa fa-check"></i><b>11.1</b> Observation window</a></li>
<li class="chapter" data-level="11.2" data-path="pointpatterns.html"><a href="pointpatterns.html#coordinate-reference-systems-1"><i class="fa fa-check"></i><b>11.2</b> Coordinate reference systems</a></li>
<li class="chapter" data-level="11.3" data-path="pointpatterns.html"><a href="pointpatterns.html#marked-point-patterns-points-on-linear-networks"><i class="fa fa-check"></i><b>11.3</b> Marked point patterns, points on linear networks</a></li>
<li class="chapter" data-level="11.4" data-path="pointpatterns.html"><a href="pointpatterns.html#spatial-sampling-and-simulating-a-point-process"><i class="fa fa-check"></i><b>11.4</b> Spatial sampling and simulating a point process</a></li>
<li class="chapter" data-level="11.5" data-path="pointpatterns.html"><a href="pointpatterns.html#simulating-points-on-the-globe"><i class="fa fa-check"></i><b>11.5</b> Simulating points on the globe</a></li>
<li class="chapter" data-level="11.6" data-path="pointpatterns.html"><a href="pointpatterns.html#exercises-9"><i class="fa fa-check"></i><b>11.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="interpolation.html"><a href="interpolation.html"><i class="fa fa-check"></i><b>12</b> Spatial Interpolation</a><ul>
<li class="chapter" data-level="12.1" data-path="interpolation.html"><a href="interpolation.html#a-first-dataset"><i class="fa fa-check"></i><b>12.1</b> A first dataset</a></li>
<li class="chapter" data-level="12.2" data-path="interpolation.html"><a href="interpolation.html#sample-variogram"><i class="fa fa-check"></i><b>12.2</b> Sample variogram</a></li>
<li class="chapter" data-level="12.3" data-path="interpolation.html"><a href="interpolation.html#fitting-variogram-models"><i class="fa fa-check"></i><b>12.3</b> Fitting variogram models</a></li>
<li class="chapter" data-level="12.4" data-path="interpolation.html"><a href="interpolation.html#kriging"><i class="fa fa-check"></i><b>12.4</b> Kriging interpolation</a></li>
<li class="chapter" data-level="12.5" data-path="interpolation.html"><a href="interpolation.html#blockkriging"><i class="fa fa-check"></i><b>12.5</b> Areal means: block kriging</a></li>
<li class="chapter" data-level="12.6" data-path="interpolation.html"><a href="interpolation.html#conditional-simulation"><i class="fa fa-check"></i><b>12.6</b> Conditional simulation</a></li>
<li class="chapter" data-level="12.7" data-path="interpolation.html"><a href="interpolation.html#trend-models"><i class="fa fa-check"></i><b>12.7</b> Trend models</a></li>
<li class="chapter" data-level="12.8" data-path="interpolation.html"><a href="interpolation.html#exercises-10"><i class="fa fa-check"></i><b>12.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="stgeostatistics.html"><a href="stgeostatistics.html"><i class="fa fa-check"></i><b>13</b> Multivariate and Spatiotemporal Geostatistics</a><ul>
<li class="chapter" data-level="13.1" data-path="stgeostatistics.html"><a href="stgeostatistics.html#preparing"><i class="fa fa-check"></i><b>13.1</b> Preparing the air quality dataset</a></li>
<li class="chapter" data-level="13.2" data-path="stgeostatistics.html"><a href="stgeostatistics.html#cokriging"><i class="fa fa-check"></i><b>13.2</b> Multivariable geostatistics</a></li>
<li class="chapter" data-level="13.3" data-path="stgeostatistics.html"><a href="stgeostatistics.html#spatiotemporal-geostatistics"><i class="fa fa-check"></i><b>13.3</b> Spatiotemporal geostatistics</a></li>
<li class="chapter" data-level="13.4" data-path="stgeostatistics.html"><a href="stgeostatistics.html#exercises-11"><i class="fa fa-check"></i><b>13.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="area.html"><a href="area.html"><i class="fa fa-check"></i><b>14</b> Proximity and Areal Data</a><ul>
<li class="chapter" data-level="14.1" data-path="area.html"><a href="area.html#representing-proximity-in-spdep"><i class="fa fa-check"></i><b>14.1</b> Representing proximity in <strong>spdep</strong></a></li>
<li class="chapter" data-level="14.2" data-path="area.html"><a href="area.html#contiguous-neighbours"><i class="fa fa-check"></i><b>14.2</b> Contiguous neighbours</a></li>
<li class="chapter" data-level="14.3" data-path="area.html"><a href="area.html#graph-based-neighbours"><i class="fa fa-check"></i><b>14.3</b> Graph-based neighbours</a></li>
<li class="chapter" data-level="14.4" data-path="area.html"><a href="area.html#distance-based-neighbours"><i class="fa fa-check"></i><b>14.4</b> Distance-based neighbours</a></li>
<li class="chapter" data-level="14.5" data-path="area.html"><a href="area.html#weights-specification"><i class="fa fa-check"></i><b>14.5</b> Weights specification</a></li>
<li class="chapter" data-level="14.6" data-path="area.html"><a href="area.html#higher-order-neighbours"><i class="fa fa-check"></i><b>14.6</b> Higher order neighbours</a></li>
<li class="chapter" data-level="14.7" data-path="area.html"><a href="area.html#exercises-12"><i class="fa fa-check"></i><b>14.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="spatautocorr.html"><a href="spatautocorr.html"><i class="fa fa-check"></i><b>15</b> Measures of spatial autocorrelation</a><ul>
<li class="chapter" data-level="15.1" data-path="spatautocorr.html"><a href="spatautocorr.html#measures-and-process-mis-specification"><i class="fa fa-check"></i><b>15.1</b> Measures and process mis-specification</a></li>
<li class="chapter" data-level="15.2" data-path="spatautocorr.html"><a href="spatautocorr.html#global-measures"><i class="fa fa-check"></i><b>15.2</b> Global measures</a></li>
<li class="chapter" data-level="15.3" data-path="spatautocorr.html"><a href="spatautocorr.html#local-measures"><i class="fa fa-check"></i><b>15.3</b> Local measures</a></li>
<li class="chapter" data-level="15.4" data-path="spatautocorr.html"><a href="spatautocorr.html#exercises-13"><i class="fa fa-check"></i><b>15.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="spatglmm.html"><a href="spatglmm.html"><i class="fa fa-check"></i><b>16</b> Spatial Regression</a><ul>
<li class="chapter" data-level="16.1" data-path="spatglmm.html"><a href="spatglmm.html#markov-random-field-and-multilevel-models-with-spatial-weights"><i class="fa fa-check"></i><b>16.1</b> Markov random field and multilevel models with spatial weights</a></li>
<li class="chapter" data-level="16.2" data-path="spatglmm.html"><a href="spatglmm.html#multilevel-models-of-the-boston-data-set"><i class="fa fa-check"></i><b>16.2</b> Multilevel models of the Boston data set</a></li>
<li class="chapter" data-level="16.3" data-path="spatglmm.html"><a href="spatglmm.html#exercises-14"><i class="fa fa-check"></i><b>16.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="spatecon.html"><a href="spatecon.html"><i class="fa fa-check"></i><b>17</b> Spatial econometrics models</a><ul>
<li class="chapter" data-level="17.1" data-path="spatecon.html"><a href="spatecon.html#spatial-econometric-models-definitions"><i class="fa fa-check"></i><b>17.1</b> Spatial econometric models: definitions</a></li>
<li class="chapter" data-level="17.2" data-path="spatecon.html"><a href="spatecon.html#maximum-likelihood-estimation-in-spatialreg"><i class="fa fa-check"></i><b>17.2</b> Maximum likelihood estimation in <strong>spatialreg</strong></a></li>
<li class="chapter" data-level="17.3" data-path="spatecon.html"><a href="spatecon.html#impacts"><i class="fa fa-check"></i><b>17.3</b> Impacts</a></li>
<li class="chapter" data-level="17.4" data-path="spatecon.html"><a href="spatecon.html#spateconpred"><i class="fa fa-check"></i><b>17.4</b> Predictions</a></li>
<li class="chapter" data-level="17.5" data-path="spatecon.html"><a href="spatecon.html#exercises-15"><i class="fa fa-check"></i><b>17.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="older.html"><a href="older.html"><i class="fa fa-check"></i><b>18</b> Older R Spatial Packages</a><ul>
<li class="chapter" data-level="18.1" data-path="older.html"><a href="older.html#retire"><i class="fa fa-check"></i><b>18.1</b> Retiring <code>rgdal</code> and <code>rgeos</code></a></li>
<li class="chapter" data-level="18.2" data-path="older.html"><a href="older.html#links-and-differences-between-sf-and-sp"><i class="fa fa-check"></i><b>18.2</b> Links and differences between sf and sp</a></li>
<li class="chapter" data-level="18.3" data-path="older.html"><a href="older.html#migration-code-and-packages"><i class="fa fa-check"></i><b>18.3</b> Migration code and packages</a></li>
<li class="chapter" data-level="18.4" data-path="older.html"><a href="older.html#package-raster-and-terra"><i class="fa fa-check"></i><b>18.4</b> Package raster and terra</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="all-r-code-in-this-book.html"><a href="all-r-code-in-this-book.html"><i class="fa fa-check"></i>All R code in this book</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html"><i class="fa fa-check"></i>R basics</a><ul>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#pipes"><i class="fa fa-check"></i>Pipes</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#data-structures"><i class="fa fa-check"></i>Data structures</a></li>
<li><a href="r-basics.html#dissecting-a-multipolygon">dissecting a <code>MULTIPOLYGON</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="plotting" class="section level1">
<h1><span class="header-section-number">Chapter 9</span> Plotting spatial data</h1>
<p>Together with timelines, maps belong to the most powerful graphs,
perhaps because we can immediately relate where we are, or have
been, on the space of the plot. Two recent books on visualisation
<span class="citation">(Healy <a href="#ref-Healy">2018</a>; Wilke <a href="#ref-Wilke">2019</a>)</span> contain chapters on visualising geospatial data or
maps. Here, we will not try to preach the do’s and don’ts of maps,
but rather point out a number of possibilities how to do things,
point out challenges along the way and ways to mitigate them.</p>
<div id="transform" class="section level2">
<h2><span class="header-section-number">9.1</span> Every plot is a projection</h2>
<p>The world is round, but plotting devices are flat. As mentioned
in section <a href="cs.html#projections">2.2.2</a>, any time we visualise, in any
way, the world on a flat device, we project: we convert ellipsoidal
coordinates into Cartesian coordinates. This includes the cases
where we think we “do nothing” (figure <a href="plotting.html#fig:world">9.1</a>, left),
or where we show the world “as it is”, e.g. as seen from space (figure
<a href="plotting.html#fig:world">9.1</a>, right).</p>

<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb298-1" title="1"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb298-2" title="2"><span class="kw">library</span>(rnaturalearth)</a>
<a class="sourceLine" id="cb298-3" title="3">w &lt;-<span class="st"> </span><span class="kw">ne_countries</span>(<span class="dt">scale =</span> <span class="st">&quot;medium&quot;</span>, <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>)</a>
<a class="sourceLine" id="cb298-4" title="4"><span class="kw">suppressWarnings</span>(<span class="kw">st_crs</span>(w) &lt;-<span class="st"> </span><span class="kw">st_crs</span>(<span class="dv">4326</span>))</a>
<a class="sourceLine" id="cb298-5" title="5"><span class="kw">layout</span>(<span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb298-6" title="6"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb298-7" title="7"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(w))</a>
<a class="sourceLine" id="cb298-8" title="8"></a>
<a class="sourceLine" id="cb298-9" title="9"><span class="co"># sphere:</span></a>
<a class="sourceLine" id="cb298-10" title="10"><span class="kw">library</span>(s2)</a>
<a class="sourceLine" id="cb298-11" title="11">g =<span class="st"> </span><span class="kw">as_s2_geography</span>(<span class="ot">TRUE</span>) <span class="co"># Earth</span></a>
<a class="sourceLine" id="cb298-12" title="12">co =<span class="st"> </span><span class="kw">s2_data_countries</span>()</a>
<a class="sourceLine" id="cb298-13" title="13">oc =<span class="st"> </span><span class="kw">s2_difference</span>(g, <span class="kw">s2_union_agg</span>(co)) <span class="co"># oceans</span></a>
<a class="sourceLine" id="cb298-14" title="14">b =<span class="st"> </span><span class="kw">s2_buffer_cells</span>(<span class="kw">as_s2_geography</span>(<span class="st">&quot;POINT(-30 -10)&quot;</span>), <span class="dv">9800000</span>) <span class="co"># visible half</span></a>
<a class="sourceLine" id="cb298-15" title="15">i =<span class="st"> </span><span class="kw">s2_intersection</span>(b, oc) <span class="co"># visible ocean</span></a>
<a class="sourceLine" id="cb298-16" title="16">co =<span class="st"> </span><span class="kw">s2_intersection</span>(b, co)</a>
<a class="sourceLine" id="cb298-17" title="17"><span class="kw">plot</span>(<span class="kw">st_transform</span>(<span class="kw">st_as_sfc</span>(i), <span class="st">&quot;+proj=ortho +lat_0=-10 +lon_0=-30&quot;</span>), <span class="dt">col =</span> <span class="st">&#39;lightblue&#39;</span>)</a>
<a class="sourceLine" id="cb298-18" title="18"><span class="kw">plot</span>(<span class="kw">st_transform</span>(<span class="kw">st_as_sfc</span>(co), <span class="st">&quot;+proj=ortho +lat_0=-10 +lon_0=-30&quot;</span>), <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:world"></span>
<img src="sds_files/figure-html/world-1.png" alt="Earth country boundaries; left: mapping long/lat linearly to \(x\) and \(y\) (plate carrée); right: as seen from infinite distance (orthographic)" width="672" />
<p class="caption">
Figure 9.1: Earth country boundaries; left: mapping long/lat linearly to <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> (plate carrée); right: as seen from infinite distance (orthographic)
</p>
</div>
<p>The left plot of figure <a href="plotting.html#fig:world">9.1</a> was obtained by</p>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb299-1" title="1"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb299-2" title="2"><span class="kw">library</span>(rnaturalearth)</a>
<a class="sourceLine" id="cb299-3" title="3">w &lt;-<span class="st"> </span><span class="kw">ne_countries</span>(<span class="dt">scale =</span> <span class="st">&quot;medium&quot;</span>, <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>)</a>
<a class="sourceLine" id="cb299-4" title="4"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(w))</a></code></pre></div>
<p>and we see that this is the default projection for data with ellipsoidal coordinates, as indicated by</p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb300-1" title="1"><span class="kw">st_is_longlat</span>(w)</a></code></pre></div>
<pre><code># [1] TRUE</code></pre>
<p>The projection taken in figure <a href="plotting.html#fig:world">9.1</a> (left) is the
equirectangular (or equidistant cylindrical) projection, which maps
longitude and latitude linearly to the <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> axis, keeping
an aspect ratio of 1. Were we to do this for smaller areas not on
the equator, it makes sense to choose a plot ratio such that one
distance unit E-W equals one distance unit N-S on the center of
the plotted area, and this is the default behaviour of the <code>plot()</code>
method for unprojected <code>sf</code> or <code>stars</code> datasets, as well as the
default for <code>ggplot2::geom_sf()</code> (section <a href="plotting.html#geomsf">9.4</a>).</p>
<p>We can also carry out this projection before plotting. Say we want to
plot Germany, then after loading the (rough) country outline,
we use <code>st_transform</code> to project:</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb302-1" title="1">DE =<span class="st"> </span><span class="kw">st_geometry</span>(<span class="kw">ne_countries</span>(<span class="dt">country =</span> <span class="st">&quot;germany&quot;</span>, <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>))</a>
<a class="sourceLine" id="cb302-2" title="2">DE.eqc =<span class="st"> </span><span class="kw">st_transform</span>(DE, <span class="st">&quot;+proj=eqc +lat_ts=51.14 +lon_0=90w&quot;</span>)</a></code></pre></div>
<p>The <code>eqc</code> refers to the “equidistant cylindrical” projection of PROJ;
the projection parameter here is <code>lat_ts</code>, the latitude of true
scale (i.e., one length unit N-S equals one length unit E-W),
which was here chosen as the middle of the bounding box latitudes</p>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb303-1" title="1"><span class="kw">print</span>(<span class="kw">mean</span>(<span class="kw">st_bbox</span>(DE)[<span class="kw">c</span>(<span class="st">&quot;ymin&quot;</span>, <span class="st">&quot;ymax&quot;</span>)]), <span class="dt">digits =</span> <span class="dv">4</span>)</a></code></pre></div>
<pre><code># [1] 51.14</code></pre>
<p>When we now plot both maps (figure <a href="plotting.html#fig:eqc">9.2</a>), they look
identical up to the values along the axes: degrees for ellipsoidal
(left), and metres for projected (Cartesian) coordinates.</p>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb305-1" title="1"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb305-2" title="2"><span class="kw">plot</span>(DE, <span class="dt">axes =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb305-3" title="3"><span class="kw">plot</span>(DE.eqc, <span class="dt">axes =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:eqc"></span>
<img src="sds_files/figure-html/eqc-1.png" alt="Germany in equirectangular projection: with axis units degrees (left) and metres in the equidistant cylindrical projection (right)" width="60%" />
<p class="caption">
Figure 9.2: Germany in equirectangular projection: with axis units degrees (left) and metres in the equidistant cylindrical projection (right)
</p>
</div>
<div id="what-is-a-good-projection-for-my-data" class="section level3">
<h3><span class="header-section-number">9.1.1</span> What is a good projection for my data?</h3>
<p>There is unfortunately no silver bullet here. Projections that
maintain all distances do not exist; only globes do. The most
used projections try to preserve:</p>
<ul>
<li>areas (equal area)</li>
<li>directions (conformal, e.g. Mercator)</li>
<li>some properties of distances (e.g. equirectangular preserves distances along meridians, azimuthal equidistant preserves distances to a central point)</li>
</ul>
<p>or some compromise of these. Parameters of projections decide what
is shown in the center of a map and what on the fringes, which
areas are up and which are down, and which areas are most enlarged.
All these choices are in the end political decisions.</p>
<p>It is often entertaining and at times educational to play around with
the different projections and understand their consequences. When
the primary purpose of the map however is not to entertain or educate
projection varieties, it may be preferable to choose a well-known or
less surprising projection, and move the discussion which projection
should be preferred to a decision process on its own.</p>
</div>
</div>
<div id="plotting-points-lines-polygons-grid-cells" class="section level2">
<h2><span class="header-section-number">9.2</span> Plotting points, lines, polygons, grid cells</h2>
<p>Since maps are just a special form of plots of statistical data,
the usual rules hold. Frequently occurring challenges include:</p>
<ul>
<li>polygons may be very small, and vanish when plotted</li>
<li>depending on the data, polygons for different features may well
overlap, and be visible only partially; using transparent fill
colours may help identify them</li>
<li>when points are plotted with symbols, they may easily overlap and be hidden; density maps (chapter <a href="pointpatterns.html#pointpatterns">11</a>) may be more helpful</li>
<li>lines may be hard to read when coloured and may overlap regardless line width</li>
</ul>
<div id="colors" class="section level3">
<h3><span class="header-section-number">9.2.1</span> Colors</h3>
<p>When plotting polygons filled with colours, one has the choice to plot
polygon boundaries, or to suppress these. If polygon boundaries draw
too much attention, an alternative is to colour them in a grey tone,
or another colour that doesn’t interfere with the fill colours. When
suppressing boundaries entirely, polygons with (nearly) identical
colours will no longer be visually distinguishable. If the property
indicating the fill colour is constant over the region, such as land
cover type, then this is not a problem but if the property is an
aggregation, the region over which it was aggregated gets lost,
and by that the proper interpretation: especially for extensive
variables, e.g. the amount of people living in a polygon, this
strongly misleads. But even with polygon boundaries, using filled
polygons for such variables may not be a good idea.</p>
<p>The use of continuous colour scales that have no noticeable colour
breaks for continuously varying variables may look attractive,
but is often more fancy than useful:</p>
<ul>
<li>it impracticable to match a colour on the map with a legend value</li>
<li>colours ramps often stretch non-linearly over the value range,
making it hard to convey magnitude</li>
</ul>
<p>Only for cases where the identification of values is less
important than the continuity of the map, such as the colouring of
a high resolution digital terrain model, it does serve its goal.
Good colours scales and palettes are e.g. found in functions
<code>hcl.colors</code> or <code>palette.colors</code>, and in packages <code>RColorBrewer</code>
<span class="citation">(Neuwirth <a href="#ref-R-RColorBrewer">2014</a>)</span>, <code>viridis</code> <span class="citation">(Garnier <a href="#ref-R-viridis">2021</a>)</span> or <code>colorspace</code>
<span class="citation">(Ihaka et al. <a href="#ref-R-colorspace">2021</a>; Zeileis et al. <a href="#ref-colorspace">2020</a>)</span>.</p>
</div>
<div id="classintervals" class="section level3">
<h3><span class="header-section-number">9.2.2</span> Color breaks: <code>classInt</code></h3>
<p>When plotting continuous geometry attributes using a limited set
of colours (or symbols), classes need to be made from the data.
R package <code>classInt</code> <span class="citation">(R. Bivand <a href="#ref-R-classInt">2020</a><a href="#ref-R-classInt">a</a>)</span> provides a number of methods to
do so. The default method is “quantile”:</p>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb306-1" title="1"><span class="kw">library</span>(classInt)</a>
<a class="sourceLine" id="cb306-2" title="2"><span class="co"># set.seed(1) needed ?</span></a>
<a class="sourceLine" id="cb306-3" title="3">r =<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">100</span>)</a>
<a class="sourceLine" id="cb306-4" title="4">(cI &lt;-<span class="st"> </span><span class="kw">classIntervals</span>(r))</a></code></pre></div>
<pre><code># style: quantile
#   one of 1.49e+10 possible partitions of this variable into 8 classes
#   [-2.61,-1.26)  [-1.26,-0.356) [-0.356,-0.131)  [-0.131,0.091)   [0.091,0.433) 
#              13              12              13              12              12 
#   [0.433,0.623)    [0.623,1.11)     [1.11,2.76] 
#              13              12              13</code></pre>
<div class="sourceCode" id="cb308"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb308-1" title="1">cI<span class="op">$</span>brks</a></code></pre></div>
<pre><code># [1] -2.612 -1.257 -0.356 -0.131  0.091  0.433  0.623  1.113  2.755</code></pre>
<p>it takes argument <code>n</code> for the number of intervals, and a <code>style</code>
that can be one of “fixed”, “sd”, “equal”, “pretty”, “quantile”,
“kmeans”, “hclust”, “bclust”, “fisher” or “jenks”. Style “pretty”
may not obey <code>n</code>; if <code>n</code> is missing, ‘nclass.Sturges’ is used;
two other methods are available for choosing <code>n</code> automatically. If
the number of observations is greater than 3000, a 10% sample is used
to create the breaks for “fisher” and “jenks”.</p>
</div>
<div id="graticule" class="section level3">
<h3><span class="header-section-number">9.2.3</span> Graticule and other navigation aids</h3>
<p>A graticule is a network of lines on a map that follow constant latitude or
longitude. On figure <a href="intro.html#fig:first-map">1.1</a> a graticule is drawn
in grey, on figure <a href="intro.html#fig:firstgather">1.2</a> in white.
Graticules are often drawn in maps to give reference where
something is. In our first map in figure <a href="intro.html#fig:first-map">1.1</a> we can
read that the area plotted is near 35<span class="math inline">\(^o\)</span> North and 80<span class="math inline">\(^o\)</span> West.
Had we plotted the lines in the projected coordinate system, they
would have been straight and their actual numbers would not have
been very informative, apart from giving an interpretation of size
or distances when the unit is known, and familiar to the map reader.
Graticules, by that, also shed light on which projection
was used: equirectangular or Mercator projections have straight
vertical and horizontal lines, conic projections have straight but
diverging meridians, equal area may have curved meridians.</p>
<p>The real navigation aid on figure <a href="plotting.html#fig:world">9.1</a> and most other
maps are geographical features like the state outline, country
outlines, coast lines, rivers, roads, railways and so on. If these
are added sparsely and sufficiently, a graticule can as well be
omitted. In such cases, maps look good without axes, tics, and labels,
leaving up a lot of plotting space to be filled with actual map data.</p>
</div>
</div>
<div id="base-plot" class="section level2">
<h2><span class="header-section-number">9.3</span> Base <code>plot</code></h2>
<p>The <code>plot</code> method for <code>sf</code> and <code>stars</code> objects try to make quick,
useful, exploratory plots; for higher quality plots and more
configurability, alternatives with more control and/or better
defaults are offered for instance by packages <code>ggplot2</code> <span class="citation">(Wickham et al. <a href="#ref-R-ggplot2">2021</a>)</span>,
<code>tmap</code> <span class="citation">(Tennekes <a href="#ref-R-tmap">2021</a>, <a href="#ref-tmap">2018</a>)</span> or <code>mapsf</code> <span class="citation">(Giraud <a href="#ref-R-mapsf">2021</a>)</span>.</p>
<p>By default, the plot method tries to plot “all” it is given.
This means that:</p>
<ul>
<li>given a geometry only (<code>sfc</code>), the geometry is plotted, without colours</li>
<li>given a geometry and an attribute, the geometry is coloured according to
the values of the attribute, using a qualitative colour scale for <code>factor</code>
or <code>logical</code> attributes and a continuous scale otherwise</li>
<li>given multiple attributes, multiple maps are plotted, each with a colour
scale but a legend is omitted by default, as colour assignment is
done on a per sub-map basis</li>
<li>for <code>stars</code> objects with multiple attributes, only the first
attribute is plotted; for three-dimensional raster cubes, all
slices over the third dimension are plotted</li>
</ul>
<div id="adding-to-plots-with-legends" class="section level3">
<h3><span class="header-section-number">9.3.1</span> Adding to plots with legends</h3>
<p>The <code>plot</code> methods for <code>stars</code> and <code>sf</code> objects may show a colour key
on one of the sides (e.g., figure <a href="intro.html#fig:first-map">1.1</a>). To do this
with <code>base::plot</code>, the plot region is split in two and two plots are
created: one with the map, and one with the legend. By default, the
<code>plot</code> function resets the graphics device (using <code>layout(matrix(1))</code>
so that subsequent plots are not hindered by the device being split
in two. If one wants to <em>add</em> to an existing plot having a coulor
legend, this is however what is needed, and resetting the plotting
device needs to be prevented by setting argument <code>reset = FALSE</code>,
and use <code>add = TRUE</code> in a subsequent call to <code>plot</code>, an example
is</p>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb310-1" title="1"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb310-2" title="2">nc =<span class="st"> </span><span class="kw">read_sf</span>(<span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;sf&quot;</span>))</a>
<a class="sourceLine" id="cb310-3" title="3"><span class="kw">plot</span>(nc[<span class="st">&quot;BIR74&quot;</span>], <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">key.pos =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb310-4" title="4"><span class="kw">plot</span>(<span class="kw">st_buffer</span>(nc[<span class="dv">1</span>,<span class="dv">1</span>], units<span class="op">::</span><span class="kw">set_units</span>(<span class="dv">10</span>, km)), <span class="dt">col =</span> <span class="st">&#39;NA&#39;</span>, </a>
<a class="sourceLine" id="cb310-5" title="5">     <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:figreset"></span>
<img src="sds_files/figure-html/figreset-1.png" alt="Annotating base plots that have a legend" width="672" height="80%" />
<p class="caption">
Figure 9.3: Annotating base plots that have a legend
</p>
</div>
<p>which is shown in figure <a href="plotting.html#fig:figreset">9.3</a>. Annotating <code>stars</code>
plots can be done in the same way when a <em>single</em> stars layer is
shown. Annotating <code>stars</code> plots with multiple cube slices can be
done by adding a “hook” function that will be called on every slice
shown, as in</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb311-1" title="1"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb311-2" title="2">r =<span class="st"> </span><span class="kw">read_stars</span>(<span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>))</a>
<a class="sourceLine" id="cb311-3" title="3">circ =<span class="st"> </span><span class="kw">st_bbox</span>(r) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_as_sfc</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_sample</span>(<span class="dv">5</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_buffer</span>(<span class="dv">300</span>)</a>
<a class="sourceLine" id="cb311-4" title="4">hook =<span class="st"> </span><span class="cf">function</span>() <span class="kw">plot</span>(circ, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;yellow&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb311-5" title="5"><span class="kw">plot</span>(r, <span class="dt">hook =</span> hook, <span class="dt">key.pos =</span> <span class="dv">4</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:starshook"></span>
<img src="sds_files/figure-html/starshook-1.png" alt="annotated multi-slice stars plot" width="672" />
<p class="caption">
Figure 9.4: annotated multi-slice stars plot
</p>
</div>
<p>and as shown in figure <a href="plotting.html#fig:starshook">9.4</a>.</p>
<p>Base plot methods have access to the resolution of the screen device
and hence the base plot method for <code>stars</code> and <code>stars_proxy</code> object
will downsample dense rasters and only plot pixels at a density
that makes sense for the device available.</p>
</div>
<div id="projections-in-base-plots" class="section level3">
<h3><span class="header-section-number">9.3.2</span> Projections in base plots</h3>
<p>The base <code>plot</code> method plots data with ellipsoidal coordinates
using the equirectangular projection, using a latitude parameter
equal to the middle latitude of the data bounding box (figure
<a href="plotting.html#fig:eqc">9.2</a>). To control this parameter, either a projection
to another equirectangular can be applied before plotting, or the
parameter <code>asp</code> can be set to override, e.g. <code>asp=1</code> would lead to
plate carrée (figure <a href="plotting.html#fig:world">9.1</a> left). Subsequent plots need
to be in the same coordinate reference system in order to make
sense with overplotting, this is not being checked.</p>
</div>
<div id="colors-and-coulor-breaks" class="section level3">
<h3><span class="header-section-number">9.3.3</span> Colors and coulor breaks</h3>
<p>In base plots, <code>nbreaks</code> can be used to set the number of coulor
breaks, and <code>breaks</code> either to the numeric vector with actual breaks,
or to a value for the <code>style</code> argument in <code>classInt::classIntervals</code>.</p>
</div>
</div>
<div id="geomsf" class="section level2">
<h2><span class="header-section-number">9.4</span> Maps with <code>ggplot2</code></h2>
<p>Package <code>ggplot2</code> <span class="citation">(Wickham et al. <a href="#ref-R-ggplot2">2021</a>; Wickham <a href="#ref-ggplot2">2016</a>)</span> can create
more complex an nicer looking graphs; it has a geometry <code>geom_sf</code>
that was developed in conjunction with the development of <code>sf</code>, and
helps creating beautiful maps; an introduction to this is found in
<span class="citation">Moreno and Basille (<a href="#ref-moreno">2018</a>)</span>, a first example is shown in figure <a href="intro.html#fig:firstgather">1.2</a>.
The code used for this plot is:</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb312-1" title="1"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(tidyverse))</a>
<a class="sourceLine" id="cb312-2" title="2">nc<span class="fl">.32119</span> =<span class="st"> </span><span class="kw">st_transform</span>(nc, <span class="dv">32119</span>) </a>
<a class="sourceLine" id="cb312-3" title="3">year_labels =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SID74&quot;</span> =<span class="st"> &quot;1974 - 1978&quot;</span>, <span class="st">&quot;SID79&quot;</span> =<span class="st"> &quot;1979 - 1984&quot;</span>)</a>
<a class="sourceLine" id="cb312-4" title="4">nc<span class="fl">.32119</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID74, SID79) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb312-5" title="5"><span class="st">    </span><span class="kw">pivot_longer</span>(<span class="kw">starts_with</span>(<span class="st">&quot;SID&quot;</span>)) -&gt;<span class="st"> </span>nc_longer</a></code></pre></div>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb313-1" title="1"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> nc_longer, <span class="kw">aes</span>(<span class="dt">fill =</span> value)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb313-2" title="2"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>name, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">labeller =</span> <span class="kw">labeller</span>(<span class="dt">name =</span> year_labels)) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-3" title="3"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="dv">34</span><span class="op">:</span><span class="dv">36</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-4" title="4"><span class="st">  </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colours =</span> <span class="kw">sf.colors</span>(<span class="dv">20</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-5" title="5"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid.major =</span> <span class="kw">element_line</span>(<span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>))</a></code></pre></div>
<p>where we see that two attributes had to be stacked (<code>pivot_longer</code>)
before plotting them as facets: this is the idea of “tidy” data,
and the <code>pivot_longer</code> method for <code>sf</code> objects automatically stacks
the geometry column too.</p>
<p>Because <code>ggplot2</code> creates graphics <em>objects</em> before plotting them,
it can control the coordinate reference system of all elements
involved, and will transform or convert all subsequent objects to
the coordinate reference system of the first. It will also draw a
graticule for the (default) thin white lines on a grey background,
and uses a datum (by default: WGS84) for this. <code>geom_sf()</code> can be
combined with other geoms, for instance to allow for annotating
plots.</p>
<p>For package <code>stars</code>, a <code>geom_stars</code> has, at the moment of writing
this, rather limited scope: it uses <code>geom_sf</code> for map layout and vector data
cubes, and adds <code>geom_raster</code> for regular rasters and <code>geom_rect</code>
for rectilinear rasters. It downsamples if the user specifies a
downsampling rate, but has no access to the screen dimensions to
automatically choose a downsampling rate. This may be just enough,
for instance figure
<a href="plotting.html#fig:ggplotstars">9.5</a> is created by the following commands:</p>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb314-1" title="1"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb314-2" title="2"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb314-3" title="3">r =<span class="st"> </span><span class="kw">read_stars</span>(<span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>))</a>
<a class="sourceLine" id="cb314-4" title="4"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> r) <span class="op">+</span></a>
<a class="sourceLine" id="cb314-5" title="5"><span class="st">        </span><span class="kw">facet_wrap</span>(<span class="op">~</span>band) <span class="op">+</span><span class="st"> </span><span class="kw">coord_equal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb314-6" title="6"><span class="st">        </span><span class="kw">theme_void</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb314-7" title="7"><span class="st">        </span><span class="kw">scale_x_discrete</span>(<span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb314-8" title="8"><span class="st">        </span><span class="kw">scale_y_discrete</span>(<span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb314-9" title="9"><span class="st">        </span><span class="kw">scale_fill_viridis_c</span>()</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ggplotstars"></span>
<img src="sds_files/figure-html/ggplotstars-1.png" alt="Simple raster plot with ggplot2" width="672" />
<p class="caption">
Figure 9.5: Simple raster plot with ggplot2
</p>
</div>
<p>More elaborate <code>ggplot2</code>-based plots with <code>stars</code> objects may be
obtained using package <code>ggspatial</code> <span class="citation">(Dunnington <a href="#ref-R-ggspatial">2021</a>)</span>. Non-compatible
but nevertheless <code>ggplot2</code>-style plots can be created with <code>tmap</code>,
a package dedicated to creating high quality maps.</p>
<p>When combining several feature sets with varying coordinate reference
systems, using <code>geom_sf</code>, all sets are transformed to the reference
system of the first set. To get further control over the “base”
coordinate reference system, <code>coord_sf</code> can be used. This allows
for instance working in a projected system, while combining graphics
elements that are <em>not</em> <code>sf</code> objects but regular <code>data.frame</code>s
with ellipsoidal coordinates associated to WGS84. A
twitter thread by Claus Wilke illustrating this is found
<a href="https://twitter.com/ClausWilke/status/1275938314055561216">here</a>.</p>
</div>
<div id="tmap" class="section level2">
<h2><span class="header-section-number">9.5</span> Maps with <code>tmap</code></h2>
<p>Package <code>tmap</code> <span class="citation">(Tennekes <a href="#ref-R-tmap">2021</a>, <a href="#ref-tmap">2018</a>)</span> takes a fresh look on plotting
spatial data in R; it resembles <code>ggplot2</code> in the sense that it
composes graphics objects before printing, by building on the <code>grid</code>
package, and by concatenating map elements with a <code>+</code> between them,
but otherwise it is entirely independent from, and incompatible
with, <code>ggplot2</code>. It has a number of options that allow for highly
professional looking maps, and many defaults have been carefully
chosen. To recreate figure <a href="intro.html#fig:firstgather">1.2</a>, for instance,
we use</p>

<div class="figure" style="text-align: center"><span style="display:block;" id="fig:tmapnc"></span>
<img src="sds_files/figure-html/tmapnc-1.png" alt="tmap: using tm_polygons() with two attribute names" width="80%" />
<p class="caption">
Figure 9.6: tmap: using <code>tm_polygons()</code> with two attribute names
</p>
</div>

<p>to recreate figure <a href="plotting.html#fig:tmapnc">9.6</a> and</p>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb315-1" title="1">nc<span class="fl">.32119</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID74, SID79) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb315-2" title="2"><span class="st">    </span><span class="kw">pivot_longer</span>(<span class="kw">starts_with</span>(<span class="st">&quot;SID&quot;</span>), <span class="dt">values_to =</span> <span class="st">&quot;SID&quot;</span>) -&gt;<span class="st"> </span>nc_longer</a>
<a class="sourceLine" id="cb315-3" title="3"><span class="kw">tm_shape</span>(nc_longer) <span class="op">+</span><span class="st"> </span><span class="kw">tm_polygons</span>(<span class="st">&quot;SID&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">by =</span> <span class="st">&quot;name&quot;</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:tmapnc2"></span>
<img src="sds_files/figure-html/tmapnc2-1.png" alt="tmap: using tm_facets() on a long table" width="80%" />
<p class="caption">
Figure 9.7: tmap: using <code>tm_facets()</code> on a long table
</p>
</div>
<p>to create figure <a href="plotting.html#fig:tmapnc2">9.7</a>.</p>
<p>Package <code>tmap</code> also has support for <code>stars</code> objects, an example created with</p>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb316-1" title="1"><span class="kw">tm_shape</span>(r) <span class="op">+</span><span class="st"> </span><span class="kw">tm_raster</span>()</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:tmapstars"></span>
<img src="sds_files/figure-html/tmapstars-1.png" alt="simple raster plot with tmap" width="80%" />
<p class="caption">
Figure 9.8: simple raster plot with tmap
</p>
</div>
<p>is shown in figure <a href="plotting.html#fig:tmapstars">9.8</a>. More examples of the use of <strong>tmap</strong> are given in Chapter <a href="area.html#area">14</a>.</p>
</div>
<div id="interactive-maps-leaflet-mapview-tmap" class="section level2">
<h2><span class="header-section-number">9.6</span> Interactive maps: <code>leaflet</code>, <code>mapview</code>, <code>tmap</code></h2>
<p>Interactive maps as shown in figure <a href="#fig:mapviewfigure"><strong>??</strong></a> can be
created with R packages <code>leaflet</code>, <code>mapview</code> or <code>tmap</code>. <code>mapview</code>
adds a number of capabilities to <code>leaflet</code> including a map legend,
configurable pop-up windows when clicking features, support for
raster data, and scalable maps with very large feature sets using
the FlatGeobuf file format, as well as facet maps that react
synchronously to zoom and pan actions. Package <code>tmap</code> has the nice
option that after giving</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb317-1" title="1"><span class="kw">tmap_mode</span>(<span class="st">&quot;view&quot;</span>)</a></code></pre></div>
<p>all usual <code>tmap</code> commands are applied to an interactive html/leaflet widget,
whereas after</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb318-1" title="1"><span class="kw">tmap_mode</span>(<span class="st">&quot;plot&quot;</span>)</a></code></pre></div>
<p>again all output is sent to R own static graphics device.</p>
</div>
<div id="exercises-8" class="section level2">
<h2><span class="header-section-number">9.7</span> Exercises</h2>
<ol style="list-style-type: decimal">
<li>For the countries Indonesia and Canada, create individual plots using
equirectangular, orthographic, and Lambert equal area projections, while
choosing projection parameters sensible for the area.</li>
<li>Recreate the plot in figure <a href="plotting.html#fig:figreset">9.3</a> with <code>ggplot2</code> and with <code>tmap</code>.</li>
<li>Recreate the plot in figure <a href="plotting.html#fig:tmapstars">9.8</a> using the <code>viridis</code> colour ramp.</li>
<li>View the interactive plot in figure <a href="plotting.html#fig:tmapstars">9.8</a> using the “view”
(interactive) mode of <code>tmap</code>, and explore which interactions are possible; also
explore adding <code>+ tm_facets(as.layers=TRUE)</code> and try switching layers on and off.</li>
</ol>

</div>
</div>



<h3>References</h3>
<div id="refs" class="references">
<div id="ref-R-classInt">
<p>Bivand, Roger. 2020a. <em>ClassInt: Choose Univariate Class Intervals</em>. <a href="https://CRAN.R-project.org/package=classInt">https://CRAN.R-project.org/package=classInt</a>.</p>
</div>
<div id="ref-R-ggspatial">
<p>Dunnington, Dewey. 2021. <em>Ggspatial: Spatial Data Framework for Ggplot2</em>. <a href="https://CRAN.R-project.org/package=ggspatial">https://CRAN.R-project.org/package=ggspatial</a>.</p>
</div>
<div id="ref-R-viridis">
<p>Garnier, Simon. 2021. <em>Viridis: Colorblind-Friendly Color Maps for R</em>. <a href="https://CRAN.R-project.org/package=viridis">https://CRAN.R-project.org/package=viridis</a>.</p>
</div>
<div id="ref-R-mapsf">
<p>Giraud, Timothée. 2021. <em>Mapsf: Thematic Cartography</em>. <a href="https://CRAN.R-project.org/package=mapsf">https://CRAN.R-project.org/package=mapsf</a>.</p>
</div>
<div id="ref-Healy">
<p>Healy, Kieran. 2018. <em>Data Visualization, a Practical Introduction</em>. Princeton University Press. <a href="http://socviz.co/index.html">http://socviz.co/index.html</a>.</p>
</div>
<div id="ref-R-colorspace">
<p>Ihaka, Ross, Paul Murrell, Kurt Hornik, Jason C. Fisher, Reto Stauffer, Claus O. Wilke, Claire D. McWhite, and Achim Zeileis. 2021. <em>Colorspace: A Toolbox for Manipulating and Assessing Colors and Palettes</em>. <a href="https://CRAN.R-project.org/package=colorspace">https://CRAN.R-project.org/package=colorspace</a>.</p>
</div>
<div id="ref-moreno">
<p>Moreno, Mel, and Mathieu Basille. 2018. <em>Drawing Beautiful Maps Programmatically with R, Sf and Ggplot2 — Part 1: Basics</em>. <a href="https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html">https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html</a>.</p>
</div>
<div id="ref-R-RColorBrewer">
<p>Neuwirth, Erich. 2014. <em>RColorBrewer: ColorBrewer Palettes</em>. <a href="https://CRAN.R-project.org/package=RColorBrewer">https://CRAN.R-project.org/package=RColorBrewer</a>.</p>
</div>
<div id="ref-tmap">
<p>Tennekes, Martijn. 2018. “tmap: Thematic Maps in R.” <em>Journal of Statistical Software</em> 84 (6): 1–39. <a href="https://doi.org/10.18637/jss.v084.i06">https://doi.org/10.18637/jss.v084.i06</a>.</p>
</div>
<div id="ref-R-tmap">
<p>Tennekes, Martijn. 2021. <em>Tmap: Thematic Maps</em>. <a href="https://github.com/mtennekes/tmap">https://github.com/mtennekes/tmap</a>.</p>
</div>
<div id="ref-ggplot2">
<p>Wickham, Hadley. 2016. <em>Ggplot2: Elegant Graphics for Data Analysis</em>. Springer.</p>
</div>
<div id="ref-R-ggplot2">
<p>Wickham, Hadley, Winston Chang, Lionel Henry, Thomas Lin Pedersen, Kohske Takahashi, Claus Wilke, Kara Woo, Hiroaki Yutani, and Dewey Dunnington. 2021. <em>Ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics</em>. <a href="https://CRAN.R-project.org/package=ggplot2">https://CRAN.R-project.org/package=ggplot2</a>.</p>
</div>
<div id="ref-Wilke">
<p>Wilke, Claus O. 2019. <em>Fundamentals of Data Visualization</em>. O’Reilly Media, Inc. <a href="https://serialmentor.com/dataviz/">https://serialmentor.com/dataviz/</a>.</p>
</div>
<div id="ref-colorspace">
<p>Zeileis, Achim, Jason C. Fisher, Kurt Hornik, Ross Ihaka, Claire D. McWhite, Paul Murrell, Reto Stauffer, and Claus O. Wilke. 2020. “colorspace: A Toolbox for Manipulating and Assessing Colors and Palettes.” <em>Journal of Statistical Software</em> 96 (1): 1–49. <a href="https://doi.org/10.18637/jss.v096.i01">https://doi.org/10.18637/jss.v096.i01</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="large.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="statistical-modelling-of-spatial-data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/edzer/sdsr/edit/master/09-Plotting.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
