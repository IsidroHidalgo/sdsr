<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>All R code in this book | Spatial Data Science</title>
  <meta name="description" content="description_xx" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="All R code in this book | Spatial Data Science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="description_xx" />
  <meta name="github-repo" content="edzer/sdsr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="All R code in this book | Spatial Data Science" />
  
  <meta name="twitter:description" content="description_xx" />
  

<meta name="author" content="Edzer Pebesma, Roger Bivand" />


<meta name="date" content="2022-04-07" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="older.html"/>
<link rel="next" href="r-basics.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />

<script>
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan');
  rCodeBlocks.each(function() {

    // if code block has been labeled with class `fold-show`, show the code on init!
    var classList = $(this).attr('class').split(/\s+/);
    for (var i = 0; i < classList.length; i++) {
    if (classList[i] === 'fold-show') {
        show = true;
      }
    }

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // hack: return show to false, otherwise all next codeBlocks will be shown!
    show = false;

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<script>
/* ========================================================================
 * Bootstrap: dropdown.js v3.3.7
 * http://getbootstrap.com/javascript/#dropdowns
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // DROPDOWN CLASS DEFINITION
  // =========================

  var backdrop = '.dropdown-backdrop'
  var toggle   = '[data-toggle="dropdown"]'
  var Dropdown = function (element) {
    $(element).on('click.bs.dropdown', this.toggle)
  }

  Dropdown.VERSION = '3.3.7'

  function getParent($this) {
    var selector = $this.attr('data-target')

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7
    }

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  }

  function clearMenus(e) {
    if (e && e.which === 3) return
    $(backdrop).remove()
    $(toggle).each(function () {
      var $this         = $(this)
      var $parent       = getParent($this)
      var relatedTarget = { relatedTarget: this }

      if (!$parent.hasClass('open')) return

      if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

      $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this.attr('aria-expanded', 'false')
      $parent.removeClass('open').trigger($.Event('hidden.bs.dropdown', relatedTarget))
    })
  }

  Dropdown.prototype.toggle = function (e) {
    var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    clearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $(document.createElement('div'))
          .addClass('dropdown-backdrop')
          .insertAfter($(this))
          .on('click', clearMenus)
      }

      var relatedTarget = { relatedTarget: this }
      $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this
        .trigger('focus')
        .attr('aria-expanded', 'true')

      $parent
        .toggleClass('open')
        .trigger($.Event('shown.bs.dropdown', relatedTarget))
    }

    return false
  }

  Dropdown.prototype.keydown = function (e) {
    if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName)) return

    var $this = $(this)

    e.preventDefault()
    e.stopPropagation()

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    if (!isActive && e.which != 27 || isActive && e.which == 27) {
      if (e.which == 27) $parent.find(toggle).trigger('focus')
      return $this.trigger('click')
    }

    var desc = ' li:not(.disabled):visible a'
    var $items = $parent.find('.dropdown-menu' + desc)

    if (!$items.length) return

    var index = $items.index(e.target)

    if (e.which == 38 && index > 0)                 index--         // up
    if (e.which == 40 && index < $items.length - 1) index++         // down
    if (!~index)                                    index = 0

    $items.eq(index).trigger('focus')
  }


  // DROPDOWN PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this = $(this)
      var data  = $this.data('bs.dropdown')

      if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  var old = $.fn.dropdown

  $.fn.dropdown             = Plugin
  $.fn.dropdown.Constructor = Dropdown


  // DROPDOWN NO CONFLICT
  // ====================

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  // APPLY TO STANDARD DROPDOWN ELEMENTS
  // ===================================

  $(document)
    .on('click.bs.dropdown.data-api', clearMenus)
    .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
    .on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown)
    .on('keydown.bs.dropdown.data-api', '.dropdown-menu', Dropdown.prototype.keydown)

}(jQuery);
</script>
<style type="text/css">
.code-folding-btn {
  margin-bottom: 4px;
}

.row { display: flex; }
.collapse { display: none; }
.in { display:block }
.pull-right > .dropdown-menu {
    right: 0;
    left: auto;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    font-size: 14px;
    text-align: left;
    list-style: none;
    background-color: #fff;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    border: 1px solid #ccc;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
    box-shadow: 0 6px 12px rgba(0,0,0,.175);
}

.open > .dropdown-menu {
    display: block;
    color: #ffffff;
    background-color: #ffffff;
    background-image: none;
    border-color: #92897e;
}

.dropdown-menu > li > a {
  display: block;
  padding: 3px 20px;
  clear: both;
  font-weight: 400;
  line-height: 1.42857143;
  color: #000000;
  white-space: nowrap;
}

.dropdown-menu > li > a:hover,
.dropdown-menu > li > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
}

.dropdown-menu > .active > a,
.dropdown-menu > .active > a:hover,
.dropdown-menu > .active > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
  outline: 0;
}
.dropdown-menu > .disabled > a,
.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  color: #aea79f;
}

.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  text-decoration: none;
  cursor: not-allowed;
  background-color: transparent;
  background-image: none;
  filter: progid:DXImageTransform.Microsoft.gradient(enabled = false);
}

.btn {
  display: inline-block;
  margin-bottom: 1;
  font-weight: normal;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  -ms-touch-action: manipulation;
      touch-action: manipulation;
  cursor: pointer;
  background-image: none;
  border: 1px solid transparent;
  padding: 4px 8px;
  font-size: 14px;
  line-height: 1.42857143;
  border-radius: 4px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.btn:focus,
.btn:active:focus,
.btn.active:focus,
.btn.focus,
.btn:active.focus,
.btn.active.focus {
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px;
}
.btn:hover,
.btn:focus,
.btn.focus {
  color: #ffffff;
  text-decoration: none;
}
.btn:active,
.btn.active {
  background-image: none;
  outline: 0;
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn.disabled,
.btn[disabled],
fieldset[disabled] .btn {
  cursor: not-allowed;
  filter: alpha(opacity=65);
  opacity: 0.65;
  box-shadow: none;
}
a.btn.disabled,
fieldset[disabled] a.btn {
  pointer-events: none;
}
.btn-default {
  color: #ffffff;
  background-color: #aea79f; #important
  border-color: #aea79f;
}

.btn-default:focus,
.btn-default.focus {
  color: #ffffff;
  background-color: #978e83;
  border-color: #6f675e;
}

.btn-default:hover {
  color: #ffffff;
  background-color: #978e83;
  border-color: #92897e;
}
.btn-default:active,
.btn-default.active,
.btn-group > .btn:not(:first-child):not(:last-child):not(.dropdown-toggle) {
  border-radius: 0;
}
.btn-group > .btn:first-child {
  margin-left: 0;
}
.btn-group > .btn:first-child:not(:last-child):not(.dropdown-toggle) {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn:last-child:not(:first-child),
.btn-group > .dropdown-toggle:not(:first-child) {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group > .btn-group {
  float: left;
}
.btn-group > .btn-group:not(:first-child):not(:last-child) > .btn {
  border-radius: 0;
}
.btn-group > .btn-group:first-child:not(:last-child) > .btn:last-child,
.btn-group > .btn-group:first-child:not(:last-child) > .dropdown-toggle {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn-group:last-child:not(:first-child) > .btn:first-child {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group .dropdown-toggle:active,
.btn-group.open .dropdown-toggle {
  outline: 0;
}
.btn-group > .btn + .dropdown-toggle {
  padding-right: 8px;
  padding-left: 8px;
}
.btn-group > .btn-lg + .dropdown-toggle {
  padding-right: 12px;
  padding-left: 12px;
}
.btn-group.open .dropdown-toggle {
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn-group.open .dropdown-toggle.btn-link {
  box-shadow: none;
}

</style>
<script>
var str = '<div class="btn-group pull-right" style="position: fixed; right: 50px; top: 10px; z-index: 200"><button type="button" class="btn btn-default btn-xs dropdown-toggle" id="allCodeButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast=""><span>Code</span> <span class="caret"></span></button><ul class="dropdown-menu" style="min-width: 50px;"><li><a id="rmd-show-all-code" href="#">Show All Code</a></li><li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li></ul></div>';
document.write(str);
</script>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatial Data Science</a></li>

<li class="divider"></li>
<li><a href="index.html#preface">Preface<span></span></a><ul>
<li><a href="index.html#acknowledgements">Acknowledgements<span></span></a></li>
</ul></li>
<li class="part"><span><b>I Spatial Data<span></span></b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Getting Started<span></span></a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#a-first-map"><i class="fa fa-check"></i><b>1.1</b> A first map<span></span></a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#coordinate-reference-systems"><i class="fa fa-check"></i><b>1.2</b> Coordinate reference systems<span></span></a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#rasterize"><i class="fa fa-check"></i><b>1.3</b> Raster and vector data<span></span></a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#raster-types"><i class="fa fa-check"></i><b>1.4</b> Raster types<span></span></a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#time-series-arrays-data-cubes"><i class="fa fa-check"></i><b>1.5</b> Time series, arrays, data cubes<span></span></a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#support"><i class="fa fa-check"></i><b>1.6</b> Support<span></span></a></li>
<li class="chapter" data-level="1.7" data-path="intro.html"><a href="intro.html#spatial-data-science-software"><i class="fa fa-check"></i><b>1.7</b> Spatial data science software<span></span></a></li>
<li class="chapter" data-level="1.8" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>1.8</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cs.html"><a href="cs.html"><i class="fa fa-check"></i><b>2</b> Coordinates<span></span></a><ul>
<li class="chapter" data-level="2.1" data-path="cs.html"><a href="cs.html#units"><i class="fa fa-check"></i><b>2.1</b> Quantities, units, datum<span></span></a></li>
<li class="chapter" data-level="2.2" data-path="cs.html"><a href="cs.html#ellipsoidal-coordinates"><i class="fa fa-check"></i><b>2.2</b> Ellipsoidal coordinates<span></span></a></li>
<li class="chapter" data-level="2.3" data-path="cs.html"><a href="cs.html#crs"><i class="fa fa-check"></i><b>2.3</b> Coordinate Reference Systems<span></span></a></li>
<li class="chapter" data-level="2.4" data-path="cs.html"><a href="cs.html#projlib"><i class="fa fa-check"></i><b>2.4</b> PROJ and mapping accuracy<span></span></a></li>
<li class="chapter" data-level="2.5" data-path="cs.html"><a href="cs.html#wkt2"><i class="fa fa-check"></i><b>2.5</b> WKT-2<span></span></a></li>
<li class="chapter" data-level="2.6" data-path="cs.html"><a href="cs.html#exercises-1"><i class="fa fa-check"></i><b>2.6</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="geometries.html"><a href="geometries.html"><i class="fa fa-check"></i><b>3</b> Geometries<span></span></a><ul>
<li class="chapter" data-level="3.1" data-path="geometries.html"><a href="geometries.html#simplefeatures"><i class="fa fa-check"></i><b>3.1</b> Simple feature geometries<span></span></a></li>
<li class="chapter" data-level="3.2" data-path="geometries.html"><a href="geometries.html#opgeom"><i class="fa fa-check"></i><b>3.2</b> Operations on geometries<span></span></a></li>
<li class="chapter" data-level="3.3" data-path="geometries.html"><a href="geometries.html#precision"><i class="fa fa-check"></i><b>3.3</b> Precision<span></span></a></li>
<li class="chapter" data-level="3.4" data-path="geometries.html"><a href="geometries.html#coverages"><i class="fa fa-check"></i><b>3.4</b> Coverages: tessellations and rasters<span></span></a></li>
<li class="chapter" data-level="3.5" data-path="geometries.html"><a href="geometries.html#networks"><i class="fa fa-check"></i><b>3.5</b> Networks<span></span></a></li>
<li class="chapter" data-level="3.6" data-path="geometries.html"><a href="geometries.html#exercises-2"><i class="fa fa-check"></i><b>3.6</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spherical.html"><a href="spherical.html"><i class="fa fa-check"></i><b>4</b> Spherical Geometries<span></span></a><ul>
<li class="chapter" data-level="4.1" data-path="spherical.html"><a href="spherical.html#straight-lines"><i class="fa fa-check"></i><b>4.1</b> Straight lines<span></span></a></li>
<li class="chapter" data-level="4.2" data-path="spherical.html"><a href="spherical.html#ring-direction"><i class="fa fa-check"></i><b>4.2</b> Ring direction<span></span></a></li>
<li class="chapter" data-level="4.3" data-path="spherical.html"><a href="spherical.html#full-polygon"><i class="fa fa-check"></i><b>4.3</b> Full polygon<span></span></a></li>
<li class="chapter" data-level="4.4" data-path="spherical.html"><a href="spherical.html#bounding-box-rectangle-and-cap"><i class="fa fa-check"></i><b>4.4</b> Bounding box, rectangle, and cap<span></span></a></li>
<li class="chapter" data-level="4.5" data-path="spherical.html"><a href="spherical.html#validity-on-the-sphere"><i class="fa fa-check"></i><b>4.5</b> Validity on the sphere<span></span></a></li>
<li class="chapter" data-level="4.6" data-path="spherical.html"><a href="spherical.html#exercises-3"><i class="fa fa-check"></i><b>4.6</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="featureattributes.html"><a href="featureattributes.html"><i class="fa fa-check"></i><b>5</b> Attributes and Support<span></span></a><ul>
<li class="chapter" data-level="5.1" data-path="featureattributes.html"><a href="featureattributes.html#agr"><i class="fa fa-check"></i><b>5.1</b> Attribute-geometry relationships and support<span></span></a></li>
<li class="chapter" data-level="5.2" data-path="featureattributes.html"><a href="featureattributes.html#aggregating-and-summarising"><i class="fa fa-check"></i><b>5.2</b> Aggregating and summarising<span></span></a></li>
<li class="chapter" data-level="5.3" data-path="featureattributes.html"><a href="featureattributes.html#area-weighted"><i class="fa fa-check"></i><b>5.3</b> Area-weighted interpolation<span></span></a></li>
<li class="chapter" data-level="5.4" data-path="featureattributes.html"><a href="featureattributes.html#updownscaling"><i class="fa fa-check"></i><b>5.4</b> Up- and Downscaling<span></span></a></li>
<li class="chapter" data-level="5.5" data-path="featureattributes.html"><a href="featureattributes.html#exercises-4"><i class="fa fa-check"></i><b>5.5</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="datacube.html"><a href="datacube.html"><i class="fa fa-check"></i><b>6</b> Data Cubes<span></span></a><ul>
<li class="chapter" data-level="6.1" data-path="datacube.html"><a href="datacube.html#a-four-dimensional-data-cube"><i class="fa fa-check"></i><b>6.1</b> A four-dimensional data cube<span></span></a></li>
<li class="chapter" data-level="6.2" data-path="datacube.html"><a href="datacube.html#dimensions-attributes-and-support"><i class="fa fa-check"></i><b>6.2</b> Dimensions, attributes, and support<span></span></a></li>
<li class="chapter" data-level="6.3" data-path="datacube.html"><a href="datacube.html#dcoperations"><i class="fa fa-check"></i><b>6.3</b> Operations on data cubes<span></span></a></li>
<li class="chapter" data-level="6.4" data-path="datacube.html"><a href="datacube.html#vectordatacubes"><i class="fa fa-check"></i><b>6.4</b> Aggregating raster to vector cubes<span></span></a></li>
<li class="chapter" data-level="6.5" data-path="datacube.html"><a href="datacube.html#switching"><i class="fa fa-check"></i><b>6.5</b> Switching dimension with attributes<span></span></a></li>
<li class="chapter" data-level="6.6" data-path="datacube.html"><a href="datacube.html#otherdynamic"><i class="fa fa-check"></i><b>6.6</b> Other dynamic spatial data<span></span></a></li>
<li class="chapter" data-level="6.7" data-path="datacube.html"><a href="datacube.html#exercises-5"><i class="fa fa-check"></i><b>6.7</b> Exercises<span></span></a></li>
</ul></li>
<li class="part"><span><b>II R for Spatial Data Science<span></span></b></span></li>
<li class="chapter" data-level="7" data-path="sf.html"><a href="sf.html"><i class="fa fa-check"></i><b>7</b> Introduction to sf and stars<span></span></a><ul>
<li class="chapter" data-level="7.1" data-path="sf.html"><a href="sf.html#sfintro"><i class="fa fa-check"></i><b>7.1</b> Package <code>sf</code><span></span></a></li>
<li class="chapter" data-level="7.2" data-path="sf.html"><a href="sf.html#spatial-joins"><i class="fa fa-check"></i><b>7.2</b> Spatial joins<span></span></a></li>
<li class="chapter" data-level="7.3" data-path="sf.html"><a href="sf.html#package-stars"><i class="fa fa-check"></i><b>7.3</b> Package <code>stars</code><span></span></a></li>
<li class="chapter" data-level="7.4" data-path="sf.html"><a href="sf.html#vector-data-cube-examples"><i class="fa fa-check"></i><b>7.4</b> Vector data cube examples<span></span></a></li>
<li class="chapter" data-level="7.5" data-path="sf.html"><a href="sf.html#raster-to-vector"><i class="fa fa-check"></i><b>7.5</b> raster-to-vector, vector-to-raster<span></span></a></li>
<li class="chapter" data-level="7.6" data-path="sf.html"><a href="sf.html#projsf"><i class="fa fa-check"></i><b>7.6</b> Coordinate transformations and conversions<span></span></a></li>
<li class="chapter" data-level="7.7" data-path="sf.html"><a href="sf.html#warp"><i class="fa fa-check"></i><b>7.7</b> Transforming and warping rasters<span></span></a></li>
<li class="chapter" data-level="7.8" data-path="sf.html"><a href="sf.html#exercises-6"><i class="fa fa-check"></i><b>7.8</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="large.html"><a href="large.html"><i class="fa fa-check"></i><b>8</b> Large data sets<span></span></a><ul>
<li class="chapter" data-level="8.1" data-path="large.html"><a href="large.html#largesf"><i class="fa fa-check"></i><b>8.1</b> Vector data: <code>sf</code><span></span></a></li>
<li class="chapter" data-level="8.2" data-path="large.html"><a href="large.html#raster-data-stars"><i class="fa fa-check"></i><b>8.2</b> Raster data: <code>stars</code><span></span></a></li>
<li class="chapter" data-level="8.3" data-path="large.html"><a href="large.html#very-large-data-cubes"><i class="fa fa-check"></i><b>8.3</b> Very large data cubes<span></span></a></li>
<li class="chapter" data-level="8.4" data-path="large.html"><a href="large.html#exercises-7"><i class="fa fa-check"></i><b>8.4</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>9</b> Plotting spatial data<span></span></a><ul>
<li class="chapter" data-level="9.1" data-path="plotting.html"><a href="plotting.html#transform"><i class="fa fa-check"></i><b>9.1</b> Every plot is a projection<span></span></a></li>
<li class="chapter" data-level="9.2" data-path="plotting.html"><a href="plotting.html#plotting-points-lines-polygons-grid-cells"><i class="fa fa-check"></i><b>9.2</b> Plotting points, lines, polygons, grid cells<span></span></a></li>
<li class="chapter" data-level="9.3" data-path="plotting.html"><a href="plotting.html#base-plot"><i class="fa fa-check"></i><b>9.3</b> Base <code>plot</code><span></span></a></li>
<li class="chapter" data-level="9.4" data-path="plotting.html"><a href="plotting.html#geomsf"><i class="fa fa-check"></i><b>9.4</b> Maps with <code>ggplot2</code><span></span></a></li>
<li class="chapter" data-level="9.5" data-path="plotting.html"><a href="plotting.html#tmap"><i class="fa fa-check"></i><b>9.5</b> Maps with <code>tmap</code><span></span></a></li>
<li class="chapter" data-level="9.6" data-path="plotting.html"><a href="plotting.html#interactive-maps-leaflet-mapview-tmap"><i class="fa fa-check"></i><b>9.6</b> Interactive maps: <code>leaflet</code>, <code>mapview</code>, <code>tmap</code><span></span></a></li>
<li class="chapter" data-level="9.7" data-path="plotting.html"><a href="plotting.html#exercises-8"><i class="fa fa-check"></i><b>9.7</b> Exercises<span></span></a></li>
</ul></li>
<li class="part"><span><b>III Models for Spatial Data<span></span></b></span></li>
<li class="chapter" data-level="10" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html"><i class="fa fa-check"></i><b>10</b> Statistical modelling of spatial data<span></span></a><ul>
<li class="chapter" data-level="10.1" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#design"><i class="fa fa-check"></i><b>10.1</b> Design-based and model-based inference<span></span></a></li>
<li class="chapter" data-level="10.2" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#predictive-models-with-coordinates"><i class="fa fa-check"></i><b>10.2</b> Predictive models with coordinates<span></span></a></li>
<li class="chapter" data-level="10.3" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#further-reading"><i class="fa fa-check"></i><b>10.3</b> Further reading<span></span></a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="pointpatterns.html"><a href="pointpatterns.html"><i class="fa fa-check"></i><b>11</b> Point Pattern Analysis<span></span></a><ul>
<li class="chapter" data-level="11.1" data-path="pointpatterns.html"><a href="pointpatterns.html#observation-window"><i class="fa fa-check"></i><b>11.1</b> Observation window<span></span></a></li>
<li class="chapter" data-level="11.2" data-path="pointpatterns.html"><a href="pointpatterns.html#coordinate-reference-systems-1"><i class="fa fa-check"></i><b>11.2</b> Coordinate reference systems<span></span></a></li>
<li class="chapter" data-level="11.3" data-path="pointpatterns.html"><a href="pointpatterns.html#marked-point-patterns-points-on-linear-networks"><i class="fa fa-check"></i><b>11.3</b> Marked point patterns, points on linear networks<span></span></a></li>
<li class="chapter" data-level="11.4" data-path="pointpatterns.html"><a href="pointpatterns.html#spatial-sampling-and-simulating-a-point-process"><i class="fa fa-check"></i><b>11.4</b> Spatial sampling and simulating a point process<span></span></a></li>
<li class="chapter" data-level="11.5" data-path="pointpatterns.html"><a href="pointpatterns.html#simulating-points-on-the-globe"><i class="fa fa-check"></i><b>11.5</b> Simulating points on the globe<span></span></a></li>
<li class="chapter" data-level="11.6" data-path="pointpatterns.html"><a href="pointpatterns.html#exercises-9"><i class="fa fa-check"></i><b>11.6</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="interpolation.html"><a href="interpolation.html"><i class="fa fa-check"></i><b>12</b> Spatial Interpolation<span></span></a><ul>
<li class="chapter" data-level="12.1" data-path="interpolation.html"><a href="interpolation.html#a-first-dataset"><i class="fa fa-check"></i><b>12.1</b> A first dataset<span></span></a></li>
<li class="chapter" data-level="12.2" data-path="interpolation.html"><a href="interpolation.html#sample-variogram"><i class="fa fa-check"></i><b>12.2</b> Sample variogram<span></span></a></li>
<li class="chapter" data-level="12.3" data-path="interpolation.html"><a href="interpolation.html#fitting-variogram-models"><i class="fa fa-check"></i><b>12.3</b> Fitting variogram models<span></span></a></li>
<li class="chapter" data-level="12.4" data-path="interpolation.html"><a href="interpolation.html#kriging"><i class="fa fa-check"></i><b>12.4</b> Kriging interpolation<span></span></a></li>
<li class="chapter" data-level="12.5" data-path="interpolation.html"><a href="interpolation.html#blockkriging"><i class="fa fa-check"></i><b>12.5</b> Areal means: block kriging<span></span></a></li>
<li class="chapter" data-level="12.6" data-path="interpolation.html"><a href="interpolation.html#conditional-simulation"><i class="fa fa-check"></i><b>12.6</b> Conditional simulation<span></span></a></li>
<li class="chapter" data-level="12.7" data-path="interpolation.html"><a href="interpolation.html#trend-models"><i class="fa fa-check"></i><b>12.7</b> Trend models<span></span></a></li>
<li class="chapter" data-level="12.8" data-path="interpolation.html"><a href="interpolation.html#exercises-10"><i class="fa fa-check"></i><b>12.8</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="stgeostatistics.html"><a href="stgeostatistics.html"><i class="fa fa-check"></i><b>13</b> Multivariate and Spatiotemporal Geostatistics<span></span></a><ul>
<li class="chapter" data-level="13.1" data-path="stgeostatistics.html"><a href="stgeostatistics.html#preparing"><i class="fa fa-check"></i><b>13.1</b> Preparing the air quality dataset<span></span></a></li>
<li class="chapter" data-level="13.2" data-path="stgeostatistics.html"><a href="stgeostatistics.html#cokriging"><i class="fa fa-check"></i><b>13.2</b> Multivariable geostatistics<span></span></a></li>
<li class="chapter" data-level="13.3" data-path="stgeostatistics.html"><a href="stgeostatistics.html#spatiotemporal-geostatistics"><i class="fa fa-check"></i><b>13.3</b> Spatiotemporal geostatistics<span></span></a></li>
<li class="chapter" data-level="13.4" data-path="stgeostatistics.html"><a href="stgeostatistics.html#exercises-11"><i class="fa fa-check"></i><b>13.4</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="area.html"><a href="area.html"><i class="fa fa-check"></i><b>14</b> Proximity and Areal Data<span></span></a><ul>
<li class="chapter" data-level="14.1" data-path="area.html"><a href="area.html#representing-proximity-in-spdep"><i class="fa fa-check"></i><b>14.1</b> Representing proximity in <strong>spdep</strong><span></span></a></li>
<li class="chapter" data-level="14.2" data-path="area.html"><a href="area.html#contiguous-neighbours"><i class="fa fa-check"></i><b>14.2</b> Contiguous neighbours<span></span></a></li>
<li class="chapter" data-level="14.3" data-path="area.html"><a href="area.html#graph-based-neighbours"><i class="fa fa-check"></i><b>14.3</b> Graph-based neighbours<span></span></a></li>
<li class="chapter" data-level="14.4" data-path="area.html"><a href="area.html#distance-based-neighbours"><i class="fa fa-check"></i><b>14.4</b> Distance-based neighbours<span></span></a></li>
<li class="chapter" data-level="14.5" data-path="area.html"><a href="area.html#weights-specification"><i class="fa fa-check"></i><b>14.5</b> Weights specification<span></span></a></li>
<li class="chapter" data-level="14.6" data-path="area.html"><a href="area.html#higher-order-neighbours"><i class="fa fa-check"></i><b>14.6</b> Higher order neighbours<span></span></a></li>
<li class="chapter" data-level="14.7" data-path="area.html"><a href="area.html#exercises-12"><i class="fa fa-check"></i><b>14.7</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="spatautocorr.html"><a href="spatautocorr.html"><i class="fa fa-check"></i><b>15</b> Measures of spatial autocorrelation<span></span></a><ul>
<li class="chapter" data-level="15.1" data-path="spatautocorr.html"><a href="spatautocorr.html#measures-and-process-mis-specification"><i class="fa fa-check"></i><b>15.1</b> Measures and process mis-specification<span></span></a></li>
<li class="chapter" data-level="15.2" data-path="spatautocorr.html"><a href="spatautocorr.html#global-measures"><i class="fa fa-check"></i><b>15.2</b> Global measures<span></span></a></li>
<li class="chapter" data-level="15.3" data-path="spatautocorr.html"><a href="spatautocorr.html#local-measures"><i class="fa fa-check"></i><b>15.3</b> Local measures<span></span></a></li>
<li class="chapter" data-level="15.4" data-path="spatautocorr.html"><a href="spatautocorr.html#exercises-13"><i class="fa fa-check"></i><b>15.4</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="spatglmm.html"><a href="spatglmm.html"><i class="fa fa-check"></i><b>16</b> Spatial Regression<span></span></a><ul>
<li class="chapter" data-level="16.1" data-path="spatglmm.html"><a href="spatglmm.html#markov-random-field-and-multilevel-models-with-spatial-weights"><i class="fa fa-check"></i><b>16.1</b> Markov random field and multilevel models with spatial weights<span></span></a></li>
<li class="chapter" data-level="16.2" data-path="spatglmm.html"><a href="spatglmm.html#multilevel-models-of-the-boston-data-set"><i class="fa fa-check"></i><b>16.2</b> Multilevel models of the Boston data set<span></span></a></li>
<li class="chapter" data-level="16.3" data-path="spatglmm.html"><a href="spatglmm.html#exercises-14"><i class="fa fa-check"></i><b>16.3</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="spatecon.html"><a href="spatecon.html"><i class="fa fa-check"></i><b>17</b> Spatial econometrics models<span></span></a><ul>
<li class="chapter" data-level="17.1" data-path="spatecon.html"><a href="spatecon.html#spatial-econometric-models-definitions"><i class="fa fa-check"></i><b>17.1</b> Spatial econometric models: definitions<span></span></a></li>
<li class="chapter" data-level="17.2" data-path="spatecon.html"><a href="spatecon.html#maximum-likelihood-estimation-in-spatialreg"><i class="fa fa-check"></i><b>17.2</b> Maximum likelihood estimation in <strong>spatialreg</strong><span></span></a></li>
<li class="chapter" data-level="17.3" data-path="spatecon.html"><a href="spatecon.html#impacts"><i class="fa fa-check"></i><b>17.3</b> Impacts<span></span></a></li>
<li class="chapter" data-level="17.4" data-path="spatecon.html"><a href="spatecon.html#spateconpred"><i class="fa fa-check"></i><b>17.4</b> Predictions<span></span></a></li>
<li class="chapter" data-level="17.5" data-path="spatecon.html"><a href="spatecon.html#exercises-15"><i class="fa fa-check"></i><b>17.5</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="older.html"><a href="older.html"><i class="fa fa-check"></i><b>18</b> Older R Spatial Packages<span></span></a><ul>
<li class="chapter" data-level="18.1" data-path="older.html"><a href="older.html#retire"><i class="fa fa-check"></i><b>18.1</b> Retiring <code>rgdal</code> and <code>rgeos</code><span></span></a></li>
<li class="chapter" data-level="18.2" data-path="older.html"><a href="older.html#links-and-differences-between-sf-and-sp"><i class="fa fa-check"></i><b>18.2</b> Links and differences between sf and sp<span></span></a></li>
<li class="chapter" data-level="18.3" data-path="older.html"><a href="older.html#migration-code-and-packages"><i class="fa fa-check"></i><b>18.3</b> Migration code and packages<span></span></a></li>
<li class="chapter" data-level="18.4" data-path="older.html"><a href="older.html#package-raster-and-terra"><i class="fa fa-check"></i><b>18.4</b> Package raster and terra<span></span></a></li>
</ul></li>
<li><a href="all-r-code-in-this-book.html#all-r-code-in-this-book">All R code in this book<span></span></a></li>
<li><a href="r-basics.html#r-basics">R basics<span></span></a><ul>
<li><a href="r-basics.html#pipes">Pipes<span></span></a></li>
<li><a href="r-basics.html#data-structures">Data structures<span></span></a></li>
<li><a href="r-basics.html#dissecting-a-multipolygon">dissecting a <code>MULTIPOLYGON</code><span></span></a></li>
</ul></li>
<li><a href="references.html#references">References<span></span></a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="all-r-code-in-this-book" class="section level1 unnumbered hasAnchor">
<h1>All R code in this book<a href="all-r-code-in-this-book.html#all-r-code-in-this-book" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div class="sourceCode" id="cb753"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb753-1" title="1"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-2" title="2"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-3" title="3"></a>
<a class="sourceLine" id="cb753-4" title="4">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-5" title="5">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-6" title="6">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-7" title="7">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-8" title="8"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-9" title="9">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-10" title="10"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-11" title="11"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-12" title="12"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-13" title="13">)</a>
<a class="sourceLine" id="cb753-14" title="14"></a>
<a class="sourceLine" id="cb753-15" title="15"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-16" title="16"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-17" title="17">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-18" title="18"></a>
<a class="sourceLine" id="cb753-19" title="19"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-20" title="20"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-21" title="21"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-22" title="22">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-23" title="23">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-24" title="24">knitr<span class="op">::</span><span class="kw">write_bib</span>(<span class="kw">c</span>(</a>
<a class="sourceLine" id="cb753-25" title="25">  <span class="st">&quot;abind&quot;</span>,</a>
<a class="sourceLine" id="cb753-26" title="26">  <span class="st">&quot;classInt&quot;</span>,</a>
<a class="sourceLine" id="cb753-27" title="27">  <span class="st">&quot;colorspace&quot;</span>,</a>
<a class="sourceLine" id="cb753-28" title="28">  <span class="st">&quot;dbscan&quot;</span>,</a>
<a class="sourceLine" id="cb753-29" title="29">  <span class="st">&quot;dbscan&quot;</span>,</a>
<a class="sourceLine" id="cb753-30" title="30">  <span class="st">&quot;ecmwfr&quot;</span>,</a>
<a class="sourceLine" id="cb753-31" title="31">  <span class="st">&quot;gdalcubes&quot;</span>,</a>
<a class="sourceLine" id="cb753-32" title="32">  <span class="st">&quot;gdalUtils&quot;</span>,</a>
<a class="sourceLine" id="cb753-33" title="33">  <span class="st">&quot;ggplot2&quot;</span>,</a>
<a class="sourceLine" id="cb753-34" title="34">  <span class="st">&quot;ggspatial&quot;</span>,</a>
<a class="sourceLine" id="cb753-35" title="35">  <span class="st">&quot;gstat&quot;</span>,</a>
<a class="sourceLine" id="cb753-36" title="36">  <span class="st">&quot;hglm&quot;</span>,</a>
<a class="sourceLine" id="cb753-37" title="37">  <span class="st">&quot;HSAR&quot;</span>,</a>
<a class="sourceLine" id="cb753-38" title="38">  <span class="st">&quot;igraph&quot;</span>,</a>
<a class="sourceLine" id="cb753-39" title="39">  <span class="st">&quot;INLA&quot;</span>,</a>
<a class="sourceLine" id="cb753-40" title="40">  <span class="st">&quot;lme4&quot;</span>,</a>
<a class="sourceLine" id="cb753-41" title="41">  <span class="st">&quot;lwgeom&quot;</span>,</a>
<a class="sourceLine" id="cb753-42" title="42">  <span class="st">&quot;mapsf&quot;</span>,</a>
<a class="sourceLine" id="cb753-43" title="43">  <span class="st">&quot;mapview&quot;</span>,</a>
<a class="sourceLine" id="cb753-44" title="44">  <span class="st">&quot;Matrix&quot;</span>,</a>
<a class="sourceLine" id="cb753-45" title="45">  <span class="st">&quot;mgcv&quot;</span>,</a>
<a class="sourceLine" id="cb753-46" title="46">  <span class="st">&quot;osmar&quot;</span>, </a>
<a class="sourceLine" id="cb753-47" title="47">  <span class="st">&quot;R2BayesX&quot;</span>,</a>
<a class="sourceLine" id="cb753-48" title="48">  <span class="st">&quot;raster&quot;</span>,</a>
<a class="sourceLine" id="cb753-49" title="49">  <span class="st">&quot;RColorBrewer&quot;</span>,</a>
<a class="sourceLine" id="cb753-50" title="50">  <span class="st">&quot;rgee&quot;</span>,</a>
<a class="sourceLine" id="cb753-51" title="51">  <span class="st">&quot;rgeoda&quot;</span>,</a>
<a class="sourceLine" id="cb753-52" title="52">  <span class="st">&quot;rnaturalearth&quot;</span>,</a>
<a class="sourceLine" id="cb753-53" title="53">  <span class="st">&quot;rstac&quot;</span>,</a>
<a class="sourceLine" id="cb753-54" title="54">  <span class="st">&quot;s2&quot;</span>,</a>
<a class="sourceLine" id="cb753-55" title="55">  <span class="st">&quot;sfnetworks&quot;</span>,</a>
<a class="sourceLine" id="cb753-56" title="56">  <span class="st">&quot;sf&quot;</span>, </a>
<a class="sourceLine" id="cb753-57" title="57">  <span class="st">&quot;sp&quot;</span>,</a>
<a class="sourceLine" id="cb753-58" title="58">  <span class="st">&quot;spacetime&quot;</span>,</a>
<a class="sourceLine" id="cb753-59" title="59">  <span class="st">&quot;spatialreg&quot;</span>,</a>
<a class="sourceLine" id="cb753-60" title="60">  <span class="st">&quot;spatstat&quot;</span>,</a>
<a class="sourceLine" id="cb753-61" title="61">  <span class="st">&quot;spData&quot;</span>,</a>
<a class="sourceLine" id="cb753-62" title="62">  <span class="st">&quot;spdep&quot;</span>,</a>
<a class="sourceLine" id="cb753-63" title="63">  <span class="st">&quot;splm&quot;</span>,</a>
<a class="sourceLine" id="cb753-64" title="64">  <span class="st">&quot;stars&quot;</span>,</a>
<a class="sourceLine" id="cb753-65" title="65">  <span class="st">&quot;stcos&quot;</span>,</a>
<a class="sourceLine" id="cb753-66" title="66">  <span class="st">&quot;stplanr&quot;</span>, </a>
<a class="sourceLine" id="cb753-67" title="67">  <span class="st">&quot;terra&quot;</span>,</a>
<a class="sourceLine" id="cb753-68" title="68">  <span class="st">&quot;tidyverse&quot;</span>,</a>
<a class="sourceLine" id="cb753-69" title="69">  <span class="st">&quot;tmap&quot;</span>,</a>
<a class="sourceLine" id="cb753-70" title="70">  <span class="st">&quot;tsibble&quot;</span>,</a>
<a class="sourceLine" id="cb753-71" title="71">  <span class="st">&quot;units&quot;</span>,</a>
<a class="sourceLine" id="cb753-72" title="72">  <span class="st">&quot;viridis&quot;</span></a>
<a class="sourceLine" id="cb753-73" title="73"></a>
<a class="sourceLine" id="cb753-74" title="74">  ), <span class="st">&quot;packages.bib&quot;</span>, <span class="dt">width =</span> <span class="dv">60</span>)</a>
<a class="sourceLine" id="cb753-75" title="75">The first part of this book introduces concepts of spatial data science,</a>
<a class="sourceLine" id="cb753-76" title="76">and uses R only to generate text output or figures. The R code used <span class="cf">for</span></a>
<a class="sourceLine" id="cb753-77" title="77">this is not shown, as it would distract from the message. The online</a>
<a class="sourceLine" id="cb753-78" title="78">version of this book contains the R sections, which can be unfolded</a>
<a class="sourceLine" id="cb753-79" title="79">on demand and copied into the clipboard <span class="cf">for</span> execution and experimenting.</a>
<a class="sourceLine" id="cb753-80" title="80">The second part of this book explains how the concepts introduced <span class="cf">in</span></a>
<a class="sourceLine" id="cb753-81" title="81">part I are dealt with using R, and deals with basic handling and plotting</a>
<a class="sourceLine" id="cb753-82" title="82">of spatial and spatiotemporal data. Part III is dedicated to statistical</a>
<a class="sourceLine" id="cb753-83" title="83">modelling of spatial data.</a>
<a class="sourceLine" id="cb753-84" title="84">This work is licensed under the</a>
<a class="sourceLine" id="cb753-85" title="85">[Attribution<span class="op">-</span>NonCommercial<span class="op">-</span>NoDerivatives</a>
<a class="sourceLine" id="cb753-86" title="86"><span class="fl">4.0</span>](https<span class="op">:</span><span class="er">//</span>creativecommons.org<span class="op">/</span>licenses<span class="op">/</span>by<span class="op">-</span>nc<span class="op">-</span>nd<span class="op">/</span><span class="fl">4.0</span><span class="op">/</span>legalcode)</a>
<a class="sourceLine" id="cb753-87" title="87">International License.</a>
<a class="sourceLine" id="cb753-88" title="88"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-89" title="89"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-90" title="90"></a>
<a class="sourceLine" id="cb753-91" title="91">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-92" title="92">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-93" title="93">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-94" title="94">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-95" title="95"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-96" title="96">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-97" title="97"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-98" title="98"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-99" title="99"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-100" title="100">)</a>
<a class="sourceLine" id="cb753-101" title="101"></a>
<a class="sourceLine" id="cb753-102" title="102"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-103" title="103"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-104" title="104">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-105" title="105"></a>
<a class="sourceLine" id="cb753-106" title="106"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-107" title="107"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-108" title="108"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-109" title="109">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-110" title="110">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-111" title="111">Text introducing Part I</a>
<a class="sourceLine" id="cb753-112" title="112"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb753-113" title="113"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-114" title="114"><span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-115" title="115"><span class="st">    </span><span class="kw">read_sf</span>() -&gt;<span class="st"> </span>nc</a>
<a class="sourceLine" id="cb753-116" title="116">nc<span class="fl">.32119</span> &lt;-<span class="st"> </span><span class="kw">st_transform</span>(nc, <span class="st">&#39;EPSG:32119&#39;</span>)</a>
<a class="sourceLine" id="cb753-117" title="117">nc<span class="fl">.32119</span> <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-118" title="118"><span class="st">    </span><span class="kw">select</span>(BIR74) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-119" title="119"><span class="st">    </span><span class="kw">plot</span>(<span class="dt">graticule =</span> <span class="ot">TRUE</span>, <span class="dt">axes =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-120" title="120">nc <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(AREA, BIR74, SID74) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>(<span class="dt">n =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-121" title="121">year_labels =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SID74&quot;</span> =<span class="st"> &quot;1974 - 1978&quot;</span>, <span class="st">&quot;SID79&quot;</span> =<span class="st"> &quot;1979 - 1984&quot;</span>)</a>
<a class="sourceLine" id="cb753-122" title="122">nc<span class="fl">.32119</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID74, SID79) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-123" title="123"><span class="st">    </span><span class="kw">pivot_longer</span>(<span class="kw">starts_with</span>(<span class="st">&quot;SID&quot;</span>)) -&gt;<span class="st"> </span>nc_longer</a>
<a class="sourceLine" id="cb753-124" title="124"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> nc_longer, <span class="kw">aes</span>(<span class="dt">fill =</span> value)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-125" title="125"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>name, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">labeller =</span> <span class="kw">labeller</span>(<span class="dt">name =</span> year_labels)) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-126" title="126"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="dv">34</span><span class="op">:</span><span class="dv">36</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-127" title="127"><span class="st">  </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors =</span> <span class="kw">sf.colors</span>(<span class="dv">20</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-128" title="128"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid.major =</span> <span class="kw">element_line</span>(<span class="dt">color =</span> <span class="st">&quot;white&quot;</span>))</a>
<a class="sourceLine" id="cb753-129" title="129"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(mapview))</a>
<a class="sourceLine" id="cb753-130" title="130"><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-131" title="131">nc<span class="fl">.32119</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mapview</span>(<span class="dt">zcol =</span> <span class="st">&quot;BIR74&quot;</span>, <span class="dt">legend =</span> <span class="ot">TRUE</span>, <span class="dt">col.regions =</span> sf.colors)</a>
<a class="sourceLine" id="cb753-132" title="132"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb753-133" title="133"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-134" title="134"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">1</span>, <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb753-135" title="135">tif &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</a>
<a class="sourceLine" id="cb753-136" title="136">x &lt;-<span class="st"> </span><span class="kw">read_stars</span>(tif)[,,,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb753-137" title="137"><span class="kw">image</span>(x, <span class="dt">main =</span> <span class="st">&quot;(a)&quot;</span>)</a>
<a class="sourceLine" id="cb753-138" title="138"><span class="kw">image</span>(x[,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>], <span class="dt">text_values =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="st">&#39;grey&#39;</span>, <span class="dt">main =</span> <span class="st">&quot;(b)&quot;</span>)</a>
<a class="sourceLine" id="cb753-139" title="139"><span class="kw">image</span>(x, <span class="dt">main =</span> <span class="st">&quot;(c)&quot;</span>)</a>
<a class="sourceLine" id="cb753-140" title="140"><span class="kw">set.seed</span>(<span class="dv">131</span>)</a>
<a class="sourceLine" id="cb753-141" title="141">pts =<span class="st"> </span><span class="kw">st_sample</span>(<span class="kw">st_as_sfc</span>(<span class="kw">st_bbox</span>(x)), <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-142" title="142"><span class="kw">plot</span>(pts, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">pch =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</a>
<a class="sourceLine" id="cb753-143" title="143"><span class="kw">image</span>(x, <span class="dt">main =</span> <span class="st">&quot;(d)&quot;</span>)</a>
<a class="sourceLine" id="cb753-144" title="144"><span class="kw">plot</span>(<span class="kw">st_buffer</span>(pts, <span class="dv">500</span>), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">pch =</span> <span class="dv">3</span>, <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-145" title="145"><span class="kw">st_extract</span>(x, pts)</a>
<a class="sourceLine" id="cb753-146" title="146"><span class="kw">aggregate</span>(x, <span class="kw">st_buffer</span>(pts, <span class="dv">500</span>), <span class="dt">FUN =</span> mean) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_as_sf</span>()</a>
<a class="sourceLine" id="cb753-147" title="147"><span class="kw">plot</span>(<span class="kw">st_rasterize</span>(nc[<span class="st">&quot;BIR74&quot;</span>], <span class="dt">dx =</span> <span class="fl">0.1</span>), <span class="dt">col =</span> <span class="kw">sf.colors</span>(), <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>)</a>
<a class="sourceLine" id="cb753-148" title="148">x =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">5</span></a>
<a class="sourceLine" id="cb753-149" title="149">y =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">4</span></a>
<a class="sourceLine" id="cb753-150" title="150">d =<span class="st"> </span><span class="kw">st_dimensions</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">.raster =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>))</a>
<a class="sourceLine" id="cb753-151" title="151">m =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">runif</span>(<span class="dv">20</span>),<span class="dv">5</span>,<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb753-152" title="152">r1 =<span class="st"> </span><span class="kw">st_as_stars</span>(<span class="dt">r =</span> m, <span class="dt">dimensions =</span> d)</a>
<a class="sourceLine" id="cb753-153" title="153"></a>
<a class="sourceLine" id="cb753-154" title="154">r =<span class="st"> </span><span class="kw">attr</span>(d, <span class="st">&quot;raster&quot;</span>)</a>
<a class="sourceLine" id="cb753-155" title="155">r<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.2</span>, <span class="fl">-0.2</span>)</a>
<a class="sourceLine" id="cb753-156" title="156"><span class="kw">attr</span>(d, <span class="st">&quot;raster&quot;</span>) =<span class="st"> </span>r</a>
<a class="sourceLine" id="cb753-157" title="157">r2 =<span class="st"> </span><span class="kw">st_as_stars</span>(<span class="dt">r =</span> m, <span class="dt">dimensions =</span> d)</a>
<a class="sourceLine" id="cb753-158" title="158"></a>
<a class="sourceLine" id="cb753-159" title="159">r =<span class="st"> </span><span class="kw">attr</span>(d, <span class="st">&quot;raster&quot;</span>)</a>
<a class="sourceLine" id="cb753-160" title="160">r<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">-0.3</span>)</a>
<a class="sourceLine" id="cb753-161" title="161"><span class="kw">attr</span>(d, <span class="st">&quot;raster&quot;</span>) =<span class="st"> </span>r</a>
<a class="sourceLine" id="cb753-162" title="162">r3 =<span class="st"> </span><span class="kw">st_as_stars</span>(<span class="dt">r =</span> m, <span class="dt">dimensions =</span> d)</a>
<a class="sourceLine" id="cb753-163" title="163"></a>
<a class="sourceLine" id="cb753-164" title="164">x =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="fl">3.5</span>, <span class="dv">5</span>, <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-165" title="165">y =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">1.5</span>, <span class="dv">3</span>, <span class="fl">3.5</span>)</a>
<a class="sourceLine" id="cb753-166" title="166">d =<span class="st"> </span><span class="kw">st_dimensions</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">.raster =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>))</a>
<a class="sourceLine" id="cb753-167" title="167">r4 =<span class="st"> </span><span class="kw">st_as_stars</span>(<span class="dt">r =</span> m, <span class="dt">dimensions =</span> d)</a>
<a class="sourceLine" id="cb753-168" title="168"></a>
<a class="sourceLine" id="cb753-169" title="169">grd =<span class="st"> </span><span class="kw">st_make_grid</span>(<span class="dt">cellsize =</span> <span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">10</span>), <span class="dt">offset =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">130</span>,<span class="dv">10</span>), <span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">8</span>,<span class="dv">5</span>), <span class="dt">crs =</span> <span class="kw">st_crs</span>(<span class="dv">4326</span>))</a>
<a class="sourceLine" id="cb753-170" title="170">r5 =<span class="st"> </span><span class="kw">st_transform</span>(grd, <span class="st">&quot;+proj=laea +lon_0=-70 +lat_0=35&quot;</span>)</a>
<a class="sourceLine" id="cb753-171" title="171"></a>
<a class="sourceLine" id="cb753-172" title="172"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="fl">0.1</span>, <span class="dv">1</span>, <span class="fl">1.1</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb753-173" title="173">r1 =<span class="st"> </span><span class="kw">st_make_grid</span>(<span class="dt">cellsize =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">4</span>), <span class="dt">offset =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb753-174" title="174"><span class="kw">plot</span>(r1, <span class="dt">main =</span> <span class="st">&quot;regular&quot;</span>)</a>
<a class="sourceLine" id="cb753-175" title="175"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(<span class="kw">st_as_sf</span>(r2)), <span class="dt">main =</span> <span class="st">&quot;rotated&quot;</span>)</a>
<a class="sourceLine" id="cb753-176" title="176"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(<span class="kw">st_as_sf</span>(r3)), <span class="dt">main =</span> <span class="st">&quot;sheared&quot;</span>)</a>
<a class="sourceLine" id="cb753-177" title="177"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(<span class="kw">st_as_sf</span>(r4, <span class="dt">as_points =</span> <span class="ot">FALSE</span>)), <span class="dt">main =</span> <span class="st">&quot;rectilinear&quot;</span>)</a>
<a class="sourceLine" id="cb753-178" title="178"><span class="kw">plot</span>(<span class="kw">st_geometry</span>((r5)), <span class="dt">main =</span> <span class="st">&quot;curvilinear&quot;</span>)</a>
<a class="sourceLine" id="cb753-179" title="179">knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/sf_deps.png&quot;</span>)</a>
<a class="sourceLine" id="cb753-180" title="180"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-181" title="181"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-182" title="182"></a>
<a class="sourceLine" id="cb753-183" title="183">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-184" title="184">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-185" title="185">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-186" title="186">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-187" title="187"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-188" title="188">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-189" title="189"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-190" title="190"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-191" title="191"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-192" title="192">)</a>
<a class="sourceLine" id="cb753-193" title="193"></a>
<a class="sourceLine" id="cb753-194" title="194"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-195" title="195"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-196" title="196">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-197" title="197"></a>
<a class="sourceLine" id="cb753-198" title="198"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-199" title="199"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-200" title="200"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-201" title="201">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-202" title="202">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-203" title="203"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb753-204" title="204"><span class="kw">plot</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">6</span>,<span class="dv">6</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">6</span>,<span class="dv">6</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-205" title="205"><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">pos =</span> <span class="dv">0</span>, <span class="dt">at =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-206" title="206"><span class="kw">axis</span>(<span class="dv">2</span>, <span class="dt">pos =</span> <span class="dv">0</span>, <span class="dt">at =</span> <span class="dv">-6</span><span class="op">:</span><span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-207" title="207">xd =<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="dt">by =</span> <span class="fl">.1</span>)</a>
<a class="sourceLine" id="cb753-208" title="208"><span class="kw">lines</span>(xd, <span class="kw">sqrt</span>(<span class="dv">25</span> <span class="op">-</span><span class="st"> </span>xd<span class="op">^</span><span class="dv">2</span>), <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-209" title="209"><span class="kw">lines</span>(xd, <span class="op">-</span><span class="kw">sqrt</span>(<span class="dv">25</span> <span class="op">-</span><span class="st"> </span>xd<span class="op">^</span><span class="dv">2</span>), <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-210" title="210"><span class="kw">arrows</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">length =</span> <span class="fl">.15</span>, <span class="dt">angle =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb753-211" title="211"><span class="kw">text</span>(<span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="dt">label =</span> <span class="st">&quot;r&quot;</span>, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb753-212" title="212">xd =<span class="st"> </span><span class="kw">seq</span>(<span class="dv">3</span><span class="op">/</span><span class="dv">5</span>, <span class="dv">1</span>, <span class="dt">by =</span> <span class="fl">.1</span>)</a>
<a class="sourceLine" id="cb753-213" title="213"><span class="kw">lines</span>(xd, <span class="kw">sqrt</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>xd<span class="op">^</span><span class="dv">2</span>), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb753-214" title="214"><span class="kw">text</span>(<span class="fl">1.2</span>, <span class="fl">0.5</span>, <span class="dt">label =</span> <span class="kw">parse</span>(<span class="dt">text =</span> <span class="st">&quot;phi&quot;</span>), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb753-215" title="215"><span class="kw">lines</span>(<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">4</span>), <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</a>
<a class="sourceLine" id="cb753-216" title="216"><span class="kw">lines</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">4</span>), <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</a>
<a class="sourceLine" id="cb753-217" title="217"><span class="kw">text</span>(<span class="fl">3.3</span>, <span class="fl">0.3</span>, <span class="dt">label =</span> <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</a>
<a class="sourceLine" id="cb753-218" title="218"><span class="kw">text</span>(<span class="fl">0.3</span>, <span class="fl">4.3</span>, <span class="dt">label =</span> <span class="st">&quot;y&quot;</span>, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</a>
<a class="sourceLine" id="cb753-219" title="219"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(sf))</a>
<a class="sourceLine" id="cb753-220" title="220">e =<span class="st"> </span><span class="kw">cbind</span>(<span class="op">-</span><span class="dv">90</span><span class="op">:</span><span class="dv">90</span>,<span class="dv">0</span>) <span class="co"># equator</span></a>
<a class="sourceLine" id="cb753-221" title="221">f1 =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">cbind</span>(<span class="dv">0</span>, <span class="dv">-90</span><span class="op">:</span><span class="dv">90</span>)) <span class="co"># 0/antimerid.</span></a>
<a class="sourceLine" id="cb753-222" title="222">f2 =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">cbind</span>(<span class="dv">90</span>, <span class="dv">-90</span><span class="op">:</span><span class="dv">90</span>), <span class="kw">cbind</span>(<span class="dv">270</span>, <span class="dv">90</span><span class="op">:-</span><span class="dv">90</span>))<span class="co"># +/- 90</span></a>
<a class="sourceLine" id="cb753-223" title="223">eq =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_linestring</span>(e), <span class="kw">st_linestring</span>(f1), <span class="kw">st_linestring</span>(f2), <span class="dt">crs=</span><span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb753-224" title="224"></a>
<a class="sourceLine" id="cb753-225" title="225">geoc =<span class="st"> </span><span class="kw">st_transform</span>(eq, <span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb753-226" title="226">cc =<span class="st"> </span><span class="kw">rbind</span>(geoc[[<span class="dv">1</span>]], <span class="ot">NA</span>, geoc[[<span class="dv">2</span>]], <span class="ot">NA</span>, geoc[[<span class="dv">3</span>]])</a>
<a class="sourceLine" id="cb753-227" title="227">from3d =<span class="st"> </span><span class="cf">function</span>(x, offset, maxz, minz) {</a>
<a class="sourceLine" id="cb753-228" title="228">    x =<span class="st"> </span>x[,<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">1</span>)] <span class="op">+</span><span class="st"> </span>offset <span class="co"># move to y right, x up, z backw</span></a>
<a class="sourceLine" id="cb753-229" title="229">    x[,<span class="dv">2</span>] =<span class="st"> </span>x[,<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span>maxz      <span class="co"># shift y to left</span></a>
<a class="sourceLine" id="cb753-230" title="230">    d =<span class="st"> </span>maxz</a>
<a class="sourceLine" id="cb753-231" title="231">    z =<span class="st"> </span>x[,<span class="dv">3</span>] <span class="op">-</span><span class="st"> </span>minz <span class="op">+</span><span class="st"> </span>offset</a>
<a class="sourceLine" id="cb753-232" title="232">    x[,<span class="dv">1</span>] =<span class="st"> </span>x[,<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span>(d<span class="op">/</span>z)</a>
<a class="sourceLine" id="cb753-233" title="233">    x[,<span class="dv">2</span>] =<span class="st"> </span>x[,<span class="dv">2</span>] <span class="op">*</span><span class="st"> </span>(d<span class="op">/</span>z)</a>
<a class="sourceLine" id="cb753-234" title="234">    x[,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</a>
<a class="sourceLine" id="cb753-235" title="235">}</a>
<a class="sourceLine" id="cb753-236" title="236">maxz =<span class="st"> </span><span class="kw">max</span>(cc[,<span class="dv">3</span>], <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-237" title="237">minz =<span class="st"> </span><span class="kw">min</span>(cc[,<span class="dv">3</span>], <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-238" title="238">offset =<span class="st"> </span><span class="fl">3e7</span></a>
<a class="sourceLine" id="cb753-239" title="239">circ =<span class="st"> </span><span class="kw">from3d</span>(cc, offset, maxz, minz)</a>
<a class="sourceLine" id="cb753-240" title="240">mx =<span class="st"> </span><span class="kw">max</span>(cc, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">*</span><span class="st"> </span><span class="fl">1.1</span></a>
<a class="sourceLine" id="cb753-241" title="241">x =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(mx, <span class="dv">0</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb753-242" title="242">y =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">0</span>, mx, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb753-243" title="243">z =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, mx))</a>
<a class="sourceLine" id="cb753-244" title="244">ll =<span class="st"> </span><span class="kw">rbind</span>(x, <span class="ot">NA</span>, y, <span class="ot">NA</span>, z)</a>
<a class="sourceLine" id="cb753-245" title="245">l0 =<span class="st">  </span><span class="kw">from3d</span>(ll, offset, maxz, minz)</a>
<a class="sourceLine" id="cb753-246" title="246">mx =<span class="st"> </span><span class="kw">max</span>(cc, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">*</span><span class="st"> </span><span class="fl">1.2</span></a>
<a class="sourceLine" id="cb753-247" title="247">x =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(mx, <span class="dv">0</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb753-248" title="248">y =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">0</span>, mx, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb753-249" title="249">z =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, mx))</a>
<a class="sourceLine" id="cb753-250" title="250">ll =<span class="st"> </span><span class="kw">rbind</span>(x, <span class="ot">NA</span>, y, <span class="ot">NA</span>, z)</a>
<a class="sourceLine" id="cb753-251" title="251">l =<span class="st">  </span><span class="kw">from3d</span>(ll, offset, maxz, minz)</a>
<a class="sourceLine" id="cb753-252" title="252"></a>
<a class="sourceLine" id="cb753-253" title="253"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-254" title="254"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb753-255" title="255"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb753-256" title="256"><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="kw">min</span>(circ[,<span class="dv">1</span>],<span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">3607103</span><span class="op">*</span><span class="fl">1.02</span>), </a>
<a class="sourceLine" id="cb753-257" title="257">                        <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="kw">min</span>(circ[,<span class="dv">2</span>],<span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2873898</span><span class="op">*</span><span class="fl">1.1</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-258" title="258"><span class="kw">lines</span>(circ)</a>
<a class="sourceLine" id="cb753-259" title="259"><span class="kw">lines</span>(l0)</a>
<a class="sourceLine" id="cb753-260" title="260"><span class="kw">text</span>(l[<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">8</span>),], <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;z&quot;</span>), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb753-261" title="261"><span class="co"># add POINT(60 47)</span></a>
<a class="sourceLine" id="cb753-262" title="262">p =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(60 47)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb753-263" title="263">p =<span class="st"> </span>p[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb753-264" title="264">pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p[<span class="dv">1</span>],<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p[<span class="dv">1</span>],p[<span class="dv">2</span>],<span class="dv">0</span>), <span class="kw">c</span>(p[<span class="dv">1</span>],p[<span class="dv">2</span>],p[<span class="dv">2</span>]))</a>
<a class="sourceLine" id="cb753-265" title="265">ptsl =<span class="st"> </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</a>
<a class="sourceLine" id="cb753-266" title="266"><span class="kw">lines</span>(ptsl, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-267" title="267"><span class="kw">points</span>(ptsl[<span class="dv">4</span>,<span class="dv">1</span>], ptsl[<span class="dv">4</span>,<span class="dv">2</span>], <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">cex =</span> <span class="dv">1</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb753-268" title="268"></a>
<a class="sourceLine" id="cb753-269" title="269"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb753-270" title="270"><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="kw">min</span>(circ[,<span class="dv">1</span>],<span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">3607103</span><span class="op">*</span><span class="fl">1.02</span>), </a>
<a class="sourceLine" id="cb753-271" title="271">                        <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="kw">min</span>(circ[,<span class="dv">2</span>],<span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">2873898</span><span class="op">*</span><span class="fl">1.1</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-272" title="272"><span class="kw">lines</span>(circ)</a>
<a class="sourceLine" id="cb753-273" title="273"></a>
<a class="sourceLine" id="cb753-274" title="274">p =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(60 47)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb753-275" title="275">p =<span class="st"> </span>p[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb753-276" title="276">pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p[<span class="dv">1</span>],p[<span class="dv">2</span>],p[<span class="dv">3</span>]))</a>
<a class="sourceLine" id="cb753-277" title="277">pt =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</a>
<a class="sourceLine" id="cb753-278" title="278"><span class="kw">lines</span>(pt)</a>
<a class="sourceLine" id="cb753-279" title="279"><span class="kw">points</span>(pt[<span class="dv">2</span>,<span class="dv">1</span>], pt[<span class="dv">2</span>,<span class="dv">2</span>], <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">cex =</span> <span class="dv">1</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb753-280" title="280"></a>
<a class="sourceLine" id="cb753-281" title="281">p0 =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(60 0)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb753-282" title="282">p0 =<span class="st"> </span>p0[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb753-283" title="283">pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p0[<span class="dv">1</span>],p0[<span class="dv">2</span>],p0[<span class="dv">3</span>]))</a>
<a class="sourceLine" id="cb753-284" title="284">pt =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</a>
<a class="sourceLine" id="cb753-285" title="285"><span class="kw">lines</span>(pt)</a>
<a class="sourceLine" id="cb753-286" title="286"></a>
<a class="sourceLine" id="cb753-287" title="287">p0 =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(0 0)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb753-288" title="288">p0 =<span class="st"> </span>p0[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb753-289" title="289">pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p0[<span class="dv">1</span>],p0[<span class="dv">2</span>],p0[<span class="dv">3</span>]))</a>
<a class="sourceLine" id="cb753-290" title="290">pt =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</a>
<a class="sourceLine" id="cb753-291" title="291"><span class="kw">lines</span>(pt)</a>
<a class="sourceLine" id="cb753-292" title="292"></a>
<a class="sourceLine" id="cb753-293" title="293">p0 =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(0 90)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb753-294" title="294">p0 =<span class="st"> </span>p0[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb753-295" title="295">pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p0[<span class="dv">1</span>],p0[<span class="dv">2</span>],p0[<span class="dv">3</span>]))</a>
<a class="sourceLine" id="cb753-296" title="296">pt =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</a>
<a class="sourceLine" id="cb753-297" title="297"><span class="kw">lines</span>(pt, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-298" title="298"></a>
<a class="sourceLine" id="cb753-299" title="299">p0 =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(90 0)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb753-300" title="300">p0 =<span class="st"> </span>p0[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb753-301" title="301">pts =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(p0[<span class="dv">1</span>],p0[<span class="dv">2</span>],p0[<span class="dv">3</span>]))</a>
<a class="sourceLine" id="cb753-302" title="302">pt =<span class="st">  </span><span class="kw">from3d</span>(pts, offset, maxz, minz)</a>
<a class="sourceLine" id="cb753-303" title="303"><span class="kw">lines</span>(pt, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-304" title="304"></a>
<a class="sourceLine" id="cb753-305" title="305">f1 =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">cbind</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">60</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb753-306" title="306">arc =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_linestring</span>(f1), <span class="dt">crs=</span><span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb753-307" title="307">geoc =<span class="st"> </span><span class="kw">st_transform</span>(arc, <span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb753-308" title="308">cc =<span class="st"> </span><span class="kw">rbind</span>(geoc[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb753-309" title="309">circ =<span class="st"> </span><span class="kw">from3d</span>(cc, offset, maxz, minz)</a>
<a class="sourceLine" id="cb753-310" title="310"><span class="kw">lines</span>(circ, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-311" title="311"></a>
<a class="sourceLine" id="cb753-312" title="312">f1 =<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">cbind</span>(<span class="dv">60</span>, <span class="dv">0</span><span class="op">:</span><span class="dv">47</span>))</a>
<a class="sourceLine" id="cb753-313" title="313">arc =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_linestring</span>(f1), <span class="dt">crs=</span><span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb753-314" title="314">geoc =<span class="st"> </span><span class="kw">st_transform</span>(arc, <span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb753-315" title="315">cc =<span class="st"> </span><span class="kw">rbind</span>(geoc[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb753-316" title="316">circ =<span class="st"> </span><span class="kw">from3d</span>(cc, offset, maxz, minz)</a>
<a class="sourceLine" id="cb753-317" title="317"><span class="kw">lines</span>(circ, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-318" title="318"></a>
<a class="sourceLine" id="cb753-319" title="319"><span class="kw">text</span>(pt[<span class="dv">1</span>,<span class="dv">1</span>]<span class="op">+</span><span class="dv">100000</span>, pt[<span class="dv">1</span>,<span class="dv">2</span>]<span class="op">+</span><span class="dv">50000</span>, <span class="dt">labels =</span> <span class="kw">expression</span>(phi), <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>) <span class="co"># lat</span></a>
<a class="sourceLine" id="cb753-320" title="320"><span class="kw">text</span>(pt[<span class="dv">1</span>,<span class="dv">1</span>]<span class="op">+</span><span class="dv">20000</span>, pt[<span class="dv">1</span>,<span class="dv">2</span>]<span class="op">-</span><span class="dv">50000</span>, <span class="dt">labels =</span> <span class="kw">expression</span>(lambda), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>) <span class="co"># lng</span></a>
<a class="sourceLine" id="cb753-321" title="321">p =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(60 47)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb753-322" title="322">p[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb753-323" title="323">p =<span class="st"> </span><span class="kw">st_as_sfc</span>(<span class="st">&quot;POINT(60 47)&quot;</span>, <span class="dt">crs =</span> <span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb753-324" title="324">p[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb753-325" title="325"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb753-326" title="326">x =<span class="st"> </span><span class="dv">4</span></a>
<a class="sourceLine" id="cb753-327" title="327">y =<span class="st"> </span><span class="dv">5</span><span class="op">/</span><span class="dv">8</span> <span class="op">*</span><span class="st"> </span><span class="kw">sqrt</span>(<span class="dv">48</span>)</a>
<a class="sourceLine" id="cb753-328" title="328"><span class="kw">plot</span>(x, y, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">6</span>,<span class="dv">6</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>,<span class="dv">8</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-329" title="329"><span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">pos =</span> <span class="dv">0</span>, <span class="dt">at =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">9</span>)</a>
<a class="sourceLine" id="cb753-330" title="330"><span class="kw">axis</span>(<span class="dv">2</span>, <span class="dt">pos =</span> <span class="dv">0</span>, <span class="dt">at =</span> <span class="dv">-5</span><span class="op">:</span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb753-331" title="331">xd =<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">8</span>, <span class="dt">by =</span> <span class="fl">.1</span>)</a>
<a class="sourceLine" id="cb753-332" title="332"><span class="kw">lines</span>(xd, <span class="dv">5</span><span class="op">/</span><span class="dv">8</span> <span class="op">*</span><span class="st"> </span><span class="kw">sqrt</span>(<span class="dv">64</span> <span class="op">-</span><span class="st"> </span>xd<span class="op">^</span><span class="dv">2</span>), <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-333" title="333"><span class="kw">lines</span>(xd, <span class="dv">5</span><span class="op">/</span><span class="dv">8</span> <span class="op">*</span><span class="st"> </span><span class="op">-</span><span class="kw">sqrt</span>(<span class="dv">64</span> <span class="op">-</span><span class="st"> </span>xd<span class="op">^</span><span class="dv">2</span>), <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-334" title="334"><span class="kw">arrows</span>(<span class="dv">0</span>, <span class="dv">0</span>, x, y, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">length =</span> <span class="fl">.15</span>, <span class="dt">angle =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb753-335" title="335">b =<span class="st"> </span>(x <span class="op">*</span><span class="st"> </span><span class="dv">25</span>) <span class="op">/</span><span class="st"> </span>(<span class="op">-</span>y <span class="op">*</span><span class="st"> </span><span class="dv">64</span>)</a>
<a class="sourceLine" id="cb753-336" title="336">a =<span class="st"> </span>y <span class="op">-</span><span class="st"> </span>x <span class="op">*</span><span class="st"> </span>b</a>
<a class="sourceLine" id="cb753-337" title="337"><span class="kw">abline</span>(a, b, <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-338" title="338">b =<span class="st"> </span><span class="dv">-1</span><span class="op">/</span>b</a>
<a class="sourceLine" id="cb753-339" title="339">x0 =<span class="st"> </span>x <span class="op">-</span><span class="st"> </span>y <span class="op">/</span><span class="st"> </span>b</a>
<a class="sourceLine" id="cb753-340" title="340"><span class="kw">arrows</span>(x0, <span class="dv">0</span>, x, y, <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">length =</span> <span class="fl">.15</span>, <span class="dt">angle =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb753-341" title="341"><span class="kw">text</span>(<span class="fl">1.2</span>, <span class="fl">0.5</span>, <span class="dt">label =</span> <span class="kw">parse</span>(<span class="dt">text =</span> <span class="st">&quot;psi&quot;</span>), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb753-342" title="342"><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">0.5</span>, <span class="dt">label =</span> <span class="kw">parse</span>(<span class="dt">text =</span> <span class="st">&quot;phi&quot;</span>), <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>)</a>
<a class="sourceLine" id="cb753-343" title="343">pts =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">13.4050</span>, <span class="fl">52.5200</span>)), <span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">2.3522</span>, <span class="fl">48.8566</span>)), <span class="dt">crs =</span> <span class="st">&#39;EPSG:4326&#39;</span>)</a>
<a class="sourceLine" id="cb753-344" title="344">s2_orig =<span class="st"> </span><span class="kw">sf_use_s2</span>(<span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-345" title="345">d1 =<span class="st"> </span><span class="kw">c</span>(<span class="dt">gc_ellipse =</span> <span class="kw">st_distance</span>(pts)[<span class="dv">1</span>,<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb753-346" title="346"><span class="kw">sf_use_s2</span>(<span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-347" title="347"><span class="co"># or, without using s2, use st_distance(st_transform(pts, &quot;+proj=longlat +ellps=sphere&quot;))</span></a>
<a class="sourceLine" id="cb753-348" title="348">d2 =<span class="st"> </span><span class="kw">c</span>(<span class="dt">gc_sphere =</span> <span class="kw">st_distance</span>(pts)[<span class="dv">1</span>,<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb753-349" title="349">p =<span class="st"> </span><span class="kw">st_transform</span>(pts, <span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb753-350" title="350">d3 =<span class="st"> </span><span class="kw">c</span>(<span class="dt">straight_ellipse =</span> units<span class="op">::</span><span class="kw">set_units</span>(<span class="kw">sqrt</span>(<span class="kw">sum</span>(<span class="kw">apply</span>(<span class="kw">do.call</span>(cbind, p), <span class="dv">1</span>, diff)<span class="op">^</span><span class="dv">2</span>)), m))</a>
<a class="sourceLine" id="cb753-351" title="351">p2 =<span class="st"> </span><span class="kw">st_transform</span>(pts, <span class="st">&quot;+proj=longlat +ellps=sphere&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;+proj=geocent&quot;</span>)</a>
<a class="sourceLine" id="cb753-352" title="352">d4 =<span class="st"> </span><span class="kw">c</span>(<span class="dt">straight_sphere =</span> units<span class="op">::</span><span class="kw">set_units</span>(<span class="kw">sqrt</span>(<span class="kw">sum</span>(<span class="kw">apply</span>(<span class="kw">do.call</span>(cbind, p2), <span class="dv">1</span>, diff)<span class="op">^</span><span class="dv">2</span>)), m))</a>
<a class="sourceLine" id="cb753-353" title="353">res =<span class="st"> </span><span class="kw">c</span>(d1,d3,d2,d4)</a>
<a class="sourceLine" id="cb753-354" title="354"><span class="co"># print as km, re-add names:</span></a>
<a class="sourceLine" id="cb753-355" title="355"><span class="kw">sf_use_s2</span>(s2_orig) <span class="co"># back to what it was before changing</span></a>
<a class="sourceLine" id="cb753-356" title="356">res <span class="op">%&gt;%</span><span class="st"> </span>units<span class="op">::</span><span class="kw">set_units</span>(km) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">setNames</span>(<span class="kw">names</span>(res)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">print</span>(<span class="dt">digits =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb753-357" title="357"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb753-358" title="358"><span class="kw">library</span>(rnaturalearth)</a>
<a class="sourceLine" id="cb753-359" title="359">countries110 =<span class="st"> </span><span class="kw">st_as_sf</span>(countries110)</a>
<a class="sourceLine" id="cb753-360" title="360">uk =<span class="st"> </span>countries110[countries110<span class="op">$</span>admin <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;United Kingdom&quot;</span>),] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-361" title="361"><span class="st">        </span><span class="kw">st_geometry</span>()</a>
<a class="sourceLine" id="cb753-362" title="362">r =<span class="st"> </span><span class="kw">read_stars</span>(<span class="st">&quot;data/uk_os_OSTN15_NTv2_OSGBtoETRS.tif&quot;</span>)</a>
<a class="sourceLine" id="cb753-363" title="363"><span class="co"># r = read_stars(&quot;/vsicurl/https://cdn.proj.org/uk_os_OSTN15_NTv2_OSGBtoETRS.tif&quot;)</span></a>
<a class="sourceLine" id="cb753-364" title="364">hook =<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb753-365" title="365">        <span class="kw">plot</span>(uk, <span class="dt">border =</span> <span class="st">&quot;orange&quot;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-366" title="366">}</a>
<a class="sourceLine" id="cb753-367" title="367"><span class="kw">plot</span>(r[,,,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>], <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">hook =</span> hook, <span class="dt">key.pos =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb753-368" title="368">h =<span class="st"> </span><span class="kw">read_stars</span>(<span class="st">&quot;data/uk_os_OSGM15_GB.tif&quot;</span>)</a>
<a class="sourceLine" id="cb753-369" title="369"><span class="co"># h = read_stars(&quot;/vsicurl/https://cdn.proj.org/uk_os_OSGM15_GB.tif&quot;)</span></a>
<a class="sourceLine" id="cb753-370" title="370"><span class="kw">plot</span>(h, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">reset =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-371" title="371"><span class="kw">plot</span>(uk, <span class="dt">border =</span> <span class="st">&quot;orange&quot;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-372" title="372"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-373" title="373"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-374" title="374"></a>
<a class="sourceLine" id="cb753-375" title="375">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-376" title="376">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-377" title="377">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-378" title="378">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-379" title="379"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-380" title="380">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-381" title="381"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-382" title="382"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-383" title="383"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-384" title="384">)</a>
<a class="sourceLine" id="cb753-385" title="385"></a>
<a class="sourceLine" id="cb753-386" title="386"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-387" title="387"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-388" title="388">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-389" title="389"></a>
<a class="sourceLine" id="cb753-390" title="390"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-391" title="391"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-392" title="392"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-393" title="393">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-394" title="394">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-395" title="395"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-396" title="396"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb753-397" title="397"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">1.2</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb753-398" title="398"></a>
<a class="sourceLine" id="cb753-399" title="399"><span class="co"># 1</span></a>
<a class="sourceLine" id="cb753-400" title="400">p =<span class="st"> </span><span class="kw">st_point</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-401" title="401"><span class="kw">plot</span>(p, <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb753-402" title="402"><span class="kw">title</span>(<span class="st">&quot;point&quot;</span>)</a>
<a class="sourceLine" id="cb753-403" title="403"><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-404" title="404"></a>
<a class="sourceLine" id="cb753-405" title="405"><span class="co"># 2</span></a>
<a class="sourceLine" id="cb753-406" title="406">mp =<span class="st"> </span><span class="kw">st_multipoint</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>)))</a>
<a class="sourceLine" id="cb753-407" title="407"><span class="kw">plot</span>(mp, <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb753-408" title="408"><span class="kw">title</span>(<span class="st">&quot;multipoint&quot;</span>)</a>
<a class="sourceLine" id="cb753-409" title="409"><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-410" title="410"></a>
<a class="sourceLine" id="cb753-411" title="411"><span class="co"># 3</span></a>
<a class="sourceLine" id="cb753-412" title="412">ls =<span class="st"> </span><span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">5</span>), <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">6</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">6</span>), <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>)))</a>
<a class="sourceLine" id="cb753-413" title="413"><span class="kw">plot</span>(ls, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-414" title="414"><span class="kw">title</span>(<span class="st">&quot;linestring&quot;</span>)</a>
<a class="sourceLine" id="cb753-415" title="415"><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-416" title="416"></a>
<a class="sourceLine" id="cb753-417" title="417"><span class="co"># 4</span></a>
<a class="sourceLine" id="cb753-418" title="418">mls =<span class="st"> </span><span class="kw">st_multilinestring</span>(<span class="kw">list</span>(</a>
<a class="sourceLine" id="cb753-419" title="419">  <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">5</span>), <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">6</span>), <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">6</span>), <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>)),</a>
<a class="sourceLine" id="cb753-420" title="420">  <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))))</a>
<a class="sourceLine" id="cb753-421" title="421"><span class="kw">plot</span>(mls, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-422" title="422"><span class="kw">title</span>(<span class="st">&quot;multilinestring&quot;</span>)</a>
<a class="sourceLine" id="cb753-423" title="423"><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-424" title="424"></a>
<a class="sourceLine" id="cb753-425" title="425"><span class="co"># 5 polygon</span></a>
<a class="sourceLine" id="cb753-426" title="426">po =<span class="st"> </span><span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">6</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>)),</a>
<a class="sourceLine" id="cb753-427" title="427">    <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))))</a>
<a class="sourceLine" id="cb753-428" title="428"><span class="kw">plot</span>(po, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">col =</span> <span class="st">&#39;#ff8888&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-429" title="429"><span class="kw">title</span>(<span class="st">&quot;polygon&quot;</span>)</a>
<a class="sourceLine" id="cb753-430" title="430"><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-431" title="431"></a>
<a class="sourceLine" id="cb753-432" title="432"><span class="co"># 6 multipolygon</span></a>
<a class="sourceLine" id="cb753-433" title="433">mpo =<span class="st"> </span><span class="kw">st_multipolygon</span>(<span class="kw">list</span>(</a>
<a class="sourceLine" id="cb753-434" title="434">    <span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">6</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>)),</a>
<a class="sourceLine" id="cb753-435" title="435">        <span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))),</a>
<a class="sourceLine" id="cb753-436" title="436">    <span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">7</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">7</span>), <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">8</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">9</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">8</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">7</span>)))))</a>
<a class="sourceLine" id="cb753-437" title="437"><span class="kw">plot</span>(mpo, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">col =</span> <span class="st">&#39;#ff8888&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-438" title="438"><span class="kw">title</span>(<span class="st">&quot;multipolygon&quot;</span>)</a>
<a class="sourceLine" id="cb753-439" title="439"><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-440" title="440"></a>
<a class="sourceLine" id="cb753-441" title="441"><span class="co"># 7 geometrycollection</span></a>
<a class="sourceLine" id="cb753-442" title="442">gc =<span class="st"> </span><span class="kw">st_geometrycollection</span>(<span class="kw">list</span>(po, ls <span class="op">+</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">5</span>), <span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">5</span>)), <span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">4</span>))))</a>
<a class="sourceLine" id="cb753-443" title="443"><span class="kw">plot</span>(gc, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">col =</span> <span class="st">&#39;#ff6666&#39;</span>, <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-444" title="444"><span class="kw">title</span>(<span class="st">&quot;geometrycollection&quot;</span>)</a>
<a class="sourceLine" id="cb753-445" title="445"><span class="kw">box</span>(<span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-446" title="446">p</a>
<a class="sourceLine" id="cb753-447" title="447">mp</a>
<a class="sourceLine" id="cb753-448" title="448">ls</a>
<a class="sourceLine" id="cb753-449" title="449">mls</a>
<a class="sourceLine" id="cb753-450" title="450">po</a>
<a class="sourceLine" id="cb753-451" title="451">mpo</a>
<a class="sourceLine" id="cb753-452" title="452">gc</a>
<a class="sourceLine" id="cb753-453" title="453">(<span class="dt">ls =</span> <span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">0</span>))))</a>
<a class="sourceLine" id="cb753-454" title="454"><span class="kw">c</span>(<span class="dt">is_simple =</span> <span class="kw">st_is_simple</span>(ls))</a>
<a class="sourceLine" id="cb753-455" title="455"><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-456" title="456"><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>), <span class="dt">dim =</span> <span class="st">&quot;XYM&quot;</span>)</a>
<a class="sourceLine" id="cb753-457" title="457"><span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">2</span>)))</a>
<a class="sourceLine" id="cb753-458" title="458">(<span class="dt">e =</span> <span class="kw">st_intersection</span>(<span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)), <span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))))</a>
<a class="sourceLine" id="cb753-459" title="459"><span class="kw">st_point</span>()</a>
<a class="sourceLine" id="cb753-460" title="460"><span class="kw">st_linestring</span>(<span class="kw">matrix</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">3</span>)[<span class="dv">0</span>,], <span class="dt">dim =</span> <span class="st">&quot;XYM&quot;</span>)</a>
<a class="sourceLine" id="cb753-461" title="461"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-462" title="462">polygon =<span class="st"> </span>po =<span class="st"> </span><span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))))</a>
<a class="sourceLine" id="cb753-463" title="463">p0 =<span class="st"> </span><span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>))))</a>
<a class="sourceLine" id="cb753-464" title="464">line =<span class="st"> </span>li =<span class="st"> </span><span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">-.5</span>), <span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">0.5</span>)))</a>
<a class="sourceLine" id="cb753-465" title="465">s =<span class="st"> </span><span class="kw">st_sfc</span>(po, li)</a>
<a class="sourceLine" id="cb753-466" title="466"></a>
<a class="sourceLine" id="cb753-467" title="467"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb753-468" title="468"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb753-469" title="469"></a>
<a class="sourceLine" id="cb753-470" title="470"><span class="co"># &quot;1020F1102&quot;</span></a>
<a class="sourceLine" id="cb753-471" title="471"><span class="co"># 1: 1</span></a>
<a class="sourceLine" id="cb753-472" title="472"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;I(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;I(line) = 1&quot;</span>)))</a>
<a class="sourceLine" id="cb753-473" title="473"><span class="kw">lines</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(.<span class="dv">5</span>,<span class="dv">0</span>), <span class="kw">c</span>(.<span class="dv">5</span>,.<span class="dv">495</span>)), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-474" title="474"><span class="kw">points</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="dt">pch =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-475" title="475"></a>
<a class="sourceLine" id="cb753-476" title="476"><span class="co"># 2: 0</span></a>
<a class="sourceLine" id="cb753-477" title="477"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;I(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;B(line) = 0&quot;</span>)))</a>
<a class="sourceLine" id="cb753-478" title="478"><span class="kw">points</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb753-479" title="479"></a>
<a class="sourceLine" id="cb753-480" title="480"><span class="co"># 3: 2</span></a>
<a class="sourceLine" id="cb753-481" title="481"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;I(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;E(line) = 2&quot;</span>)))</a>
<a class="sourceLine" id="cb753-482" title="482"><span class="kw">plot</span>(po, <span class="dt">col =</span> <span class="st">&#39;#ff8888&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-483" title="483"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-484" title="484"></a>
<a class="sourceLine" id="cb753-485" title="485"><span class="co"># 4: 0</span></a>
<a class="sourceLine" id="cb753-486" title="486"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;B(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;I(line) = 0&quot;</span>)))</a>
<a class="sourceLine" id="cb753-487" title="487"><span class="kw">points</span>(.<span class="dv">5</span>, <span class="dv">0</span>, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb753-488" title="488"></a>
<a class="sourceLine" id="cb753-489" title="489"><span class="co"># 5: F</span></a>
<a class="sourceLine" id="cb753-490" title="490"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;B(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;B(line) = F&quot;</span>)))</a>
<a class="sourceLine" id="cb753-491" title="491"></a>
<a class="sourceLine" id="cb753-492" title="492"><span class="co"># 6: 1</span></a>
<a class="sourceLine" id="cb753-493" title="493"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;B(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;E(line) = 1&quot;</span>)))</a>
<a class="sourceLine" id="cb753-494" title="494"><span class="kw">plot</span>(po, <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-495" title="495"></a>
<a class="sourceLine" id="cb753-496" title="496"><span class="co"># 7: 1</span></a>
<a class="sourceLine" id="cb753-497" title="497"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;E(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;I(line) = 1&quot;</span>)))</a>
<a class="sourceLine" id="cb753-498" title="498"><span class="kw">lines</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">-.5</span>), <span class="kw">c</span>(.<span class="dv">5</span>, <span class="dv">0</span>)), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-499" title="499"></a>
<a class="sourceLine" id="cb753-500" title="500"><span class="co"># 8: 0</span></a>
<a class="sourceLine" id="cb753-501" title="501"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;E(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;B(line) = 0&quot;</span>)))</a>
<a class="sourceLine" id="cb753-502" title="502"><span class="kw">points</span>(.<span class="dv">5</span>, <span class="fl">-.5</span>, <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb753-503" title="503"></a>
<a class="sourceLine" id="cb753-504" title="504"><span class="co"># 9: 2</span></a>
<a class="sourceLine" id="cb753-505" title="505"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">main =</span> <span class="kw">expression</span>(<span class="kw">paste</span>(<span class="st">&quot;E(pol)&quot;</span>,<span class="kw">intersect</span>(),<span class="st">&quot;E(line) = 2&quot;</span>)))</a>
<a class="sourceLine" id="cb753-506" title="506"><span class="kw">plot</span>(p0 <span class="op">/</span><span class="st"> </span>po, <span class="dt">col =</span> <span class="st">&#39;#ff8888&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-507" title="507"><span class="kw">plot</span>(s, <span class="dt">col =</span> <span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&#39;darkgreen&#39;</span>), <span class="dt">border =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-508" title="508"><span class="kw">st_relate</span>(polygon, line)</a>
<a class="sourceLine" id="cb753-509" title="509"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>), <span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb753-510" title="510"><span class="kw">set.seed</span>(<span class="dv">133331</span>)</a>
<a class="sourceLine" id="cb753-511" title="511">mp =<span class="st"> </span><span class="kw">st_multipoint</span>(<span class="kw">matrix</span>(<span class="kw">runif</span>(<span class="dv">20</span>), <span class="dv">10</span>))</a>
<a class="sourceLine" id="cb753-512" title="512"><span class="kw">plot</span>(mp, <span class="dt">cex =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-513" title="513"><span class="kw">plot</span>(<span class="kw">st_convex_hull</span>(mp), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb753-514" title="514"><span class="kw">box</span>()</a>
<a class="sourceLine" id="cb753-515" title="515"><span class="kw">plot</span>(mp, <span class="dt">cex =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-516" title="516"><span class="kw">plot</span>(<span class="kw">st_voronoi</span>(mp), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb753-517" title="517"><span class="kw">box</span>()</a>
<a class="sourceLine" id="cb753-518" title="518"><span class="kw">plot</span>(mp, <span class="dt">cex =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-519" title="519"><span class="kw">plot</span>(<span class="kw">st_triangulate</span>(mp), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;darkgreen&#39;</span>)</a>
<a class="sourceLine" id="cb753-520" title="520"><span class="kw">box</span>()</a>
<a class="sourceLine" id="cb753-521" title="521"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(.<span class="dv">1</span>, <span class="dv">4</span>), <span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-522" title="522">sq =<span class="st"> </span><span class="cf">function</span>(pt, <span class="dt">sz =</span> <span class="dv">1</span>) <span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(pt <span class="op">-</span><span class="st"> </span>sz), </a>
<a class="sourceLine" id="cb753-523" title="523">  <span class="kw">c</span>(pt[<span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>sz, pt[<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span>sz), <span class="kw">c</span>(pt <span class="op">+</span><span class="st"> </span>sz), <span class="kw">c</span>(pt[<span class="dv">1</span>] <span class="op">-</span><span class="st"> </span>sz, pt[<span class="dv">2</span>] <span class="op">+</span><span class="st"> </span>sz), <span class="kw">c</span>(pt <span class="op">-</span><span class="st"> </span>sz))))</a>
<a class="sourceLine" id="cb753-524" title="524">x =<span class="st"> </span><span class="kw">st_sf</span>(<span class="dt">box =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="kw">st_sfc</span>(<span class="kw">sq</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)), <span class="kw">sq</span>(<span class="kw">c</span>(<span class="fl">1.7</span>, <span class="fl">-0.5</span>)), <span class="kw">sq</span>(<span class="kw">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>))))</a>
<a class="sourceLine" id="cb753-525" title="525"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(x), <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="kw">sf.colors</span>(<span class="dv">3</span>, <span class="dt">categorical =</span> <span class="ot">TRUE</span>), <span class="dt">lwd =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-526" title="526"><span class="kw">plot</span>(<span class="kw">st_intersection</span>(<span class="kw">st_geometry</span>(x)), <span class="dt">col =</span> <span class="kw">sf.colors</span>(<span class="dv">7</span>, <span class="dt">categorical=</span><span class="ot">TRUE</span>, <span class="dt">alpha =</span> <span class="fl">.5</span>))</a>
<a class="sourceLine" id="cb753-527" title="527"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(.<span class="dv">1</span>, <span class="dv">4</span>), <span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)) </a>
<a class="sourceLine" id="cb753-528" title="528">xg =<span class="st"> </span><span class="kw">st_geometry</span>(x)</a>
<a class="sourceLine" id="cb753-529" title="529"><span class="kw">plot</span>(<span class="kw">st_difference</span>(xg), <span class="dt">col =</span> <span class="kw">sf.colors</span>(<span class="dv">3</span>, <span class="dt">alpha =</span> <span class="fl">.5</span>, <span class="dt">categorical=</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb753-530" title="530"><span class="kw">plot</span>(<span class="kw">st_difference</span>(xg[<span class="dv">3</span><span class="op">:</span><span class="dv">1</span>]), <span class="dt">col =</span> <span class="kw">sf.colors</span>(<span class="dv">3</span>, <span class="dt">alpha =</span> <span class="fl">.5</span>, <span class="dt">categorical=</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb753-531" title="531"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb753-532" title="532">ls =<span class="st"> </span><span class="kw">st_sf</span>(<span class="dt">a =</span> <span class="dv">2</span>, <span class="kw">st_sfc</span>(<span class="kw">st_linestring</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="fl">0.1</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">.9</span>)))))</a>
<a class="sourceLine" id="cb753-533" title="533">grd =<span class="st"> </span><span class="kw">st_as_stars</span>(<span class="kw">st_bbox</span>(ls), <span class="dt">nx =</span> <span class="dv">10</span>, <span class="dt">ny =</span> <span class="dv">10</span>, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">1.0</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb753-534" title="534">   <span class="dt">values =</span> <span class="dv">-1</span>)</a>
<a class="sourceLine" id="cb753-535" title="535">r =<span class="st"> </span><span class="kw">st_rasterize</span>(ls, grd, <span class="dt">options =</span> <span class="st">&quot;ALL_TOUCHED=TRUE&quot;</span>)</a>
<a class="sourceLine" id="cb753-536" title="536">r[r <span class="op">==</span><span class="st"> </span><span class="dv">-1</span>] =<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb753-537" title="537"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(<span class="kw">st_as_sf</span>(grd)), <span class="dt">border =</span> <span class="st">&#39;orange&#39;</span>, <span class="dt">col =</span> <span class="ot">NA</span>, </a>
<a class="sourceLine" id="cb753-538" title="538">     <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">key.pos =</span> <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb753-539" title="539"><span class="kw">plot</span>(r, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>, <span class="dt">main =</span> <span class="ot">NA</span>) <span class="co"># ALL_TOUCHED=FALSE;</span></a>
<a class="sourceLine" id="cb753-540" title="540"><span class="kw">plot</span>(ls, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-541" title="541"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-542" title="542"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-543" title="543"></a>
<a class="sourceLine" id="cb753-544" title="544">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-545" title="545">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-546" title="546">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-547" title="547">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-548" title="548"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-549" title="549">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-550" title="550"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-551" title="551"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-552" title="552"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-553" title="553">)</a>
<a class="sourceLine" id="cb753-554" title="554"></a>
<a class="sourceLine" id="cb753-555" title="555"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-556" title="556"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-557" title="557">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-558" title="558"></a>
<a class="sourceLine" id="cb753-559" title="559"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-560" title="560"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-561" title="561"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-562" title="562">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-563" title="563">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-564" title="564"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-565" title="565"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(maps))</a>
<a class="sourceLine" id="cb753-566" title="566"><span class="co"># maps:</span></a>
<a class="sourceLine" id="cb753-567" title="567"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-568" title="568"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="fl">1.2</span>,<span class="dv">1</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb753-569" title="569">m =<span class="st"> </span><span class="kw">st_as_sf</span>(<span class="kw">map</span>(<span class="dt">fill=</span><span class="ot">TRUE</span>, <span class="dt">plot=</span><span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb753-570" title="570">a =<span class="st"> </span>m[m<span class="op">$</span>ID <span class="op">==</span><span class="st"> &quot;Antarctica&quot;</span>, ]</a>
<a class="sourceLine" id="cb753-571" title="571"><span class="kw">st_bbox</span>(a)</a>
<a class="sourceLine" id="cb753-572" title="572"><span class="kw">library</span>(s2)</a>
<a class="sourceLine" id="cb753-573" title="573"><span class="kw">s2_bounds_cap</span>(a)</a>
<a class="sourceLine" id="cb753-574" title="574"><span class="kw">s2_bounds_rect</span>(a)</a>
<a class="sourceLine" id="cb753-575" title="575"><span class="kw">st_bbox</span>(m[m<span class="op">$</span>ID <span class="op">==</span><span class="st"> &quot;Fiji&quot;</span>,])</a>
<a class="sourceLine" id="cb753-576" title="576"><span class="kw">s2_bounds_rect</span>(m[m<span class="op">$</span>ID <span class="op">==</span><span class="st"> &quot;Fiji&quot;</span>,])</a>
<a class="sourceLine" id="cb753-577" title="577"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-578" title="578"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(maps))</a>
<a class="sourceLine" id="cb753-579" title="579"><span class="co"># maps:</span></a>
<a class="sourceLine" id="cb753-580" title="580"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-581" title="581"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="fl">1.2</span>,<span class="dv">1</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb753-582" title="582">m =<span class="st"> </span><span class="kw">st_as_sf</span>(<span class="kw">map</span>(<span class="dt">fill=</span><span class="ot">TRUE</span>, <span class="dt">plot=</span><span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb753-583" title="583">m =<span class="st"> </span>m[m<span class="op">$</span>ID <span class="op">==</span><span class="st"> &quot;Antarctica&quot;</span>, ]</a>
<a class="sourceLine" id="cb753-584" title="584"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(m), <span class="dt">asp =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-585" title="585"><span class="kw">title</span>(<span class="st">&quot;a (not valid)&quot;</span>)</a>
<a class="sourceLine" id="cb753-586" title="586"><span class="co"># ne:</span></a>
<a class="sourceLine" id="cb753-587" title="587"><span class="kw">library</span>(rnaturalearth)</a>
<a class="sourceLine" id="cb753-588" title="588">ne =<span class="st"> </span><span class="kw">ne_countries</span>(<span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>)</a>
<a class="sourceLine" id="cb753-589" title="589">ne =<span class="st"> </span>ne[ne<span class="op">$</span>region_un <span class="op">==</span><span class="st"> &quot;Antarctica&quot;</span>, <span class="st">&quot;region_un&quot;</span>]</a>
<a class="sourceLine" id="cb753-590" title="590"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(ne), <span class="dt">asp =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-591" title="591"><span class="kw">title</span>(<span class="st">&quot;b (valid)&quot;</span>)</a>
<a class="sourceLine" id="cb753-592" title="592"><span class="co"># 3031</span></a>
<a class="sourceLine" id="cb753-593" title="593">m <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-594" title="594"><span class="st">  </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-595" title="595"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dv">3031</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-596" title="596"><span class="st">  </span><span class="kw">plot</span>()</a>
<a class="sourceLine" id="cb753-597" title="597"><span class="kw">title</span>(<span class="st">&quot;c (valid)&quot;</span>)</a>
<a class="sourceLine" id="cb753-598" title="598">ne <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-599" title="599"><span class="st">  </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-600" title="600"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dv">3031</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-601" title="601"><span class="st">  </span><span class="kw">plot</span>()</a>
<a class="sourceLine" id="cb753-602" title="602"><span class="kw">title</span>(<span class="st">&quot;d (not valid)&quot;</span>)</a>
<a class="sourceLine" id="cb753-603" title="603"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-604" title="604"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-605" title="605"></a>
<a class="sourceLine" id="cb753-606" title="606">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-607" title="607">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-608" title="608">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-609" title="609">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-610" title="610"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-611" title="611">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-612" title="612"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-613" title="613"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-614" title="614"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-615" title="615">)</a>
<a class="sourceLine" id="cb753-616" title="616"></a>
<a class="sourceLine" id="cb753-617" title="617"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-618" title="618"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-619" title="619">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-620" title="620"></a>
<a class="sourceLine" id="cb753-621" title="621"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-622" title="622"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-623" title="623"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-624" title="624">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-625" title="625">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-626" title="626"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-627" title="627"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb753-628" title="628"><span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-629" title="629"><span class="st">    </span><span class="kw">read_sf</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-630" title="630"><span class="st">    </span><span class="kw">st_transform</span>(<span class="dv">32119</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-631" title="631"><span class="st">    </span><span class="kw">select</span>(BIR74, SID74, NAME) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-632" title="632"><span class="st">    </span><span class="kw">st_centroid</span>() -&gt;<span class="st"> </span>x</a>
<a class="sourceLine" id="cb753-633" title="633">nc &lt;-<span class="st"> </span><span class="kw">read_sf</span>(<span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;sf&quot;</span>))</a>
<a class="sourceLine" id="cb753-634" title="634"><span class="co"># encode quadrant by two logicals:</span></a>
<a class="sourceLine" id="cb753-635" title="635">nc<span class="op">$</span>lng =<span class="st"> </span><span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(nc)))[,<span class="dv">1</span>] <span class="op">&gt;</span><span class="st"> </span><span class="dv">-79</span></a>
<a class="sourceLine" id="cb753-636" title="636">nc<span class="op">$</span>lat =<span class="st"> </span><span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(nc)))[,<span class="dv">2</span>] <span class="op">&gt;</span><span class="st"> </span><span class="fl">35.5</span></a>
<a class="sourceLine" id="cb753-637" title="637">nc.grp =<span class="st"> </span><span class="kw">aggregate</span>(nc[<span class="st">&quot;SID74&quot;</span>], <span class="kw">list</span>(nc<span class="op">$</span>lng, nc<span class="op">$</span>lat), sum)</a>
<a class="sourceLine" id="cb753-638" title="638"><span class="kw">plot</span>(nc.grp[<span class="st">&quot;SID74&quot;</span>], <span class="dt">axes =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-639" title="639">nc &lt;-<span class="st"> </span><span class="kw">st_transform</span>(nc, <span class="dv">2264</span>)</a>
<a class="sourceLine" id="cb753-640" title="640">gr =<span class="st"> </span><span class="kw">st_sf</span>(</a>
<a class="sourceLine" id="cb753-641" title="641">   <span class="dt">label =</span> <span class="kw">apply</span>(<span class="kw">expand.grid</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, LETTERS[<span class="dv">10</span><span class="op">:</span><span class="dv">1</span>])[,<span class="dv">2</span><span class="op">:</span><span class="dv">1</span>], <span class="dv">1</span>, paste0, <span class="dt">collapse =</span> <span class="st">&quot; &quot;</span>),</a>
<a class="sourceLine" id="cb753-642" title="642">   <span class="dt">geom =</span> <span class="kw">st_make_grid</span>(nc))</a>
<a class="sourceLine" id="cb753-643" title="643"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc), <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">border =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-644" title="644"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(gr), <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-645" title="645">a =<span class="st"> </span><span class="kw">aggregate</span>(nc[<span class="st">&quot;SID74&quot;</span>], gr, sum)</a>
<a class="sourceLine" id="cb753-646" title="646"><span class="kw">c</span>(<span class="dt">sid74_sum_counties =</span> <span class="kw">sum</span>(nc<span class="op">$</span>SID74), <span class="dt">sid74_sum_rectangles =</span> <span class="kw">sum</span>(a<span class="op">$</span>SID74, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb753-647" title="647">g =<span class="st"> </span><span class="kw">st_make_grid</span>(<span class="kw">st_bbox</span>(<span class="kw">st_as_sfc</span>(<span class="st">&quot;LINESTRING(0 0,1 1)&quot;</span>)), <span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-648" title="648"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb753-649" title="649"><span class="kw">plot</span>(g)</a>
<a class="sourceLine" id="cb753-650" title="650"><span class="kw">plot</span>(g[<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span><span class="kw">diag</span>(<span class="kw">c</span>(<span class="dv">3</span><span class="op">/</span><span class="dv">4</span>, <span class="dv">1</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">c</span>(<span class="fl">0.25</span>, <span class="fl">0.125</span>), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-651" title="651"><span class="kw">text</span>(<span class="kw">c</span>(.<span class="dv">2</span>, <span class="fl">.8</span>, <span class="fl">.2</span>, <span class="fl">.8</span>), <span class="kw">c</span>(.<span class="dv">2</span>, <span class="fl">.2</span>, <span class="fl">.8</span>, <span class="fl">.8</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">8</span>), <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>)</a>
<a class="sourceLine" id="cb753-652" title="652"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-653" title="653"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-654" title="654"></a>
<a class="sourceLine" id="cb753-655" title="655">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-656" title="656">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-657" title="657">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-658" title="658">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-659" title="659"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-660" title="660">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-661" title="661"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-662" title="662"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-663" title="663"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-664" title="664">)</a>
<a class="sourceLine" id="cb753-665" title="665"></a>
<a class="sourceLine" id="cb753-666" title="666"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-667" title="667"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-668" title="668">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-669" title="669"></a>
<a class="sourceLine" id="cb753-670" title="670"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-671" title="671"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-672" title="672"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-673" title="673">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-674" title="674">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-675" title="675"><span class="co"># (C) 2019, Edzer Pebesma, CC-BY-SA</span></a>
<a class="sourceLine" id="cb753-676" title="676"><span class="kw">set.seed</span>(<span class="dv">1331</span>)</a>
<a class="sourceLine" id="cb753-677" title="677"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(stars))</a>
<a class="sourceLine" id="cb753-678" title="678"><span class="kw">library</span>(colorspace)</a>
<a class="sourceLine" id="cb753-679" title="679">tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</a>
<a class="sourceLine" id="cb753-680" title="680">r =<span class="st"> </span><span class="kw">read_stars</span>(tif)</a>
<a class="sourceLine" id="cb753-681" title="681"></a>
<a class="sourceLine" id="cb753-682" title="682">nrow =<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb753-683" title="683">ncol =<span class="st"> </span><span class="dv">8</span></a>
<a class="sourceLine" id="cb753-684" title="684">m =<span class="st"> </span>r[[<span class="dv">1</span>]][<span class="dv">1</span><span class="op">:</span>nrow,<span class="dv">1</span><span class="op">:</span>ncol,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb753-685" title="685"><span class="kw">dim</span>(m) =<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> nrow, <span class="dt">y =</span> ncol) <span class="co"># named dim</span></a>
<a class="sourceLine" id="cb753-686" title="686">s =<span class="st"> </span><span class="kw">st_as_stars</span>(m)</a>
<a class="sourceLine" id="cb753-687" title="687"><span class="co"># s</span></a>
<a class="sourceLine" id="cb753-688" title="688"><span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>delta =<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb753-689" title="689"><span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>delta =<span class="st"> </span><span class="fl">-.5</span></a>
<a class="sourceLine" id="cb753-690" title="690"><span class="kw">attr</span>(<span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>), <span class="st">&quot;raster&quot;</span>)<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="fl">1.2</span>, <span class="fl">0.0</span>)</a>
<a class="sourceLine" id="cb753-691" title="691"></a>
<a class="sourceLine" id="cb753-692" title="692">plt =<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">yoffset =</span> <span class="dv">0</span>, add, <span class="dt">li =</span> <span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb753-693" title="693">    <span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span><span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset <span class="op">+</span><span class="st"> </span>yoffset</a>
<a class="sourceLine" id="cb753-694" title="694">    l =<span class="st"> </span><span class="kw">st_as_sf</span>(x, <span class="dt">as_points =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-695" title="695">    pal =<span class="st"> </span><span class="kw">sf.colors</span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb753-696" title="696">    <span class="cf">if</span> (li)</a>
<a class="sourceLine" id="cb753-697" title="697">        pal =<span class="st"> </span><span class="kw">lighten</span>(pal, <span class="fl">0.3</span> <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.1</span>))</a>
<a class="sourceLine" id="cb753-698" title="698">    <span class="cf">if</span> (<span class="op">!</span><span class="st"> </span>add)</a>
<a class="sourceLine" id="cb753-699" title="699">        <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">FALSE</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>, <span class="dt">pal =</span> pal, <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(.<span class="dv">75</span>), <span class="dt">key.pos =</span> <span class="ot">NULL</span>, <span class="dt">main =</span> <span class="ot">NULL</span>, <span class="dt">xlab =</span> <span class="st">&quot;time&quot;</span>)</a>
<a class="sourceLine" id="cb753-700" title="700">    <span class="cf">else</span></a>
<a class="sourceLine" id="cb753-701" title="701">        <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>, <span class="dt">pal =</span> pal, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(.<span class="dv">75</span>))</a>
<a class="sourceLine" id="cb753-702" title="702">    u =<span class="st"> </span><span class="kw">st_union</span>(l)</a>
<a class="sourceLine" id="cb753-703" title="703">    <span class="co"># print(u)</span></a>
<a class="sourceLine" id="cb753-704" title="704">    <span class="kw">plot</span>(<span class="kw">st_geometry</span>(u), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">lwd =</span> <span class="fl">2.5</span>)</a>
<a class="sourceLine" id="cb753-705" title="705">}</a>
<a class="sourceLine" id="cb753-706" title="706"></a>
<a class="sourceLine" id="cb753-707" title="707">pl =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">randomize =</span> <span class="ot">FALSE</span>) {</a>
<a class="sourceLine" id="cb753-708" title="708">  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</a>
<a class="sourceLine" id="cb753-709" title="709">  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</a>
<a class="sourceLine" id="cb753-710" title="710">  m =<span class="st"> </span>r[[<span class="dv">1</span>]][y <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>nrow,x <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>ncol,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb753-711" title="711">  <span class="cf">if</span> (randomize)</a>
<a class="sourceLine" id="cb753-712" title="712">    m =<span class="st"> </span>m[<span class="kw">sample</span>(y <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>nrow),x <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>ncol]</a>
<a class="sourceLine" id="cb753-713" title="713">  <span class="kw">dim</span>(m) =<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> nrow, <span class="dt">y =</span> ncol) <span class="co"># named dim</span></a>
<a class="sourceLine" id="cb753-714" title="714">  s[[<span class="dv">1</span>]] =<span class="st"> </span>m</a>
<a class="sourceLine" id="cb753-715" title="715">  <span class="kw">plt</span>(s, <span class="dv">0</span>, add)</a>
<a class="sourceLine" id="cb753-716" title="716">  <span class="kw">plt</span>(s, <span class="dv">1</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-717" title="717">  <span class="kw">plt</span>(s, <span class="dv">2</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-718" title="718">  <span class="kw">plt</span>(s, <span class="dv">3</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-719" title="719">  <span class="kw">plt</span>(s, <span class="dv">4</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-720" title="720">  <span class="kw">plt</span>(s, <span class="dv">5</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-721" title="721">  <span class="kw">plt</span>(s, <span class="dv">6</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-722" title="722">  <span class="kw">plt</span>(s, <span class="dv">7</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-723" title="723">  <span class="kw">plt</span>(s, <span class="dv">8</span>, <span class="ot">TRUE</span>, <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-724" title="724">}</a>
<a class="sourceLine" id="cb753-725" title="725"></a>
<a class="sourceLine" id="cb753-726" title="726"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb753-727" title="727"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="fl">0.5</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb753-728" title="728"><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">12</span>,<span class="dv">15</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">5</span>,<span class="dv">10</span>), <span class="dt">asp=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-729" title="729"><span class="kw">pl</span>(s, <span class="dv">0</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb753-730" title="730"><span class="co"># box()</span></a>
<a class="sourceLine" id="cb753-731" title="731"><span class="kw">text</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">0</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">-90</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</a>
<a class="sourceLine" id="cb753-732" title="732"><span class="kw">text</span>(<span class="op">-</span><span class="dv">5</span>,  <span class="fl">6.5</span>, <span class="st">&quot;latitude&quot;</span>, <span class="dt">srt =</span> <span class="dv">25</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</a>
<a class="sourceLine" id="cb753-733" title="733"><span class="kw">text</span>( <span class="dv">5</span>,  <span class="fl">8.5</span>, <span class="st">&quot;longitude&quot;</span>, <span class="dt">srt =</span> <span class="dv">0</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</a>
<a class="sourceLine" id="cb753-734" title="734"><span class="co"># (C) 2021, Jonathan Bahlmann, CC-BY-SA</span></a>
<a class="sourceLine" id="cb753-735" title="735"><span class="co"># https://github.com/Open-EO/openeo.org/tree/master/documentation/1.0/datacubes/.scripts</span></a>
<a class="sourceLine" id="cb753-736" title="736"><span class="co"># based on work by Edzer Pebesma, 2019, here: https://gist.github.com/edzer/5f1b0faa3e93073784e01d5a4bb60eca</span></a>
<a class="sourceLine" id="cb753-737" title="737"></a>
<a class="sourceLine" id="cb753-738" title="738"><span class="co"># plotting runs via a dummy stars object with x, y dimensions (no bands)</span></a>
<a class="sourceLine" id="cb753-739" title="739"><span class="co"># to not be overly dependent on an input image, time steps and bands</span></a>
<a class="sourceLine" id="cb753-740" title="740"><span class="co"># are displayed by replacing the matrix contained in the dummy stars object</span></a>
<a class="sourceLine" id="cb753-741" title="741"><span class="co"># every time something is plotted</span></a>
<a class="sourceLine" id="cb753-742" title="742"></a>
<a class="sourceLine" id="cb753-743" title="743"><span class="co"># packages, read input ----</span></a>
<a class="sourceLine" id="cb753-744" title="744"><span class="kw">set.seed</span>(<span class="dv">1331</span>)</a>
<a class="sourceLine" id="cb753-745" title="745"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb753-746" title="746"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(colorspace))</a>
<a class="sourceLine" id="cb753-747" title="747"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(scales))</a>
<a class="sourceLine" id="cb753-748" title="748"></a>
<a class="sourceLine" id="cb753-749" title="749"><span class="co"># make color palettes ----</span></a>
<a class="sourceLine" id="cb753-750" title="750">blues &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">211</span>, <span class="dt">c1 =</span> <span class="dv">80</span>, <span class="dt">l1 =</span> <span class="dv">40</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-751" title="751">greens &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">134</span>, <span class="dt">c1 =</span> <span class="dv">80</span>, <span class="dt">l1 =</span> <span class="dv">40</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-752" title="752">reds &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">360</span>, <span class="dt">c1 =</span> <span class="dv">80</span>, <span class="dt">l1 =</span> <span class="dv">40</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-753" title="753">purples &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">299</span>, <span class="dt">c1 =</span> <span class="dv">80</span>, <span class="dt">l1 =</span> <span class="dv">40</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-754" title="754">greys &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">0</span>, <span class="dt">c1 =</span> <span class="dv">0</span>, <span class="dt">l1 =</span> <span class="dv">40</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-755" title="755"></a>
<a class="sourceLine" id="cb753-756" title="756"><span class="co"># matrices from raster ----</span></a>
<a class="sourceLine" id="cb753-757" title="757"><span class="co"># make input matrices from an actual raster image</span></a>
<a class="sourceLine" id="cb753-758" title="758">input &lt;-<span class="st"> </span><span class="kw">read_stars</span>(<span class="st">&quot;data/iceland_delta_cutout_2.tif&quot;</span>) <span class="co"># this raster needs approx 6x7 format</span></a>
<a class="sourceLine" id="cb753-759" title="759"><span class="co"># if the input raster is changed, every image where a pixel value is written as text needs to be checked and corrected accordingly</span></a>
<a class="sourceLine" id="cb753-760" title="760">input &lt;-<span class="st"> </span>input[,,,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</a>
<a class="sourceLine" id="cb753-761" title="761">warped &lt;-<span class="st"> </span><span class="kw">st_warp</span>(input, <span class="dt">crs =</span> <span class="kw">st_crs</span>(input), <span class="dt">cellsize =</span> <span class="dv">200</span>) <span class="co"># warp to approx. 6x7 pixel</span></a>
<a class="sourceLine" id="cb753-762" title="762"></a>
<a class="sourceLine" id="cb753-763" title="763"><span class="co"># these are only needed for resampling</span></a>
<a class="sourceLine" id="cb753-764" title="764">warped_highres &lt;-<span class="st"> </span><span class="kw">st_warp</span>(warped, <span class="dt">crs =</span> <span class="kw">st_crs</span>(warped), <span class="dt">cellsize =</span> <span class="dv">100</span>) <span class="co"># with different input, cellsize must be adapted</span></a>
<a class="sourceLine" id="cb753-765" title="765"><span class="co"># this is a bit of a trick, because 3:4 is different format than 6:7</span></a>
<a class="sourceLine" id="cb753-766" title="766"><span class="co"># when downsampling, the raster of origin isn&#39;t so important anyway</span></a>
<a class="sourceLine" id="cb753-767" title="767">warped_lowres &lt;-<span class="st"> </span><span class="kw">st_warp</span>(warped_highres[,<span class="dv">1</span><span class="op">:</span><span class="dv">11</span>,,], <span class="dt">crs =</span> <span class="kw">st_crs</span>(warped), <span class="dt">cellsize =</span> <span class="dv">390</span>)</a>
<a class="sourceLine" id="cb753-768" title="768"><span class="co"># plot(warped_lowres)</span></a>
<a class="sourceLine" id="cb753-769" title="769"><span class="co"># image(warped[,,,1], text_values = TRUE)</span></a>
<a class="sourceLine" id="cb753-770" title="770"></a>
<a class="sourceLine" id="cb753-771" title="771">t1 &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">matrix</span>(<span class="kw">runif</span>(<span class="dv">42</span>, <span class="dv">-30</span>, <span class="dv">150</span>), <span class="dt">ncol =</span> <span class="dv">7</span>)) <span class="co"># create timesteps 2 and 3 randomly</span></a>
<a class="sourceLine" id="cb753-772" title="772">t2 &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">matrix</span>(<span class="kw">runif</span>(<span class="dv">42</span>, <span class="dv">-250</span>, <span class="dv">50</span>), <span class="dt">ncol =</span> <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb753-773" title="773"></a>
<a class="sourceLine" id="cb753-774" title="774"><span class="co"># create dummy stars object ----</span></a>
<a class="sourceLine" id="cb753-775" title="775">make_dummy_stars &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, d1, d2, aff) {</a>
<a class="sourceLine" id="cb753-776" title="776">  m =<span class="st"> </span>warped_highres[[<span class="dv">1</span>]][<span class="dv">1</span><span class="op">:</span>x,<span class="dv">1</span><span class="op">:</span>y,<span class="dv">1</span>] <span class="co"># underlying raster doesn&#39;t matter because it&#39;s just dummy construct</span></a>
<a class="sourceLine" id="cb753-777" title="777">  <span class="kw">dim</span>(m) =<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y) <span class="co"># named dim</span></a>
<a class="sourceLine" id="cb753-778" title="778">  dummy =<span class="st"> </span><span class="kw">st_as_stars</span>(m)</a>
<a class="sourceLine" id="cb753-779" title="779">  <span class="kw">attr</span>(dummy, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>delta =<span class="st"> </span>d1</a>
<a class="sourceLine" id="cb753-780" title="780">  <span class="kw">attr</span>(dummy, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>delta =<span class="st"> </span>d2</a>
<a class="sourceLine" id="cb753-781" title="781">  <span class="kw">attr</span>(<span class="kw">attr</span>(dummy, <span class="st">&quot;dimensions&quot;</span>), <span class="st">&quot;raster&quot;</span>)<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(aff, <span class="fl">0.0</span>)</a>
<a class="sourceLine" id="cb753-782" title="782">  <span class="kw">return</span>(dummy)</a>
<a class="sourceLine" id="cb753-783" title="783">}</a>
<a class="sourceLine" id="cb753-784" title="784"></a>
<a class="sourceLine" id="cb753-785" title="785">s &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="fl">2.5</span>, <span class="fl">-.5714286</span>, <span class="fl">-1.14</span>) <span class="co"># mainly used, perspective</span></a>
<a class="sourceLine" id="cb753-786" title="786">f &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>) <span class="co"># flat</span></a>
<a class="sourceLine" id="cb753-787" title="787">highres &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">12</span>, <span class="dv">14</span>, <span class="fl">1.25</span>, <span class="fl">-.2857143</span>, <span class="fl">-.57</span>) <span class="co"># for resampling</span></a>
<a class="sourceLine" id="cb753-788" title="788">lowres &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">-1</span>, <span class="dv">-2</span>) <span class="co"># for resampling</span></a>
<a class="sourceLine" id="cb753-789" title="789"></a>
<a class="sourceLine" id="cb753-790" title="790"><span class="co"># matrices from image ----</span></a>
<a class="sourceLine" id="cb753-791" title="791">make_matrix &lt;-<span class="st"> </span><span class="cf">function</span>(image, band, <span class="dt">n =</span> <span class="dv">42</span>, <span class="dt">ncol =</span> <span class="dv">7</span>, <span class="dt">t =</span> <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb753-792" title="792">  <span class="co"># this is based on an input image with &gt;= 4 input bands</span></a>
<a class="sourceLine" id="cb753-793" title="793">  <span class="co"># n is meant to cut off NAs, ncol is y, t is random matrix for time difference</span></a>
<a class="sourceLine" id="cb753-794" title="794">  <span class="kw">return</span>(<span class="kw">matrix</span>(image[,,,band][[<span class="dv">1</span>]][<span class="dv">1</span><span class="op">:</span>n], <span class="dt">ncol =</span> ncol) <span class="op">-</span><span class="st"> </span>t)</a>
<a class="sourceLine" id="cb753-795" title="795">  <span class="co"># before: b3 &lt;- matrix(warped[,,,1][[1]][1:42], ncol = 7) - t2</span></a>
<a class="sourceLine" id="cb753-796" title="796">}</a>
<a class="sourceLine" id="cb753-797" title="797"></a>
<a class="sourceLine" id="cb753-798" title="798"><span class="co"># now use function: </span></a>
<a class="sourceLine" id="cb753-799" title="799">b1 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-800" title="800">b2 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">1</span>, <span class="dt">t =</span> t1)</a>
<a class="sourceLine" id="cb753-801" title="801">b3 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">1</span>, <span class="dt">t =</span> t2)</a>
<a class="sourceLine" id="cb753-802" title="802">g1 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-803" title="803">g2 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">2</span>, <span class="dt">t =</span> t1)</a>
<a class="sourceLine" id="cb753-804" title="804">g3 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">2</span>, <span class="dt">t =</span> t2)</a>
<a class="sourceLine" id="cb753-805" title="805">r1 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-806" title="806">r2 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">3</span>, <span class="dt">t =</span> t1)</a>
<a class="sourceLine" id="cb753-807" title="807">r3 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">3</span>, <span class="dt">t =</span> t2)</a>
<a class="sourceLine" id="cb753-808" title="808">n1 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb753-809" title="809">n2 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">4</span>, <span class="dt">t =</span> t1)</a>
<a class="sourceLine" id="cb753-810" title="810">n3 &lt;-<span class="st"> </span><span class="kw">make_matrix</span>(warped, <span class="dv">4</span>, <span class="dt">t =</span> t2)</a>
<a class="sourceLine" id="cb753-811" title="811"></a>
<a class="sourceLine" id="cb753-812" title="812"><span class="co"># plot functions ----</span></a>
<a class="sourceLine" id="cb753-813" title="813">plt =<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">yoffset =</span> <span class="dv">0</span>, add, <span class="dt">li =</span> <span class="ot">TRUE</span>, pal, <span class="dt">print_geom =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="fl">.75</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>) {</a>
<a class="sourceLine" id="cb753-814" title="814">  <span class="co"># pal is color palette</span></a>
<a class="sourceLine" id="cb753-815" title="815">  <span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span><span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset <span class="op">+</span><span class="st"> </span>yoffset </a>
<a class="sourceLine" id="cb753-816" title="816">  l =<span class="st"> </span><span class="kw">st_as_sf</span>(x, <span class="dt">as_points =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-817" title="817">  <span class="cf">if</span> (li)</a>
<a class="sourceLine" id="cb753-818" title="818">    pal =<span class="st"> </span><span class="kw">lighten</span>(pal, <span class="fl">0.2</span>) <span class="co"># + rnorm(1, 0, 0.1))</span></a>
<a class="sourceLine" id="cb753-819" title="819">  <span class="cf">if</span> (<span class="op">!</span><span class="st"> </span>add)</a>
<a class="sourceLine" id="cb753-820" title="820">    <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">FALSE</span>, <span class="dt">breaks =</span> breaks, <span class="dt">pal =</span> pal, <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(border), <span class="dt">key.pos =</span> <span class="ot">NULL</span>, <span class="dt">main =</span> <span class="ot">NULL</span>, <span class="dt">xlab =</span> <span class="st">&quot;time&quot;</span>)</a>
<a class="sourceLine" id="cb753-821" title="821">  <span class="cf">else</span></a>
<a class="sourceLine" id="cb753-822" title="822">    <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">breaks =</span> breaks, <span class="dt">pal =</span> pal, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(border))</a>
<a class="sourceLine" id="cb753-823" title="823">  u =<span class="st"> </span><span class="kw">st_union</span>(l)</a>
<a class="sourceLine" id="cb753-824" title="824">  <span class="co"># print(u)</span></a>
<a class="sourceLine" id="cb753-825" title="825">  <span class="cf">if</span>(print_geom) {</a>
<a class="sourceLine" id="cb753-826" title="826">    <span class="kw">plot</span>(<span class="kw">st_geometry</span>(u), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">lwd =</span> <span class="fl">2.5</span>)</a>
<a class="sourceLine" id="cb753-827" title="827">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb753-828" title="828">    <span class="co"># not print geometry</span></a>
<a class="sourceLine" id="cb753-829" title="829">  }</a>
<a class="sourceLine" id="cb753-830" title="830">}</a>
<a class="sourceLine" id="cb753-831" title="831"></a>
<a class="sourceLine" id="cb753-832" title="832">pl_stack =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, nrM, <span class="dt">imgY =</span> <span class="dv">7</span>, <span class="dt">inner =</span> <span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb753-833" title="833">  <span class="co"># nrM is the timestep {1, 2, 3}, cause this function</span></a>
<a class="sourceLine" id="cb753-834" title="834">  <span class="co"># prints all 4 bands at once</span></a>
<a class="sourceLine" id="cb753-835" title="835">  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</a>
<a class="sourceLine" id="cb753-836" title="836">  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</a>
<a class="sourceLine" id="cb753-837" title="837">  <span class="co"># m = r[[1]][y + 1:nrow,x + 1:ncol,1]</span></a>
<a class="sourceLine" id="cb753-838" title="838">  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;n&quot;</span>, nrM)))</a>
<a class="sourceLine" id="cb753-839" title="839">  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)] <span class="co"># turn around to have same orientation as flat plot</span></a>
<a class="sourceLine" id="cb753-840" title="840">  <span class="kw">plt</span>(s, <span class="dv">0</span>, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> purples)</a>
<a class="sourceLine" id="cb753-841" title="841">  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;r&quot;</span>, nrM)))</a>
<a class="sourceLine" id="cb753-842" title="842">  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb753-843" title="843">  <span class="kw">plt</span>(s, <span class="dv">1</span><span class="op">*</span>inner, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> reds)</a>
<a class="sourceLine" id="cb753-844" title="844">  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;g&quot;</span>, nrM)))</a>
<a class="sourceLine" id="cb753-845" title="845">  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb753-846" title="846">  <span class="kw">plt</span>(s, <span class="dv">2</span><span class="op">*</span>inner, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> greens)</a>
<a class="sourceLine" id="cb753-847" title="847">  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;b&quot;</span>, nrM)))</a>
<a class="sourceLine" id="cb753-848" title="848">  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb753-849" title="849">  <span class="kw">plt</span>(s, <span class="dv">3</span><span class="op">*</span>inner, <span class="ot">TRUE</span>, <span class="dt">pal =</span> blues) <span class="co"># li FALSE deleted</span></a>
<a class="sourceLine" id="cb753-850" title="850">}</a>
<a class="sourceLine" id="cb753-851" title="851"></a>
<a class="sourceLine" id="cb753-852" title="852"><span class="co"># flat plot function</span></a>
<a class="sourceLine" id="cb753-853" title="853"><span class="co"># prints any dummy stars with any single matrix to position</span></a>
<a class="sourceLine" id="cb753-854" title="854">pl =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">randomize =</span> <span class="ot">FALSE</span>, pal, m, <span class="dt">print_geom =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="fl">.75</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>) {</a>
<a class="sourceLine" id="cb753-855" title="855">  <span class="co"># m is matrix to replace image with</span></a>
<a class="sourceLine" id="cb753-856" title="856">  <span class="co"># m &lt;- t(m)</span></a>
<a class="sourceLine" id="cb753-857" title="857">  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</a>
<a class="sourceLine" id="cb753-858" title="858">  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</a>
<a class="sourceLine" id="cb753-859" title="859">  <span class="co"># print(m)</span></a>
<a class="sourceLine" id="cb753-860" title="860">  s[[<span class="dv">1</span>]] =<span class="st"> </span>m</a>
<a class="sourceLine" id="cb753-861" title="861">  <span class="kw">plt</span>(s, <span class="dv">0</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">pal =</span> pal, <span class="dt">print_geom =</span> print_geom, <span class="dt">border =</span> border, <span class="dt">breaks =</span> breaks)</a>
<a class="sourceLine" id="cb753-862" title="862">  <span class="co">#plot(s, text_values = TRUE)</span></a>
<a class="sourceLine" id="cb753-863" title="863">}</a>
<a class="sourceLine" id="cb753-864" title="864"></a>
<a class="sourceLine" id="cb753-865" title="865">print_segments &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, seg, <span class="dt">by =</span> <span class="dv">1</span>, <span class="dt">lwd =</span> <span class="dv">4</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>) {</a>
<a class="sourceLine" id="cb753-866" title="866">  seg =<span class="st"> </span>seg <span class="op">*</span><span class="st"> </span>by</a>
<a class="sourceLine" id="cb753-867" title="867">  seg[,<span class="dv">1</span>] &lt;-<span class="st"> </span>seg[,<span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb753-868" title="868">  seg[,<span class="dv">3</span>] &lt;-<span class="st"> </span>seg[,<span class="dv">3</span>] <span class="op">+</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb753-869" title="869">  seg[,<span class="dv">2</span>] &lt;-<span class="st"> </span>seg[,<span class="dv">2</span>] <span class="op">+</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb753-870" title="870">  seg[,<span class="dv">4</span>] &lt;-<span class="st"> </span>seg[,<span class="dv">4</span>] <span class="op">+</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb753-871" title="871">  <span class="kw">segments</span>(seg[,<span class="dv">1</span>], seg[,<span class="dv">2</span>], seg[,<span class="dv">3</span>], seg[,<span class="dv">4</span>], <span class="dt">lwd =</span> lwd, <span class="dt">col =</span> col)</a>
<a class="sourceLine" id="cb753-872" title="872">}</a>
<a class="sourceLine" id="cb753-873" title="873"></a>
<a class="sourceLine" id="cb753-874" title="874"><span class="co"># time series ----</span></a>
<a class="sourceLine" id="cb753-875" title="875"></a>
<a class="sourceLine" id="cb753-876" title="876"><span class="co"># from: cube1_ts_6x7_bigger.png</span></a>
<a class="sourceLine" id="cb753-877" title="877">offset =<span class="st"> </span><span class="dv">26</span></a>
<a class="sourceLine" id="cb753-878" title="878"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb753-879" title="879"><span class="co">#par(mar = c(3, 2, 7, 2))</span></a>
<a class="sourceLine" id="cb753-880" title="880"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb753-881" title="881"><span class="co">#plot.window(xlim = c(10, 50), ylim = c(-3, 10), asp = 1)</span></a>
<a class="sourceLine" id="cb753-882" title="882"><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">15</span>, <span class="dv">75</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">3</span>, <span class="dv">10</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-883" title="883"><span class="kw">pl_stack</span>(s, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dt">nrM =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-884" title="884"><span class="kw">pl_stack</span>(s, offset, <span class="dv">0</span>, <span class="dt">nrM =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-885" title="885"><span class="kw">pl_stack</span>(s, <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>offset, <span class="dv">0</span>, <span class="dt">nrM =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-886" title="886"><span class="co"># po &lt;- matrix(c(0,-8,7,0,15,3.5,  0,1,1,5,5,14), ncol = 2)</span></a>
<a class="sourceLine" id="cb753-887" title="887">heads &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="fl">3.5</span>, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>offset, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>offset, <span class="dv">14</span>,<span class="dv">14</span>,<span class="dv">14</span>), <span class="dt">ncol =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-888" title="888"><span class="kw">points</span>(heads, <span class="dt">pch =</span> <span class="dv">16</span>) <span class="co"># 4 or 16</span></a>
<a class="sourceLine" id="cb753-889" title="889"><span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>), <span class="fl">3.5</span>, <span class="dv">14</span>) <span class="co"># first stack pyramid</span></a>
<a class="sourceLine" id="cb753-890" title="890"><span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>) <span class="op">+</span><span class="st"> </span>offset, <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>), <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>offset, <span class="dv">14</span>) <span class="co"># second stack pyramid</span></a>
<a class="sourceLine" id="cb753-891" title="891"><span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>) <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>offset, <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>), <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>offset, <span class="dv">14</span>) <span class="co"># third stack pyramid</span></a>
<a class="sourceLine" id="cb753-892" title="892"><span class="kw">arrows</span>(<span class="op">-</span><span class="dv">13</span>, <span class="dv">14</span>, <span class="dv">72</span>, <span class="dv">14</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)  <span class="co"># timeline</span></a>
<a class="sourceLine" id="cb753-893" title="893"><span class="kw">text</span>(<span class="fl">7.5</span>, <span class="fl">3.8</span>, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-894" title="894"><span class="kw">text</span>(<span class="op">-</span><span class="dv">10</span>, <span class="fl">-2.5</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-895" title="895"><span class="kw">text</span>(<span class="op">-</span><span class="fl">4.5</span>, <span class="fl">1.8</span>, <span class="st">&quot;y&quot;</span>, <span class="dt">srt =</span> <span class="fl">27.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-896" title="896">y =<span class="st"> </span><span class="fl">15.8</span></a>
<a class="sourceLine" id="cb753-897" title="897"><span class="kw">text</span>(<span class="dv">69</span>, y, <span class="st">&quot;time&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-898" title="898"><span class="kw">text</span>(<span class="fl">3.5</span>, y, <span class="st">&quot;2020-10-01&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-899" title="899"><span class="kw">text</span>(<span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>offset, y, <span class="st">&quot;2020-10-13&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-900" title="900"><span class="kw">text</span>(<span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>offset, y, <span class="st">&quot;2020-10-25&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-901" title="901"><span class="co"># flat ----</span></a>
<a class="sourceLine" id="cb753-902" title="902">xlabels &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset <span class="op">+</span><span class="st"> </span><span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>delta <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">length.out =</span> <span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>to, <span class="dt">by =</span> <span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>delta)</a>
<a class="sourceLine" id="cb753-903" title="903">ylabels &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset <span class="op">+</span><span class="st"> </span><span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>delta <span class="op">/</span><span class="st"> </span><span class="dv">2</span>, <span class="dt">length.out =</span> <span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>to, <span class="dt">by =</span> <span class="kw">attr</span>(warped, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>delta)</a>
<a class="sourceLine" id="cb753-904" title="904"></a>
<a class="sourceLine" id="cb753-905" title="905">print_labels &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, off, lab, horizontal, <span class="dt">cex =</span> <span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb753-906" title="906">  <span class="cf">if</span>(horizontal) { <span class="co"># x</span></a>
<a class="sourceLine" id="cb753-907" title="907">    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">0</span><span class="op">:</span>(<span class="kw">length</span>(lab)<span class="op">-</span><span class="dv">1</span>)) {</a>
<a class="sourceLine" id="cb753-908" title="908">      <span class="kw">text</span>(x <span class="op">+</span><span class="st"> </span>i<span class="op">*</span>off, y, lab[i<span class="op">+</span><span class="dv">1</span>], <span class="dt">cex =</span> cex, <span class="dt">srt =</span> <span class="dv">90</span>)</a>
<a class="sourceLine" id="cb753-909" title="909">    }</a>
<a class="sourceLine" id="cb753-910" title="910">  } <span class="cf">else</span> { <span class="co"># y</span></a>
<a class="sourceLine" id="cb753-911" title="911">    lab &lt;-<span class="st"> </span>lab[<span class="kw">length</span>(lab)<span class="op">:</span><span class="dv">0</span>]</a>
<a class="sourceLine" id="cb753-912" title="912">    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">0</span><span class="op">:</span>(<span class="kw">length</span>(lab)<span class="op">-</span><span class="dv">1</span>)) {</a>
<a class="sourceLine" id="cb753-913" title="913">      <span class="kw">text</span>(x, y <span class="op">+</span><span class="st"> </span>i<span class="op">*</span>off, lab[i<span class="op">+</span><span class="dv">1</span>], <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-914" title="914">    }</a>
<a class="sourceLine" id="cb753-915" title="915">  }</a>
<a class="sourceLine" id="cb753-916" title="916">}</a>
<a class="sourceLine" id="cb753-917" title="917"></a>
<a class="sourceLine" id="cb753-918" title="918"><span class="co"># before: width=1000, xlim(-2, 33), date labels x=31</span></a>
<a class="sourceLine" id="cb753-919" title="919"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb753-920" title="920"><span class="co"># par(mar = c(0,0,0,0))</span></a>
<a class="sourceLine" id="cb753-921" title="921"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb753-922" title="922"><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>, <span class="dv">40</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">25</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-923" title="923"><span class="kw">pl</span>(f, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b1)</a>
<a class="sourceLine" id="cb753-924" title="924"><span class="kw">pl</span>(f, <span class="dv">7</span>, <span class="dv">10</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b2)</a>
<a class="sourceLine" id="cb753-925" title="925"><span class="kw">pl</span>(f, <span class="dv">7</span>, <span class="dv">20</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3)</a>
<a class="sourceLine" id="cb753-926" title="926"><span class="kw">pl</span>(f, <span class="dv">14</span>, <span class="dv">0</span>, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g1)</a>
<a class="sourceLine" id="cb753-927" title="927"><span class="kw">pl</span>(f, <span class="dv">14</span>, <span class="dv">10</span>, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g2)</a>
<a class="sourceLine" id="cb753-928" title="928"><span class="kw">pl</span>(f, <span class="dv">14</span>, <span class="dv">20</span>, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g3)</a>
<a class="sourceLine" id="cb753-929" title="929"><span class="kw">pl</span>(f, <span class="dv">21</span>, <span class="dv">0</span>, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r1)</a>
<a class="sourceLine" id="cb753-930" title="930"><span class="kw">pl</span>(f, <span class="dv">21</span>, <span class="dv">10</span>, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r2)</a>
<a class="sourceLine" id="cb753-931" title="931"><span class="kw">pl</span>(f, <span class="dv">21</span>, <span class="dv">20</span>, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r3)</a>
<a class="sourceLine" id="cb753-932" title="932"><span class="kw">pl</span>(f, <span class="dv">28</span>, <span class="dv">0</span>, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n1)</a>
<a class="sourceLine" id="cb753-933" title="933"><span class="kw">pl</span>(f, <span class="dv">28</span>, <span class="dv">10</span>, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n2)</a>
<a class="sourceLine" id="cb753-934" title="934"><span class="kw">pl</span>(f, <span class="dv">28</span>, <span class="dv">20</span>, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n3)</a>
<a class="sourceLine" id="cb753-935" title="935"><span class="kw">print_labels</span>(<span class="fl">28.5</span>, <span class="dv">-2</span>, <span class="dv">1</span>, xlabels, <span class="dt">horizontal =</span> <span class="ot">TRUE</span>, <span class="dt">cex =</span> <span class="fl">0.7</span>)</a>
<a class="sourceLine" id="cb753-936" title="936"><span class="kw">print_labels</span>(<span class="dv">36</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, ylabels, <span class="dt">horizontal =</span> <span class="ot">FALSE</span>, <span class="dt">cex =</span> <span class="fl">0.7</span>)</a>
<a class="sourceLine" id="cb753-937" title="937"><span class="co"># arrows(6, 27, 6, 0, angle = 20, lwd = 2)</span></a>
<a class="sourceLine" id="cb753-938" title="938"><span class="co"># text(5, 14, &quot;time&quot;, srt = 90, col = &quot;black&quot;)</span></a>
<a class="sourceLine" id="cb753-939" title="939"><span class="kw">text</span>(<span class="dv">10</span>, <span class="dv">28</span>, <span class="st">&quot;blue&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-940" title="940"><span class="kw">text</span>(<span class="dv">17</span>, <span class="dv">28</span>, <span class="st">&quot;green&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-941" title="941"><span class="kw">text</span>(<span class="dv">24</span>, <span class="dv">28</span>, <span class="st">&quot;red&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-942" title="942"><span class="kw">text</span>(<span class="dv">31</span>, <span class="dv">28</span>, <span class="st">&quot;nir&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-943" title="943"><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">23.5</span>, <span class="st">&quot;2020-10-01&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-944" title="944"><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">13.5</span>, <span class="st">&quot;2020-10-13&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-945" title="945"><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">3.5</span>, <span class="st">&quot;2020-10-25&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-946" title="946"><span class="co"># filter ----</span></a>
<a class="sourceLine" id="cb753-947" title="947"><span class="co"># mask &lt;- matrix(c(rep(NA, 26), 1,NA,1,NA,1,1,1, rep(NA, 9)), ncol = 7)</span></a>
<a class="sourceLine" id="cb753-948" title="948">mask &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb753-949" title="949">                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb753-950" title="950">                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb753-951" title="951">                 <span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb753-952" title="952">                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb753-953" title="953">                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb753-954" title="954">                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>), <span class="dt">ncol =</span> <span class="dv">7</span>)</a>
<a class="sourceLine" id="cb753-955" title="955"></a>
<a class="sourceLine" id="cb753-956" title="956">print_grid &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb753-957" title="957">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b1)</a>
<a class="sourceLine" id="cb753-958" title="958">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b2)</a>
<a class="sourceLine" id="cb753-959" title="959">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3)</a>
<a class="sourceLine" id="cb753-960" title="960">  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g1)</a>
<a class="sourceLine" id="cb753-961" title="961">  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g2)</a>
<a class="sourceLine" id="cb753-962" title="962">  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g3)</a>
<a class="sourceLine" id="cb753-963" title="963">  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r1)</a>
<a class="sourceLine" id="cb753-964" title="964">  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r2)</a>
<a class="sourceLine" id="cb753-965" title="965">  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r3)</a>
<a class="sourceLine" id="cb753-966" title="966">  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n1)</a>
<a class="sourceLine" id="cb753-967" title="967">  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n2)</a>
<a class="sourceLine" id="cb753-968" title="968">  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n3)</a>
<a class="sourceLine" id="cb753-969" title="969">}</a>
<a class="sourceLine" id="cb753-970" title="970">print_alpha_grid &lt;-<span class="st"> </span><span class="cf">function</span>(x,y, <span class="dt">alp =</span> <span class="fl">0.2</span>, <span class="dt">geom =</span> <span class="ot">FALSE</span>) {</a>
<a class="sourceLine" id="cb753-971" title="971">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(blues, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> b1, <span class="dt">border =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-972" title="972">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(blues, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> b2, <span class="dt">border =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-973" title="973">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(blues, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> b3, <span class="dt">border =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-974" title="974">  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(greens, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> g1, <span class="dt">border =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-975" title="975">  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(greens, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> g2, <span class="dt">border =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-976" title="976">  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(greens, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> g3, <span class="dt">border =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-977" title="977">  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(reds, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> r1, <span class="dt">border =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-978" title="978">  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(reds, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> r2, <span class="dt">border =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-979" title="979">  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(reds, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> r3, <span class="dt">border =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-980" title="980">  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(purples, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> n1, <span class="dt">border =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-981" title="981">  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(purples, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> n2, <span class="dt">border =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-982" title="982">  <span class="kw">invisible</span>(<span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> <span class="kw">alpha</span>(purples, alp), <span class="dt">print_geom =</span> geom,  <span class="dt">m =</span> n3, <span class="dt">border =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb753-983" title="983">}</a>
<a class="sourceLine" id="cb753-984" title="984"></a>
<a class="sourceLine" id="cb753-985" title="985">print_grid_filter &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb753-986" title="986">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">matrix</span>(b1[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb753-987" title="987">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">matrix</span>(b2[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb753-988" title="988">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">matrix</span>(b3[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb753-989" title="989">  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> <span class="kw">matrix</span>(g1[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb753-990" title="990">  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> <span class="kw">matrix</span>(g2[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb753-991" title="991">  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> <span class="kw">matrix</span>(g3[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb753-992" title="992">  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> <span class="kw">matrix</span>(r1[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb753-993" title="993">  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> <span class="kw">matrix</span>(r2[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb753-994" title="994">  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> <span class="kw">matrix</span>(r3[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb753-995" title="995">  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> <span class="kw">matrix</span>(n1[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb753-996" title="996">  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> <span class="kw">matrix</span>(n2[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb753-997" title="997">  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> <span class="kw">matrix</span>(n3[mask <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb753-998" title="998">}</a>
<a class="sourceLine" id="cb753-999" title="999"></a>
<a class="sourceLine" id="cb753-1000" title="1000">print_grid_time_filter &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) { <span class="co"># 3x1, 28x7</span></a>
<a class="sourceLine" id="cb753-1001" title="1001">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3)</a>
<a class="sourceLine" id="cb753-1002" title="1002">  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g3)</a>
<a class="sourceLine" id="cb753-1003" title="1003">  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r3)</a>
<a class="sourceLine" id="cb753-1004" title="1004">  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n3)</a>
<a class="sourceLine" id="cb753-1005" title="1005">}</a>
<a class="sourceLine" id="cb753-1006" title="1006"></a>
<a class="sourceLine" id="cb753-1007" title="1007">print_grid_bands_filter &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, <span class="dt">pal =</span> greys) { <span class="co"># 1x3 6x27</span></a>
<a class="sourceLine" id="cb753-1008" title="1008">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> n1)</a>
<a class="sourceLine" id="cb753-1009" title="1009">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> n2)</a>
<a class="sourceLine" id="cb753-1010" title="1010">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> n3)</a>
<a class="sourceLine" id="cb753-1011" title="1011">}</a>
<a class="sourceLine" id="cb753-1012" title="1012"></a>
<a class="sourceLine" id="cb753-1013" title="1013"><span class="co"># build exactly like reduce</span></a>
<a class="sourceLine" id="cb753-1014" title="1014"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb753-1015" title="1015"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb753-1016" title="1016">x =<span class="st"> </span><span class="dv">120</span></a>
<a class="sourceLine" id="cb753-1017" title="1017">y =<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb753-1018" title="1018">down =<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb753-1019" title="1019"><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, x), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, y), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-1020" title="1020"><span class="kw">print_grid</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-27</span>)</a>
<a class="sourceLine" id="cb753-1021" title="1021"><span class="kw">print_alpha_grid</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>, <span class="dv">0</span><span class="op">-</span>down) <span class="co"># alpha grid</span></a>
<a class="sourceLine" id="cb753-1022" title="1022"><span class="kw">print_grid_time_filter</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>, <span class="dv">-10</span><span class="op">-</span>down) <span class="co"># select 3rd</span></a>
<a class="sourceLine" id="cb753-1023" title="1023"><span class="kw">print_alpha_grid</span>(x<span class="op">/</span><span class="dv">3</span><span class="op">+</span>((x<span class="op">/</span><span class="dv">3-6</span>)<span class="op">/</span><span class="dv">2</span>) <span class="fl">-10.5</span>, <span class="dv">0</span><span class="op">-</span>down) <span class="co"># alpha grid</span></a>
<a class="sourceLine" id="cb753-1024" title="1024"><span class="kw">print_grid_bands_filter</span>(x<span class="op">/</span><span class="dv">3</span><span class="op">+</span>((x<span class="op">/</span><span class="dv">3</span><span class="fl">-12.4</span>)), <span class="dv">0</span><span class="op">-</span>down, <span class="dt">pal =</span> purples)</a>
<a class="sourceLine" id="cb753-1025" title="1025"><span class="kw">print_alpha_grid</span>(<span class="dv">2</span><span class="op">*</span>(x<span class="op">/</span><span class="dv">3</span>)<span class="op">+</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span><span class="op">-</span>down) <span class="co"># alpha grid</span></a>
<a class="sourceLine" id="cb753-1026" title="1026"><span class="kw">print_grid_filter</span>(<span class="dv">2</span><span class="op">*</span>(x<span class="op">/</span><span class="dv">3</span>)<span class="op">+</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span><span class="op">-</span>down)</a>
<a class="sourceLine" id="cb753-1027" title="1027"><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">13.5</span><span class="op">-</span>down, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1028" title="1028"><span class="kw">text</span>(<span class="dv">43</span>, <span class="fl">13.5</span><span class="op">-</span>down, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1029" title="1029"><span class="kw">text</span>(<span class="dv">83</span>, <span class="fl">13.5</span><span class="op">-</span>down, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1030" title="1030"><span class="kw">text</span>(<span class="dv">20</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1031" title="1031"><span class="kw">text</span>(<span class="dv">60</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1032" title="1032"><span class="kw">text</span>(<span class="dv">100</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1033" title="1033"><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, x<span class="op">/</span><span class="dv">6</span>,<span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-1034" title="1034"><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, x<span class="op">/</span><span class="dv">2</span>,<span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-1035" title="1035"><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2</span><span class="op">+</span><span class="dv">28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, <span class="dv">100</span>, <span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-1036" title="1036"><span class="co"># points(seq(1,120,10), seq(1,120,10))</span></a>
<a class="sourceLine" id="cb753-1037" title="1037"><span class="kw">text</span>(<span class="fl">28.5</span>,<span class="dv">49</span>, <span class="st">&quot;filter temporally&quot;</span>, <span class="dt">srt =</span> <span class="fl">55.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb753-1038" title="1038"><span class="kw">text</span>(<span class="dv">57</span>,<span class="dv">49</span>, <span class="st">&quot;filter bands&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb753-1039" title="1039"><span class="kw">text</span>(<span class="fl">91.5</span>,<span class="dv">49</span>, <span class="st">&quot;filter spatially&quot;</span>, <span class="dt">srt =</span> <span class="fl">-55.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb753-1040" title="1040"><span class="kw">print_labels</span>(<span class="dt">x =</span> x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">y =</span> y<span class="op">+</span><span class="dv">4</span>, <span class="dt">off =</span> <span class="dv">7</span>, <span class="dt">lab =</span> <span class="kw">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;green&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;nir&quot;</span>),</a>
<a class="sourceLine" id="cb753-1041" title="1041">             <span class="dt">horizontal =</span> <span class="ot">TRUE</span>, <span class="dt">cex =</span> <span class="fl">0.6</span>)</a>
<a class="sourceLine" id="cb753-1042" title="1042"><span class="kw">print_labels</span>(<span class="dt">x =</span> x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">-</span><span class="st"> </span><span class="dv">9</span>, <span class="dt">y =</span> y<span class="dv">-23</span>, <span class="dt">off =</span> <span class="dv">10</span>, <span class="dt">lab =</span> <span class="kw">c</span>(<span class="st">&quot;2020-10-01&quot;</span>, <span class="st">&quot;2020-10-13&quot;</span>, <span class="st">&quot;2020-10-25&quot;</span>),</a>
<a class="sourceLine" id="cb753-1043" title="1043">             <span class="dt">horizontal =</span> <span class="ot">FALSE</span>, <span class="dt">cex =</span> <span class="fl">0.6</span>)</a>
<a class="sourceLine" id="cb753-1044" title="1044"><span class="kw">print_labels</span>(<span class="dt">x =</span> x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="fl">21.5</span>, <span class="dt">y =</span> y<span class="dv">-30</span>, <span class="dt">off =</span> <span class="dv">1</span>, <span class="dt">lab =</span> xlabels,</a>
<a class="sourceLine" id="cb753-1045" title="1045">             <span class="dt">horizontal =</span> <span class="ot">TRUE</span>, <span class="dt">cex =</span> <span class="fl">0.3</span>)</a>
<a class="sourceLine" id="cb753-1046" title="1046"><span class="kw">print_labels</span>(<span class="dt">x =</span> x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">30</span>, <span class="dt">y =</span> y<span class="fl">-26.5</span>, <span class="dt">off =</span> <span class="dv">1</span>, <span class="dt">lab =</span> ylabels,</a>
<a class="sourceLine" id="cb753-1047" title="1047">             <span class="dt">horizontal =</span> <span class="ot">FALSE</span>, <span class="dt">cex =</span> <span class="fl">0.3</span>)</a>
<a class="sourceLine" id="cb753-1048" title="1048"><span class="co"># apply ----</span></a>
<a class="sourceLine" id="cb753-1049" title="1049">print_text =<span class="st"> </span><span class="cf">function</span>(s, x, y, m) {</a>
<a class="sourceLine" id="cb753-1050" title="1050">  <span class="co"># m &lt;- t(m) # transverse for correct order</span></a>
<a class="sourceLine" id="cb753-1051" title="1051">  <span class="co"># print(m)</span></a>
<a class="sourceLine" id="cb753-1052" title="1052">  r &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">seq</span>(<span class="fl">0.5</span>, <span class="fl">5.5</span>, <span class="dv">1</span>), <span class="dv">7</span>)</a>
<a class="sourceLine" id="cb753-1053" title="1053">  r &lt;-<span class="st"> </span>r <span class="op">+</span><span class="st"> </span>x <span class="co"># consider offsets</span></a>
<a class="sourceLine" id="cb753-1054" title="1054">  u &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">rep</span>(<span class="fl">0.5</span>, <span class="dv">6</span>), <span class="kw">rep</span>(<span class="fl">1.5</span>, <span class="dv">6</span>), <span class="kw">rep</span>(<span class="fl">2.5</span>, <span class="dv">6</span>), </a>
<a class="sourceLine" id="cb753-1055" title="1055">         <span class="kw">rep</span>(<span class="fl">3.5</span>, <span class="dv">6</span>), <span class="kw">rep</span>(<span class="fl">4.5</span>, <span class="dv">6</span>), <span class="kw">rep</span>(<span class="fl">5.5</span>, <span class="dv">6</span>), <span class="kw">rep</span>(<span class="fl">6.5</span>, <span class="dv">6</span>))</a>
<a class="sourceLine" id="cb753-1056" title="1056">  u &lt;-<span class="st"> </span>u <span class="op">+</span><span class="st"> </span>y <span class="co"># offset</span></a>
<a class="sourceLine" id="cb753-1057" title="1057">  tab &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(r,u), <span class="dt">nrow =</span> <span class="dv">42</span>, <span class="dt">byrow =</span> <span class="ot">FALSE</span>) <span class="co"># make point table</span></a>
<a class="sourceLine" id="cb753-1058" title="1058">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">42</span>) {</a>
<a class="sourceLine" id="cb753-1059" title="1059">    <span class="co">#text(tab[i, 1], tab[i, 2], labels = paste0(&quot;&quot;, m[i]), cex = 1.1)</span></a>
<a class="sourceLine" id="cb753-1060" title="1060">    <span class="kw">text</span>(tab[i, <span class="dv">1</span>], tab[i, <span class="dv">2</span>], <span class="dt">labels =</span> <span class="kw">paste0</span>(<span class="st">&quot;&quot;</span>, m[i]), <span class="dt">cex =</span> <span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb753-1061" title="1061">    }</a>
<a class="sourceLine" id="cb753-1062" title="1062">}</a>
<a class="sourceLine" id="cb753-1063" title="1063"></a>
<a class="sourceLine" id="cb753-1064" title="1064">abs_brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">500</span>,<span class="dv">500</span>, <span class="dv">50</span>)</a>
<a class="sourceLine" id="cb753-1065" title="1065">abs_pal &lt;-<span class="st"> </span><span class="kw">sequential_hcl</span>(<span class="dt">n =</span> <span class="dv">20</span>, <span class="dt">h1 =</span> <span class="dv">211</span>, <span class="dt">c1 =</span> <span class="dv">80</span>, <span class="dt">l1 =</span> <span class="dv">30</span>, <span class="dt">l2 =</span> <span class="dv">100</span>, <span class="dt">p1 =</span> <span class="fl">1.2</span>)</a>
<a class="sourceLine" id="cb753-1066" title="1066"></a>
<a class="sourceLine" id="cb753-1067" title="1067"><span class="co">#png(&quot;exp_apply_unary.png&quot;, width = 2400, height = 1000, pointsize = 24)</span></a>
<a class="sourceLine" id="cb753-1068" title="1068"><span class="co">#plot.new()</span></a>
<a class="sourceLine" id="cb753-1069" title="1069"><span class="co">#par(mar = c(2,2,2,2))</span></a>
<a class="sourceLine" id="cb753-1070" title="1070"><span class="co">#x = 30</span></a>
<a class="sourceLine" id="cb753-1071" title="1071"><span class="co">#y = 7.5</span></a>
<a class="sourceLine" id="cb753-1072" title="1072"><span class="co">#plot.window(xlim = c(0, x), ylim = c(0, y), asp = 1)</span></a>
<a class="sourceLine" id="cb753-1073" title="1073"><span class="co">#pl(f, 3, 2, pal = abs_pal, m = b3 - 200, breaks = abs_brks)</span></a>
<a class="sourceLine" id="cb753-1074" title="1074"><span class="co">#pl(f, 1.5, .5, pal = abs_pal, m = b2 - 200, breaks = abs_brks)</span></a>
<a class="sourceLine" id="cb753-1075" title="1075"><span class="co">#pl(f, 0, -1, pal = abs_pal, m = b1 - 200, breaks = abs_brks)</span></a>
<a class="sourceLine" id="cb753-1076" title="1076"><span class="co">#print_text(s, 0, -1, m = b1 - 200)</span></a>
<a class="sourceLine" id="cb753-1077" title="1077"><span class="co">#pl(f, 23, 2, pal = abs_pal, m = abs(b3 - 200), breaks = abs_brks)</span></a>
<a class="sourceLine" id="cb753-1078" title="1078"><span class="co">#pl(f, 21.5, 0.5, pal = abs_pal, m = abs(b2 - 200), breaks = abs_brks)</span></a>
<a class="sourceLine" id="cb753-1079" title="1079"><span class="co">#pl(f, 20, -1, pal = abs_pal, m = abs(b1 - 200), breaks = abs_brks)</span></a>
<a class="sourceLine" id="cb753-1080" title="1080"><span class="co">#print_text(s, 20, -1, m = abs(b1 - 200))</span></a>
<a class="sourceLine" id="cb753-1081" title="1081"><span class="co">#arrows(11, 4, 17.5, 4, lwd = 3)</span></a>
<a class="sourceLine" id="cb753-1082" title="1082"><span class="co">#text(14.3, 3.5, &quot;absolute()&quot;, cex = 1.4)</span></a>
<a class="sourceLine" id="cb753-1083" title="1083"><span class="co">#dev.off()</span></a>
<a class="sourceLine" id="cb753-1084" title="1084"></a>
<a class="sourceLine" id="cb753-1085" title="1085">vNeumann_seg &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), </a>
<a class="sourceLine" id="cb753-1086" title="1086">                         <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>)), <span class="dt">ncol =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb753-1087" title="1087"></a>
<a class="sourceLine" id="cb753-1088" title="1088">apply_filter &lt;-<span class="st"> </span><span class="cf">function</span>(input, <span class="dt">pad =</span> <span class="ot">TRUE</span>, <span class="dt">padValue =</span> <span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb753-1089" title="1089">  ras &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">focal</span>(raster<span class="op">::</span><span class="kw">raster</span>(input), <span class="dt">w =</span> <span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="fl">0.2</span>,<span class="dv">0</span>, <span class="fl">0.2</span>,<span class="fl">0.2</span>,<span class="fl">0.2</span>, <span class="dv">0</span>,<span class="fl">0.2</span>,<span class="dv">0</span>), <span class="dt">ncol =</span> <span class="dv">3</span>), <span class="dt">pad =</span> pad, <span class="dt">padValue =</span> padValue)</a>
<a class="sourceLine" id="cb753-1090" title="1090">  ras &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">as.matrix</span>(ras)</a>
<a class="sourceLine" id="cb753-1091" title="1091">  ras[ras <span class="op">==</span><span class="st"> &quot;NaN&quot;</span>] &lt;-<span class="st"> </span><span class="dv">-999</span></a>
<a class="sourceLine" id="cb753-1092" title="1092">  <span class="kw">return</span>(<span class="kw">floor</span>(ras))</a>
<a class="sourceLine" id="cb753-1093" title="1093">}</a>
<a class="sourceLine" id="cb753-1094" title="1094"></a>
<a class="sourceLine" id="cb753-1095" title="1095">brks &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">1000</span>, <span class="dv">50</span>)</a>
<a class="sourceLine" id="cb753-1096" title="1096"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb753-1097" title="1097"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb753-1098" title="1098">x =<span class="st"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb753-1099" title="1099">y =<span class="st"> </span><span class="fl">7.5</span></a>
<a class="sourceLine" id="cb753-1100" title="1100"><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, x), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, y), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-1101" title="1101"><span class="kw">pl</span>(f, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3, <span class="dt">breaks =</span> brks)</a>
<a class="sourceLine" id="cb753-1102" title="1102"><span class="kw">pl</span>(f, <span class="fl">1.5</span>, <span class="fl">.5</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b2, <span class="dt">breaks =</span> brks)</a>
<a class="sourceLine" id="cb753-1103" title="1103"><span class="kw">pl</span>(f, <span class="dv">0</span>, <span class="dv">-1</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b1, <span class="dt">breaks =</span> brks)</a>
<a class="sourceLine" id="cb753-1104" title="1104"><span class="kw">print_text</span>(s, <span class="dv">0</span>, <span class="dv">-1</span>, <span class="dt">m =</span> b1) <span class="co"># print text on left first stack</span></a>
<a class="sourceLine" id="cb753-1105" title="1105"><span class="kw">print_segments</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dt">seg =</span> vNeumann_seg, <span class="dt">lwd =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1106" title="1106"><span class="kw">pl</span>(f, <span class="dv">23</span>, <span class="dv">2</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">apply_filter</span>(b3), <span class="dt">breaks =</span> brks)</a>
<a class="sourceLine" id="cb753-1107" title="1107"><span class="kw">pl</span>(f, <span class="fl">21.5</span>, <span class="fl">0.5</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">apply_filter</span>(b2), <span class="dt">breaks =</span> brks)</a>
<a class="sourceLine" id="cb753-1108" title="1108"><span class="kw">pl</span>(f, <span class="dv">20</span>, <span class="dv">-1</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> <span class="kw">apply_filter</span>(b1), <span class="dt">breaks =</span> brks)</a>
<a class="sourceLine" id="cb753-1109" title="1109"><span class="kw">print_text</span>(s, <span class="dv">20</span>, <span class="dv">-1</span>, <span class="dt">m =</span> <span class="kw">apply_filter</span>(b1)) <span class="co"># set pad = FALSE for -99</span></a>
<a class="sourceLine" id="cb753-1110" title="1110"><span class="kw">print_segments</span>(<span class="dv">22</span>, <span class="dv">3</span>, <span class="dt">seg =</span> vNeumann_seg, <span class="dt">lwd =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1111" title="1111"><span class="kw">arrows</span>(<span class="dv">11</span>, <span class="dv">4</span>, <span class="fl">17.5</span>, <span class="dv">4</span>, <span class="dt">lwd =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1112" title="1112"><span class="kw">text</span>(<span class="fl">14.3</span>, <span class="fl">3.5</span>, <span class="st">&quot;apply_kernel()&quot;</span>, <span class="dt">cex =</span> <span class="fl">1.4</span>)</a>
<a class="sourceLine" id="cb753-1113" title="1113"><span class="kw">print_segments</span>(<span class="fl">13.8</span>, <span class="dv">1</span>, <span class="dt">seg =</span> vNeumann_seg, <span class="dt">lwd =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1114" title="1114">cex =<span class="st"> </span><span class="fl">.8</span></a>
<a class="sourceLine" id="cb753-1115" title="1115"><span class="kw">text</span>(<span class="fl">14.3</span>, <span class="fl">1.5</span>, <span class="st">&quot;0.2&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1116" title="1116"><span class="kw">text</span>(<span class="fl">13.3</span>, <span class="fl">1.5</span>, <span class="st">&quot;0.2&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1117" title="1117"><span class="kw">text</span>(<span class="fl">15.3</span>, <span class="fl">1.5</span>, <span class="st">&quot;0.2&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1118" title="1118"><span class="kw">text</span>(<span class="fl">14.3</span>, <span class="fl">2.5</span>, <span class="st">&quot;0.2&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1119" title="1119"><span class="kw">text</span>(<span class="fl">14.3</span>, <span class="fl">.5</span>, <span class="st">&quot;0.2&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1120" title="1120"></a>
<a class="sourceLine" id="cb753-1121" title="1121">time_arrow_seg &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">c</span>(<span class="op">-</span><span class="fl">1.0</span>, <span class="fl">0.3</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span>, <span class="fl">5.1</span>), <span class="kw">c</span>(<span class="op">-</span><span class="fl">1.0</span>, <span class="fl">0.3</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span>, <span class="fl">5.1</span>),</a>
<a class="sourceLine" id="cb753-1122" title="1122">                           <span class="kw">c</span>(<span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">4.3</span>, <span class="fl">5.6</span>), <span class="kw">c</span>(<span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">4.3</span>, <span class="fl">5.6</span>)), <span class="dt">ncol =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb753-1123" title="1123">time_arrow_flag_seg &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">c</span>(<span class="op">-</span><span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span>), <span class="kw">c</span>(<span class="op">-</span><span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.7</span>, <span class="fl">3.9</span>),</a>
<a class="sourceLine" id="cb753-1124" title="1124">                                <span class="kw">c</span>(<span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">5.6</span>), <span class="kw">c</span>(<span class="fl">0.7</span>, <span class="fl">1.9</span>, <span class="fl">3.1</span>, <span class="fl">5.6</span>)), <span class="dt">ncol =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb753-1125" title="1125"></a>
<a class="sourceLine" id="cb753-1126" title="1126">b11 &lt;-<span class="st"> </span>b2 <span class="op">-</span><span class="st"> </span>t1</a>
<a class="sourceLine" id="cb753-1127" title="1127">b12 &lt;-<span class="st"> </span>b1 <span class="op">-</span><span class="st"> </span>t2 <span class="op">+</span><span class="st"> </span>t1</a>
<a class="sourceLine" id="cb753-1128" title="1128"></a>
<a class="sourceLine" id="cb753-1129" title="1129"><span class="co"># png(&quot;exp_apply_ts.png&quot;, width = 2400, height = 1000, pointsize = 24)</span></a>
<a class="sourceLine" id="cb753-1130" title="1130"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb753-1131" title="1131"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-1132" title="1132">x =<span class="st"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb753-1133" title="1133">y =<span class="st"> </span><span class="dv">10</span> <span class="co"># 7.5</span></a>
<a class="sourceLine" id="cb753-1134" title="1134"><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, x), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, y), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-1135" title="1135"><span class="kw">pl</span>(f, <span class="fl">4.8</span>, <span class="fl">3.8</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3, <span class="dt">breaks =</span> brks)</a>
<a class="sourceLine" id="cb753-1136" title="1136"><span class="kw">print_text</span>(s, <span class="fl">4.8</span>, <span class="fl">3.8</span>, <span class="dt">m =</span> b3)</a>
<a class="sourceLine" id="cb753-1137" title="1137"><span class="kw">pl</span>(f, <span class="fl">3.6</span>, <span class="fl">2.6</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b11, <span class="dt">breaks =</span> brks)</a>
<a class="sourceLine" id="cb753-1138" title="1138"><span class="kw">print_text</span>(s, <span class="fl">3.6</span>, <span class="fl">2.6</span>, <span class="dt">m =</span> b11)</a>
<a class="sourceLine" id="cb753-1139" title="1139"><span class="kw">pl</span>(f, <span class="fl">2.4</span>, <span class="fl">1.4</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b12, <span class="dt">breaks =</span> brks)</a>
<a class="sourceLine" id="cb753-1140" title="1140"><span class="kw">print_text</span>(s, <span class="fl">2.4</span>, <span class="fl">1.4</span>, <span class="dt">m =</span> b12)</a>
<a class="sourceLine" id="cb753-1141" title="1141"><span class="kw">pl</span>(f, <span class="fl">1.2</span>, <span class="fl">.2</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b2, <span class="dt">breaks =</span> brks)</a>
<a class="sourceLine" id="cb753-1142" title="1142"><span class="kw">print_text</span>(s, <span class="fl">1.2</span>, <span class="fl">.2</span>, <span class="dt">m =</span> b2)</a>
<a class="sourceLine" id="cb753-1143" title="1143"><span class="kw">pl</span>(f, <span class="dv">0</span>, <span class="dv">-1</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b1, <span class="dt">breaks =</span> brks)</a>
<a class="sourceLine" id="cb753-1144" title="1144"><span class="kw">print_text</span>(s, <span class="dv">0</span>, <span class="dv">-1</span>, <span class="dt">m =</span> b1) <span class="co"># print text on left first stack</span></a>
<a class="sourceLine" id="cb753-1145" title="1145"><span class="kw">pl</span>(f, <span class="fl">24.8</span>, <span class="fl">3.8</span>, <span class="dt">pal =</span> <span class="kw">alpha</span>(greys, <span class="fl">0.1</span>), <span class="dt">m =</span> <span class="kw">matrix</span>(<span class="kw">rep</span>(<span class="st">&quot;NA&quot;</span>, <span class="dv">42</span>), <span class="dt">ncol =</span> <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb753-1146" title="1146"><span class="kw">pl</span>(f, <span class="fl">23.6</span>, <span class="fl">2.6</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> (b12 <span class="op">+</span><span class="st"> </span>b11 <span class="op">+</span><span class="st"> </span>b3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">breaks =</span> brks)</a>
<a class="sourceLine" id="cb753-1147" title="1147"><span class="kw">print_text</span>(s, <span class="fl">23.6</span>, <span class="fl">2.6</span>, <span class="dt">m =</span> <span class="kw">floor</span>((b12 <span class="op">+</span><span class="st"> </span>b11 <span class="op">+</span><span class="st"> </span>b3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>))</a>
<a class="sourceLine" id="cb753-1148" title="1148"><span class="kw">pl</span>(f, <span class="fl">22.4</span>, <span class="fl">1.4</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> (b2 <span class="op">+</span><span class="st"> </span>b12 <span class="op">+</span><span class="st"> </span>b11) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">breaks =</span> brks)</a>
<a class="sourceLine" id="cb753-1149" title="1149"><span class="kw">print_text</span>(s, <span class="fl">22.4</span>, <span class="fl">1.4</span>, <span class="dt">m =</span> <span class="kw">floor</span>((b2 <span class="op">+</span><span class="st"> </span>b12 <span class="op">+</span><span class="st"> </span>b11) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>))</a>
<a class="sourceLine" id="cb753-1150" title="1150"><span class="kw">pl</span>(f, <span class="fl">21.2</span>, <span class="fl">.2</span>, <span class="dt">pal =</span> blues, <span class="dt">m =</span> (b1 <span class="op">+</span><span class="st"> </span>b2 <span class="op">+</span><span class="st"> </span>b12) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>, <span class="dt">breaks =</span> brks)</a>
<a class="sourceLine" id="cb753-1151" title="1151"><span class="kw">print_text</span>(s, <span class="fl">21.2</span>, <span class="fl">.2</span>, <span class="dt">m =</span> <span class="kw">floor</span>((b1 <span class="op">+</span><span class="st"> </span>b2 <span class="op">+</span><span class="st"> </span>b12) <span class="op">/</span><span class="st"> </span><span class="dv">3</span>))</a>
<a class="sourceLine" id="cb753-1152" title="1152"><span class="kw">pl</span>(f, <span class="dv">20</span>, <span class="dv">-1</span>, <span class="dt">pal =</span> <span class="kw">alpha</span>(greys, <span class="fl">0.1</span>), <span class="dt">m =</span> <span class="kw">matrix</span>(<span class="kw">rep</span>(<span class="st">&quot;NA&quot;</span>, <span class="dv">42</span>), <span class="dt">ncol =</span> <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb753-1153" title="1153"><span class="kw">print_segments</span>(<span class="fl">5.7</span>, <span class="fl">1.7</span>, <span class="dt">seg =</span> time_arrow_seg, <span class="dt">col =</span> <span class="st">&quot;forestgreen&quot;</span>)</a>
<a class="sourceLine" id="cb753-1154" title="1154"><span class="kw">arrows</span>(<span class="fl">12.5</span>, <span class="dv">9</span>, <span class="dv">20</span>, <span class="dv">9</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-1155" title="1155">cex =<span class="st"> </span><span class="fl">.9</span></a>
<a class="sourceLine" id="cb753-1156" title="1156"><span class="kw">text</span>(<span class="fl">16.3</span>, <span class="fl">8.3</span>, <span class="st">&quot;apply_dimension(dimension = &#39;t&#39;)&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1157" title="1157"><span class="kw">print_segments</span>(<span class="fl">9.7</span>, <span class="fl">1.7</span>, time_arrow_seg, <span class="dt">col =</span> <span class="st">&quot;forestgreen&quot;</span>) <span class="co"># draw ma explanation</span></a>
<a class="sourceLine" id="cb753-1158" title="1158"><span class="kw">text</span>(<span class="op">-</span><span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">-0.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;496&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1159" title="1159"><span class="kw">text</span>(.<span class="dv">7</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">.7</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;363&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1160" title="1160"><span class="kw">text</span>(<span class="fl">1.9</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">1.9</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;658&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1161" title="1161"><span class="kw">text</span>(<span class="fl">3.1</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">3.1</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;230&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1162" title="1162"><span class="kw">text</span>(<span class="fl">4.3</span> <span class="op">+</span><span class="st"> </span><span class="dv">10</span>, <span class="fl">4.3</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;525&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1163" title="1163">t_formula &lt;-<span class="st"> </span><span class="kw">expression</span>(<span class="st">&quot;t&quot;</span>[n]<span class="op">*</span><span class="st">&quot; = (t&quot;</span>[n<span class="dv">-1</span>]<span class="op">*</span><span class="st">&quot; + t&quot;</span>[n]<span class="op">*</span><span class="st">&quot; + t&quot;</span>[n<span class="op">+</span><span class="dv">1</span>]<span class="op">*</span><span class="st">&quot;) / 3&quot;</span>)</a>
<a class="sourceLine" id="cb753-1164" title="1164"><span class="co"># text(13.8, 3, t_formula, srt = 45, cex = 1.2)</span></a>
<a class="sourceLine" id="cb753-1165" title="1165"><span class="kw">text</span>(<span class="fl">14.4</span>, <span class="fl">3.6</span>, <span class="st">&quot;calculate moving average&quot;</span>, <span class="dt">srt =</span> <span class="dv">45</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1166" title="1166"><span class="kw">arrows</span>(<span class="dv">15</span>, <span class="fl">5.7</span>, <span class="dv">18</span>, <span class="fl">5.7</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-1167" title="1167"><span class="kw">print_segments</span>(<span class="fl">15.4</span>, <span class="fl">1.7</span>, <span class="dt">seg =</span> time_arrow_seg, <span class="dt">col =</span> <span class="st">&quot;forestgreen&quot;</span>) <span class="co"># draw ma explanation</span></a>
<a class="sourceLine" id="cb753-1168" title="1168"><span class="kw">text</span>(<span class="op">-</span><span class="fl">0.5</span> <span class="op">+</span><span class="st"> </span><span class="fl">15.7</span>, <span class="fl">-0.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;NA&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1169" title="1169"><span class="kw">text</span>(.<span class="dv">7</span> <span class="op">+</span><span class="st"> </span><span class="fl">15.7</span>, <span class="fl">.7</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;505&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1170" title="1170"><span class="kw">text</span>(<span class="fl">1.9</span> <span class="op">+</span><span class="st"> </span><span class="fl">15.7</span>, <span class="fl">1.9</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;417&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1171" title="1171"><span class="kw">text</span>(<span class="fl">3.1</span> <span class="op">+</span><span class="st"> </span><span class="fl">15.7</span>, <span class="fl">3.1</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;471&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1172" title="1172"><span class="kw">text</span>(<span class="fl">4.3</span> <span class="op">+</span><span class="st"> </span><span class="fl">15.7</span>, <span class="fl">4.3</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>, <span class="st">&quot;NA&quot;</span>, <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1173" title="1173"><span class="kw">print_segments</span>(<span class="fl">25.7</span>, <span class="fl">1.7</span>, <span class="dt">seg =</span> time_arrow_seg, <span class="dt">col =</span> <span class="st">&quot;forestgreen&quot;</span>)</a>
<a class="sourceLine" id="cb753-1174" title="1174"><span class="co"># reduce ----</span></a>
<a class="sourceLine" id="cb753-1175" title="1175"></a>
<a class="sourceLine" id="cb753-1176" title="1176"><span class="co"># calc mean over time</span></a>
<a class="sourceLine" id="cb753-1177" title="1177">timeB &lt;-<span class="st"> </span>(b1 <span class="op">+</span><span class="st"> </span>b2 <span class="op">+</span><span class="st"> </span>b3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb753-1178" title="1178">timeG &lt;-<span class="st"> </span>(g1 <span class="op">+</span><span class="st"> </span>g2 <span class="op">+</span><span class="st"> </span>g3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb753-1179" title="1179">timeR &lt;-<span class="st"> </span>(r1 <span class="op">+</span><span class="st"> </span>r2 <span class="op">+</span><span class="st"> </span>r3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb753-1180" title="1180">timeN &lt;-<span class="st"> </span>(n1 <span class="op">+</span><span class="st"> </span>n2 <span class="op">+</span><span class="st"> </span>n3) <span class="op">/</span><span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb753-1181" title="1181"></a>
<a class="sourceLine" id="cb753-1182" title="1182">print_grid_time &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) { <span class="co"># 3x1, 28x7</span></a>
<a class="sourceLine" id="cb753-1183" title="1183">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> timeB)</a>
<a class="sourceLine" id="cb753-1184" title="1184">  <span class="kw">pl</span>(f, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> timeG)</a>
<a class="sourceLine" id="cb753-1185" title="1185">  <span class="kw">pl</span>(f, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> timeR)</a>
<a class="sourceLine" id="cb753-1186" title="1186">  <span class="kw">pl</span>(f, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> timeN)</a>
<a class="sourceLine" id="cb753-1187" title="1187">}</a>
<a class="sourceLine" id="cb753-1188" title="1188"></a>
<a class="sourceLine" id="cb753-1189" title="1189"><span class="co"># calc ndvi</span></a>
<a class="sourceLine" id="cb753-1190" title="1190">ndvi1 &lt;-<span class="st"> </span>(n1 <span class="op">-</span><span class="st"> </span>r1) <span class="op">/</span><span class="st"> </span>(n1 <span class="op">+</span><span class="st"> </span>r1)</a>
<a class="sourceLine" id="cb753-1191" title="1191">ndvi2 &lt;-<span class="st"> </span>(n2 <span class="op">-</span><span class="st"> </span>r2) <span class="op">/</span><span class="st"> </span>(n2 <span class="op">+</span><span class="st"> </span>r2)</a>
<a class="sourceLine" id="cb753-1192" title="1192">ndvi3 &lt;-<span class="st"> </span>(n3 <span class="op">-</span><span class="st"> </span>r3) <span class="op">/</span><span class="st"> </span>(n3 <span class="op">+</span><span class="st"> </span>r3)</a>
<a class="sourceLine" id="cb753-1193" title="1193"></a>
<a class="sourceLine" id="cb753-1194" title="1194">print_grid_bands &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, <span class="dt">pal =</span> greys) { <span class="co"># 1x3 6x27</span></a>
<a class="sourceLine" id="cb753-1195" title="1195">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> ndvi1)</a>
<a class="sourceLine" id="cb753-1196" title="1196">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> ndvi2)</a>
<a class="sourceLine" id="cb753-1197" title="1197">  <span class="kw">pl</span>(f, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> pal, <span class="dt">m =</span> ndvi3)</a>
<a class="sourceLine" id="cb753-1198" title="1198">}</a>
<a class="sourceLine" id="cb753-1199" title="1199"></a>
<a class="sourceLine" id="cb753-1200" title="1200">plte =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">randomize =</span> <span class="ot">FALSE</span>, pal, m) {</a>
<a class="sourceLine" id="cb753-1201" title="1201">  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</a>
<a class="sourceLine" id="cb753-1202" title="1202">  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</a>
<a class="sourceLine" id="cb753-1203" title="1203">  <span class="co"># m = r[[1]][y + 1:nrow,x + 1:ncol,1]</span></a>
<a class="sourceLine" id="cb753-1204" title="1204">  <span class="co"># dim(m) = c(x = nrow, y = ncol) # named dim</span></a>
<a class="sourceLine" id="cb753-1205" title="1205">  <span class="co"># s[[1]] = m</span></a>
<a class="sourceLine" id="cb753-1206" title="1206">  <span class="co"># me &lt;- floor(mean(s[[1]]))</span></a>
<a class="sourceLine" id="cb753-1207" title="1207">  me &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">mean</span>(m))</a>
<a class="sourceLine" id="cb753-1208" title="1208">  <span class="cf">if</span> (me[<span class="dv">1</span>] <span class="op">&gt;</span><span class="st"> </span><span class="dv">100</span>) { <span class="co"># in case non-artificial grids with very high</span></a>
<a class="sourceLine" id="cb753-1209" title="1209">    me &lt;-<span class="st"> </span>m <span class="op">/</span><span class="st"> </span><span class="dv">10</span>     <span class="co"># numbers are used, make them smaller</span></a>
<a class="sourceLine" id="cb753-1210" title="1210">    me &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">mean</span>(me))</a>
<a class="sourceLine" id="cb753-1211" title="1211">  }</a>
<a class="sourceLine" id="cb753-1212" title="1212">  <span class="kw">text</span>(x,y,me,<span class="dt">cex =</span> <span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb753-1213" title="1213">}</a>
<a class="sourceLine" id="cb753-1214" title="1214"></a>
<a class="sourceLine" id="cb753-1215" title="1215">print_grid_spat &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb753-1216" title="1216">  x =<span class="st"> </span>x <span class="op">+</span><span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb753-1217" title="1217">  y =<span class="st"> </span>y <span class="op">+</span><span class="st"> </span><span class="fl">3.5</span></a>
<a class="sourceLine" id="cb753-1218" title="1218">  <span class="kw">plte</span>(s, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b1)</a>
<a class="sourceLine" id="cb753-1219" title="1219">  <span class="kw">plte</span>(s, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b2)</a>
<a class="sourceLine" id="cb753-1220" title="1220">  <span class="kw">plte</span>(s, <span class="dv">0</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> blues, <span class="dt">m =</span> b3)</a>
<a class="sourceLine" id="cb753-1221" title="1221">  <span class="kw">plte</span>(s, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g1)</a>
<a class="sourceLine" id="cb753-1222" title="1222">  <span class="kw">plte</span>(s, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g2)</a>
<a class="sourceLine" id="cb753-1223" title="1223">  <span class="kw">plte</span>(s, <span class="dv">7</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> greens, <span class="dt">m =</span> g3)</a>
<a class="sourceLine" id="cb753-1224" title="1224">  <span class="kw">plte</span>(s, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r1)</a>
<a class="sourceLine" id="cb753-1225" title="1225">  <span class="kw">plte</span>(s, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r2)</a>
<a class="sourceLine" id="cb753-1226" title="1226">  <span class="kw">plte</span>(s, <span class="dv">14</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> reds, <span class="dt">m =</span> r3)</a>
<a class="sourceLine" id="cb753-1227" title="1227">  <span class="kw">plte</span>(s, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">0</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n1)</a>
<a class="sourceLine" id="cb753-1228" title="1228">  <span class="kw">plte</span>(s, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">10</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n2)</a>
<a class="sourceLine" id="cb753-1229" title="1229">  <span class="kw">plte</span>(s, <span class="dv">21</span><span class="op">+</span>x, <span class="dv">20</span><span class="op">+</span>y, <span class="dt">pal =</span> purples, <span class="dt">m =</span> n3)</a>
<a class="sourceLine" id="cb753-1230" title="1230">}</a>
<a class="sourceLine" id="cb753-1231" title="1231"></a>
<a class="sourceLine" id="cb753-1232" title="1232"><span class="co"># png(&quot;exp_reduce.png&quot;, width = 1200, height = 1000, pointsize = 32)</span></a>
<a class="sourceLine" id="cb753-1233" title="1233"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb753-1234" title="1234"><span class="co">#par(mar = c(3,3,3,3))</span></a>
<a class="sourceLine" id="cb753-1235" title="1235"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">2</span>,<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb753-1236" title="1236">x =<span class="st"> </span><span class="dv">120</span></a>
<a class="sourceLine" id="cb753-1237" title="1237">y =<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb753-1238" title="1238"><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, x), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, y), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-1239" title="1239"><span class="kw">print_grid</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-27</span>)</a>
<a class="sourceLine" id="cb753-1240" title="1240"><span class="co"># print_alpha_grid((x/3-28)/2, 0) # alpha grid</span></a>
<a class="sourceLine" id="cb753-1241" title="1241"><span class="kw">print_grid_time</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>, <span class="dv">0</span>) <span class="co"># off = 5.5</span></a>
<a class="sourceLine" id="cb753-1242" title="1242"><span class="co"># print_alpha_grid(x/3+((x/3-6)/2) -10.5, 0) # alpha grid</span></a>
<a class="sourceLine" id="cb753-1243" title="1243"><span class="kw">print_grid_bands</span>(x<span class="op">/</span><span class="dv">3</span><span class="op">+</span>((x<span class="op">/</span><span class="dv">3-6</span>)<span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb753-1244" title="1244"><span class="kw">print_alpha_grid</span>(<span class="dv">2</span><span class="op">*</span>(x<span class="op">/</span><span class="dv">3</span>)<span class="op">+</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span>, <span class="dt">alp =</span> <span class="dv">0</span>, <span class="dt">geom =</span> <span class="ot">TRUE</span>) <span class="co"># alpha grid</span></a>
<a class="sourceLine" id="cb753-1245" title="1245"><span class="kw">print_grid_spat</span>(<span class="dv">2</span><span class="op">*</span>(x<span class="op">/</span><span class="dv">3</span>)<span class="op">+</span>((x<span class="op">/</span><span class="dv">3-28</span>)<span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb753-1246" title="1246"><span class="kw">text</span>(<span class="dv">3</span>, <span class="fl">13.5</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1247" title="1247"><span class="co">#segments(3.6, 8, 3.7, 19, col = &quot;red&quot;, lwd=3)</span></a>
<a class="sourceLine" id="cb753-1248" title="1248"><span class="kw">segments</span>(<span class="fl">3.4</span>, <span class="dv">8</span>, <span class="fl">3.4</span>, <span class="dv">19</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1249" title="1249"><span class="kw">text</span>(<span class="dv">43</span>, <span class="fl">13.5</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1250" title="1250"><span class="kw">text</span>(<span class="dv">83</span>, <span class="fl">13.5</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1251" title="1251"><span class="kw">text</span>(<span class="dv">20</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1252" title="1252"><span class="kw">text</span>(<span class="dv">60</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1253" title="1253"><span class="kw">segments</span>(<span class="dv">53</span>,<span class="fl">29.8</span>, <span class="dv">67</span>,<span class="fl">29.8</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1254" title="1254"><span class="kw">text</span>(<span class="dv">100</span>, <span class="dv">30</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1255" title="1255"><span class="kw">text</span>(<span class="dv">30</span>, <span class="dv">7</span>, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1256" title="1256"><span class="kw">text</span>(<span class="dv">36</span>, <span class="dv">13</span>, <span class="st">&quot;y&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1257" title="1257"><span class="kw">text</span>(<span class="dv">60</span>, <span class="dv">-3</span>, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1258" title="1258"><span class="kw">text</span>(<span class="dv">66</span>, <span class="dv">3</span>, <span class="st">&quot;y&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1259" title="1259"><span class="kw">text</span>(<span class="dv">110</span>, <span class="dv">-3</span>, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1260" title="1260"><span class="kw">text</span>(<span class="dv">116</span>, <span class="dv">3</span>, <span class="st">&quot;y&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1261" title="1261"><span class="kw">segments</span>(<span class="dv">108</span>,<span class="op">-</span><span class="fl">2.4</span>, <span class="dv">112</span>,<span class="op">-</span><span class="fl">3.2</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1262" title="1262"><span class="kw">segments</span>(<span class="dv">114</span>,<span class="fl">3.2</span>, <span class="dv">118</span>,<span class="fl">2.4</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">lwd =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1263" title="1263"><span class="kw">text</span>(<span class="dv">60</span>, y<span class="op">+</span><span class="dv">4</span>, <span class="st">&quot;bands&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>) <span class="co"># dim names on main</span></a>
<a class="sourceLine" id="cb753-1264" title="1264"><span class="kw">text</span>(<span class="dv">43</span>, y<span class="dv">-14</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1265" title="1265"><span class="kw">text</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">24</span>, y<span class="dv">-30</span>, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1266" title="1266"><span class="kw">text</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">30</span>, y<span class="dv">-24</span>, <span class="st">&quot;y&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1267" title="1267"><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2-28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, x<span class="op">/</span><span class="dv">6</span>,<span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-1268" title="1268"><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, x<span class="op">/</span><span class="dv">2</span>,<span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-1269" title="1269"><span class="kw">arrows</span>(x<span class="op">/</span><span class="dv">2</span><span class="op">+</span><span class="dv">28</span><span class="op">/</span><span class="dv">2</span>,y<span class="dv">-30</span>, <span class="dv">100</span>, <span class="dv">32</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-1270" title="1270"><span class="co"># points(seq(1,120,10), seq(1,120,10))</span></a>
<a class="sourceLine" id="cb753-1271" title="1271"><span class="kw">text</span>(<span class="fl">28.5</span>,<span class="dv">49</span>, <span class="st">&quot;reduce temporally&quot;</span>, <span class="dt">srt =</span> <span class="fl">55.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb753-1272" title="1272"><span class="kw">text</span>(<span class="dv">57</span>,<span class="dv">49</span>, <span class="st">&quot;reduce bands&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb753-1273" title="1273"><span class="kw">text</span>(<span class="fl">91.5</span>,<span class="dv">49</span>, <span class="st">&quot;reduce spatially&quot;</span>, <span class="dt">srt =</span> <span class="fl">-55.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>)</a>
<a class="sourceLine" id="cb753-1274" title="1274"><span class="co"># aggregate ----</span></a>
<a class="sourceLine" id="cb753-1275" title="1275"></a>
<a class="sourceLine" id="cb753-1276" title="1276">mask_agg &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb753-1277" title="1277">                 <span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb753-1278" title="1278">                  <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb753-1279" title="1279">                  <span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb753-1280" title="1280">                  <span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb753-1281" title="1281">                  <span class="dv">1</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>, <span class="dv">1</span>,<span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb753-1282" title="1282">                 <span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>,<span class="ot">NA</span>), <span class="dt">ncol =</span> <span class="dv">7</span>)</a>
<a class="sourceLine" id="cb753-1283" title="1283"></a>
<a class="sourceLine" id="cb753-1284" title="1284">pl_stack_agg =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, nrM, <span class="dt">imgY =</span> <span class="dv">7</span>, <span class="dt">inner =</span> <span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb753-1285" title="1285">  <span class="co"># pl_stack that masks the added matrices</span></a>
<a class="sourceLine" id="cb753-1286" title="1286">  <span class="co"># nrM is the timestep {1, 2, 3}, cause this function</span></a>
<a class="sourceLine" id="cb753-1287" title="1287">  <span class="co"># prints all 4 bands at once</span></a>
<a class="sourceLine" id="cb753-1288" title="1288">  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</a>
<a class="sourceLine" id="cb753-1289" title="1289">  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</a>
<a class="sourceLine" id="cb753-1290" title="1290">  <span class="co"># m = r[[1]][y + 1:nrow,x + 1:ncol,1]</span></a>
<a class="sourceLine" id="cb753-1291" title="1291">  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;n&quot;</span>, nrM)))</a>
<a class="sourceLine" id="cb753-1292" title="1292">  m &lt;-<span class="st"> </span><span class="kw">matrix</span>(m[mask_agg <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>)</a>
<a class="sourceLine" id="cb753-1293" title="1293">  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)] <span class="co"># turn around to have same orientation as flat plot</span></a>
<a class="sourceLine" id="cb753-1294" title="1294">  <span class="kw">plt</span>(s, <span class="dv">0</span>, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> purples)</a>
<a class="sourceLine" id="cb753-1295" title="1295">  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;r&quot;</span>, nrM)))</a>
<a class="sourceLine" id="cb753-1296" title="1296">  m &lt;-<span class="st"> </span><span class="kw">matrix</span>(m[mask_agg <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>)</a>
<a class="sourceLine" id="cb753-1297" title="1297">  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb753-1298" title="1298">  <span class="kw">plt</span>(s, <span class="dv">1</span><span class="op">*</span>inner, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> reds)</a>
<a class="sourceLine" id="cb753-1299" title="1299">  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;g&quot;</span>, nrM)))</a>
<a class="sourceLine" id="cb753-1300" title="1300">  m &lt;-<span class="st"> </span><span class="kw">matrix</span>(m[mask_agg <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>)</a>
<a class="sourceLine" id="cb753-1301" title="1301">  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb753-1302" title="1302">  <span class="kw">plt</span>(s, <span class="dv">2</span><span class="op">*</span>inner, <span class="ot">TRUE</span>,  <span class="dt">pal =</span> greens)</a>
<a class="sourceLine" id="cb753-1303" title="1303">  m &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text=</span><span class="kw">paste0</span>(<span class="st">&quot;b&quot;</span>, nrM)))</a>
<a class="sourceLine" id="cb753-1304" title="1304">  m &lt;-<span class="st"> </span><span class="kw">matrix</span>(m[mask_agg <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>], <span class="dt">ncol =</span> <span class="dv">7</span>)</a>
<a class="sourceLine" id="cb753-1305" title="1305">  s[[<span class="dv">1</span>]] =<span class="st"> </span>m[,<span class="kw">c</span>(imgY<span class="op">:</span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb753-1306" title="1306">  <span class="kw">plt</span>(s, <span class="dv">3</span><span class="op">*</span>inner, <span class="ot">TRUE</span>, <span class="dt">pal =</span> blues) <span class="co"># li FALSE</span></a>
<a class="sourceLine" id="cb753-1307" title="1307">}</a>
<a class="sourceLine" id="cb753-1308" title="1308"></a>
<a class="sourceLine" id="cb753-1309" title="1309">polygon_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="kw">c</span>(<span class="fl">0.0</span>, <span class="fl">5.1</span>, <span class="fl">4.9</span>,<span class="op">-</span><span class="fl">2.3</span>), <span class="kw">c</span>(<span class="fl">0.0</span>, <span class="fl">2.4</span>, <span class="fl">3.1</span>, <span class="fl">1.8</span>),</a>
<a class="sourceLine" id="cb753-1310" title="1310">                      <span class="kw">c</span>(<span class="fl">5.1</span>, <span class="fl">4.9</span>,<span class="op">-</span><span class="fl">2.3</span>, <span class="fl">0.0</span>), <span class="kw">c</span>(<span class="fl">2.4</span>, <span class="fl">3.1</span>, <span class="fl">1.8</span>, <span class="fl">0.0</span>)), <span class="dt">ncol =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb753-1311" title="1311"></a>
<a class="sourceLine" id="cb753-1312" title="1312">a &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">5</span>, <span class="fl">-1.14</span>, <span class="fl">-2.28</span>)</a>
<a class="sourceLine" id="cb753-1313" title="1313"></a>
<a class="sourceLine" id="cb753-1314" title="1314">print_vector_content &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, <span class="dt">cex =</span> <span class="fl">0.8</span>) {</a>
<a class="sourceLine" id="cb753-1315" title="1315">  vec &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="kw">rnorm</span>(<span class="dv">8</span>, <span class="dv">250</span>, <span class="dv">100</span>))</a>
<a class="sourceLine" id="cb753-1316" title="1316">  <span class="kw">text</span>( <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x,<span class="dv">12</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">1</span>], <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1317" title="1317">  <span class="kw">text</span>( <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">8</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">2</span>], <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1318" title="1318">  <span class="kw">text</span>( <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">4</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">3</span>], <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1319" title="1319">  <span class="kw">text</span>( <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">4</span>], <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1320" title="1320">  <span class="kw">text</span>( <span class="dv">12</span> <span class="op">+</span><span class="st"> </span>x,<span class="dv">12</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">5</span>], <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1321" title="1321">  <span class="kw">text</span>( <span class="dv">12</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">8</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">6</span>], <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1322" title="1322">  <span class="kw">text</span>( <span class="dv">12</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">4</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">7</span>], <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1323" title="1323">  <span class="kw">text</span>( <span class="dv">12</span> <span class="op">+</span><span class="st"> </span>x, <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>y, vec[<span class="dv">8</span>], <span class="dt">cex =</span> cex)</a>
<a class="sourceLine" id="cb753-1324" title="1324">}</a>
<a class="sourceLine" id="cb753-1325" title="1325"></a>
<a class="sourceLine" id="cb753-1326" title="1326">print_ts &lt;-<span class="st"> </span><span class="cf">function</span>(off2, yoff2) {</a>
<a class="sourceLine" id="cb753-1327" title="1327">  <span class="kw">pl_stack</span>(s, <span class="dv">0</span> <span class="op">+</span><span class="st"> </span>off2, yoff2, <span class="dt">nrM =</span> <span class="dv">3</span>) <span class="co"># input 2</span></a>
<a class="sourceLine" id="cb753-1328" title="1328">  <span class="kw">pl_stack</span>(s, off <span class="op">+</span><span class="st"> </span>off2, yoff2, <span class="dt">nrM =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-1329" title="1329">  <span class="kw">pl_stack</span>(s, <span class="dv">2</span> <span class="op">*</span><span class="st"> </span>off <span class="op">+</span><span class="st"> </span>off2, yoff2, <span class="dt">nrM =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-1330" title="1330">  <span class="kw">arrows</span>(<span class="op">-</span><span class="dv">13</span> <span class="op">+</span><span class="st"> </span>off2, <span class="dv">14</span> <span class="op">+</span><span class="st"> </span>yoff2, <span class="dv">72</span> <span class="op">+</span><span class="st"> </span>off2, <span class="dv">14</span> <span class="op">+</span><span class="st"> </span>yoff2, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)  <span class="co"># timeline</span></a>
<a class="sourceLine" id="cb753-1331" title="1331">  heads &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="fl">3.5</span><span class="op">+</span>off2, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>off <span class="op">+</span><span class="st"> </span>off2, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>off <span class="op">+</span><span class="st"> </span>off2, <span class="dv">14</span><span class="op">+</span>yoff2,<span class="dv">14</span><span class="op">+</span>yoff2,<span class="dv">14</span><span class="op">+</span>yoff2), <span class="dt">ncol =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-1332" title="1332">  <span class="kw">points</span>(heads, <span class="dt">pch =</span> <span class="dv">16</span>) <span class="co"># 4 or 16</span></a>
<a class="sourceLine" id="cb753-1333" title="1333">  <span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>)<span class="op">+</span>off2, <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>)<span class="op">+</span>yoff2, <span class="fl">3.5</span><span class="op">+</span>off2, <span class="dv">14</span><span class="op">+</span>yoff2) <span class="co"># first stack pyramid</span></a>
<a class="sourceLine" id="cb753-1334" title="1334">  <span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>) <span class="op">+</span><span class="st"> </span>off <span class="op">+</span><span class="st"> </span>off2, <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>)<span class="op">+</span>yoff2, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>off <span class="op">+</span><span class="st"> </span>off2, <span class="dv">14</span><span class="op">+</span>yoff2) <span class="co"># second stack pyramid</span></a>
<a class="sourceLine" id="cb753-1335" title="1335">  <span class="kw">segments</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">8</span>, <span class="dv">7</span>, <span class="dv">0</span>, <span class="dv">15</span>) <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>off <span class="op">+</span><span class="st"> </span>off2, <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>)<span class="op">+</span>yoff2, <span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>off <span class="op">+</span><span class="st"> </span>off2, <span class="dv">14</span><span class="op">+</span>yoff2) <span class="co"># third stack pyramid</span></a>
<a class="sourceLine" id="cb753-1336" title="1336">  <span class="kw">text</span>(<span class="fl">7.5</span><span class="op">+</span>off2, <span class="fl">4.3</span><span class="op">+</span>yoff2, <span class="st">&quot;x&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> secText)</a>
<a class="sourceLine" id="cb753-1337" title="1337">  <span class="kw">text</span>(<span class="op">-</span><span class="fl">9.5</span><span class="op">+</span>off2, <span class="fl">-2.5</span><span class="op">+</span>yoff2, <span class="st">&quot;bands&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> secText)</a>
<a class="sourceLine" id="cb753-1338" title="1338">  <span class="kw">text</span>(<span class="op">-</span><span class="fl">4.5</span><span class="op">+</span>off2, <span class="dv">2</span><span class="op">+</span>yoff2, <span class="st">&quot;y&quot;</span>, <span class="dt">srt =</span> <span class="fl">27.5</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">cex =</span> secText)</a>
<a class="sourceLine" id="cb753-1339" title="1339">  <span class="kw">text</span>(<span class="dv">69</span><span class="op">+</span>off2, <span class="fl">15.5</span><span class="op">+</span>yoff2<span class="op">+</span><span class="dv">1</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1340" title="1340">  <span class="kw">text</span>(<span class="fl">3.5</span><span class="op">+</span>off2, <span class="fl">15.5</span><span class="op">+</span>yoff2, <span class="st">&quot;2020-10-01&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1341" title="1341">  <span class="kw">text</span>(<span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span>off <span class="op">+</span><span class="st"> </span>off2, <span class="fl">15.5</span><span class="op">+</span>yoff2, <span class="st">&quot;2020-10-13&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1342" title="1342">  <span class="kw">text</span>(<span class="fl">3.5</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span><span class="op">*</span>off <span class="op">+</span><span class="st"> </span>off2, <span class="fl">15.5</span><span class="op">+</span>yoff2, <span class="st">&quot;2020-10-25&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)</a>
<a class="sourceLine" id="cb753-1343" title="1343">}</a>
<a class="sourceLine" id="cb753-1344" title="1344"></a>
<a class="sourceLine" id="cb753-1345" title="1345">secText =<span class="st"> </span><span class="fl">0.8</span> <span class="co"># secondary text size (dimension naming)</span></a>
<a class="sourceLine" id="cb753-1346" title="1346">off =<span class="st"> </span><span class="dv">26</span> <span class="co"># image stacks are always 26 apart</span></a>
<a class="sourceLine" id="cb753-1347" title="1347">x =<span class="st"> </span><span class="dv">72</span> <span class="co"># png X</span></a>
<a class="sourceLine" id="cb753-1348" title="1348">y =<span class="st"> </span><span class="dv">48</span> <span class="co"># png Y</span></a>
<a class="sourceLine" id="cb753-1349" title="1349">yoff =<span class="st"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb753-1350" title="1350"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb753-1351" title="1351"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb753-1352" title="1352"><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, x), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, y), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-1353" title="1353"><span class="kw">print_ts</span>(<span class="dv">5</span>, yoff)</a>
<a class="sourceLine" id="cb753-1354" title="1354">col =<span class="st"> &#39;#ff5555&#39;</span></a>
<a class="sourceLine" id="cb753-1355" title="1355"><span class="kw">print_segments</span>(<span class="fl">10.57</span>, yoff<span class="fl">-.43</span>, <span class="dt">seg =</span> polygon_<span class="dv">1</span>, <span class="dt">col =</span> col)</a>
<a class="sourceLine" id="cb753-1356" title="1356">x =<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb753-1357" title="1357"><span class="kw">segments</span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="fl">-1.3</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="op">-</span>.<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)<span class="op">+</span>yoff, <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">-1.3</span>, <span class="dv">1</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>)<span class="op">+</span>yoff, <span class="dt">lwd =</span> <span class="dv">4</span>, <span class="dt">col =</span> col)</a>
<a class="sourceLine" id="cb753-1358" title="1358"><span class="kw">print_segments</span>(<span class="fl">10.57</span><span class="op">+</span>off, yoff<span class="fl">-.43</span>, <span class="dt">seg =</span> polygon_<span class="dv">1</span>, <span class="dt">col =</span> col)</a>
<a class="sourceLine" id="cb753-1359" title="1359">x =<span class="st"> </span><span class="dv">3</span> <span class="op">+</span><span class="st"> </span>off</a>
<a class="sourceLine" id="cb753-1360" title="1360"><span class="kw">segments</span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="fl">-1.3</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="op">-</span>.<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)<span class="op">+</span>yoff, <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">-1.3</span>, <span class="dv">1</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>)<span class="op">+</span>yoff, <span class="dt">lwd =</span> <span class="dv">4</span>, <span class="dt">col =</span> col)</a>
<a class="sourceLine" id="cb753-1361" title="1361"><span class="kw">print_segments</span>(<span class="fl">10.57</span><span class="op">+</span><span class="dv">2</span><span class="op">*</span>off, yoff<span class="fl">-.43</span>, <span class="dt">seg =</span> polygon_<span class="dv">1</span>, <span class="dt">col =</span> col)</a>
<a class="sourceLine" id="cb753-1362" title="1362">x =<span class="st"> </span><span class="dv">3</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>off</a>
<a class="sourceLine" id="cb753-1363" title="1363"><span class="kw">segments</span>(<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="fl">-1.3</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="op">-</span>.<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)<span class="op">+</span>yoff, <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">-1.3</span>, <span class="dv">1</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>)<span class="op">+</span>yoff, <span class="dt">lwd =</span> <span class="dv">4</span>, <span class="dt">col =</span> col)</a>
<a class="sourceLine" id="cb753-1364" title="1364"><span class="co"># old 75 28 poly 86.25, 27.15</span></a>
<a class="sourceLine" id="cb753-1365" title="1365"><span class="kw">pl_stack_agg</span>(a, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dt">nrM =</span> <span class="dv">1</span>, <span class="dt">inner =</span> <span class="dv">3</span>) <span class="co"># print masked enlargement</span></a>
<a class="sourceLine" id="cb753-1366" title="1366"><span class="kw">print_segments</span>(<span class="fl">16.25</span>, <span class="fl">7.15</span>, <span class="dt">seg =</span> polygon_<span class="dv">1</span>, <span class="dt">by =</span> <span class="dv">2</span>, <span class="dt">col =</span> col)</a>
<a class="sourceLine" id="cb753-1367" title="1367">x &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb753-1368" title="1368">y &lt;-<span class="st"> </span><span class="dv">8</span></a>
<a class="sourceLine" id="cb753-1369" title="1369"><span class="kw">segments</span>(<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">0</span>, <span class="fl">-2.6</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="op">-</span>.<span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">2</span>)<span class="op">+</span>y, <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">-2.6</span>, <span class="dv">2</span>)<span class="op">+</span>x, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>)<span class="op">+</span>y, <span class="dt">lwd =</span> <span class="dv">4</span>, <span class="dt">col =</span> col) <span class="co"># line in large</span></a>
<a class="sourceLine" id="cb753-1370" title="1370"><span class="kw">segments</span>(<span class="op">-</span><span class="dv">3</span>, <span class="dv">25</span>, <span class="dv">-7</span>, <span class="dv">9</span>, <span class="dt">lwd =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-1371" title="1371"><span class="kw">segments</span>(<span class="dv">21</span>, <span class="dv">29</span>, <span class="fl">27.5</span>, <span class="dv">14</span>, <span class="dt">lwd =</span> <span class="dv">3</span>, <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-1372" title="1372"><span class="kw">text</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="st">&quot;1. Group by geometry&quot;</span>, <span class="dt">cex =</span> <span class="fl">1.3</span>)</a>
<a class="sourceLine" id="cb753-1373" title="1373">vecM &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rep</span>(<span class="dv">1</span>,<span class="dv">8</span>), <span class="dt">ncol =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-1374" title="1374"><span class="kw">text</span>(<span class="dv">57</span>, <span class="dv">21</span>, <span class="st">&quot;2. Reduce to vector cube&quot;</span>, <span class="dt">cex =</span> <span class="fl">1.3</span>)</a>
<a class="sourceLine" id="cb753-1375" title="1375">b &lt;-<span class="st"> </span><span class="kw">make_dummy_stars</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">12</span>, <span class="dv">4</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb753-1376" title="1376"><span class="kw">pl</span>(b, <span class="dv">48</span>, <span class="dv">-5</span>, <span class="dt">m =</span> vecM, <span class="dt">pal =</span> <span class="kw">alpha</span>(<span class="st">&quot;white&quot;</span>, <span class="fl">0.9</span>), <span class="dt">border =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb753-1377" title="1377"><span class="kw">print_vector_content</span>(<span class="dv">54</span>, <span class="dv">-3</span>)</a>
<a class="sourceLine" id="cb753-1378" title="1378"><span class="kw">pl</span>(b, <span class="fl">46.5</span>, <span class="fl">-3.5</span>, <span class="dt">m =</span> vecM, <span class="dt">pal =</span> <span class="kw">alpha</span>(<span class="st">&quot;white&quot;</span>, <span class="fl">0.9</span>), <span class="dt">border =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb753-1379" title="1379"><span class="kw">print_vector_content</span>(<span class="fl">52.5</span>, <span class="fl">-1.5</span>)</a>
<a class="sourceLine" id="cb753-1380" title="1380"><span class="kw">pl</span>(b, <span class="dv">45</span>, <span class="dv">-2</span>, <span class="dt">m =</span> vecM, <span class="dt">pal =</span> <span class="kw">alpha</span>(<span class="st">&quot;white&quot;</span>, <span class="fl">0.9</span>), <span class="dt">border =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb753-1381" title="1381"><span class="kw">print_vector_content</span>(<span class="dv">51</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb753-1382" title="1382"><span class="kw">text</span>(<span class="fl">51.5</span>, <span class="dv">15</span>, <span class="st">&quot;Line_1&quot;</span>, <span class="dt">col =</span> col)</a>
<a class="sourceLine" id="cb753-1383" title="1383"><span class="kw">text</span>(<span class="dv">63</span>, <span class="dv">15</span>, <span class="st">&quot;Polygon_1&quot;</span>, <span class="dt">col =</span> col)</a>
<a class="sourceLine" id="cb753-1384" title="1384"><span class="kw">text</span>(<span class="dv">57</span>, <span class="fl">17.5</span>, <span class="st">&quot;Geometries&quot;</span>, <span class="dt">cex =</span> <span class="fl">1.1</span>)</a>
<a class="sourceLine" id="cb753-1385" title="1385"><span class="kw">text</span>(<span class="dv">42</span>, <span class="dv">12</span>, <span class="st">&quot;blue&quot;</span>)</a>
<a class="sourceLine" id="cb753-1386" title="1386"><span class="kw">text</span>(<span class="dv">42</span>,  <span class="dv">8</span>, <span class="st">&quot;green&quot;</span>)</a>
<a class="sourceLine" id="cb753-1387" title="1387"><span class="kw">text</span>(<span class="dv">42</span>,  <span class="dv">4</span>, <span class="st">&quot;red&quot;</span>)</a>
<a class="sourceLine" id="cb753-1388" title="1388"><span class="kw">text</span>(<span class="dv">42</span>,  <span class="dv">0</span>, <span class="st">&quot;nir&quot;</span>)</a>
<a class="sourceLine" id="cb753-1389" title="1389"><span class="kw">text</span>(<span class="dv">38</span>, <span class="dv">6</span>, <span class="st">&quot;Bands&quot;</span>, <span class="dt">srt =</span> <span class="dv">90</span>, <span class="dt">cex =</span> <span class="fl">1.1</span>)</a>
<a class="sourceLine" id="cb753-1390" title="1390"><span class="co"># arrows(13.5, -2, 13.5, -6, angle = 20, lwd = 3)</span></a>
<a class="sourceLine" id="cb753-1391" title="1391"><span class="kw">text</span>(<span class="dv">72</span>, <span class="fl">15.5</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">315</span>, <span class="dt">cex =</span> <span class="fl">1.1</span>)</a>
<a class="sourceLine" id="cb753-1392" title="1392"><span class="kw">arrows</span>(<span class="fl">69.5</span>, <span class="dv">15</span>, <span class="fl">72.5</span>, <span class="dv">12</span>, <span class="dt">angle =</span> <span class="dv">20</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-1393" title="1393"><span class="co"># print_segments(30, 35, seg = arrow_seg)</span></a>
<a class="sourceLine" id="cb753-1394" title="1394"></a>
<a class="sourceLine" id="cb753-1395" title="1395"><span class="kw">set.seed</span>(<span class="dv">1331</span>)</a>
<a class="sourceLine" id="cb753-1396" title="1396"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb753-1397" title="1397"><span class="kw">library</span>(colorspace)</a>
<a class="sourceLine" id="cb753-1398" title="1398">tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</a>
<a class="sourceLine" id="cb753-1399" title="1399">r =<span class="st"> </span><span class="kw">read_stars</span>(tif)</a>
<a class="sourceLine" id="cb753-1400" title="1400"></a>
<a class="sourceLine" id="cb753-1401" title="1401">nrow =<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb753-1402" title="1402">ncol =<span class="st"> </span><span class="dv">8</span></a>
<a class="sourceLine" id="cb753-1403" title="1403"><span class="co">#m = matrix(runif(nrow * ncol), nrow = nrow, ncol = ncol)</span></a>
<a class="sourceLine" id="cb753-1404" title="1404">m =<span class="st"> </span>r[[<span class="dv">1</span>]][<span class="dv">1</span><span class="op">:</span>nrow,<span class="dv">1</span><span class="op">:</span>ncol,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb753-1405" title="1405"><span class="kw">dim</span>(m) =<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> nrow, <span class="dt">y =</span> ncol) <span class="co"># named dim</span></a>
<a class="sourceLine" id="cb753-1406" title="1406">s =<span class="st"> </span><span class="kw">st_as_stars</span>(m)</a>
<a class="sourceLine" id="cb753-1407" title="1407"><span class="co"># s</span></a>
<a class="sourceLine" id="cb753-1408" title="1408"><span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>delta =<span class="st"> </span><span class="dv">3</span> </a>
<a class="sourceLine" id="cb753-1409" title="1409"><span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>delta =<span class="st"> </span><span class="fl">-.5</span></a>
<a class="sourceLine" id="cb753-1410" title="1410"><span class="kw">attr</span>(<span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>), <span class="st">&quot;raster&quot;</span>)<span class="op">$</span>affine =<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="fl">1.2</span>, <span class="fl">0.0</span>)</a>
<a class="sourceLine" id="cb753-1411" title="1411"></a>
<a class="sourceLine" id="cb753-1412" title="1412">plt =<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">yoffset =</span> <span class="dv">0</span>, add, <span class="dt">li =</span> <span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb753-1413" title="1413">    <span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span><span class="kw">attr</span>(x, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset <span class="op">+</span><span class="st"> </span>yoffset </a>
<a class="sourceLine" id="cb753-1414" title="1414">    l =<span class="st"> </span><span class="kw">st_as_sf</span>(x, <span class="dt">as_points =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-1415" title="1415">    pal =<span class="st"> </span><span class="kw">sf.colors</span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb753-1416" title="1416">    <span class="cf">if</span> (li)</a>
<a class="sourceLine" id="cb753-1417" title="1417">        pal =<span class="st"> </span><span class="kw">lighten</span>(pal, <span class="fl">0.3</span> <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.1</span>))</a>
<a class="sourceLine" id="cb753-1418" title="1418">    <span class="cf">if</span> (<span class="op">!</span><span class="st"> </span>add)</a>
<a class="sourceLine" id="cb753-1419" title="1419">        <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">FALSE</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>, <span class="dt">pal =</span> pal, <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(.<span class="dv">75</span>), <span class="dt">key.pos =</span> <span class="ot">NULL</span>, <span class="dt">main =</span> <span class="ot">NULL</span>, <span class="dt">xlab =</span> <span class="st">&quot;time&quot;</span>)</a>
<a class="sourceLine" id="cb753-1420" title="1420">    <span class="cf">else</span></a>
<a class="sourceLine" id="cb753-1421" title="1421">        <span class="kw">plot</span>(l, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">breaks =</span> <span class="st">&quot;equal&quot;</span>, <span class="dt">pal =</span> pal, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(.<span class="dv">75</span>))</a>
<a class="sourceLine" id="cb753-1422" title="1422">    u =<span class="st"> </span><span class="kw">st_union</span>(l)</a>
<a class="sourceLine" id="cb753-1423" title="1423">    <span class="kw">plot</span>(<span class="kw">st_geometry</span>(u), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">lwd =</span> <span class="fl">2.5</span>)</a>
<a class="sourceLine" id="cb753-1424" title="1424">}</a>
<a class="sourceLine" id="cb753-1425" title="1425"></a>
<a class="sourceLine" id="cb753-1426" title="1426">pl =<span class="st"> </span><span class="cf">function</span>(s, x, y, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">randomize =</span> <span class="ot">FALSE</span>) {</a>
<a class="sourceLine" id="cb753-1427" title="1427">  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">1</span>]]<span class="op">$</span>offset =<span class="st"> </span>x</a>
<a class="sourceLine" id="cb753-1428" title="1428">  <span class="kw">attr</span>(s, <span class="st">&quot;dimensions&quot;</span>)[[<span class="dv">2</span>]]<span class="op">$</span>offset =<span class="st"> </span>y</a>
<a class="sourceLine" id="cb753-1429" title="1429">  m =<span class="st"> </span>r[[<span class="dv">1</span>]][y <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>nrow,x <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>ncol,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb753-1430" title="1430">  <span class="cf">if</span> (randomize)</a>
<a class="sourceLine" id="cb753-1431" title="1431">    m =<span class="st"> </span>m[<span class="kw">sample</span>(y <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>nrow),x <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span>ncol]</a>
<a class="sourceLine" id="cb753-1432" title="1432">  <span class="kw">dim</span>(m) =<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> nrow, <span class="dt">y =</span> ncol) <span class="co"># named dim</span></a>
<a class="sourceLine" id="cb753-1433" title="1433">  s[[<span class="dv">1</span>]] =<span class="st"> </span>m</a>
<a class="sourceLine" id="cb753-1434" title="1434">  <span class="kw">plt</span>(s, <span class="dv">0</span>, add)</a>
<a class="sourceLine" id="cb753-1435" title="1435">  <span class="kw">plt</span>(s, <span class="dv">1</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1436" title="1436">  <span class="kw">plt</span>(s, <span class="dv">2</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1437" title="1437">  <span class="kw">plt</span>(s, <span class="dv">3</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1438" title="1438">  <span class="kw">plt</span>(s, <span class="dv">4</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1439" title="1439">  <span class="kw">plt</span>(s, <span class="dv">5</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1440" title="1440">  <span class="kw">plt</span>(s, <span class="dv">6</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1441" title="1441">  <span class="kw">plt</span>(s, <span class="dv">7</span>, <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1442" title="1442">  <span class="kw">plt</span>(s, <span class="dv">8</span>, <span class="ot">TRUE</span>, <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-1443" title="1443">}</a>
<a class="sourceLine" id="cb753-1444" title="1444"></a>
<a class="sourceLine" id="cb753-1445" title="1445"><span class="co"># point vector data cube:</span></a>
<a class="sourceLine" id="cb753-1446" title="1446"><span class="kw">plot.new</span>()</a>
<a class="sourceLine" id="cb753-1447" title="1447"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb753-1448" title="1448"><span class="kw">plot.window</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">16</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>,<span class="dv">12</span>), <span class="dt">asp =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-1449" title="1449"><span class="kw">library</span>(spacetime)</a>
<a class="sourceLine" id="cb753-1450" title="1450"><span class="kw">data</span>(air)</a>
<a class="sourceLine" id="cb753-1451" title="1451">de =<span class="st"> </span><span class="kw">st_geometry</span>(<span class="kw">st_normalize</span>(<span class="kw">st_as_sf</span>(DE)))</a>
<a class="sourceLine" id="cb753-1452" title="1452"><span class="co"># </span></a>
<a class="sourceLine" id="cb753-1453" title="1453"><span class="kw">pl</span>(s, <span class="dv">0</span>, <span class="dv">0</span>, <span class="ot">TRUE</span>, <span class="dt">randomize =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1454" title="1454">de =<span class="st"> </span>de <span class="op">*</span><span class="st"> </span><span class="dv">6</span> <span class="op">+</span><span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">7</span>, <span class="dv">9</span>)</a>
<a class="sourceLine" id="cb753-1455" title="1455"><span class="kw">plot</span>(de, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="kw">grey</span>(.<span class="dv">5</span>))</a>
<a class="sourceLine" id="cb753-1456" title="1456"><span class="kw">text</span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">0</span>, <span class="st">&quot;time&quot;</span>, <span class="dt">srt =</span> <span class="dv">-90</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</a>
<a class="sourceLine" id="cb753-1457" title="1457"><span class="kw">text</span>(<span class="op">-</span><span class="dv">5</span>,  <span class="fl">7.5</span>, <span class="st">&quot;sensor location&quot;</span>, <span class="dt">srt =</span> <span class="dv">25</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</a>
<a class="sourceLine" id="cb753-1458" title="1458"><span class="kw">text</span>( <span class="dv">7</span>,  <span class="fl">10.5</span>, <span class="st">&quot;air quality parameter&quot;</span>, <span class="dt">srt =</span> <span class="dv">0</span>, <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>)</a>
<a class="sourceLine" id="cb753-1459" title="1459"><span class="kw">text</span>( <span class="fl">1.5</span>,  <span class="fl">8.5</span>, <span class="kw">expression</span>(PM[<span class="dv">10</span>]), <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">cex =</span> <span class="fl">.75</span>)</a>
<a class="sourceLine" id="cb753-1460" title="1460"><span class="kw">text</span>( <span class="fl">4.5</span>,  <span class="fl">8.5</span>, <span class="kw">expression</span>(NO[x]), <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">cex =</span> <span class="fl">.75</span>)</a>
<a class="sourceLine" id="cb753-1461" title="1461"><span class="kw">text</span>( <span class="dv">8</span>,  <span class="fl">8.5</span>, <span class="kw">expression</span>(SO[<span class="dv">4</span>]), <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">cex =</span> <span class="fl">.75</span>)</a>
<a class="sourceLine" id="cb753-1462" title="1462"><span class="kw">text</span>( <span class="dv">11</span>,  <span class="fl">8.5</span>, <span class="kw">expression</span>(O[<span class="dv">3</span>]), <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">cex =</span> <span class="fl">.75</span>)</a>
<a class="sourceLine" id="cb753-1463" title="1463"><span class="kw">text</span>( <span class="dv">14</span>,  <span class="fl">8.5</span>, <span class="kw">expression</span>(CO), <span class="dt">col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">cex =</span> <span class="fl">.75</span>)</a>
<a class="sourceLine" id="cb753-1464" title="1464"><span class="co"># location points:</span></a>
<a class="sourceLine" id="cb753-1465" title="1465">p =<span class="st"> </span><span class="kw">st_coordinates</span>(s[,<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb753-1466" title="1466">p[,<span class="dv">1</span>] =<span class="st"> </span>p[,<span class="dv">1</span>]<span class="op">-</span><span class="fl">1.4</span></a>
<a class="sourceLine" id="cb753-1467" title="1467">p[,<span class="dv">2</span>] =<span class="st"> </span>p[,<span class="dv">2</span>] <span class="op">+</span><span class="st"> </span><span class="fl">8.2</span></a>
<a class="sourceLine" id="cb753-1468" title="1468"><span class="kw">points</span>(p, <span class="dt">col =</span> <span class="kw">grey</span>(.<span class="dv">7</span>), <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb753-1469" title="1469"><span class="co"># centroids:</span></a>
<a class="sourceLine" id="cb753-1470" title="1470"><span class="kw">set.seed</span>(<span class="dv">131</span>)</a>
<a class="sourceLine" id="cb753-1471" title="1471">cent =<span class="st"> </span><span class="kw">st_coordinates</span>(<span class="kw">st_sample</span>(de, <span class="dv">8</span>))</a>
<a class="sourceLine" id="cb753-1472" title="1472"><span class="kw">points</span>(cent, <span class="dt">col =</span> <span class="kw">grey</span>(.<span class="dv">7</span>), <span class="dt">pch =</span> <span class="dv">16</span>)</a>
<a class="sourceLine" id="cb753-1473" title="1473">cent =<span class="st"> </span>cent[<span class="kw">rev</span>(<span class="kw">order</span>(cent[,<span class="dv">1</span>])),]</a>
<a class="sourceLine" id="cb753-1474" title="1474">seg =<span class="st"> </span><span class="kw">cbind</span>(p, cent[<span class="dv">1</span><span class="op">:</span><span class="dv">8</span>,])</a>
<a class="sourceLine" id="cb753-1475" title="1475"><span class="kw">segments</span>(seg[,<span class="dv">1</span>], seg[,<span class="dv">2</span>], seg[,<span class="dv">3</span>], seg[,<span class="dv">4</span>], <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-1476" title="1476"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-1477" title="1477"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1478" title="1478"></a>
<a class="sourceLine" id="cb753-1479" title="1479">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-1480" title="1480">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-1481" title="1481">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-1482" title="1482">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-1483" title="1483"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-1484" title="1484">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-1485" title="1485"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-1486" title="1486"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-1487" title="1487"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-1488" title="1488">)</a>
<a class="sourceLine" id="cb753-1489" title="1489"></a>
<a class="sourceLine" id="cb753-1490" title="1490"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-1491" title="1491"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-1492" title="1492">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-1493" title="1493"></a>
<a class="sourceLine" id="cb753-1494" title="1494"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-1495" title="1495"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-1496" title="1496"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-1497" title="1497">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-1498" title="1498">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-1499" title="1499"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-1500" title="1500">p1 =<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">7.35</span>, <span class="fl">52.42</span>))</a>
<a class="sourceLine" id="cb753-1501" title="1501">p2 =<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">7.22</span>, <span class="fl">52.18</span>))</a>
<a class="sourceLine" id="cb753-1502" title="1502">p3 =<span class="st"> </span><span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">7.44</span>, <span class="fl">52.19</span>))</a>
<a class="sourceLine" id="cb753-1503" title="1503">sfc =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">list</span>(p1, p2, p3), <span class="dt">crs =</span> <span class="st">&#39;OGC:CRS84&#39;</span>)</a>
<a class="sourceLine" id="cb753-1504" title="1504"><span class="kw">st_sf</span>(<span class="dt">elev =</span> <span class="kw">c</span>(<span class="fl">33.2</span>, <span class="fl">52.1</span>, <span class="fl">81.2</span>), <span class="dt">marker =</span> <span class="kw">c</span>(<span class="st">&quot;Id01&quot;</span>, <span class="st">&quot;Id02&quot;</span>, <span class="st">&quot;Id03&quot;</span>),</a>
<a class="sourceLine" id="cb753-1505" title="1505">      <span class="dt">geom =</span> sfc)</a>
<a class="sourceLine" id="cb753-1506" title="1506">knitr<span class="op">::</span><span class="kw">include_graphics</span>(<span class="st">&quot;images/sf_obj.png&quot;</span>)</a>
<a class="sourceLine" id="cb753-1507" title="1507"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-1508" title="1508">(<span class="dt">file =</span> <span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;sf&quot;</span>))</a>
<a class="sourceLine" id="cb753-1509" title="1509">nc =<span class="st"> </span><span class="kw">st_read</span>(file)</a>
<a class="sourceLine" id="cb753-1510" title="1510"><span class="kw">st_layers</span>(file)</a>
<a class="sourceLine" id="cb753-1511" title="1511">(<span class="dt">file =</span> <span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">&quot;.gpkg&quot;</span>))</a>
<a class="sourceLine" id="cb753-1512" title="1512"><span class="kw">st_write</span>(nc, file, <span class="dt">layer =</span> <span class="st">&quot;layer_nc&quot;</span>)</a>
<a class="sourceLine" id="cb753-1513" title="1513">nc[<span class="dv">2</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">3</span><span class="op">:</span><span class="dv">7</span>]</a>
<a class="sourceLine" id="cb753-1514" title="1514">nc5 =<span class="st"> </span>nc[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, ]</a>
<a class="sourceLine" id="cb753-1515" title="1515">nc7 =<span class="st"> </span>nc[<span class="dv">1</span><span class="op">:</span><span class="dv">7</span>, ]</a>
<a class="sourceLine" id="cb753-1516" title="1516">(<span class="dt">i =</span> <span class="kw">st_intersects</span>(nc5, nc7))</a>
<a class="sourceLine" id="cb753-1517" title="1517"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc7))</a>
<a class="sourceLine" id="cb753-1518" title="1518"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc5), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="st">&quot;brown&quot;</span>)</a>
<a class="sourceLine" id="cb753-1519" title="1519">cc =<span class="st"> </span><span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(nc7)))</a>
<a class="sourceLine" id="cb753-1520" title="1520"><span class="kw">text</span>(cc, <span class="dt">labels =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(nc7), <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>)</a>
<a class="sourceLine" id="cb753-1521" title="1521"><span class="kw">as.matrix</span>(i)</a>
<a class="sourceLine" id="cb753-1522" title="1522"><span class="kw">lengths</span>(i)</a>
<a class="sourceLine" id="cb753-1523" title="1523"><span class="kw">lengths</span>(<span class="kw">t</span>(i))</a>
<a class="sourceLine" id="cb753-1524" title="1524"><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">&quot;sgbp&quot;</span>)</a>
<a class="sourceLine" id="cb753-1525" title="1525"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb753-1526" title="1526">nc <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(BIR74) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1527" title="1527">orange &lt;-<span class="st"> </span>nc <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">filter</span>(NAME <span class="op">==</span><span class="st"> &quot;Orange&quot;</span>)</a>
<a class="sourceLine" id="cb753-1528" title="1528">wd =<span class="st"> </span><span class="kw">st_is_within_distance</span>(nc, orange, units<span class="op">::</span><span class="kw">set_units</span>(<span class="dv">50</span>, km))</a>
<a class="sourceLine" id="cb753-1529" title="1529">o50 &lt;-<span class="st"> </span>nc <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="kw">lengths</span>(wd) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb753-1530" title="1530"><span class="kw">nrow</span>(o50)</a>
<a class="sourceLine" id="cb753-1531" title="1531">og =<span class="st"> </span><span class="kw">st_geometry</span>(orange)</a>
<a class="sourceLine" id="cb753-1532" title="1532"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(o50), <span class="dt">lwd =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-1533" title="1533"><span class="kw">plot</span>(og, <span class="dt">col =</span> <span class="st">&#39;orange&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1534" title="1534"><span class="kw">plot</span>(<span class="kw">st_buffer</span>(og, units<span class="op">::</span><span class="kw">set_units</span>(<span class="dv">50</span>, km)), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;brown&#39;</span>)</a>
<a class="sourceLine" id="cb753-1535" title="1535"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-1536" title="1536"><span class="co"># example of largest = TRUE:</span></a>
<a class="sourceLine" id="cb753-1537" title="1537">nc &lt;-<span class="st"> </span><span class="kw">st_transform</span>(<span class="kw">read_sf</span>(<span class="kw">system.file</span>(<span class="st">&quot;shape/nc.shp&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>)), <span class="dv">2264</span>)</a>
<a class="sourceLine" id="cb753-1538" title="1538">gr =<span class="st"> </span><span class="kw">st_sf</span>(</a>
<a class="sourceLine" id="cb753-1539" title="1539">         <span class="dt">label =</span> <span class="kw">apply</span>(<span class="kw">expand.grid</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, LETTERS[<span class="dv">10</span><span class="op">:</span><span class="dv">1</span>])[,<span class="dv">2</span><span class="op">:</span><span class="dv">1</span>], <span class="dv">1</span>, paste0, <span class="dt">collapse =</span> <span class="st">&quot; &quot;</span>),</a>
<a class="sourceLine" id="cb753-1540" title="1540">         <span class="dt">geom =</span> <span class="kw">st_make_grid</span>(nc))</a>
<a class="sourceLine" id="cb753-1541" title="1541">gr<span class="op">$</span>col =<span class="st"> </span><span class="kw">sf.colors</span>(<span class="dv">10</span>, <span class="dt">categorical =</span> <span class="ot">TRUE</span>, <span class="dt">alpha =</span> <span class="fl">.3</span>)</a>
<a class="sourceLine" id="cb753-1542" title="1542"><span class="co"># cut, to check, NA&#39;s work out:</span></a>
<a class="sourceLine" id="cb753-1543" title="1543">gr =<span class="st"> </span>gr[<span class="op">-</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">30</span>),]</a>
<a class="sourceLine" id="cb753-1544" title="1544"><span class="kw">suppressWarnings</span>(nc_j &lt;-<span class="st"> </span><span class="kw">st_join</span>(nc, gr, <span class="dt">largest =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb753-1545" title="1545"><span class="co"># the two datasets:</span></a>
<a class="sourceLine" id="cb753-1546" title="1546">opar =<span class="st"> </span><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>), <span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb753-1547" title="1547"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc_j))</a>
<a class="sourceLine" id="cb753-1548" title="1548"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(gr), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> gr<span class="op">$</span>col)</a>
<a class="sourceLine" id="cb753-1549" title="1549"><span class="kw">text</span>(<span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(gr))), <span class="dt">labels =</span> gr<span class="op">$</span>label)</a>
<a class="sourceLine" id="cb753-1550" title="1550"><span class="co"># the joined dataset:</span></a>
<a class="sourceLine" id="cb753-1551" title="1551"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(nc_j), <span class="dt">border =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">col =</span> nc_j<span class="op">$</span>col)</a>
<a class="sourceLine" id="cb753-1552" title="1552"><span class="kw">text</span>(<span class="kw">st_coordinates</span>(<span class="kw">st_centroid</span>(<span class="kw">st_geometry</span>(nc_j))), <span class="dt">labels =</span> nc_j<span class="op">$</span>label, <span class="dt">cex =</span> <span class="fl">.8</span>)</a>
<a class="sourceLine" id="cb753-1553" title="1553"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(gr), <span class="dt">border =</span> <span class="st">&#39;green&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1554" title="1554"><span class="kw">par</span>(opar)</a>
<a class="sourceLine" id="cb753-1555" title="1555">tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</a>
<a class="sourceLine" id="cb753-1556" title="1556"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb753-1557" title="1557">(<span class="dt">r =</span> <span class="kw">read_stars</span>(tif))</a>
<a class="sourceLine" id="cb753-1558" title="1558"><span class="kw">length</span>(r)</a>
<a class="sourceLine" id="cb753-1559" title="1559"><span class="kw">class</span>(r[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb753-1560" title="1560"><span class="kw">dim</span>(r[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb753-1561" title="1561"><span class="kw">st_dimensions</span>(r)</a>
<a class="sourceLine" id="cb753-1562" title="1562"><span class="kw">st_bbox</span>(r)</a>
<a class="sourceLine" id="cb753-1563" title="1563">tf =<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">&quot;.tif&quot;</span>)</a>
<a class="sourceLine" id="cb753-1564" title="1564"><span class="kw">write_stars</span>(r, tf)</a>
<a class="sourceLine" id="cb753-1565" title="1565"><span class="kw">st_drivers</span>(<span class="st">&quot;raster&quot;</span>)</a>
<a class="sourceLine" id="cb753-1566" title="1566">r[,<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>, <span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">250</span>, <span class="dv">5</span>), <span class="dv">4</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dim</span>()</a>
<a class="sourceLine" id="cb753-1567" title="1567">r[,<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>, <span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">250</span>, <span class="dv">5</span>), <span class="dv">4</span>, drop =<span class="st"> </span><span class="ot">TRUE</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dim</span>()</a>
<a class="sourceLine" id="cb753-1568" title="1568"><span class="kw">library</span>(dplyr, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-1569" title="1569"><span class="kw">filter</span>(r, x <span class="op">&gt;</span><span class="st"> </span><span class="dv">289000</span>, x <span class="op">&lt;</span><span class="st"> </span><span class="dv">290000</span>)</a>
<a class="sourceLine" id="cb753-1570" title="1570"><span class="kw">slice</span>(r, band, <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1571" title="1571">b =<span class="st"> </span><span class="kw">st_bbox</span>(r) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1572" title="1572"><span class="st">    </span><span class="kw">st_as_sfc</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1573" title="1573"><span class="st">    </span><span class="kw">st_centroid</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1574" title="1574"><span class="st">    </span><span class="kw">st_buffer</span>(units<span class="op">::</span><span class="kw">set_units</span>(<span class="dv">500</span>, m))</a>
<a class="sourceLine" id="cb753-1575" title="1575">r[b]</a>
<a class="sourceLine" id="cb753-1576" title="1576"><span class="kw">plot</span>(r[b][,,,<span class="dv">1</span>], <span class="dt">reset =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-1577" title="1577"><span class="kw">plot</span>(b, <span class="dt">border =</span> <span class="st">&#39;brown&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1578" title="1578">r[b] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_normalize</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_dimensions</span>()</a>
<a class="sourceLine" id="cb753-1579" title="1579">r[b, crop =<span class="st"> </span><span class="ot">FALSE</span>]</a>
<a class="sourceLine" id="cb753-1580" title="1580"><span class="kw">st_crop</span>(r, b)</a>
<a class="sourceLine" id="cb753-1581" title="1581"><span class="kw">aperm</span>(r, <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-1582" title="1582">(<span class="dt">rs =</span> <span class="kw">split</span>(r))</a>
<a class="sourceLine" id="cb753-1583" title="1583"><span class="kw">merge</span>(rs)</a>
<a class="sourceLine" id="cb753-1584" title="1584"><span class="kw">st_redimension</span>(r, <span class="kw">c</span>(<span class="dv">349</span>, <span class="dv">352</span>, <span class="dv">3</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-1585" title="1585"><span class="kw">set.seed</span>(<span class="dv">115517</span>)</a>
<a class="sourceLine" id="cb753-1586" title="1586">pts =<span class="st"> </span><span class="kw">st_bbox</span>(r) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_as_sfc</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_sample</span>(<span class="dv">20</span>)</a>
<a class="sourceLine" id="cb753-1587" title="1587">(<span class="dt">e =</span> <span class="kw">st_extract</span>(r, pts))</a>
<a class="sourceLine" id="cb753-1588" title="1588"><span class="kw">set.seed</span>(<span class="dv">131</span>)</a>
<a class="sourceLine" id="cb753-1589" title="1589">circles =<span class="st"> </span><span class="kw">st_sample</span>(<span class="kw">st_as_sfc</span>(<span class="kw">st_bbox</span>(r)), <span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1590" title="1590"><span class="st">    </span><span class="kw">st_buffer</span>(<span class="dv">500</span>)</a>
<a class="sourceLine" id="cb753-1591" title="1591"><span class="kw">aggregate</span>(r, circles, max)</a>
<a class="sourceLine" id="cb753-1592" title="1592"><span class="kw">plot</span>(r[,,,<span class="dv">1</span>], <span class="dt">reset =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-1593" title="1593">col =<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;green&quot;</span>, <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb753-1594" title="1594">col[<span class="kw">c</span>(<span class="dv">8</span>, <span class="dv">14</span>, <span class="dv">15</span>, <span class="dv">18</span>, <span class="dv">19</span>)] =<span class="st"> &quot;red&quot;</span></a>
<a class="sourceLine" id="cb753-1595" title="1595"><span class="kw">st_as_sf</span>(e) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_coordinates</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">text</span>(<span class="dt">labels =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">20</span>, <span class="dt">col =</span> col)</a>
<a class="sourceLine" id="cb753-1596" title="1596">rs =<span class="st"> </span><span class="kw">split</span>(r)</a>
<a class="sourceLine" id="cb753-1597" title="1597">trn =<span class="st"> </span><span class="kw">st_extract</span>(rs, pts)</a>
<a class="sourceLine" id="cb753-1598" title="1598">trn<span class="op">$</span>cls =<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;land&quot;</span>, <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb753-1599" title="1599">trn<span class="op">$</span>cls[<span class="kw">c</span>(<span class="dv">8</span>, <span class="dv">14</span>, <span class="dv">15</span>, <span class="dv">18</span>, <span class="dv">19</span>)] =<span class="st"> &quot;water&quot;</span></a>
<a class="sourceLine" id="cb753-1600" title="1600">model =<span class="st"> </span>MASS<span class="op">::</span><span class="kw">lda</span>(cls <span class="op">~</span><span class="st"> </span>., <span class="kw">st_drop_geometry</span>(trn))</a>
<a class="sourceLine" id="cb753-1601" title="1601">pr =<span class="st"> </span><span class="kw">predict</span>(rs, model)</a>
<a class="sourceLine" id="cb753-1602" title="1602"><span class="kw">plot</span>(pr[<span class="dv">1</span>], <span class="dt">key.pos =</span> <span class="dv">4</span>, <span class="dt">key.width =</span> <span class="kw">lcm</span>(<span class="fl">3.5</span>), <span class="dt">key.length =</span> <span class="kw">lcm</span>(<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-1603" title="1603"><span class="kw">plot</span>(r)</a>
<a class="sourceLine" id="cb753-1604" title="1604"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-1605" title="1605"><span class="kw">plot</span>(r, <span class="dt">rgb =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">main =</span> <span class="st">&quot;RGB&quot;</span>)    <span class="co"># rgb</span></a>
<a class="sourceLine" id="cb753-1606" title="1606"><span class="kw">plot</span>(r, <span class="dt">rgb =</span> <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">2</span>), <span class="dt">main =</span> <span class="st">&quot;False color (NIR-R-G)&quot;</span>) <span class="co"># false color</span></a>
<a class="sourceLine" id="cb753-1607" title="1607"><span class="kw">log</span>(r)</a>
<a class="sourceLine" id="cb753-1608" title="1608">r <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">log</span>(r)</a>
<a class="sourceLine" id="cb753-1609" title="1609">r2 =<span class="st"> </span>r</a>
<a class="sourceLine" id="cb753-1610" title="1610">r2[r <span class="op">&lt;</span><span class="st"> </span><span class="dv">50</span>] =<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb753-1611" title="1611">r2</a>
<a class="sourceLine" id="cb753-1612" title="1612">r2[<span class="kw">is.na</span>(r2)] =<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb753-1613" title="1613">r2</a>
<a class="sourceLine" id="cb753-1614" title="1614"><span class="kw">st_apply</span>(r, <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), mean)</a>
<a class="sourceLine" id="cb753-1615" title="1615">ndvi =<span class="st"> </span><span class="cf">function</span>(b1, b2, b3, b4, b5, b6) (b4 <span class="op">-</span><span class="st"> </span>b3)<span class="op">/</span>(b4 <span class="op">+</span><span class="st"> </span>b3)</a>
<a class="sourceLine" id="cb753-1616" title="1616"><span class="kw">st_apply</span>(r, <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), ndvi)</a>
<a class="sourceLine" id="cb753-1617" title="1617">ndvi2 =<span class="st"> </span><span class="cf">function</span>(x) (x[<span class="dv">4</span>]<span class="op">-</span>x[<span class="dv">3</span>])<span class="op">/</span>(x[<span class="dv">4</span>]<span class="op">+</span>x[<span class="dv">3</span>])</a>
<a class="sourceLine" id="cb753-1618" title="1618"><span class="kw">as.data.frame</span>(<span class="kw">st_apply</span>(r, <span class="kw">c</span>(<span class="st">&quot;band&quot;</span>), mean))</a>
<a class="sourceLine" id="cb753-1619" title="1619"><span class="kw">st_apply</span>(r, <span class="kw">c</span>(<span class="st">&quot;band&quot;</span>), quantile, <span class="kw">c</span>(.<span class="dv">25</span>, <span class="fl">.5</span>, <span class="fl">.75</span>))</a>
<a class="sourceLine" id="cb753-1620" title="1620"><span class="kw">st_apply</span>(r, <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), quantile, <span class="kw">c</span>(.<span class="dv">25</span>, <span class="fl">.5</span>, <span class="fl">.75</span>))</a>
<a class="sourceLine" id="cb753-1621" title="1621"><span class="kw">options</span>(<span class="st">&quot;rgdal_show_exportToProj4_warnings&quot;</span>=<span class="st">&quot;none&quot;</span>) <span class="co"># led to:</span></a>
<a class="sourceLine" id="cb753-1622" title="1622"><span class="co"># Warning in sp::proj4string(obj): CRS object has comment, which is</span></a>
<a class="sourceLine" id="cb753-1623" title="1623"><span class="co"># lost in output</span></a>
<a class="sourceLine" id="cb753-1624" title="1624"><span class="kw">library</span>(spacetime)</a>
<a class="sourceLine" id="cb753-1625" title="1625"><span class="kw">data</span>(air) <span class="co"># this loads several datasets in .GlobalEnv</span></a>
<a class="sourceLine" id="cb753-1626" title="1626"><span class="kw">dim</span>(air)</a>
<a class="sourceLine" id="cb753-1627" title="1627">d =<span class="st"> </span><span class="kw">st_dimensions</span>(<span class="dt">station =</span> <span class="kw">st_as_sfc</span>(stations), <span class="dt">time =</span> dates)</a>
<a class="sourceLine" id="cb753-1628" title="1628">(<span class="dt">aq =</span> <span class="kw">st_as_stars</span>(<span class="kw">list</span>(<span class="dt">PM10 =</span> air), <span class="dt">dimensions =</span> d))</a>
<a class="sourceLine" id="cb753-1629" title="1629"><span class="kw">image</span>(<span class="kw">aperm</span>(<span class="kw">log</span>(aq), <span class="dv">2</span><span class="op">:</span><span class="dv">1</span>), <span class="dt">main =</span> <span class="st">&quot;NA pattern (white) in PM10 station time series&quot;</span>)</a>
<a class="sourceLine" id="cb753-1630" title="1630"><span class="kw">plot</span>(<span class="kw">st_as_sf</span>(<span class="kw">st_apply</span>(aq, <span class="dv">1</span>, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)), <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">pch =</span> <span class="dv">16</span>,</a>
<a class="sourceLine" id="cb753-1631" title="1631">    <span class="dt">ylim =</span> <span class="kw">st_bbox</span>(DE)[<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>)])</a>
<a class="sourceLine" id="cb753-1632" title="1632"><span class="kw">plot</span>(DE, <span class="dt">add=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1633" title="1633">(<span class="dt">a =</span> <span class="kw">aggregate</span>(aq, <span class="kw">st_as_sf</span>(DE_NUTS1), mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb753-1634" title="1634"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb753-1635" title="1635">a <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(time <span class="op">&gt;=</span><span class="st"> &quot;2008-01-01&quot;</span>, time <span class="op">&lt;</span><span class="st"> &quot;2008-01-07&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-1636" title="1636"><span class="st">    </span><span class="kw">plot</span>(<span class="dt">key.pos =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb753-1637" title="1637"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(xts))</a>
<a class="sourceLine" id="cb753-1638" title="1638"><span class="kw">plot</span>(<span class="kw">as.xts</span>(a)[,<span class="dv">4</span>], <span class="dt">main =</span> DE_NUTS1<span class="op">$</span>NAME_<span class="dv">1</span>[<span class="dv">4</span>])</a>
<a class="sourceLine" id="cb753-1639" title="1639"><span class="kw">library</span>(spDataLarge)</a>
<a class="sourceLine" id="cb753-1640" title="1640"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(bristol_zones), <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">graticule =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1641" title="1641"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(bristol_zones)[<span class="dv">33</span>], <span class="dt">col =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1642" title="1642"><span class="kw">head</span>(bristol_od)</a>
<a class="sourceLine" id="cb753-1643" title="1643"><span class="kw">nrow</span>(bristol_zones)<span class="op">^</span><span class="dv">2</span> <span class="co"># all combinations</span></a>
<a class="sourceLine" id="cb753-1644" title="1644"><span class="kw">nrow</span>(bristol_od) <span class="co"># non-zero combinations</span></a>
<a class="sourceLine" id="cb753-1645" title="1645"><span class="co"># create O-D-mode array:</span></a>
<a class="sourceLine" id="cb753-1646" title="1646">bristol_tidy &lt;-<span class="st"> </span>bristol_od <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-1647" title="1647"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>all) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-1648" title="1648"><span class="st">    </span><span class="kw">pivot_longer</span>(<span class="dv">3</span><span class="op">:</span><span class="dv">6</span>, <span class="dt">names_to =</span> <span class="st">&quot;mode&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;n&quot;</span>)</a>
<a class="sourceLine" id="cb753-1649" title="1649"><span class="kw">head</span>(bristol_tidy)</a>
<a class="sourceLine" id="cb753-1650" title="1650">od =<span class="st"> </span>bristol_tidy <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(<span class="st">&quot;o&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unique</span>()</a>
<a class="sourceLine" id="cb753-1651" title="1651">nod =<span class="st"> </span><span class="kw">length</span>(od)</a>
<a class="sourceLine" id="cb753-1652" title="1652">mode =<span class="st"> </span>bristol_tidy <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(<span class="st">&quot;mode&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unique</span>()</a>
<a class="sourceLine" id="cb753-1653" title="1653">nmode =<span class="st"> </span><span class="kw">length</span>(mode)</a>
<a class="sourceLine" id="cb753-1654" title="1654">a =<span class="st"> </span><span class="kw">array</span>(0L,  <span class="kw">c</span>(nod, nod, nmode), </a>
<a class="sourceLine" id="cb753-1655" title="1655">    <span class="dt">dimnames =</span> <span class="kw">list</span>(<span class="dt">o =</span> od, <span class="dt">d =</span> od, <span class="dt">mode =</span> mode))</a>
<a class="sourceLine" id="cb753-1656" title="1656"><span class="kw">dim</span>(a)</a>
<a class="sourceLine" id="cb753-1657" title="1657">a[<span class="kw">as.matrix</span>(bristol_tidy[<span class="kw">c</span>(<span class="st">&quot;o&quot;</span>, <span class="st">&quot;d&quot;</span>, <span class="st">&quot;mode&quot;</span>)])] =<span class="st"> </span>bristol_tidy<span class="op">$</span>n</a>
<a class="sourceLine" id="cb753-1658" title="1658">order =<span class="st"> </span><span class="kw">match</span>(od, bristol_zones<span class="op">$</span>geo_code) <span class="co"># it happens this equals 1:102</span></a>
<a class="sourceLine" id="cb753-1659" title="1659">zones =<span class="st"> </span><span class="kw">st_geometry</span>(bristol_zones)[order]</a>
<a class="sourceLine" id="cb753-1660" title="1660"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb753-1661" title="1661">(<span class="dt">d =</span> <span class="kw">st_dimensions</span>(<span class="dt">o =</span> zones, <span class="dt">d =</span> zones, <span class="dt">mode =</span> mode))</a>
<a class="sourceLine" id="cb753-1662" title="1662">(<span class="dt">odm =</span> <span class="kw">st_as_stars</span>(<span class="kw">list</span>(<span class="dt">N =</span> a), <span class="dt">dimensions =</span> d))</a>
<a class="sourceLine" id="cb753-1663" title="1663"><span class="kw">plot</span>(<span class="kw">adrop</span>(odm[,,<span class="dv">33</span>]) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">logz =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1664" title="1664">d =<span class="st"> </span><span class="kw">st_apply</span>(odm, <span class="dv">2</span>, sum)</a>
<a class="sourceLine" id="cb753-1665" title="1665"><span class="kw">which.max</span>(d[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb753-1666" title="1666"><span class="kw">st_apply</span>(odm, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, sum)</a>
<a class="sourceLine" id="cb753-1667" title="1667"><span class="kw">st_apply</span>(odm, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), sum)</a>
<a class="sourceLine" id="cb753-1668" title="1668"><span class="kw">st_apply</span>(odm, <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), sum)</a>
<a class="sourceLine" id="cb753-1669" title="1669">o =<span class="st"> </span><span class="kw">st_apply</span>(odm, <span class="dv">1</span>, sum)</a>
<a class="sourceLine" id="cb753-1670" title="1670">d =<span class="st"> </span><span class="kw">st_apply</span>(odm, <span class="dv">2</span>, sum)</a>
<a class="sourceLine" id="cb753-1671" title="1671">x =<span class="st"> </span>(<span class="kw">c</span>(o, d, <span class="dt">along =</span> <span class="kw">list</span>(<span class="dt">od =</span> <span class="kw">c</span>(<span class="st">&quot;origin&quot;</span>, <span class="st">&quot;destination&quot;</span>))))</a>
<a class="sourceLine" id="cb753-1672" title="1672"><span class="kw">plot</span>(x, <span class="dt">logz =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1673" title="1673"><span class="kw">library</span>(units)</a>
<a class="sourceLine" id="cb753-1674" title="1674">a =<span class="st"> </span><span class="kw">set_units</span>(<span class="kw">st_area</span>(<span class="kw">st_as_sf</span>(o)), km<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-1675" title="1675">o<span class="op">$</span>sum_km =<span class="st"> </span>o<span class="op">$</span>sum <span class="op">/</span><span class="st"> </span>a</a>
<a class="sourceLine" id="cb753-1676" title="1676">d<span class="op">$</span>sum_km =<span class="st"> </span>d<span class="op">$</span>sum <span class="op">/</span><span class="st"> </span>a</a>
<a class="sourceLine" id="cb753-1677" title="1677">od =<span class="st"> </span><span class="kw">c</span>(o[<span class="st">&quot;sum_km&quot;</span>], d[<span class="st">&quot;sum_km&quot;</span>], <span class="dt">along =</span> <span class="kw">list</span>(<span class="dt">od =</span> <span class="kw">c</span>(<span class="st">&quot;origin&quot;</span>, <span class="st">&quot;destination&quot;</span>)))</a>
<a class="sourceLine" id="cb753-1678" title="1678"><span class="kw">plot</span>(od, <span class="dt">logz =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1679" title="1679">(<span class="dt">file =</span> <span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package=</span><span class="st">&quot;sf&quot;</span>))</a>
<a class="sourceLine" id="cb753-1680" title="1680"><span class="kw">read_sf</span>(file) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-1681" title="1681"><span class="st">    </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1682" title="1682"><span class="st">    </span><span class="kw">st_as_stars</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1683" title="1683"><span class="st">    </span><span class="kw">plot</span>()</a>
<a class="sourceLine" id="cb753-1684" title="1684"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb753-1685" title="1685"><span class="kw">read_sf</span>(file) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1686" title="1686"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="kw">as.factor</span>(NAME)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1687" title="1687"><span class="st">    </span><span class="kw">select</span>(SID74, SID79, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1688" title="1688"><span class="st">    </span><span class="kw">st_rasterize</span>()</a>
<a class="sourceLine" id="cb753-1689" title="1689"><span class="kw">read_sf</span>(file) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1690" title="1690"><span class="st">    </span><span class="kw">st_cast</span>(<span class="st">&quot;MULTILINESTRING&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1691" title="1691"><span class="st">    </span><span class="kw">select</span>(CNTY_ID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1692" title="1692"><span class="st">    </span><span class="kw">st_rasterize</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1693" title="1693"><span class="st">    </span><span class="kw">plot</span>()</a>
<a class="sourceLine" id="cb753-1694" title="1694">x =<span class="st"> </span><span class="kw">st_crs</span>(<span class="st">&quot;OGC:CRS84&quot;</span>)</a>
<a class="sourceLine" id="cb753-1695" title="1695">x<span class="op">$</span>proj4string</a>
<a class="sourceLine" id="cb753-1696" title="1696"><span class="kw">sf_proj_search_paths</span>()</a>
<a class="sourceLine" id="cb753-1697" title="1697"><span class="kw">paste0</span>(<span class="kw">tail</span>(<span class="kw">sf_proj_search_paths</span>(), <span class="dv">1</span>), .Platform<span class="op">$</span>file.sep, <span class="st">&quot;proj.db&quot;</span>)</a>
<a class="sourceLine" id="cb753-1698" title="1698"><span class="kw">sf_extSoftVersion</span>()[<span class="st">&quot;PROJ&quot;</span>]</a>
<a class="sourceLine" id="cb753-1699" title="1699"><span class="kw">sf_proj_network</span>()</a>
<a class="sourceLine" id="cb753-1700" title="1700"><span class="kw">sf_proj_network</span>(<span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1701" title="1701"><span class="kw">list.files</span>(<span class="kw">sf_proj_search_paths</span>()[<span class="dv">1</span>], <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1702" title="1702">(<span class="dt">p =</span> <span class="kw">sf_proj_pipelines</span>(<span class="st">&quot;EPSG:4326&quot;</span>, <span class="st">&quot;EPSG:22525&quot;</span>))</a>
<a class="sourceLine" id="cb753-1703" title="1703"><span class="kw">sf_proj_network</span>(<span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-1704" title="1704"><span class="kw">sf_proj_pipelines</span>(<span class="st">&quot;EPSG:4326&quot;</span>, <span class="st">&quot;EPSG:22525&quot;</span>)</a>
<a class="sourceLine" id="cb753-1705" title="1705"><span class="kw">names</span>(p)</a>
<a class="sourceLine" id="cb753-1706" title="1706">p<span class="op">$</span>accuracy</a>
<a class="sourceLine" id="cb753-1707" title="1707">p[<span class="kw">is.na</span>(p<span class="op">$</span>accuracy),]</a>
<a class="sourceLine" id="cb753-1708" title="1708"><span class="kw">cat</span>(<span class="kw">st_crs</span>(<span class="st">&quot;EPSG:4326&quot;</span>)<span class="op">$</span>wkt, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb753-1709" title="1709"><span class="kw">st_axis_order</span>(<span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1710" title="1710">tif =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>)</a>
<a class="sourceLine" id="cb753-1711" title="1711"><span class="kw">read_stars</span>(tif) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1712" title="1712"><span class="st">    </span><span class="kw">st_transform</span>(<span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb753-1713" title="1713"><span class="kw">read_stars</span>(tif) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1714" title="1714"><span class="st">    </span><span class="kw">st_warp</span>(<span class="dt">crs =</span> <span class="kw">st_crs</span>(<span class="dv">4326</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1715" title="1715"><span class="st">    </span><span class="kw">st_dimensions</span>()</a>
<a class="sourceLine" id="cb753-1716" title="1716">r =<span class="st"> </span><span class="kw">read_stars</span>(tif)</a>
<a class="sourceLine" id="cb753-1717" title="1717">grd =<span class="st"> </span><span class="kw">st_bbox</span>(r) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1718" title="1718"><span class="st">        </span><span class="kw">st_as_sfc</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1719" title="1719"><span class="st">        </span><span class="kw">st_transform</span>(<span class="dv">4326</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1720" title="1720"><span class="st">        </span><span class="kw">st_bbox</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1721" title="1721"><span class="st">        </span><span class="kw">st_as_stars</span>(<span class="dt">nx =</span> <span class="kw">dim</span>(r)[<span class="st">&quot;x&quot;</span>], <span class="dt">ny =</span> <span class="kw">dim</span>(r)[<span class="st">&quot;y&quot;</span>])</a>
<a class="sourceLine" id="cb753-1722" title="1722"><span class="kw">st_warp</span>(r, grd)</a>
<a class="sourceLine" id="cb753-1723" title="1723"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-1724" title="1724"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1725" title="1725"></a>
<a class="sourceLine" id="cb753-1726" title="1726">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-1727" title="1727">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-1728" title="1728">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-1729" title="1729">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-1730" title="1730"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-1731" title="1731">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-1732" title="1732"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-1733" title="1733"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-1734" title="1734"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-1735" title="1735">)</a>
<a class="sourceLine" id="cb753-1736" title="1736"></a>
<a class="sourceLine" id="cb753-1737" title="1737"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-1738" title="1738"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-1739" title="1739">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-1740" title="1740"></a>
<a class="sourceLine" id="cb753-1741" title="1741"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-1742" title="1742"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-1743" title="1743"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-1744" title="1744">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-1745" title="1745">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-1746" title="1746"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-1747" title="1747">(<span class="dt">file =</span> <span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;sf&quot;</span>))</a>
<a class="sourceLine" id="cb753-1748" title="1748">bb =<span class="st"> &quot;POLYGON ((-81.7 36.2, -80.4 36.2, -80.4 36.5, -81.7 36.5, -81.7 36.2))&quot;</span></a>
<a class="sourceLine" id="cb753-1749" title="1749">nc<span class="fl">.1</span> =<span class="st"> </span><span class="kw">st_read</span>(file, <span class="dt">wkt_filter =</span> bb)</a>
<a class="sourceLine" id="cb753-1750" title="1750">q =<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;select BIR74,SID74,geom from &#39;nc.gpkg&#39; where BIR74 &gt; 1500&quot;</span>)</a>
<a class="sourceLine" id="cb753-1751" title="1751">nc<span class="fl">.2</span> =<span class="st"> </span><span class="kw">st_read</span>(file, <span class="dt">query =</span> q)</a>
<a class="sourceLine" id="cb753-1752" title="1752">q =<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;select BIR74,SID74,geom from &#39;nc.gpkg&#39; LIMIT 10 OFFSET 50&quot;</span>)</a>
<a class="sourceLine" id="cb753-1753" title="1753">nc<span class="fl">.2</span> =<span class="st"> </span><span class="kw">st_read</span>(file, <span class="dt">query =</span> q)</a>
<a class="sourceLine" id="cb753-1754" title="1754">has_PG &lt;-<span class="st"> </span><span class="kw">any</span>(<span class="st">&quot;PostgreSQL&quot;</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">st_drivers</span>()<span class="op">$</span>name) <span class="op">&amp;&amp;</span></a>
<a class="sourceLine" id="cb753-1755" title="1755"><span class="st">    </span><span class="op">!</span><span class="kw">inherits</span>(<span class="kw">try</span>(DBI<span class="op">::</span><span class="kw">dbConnect</span>( </a>
<a class="sourceLine" id="cb753-1756" title="1756">        RPostgres<span class="op">::</span><span class="kw">Postgres</span>(),</a>
<a class="sourceLine" id="cb753-1757" title="1757">        <span class="dt">host =</span> <span class="st">&quot;localhost&quot;</span>,</a>
<a class="sourceLine" id="cb753-1758" title="1758">        <span class="dt">dbname =</span> <span class="st">&quot;postgis&quot;</span>), <span class="dt">silent =</span> <span class="ot">TRUE</span>), <span class="st">&quot;try-error&quot;</span>)</a>
<a class="sourceLine" id="cb753-1759" title="1759">nc =<span class="st"> </span><span class="kw">read_sf</span>(file)</a>
<a class="sourceLine" id="cb753-1760" title="1760"><span class="kw">write_sf</span>(nc, <span class="st">&quot;PG:dbname=postgis&quot;</span>, <span class="st">&quot;nc&quot;</span>)</a>
<a class="sourceLine" id="cb753-1761" title="1761">pg &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbConnect</span>(</a>
<a class="sourceLine" id="cb753-1762" title="1762">    RPostgres<span class="op">::</span><span class="kw">Postgres</span>(),</a>
<a class="sourceLine" id="cb753-1763" title="1763">    <span class="dt">host =</span> <span class="st">&quot;localhost&quot;</span>,</a>
<a class="sourceLine" id="cb753-1764" title="1764">    <span class="dt">dbname =</span> <span class="st">&quot;postgis&quot;</span>)</a>
<a class="sourceLine" id="cb753-1765" title="1765"><span class="kw">st_read</span>(pg, <span class="dt">query =</span> <span class="st">&quot;select BIR74,wkb_geometry from nc limit 3&quot;</span>)</a>
<a class="sourceLine" id="cb753-1766" title="1766">q =<span class="st"> &quot;SELECT BIR74,wkb_geometry FROM nc WHERE \</span></a>
<a class="sourceLine" id="cb753-1767" title="1767"><span class="st">  ST_Intersects(wkb_geometry, &#39;SRID=4267;POINT (-81.49826 36.4314)&#39;);&quot;</span></a>
<a class="sourceLine" id="cb753-1768" title="1768"><span class="kw">st_read</span>(pg, <span class="dt">query =</span> q)</a>
<a class="sourceLine" id="cb753-1769" title="1769"><span class="kw">library</span>(dplyr, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-1770" title="1770">nc_db =<span class="st"> </span><span class="kw">tbl</span>(pg, <span class="st">&quot;nc&quot;</span>)</a>
<a class="sourceLine" id="cb753-1771" title="1771">nc_db <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-1772" title="1772"><span class="st">     </span><span class="kw">filter</span>(<span class="kw">ST_Intersects</span>(wkb_geometry, <span class="st">&#39;SRID=4267;POINT (-81.49826 36.4314)&#39;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1773" title="1773"><span class="st">     </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb753-1774" title="1774">nc_db <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="kw">ST_Area</span>(wkb_geometry) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1775" title="1775"><span class="kw">download.file</span>(</a>
<a class="sourceLine" id="cb753-1776" title="1776">  <span class="st">&quot;https://openstreetmap.org/api/0.6/map?bbox=7.595,51.969,7.598,51.970&quot;</span>,</a>
<a class="sourceLine" id="cb753-1777" title="1777">  <span class="st">&quot;data/ms.osm&quot;</span>, <span class="dt">method =</span> <span class="st">&quot;auto&quot;</span>)</a>
<a class="sourceLine" id="cb753-1778" title="1778">o =<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/ms.osm&quot;</span>, <span class="st">&quot;lines&quot;</span>)</a>
<a class="sourceLine" id="cb753-1779" title="1779">p =<span class="st"> </span><span class="kw">read_sf</span>(<span class="st">&quot;data/ms.osm&quot;</span>, <span class="st">&quot;multipolygons&quot;</span>)</a>
<a class="sourceLine" id="cb753-1780" title="1780">bb =<span class="st"> </span><span class="kw">st_bbox</span>(<span class="kw">c</span>(<span class="dt">xmin=</span><span class="fl">7.595</span>, <span class="dt">ymin =</span> <span class="fl">51.969</span>, <span class="dt">xmax =</span> <span class="fl">7.598</span>, <span class="dt">ymax =</span> <span class="fl">51.970</span>),</a>
<a class="sourceLine" id="cb753-1781" title="1781">    <span class="dt">crs =</span> <span class="dv">4326</span>)</a>
<a class="sourceLine" id="cb753-1782" title="1782"><span class="kw">plot</span>(<span class="kw">st_as_sfc</span>(bb), <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">cex.axis =</span> <span class="fl">.5</span>)</a>
<a class="sourceLine" id="cb753-1783" title="1783"><span class="kw">plot</span>(o[,<span class="dv">1</span>], <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1784" title="1784"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(p), <span class="dt">border =</span> <span class="ot">NA</span>, <span class="dt">col =</span> <span class="st">&#39;#88888888&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1785" title="1785"><span class="kw">options</span>(<span class="dt">timeout =</span> <span class="dv">600</span>) <span class="co"># or large in case of slow network</span></a>
<a class="sourceLine" id="cb753-1786" title="1786"><span class="kw">install.packages</span>(<span class="st">&quot;starsdata&quot;</span>, <span class="dt">repos =</span> <span class="st">&quot;http://pebesma.staff.ifgi.de&quot;</span>, </a>
<a class="sourceLine" id="cb753-1787" title="1787">    <span class="dt">type =</span> <span class="st">&quot;source&quot;</span>)</a>
<a class="sourceLine" id="cb753-1788" title="1788">f =<span class="st"> &quot;sentinel/S2A_MSIL1C_20180220T105051_N0206_R051_T32ULE_20180221T134037.zip&quot;</span></a>
<a class="sourceLine" id="cb753-1789" title="1789">granule =<span class="st"> </span><span class="kw">system.file</span>(<span class="dt">file =</span> f, <span class="dt">package =</span> <span class="st">&quot;starsdata&quot;</span>)</a>
<a class="sourceLine" id="cb753-1790" title="1790"><span class="kw">file.size</span>(granule)</a>
<a class="sourceLine" id="cb753-1791" title="1791">base_name =<span class="st"> </span><span class="kw">strsplit</span>(<span class="kw">basename</span>(granule), <span class="st">&quot;.zip&quot;</span>)[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb753-1792" title="1792">s2 =<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;SENTINEL2_L1C:/vsizip/&quot;</span>, granule, <span class="st">&quot;/&quot;</span>, base_name, </a>
<a class="sourceLine" id="cb753-1793" title="1793">    <span class="st">&quot;.SAFE/MTD_MSIL1C.xml:10m:EPSG_32632&quot;</span>)</a>
<a class="sourceLine" id="cb753-1794" title="1794">(<span class="dt">p =</span> <span class="kw">read_stars</span>(s2, <span class="dt">proxy =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb753-1795" title="1795"><span class="kw">object.size</span>(p)</a>
<a class="sourceLine" id="cb753-1796" title="1796">p2 =<span class="st"> </span>p <span class="op">*</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb753-1797" title="1797"><span class="kw">plot</span>(p)</a>
<a class="sourceLine" id="cb753-1798" title="1798">(<span class="dt">ds =</span> <span class="kw">floor</span>(<span class="kw">sqrt</span>(<span class="kw">prod</span>(<span class="kw">dim</span>(p)) <span class="op">/</span><span class="st"> </span><span class="kw">prod</span>(<span class="kw">dev.size</span>(<span class="st">&quot;px&quot;</span>)))))</a>
<a class="sourceLine" id="cb753-1799" title="1799"><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">&quot;stars_proxy&quot;</span>)</a>
<a class="sourceLine" id="cb753-1800" title="1800"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-1801" title="1801"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1802" title="1802"></a>
<a class="sourceLine" id="cb753-1803" title="1803">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-1804" title="1804">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-1805" title="1805">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-1806" title="1806">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-1807" title="1807"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-1808" title="1808">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-1809" title="1809"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-1810" title="1810"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-1811" title="1811"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-1812" title="1812">)</a>
<a class="sourceLine" id="cb753-1813" title="1813"></a>
<a class="sourceLine" id="cb753-1814" title="1814"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-1815" title="1815"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-1816" title="1816">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-1817" title="1817"></a>
<a class="sourceLine" id="cb753-1818" title="1818"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-1819" title="1819"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-1820" title="1820"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-1821" title="1821">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-1822" title="1822">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-1823" title="1823"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-1824" title="1824"><span class="kw">library</span>(rnaturalearth)</a>
<a class="sourceLine" id="cb753-1825" title="1825">w &lt;-<span class="st"> </span><span class="kw">ne_countries</span>(<span class="dt">scale =</span> <span class="st">&quot;medium&quot;</span>, <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>)</a>
<a class="sourceLine" id="cb753-1826" title="1826"><span class="kw">suppressWarnings</span>(<span class="kw">st_crs</span>(w) &lt;-<span class="st"> </span><span class="kw">st_crs</span>(<span class="dv">4326</span>))</a>
<a class="sourceLine" id="cb753-1827" title="1827"><span class="kw">layout</span>(<span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb753-1828" title="1828"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb753-1829" title="1829"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(w))</a>
<a class="sourceLine" id="cb753-1830" title="1830"></a>
<a class="sourceLine" id="cb753-1831" title="1831"><span class="co"># sphere:</span></a>
<a class="sourceLine" id="cb753-1832" title="1832"><span class="kw">library</span>(s2)</a>
<a class="sourceLine" id="cb753-1833" title="1833">g =<span class="st"> </span><span class="kw">as_s2_geography</span>(<span class="ot">TRUE</span>) <span class="co"># Earth</span></a>
<a class="sourceLine" id="cb753-1834" title="1834">co =<span class="st"> </span><span class="kw">s2_data_countries</span>()</a>
<a class="sourceLine" id="cb753-1835" title="1835">oc =<span class="st"> </span><span class="kw">s2_difference</span>(g, <span class="kw">s2_union_agg</span>(co)) <span class="co"># oceans</span></a>
<a class="sourceLine" id="cb753-1836" title="1836">b =<span class="st"> </span><span class="kw">s2_buffer_cells</span>(<span class="kw">as_s2_geography</span>(<span class="st">&quot;POINT(-30 -10)&quot;</span>), <span class="dv">9800000</span>) <span class="co"># visible half</span></a>
<a class="sourceLine" id="cb753-1837" title="1837">i =<span class="st"> </span><span class="kw">s2_intersection</span>(b, oc) <span class="co"># visible ocean</span></a>
<a class="sourceLine" id="cb753-1838" title="1838">co =<span class="st"> </span><span class="kw">s2_intersection</span>(b, co)</a>
<a class="sourceLine" id="cb753-1839" title="1839"><span class="kw">plot</span>(<span class="kw">st_transform</span>(<span class="kw">st_as_sfc</span>(i), <span class="st">&quot;+proj=ortho +lat_0=-10 +lon_0=-30&quot;</span>), <span class="dt">col =</span> <span class="st">&#39;lightblue&#39;</span>)</a>
<a class="sourceLine" id="cb753-1840" title="1840"><span class="kw">plot</span>(<span class="kw">st_transform</span>(<span class="kw">st_as_sfc</span>(co), <span class="st">&quot;+proj=ortho +lat_0=-10 +lon_0=-30&quot;</span>), <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1841" title="1841"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-1842" title="1842"><span class="kw">library</span>(rnaturalearth)</a>
<a class="sourceLine" id="cb753-1843" title="1843">w &lt;-<span class="st"> </span><span class="kw">ne_countries</span>(<span class="dt">scale =</span> <span class="st">&quot;medium&quot;</span>, <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>)</a>
<a class="sourceLine" id="cb753-1844" title="1844"><span class="kw">plot</span>(<span class="kw">st_geometry</span>(w))</a>
<a class="sourceLine" id="cb753-1845" title="1845"><span class="kw">st_is_longlat</span>(w)</a>
<a class="sourceLine" id="cb753-1846" title="1846">DE =<span class="st"> </span><span class="kw">st_geometry</span>(<span class="kw">ne_countries</span>(<span class="dt">country =</span> <span class="st">&quot;germany&quot;</span>, <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>))</a>
<a class="sourceLine" id="cb753-1847" title="1847">DE.eqc =<span class="st"> </span><span class="kw">st_transform</span>(DE, <span class="st">&quot;+proj=eqc +lat_ts=51.14 +lon_0=90w&quot;</span>)</a>
<a class="sourceLine" id="cb753-1848" title="1848"><span class="kw">print</span>(<span class="kw">mean</span>(<span class="kw">st_bbox</span>(DE)[<span class="kw">c</span>(<span class="st">&quot;ymin&quot;</span>, <span class="st">&quot;ymax&quot;</span>)]), <span class="dt">digits =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb753-1849" title="1849"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-1850" title="1850"><span class="kw">plot</span>(DE, <span class="dt">axes =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1851" title="1851"><span class="kw">plot</span>(DE.eqc, <span class="dt">axes =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1852" title="1852"><span class="kw">library</span>(classInt)</a>
<a class="sourceLine" id="cb753-1853" title="1853"><span class="co"># set.seed(1) needed ?</span></a>
<a class="sourceLine" id="cb753-1854" title="1854">r =<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">100</span>)</a>
<a class="sourceLine" id="cb753-1855" title="1855">(cI &lt;-<span class="st"> </span><span class="kw">classIntervals</span>(r))</a>
<a class="sourceLine" id="cb753-1856" title="1856">cI<span class="op">$</span>brks</a>
<a class="sourceLine" id="cb753-1857" title="1857"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-1858" title="1858">nc =<span class="st"> </span><span class="kw">read_sf</span>(<span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;sf&quot;</span>))</a>
<a class="sourceLine" id="cb753-1859" title="1859"><span class="kw">plot</span>(nc[<span class="st">&quot;BIR74&quot;</span>], <span class="dt">reset =</span> <span class="ot">FALSE</span>, <span class="dt">key.pos =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb753-1860" title="1860"><span class="kw">plot</span>(<span class="kw">st_buffer</span>(nc[<span class="dv">1</span>,<span class="dv">1</span>], units<span class="op">::</span><span class="kw">set_units</span>(<span class="dv">10</span>, km)), <span class="dt">col =</span> <span class="st">&#39;NA&#39;</span>, </a>
<a class="sourceLine" id="cb753-1861" title="1861">     <span class="dt">border =</span> <span class="st">&#39;red&#39;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1862" title="1862"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb753-1863" title="1863">r =<span class="st"> </span><span class="kw">read_stars</span>(<span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>))</a>
<a class="sourceLine" id="cb753-1864" title="1864">circ =<span class="st"> </span><span class="kw">st_bbox</span>(r) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_as_sfc</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_sample</span>(<span class="dv">5</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_buffer</span>(<span class="dv">300</span>)</a>
<a class="sourceLine" id="cb753-1865" title="1865">hook =<span class="st"> </span><span class="cf">function</span>() <span class="kw">plot</span>(circ, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&#39;yellow&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1866" title="1866"><span class="kw">plot</span>(r, <span class="dt">hook =</span> hook, <span class="dt">key.pos =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb753-1867" title="1867"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(tidyverse))</a>
<a class="sourceLine" id="cb753-1868" title="1868">nc<span class="fl">.32119</span> =<span class="st"> </span><span class="kw">st_transform</span>(nc, <span class="dv">32119</span>) </a>
<a class="sourceLine" id="cb753-1869" title="1869">year_labels =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SID74&quot;</span> =<span class="st"> &quot;1974 - 1978&quot;</span>, <span class="st">&quot;SID79&quot;</span> =<span class="st"> &quot;1979 - 1984&quot;</span>)</a>
<a class="sourceLine" id="cb753-1870" title="1870">nc<span class="fl">.32119</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID74, SID79) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-1871" title="1871"><span class="st">    </span><span class="kw">pivot_longer</span>(<span class="kw">starts_with</span>(<span class="st">&quot;SID&quot;</span>)) -&gt;<span class="st"> </span>nc_longer</a>
<a class="sourceLine" id="cb753-1872" title="1872"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> nc_longer, <span class="kw">aes</span>(<span class="dt">fill =</span> value)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-1873" title="1873"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>name, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">labeller =</span> <span class="kw">labeller</span>(<span class="dt">name =</span> year_labels)) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-1874" title="1874"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">breaks =</span> <span class="dv">34</span><span class="op">:</span><span class="dv">36</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-1875" title="1875"><span class="st">  </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colours =</span> <span class="kw">sf.colors</span>(<span class="dv">20</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-1876" title="1876"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.grid.major =</span> <span class="kw">element_line</span>(<span class="dt">colour =</span> <span class="st">&quot;white&quot;</span>))</a>
<a class="sourceLine" id="cb753-1877" title="1877"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb753-1878" title="1878"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb753-1879" title="1879">r =<span class="st"> </span><span class="kw">read_stars</span>(<span class="kw">system.file</span>(<span class="st">&quot;tif/L7_ETMs.tif&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;stars&quot;</span>))</a>
<a class="sourceLine" id="cb753-1880" title="1880"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> r) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-1881" title="1881"><span class="st">        </span><span class="kw">facet_wrap</span>(<span class="op">~</span>band) <span class="op">+</span><span class="st"> </span><span class="kw">coord_equal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb753-1882" title="1882"><span class="st">        </span><span class="kw">theme_void</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb753-1883" title="1883"><span class="st">        </span><span class="kw">scale_x_discrete</span>(<span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-1884" title="1884"><span class="st">        </span><span class="kw">scale_y_discrete</span>(<span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-1885" title="1885"><span class="st">        </span><span class="kw">scale_fill_viridis_c</span>()</a>
<a class="sourceLine" id="cb753-1886" title="1886"><span class="kw">library</span>(tmap)</a>
<a class="sourceLine" id="cb753-1887" title="1887"><span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1888" title="1888"><span class="st">    </span><span class="kw">read_sf</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1889" title="1889"><span class="st">    </span><span class="kw">st_transform</span>(<span class="st">&#39;EPSG:32119&#39;</span>) -&gt;<span class="st"> </span>nc<span class="fl">.32119</span></a>
<a class="sourceLine" id="cb753-1890" title="1890"><span class="kw">tm_shape</span>(nc<span class="fl">.32119</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_polygons</span>(<span class="kw">c</span>(<span class="st">&quot;SID74&quot;</span>, <span class="st">&quot;SID79&quot;</span>))</a>
<a class="sourceLine" id="cb753-1891" title="1891">nc<span class="fl">.32119</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID74, SID79) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-1892" title="1892"><span class="st">    </span><span class="kw">pivot_longer</span>(<span class="kw">starts_with</span>(<span class="st">&quot;SID&quot;</span>), <span class="dt">values_to =</span> <span class="st">&quot;SID&quot;</span>) -&gt;<span class="st"> </span>nc_longer</a>
<a class="sourceLine" id="cb753-1893" title="1893"><span class="kw">tm_shape</span>(nc_longer) <span class="op">+</span><span class="st"> </span><span class="kw">tm_polygons</span>(<span class="st">&quot;SID&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">by =</span> <span class="st">&quot;name&quot;</span>)</a>
<a class="sourceLine" id="cb753-1894" title="1894">nc<span class="fl">.32119</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID74, SID79) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-1895" title="1895"><span class="st">    </span><span class="kw">pivot_longer</span>(<span class="kw">starts_with</span>(<span class="st">&quot;SID&quot;</span>), <span class="dt">values_to =</span> <span class="st">&quot;SID&quot;</span>) -&gt;<span class="st"> </span>nc_longer</a>
<a class="sourceLine" id="cb753-1896" title="1896"><span class="kw">tm_shape</span>(nc_longer) <span class="op">+</span><span class="st"> </span><span class="kw">tm_polygons</span>(<span class="st">&quot;SID&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">by =</span> <span class="st">&quot;name&quot;</span>)</a>
<a class="sourceLine" id="cb753-1897" title="1897"><span class="kw">tm_shape</span>(r) <span class="op">+</span><span class="st"> </span><span class="kw">tm_raster</span>()</a>
<a class="sourceLine" id="cb753-1898" title="1898"><span class="kw">tm_shape</span>(r) <span class="op">+</span><span class="st"> </span><span class="kw">tm_raster</span>()</a>
<a class="sourceLine" id="cb753-1899" title="1899"><span class="kw">tmap_mode</span>(<span class="st">&quot;view&quot;</span>)</a>
<a class="sourceLine" id="cb753-1900" title="1900"><span class="kw">tmap_mode</span>(<span class="st">&quot;plot&quot;</span>)</a>
<a class="sourceLine" id="cb753-1901" title="1901"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-1902" title="1902"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1903" title="1903"></a>
<a class="sourceLine" id="cb753-1904" title="1904">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-1905" title="1905">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-1906" title="1906">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-1907" title="1907">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-1908" title="1908"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-1909" title="1909">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-1910" title="1910"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-1911" title="1911"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-1912" title="1912"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-1913" title="1913">)</a>
<a class="sourceLine" id="cb753-1914" title="1914"></a>
<a class="sourceLine" id="cb753-1915" title="1915"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-1916" title="1916"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-1917" title="1917">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-1918" title="1918"></a>
<a class="sourceLine" id="cb753-1919" title="1919"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-1920" title="1920"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-1921" title="1921"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-1922" title="1922">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-1923" title="1923">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-1924" title="1924"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-1925" title="1925"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1926" title="1926"></a>
<a class="sourceLine" id="cb753-1927" title="1927">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-1928" title="1928">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-1929" title="1929">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-1930" title="1930">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-1931" title="1931"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-1932" title="1932">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-1933" title="1933"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-1934" title="1934"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-1935" title="1935"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-1936" title="1936">)</a>
<a class="sourceLine" id="cb753-1937" title="1937"></a>
<a class="sourceLine" id="cb753-1938" title="1938"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-1939" title="1939"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-1940" title="1940">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-1941" title="1941"></a>
<a class="sourceLine" id="cb753-1942" title="1942"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-1943" title="1943"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-1944" title="1944"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-1945" title="1945">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-1946" title="1946">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-1947" title="1947"><span class="kw">set.seed</span>(<span class="dv">13531</span>)</a>
<a class="sourceLine" id="cb753-1948" title="1948"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-1949" title="1949">n =<span class="st"> </span><span class="dv">30</span></a>
<a class="sourceLine" id="cb753-1950" title="1950">xy =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">runif</span>(n), <span class="dt">y =</span> <span class="kw">runif</span>(n)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>))</a>
<a class="sourceLine" id="cb753-1951" title="1951">w1 =<span class="st"> </span><span class="kw">st_bbox</span>(<span class="kw">c</span>(<span class="dt">xmin =</span> <span class="dv">0</span>, <span class="dt">ymin =</span> <span class="dv">0</span>, <span class="dt">xmax =</span> <span class="dv">1</span>, <span class="dt">ymax =</span> <span class="dv">1</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1952" title="1952"><span class="st">        </span><span class="kw">st_as_sfc</span>() </a>
<a class="sourceLine" id="cb753-1953" title="1953">w2 =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_point</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">0.5</span>))) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_buffer</span>(<span class="fl">1.2</span>)</a>
<a class="sourceLine" id="cb753-1954" title="1954"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="fl">2.1</span>, <span class="fl">2.1</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>), <span class="dt">xaxs =</span> <span class="st">&quot;i&quot;</span>, <span class="dt">yaxs =</span> <span class="st">&quot;i&quot;</span>)</a>
<a class="sourceLine" id="cb753-1955" title="1955"><span class="kw">plot</span>(w1, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-1956" title="1956"><span class="kw">plot</span>(xy, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1957" title="1957"><span class="kw">plot</span>(w2, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-1958" title="1958"><span class="kw">plot</span>(xy, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">cex =</span> <span class="fl">.5</span>)</a>
<a class="sourceLine" id="cb753-1959" title="1959"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(spatstat))</a>
<a class="sourceLine" id="cb753-1960" title="1960"><span class="kw">as.ppp</span>(xy)</a>
<a class="sourceLine" id="cb753-1961" title="1961">(<span class="dt">pp1 =</span> <span class="kw">c</span>(w1, <span class="kw">st_geometry</span>(xy)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.ppp</span>())</a>
<a class="sourceLine" id="cb753-1962" title="1962">c1 =<span class="st"> </span><span class="kw">st_buffer</span>(<span class="kw">st_centroid</span>(w2), <span class="fl">1.2</span>)</a>
<a class="sourceLine" id="cb753-1963" title="1963">(<span class="dt">pp2 =</span> <span class="kw">c</span>(c1, <span class="kw">st_geometry</span>(xy)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.ppp</span>())</a>
<a class="sourceLine" id="cb753-1964" title="1964"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb753-1965" title="1965">q1 =<span class="st"> </span><span class="kw">quadratcount</span>(pp1, <span class="dt">nx=</span><span class="dv">3</span>, <span class="dt">ny=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1966" title="1966">q2 =<span class="st"> </span><span class="kw">quadratcount</span>(pp2, <span class="dt">nx=</span><span class="dv">3</span>, <span class="dt">ny=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1967" title="1967"><span class="kw">plot</span>(q1, <span class="dt">main =</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-1968" title="1968"><span class="kw">plot</span>(xy, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1969" title="1969"><span class="kw">plot</span>(q2, <span class="dt">main =</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-1970" title="1970"><span class="kw">plot</span>(xy, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1971" title="1971"><span class="kw">quadrat.test</span>(pp1, <span class="dt">nx=</span><span class="dv">3</span>, <span class="dt">ny=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1972" title="1972"><span class="kw">quadrat.test</span>(pp2, <span class="dt">nx=</span><span class="dv">3</span>, <span class="dt">ny=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-1973" title="1973">den1 &lt;-<span class="st"> </span><span class="kw">density</span>(pp1, <span class="dt">sigma =</span> bw.diggle)</a>
<a class="sourceLine" id="cb753-1974" title="1974">den2 &lt;-<span class="st"> </span><span class="kw">density</span>(pp2, <span class="dt">sigma =</span> bw.diggle)</a>
<a class="sourceLine" id="cb753-1975" title="1975"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">1.1</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-1976" title="1976"><span class="kw">plot</span>(den1)</a>
<a class="sourceLine" id="cb753-1977" title="1977"><span class="kw">plot</span>(pp1, <span class="dt">add=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1978" title="1978"><span class="kw">plot</span>(den2)</a>
<a class="sourceLine" id="cb753-1979" title="1979"><span class="kw">plot</span>(pp1, <span class="dt">add=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-1980" title="1980"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb753-1981" title="1981">s1 =<span class="st"> </span><span class="kw">st_as_stars</span>(den1)</a>
<a class="sourceLine" id="cb753-1982" title="1982">(<span class="dt">s2 =</span> <span class="kw">st_as_stars</span>(den2))</a>
<a class="sourceLine" id="cb753-1983" title="1983"><span class="kw">sum</span>(s1[[<span class="dv">1</span>]], <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)<span class="op">*</span><span class="kw">st_dimensions</span>(s1)<span class="op">$</span>x<span class="op">$</span>delta<span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb753-1984" title="1984"><span class="kw">sum</span>(s2[[<span class="dv">1</span>]], <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)<span class="op">*</span><span class="kw">st_dimensions</span>(s2)<span class="op">$</span>x<span class="op">$</span>delta<span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb753-1985" title="1985">pt =<span class="st"> </span><span class="kw">st_sfc</span>(<span class="kw">st_point</span>(<span class="kw">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>)))</a>
<a class="sourceLine" id="cb753-1986" title="1986">s2<span class="op">$</span>dist =<span class="st"> </span><span class="kw">st_distance</span>(<span class="kw">st_as_sf</span>(s2, <span class="dt">as_points =</span> <span class="ot">TRUE</span>, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>), pt)</a>
<a class="sourceLine" id="cb753-1987" title="1987">(<span class="dt">m =</span> <span class="kw">ppm</span>(pp2 <span class="op">~</span><span class="st"> </span>dist, <span class="dt">data =</span> <span class="kw">list</span>(<span class="dt">dist =</span> <span class="kw">as.im</span>(s2[<span class="st">&quot;dist&quot;</span>]))))</a>
<a class="sourceLine" id="cb753-1988" title="1988"><span class="kw">plot</span>(m, <span class="dt">se =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-1989" title="1989"><span class="kw">predict</span>(m, <span class="dt">covariates =</span> <span class="kw">list</span>(<span class="dt">dist =</span> <span class="kw">as.im</span>(s2[<span class="st">&quot;dist&quot;</span>]))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1990" title="1990"><span class="st">    </span><span class="kw">st_as_stars</span>()</a>
<a class="sourceLine" id="cb753-1991" title="1991"><span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-1992" title="1992"><span class="st">    </span><span class="kw">read_sf</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1993" title="1993"><span class="st">    </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1994" title="1994"><span class="st">    </span><span class="kw">st_centroid</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-1995" title="1995"><span class="st">    </span><span class="kw">as.ppp</span>()</a>
<a class="sourceLine" id="cb753-1996" title="1996">longleaf</a>
<a class="sourceLine" id="cb753-1997" title="1997">ll =<span class="st"> </span><span class="kw">st_as_sf</span>(longleaf)</a>
<a class="sourceLine" id="cb753-1998" title="1998"><span class="kw">print</span>(ll, <span class="dt">n =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb753-1999" title="1999"><span class="kw">as.ppp</span>(ll)</a>
<a class="sourceLine" id="cb753-2000" title="2000"><span class="kw">print</span>(<span class="kw">st_as_sf</span>(copper<span class="op">$</span>SouthLines), <span class="dt">n =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb753-2001" title="2001"><span class="kw">print</span>(<span class="kw">st_as_sf</span>(chicago), <span class="dt">n =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb753-2002" title="2002"><span class="kw">table</span>(<span class="kw">st_as_sf</span>(chicago)<span class="op">$</span>label)</a>
<a class="sourceLine" id="cb753-2003" title="2003">kappa =<span class="st"> </span><span class="dv">30</span> <span class="op">/</span><span class="st"> </span><span class="kw">st_area</span>(w2) <span class="co"># intensity</span></a>
<a class="sourceLine" id="cb753-2004" title="2004">th =<span class="st"> </span><span class="kw">st_sample</span>(w2, <span class="dt">kappa =</span> kappa, <span class="dt">mu =</span> <span class="dv">3</span>, <span class="dt">scale =</span> <span class="fl">0.05</span>, <span class="dt">type =</span> <span class="st">&quot;Thomas&quot;</span>)</a>
<a class="sourceLine" id="cb753-2005" title="2005"><span class="kw">nrow</span>(th)</a>
<a class="sourceLine" id="cb753-2006" title="2006"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb753-2007" title="2007"><span class="kw">plot</span>(w2)</a>
<a class="sourceLine" id="cb753-2008" title="2008"><span class="kw">plot</span>(th, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-2009" title="2009"><span class="co"># example from plotting chapter:</span></a>
<a class="sourceLine" id="cb753-2010" title="2010"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb753-2011" title="2011"><span class="kw">library</span>(s2)</a>
<a class="sourceLine" id="cb753-2012" title="2012">g =<span class="st"> </span><span class="kw">as_s2_geography</span>(<span class="ot">TRUE</span>) <span class="co"># Earth</span></a>
<a class="sourceLine" id="cb753-2013" title="2013">co =<span class="st"> </span><span class="kw">s2_data_countries</span>()</a>
<a class="sourceLine" id="cb753-2014" title="2014">oc =<span class="st"> </span><span class="kw">s2_difference</span>(g, <span class="kw">s2_union_agg</span>(co)) <span class="co"># oceans</span></a>
<a class="sourceLine" id="cb753-2015" title="2015">b =<span class="st"> </span><span class="kw">s2_buffer_cells</span>(<span class="kw">as_s2_geography</span>(<span class="st">&quot;POINT(-30 -10)&quot;</span>), <span class="dv">9800000</span>) <span class="co"># visible half</span></a>
<a class="sourceLine" id="cb753-2016" title="2016">i =<span class="st"> </span><span class="kw">s2_intersection</span>(b, oc) <span class="co"># visible ocean</span></a>
<a class="sourceLine" id="cb753-2017" title="2017">co =<span class="st"> </span><span class="kw">s2_intersection</span>(b, co)</a>
<a class="sourceLine" id="cb753-2018" title="2018"><span class="kw">plot</span>(<span class="kw">st_transform</span>(<span class="kw">st_as_sfc</span>(i), <span class="st">&quot;+proj=ortho +lat_0=-10 +lon_0=-30&quot;</span>), </a>
<a class="sourceLine" id="cb753-2019" title="2019">     <span class="dt">col =</span> <span class="st">&#39;lightblue&#39;</span>)</a>
<a class="sourceLine" id="cb753-2020" title="2020"><span class="kw">plot</span>(<span class="kw">st_transform</span>(<span class="kw">st_as_sfc</span>(co), <span class="st">&quot;+proj=ortho +lat_0=-10 +lon_0=-30&quot;</span>), </a>
<a class="sourceLine" id="cb753-2021" title="2021">     <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="st">&#39;grey&#39;</span>)</a>
<a class="sourceLine" id="cb753-2022" title="2022"><span class="co"># sampling from globe:</span></a>
<a class="sourceLine" id="cb753-2023" title="2023"><span class="co">#sf_use_s2(FALSE)</span></a>
<a class="sourceLine" id="cb753-2024" title="2024"><span class="kw">assign</span>(<span class="st">&quot;.sf.use_s2&quot;</span>, <span class="ot">FALSE</span>, <span class="dt">envir=</span>sf<span class="op">:::</span>.sf_cache) <span class="co"># cheat!</span></a>
<a class="sourceLine" id="cb753-2025" title="2025">pts =<span class="st"> </span><span class="kw">suppressMessages</span>( <span class="co"># cheat!</span></a>
<a class="sourceLine" id="cb753-2026" title="2026">   <span class="kw">st_sample</span>(<span class="kw">st_as_sfc</span>(<span class="kw">st_bbox</span>(<span class="kw">st_as_stars</span>())), <span class="dv">1000</span>, <span class="dt">exact =</span> <span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb753-2027" title="2027"><span class="co">#sf_use_s2(TRUE)</span></a>
<a class="sourceLine" id="cb753-2028" title="2028"><span class="kw">assign</span>(<span class="st">&quot;.sf.use_s2&quot;</span>, <span class="ot">TRUE</span>, <span class="dt">envir =</span> sf<span class="op">:::</span>.sf_cache) <span class="co"># cheat!</span></a>
<a class="sourceLine" id="cb753-2029" title="2029">pts =<span class="st"> </span><span class="kw">s2_intersection</span>(i, pts) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_as_sfc</span>()</a>
<a class="sourceLine" id="cb753-2030" title="2030"><span class="kw">plot</span>(<span class="kw">st_transform</span>(pts, <span class="st">&quot;+proj=ortho +lat_0=-10 +lon_0=-30&quot;</span>), </a>
<a class="sourceLine" id="cb753-2031" title="2031">     <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">pch =</span> <span class="dv">3</span>, <span class="dt">cex =</span> <span class="fl">.7</span>)</a>
<a class="sourceLine" id="cb753-2032" title="2032"><span class="co"># we need to detach, to avoid name clashes of using idw() and diagnose() later on</span></a>
<a class="sourceLine" id="cb753-2033" title="2033"><span class="kw">library</span>(spatstat)</a>
<a class="sourceLine" id="cb753-2034" title="2034">w =<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">which</span>(x <span class="op">==</span><span class="st"> </span><span class="kw">search</span>())</a>
<a class="sourceLine" id="cb753-2035" title="2035"><span class="kw">detach</span>(<span class="dt">pos =</span> <span class="kw">w</span>(<span class="st">&quot;package:spatstat&quot;</span>))</a>
<a class="sourceLine" id="cb753-2036" title="2036"><span class="kw">detach</span>(<span class="dt">pos =</span> <span class="kw">w</span>(<span class="st">&quot;package:spatstat.linnet&quot;</span>))</a>
<a class="sourceLine" id="cb753-2037" title="2037"><span class="kw">detach</span>(<span class="dt">pos =</span> <span class="kw">w</span>(<span class="st">&quot;package:spatstat.core&quot;</span>))</a>
<a class="sourceLine" id="cb753-2038" title="2038"><span class="kw">detach</span>(<span class="dt">pos =</span> <span class="kw">w</span>(<span class="st">&quot;package:spatstat.geom&quot;</span>))</a>
<a class="sourceLine" id="cb753-2039" title="2039"><span class="kw">detach</span>(<span class="dt">pos =</span> <span class="kw">w</span>(<span class="st">&quot;package:spatstat.data&quot;</span>))</a>
<a class="sourceLine" id="cb753-2040" title="2040"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-2041" title="2041"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-2042" title="2042"></a>
<a class="sourceLine" id="cb753-2043" title="2043">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-2044" title="2044">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-2045" title="2045">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-2046" title="2046">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-2047" title="2047"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-2048" title="2048">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-2049" title="2049"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-2050" title="2050"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-2051" title="2051"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-2052" title="2052">)</a>
<a class="sourceLine" id="cb753-2053" title="2053"></a>
<a class="sourceLine" id="cb753-2054" title="2054"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-2055" title="2055"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-2056" title="2056">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2057" title="2057"></a>
<a class="sourceLine" id="cb753-2058" title="2058"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-2059" title="2059"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-2060" title="2060"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-2061" title="2061">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-2062" title="2062">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-2063" title="2063"><span class="co"># after running the &quot;Spatiotemporal Geostatistics&quot; chapter, write NO2 means by</span></a>
<a class="sourceLine" id="cb753-2064" title="2064"><span class="kw">write_csv</span>(<span class="kw">right_join</span>(a2, tb), <span class="st">&quot;no2.csv&quot;</span>)</a>
<a class="sourceLine" id="cb753-2065" title="2065"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb753-2066" title="2066">no2 =<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">system.file</span>(<span class="st">&quot;external/no2.csv&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;gstat&quot;</span>))</a>
<a class="sourceLine" id="cb753-2067" title="2067"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-2068" title="2068">crs =<span class="st"> </span><span class="kw">st_crs</span>(<span class="st">&quot;EPSG:32632&quot;</span>)</a>
<a class="sourceLine" id="cb753-2069" title="2069">no2.sf =<span class="st"> </span><span class="kw">st_as_sf</span>(no2, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;station_longitude_deg&quot;</span>, <span class="st">&quot;station_latitude_deg&quot;</span>), <span class="dt">crs =</span> <span class="st">&quot;OGC:CRS84&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2070" title="2070"><span class="st">    </span><span class="kw">st_transform</span>(crs)</a>
<a class="sourceLine" id="cb753-2071" title="2071"><span class="kw">data</span>(air, <span class="dt">package =</span> <span class="st">&quot;spacetime&quot;</span>) <span class="co"># this loads German boundaries into DE_NUTS1</span></a>
<a class="sourceLine" id="cb753-2072" title="2072">de &lt;-<span class="st"> </span><span class="kw">st_transform</span>(<span class="kw">st_as_sf</span>(DE_NUTS1), crs)</a>
<a class="sourceLine" id="cb753-2073" title="2073"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> de) <span class="op">+</span><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">col =</span> NO2))</a>
<a class="sourceLine" id="cb753-2074" title="2074"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb753-2075" title="2075"><span class="kw">st_bbox</span>(de) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2076" title="2076"><span class="st">  </span><span class="kw">st_as_stars</span>(<span class="dt">dx =</span> <span class="dv">10000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2077" title="2077"><span class="st">  </span><span class="kw">st_crop</span>(de) -&gt;<span class="st"> </span>grd</a>
<a class="sourceLine" id="cb753-2078" title="2078">grd</a>
<a class="sourceLine" id="cb753-2079" title="2079"><span class="kw">library</span>(gstat)</a>
<a class="sourceLine" id="cb753-2080" title="2080">i =<span class="st"> </span><span class="kw">idw</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, grd)</a>
<a class="sourceLine" id="cb753-2081" title="2081"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> i, <span class="kw">aes</span>(<span class="dt">fill =</span> var1.pred, <span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2082" title="2082"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_cast</span>(de, <span class="st">&quot;MULTILINESTRING&quot;</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2083" title="2083"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf)</a>
<a class="sourceLine" id="cb753-2084" title="2084">v =<span class="st"> </span><span class="kw">variogram</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf)</a>
<a class="sourceLine" id="cb753-2085" title="2085"><span class="kw">plot</span>(v, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-2086" title="2086"><span class="kw">library</span>(gstat)</a>
<a class="sourceLine" id="cb753-2087" title="2087">v0 =<span class="st"> </span><span class="kw">variogram</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, <span class="dt">cutoff =</span> <span class="dv">100000</span>, <span class="dt">width =</span> <span class="dv">10000</span>)</a>
<a class="sourceLine" id="cb753-2088" title="2088"><span class="kw">plot</span>(v0, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-2089" title="2089">v.m =<span class="st"> </span><span class="kw">fit.variogram</span>(v, <span class="kw">vgm</span>(<span class="dv">1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">50000</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb753-2090" title="2090"><span class="kw">plot</span>(v, v.m, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-2091" title="2091">k =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, grd, v.m)</a>
<a class="sourceLine" id="cb753-2092" title="2092"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> k, <span class="kw">aes</span>(<span class="dt">fill =</span> var1.pred, <span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2093" title="2093"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_cast</span>(de, <span class="st">&quot;MULTILINESTRING&quot;</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2094" title="2094"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-2095" title="2095"><span class="st">    </span><span class="kw">coord_sf</span>(<span class="dt">lims_method =</span> <span class="st">&quot;geometry_bbox&quot;</span>)</a>
<a class="sourceLine" id="cb753-2096" title="2096">a =<span class="st"> </span><span class="kw">aggregate</span>(no2.sf[<span class="st">&quot;NO2&quot;</span>], <span class="dt">by =</span> de, <span class="dt">FUN =</span> mean)</a>
<a class="sourceLine" id="cb753-2097" title="2097">b =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, de, v.m)</a>
<a class="sourceLine" id="cb753-2098" title="2098">b<span class="op">$</span>sample =<span class="st"> </span>a<span class="op">$</span>NO2</a>
<a class="sourceLine" id="cb753-2099" title="2099">b<span class="op">$</span>kriging =<span class="st"> </span>b<span class="op">$</span>var1.pred</a>
<a class="sourceLine" id="cb753-2100" title="2100">b <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(sample, kriging) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2101" title="2101"><span class="st">        </span><span class="kw">pivot_longer</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">names_to =</span> <span class="st">&quot;var&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;NO2&quot;</span>) -&gt;<span class="st"> </span>b2</a>
<a class="sourceLine" id="cb753-2102" title="2102">b2<span class="op">$</span>var =<span class="st"> </span><span class="kw">factor</span>(b2<span class="op">$</span>var, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;sample&quot;</span>, <span class="st">&quot;kriging&quot;</span>))</a>
<a class="sourceLine" id="cb753-2103" title="2103"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> b2, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">fill =</span> NO2)) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>var) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-2104" title="2104"><span class="st">     </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors =</span> <span class="kw">sf.colors</span>(<span class="dv">20</span>))</a>
<a class="sourceLine" id="cb753-2105" title="2105">SE =<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">sqrt</span>(<span class="kw">var</span>(x)<span class="op">/</span><span class="kw">length</span>(x))</a>
<a class="sourceLine" id="cb753-2106" title="2106">a =<span class="st"> </span><span class="kw">aggregate</span>(no2.sf[<span class="st">&quot;NO2&quot;</span>], de, SE)</a>
<a class="sourceLine" id="cb753-2107" title="2107">b<span class="op">$</span>sample =<span class="st"> </span>a<span class="op">$</span>NO2</a>
<a class="sourceLine" id="cb753-2108" title="2108">b<span class="op">$</span>kriging =<span class="st"> </span><span class="kw">sqrt</span>(b<span class="op">$</span>var1.var)</a>
<a class="sourceLine" id="cb753-2109" title="2109">b <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(sample, kriging) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2110" title="2110"><span class="st">        </span><span class="kw">pivot_longer</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">names_to =</span> <span class="st">&quot;var&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;Standard_error&quot;</span>) -&gt;<span class="st"> </span>b2</a>
<a class="sourceLine" id="cb753-2111" title="2111">b2<span class="op">$</span>var =<span class="st"> </span><span class="kw">factor</span>(b2<span class="op">$</span>var, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;sample&quot;</span>, <span class="st">&quot;kriging&quot;</span>))</a>
<a class="sourceLine" id="cb753-2112" title="2112"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> b2, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">fill =</span> Standard_error)) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>var, <span class="dt">as.table =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-2113" title="2113"><span class="st">     </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors =</span> <span class="kw">sf.colors</span>(<span class="dv">20</span>))</a>
<a class="sourceLine" id="cb753-2114" title="2114">s =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, grd, v.m, <span class="dt">nmax =</span> <span class="dv">30</span>, <span class="dt">nsim =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-2115" title="2115"><span class="kw">library</span>(viridis)</a>
<a class="sourceLine" id="cb753-2116" title="2116">g =<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">coord_equal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb753-2117" title="2117"><span class="st">    </span><span class="kw">scale_fill_viridis</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb753-2118" title="2118"><span class="st">    </span><span class="kw">theme_void</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb753-2119" title="2119"><span class="st">    </span><span class="kw">scale_x_discrete</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-2120" title="2120"><span class="st">    </span><span class="kw">scale_y_discrete</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb753-2121" title="2121">g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> s[,,,<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>]) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>sample)</a>
<a class="sourceLine" id="cb753-2122" title="2122">v =<span class="st"> </span>vroom<span class="op">::</span><span class="kw">vroom</span>(<span class="st">&quot;aq/pop/Zensus_Bevoelkerung_100m-Gitter.csv&quot;</span>)</a>
<a class="sourceLine" id="cb753-2123" title="2123">v <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Einwohner <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2124" title="2124"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>Gitter_ID_100m) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2125" title="2125"><span class="st">    </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;x_mp_100m&quot;</span>, <span class="st">&quot;y_mp_100m&quot;</span>), <span class="dt">crs =</span> <span class="dv">3035</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2126" title="2126"><span class="st">    </span><span class="kw">st_transform</span>(<span class="kw">st_crs</span>(grd)) -&gt;<span class="st"> </span>b</a>
<a class="sourceLine" id="cb753-2127" title="2127">a =<span class="st"> </span><span class="kw">aggregate</span>(b, <span class="kw">st_as_sf</span>(grd, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>), sum)</a>
<a class="sourceLine" id="cb753-2128" title="2128">v =<span class="st"> </span>vroom<span class="op">::</span><span class="kw">vroom</span>(<span class="st">&quot;aq/pop/Zensus_Bevoelkerung_100m-Gitter.csv&quot;</span>)</a>
<a class="sourceLine" id="cb753-2129" title="2129">v1 &lt;-<span class="st"> </span>v[v<span class="op">$</span>Einwohner <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb753-2130" title="2130"><span class="kw">rm</span>(v); <span class="kw">gc</span>(<span class="dt">full=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-2131" title="2131">v2 &lt;-<span class="st"> </span><span class="kw">st_as_sf</span>(v1, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;x_mp_100m&quot;</span>, <span class="st">&quot;y_mp_100m&quot;</span>), <span class="dt">crs =</span> <span class="dv">3035</span>)</a>
<a class="sourceLine" id="cb753-2132" title="2132"><span class="kw">rm</span>(v1); <span class="kw">gc</span>()</a>
<a class="sourceLine" id="cb753-2133" title="2133">b &lt;-<span class="st"> </span><span class="kw">st_transform</span>(v2, <span class="kw">st_crs</span>(grd))</a>
<a class="sourceLine" id="cb753-2134" title="2134"><span class="kw">rm</span>(v2); <span class="kw">gc</span>()</a>
<a class="sourceLine" id="cb753-2135" title="2135">a =<span class="st"> </span><span class="kw">aggregate</span>(b, <span class="kw">st_as_sf</span>(grd, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>), sum)</a>
<a class="sourceLine" id="cb753-2136" title="2136"><span class="kw">gc</span>()</a>
<a class="sourceLine" id="cb753-2137" title="2137">grd<span class="op">$</span>ID =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">prod</span>(<span class="kw">dim</span>(grd)) <span class="co"># so we can find out later which grid cell we have</span></a>
<a class="sourceLine" id="cb753-2138" title="2138">ii =<span class="st"> </span><span class="kw">st_intersects</span>(grd[<span class="st">&quot;ID&quot;</span>], <span class="kw">st_cast</span>(<span class="kw">st_union</span>(de), <span class="st">&quot;MULTILINESTRING&quot;</span>))</a>
<a class="sourceLine" id="cb753-2139" title="2139">grd_sf =<span class="st"> </span><span class="kw">st_as_sf</span>(grd[<span class="st">&quot;ID&quot;</span>], <span class="dt">na.rm =</span> <span class="ot">FALSE</span>)[<span class="kw">lengths</span>(ii) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>,]</a>
<a class="sourceLine" id="cb753-2140" title="2140">iii =<span class="st"> </span><span class="kw">st_intersection</span>(grd_sf, <span class="kw">st_union</span>(de))</a>
<a class="sourceLine" id="cb753-2141" title="2141">grd<span class="op">$</span>area =<span class="st"> </span><span class="kw">st_area</span>(grd)[[<span class="dv">1</span>]] <span class="op">+</span><span class="st"> </span>units<span class="op">::</span><span class="kw">set_units</span>(grd<span class="op">$</span>values, m<span class="op">^</span><span class="dv">2</span>) <span class="co"># NA&#39;s</span></a>
<a class="sourceLine" id="cb753-2142" title="2142">grd<span class="op">$</span>area[iii<span class="op">$</span>ID] =<span class="st"> </span><span class="kw">st_area</span>(iii)</a>
<a class="sourceLine" id="cb753-2143" title="2143">grd<span class="op">$</span>pop_dens =<span class="st"> </span>a<span class="op">$</span>Einwohner <span class="op">/</span><span class="st"> </span>grd<span class="op">$</span>area</a>
<a class="sourceLine" id="cb753-2144" title="2144"><span class="kw">sum</span>(grd<span class="op">$</span>pop_dens <span class="op">*</span><span class="st"> </span>grd<span class="op">$</span>area, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># verify</span></a>
<a class="sourceLine" id="cb753-2145" title="2145"><span class="kw">sum</span>(b<span class="op">$</span>Einwohner)</a>
<a class="sourceLine" id="cb753-2146" title="2146">g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> grd, <span class="kw">aes</span>(<span class="dt">fill =</span> <span class="kw">sqrt</span>(pop_dens), <span class="dt">x =</span> x, <span class="dt">y =</span> y))</a>
<a class="sourceLine" id="cb753-2147" title="2147">(<span class="dt">a =</span> <span class="kw">aggregate</span>(grd[<span class="st">&quot;pop_dens&quot;</span>], no2.sf, mean))</a>
<a class="sourceLine" id="cb753-2148" title="2148">no2.sf<span class="op">$</span>pop_dens =<span class="st"> </span><span class="kw">st_as_sf</span>(a)[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb753-2149" title="2149"><span class="kw">summary</span>(<span class="kw">lm</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf))</a>
<a class="sourceLine" id="cb753-2150" title="2150"><span class="kw">plot</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf)</a>
<a class="sourceLine" id="cb753-2151" title="2151"><span class="kw">abline</span>(<span class="kw">lm</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf))</a>
<a class="sourceLine" id="cb753-2152" title="2152">no2.sf =<span class="st"> </span>no2.sf[<span class="op">!</span><span class="kw">is.na</span>(no2.sf<span class="op">$</span>pop_dens),]</a>
<a class="sourceLine" id="cb753-2153" title="2153">vr =<span class="st"> </span><span class="kw">variogram</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf)</a>
<a class="sourceLine" id="cb753-2154" title="2154">vr.m =<span class="st"> </span><span class="kw">fit.variogram</span>(vr, <span class="kw">vgm</span>(<span class="dv">1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">50000</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb753-2155" title="2155"><span class="kw">plot</span>(vr, vr.m, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-2156" title="2156">kr =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf, grd[<span class="st">&quot;pop_dens&quot;</span>], vr.m)</a>
<a class="sourceLine" id="cb753-2157" title="2157">k<span class="op">$</span>kr1 =<span class="st"> </span>k<span class="op">$</span>var1.pred</a>
<a class="sourceLine" id="cb753-2158" title="2158">k<span class="op">$</span>kr2 =<span class="st"> </span>kr<span class="op">$</span>var1.pred</a>
<a class="sourceLine" id="cb753-2159" title="2159"><span class="kw">st_redimension</span>(k[<span class="kw">c</span>(<span class="st">&quot;kr1&quot;</span>, <span class="st">&quot;kr2&quot;</span>)], </a>
<a class="sourceLine" id="cb753-2160" title="2160">    <span class="dt">along =</span> <span class="kw">list</span>(<span class="dt">what =</span> <span class="kw">c</span>(<span class="st">&quot;kriging&quot;</span>, <span class="st">&quot;residual kriging&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2161" title="2161"><span class="st">    </span><span class="kw">setNames</span>(<span class="st">&quot;NO2&quot;</span>) -&gt;<span class="st"> </span>km</a>
<a class="sourceLine" id="cb753-2162" title="2162">g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> km, <span class="kw">aes</span>(<span class="dt">fill =</span> NO2, <span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2163" title="2163"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_cast</span>(de, <span class="st">&quot;MULTILINESTRING&quot;</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2164" title="2164"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>what) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-2165" title="2165"><span class="st">    </span><span class="kw">coord_sf</span>(<span class="dt">lims_method =</span> <span class="st">&quot;geometry_bbox&quot;</span>)</a>
<a class="sourceLine" id="cb753-2166" title="2166"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-2167" title="2167"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-2168" title="2168"></a>
<a class="sourceLine" id="cb753-2169" title="2169">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-2170" title="2170">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-2171" title="2171">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-2172" title="2172">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-2173" title="2173"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-2174" title="2174">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-2175" title="2175"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-2176" title="2176"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-2177" title="2177"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-2178" title="2178">)</a>
<a class="sourceLine" id="cb753-2179" title="2179"></a>
<a class="sourceLine" id="cb753-2180" title="2180"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-2181" title="2181"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-2182" title="2182">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2183" title="2183"></a>
<a class="sourceLine" id="cb753-2184" title="2184"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-2185" title="2185"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-2186" title="2186"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-2187" title="2187">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-2188" title="2188">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-2189" title="2189"><span class="co"># try(load(&quot;data/ch16.rda&quot;))</span></a>
<a class="sourceLine" id="cb753-2190" title="2190"><span class="kw">set.seed</span>(<span class="dv">123</span>)</a>
<a class="sourceLine" id="cb753-2191" title="2191">files =<span class="st"> </span><span class="kw">list.files</span>(<span class="st">&quot;aq&quot;</span>, <span class="dt">pattern =</span> <span class="st">&quot;*.csv&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-2192" title="2192">r =<span class="st"> </span><span class="kw">lapply</span>(files[<span class="op">-</span><span class="dv">1</span>], <span class="cf">function</span>(f) <span class="kw">read.csv</span>(f))</a>
<a class="sourceLine" id="cb753-2193" title="2193"><span class="kw">Sys.setenv</span>(<span class="dt">TZ =</span> <span class="st">&quot;UTC&quot;</span>) <span class="co"># make sure times are not interpreted in local time zone</span></a>
<a class="sourceLine" id="cb753-2194" title="2194">r =<span class="st"> </span><span class="kw">lapply</span>(r, <span class="cf">function</span>(f) {</a>
<a class="sourceLine" id="cb753-2195" title="2195">        f<span class="op">$</span>t =<span class="st"> </span><span class="kw">as.POSIXct</span>(f<span class="op">$</span>DatetimeBegin) </a>
<a class="sourceLine" id="cb753-2196" title="2196">        f[<span class="kw">order</span>(f<span class="op">$</span>t), ] </a>
<a class="sourceLine" id="cb753-2197" title="2197">    }</a>
<a class="sourceLine" id="cb753-2198" title="2198">)</a>
<a class="sourceLine" id="cb753-2199" title="2199">r =<span class="st"> </span>r[<span class="kw">sapply</span>(r, nrow) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1000</span>]</a>
<a class="sourceLine" id="cb753-2200" title="2200"><span class="kw">names</span>(r) =<span class="st">  </span><span class="kw">sapply</span>(r, <span class="cf">function</span>(f) <span class="kw">unique</span>(f<span class="op">$</span>AirQualityStationEoICode))</a>
<a class="sourceLine" id="cb753-2201" title="2201"><span class="kw">length</span>(r) <span class="op">==</span><span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(<span class="kw">names</span>(r)))</a>
<a class="sourceLine" id="cb753-2202" title="2202"><span class="kw">library</span>(xts)</a>
<a class="sourceLine" id="cb753-2203" title="2203">r =<span class="st"> </span><span class="kw">lapply</span>(r, <span class="cf">function</span>(f) <span class="kw">xts</span>(f<span class="op">$</span>Concentration, f<span class="op">$</span>t))</a>
<a class="sourceLine" id="cb753-2204" title="2204">aq =<span class="st"> </span><span class="kw">do.call</span>(cbind, r)</a>
<a class="sourceLine" id="cb753-2205" title="2205">sel =<span class="st"> </span><span class="kw">apply</span>(aq, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="kw">mean</span>(<span class="kw">is.na</span>(x)) <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.25</span>)</a>
<a class="sourceLine" id="cb753-2206" title="2206">aqsel =<span class="st"> </span>aq[, sel]</a>
<a class="sourceLine" id="cb753-2207" title="2207"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb753-2208" title="2208"><span class="kw">read.csv</span>(<span class="st">&quot;aq/AirBase_v8_stations.csv&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2209" title="2209"><span class="st">    </span><span class="kw">as_tibble</span>()  <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2210" title="2210"><span class="st">    </span><span class="kw">filter</span>(country_iso_code <span class="op">==</span><span class="st"> &quot;DE&quot;</span>, station_type_of_area <span class="op">==</span><span class="st"> &quot;rural&quot;</span>, </a>
<a class="sourceLine" id="cb753-2211" title="2211">                 type_of_station <span class="op">==</span><span class="st"> &quot;Background&quot;</span>) -&gt;<span class="st"> </span>a2</a>
<a class="sourceLine" id="cb753-2212" title="2212"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-2213" title="2213">a2.sf =<span class="st"> </span><span class="kw">st_as_sf</span>(a2, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;station_longitude_deg&quot;</span>, <span class="st">&quot;station_latitude_deg&quot;</span>), <span class="dt">crs =</span> <span class="st">&#39;EPSG:4326&#39;</span>)</a>
<a class="sourceLine" id="cb753-2214" title="2214">sel =<span class="st">  </span><span class="kw">colnames</span>(aqsel) <span class="op">%in%</span><span class="st"> </span>a2<span class="op">$</span>station_european_code</a>
<a class="sourceLine" id="cb753-2215" title="2215">aqsel =<span class="st"> </span>aqsel[, sel]</a>
<a class="sourceLine" id="cb753-2216" title="2216">tb =<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">NO2 =</span> <span class="kw">apply</span>(aqsel, <span class="dv">2</span>, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">station_european_code =</span> <span class="kw">colnames</span>(aqsel))</a>
<a class="sourceLine" id="cb753-2217" title="2217">crs =<span class="st"> &quot;EPSG:32632&quot;</span></a>
<a class="sourceLine" id="cb753-2218" title="2218"><span class="kw">right_join</span>(a2.sf, tb) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(crs) -&gt;<span class="st"> </span>no2.sf </a>
<a class="sourceLine" id="cb753-2219" title="2219"><span class="co"># load German boundaries</span></a>
<a class="sourceLine" id="cb753-2220" title="2220"><span class="kw">data</span>(air, <span class="dt">package =</span> <span class="st">&quot;spacetime&quot;</span>)</a>
<a class="sourceLine" id="cb753-2221" title="2221">de &lt;-<span class="st"> </span><span class="kw">st_transform</span>(<span class="kw">st_as_sf</span>(DE_NUTS1), crs)</a>
<a class="sourceLine" id="cb753-2222" title="2222"><span class="kw">library</span>(gstat)</a>
<a class="sourceLine" id="cb753-2223" title="2223"><span class="kw">demo</span>(cokriging)</a>
<a class="sourceLine" id="cb753-2224" title="2224"><span class="kw">demo</span>(cosimulation)</a>
<a class="sourceLine" id="cb753-2225" title="2225">aqx =<span class="st"> </span>aq[ , <span class="kw">colnames</span>(aq) <span class="op">%in%</span><span class="st"> </span>a2<span class="op">$</span>station_european_code]</a>
<a class="sourceLine" id="cb753-2226" title="2226">sfc =<span class="st"> </span><span class="kw">st_geometry</span>(a2.sf)[<span class="kw">match</span>(<span class="kw">colnames</span>(aqx), a2.sf<span class="op">$</span>station_european_code)]</a>
<a class="sourceLine" id="cb753-2227" title="2227"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb753-2228" title="2228"><span class="kw">st_as_stars</span>(<span class="dt">NO2 =</span> <span class="kw">as.matrix</span>(aqx)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2229" title="2229"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="dt">names =</span> <span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;station&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2230" title="2230"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;time&quot;</span>, <span class="kw">index</span>(aqx)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2231" title="2231"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;station&quot;</span>, sfc) -&gt;<span class="st"> </span>no2.st</a>
<a class="sourceLine" id="cb753-2232" title="2232">v.st =<span class="st"> </span><span class="kw">variogramST</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.st[,<span class="dv">1</span><span class="op">:</span>(<span class="dv">24</span><span class="op">*</span><span class="dv">31</span>)], <span class="dt">tlags =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">48</span>, </a>
<a class="sourceLine" id="cb753-2233" title="2233">    <span class="dt">cores =</span> <span class="kw">getOption</span>(<span class="st">&quot;mc.cores&quot;</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-2234" title="2234">v1 =<span class="st"> </span><span class="kw">plot</span>(v.st)</a>
<a class="sourceLine" id="cb753-2235" title="2235">v2 =<span class="st"> </span><span class="kw">plot</span>(v.st, <span class="dt">map =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2236" title="2236"><span class="kw">print</span>(v1, <span class="dt">split =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="dt">more =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-2237" title="2237"><span class="kw">print</span>(v2, <span class="dt">split =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="dt">more =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2238" title="2238"><span class="co"># product-sum</span></a>
<a class="sourceLine" id="cb753-2239" title="2239">prodSumModel &lt;-<span class="st"> </span><span class="kw">vgmST</span>(<span class="st">&quot;productSum&quot;</span>,</a>
<a class="sourceLine" id="cb753-2240" title="2240">    <span class="dt">space =</span> <span class="kw">vgm</span>(<span class="dv">150</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">200</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb753-2241" title="2241">    <span class="dt">time =</span> <span class="kw">vgm</span>(<span class="dv">20</span>, <span class="st">&quot;Sph&quot;</span>, <span class="dv">40</span>, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb753-2242" title="2242">    <span class="dt">k =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-2243" title="2243">StAni =<span class="st"> </span><span class="kw">estiStAni</span>(v.st, <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">200000</span>))</a>
<a class="sourceLine" id="cb753-2244" title="2244">(fitProdSumModel &lt;-<span class="st"> </span><span class="kw">fit.StVariogram</span>(v.st, prodSumModel, <span class="dt">fit.method =</span> <span class="dv">7</span>,</a>
<a class="sourceLine" id="cb753-2245" title="2245">    <span class="dt">stAni =</span> StAni, <span class="dt">method =</span> <span class="st">&quot;L-BFGS-B&quot;</span>,</a>
<a class="sourceLine" id="cb753-2246" title="2246">    <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">parscale =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="dv">10</span>)),</a>
<a class="sourceLine" id="cb753-2247" title="2247">    <span class="dt">lower =</span> <span class="kw">rep</span>(<span class="fl">0.0001</span>, <span class="dv">7</span>)))</a>
<a class="sourceLine" id="cb753-2248" title="2248"><span class="kw">plot</span>(v.st, fitProdSumModel, <span class="dt">wireframe =</span> <span class="ot">FALSE</span>, <span class="dt">all =</span> <span class="ot">TRUE</span>, <span class="dt">scales =</span> <span class="kw">list</span>(<span class="dt">arrows=</span><span class="ot">FALSE</span>), <span class="dt">zlim =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">150</span>))</a>
<a class="sourceLine" id="cb753-2249" title="2249"><span class="kw">plot</span>(v.st, <span class="dt">model =</span> fitProdSumModel, <span class="dt">wireframe =</span> <span class="ot">TRUE</span>, <span class="dt">all =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb753-2250" title="2250">     <span class="dt">scales =</span> <span class="kw">list</span>(<span class="dt">arrows =</span> <span class="ot">FALSE</span>), <span class="dt">zlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">185</span>))</a>
<a class="sourceLine" id="cb753-2251" title="2251">pt =<span class="st"> </span><span class="kw">st_sample</span>(de, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-2252" title="2252">t =<span class="st"> </span><span class="kw">st_get_dimension_values</span>(no2.st, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-2253" title="2253"><span class="kw">st_as_stars</span>(<span class="kw">list</span>(<span class="dt">pts =</span> <span class="kw">matrix</span>(<span class="dv">1</span>, <span class="kw">length</span>(t), <span class="kw">length</span>(pt)))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2254" title="2254"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="dt">names =</span> <span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;station&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2255" title="2255"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;time&quot;</span>, t) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2256" title="2256"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;station&quot;</span>, pt) -&gt;<span class="st"> </span>new_pt</a>
<a class="sourceLine" id="cb753-2257" title="2257">no2.st &lt;-<span class="st"> </span><span class="kw">st_transform</span>(no2.st, crs)</a>
<a class="sourceLine" id="cb753-2258" title="2258">new_ts &lt;-<span class="st"> </span><span class="kw">krigeST</span>(NO2<span class="op">~</span><span class="dv">1</span>, <span class="dt">data =</span> no2.st[<span class="st">&quot;NO2&quot;</span>], <span class="dt">newdata =</span> new_pt,</a>
<a class="sourceLine" id="cb753-2259" title="2259">         <span class="dt">nmax =</span> <span class="dv">50</span>, <span class="dt">stAni =</span> StAni, <span class="dt">modelList =</span> fitProdSumModel,</a>
<a class="sourceLine" id="cb753-2260" title="2260">         <span class="dt">progress =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2261" title="2261"><span class="kw">plot</span>(<span class="kw">as.xts</span>(new_ts[<span class="dv">2</span>]))</a>
<a class="sourceLine" id="cb753-2262" title="2262">t4 =<span class="st"> </span>t[(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span> <span class="op">-</span><span class="st"> </span><span class="fl">0.5</span>) <span class="op">*</span><span class="st"> </span>(<span class="dv">3</span><span class="op">*</span><span class="dv">24</span><span class="op">*</span><span class="dv">30</span>)]</a>
<a class="sourceLine" id="cb753-2263" title="2263">d =<span class="st"> </span><span class="kw">dim</span>(grd)</a>
<a class="sourceLine" id="cb753-2264" title="2264"><span class="kw">st_as_stars</span>(<span class="dt">pts =</span> <span class="kw">array</span>(<span class="dv">1</span>, <span class="kw">c</span>(d[<span class="dv">1</span>], d[<span class="dv">2</span>], <span class="dt">time =</span> <span class="kw">length</span>(t4)))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2265" title="2265"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;time&quot;</span>, t4) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2266" title="2266"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;x&quot;</span>, <span class="kw">st_get_dimension_values</span>(grd, <span class="st">&quot;x&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2267" title="2267"><span class="st">    </span><span class="kw">st_set_dimensions</span>(<span class="st">&quot;y&quot;</span>, <span class="kw">st_get_dimension_values</span>(grd, <span class="st">&quot;y&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2268" title="2268"><span class="st">    </span><span class="kw">st_set_crs</span>(crs) -&gt;<span class="st"> </span>grd.st</a>
<a class="sourceLine" id="cb753-2269" title="2269">new_int &lt;-<span class="st"> </span><span class="kw">krigeST</span>(NO2<span class="op">~</span><span class="dv">1</span>, <span class="dt">data =</span> no2.st[<span class="st">&quot;NO2&quot;</span>], <span class="dt">newdata =</span> grd.st,</a>
<a class="sourceLine" id="cb753-2270" title="2270">         <span class="dt">nmax =</span> <span class="dv">200</span>, <span class="dt">stAni =</span> StAni, <span class="dt">modelList =</span> fitProdSumModel,</a>
<a class="sourceLine" id="cb753-2271" title="2271">         <span class="dt">progress =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2272" title="2272"><span class="kw">names</span>(new_int)[<span class="dv">2</span>] =<span class="st"> &quot;NO2&quot;</span></a>
<a class="sourceLine" id="cb753-2273" title="2273">g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> new_int, <span class="kw">aes</span>(<span class="dt">fill =</span> NO2, <span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2274" title="2274"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="kw">as.Date</span>(time)) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-2275" title="2275"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_cast</span>(de, <span class="st">&quot;MULTILINESTRING&quot;</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2276" title="2276"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf, <span class="dt">col =</span> <span class="st">&#39;grey&#39;</span>, <span class="dt">cex =</span> <span class="fl">.5</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2277" title="2277"><span class="st">    </span><span class="kw">coord_sf</span>(<span class="dt">lims_method =</span> <span class="st">&quot;geometry_bbox&quot;</span>)</a>
<a class="sourceLine" id="cb753-2278" title="2278"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-2279" title="2279"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-2280" title="2280"></a>
<a class="sourceLine" id="cb753-2281" title="2281">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-2282" title="2282">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-2283" title="2283">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-2284" title="2284">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-2285" title="2285"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-2286" title="2286">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-2287" title="2287"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-2288" title="2288"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-2289" title="2289"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-2290" title="2290">)</a>
<a class="sourceLine" id="cb753-2291" title="2291"></a>
<a class="sourceLine" id="cb753-2292" title="2292"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-2293" title="2293"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-2294" title="2294">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2295" title="2295"></a>
<a class="sourceLine" id="cb753-2296" title="2296"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-2297" title="2297"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-2298" title="2298"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-2299" title="2299">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-2300" title="2300">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-2301" title="2301">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(<span class="dt">echo =</span> <span class="ot">TRUE</span>, <span class="dt">paged.print=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2302" title="2302"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-2303" title="2303"><span class="kw">data</span>(pol_pres15, <span class="dt">package =</span> <span class="st">&quot;spDataLarge&quot;</span>)</a>
<a class="sourceLine" id="cb753-2304" title="2304">pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2305" title="2305"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select =</span> <span class="kw">c</span>(TERYT, name, types)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2306" title="2306"><span class="st">    </span><span class="kw">head</span>()</a>
<a class="sourceLine" id="cb753-2307" title="2307"><span class="kw">library</span>(tmap, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2308" title="2308"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;types&quot;</span>)</a>
<a class="sourceLine" id="cb753-2309" title="2309"><span class="cf">if</span> (<span class="op">!</span><span class="kw">all</span>(<span class="kw">st_is_valid</span>(pol_pres15))) pol_pres15 &lt;-<span class="st"> </span><span class="kw">st_make_valid</span>(pol_pres15)</a>
<a class="sourceLine" id="cb753-2310" title="2310"><span class="kw">library</span>(spdep)</a>
<a class="sourceLine" id="cb753-2311" title="2311"><span class="kw">args</span>(poly2nb)</a>
<a class="sourceLine" id="cb753-2312" title="2312"><span class="kw">system.time</span>(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">poly2nb</span>(<span class="dt">queen =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>nb_q)</a>
<a class="sourceLine" id="cb753-2313" title="2313">nb_q</a>
<a class="sourceLine" id="cb753-2314" title="2314">old_use_s2 &lt;-<span class="st"> </span><span class="kw">sf_use_s2</span>()</a>
<a class="sourceLine" id="cb753-2315" title="2315"><span class="kw">sf_use_s2</span>(<span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-2316" title="2316">(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="st">&quot;OGC:CRS84&quot;</span>) -&gt;<span class="st"> </span>pol_pres15_ll) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2317" title="2317"><span class="st">    </span><span class="kw">poly2nb</span>(<span class="dt">queen =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>nb_q_s2</a>
<a class="sourceLine" id="cb753-2318" title="2318"><span class="kw">all.equal</span>(nb_q, nb_q_s2, <span class="dt">check.attributes=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2319" title="2319">(nb_q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>())<span class="op">$</span>nc</a>
<a class="sourceLine" id="cb753-2320" title="2320"><span class="kw">library</span>(Matrix, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2321" title="2321"><span class="kw">library</span>(spatialreg, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2322" title="2322">nb_q <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2323" title="2323"><span class="st">    </span><span class="kw">nb2listw</span>(<span class="dt">style =</span> <span class="st">&quot;B&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2324" title="2324"><span class="st">    </span><span class="kw">as</span>(<span class="st">&quot;CsparseMatrix&quot;</span>) -&gt;<span class="st"> </span>smat</a>
<a class="sourceLine" id="cb753-2325" title="2325"><span class="kw">library</span>(igraph, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2326" title="2326">(smat <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2327" title="2327"><span class="st">        </span><span class="kw">graph.adjacency</span>() -&gt;<span class="st"> </span>g1) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2328" title="2328"><span class="st">    </span><span class="kw">count_components</span>()</a>
<a class="sourceLine" id="cb753-2329" title="2329">tf &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">&quot;.gal&quot;</span>)</a>
<a class="sourceLine" id="cb753-2330" title="2330"><span class="kw">write.nb.gal</span>(nb_q, tf)</a>
<a class="sourceLine" id="cb753-2331" title="2331">pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2332" title="2332"><span class="st">    </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2333" title="2333"><span class="st">    </span><span class="kw">st_centroid</span>(<span class="dt">of_largest_polygon =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>coords </a>
<a class="sourceLine" id="cb753-2334" title="2334">(coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">tri2nb</span>() -&gt;<span class="st"> </span>nb_tri)</a>
<a class="sourceLine" id="cb753-2335" title="2335">nb_tri <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2336" title="2336"><span class="st">    </span><span class="kw">nbdists</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2337" title="2337"><span class="st">    </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2338" title="2338"><span class="st">    </span><span class="kw">summary</span>()</a>
<a class="sourceLine" id="cb753-2339" title="2339">(nb_tri <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>())<span class="op">$</span>nc</a>
<a class="sourceLine" id="cb753-2340" title="2340">(nb_tri <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2341" title="2341"><span class="st">        </span><span class="kw">soi.graph</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2342" title="2342"><span class="st">        </span><span class="kw">graph2nb</span>() -&gt;<span class="st"> </span>nb_soi)</a>
<a class="sourceLine" id="cb753-2343" title="2343">(nb_soi <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>() -&gt;<span class="st"> </span>n_comp)<span class="op">$</span>nc</a>
<a class="sourceLine" id="cb753-2344" title="2344"><span class="kw">table</span>(n_comp<span class="op">$</span>comp.id)</a>
<a class="sourceLine" id="cb753-2345" title="2345">opar &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>)<span class="op">+</span><span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb753-2346" title="2346">pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2347" title="2347"><span class="st">    </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2348" title="2348"><span class="st">    </span><span class="kw">plot</span>(<span class="dt">border =</span> <span class="st">&quot;grey&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb753-2349" title="2349">nb_soi <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2350" title="2350"><span class="st">    </span><span class="kw">plot</span>(<span class="dt">coords =</span> coords, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">points =</span> <span class="ot">FALSE</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb753-2351" title="2351">nb_tri <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2352" title="2352"><span class="st">    </span><span class="kw">diffnb</span>(nb_soi) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2353" title="2353"><span class="st">    </span><span class="kw">plot</span>(<span class="dt">coords =</span> coords, <span class="dt">col =</span> <span class="st">&quot;orange&quot;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">points =</span> <span class="ot">FALSE</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb753-2354" title="2354"><span class="kw">par</span>(opar)</a>
<a class="sourceLine" id="cb753-2355" title="2355">coords <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2356" title="2356"><span class="st">    </span><span class="kw">knearneigh</span>(<span class="dt">k =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2357" title="2357"><span class="st">    </span><span class="kw">knn2nb</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2358" title="2358"><span class="st">    </span><span class="kw">nbdists</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2359" title="2359"><span class="st">    </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2360" title="2360"><span class="st">    </span><span class="kw">summary</span>()</a>
<a class="sourceLine" id="cb753-2361" title="2361"><span class="kw">system.time</span>(coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">18000</span>) -&gt;<span class="st"> </span>nb_d18)</a>
<a class="sourceLine" id="cb753-2362" title="2362"><span class="kw">system.time</span>(coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">18000</span>, <span class="dt">use_kd_tree =</span> <span class="ot">FALSE</span>) -&gt;<span class="st"> </span>nb_d18a)</a>
<a class="sourceLine" id="cb753-2363" title="2363"><span class="kw">all.equal</span>(nb_d18, nb_d18a, <span class="dt">check.attributes =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2364" title="2364">nb_d18</a>
<a class="sourceLine" id="cb753-2365" title="2365">(nb_d18 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>() -&gt;<span class="st"> </span>n_comp)<span class="op">$</span>nc</a>
<a class="sourceLine" id="cb753-2366" title="2366"><span class="kw">table</span>(n_comp<span class="op">$</span>comp.id)</a>
<a class="sourceLine" id="cb753-2367" title="2367">(coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">18300</span>) -&gt;<span class="st"> </span>nb_d183)</a>
<a class="sourceLine" id="cb753-2368" title="2368">(nb_d183 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>())<span class="op">$</span>nc</a>
<a class="sourceLine" id="cb753-2369" title="2369">(coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dnearneigh</span>(<span class="dv">0</span>, <span class="dv">16000</span>) -&gt;<span class="st"> </span>nb_d16)</a>
<a class="sourceLine" id="cb753-2370" title="2370">((coords <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">knearneigh</span>(<span class="dt">k =</span> <span class="dv">6</span>) -&gt;<span class="st"> </span>knn_k6) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">knn2nb</span>() -&gt;<span class="st"> </span>nb_k6)</a>
<a class="sourceLine" id="cb753-2371" title="2371">(knn_k6 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">knn2nb</span>(<span class="dt">sym =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>nb_k6s)</a>
<a class="sourceLine" id="cb753-2372" title="2372">(nb_k6s <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">n.comp.nb</span>())<span class="op">$</span>nc</a>
<a class="sourceLine" id="cb753-2373" title="2373">old_use_s2 &lt;-<span class="st"> </span><span class="kw">sf_use_s2</span>()</a>
<a class="sourceLine" id="cb753-2374" title="2374"><span class="kw">sf_use_s2</span>(<span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-2375" title="2375">pol_pres15_ll <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2376" title="2376"><span class="st">    </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2377" title="2377"><span class="st">    </span><span class="kw">st_centroid</span>(<span class="dt">of_largest_polygon =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>coords_ll</a>
<a class="sourceLine" id="cb753-2378" title="2378">(coords_ll <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dnearneigh</span>(<span class="dv">0</span>, <span class="fl">18.3</span>, <span class="dt">use_s2=</span><span class="ot">TRUE</span>, <span class="dt">dwithin=</span><span class="ot">TRUE</span>) -&gt;<span class="st"> </span>nb_d183_ll)</a>
<a class="sourceLine" id="cb753-2379" title="2379"><span class="kw">isTRUE</span>(<span class="kw">all.equal</span>(nb_d183, nb_d183_ll, <span class="dt">check.attributes =</span> <span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb753-2380" title="2380"><span class="cf">if</span> (<span class="kw">packageVersion</span>(<span class="st">&quot;s2&quot;</span>) <span class="op">&gt;</span><span class="st"> &quot;1.0.7&quot;</span>) (coords_ll <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">dnearneigh</span>(<span class="dv">0</span>, <span class="fl">18.3</span>) -&gt;<span class="st"> </span>nb_d183_llce)</a>
<a class="sourceLine" id="cb753-2381" title="2381"><span class="kw">isTRUE</span>(<span class="kw">all.equal</span>(nb_d183_llce, nb_d183_ll, <span class="dt">check.attributes =</span> <span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb753-2382" title="2382">(coords_ll <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">knearneigh</span>(<span class="dt">k =</span> <span class="dv">6</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">knn2nb</span>() -&gt;<span class="st"> </span>nb_k6_ll)</a>
<a class="sourceLine" id="cb753-2383" title="2383"><span class="kw">isTRUE</span>(<span class="kw">all.equal</span>(nb_k6, nb_k6_ll, <span class="dt">check.attributes =</span> <span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb753-2384" title="2384">nb_q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nbdists</span>(coords_ll) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summary</span>()</a>
<a class="sourceLine" id="cb753-2385" title="2385">nb_q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nbdists</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summary</span>()</a>
<a class="sourceLine" id="cb753-2386" title="2386"><span class="kw">sf_use_s2</span>(old_use_s2)</a>
<a class="sourceLine" id="cb753-2387" title="2387"><span class="kw">args</span>(nb2listw)</a>
<a class="sourceLine" id="cb753-2388" title="2388"><span class="kw">args</span>(spweights.constants)</a>
<a class="sourceLine" id="cb753-2389" title="2389">(nb_q <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2390" title="2390"><span class="st">        </span><span class="kw">nb2listw</span>(<span class="dt">style =</span> <span class="st">&quot;B&quot;</span>) -&gt;<span class="st"> </span>lw_q_B) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2391" title="2391"><span class="st">    </span><span class="kw">spweights.constants</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2392" title="2392"><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2393" title="2393"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select =</span> <span class="kw">c</span>(n, S0, S1, S2))</a>
<a class="sourceLine" id="cb753-2394" title="2394">(nb_q <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2395" title="2395"><span class="st">        </span><span class="kw">nb2listw</span>(<span class="dt">style =</span> <span class="st">&quot;W&quot;</span>) -&gt;<span class="st"> </span>lw_q_W) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2396" title="2396"><span class="st">    </span><span class="kw">spweights.constants</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2397" title="2397"><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2398" title="2398"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select =</span> <span class="kw">c</span>(n, S0, S1, S2))</a>
<a class="sourceLine" id="cb753-2399" title="2399">nb_d183 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2400" title="2400"><span class="st">    </span><span class="kw">nbdists</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2401" title="2401"><span class="st">    </span><span class="kw">lapply</span>(<span class="cf">function</span>(x) <span class="dv">1</span><span class="op">/</span>(x<span class="op">/</span><span class="dv">1000</span>)) -&gt;<span class="st"> </span>gwts</a>
<a class="sourceLine" id="cb753-2402" title="2402">(nb_d183 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nb2listw</span>(<span class="dt">glist=</span>gwts, <span class="dt">style=</span><span class="st">&quot;B&quot;</span>) -&gt;<span class="st"> </span>lw_d183_idw_B) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2403" title="2403"><span class="st">    </span><span class="kw">spweights.constants</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2404" title="2404"><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2405" title="2405"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select=</span><span class="kw">c</span>(n, S0, S1, S2))</a>
<a class="sourceLine" id="cb753-2406" title="2406"><span class="kw">try</span>(nb_d16 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nb2listw</span>(<span class="dt">style=</span><span class="st">&quot;B&quot;</span>) -&gt;<span class="st"> </span>lw_d16_B)</a>
<a class="sourceLine" id="cb753-2407" title="2407">nb_d16 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2408" title="2408"><span class="st">    </span><span class="kw">nb2listw</span>(<span class="dt">style=</span><span class="st">&quot;B&quot;</span>, <span class="dt">zero.policy=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2409" title="2409"><span class="st">    </span><span class="kw">spweights.constants</span>(<span class="dt">zero.policy=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2410" title="2410"><span class="st">    </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2411" title="2411"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select=</span><span class="kw">c</span>(n, S0, S1, S2))</a>
<a class="sourceLine" id="cb753-2412" title="2412">nb_q</a>
<a class="sourceLine" id="cb753-2413" title="2413">(nb_q <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">nblag</span>(<span class="dv">2</span>) -&gt;<span class="st"> </span>nb_q2)[[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb753-2414" title="2414"><span class="kw">nblag_cumul</span>(nb_q2)</a>
<a class="sourceLine" id="cb753-2415" title="2415"><span class="kw">union.nb</span>(nb_q2[[<span class="dv">2</span>]], nb_q2[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb753-2416" title="2416"><span class="kw">diameter</span>(g1)</a>
<a class="sourceLine" id="cb753-2417" title="2417">g1 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">shortest.paths</span>() -&gt;<span class="st"> </span>sps</a>
<a class="sourceLine" id="cb753-2418" title="2418">(sps <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">apply</span>(<span class="dv">2</span>, max) -&gt;<span class="st"> </span>spmax) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">max</span>()</a>
<a class="sourceLine" id="cb753-2419" title="2419">mr &lt;-<span class="st"> </span><span class="kw">which.max</span>(spmax)</a>
<a class="sourceLine" id="cb753-2420" title="2420">pol_pres15<span class="op">$</span>name0[mr]</a>
<a class="sourceLine" id="cb753-2421" title="2421">pol_pres15<span class="op">$</span>sps1 &lt;-<span class="st"> </span>sps[,mr]</a>
<a class="sourceLine" id="cb753-2422" title="2422">tm1 &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;sps1&quot;</span>, <span class="dt">title =</span> <span class="st">&quot;Shortest path</span><span class="ch">\n</span><span class="st">count&quot;</span>)</a>
<a class="sourceLine" id="cb753-2423" title="2423">coords[mr] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2424" title="2424"><span class="st">    </span><span class="kw">st_distance</span>(coords) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2425" title="2425"><span class="st">    </span><span class="kw">c</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2426" title="2426"><span class="st">    </span>(<span class="cf">function</span>(x) x<span class="op">/</span><span class="dv">1000</span>)() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2427" title="2427"><span class="st">    </span>units<span class="op">::</span><span class="kw">set_units</span>(<span class="ot">NULL</span>) -&gt;<span class="st"> </span>pol_pres15<span class="op">$</span>dist_<span class="dv">52</span></a>
<a class="sourceLine" id="cb753-2428" title="2428"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb753-2429" title="2429">g1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(pol_pres15, <span class="kw">aes</span>(<span class="dt">x =</span> sps1, <span class="dt">y =</span> dist_<span class="dv">52</span>)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Shortest path count&quot;</span>) <span class="op">+</span><span class="st">  </span><span class="kw">ylab</span>(<span class="st">&quot;km distance&quot;</span>)</a>
<a class="sourceLine" id="cb753-2430" title="2430">gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(<span class="kw">tmap_grob</span>(tm1), g1, <span class="dt">nrow=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-2431" title="2431">glance_htest &lt;-<span class="st"> </span><span class="cf">function</span>(ht) <span class="kw">c</span>(ht<span class="op">$</span>estimate, </a>
<a class="sourceLine" id="cb753-2432" title="2432">    <span class="st">&quot;Std deviate&quot;</span> =<span class="st"> </span><span class="kw">unname</span>(ht<span class="op">$</span>statistic), </a>
<a class="sourceLine" id="cb753-2433" title="2433">    <span class="st">&quot;p.value&quot;</span> =<span class="st"> </span><span class="kw">unname</span>(ht<span class="op">$</span>p.value))</a>
<a class="sourceLine" id="cb753-2434" title="2434"><span class="kw">set.seed</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-2435" title="2435">(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2436" title="2436"><span class="st">        </span><span class="kw">nrow</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2437" title="2437"><span class="st">        </span><span class="kw">rnorm</span>() -&gt;<span class="st"> </span>x) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2438" title="2438"><span class="st">    </span><span class="kw">moran.test</span>(lw_q_B, <span class="dt">randomisation =</span> <span class="ot">FALSE</span>, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2439" title="2439"><span class="st">    </span><span class="kw">glance_htest</span>()</a>
<a class="sourceLine" id="cb753-2440" title="2440">beta &lt;-<span class="st"> </span><span class="fl">0.0015</span></a>
<a class="sourceLine" id="cb753-2441" title="2441">coords <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2442" title="2442"><span class="st">    </span><span class="kw">st_coordinates</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2443" title="2443"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select =</span> <span class="dv">1</span>, <span class="dt">drop =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2444" title="2444"><span class="st">    </span>(<span class="cf">function</span>(x) x<span class="op">/</span><span class="dv">1000</span>)() -&gt;<span class="st"> </span>t</a>
<a class="sourceLine" id="cb753-2445" title="2445">(x <span class="op">+</span><span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>t -&gt;<span class="st"> </span>x_t) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2446" title="2446"><span class="st">    </span><span class="kw">moran.test</span>(lw_q_B, <span class="dt">randomisation =</span> <span class="ot">FALSE</span>, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2447" title="2447"><span class="st">    </span><span class="kw">glance_htest</span>()</a>
<a class="sourceLine" id="cb753-2448" title="2448"><span class="kw">lm</span>(x_t <span class="op">~</span><span class="st"> </span>t) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2449" title="2449"><span class="st">    </span><span class="kw">lm.morantest</span>(lw_q_B, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2450" title="2450"><span class="st">    </span><span class="kw">glance_htest</span>()</a>
<a class="sourceLine" id="cb753-2451" title="2451"><span class="kw">args</span>(joincount.test)</a>
<a class="sourceLine" id="cb753-2452" title="2452">(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2453" title="2453"><span class="st">        </span><span class="kw">st_drop_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2454" title="2454"><span class="st">        </span><span class="kw">subset</span>(<span class="dt">select =</span> types, <span class="dt">drop =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>Types) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2455" title="2455"><span class="st">    </span><span class="kw">table</span>()</a>
<a class="sourceLine" id="cb753-2456" title="2456">Types <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">joincount.multi</span>(<span class="dt">listw =</span> lw_q_B)</a>
<a class="sourceLine" id="cb753-2457" title="2457">Types <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">joincount.multi</span>(<span class="dt">listw =</span> lw_d183_idw_B)</a>
<a class="sourceLine" id="cb753-2458" title="2458"><span class="kw">args</span>(moran.test)</a>
<a class="sourceLine" id="cb753-2459" title="2459">pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2460" title="2460"><span class="st">        </span><span class="kw">st_drop_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2461" title="2461"><span class="st">        </span><span class="kw">subset</span>(<span class="dt">select =</span> I_turnout, <span class="dt">drop =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>I_turnout</a>
<a class="sourceLine" id="cb753-2462" title="2462">I_turnout <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">moran.test</span>(<span class="dt">listw =</span> lw_q_B, <span class="dt">randomisation =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2463" title="2463"><span class="st">    </span><span class="kw">glance_htest</span>()</a>
<a class="sourceLine" id="cb753-2464" title="2464"><span class="kw">lm</span>(I_turnout <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, pol_pres15) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2465" title="2465"><span class="st">    </span><span class="kw">lm.morantest</span>(<span class="dt">listw =</span> lw_q_B) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2466" title="2466"><span class="st">    </span><span class="kw">glance_htest</span>()</a>
<a class="sourceLine" id="cb753-2467" title="2467">(I_turnout <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2468" title="2468"><span class="st">    </span><span class="kw">moran.test</span>(<span class="dt">listw =</span> lw_q_B) -&gt;<span class="st"> </span>mtr) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2469" title="2469"><span class="st">    </span><span class="kw">glance_htest</span>()</a>
<a class="sourceLine" id="cb753-2470" title="2470"><span class="kw">set.seed</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-2471" title="2471">I_turnout <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2472" title="2472"><span class="st">    </span><span class="kw">moran.mc</span>(<span class="dt">listw =</span> lw_q_B, <span class="dt">nsim =</span> <span class="dv">999</span>, <span class="dt">return_boot =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>mmc</a>
<a class="sourceLine" id="cb753-2473" title="2473"><span class="kw">c</span>(<span class="st">&quot;Permutation bootstrap&quot;</span> =<span class="st"> </span><span class="kw">var</span>(mmc<span class="op">$</span>t), </a>
<a class="sourceLine" id="cb753-2474" title="2474">  <span class="st">&quot;Analytical randomisation&quot;</span> =<span class="st"> </span><span class="kw">unname</span>(mtr<span class="op">$</span>estimate[<span class="dv">3</span>]))</a>
<a class="sourceLine" id="cb753-2475" title="2475">I_turnout <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2476" title="2476"><span class="st">    </span><span class="kw">moran.plot</span>(<span class="dt">listw =</span> lw_q_W, <span class="dt">labels =</span> pol_pres15<span class="op">$</span>TERYT, <span class="dt">cex =</span> <span class="dv">1</span>, <span class="dt">pch =</span> <span class="st">&quot;.&quot;</span>,</a>
<a class="sourceLine" id="cb753-2477" title="2477">        <span class="dt">xlab =</span> <span class="st">&quot;I round turnout&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;lagged turnout&quot;</span>) -&gt;<span class="st"> </span>infl_W</a>
<a class="sourceLine" id="cb753-2478" title="2478">pol_pres15<span class="op">$</span>hat_value &lt;-<span class="st"> </span>infl_W<span class="op">$</span>hat</a>
<a class="sourceLine" id="cb753-2479" title="2479"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;hat_value&quot;</span>)</a>
<a class="sourceLine" id="cb753-2480" title="2480"><span class="kw">args</span>(localmoran)</a>
<a class="sourceLine" id="cb753-2481" title="2481">I_turnout <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2482" title="2482"><span class="st">    </span><span class="kw">localmoran</span>(<span class="dt">listw =</span> lw_q_W) -&gt;<span class="st"> </span>locm</a>
<a class="sourceLine" id="cb753-2483" title="2483"><span class="kw">all.equal</span>(<span class="kw">sum</span>(locm[,<span class="dv">1</span>])<span class="op">/</span><span class="kw">Szero</span>(lw_q_W), <span class="kw">unname</span>(<span class="kw">moran.test</span>(I_turnout, lw_q_W)<span class="op">$</span>estimate[<span class="dv">1</span>]))</a>
<a class="sourceLine" id="cb753-2484" title="2484">pva &lt;-<span class="st"> </span><span class="cf">function</span>(pv) <span class="kw">cbind</span>(<span class="st">&quot;none&quot;</span> =<span class="st"> </span>pv, <span class="st">&quot;FDR&quot;</span> =<span class="st"> </span><span class="kw">p.adjust</span>(pv, <span class="st">&quot;fdr&quot;</span>),</a>
<a class="sourceLine" id="cb753-2485" title="2485">    <span class="st">&quot;BY&quot;</span> =<span class="st"> </span><span class="kw">p.adjust</span>(pv, <span class="st">&quot;BY&quot;</span>), <span class="st">&quot;Bonferroni&quot;</span> =<span class="st"> </span><span class="kw">p.adjust</span>(pv, <span class="st">&quot;bonferroni&quot;</span>))</a>
<a class="sourceLine" id="cb753-2486" title="2486">locm <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2487" title="2487"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select =</span> <span class="st">&quot;Pr(z != E(Ii))&quot;</span>, <span class="dt">drop =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2488" title="2488"><span class="st">    </span><span class="kw">pva</span>() -&gt;<span class="st"> </span>pvsp</a>
<a class="sourceLine" id="cb753-2489" title="2489">f &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">sum</span>(x <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.005</span>)</a>
<a class="sourceLine" id="cb753-2490" title="2490"><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, f)</a>
<a class="sourceLine" id="cb753-2491" title="2491"><span class="kw">library</span>(parallel)</a>
<a class="sourceLine" id="cb753-2492" title="2492"><span class="kw">invisible</span>(spdep<span class="op">::</span><span class="kw">set.coresOption</span>(<span class="kw">ifelse</span>(<span class="kw">detectCores</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="kw">detectCores</span>()<span class="op">-</span>1L)))</a>
<a class="sourceLine" id="cb753-2493" title="2493"><span class="kw">system.time</span>(I_turnout <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2494" title="2494"><span class="st">        </span><span class="kw">localmoran_perm</span>(<span class="dt">listw =</span> lw_q_W, <span class="dt">nsim =</span> <span class="dv">9999</span>, <span class="dt">iseed =</span> <span class="dv">1</span>) -&gt;<span class="st"> </span>locm_p)</a>
<a class="sourceLine" id="cb753-2495" title="2495">locm_p <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2496" title="2496"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select =</span> <span class="st">&quot;Pr(z != E(Ii))&quot;</span>, <span class="dt">drop =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2497" title="2497"><span class="st">    </span><span class="kw">pva</span>() -&gt;<span class="st"> </span>pvsp</a>
<a class="sourceLine" id="cb753-2498" title="2498"><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, f)</a>
<a class="sourceLine" id="cb753-2499" title="2499">locm_p <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2500" title="2500"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select =</span> <span class="st">&quot;Pr(z != E(Ii)) Sim&quot;</span>, <span class="dt">drop =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2501" title="2501"><span class="st">    </span><span class="kw">pva</span>() -&gt;<span class="st"> </span>pvsp</a>
<a class="sourceLine" id="cb753-2502" title="2502"><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, f)</a>
<a class="sourceLine" id="cb753-2503" title="2503">pol_pres15<span class="op">$</span>locm_pv &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(locm[, <span class="st">&quot;Pr(z != E(Ii))&quot;</span>], <span class="st">&quot;fdr&quot;</span>)</a>
<a class="sourceLine" id="cb753-2504" title="2504">pol_pres15<span class="op">$</span>locm_std_pv &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(locm_p[, <span class="st">&quot;Pr(z != E(Ii))&quot;</span>], <span class="st">&quot;fdr&quot;</span>)</a>
<a class="sourceLine" id="cb753-2505" title="2505">pol_pres15<span class="op">$</span>locm_p_pv &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(locm_p[, <span class="st">&quot;Pr(z != E(Ii)) Sim&quot;</span>], <span class="st">&quot;fdr&quot;</span>)</a>
<a class="sourceLine" id="cb753-2506" title="2506"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;locm_pv&quot;</span>, <span class="st">&quot;locm_std_pv&quot;</span>, <span class="st">&quot;locm_p_pv&quot;</span>),</a>
<a class="sourceLine" id="cb753-2507" title="2507">    <span class="dt">breaks=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.0005</span>, <span class="fl">0.001</span>, <span class="fl">0.005</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="dv">1</span>), </a>
<a class="sourceLine" id="cb753-2508" title="2508">    <span class="dt">title =</span> <span class="st">&quot;Pseudo p-values</span><span class="ch">\n</span><span class="st">Local Moran&#39;s I&quot;</span>, <span class="dt">palette=</span><span class="st">&quot;-YlOrBr&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-2509" title="2509"><span class="st">    </span><span class="kw">tm_facets</span>(<span class="dt">free.scales =</span> <span class="ot">FALSE</span>, <span class="dt">ncol =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-2510" title="2510"><span class="st">    </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels =</span> <span class="kw">c</span>(<span class="st">&quot;Analytical conditional&quot;</span>, <span class="st">&quot;Permutation std. dev.&quot;</span>,</a>
<a class="sourceLine" id="cb753-2511" title="2511">        <span class="st">&quot;Permutation rank&quot;</span>))</a>
<a class="sourceLine" id="cb753-2512" title="2512">quadr &lt;-<span class="st"> </span><span class="kw">attr</span>(locm, <span class="st">&quot;quadr&quot;</span>)<span class="op">$</span>mean</a>
<a class="sourceLine" id="cb753-2513" title="2513">a &lt;-<span class="st"> </span><span class="kw">table</span>(<span class="kw">addNA</span>(quadr))</a>
<a class="sourceLine" id="cb753-2514" title="2514">pol_pres15<span class="op">$</span>hs_an_q &lt;-<span class="st"> </span>pol_pres15<span class="op">$</span>hs_ac_q &lt;-<span class="st"> </span>pol_pres15<span class="op">$</span>hs_cp_q &lt;-<span class="st"> </span>quadr</a>
<a class="sourceLine" id="cb753-2515" title="2515"><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>hs_an_q) &lt;-<span class="st"> </span>pol_pres15<span class="op">$</span>locm_pv <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.005</span></a>
<a class="sourceLine" id="cb753-2516" title="2516">b &lt;-<span class="st"> </span><span class="kw">table</span>(<span class="kw">addNA</span>(pol_pres15<span class="op">$</span>hs_an_q))</a>
<a class="sourceLine" id="cb753-2517" title="2517"><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>hs_ac_q) &lt;-<span class="st"> </span>pol_pres15<span class="op">$</span>locm_std_pv <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.005</span></a>
<a class="sourceLine" id="cb753-2518" title="2518">c &lt;-<span class="st"> </span><span class="kw">table</span>(<span class="kw">addNA</span>(pol_pres15<span class="op">$</span>hs_ac_q))</a>
<a class="sourceLine" id="cb753-2519" title="2519"><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>hs_cp_q) &lt;-<span class="st"> </span>pol_pres15<span class="op">$</span>locm_p_pv <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.005</span></a>
<a class="sourceLine" id="cb753-2520" title="2520">d &lt;-<span class="st"> </span><span class="kw">table</span>(<span class="kw">addNA</span>(pol_pres15<span class="op">$</span>hs_cp_q))</a>
<a class="sourceLine" id="cb753-2521" title="2521"><span class="kw">t</span>(<span class="kw">rbind</span>(<span class="st">&quot;Moran plot quadrants&quot;</span> =<span class="st"> </span>a, <span class="st">&quot;Analytical cond.&quot;</span> =<span class="st"> </span>b, </a>
<a class="sourceLine" id="cb753-2522" title="2522">    <span class="st">&quot;Permutation std. cond.&quot;</span> =<span class="st"> </span>c, <span class="st">&quot;Permutation rank cond.&quot;</span> =<span class="st"> </span>d))</a>
<a class="sourceLine" id="cb753-2523" title="2523">pol_pres15<span class="op">$</span>hs_an_q &lt;-<span class="st"> </span><span class="kw">droplevels</span>(pol_pres15<span class="op">$</span>hs_an_q)</a>
<a class="sourceLine" id="cb753-2524" title="2524">pol_pres15<span class="op">$</span>hs_ac_q &lt;-<span class="st"> </span><span class="kw">droplevels</span>(pol_pres15<span class="op">$</span>hs_ac_q)</a>
<a class="sourceLine" id="cb753-2525" title="2525">pol_pres15<span class="op">$</span>hs_cp_q &lt;-<span class="st"> </span><span class="kw">droplevels</span>(pol_pres15<span class="op">$</span>hs_cp_q)</a>
<a class="sourceLine" id="cb753-2526" title="2526"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;hs_an_q&quot;</span>, <span class="st">&quot;hs_ac_q&quot;</span>, <span class="st">&quot;hs_cp_q&quot;</span>), <span class="dt">colorNA=</span><span class="st">&quot;grey95&quot;</span>,</a>
<a class="sourceLine" id="cb753-2527" title="2527">    <span class="dt">textNA=</span><span class="st">&quot;Not </span><span class="ch">\&quot;</span><span class="st">interesting</span><span class="ch">\&quot;</span><span class="st">&quot;</span>, <span class="dt">title=</span><span class="st">&quot;Turnout hotspot status</span><span class="ch">\n</span><span class="st">Local Moran&#39;s I&quot;</span>,</a>
<a class="sourceLine" id="cb753-2528" title="2528">    <span class="dt">palette=</span>RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="dv">4</span>, <span class="st">&quot;Set3&quot;</span>)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>)]) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-2529" title="2529"><span class="st">    </span><span class="kw">tm_facets</span>(<span class="dt">free.scales=</span><span class="ot">FALSE</span>, <span class="dt">ncol=</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels=</span></a>
<a class="sourceLine" id="cb753-2530" title="2530">            <span class="kw">c</span>(<span class="st">&quot;Analytical conditional&quot;</span>, <span class="st">&quot;Permutation std. cond.&quot;</span>, </a>
<a class="sourceLine" id="cb753-2531" title="2531">              <span class="st">&quot;Permutation rank cond.&quot;</span>))</a>
<a class="sourceLine" id="cb753-2532" title="2532"><span class="kw">lm</span>(I_turnout <span class="op">~</span><span class="st"> </span><span class="dv">1</span>) -&gt;<span class="st"> </span>lm_null</a>
<a class="sourceLine" id="cb753-2533" title="2533"><span class="kw">invisible</span>(spdep<span class="op">::</span><span class="kw">set.coresOption</span>(<span class="kw">ifelse</span>(<span class="kw">detectCores</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="kw">detectCores</span>()<span class="op">-</span>1L)))</a>
<a class="sourceLine" id="cb753-2534" title="2534"><span class="kw">system.time</span>(lm_null <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">localmoran.sad</span>(<span class="dt">nb =</span> nb_q, <span class="dt">style =</span> <span class="st">&quot;W&quot;</span>, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2535" title="2535"><span class="st">        </span><span class="kw">summary</span>() -&gt;<span class="st"> </span>locm_sad_null)</a>
<a class="sourceLine" id="cb753-2536" title="2536"><span class="kw">lm</span>(I_turnout <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">weights =</span> pol_pres15<span class="op">$</span>I_entitled_to_vote) -&gt;<span class="st"> </span>lm_null_weights</a>
<a class="sourceLine" id="cb753-2537" title="2537"><span class="kw">invisible</span>(spdep<span class="op">::</span><span class="kw">set.coresOption</span>(<span class="kw">ifelse</span>(<span class="kw">detectCores</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="kw">detectCores</span>()<span class="op">-</span>1L)))</a>
<a class="sourceLine" id="cb753-2538" title="2538"><span class="kw">system.time</span>(lm_null_weights <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">localmoran.sad</span>(<span class="dt">nb =</span> nb_q, <span class="dt">style =</span> <span class="st">&quot;W&quot;</span>, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2539" title="2539"><span class="st">        </span><span class="kw">summary</span>() -&gt;<span class="st"> </span>locm_sad_null_weights)</a>
<a class="sourceLine" id="cb753-2540" title="2540"><span class="kw">lm</span>(I_turnout <span class="op">~</span><span class="st"> </span>Types, <span class="dt">weights=</span>pol_pres15<span class="op">$</span>I_entitled_to_vote) -&gt;<span class="st"> </span>lm_types</a>
<a class="sourceLine" id="cb753-2541" title="2541"><span class="kw">invisible</span>(spdep<span class="op">::</span><span class="kw">set.coresOption</span>(<span class="kw">ifelse</span>(<span class="kw">detectCores</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="kw">detectCores</span>()<span class="op">-</span>1L)))</a>
<a class="sourceLine" id="cb753-2542" title="2542"><span class="kw">system.time</span>(lm_types <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">localmoran.sad</span>(<span class="dt">nb =</span> nb_q, <span class="dt">style =</span> <span class="st">&quot;W&quot;</span>, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2543" title="2543"><span class="st">        </span><span class="kw">summary</span>() -&gt;<span class="st"> </span>locm_sad_types)</a>
<a class="sourceLine" id="cb753-2544" title="2544">pol_pres15<span class="op">$</span>locm_sad0 &lt;-<span class="st"> </span>pol_pres15<span class="op">$</span>locm_sad1 &lt;-<span class="st"> </span>pol_pres15<span class="op">$</span>locm_sad2 &lt;-<span class="st"> </span>quadr</a>
<a class="sourceLine" id="cb753-2545" title="2545"><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>locm_sad0) &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(locm_sad_null[, <span class="st">&quot;Pr. (Sad)&quot;</span>], <span class="st">&quot;fdr&quot;</span>)  <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.005</span></a>
<a class="sourceLine" id="cb753-2546" title="2546">pol_pres15<span class="op">$</span>locm_sad0 &lt;-<span class="st"> </span><span class="kw">droplevels</span>(pol_pres15<span class="op">$</span>locm_sad0)</a>
<a class="sourceLine" id="cb753-2547" title="2547"><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>locm_sad1) &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(locm_sad_null_weights[,</a>
<a class="sourceLine" id="cb753-2548" title="2548">    <span class="st">&quot;Pr. (Sad)&quot;</span>], <span class="st">&quot;fdr&quot;</span>) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.005</span></a>
<a class="sourceLine" id="cb753-2549" title="2549">pol_pres15<span class="op">$</span>locm_sad1 &lt;-<span class="st"> </span><span class="kw">droplevels</span>(pol_pres15<span class="op">$</span>locm_sad1)</a>
<a class="sourceLine" id="cb753-2550" title="2550"><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>locm_sad2) &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(locm_sad_types[, <span class="st">&quot;Pr. (Sad)&quot;</span>], <span class="st">&quot;fdr&quot;</span>) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.005</span></a>
<a class="sourceLine" id="cb753-2551" title="2551">pol_pres15<span class="op">$</span>locm_sad2 &lt;-<span class="st"> </span><span class="kw">droplevels</span>(pol_pres15<span class="op">$</span>locm_sad2)</a>
<a class="sourceLine" id="cb753-2552" title="2552"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;hs_cp_q&quot;</span>, <span class="st">&quot;locm_sad0&quot;</span>, <span class="st">&quot;locm_sad1&quot;</span>,  <span class="st">&quot;locm_sad2&quot;</span>),</a>
<a class="sourceLine" id="cb753-2553" title="2553">    <span class="dt">colorNA=</span><span class="st">&quot;grey95&quot;</span>, <span class="dt">textNA=</span><span class="st">&quot;Not </span><span class="ch">\&quot;</span><span class="st">interesting</span><span class="ch">\&quot;</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb753-2554" title="2554">    <span class="dt">title=</span><span class="st">&quot;Turnout hotspot status</span><span class="ch">\n</span><span class="st">Local Moran&#39;s I&quot;</span>,</a>
<a class="sourceLine" id="cb753-2555" title="2555">    <span class="dt">palette=</span>RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="dv">4</span>, <span class="st">&quot;Set3&quot;</span>)[<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">2</span>)]) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-2556" title="2556"><span class="st">    </span><span class="kw">tm_facets</span>(<span class="dt">free.scales =</span> <span class="ot">FALSE</span>, <span class="dt">ncol =</span> <span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb753-2557" title="2557">        <span class="st">&quot;Permutation rank&quot;</span>,</a>
<a class="sourceLine" id="cb753-2558" title="2558">        <span class="st">&quot;Saddlepoint null&quot;</span>,</a>
<a class="sourceLine" id="cb753-2559" title="2559">        <span class="st">&quot;Saddlepoint weighted null&quot;</span>,</a>
<a class="sourceLine" id="cb753-2560" title="2560">        <span class="st">&quot;Saddlepoint weighted types&quot;</span>))</a>
<a class="sourceLine" id="cb753-2561" title="2561"><span class="kw">rbind</span>(<span class="dt">null=</span><span class="kw">append</span>(<span class="kw">table</span>(<span class="kw">addNA</span>(pol_pres15<span class="op">$</span>locm_sad0)), <span class="kw">c</span>(<span class="st">&quot;Low-High&quot;</span>=<span class="dv">0</span>), <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb753-2562" title="2562">    <span class="dt">weighted=</span><span class="kw">append</span>(<span class="kw">table</span>(<span class="kw">addNA</span>(pol_pres15<span class="op">$</span>locm_sad1)), <span class="kw">c</span>(<span class="st">&quot;Low-High&quot;</span>=<span class="dv">0</span>), <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb753-2563" title="2563">    <span class="dt">type_weighted=</span><span class="kw">table</span>(<span class="kw">addNA</span>(pol_pres15<span class="op">$</span>locm_sad2)))</a>
<a class="sourceLine" id="cb753-2564" title="2564"><span class="kw">invisible</span>(spdep<span class="op">::</span><span class="kw">set.coresOption</span>(<span class="kw">ifelse</span>(<span class="kw">detectCores</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="kw">detectCores</span>()<span class="op">-</span>1L)))</a>
<a class="sourceLine" id="cb753-2565" title="2565"><span class="kw">system.time</span>(lm_types <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">localmoran.exact</span>(<span class="dt">nb =</span> nb_q, <span class="dt">style =</span> <span class="st">&quot;W&quot;</span>, </a>
<a class="sourceLine" id="cb753-2566" title="2566">    <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>, <span class="dt">useTP=</span><span class="ot">TRUE</span>, <span class="dt">truncErr=</span><span class="fl">1e-8</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2567" title="2567"><span class="st">        </span><span class="kw">as.data.frame</span>() -&gt;<span class="st"> </span>locm_ex_types)</a>
<a class="sourceLine" id="cb753-2568" title="2568">pol_pres15<span class="op">$</span>locm_ex &lt;-<span class="st"> </span>quadr</a>
<a class="sourceLine" id="cb753-2569" title="2569"><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>locm_ex) &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(locm_ex_types[, <span class="st">&quot;Pr. (exact)&quot;</span>], <span class="st">&quot;fdr&quot;</span>) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.005</span></a>
<a class="sourceLine" id="cb753-2570" title="2570">pol_pres15<span class="op">$</span>locm_ex &lt;-<span class="st"> </span><span class="kw">droplevels</span>(pol_pres15<span class="op">$</span>locm_ex)</a>
<a class="sourceLine" id="cb753-2571" title="2571"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;locm_sad2&quot;</span>, <span class="st">&quot;locm_ex&quot;</span>),</a>
<a class="sourceLine" id="cb753-2572" title="2572">    <span class="dt">colorNA=</span><span class="st">&quot;grey95&quot;</span>, <span class="dt">textNA=</span><span class="st">&quot;Not </span><span class="ch">\&quot;</span><span class="st">interesting</span><span class="ch">\&quot;</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb753-2573" title="2573">    <span class="dt">title=</span><span class="st">&quot;Turnout hotspot status</span><span class="ch">\n</span><span class="st">Local Moran&#39;s I&quot;</span>,</a>
<a class="sourceLine" id="cb753-2574" title="2574">    <span class="dt">palette=</span>RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="dv">4</span>, <span class="st">&quot;Set3&quot;</span>)[<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>)]) <span class="op">+</span></a>
<a class="sourceLine" id="cb753-2575" title="2575"><span class="st">    </span><span class="kw">tm_facets</span>(<span class="dt">free.scales =</span> <span class="ot">FALSE</span>, <span class="dt">ncol =</span> <span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb753-2576" title="2576">        <span class="st">&quot;Saddlepoint weighted types&quot;</span>,</a>
<a class="sourceLine" id="cb753-2577" title="2577">        <span class="st">&quot;Exact weighted types&quot;</span>))</a>
<a class="sourceLine" id="cb753-2578" title="2578"><span class="kw">table</span>(<span class="dt">Saddlepoint=</span><span class="kw">addNA</span>(pol_pres15<span class="op">$</span>locm_sad2), <span class="dt">exact=</span><span class="kw">addNA</span>(pol_pres15<span class="op">$</span>locm_ex))</a>
<a class="sourceLine" id="cb753-2579" title="2579"><span class="kw">system.time</span>(I_turnout <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2580" title="2580"><span class="st">        </span><span class="kw">localG</span>(lw_q_W, <span class="dt">return_internals=</span><span class="ot">TRUE</span>) -&gt;<span class="st"> </span>locG)</a>
<a class="sourceLine" id="cb753-2581" title="2581"><span class="kw">invisible</span>(spdep<span class="op">::</span><span class="kw">set.coresOption</span>(<span class="kw">ifelse</span>(<span class="kw">detectCores</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="kw">detectCores</span>()<span class="op">-</span>1L)))</a>
<a class="sourceLine" id="cb753-2582" title="2582"><span class="kw">system.time</span>(I_turnout <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2583" title="2583"><span class="st">        </span><span class="kw">localG_perm</span>(lw_q_W, <span class="dt">nsim =</span> <span class="dv">9999</span>, <span class="dt">iseed =</span> <span class="dv">1</span>) -&gt;<span class="st"> </span>locG_p)</a>
<a class="sourceLine" id="cb753-2584" title="2584"><span class="kw">cor</span>(<span class="kw">cbind</span>(<span class="dt">localG=</span><span class="kw">attr</span>(locG, <span class="st">&quot;internals&quot;</span>)[, <span class="st">&quot;Pr(z != E(Gi))&quot;</span>], </a>
<a class="sourceLine" id="cb753-2585" title="2585">    <span class="kw">attr</span>(locG_p, <span class="st">&quot;internals&quot;</span>)[, <span class="kw">c</span>(<span class="st">&quot;Pr(z != E(Gi))&quot;</span>, <span class="st">&quot;Pr(z != E(Gi)) Sim&quot;</span>)]))</a>
<a class="sourceLine" id="cb753-2586" title="2586"><span class="kw">invisible</span>(spdep<span class="op">::</span><span class="kw">set.coresOption</span>(<span class="kw">ifelse</span>(<span class="kw">detectCores</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="kw">detectCores</span>()<span class="op">-</span>1L)))</a>
<a class="sourceLine" id="cb753-2587" title="2587"><span class="kw">system.time</span>(I_turnout <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2588" title="2588"><span class="st">        </span><span class="kw">localC_perm</span>(lw_q_W, <span class="dt">nsim=</span><span class="dv">9999</span>, <span class="dt">iseed=</span><span class="dv">1</span>) -&gt;<span class="st"> </span>locC_p)</a>
<a class="sourceLine" id="cb753-2589" title="2589"><span class="kw">cor</span>(<span class="kw">attr</span>(locC_p, <span class="st">&quot;pseudo-p&quot;</span>)[, <span class="kw">c</span>(<span class="st">&quot;Pr(z != E(Ci))&quot;</span>, <span class="st">&quot;Pr(z != E(Ci)) Sim&quot;</span>)])</a>
<a class="sourceLine" id="cb753-2590" title="2590">pol_pres15<span class="op">$</span>hs_C &lt;-<span class="st"> </span><span class="kw">attr</span>(locC_p, <span class="st">&quot;cluster&quot;</span>)</a>
<a class="sourceLine" id="cb753-2591" title="2591"><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>hs_C) &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(<span class="kw">attr</span>(locC_p, <span class="st">&quot;pseudo-p&quot;</span>)[,<span class="st">&quot;Pr(z != E(Ci)) Sim&quot;</span>], <span class="st">&quot;fdr&quot;</span>) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.005</span></a>
<a class="sourceLine" id="cb753-2592" title="2592">pol_pres15<span class="op">$</span>hs_C &lt;-<span class="st"> </span><span class="kw">droplevels</span>(pol_pres15<span class="op">$</span>hs_C)</a>
<a class="sourceLine" id="cb753-2593" title="2593">pol_pres15<span class="op">$</span>hs_G &lt;-<span class="st"> </span><span class="kw">cut</span>(I_turnout, <span class="kw">c</span>(<span class="op">-</span><span class="ot">Inf</span>, <span class="kw">mean</span>(I_turnout), <span class="ot">Inf</span>), </a>
<a class="sourceLine" id="cb753-2594" title="2594">    <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;Low&quot;</span>, <span class="st">&quot;High&quot;</span>))</a>
<a class="sourceLine" id="cb753-2595" title="2595"><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>hs_G) &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(<span class="kw">attr</span>(locG_p, <span class="st">&quot;internals&quot;</span>)[,<span class="st">&quot;Pr(z != E(Gi))&quot;</span>], <span class="st">&quot;fdr&quot;</span>) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.005</span></a>
<a class="sourceLine" id="cb753-2596" title="2596">pol_pres15<span class="op">$</span>hs_G &lt;-<span class="st"> </span><span class="kw">droplevels</span>(pol_pres15<span class="op">$</span>hs_G)</a>
<a class="sourceLine" id="cb753-2597" title="2597">m1 &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;hs_cp_q&quot;</span>, <span class="dt">palette=</span>RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="dv">4</span>,</a>
<a class="sourceLine" id="cb753-2598" title="2598">    <span class="st">&quot;Set3&quot;</span>)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>)], <span class="dt">colorNA=</span><span class="st">&quot;grey95&quot;</span>, <span class="dt">textNA=</span><span class="st">&quot;Not </span><span class="ch">\&quot;</span><span class="st">interesting</span><span class="ch">\&quot;</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb753-2599" title="2599">    <span class="dt">title=</span><span class="st">&quot;Turnout hotspot status</span><span class="ch">\n</span><span class="st">Local Moran I&quot;</span>)</a>
<a class="sourceLine" id="cb753-2600" title="2600">m2 &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;hs_G&quot;</span>, <span class="dt">palette=</span>RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="dv">4</span>,</a>
<a class="sourceLine" id="cb753-2601" title="2601">    <span class="st">&quot;Set3&quot;</span>)[<span class="op">-</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>)], <span class="dt">colorNA=</span><span class="st">&quot;grey95&quot;</span>, <span class="dt">textNA=</span><span class="st">&quot;Not </span><span class="ch">\&quot;</span><span class="st">interesting</span><span class="ch">\&quot;</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb753-2602" title="2602">    <span class="dt">title=</span><span class="st">&quot;Turnout hotspot status</span><span class="ch">\n</span><span class="st">Local Getis/Ord G&quot;</span>)</a>
<a class="sourceLine" id="cb753-2603" title="2603">m3 &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;hs_C&quot;</span>, <span class="dt">palette=</span>RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="dv">4</span>,</a>
<a class="sourceLine" id="cb753-2604" title="2604">    <span class="st">&quot;Set3&quot;</span>)[<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">1</span>)], <span class="dt">colorNA=</span><span class="st">&quot;grey95&quot;</span>, <span class="dt">textNA=</span><span class="st">&quot;Not </span><span class="ch">\&quot;</span><span class="st">interesting</span><span class="ch">\&quot;</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb753-2605" title="2605">    <span class="dt">title=</span><span class="st">&quot;Turnout hotspot status</span><span class="ch">\n</span><span class="st">Local Geary C&quot;</span>)</a>
<a class="sourceLine" id="cb753-2606" title="2606"><span class="kw">tmap_arrange</span>(m1, m2, m3, <span class="dt">nrow=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-2607" title="2607"><span class="kw">invisible</span>(spdep<span class="op">::</span><span class="kw">set.coresOption</span>(<span class="kw">ifelse</span>(<span class="kw">detectCores</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="kw">detectCores</span>()<span class="op">-</span>1L)))</a>
<a class="sourceLine" id="cb753-2608" title="2608"><span class="kw">system.time</span>(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2609" title="2609"><span class="st">        </span><span class="kw">st_drop_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2610" title="2610"><span class="st">        </span><span class="kw">subset</span>(<span class="dt">select =</span> II_turnout) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2611" title="2611"><span class="st">        </span><span class="kw">localC_perm</span>(lw_q_W, <span class="dt">nsim=</span><span class="dv">9999</span>, <span class="dt">iseed=</span><span class="dv">1</span>) -&gt;<span class="st"> </span>locC_p_II)</a>
<a class="sourceLine" id="cb753-2612" title="2612">pol_pres15<span class="op">$</span>hs_C_II &lt;-<span class="st"> </span><span class="kw">attr</span>(locC_p_II, <span class="st">&quot;cluster&quot;</span>)</a>
<a class="sourceLine" id="cb753-2613" title="2613"><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>hs_C_II) &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(<span class="kw">attr</span>(locC_p_II, <span class="st">&quot;pseudo-p&quot;</span>)[,<span class="st">&quot;Pr(z != E(Ci)) Sim&quot;</span>], <span class="st">&quot;fdr&quot;</span>) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.005</span></a>
<a class="sourceLine" id="cb753-2614" title="2614">pol_pres15<span class="op">$</span>hs_C_II &lt;-<span class="st"> </span><span class="kw">droplevels</span>(pol_pres15<span class="op">$</span>hs_C_II)</a>
<a class="sourceLine" id="cb753-2615" title="2615"><span class="kw">invisible</span>(spdep<span class="op">::</span><span class="kw">set.coresOption</span>(<span class="kw">ifelse</span>(<span class="kw">detectCores</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="kw">detectCores</span>()<span class="op">-</span>1L)))</a>
<a class="sourceLine" id="cb753-2616" title="2616"><span class="kw">system.time</span>(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2617" title="2617"><span class="st">        </span><span class="kw">st_drop_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2618" title="2618"><span class="st">        </span><span class="kw">subset</span>(<span class="dt">select =</span> <span class="kw">c</span>(I_turnout, II_turnout)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-2619" title="2619"><span class="st">        </span><span class="kw">localC_perm</span>(lw_q_W, <span class="dt">nsim=</span><span class="dv">9999</span>, <span class="dt">iseed=</span><span class="dv">1</span>) -&gt;<span class="st"> </span>locMvC_p)</a>
<a class="sourceLine" id="cb753-2620" title="2620"><span class="kw">all.equal</span>(locMvC_p, (locC_p<span class="op">+</span>locC_p_II)<span class="op">/</span><span class="dv">2</span>, <span class="dt">check.attributes=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2621" title="2621">pol_pres15<span class="op">$</span>hs_MvC &lt;-<span class="st"> </span><span class="kw">attr</span>(locMvC_p, <span class="st">&quot;cluster&quot;</span>)</a>
<a class="sourceLine" id="cb753-2622" title="2622"><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>hs_MvC) &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(<span class="kw">attr</span>(locMvC_p, <span class="st">&quot;pseudo-p&quot;</span>)[,<span class="st">&quot;Pr(z != E(Ci)) Sim&quot;</span>], <span class="st">&quot;fdr&quot;</span>) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.005</span></a>
<a class="sourceLine" id="cb753-2623" title="2623">pol_pres15<span class="op">$</span>hs_MvC &lt;-<span class="st"> </span><span class="kw">droplevels</span>(pol_pres15<span class="op">$</span>hs_MvC)</a>
<a class="sourceLine" id="cb753-2624" title="2624">m3 &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;hs_C&quot;</span>, <span class="dt">palette=</span>RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="dv">4</span>,</a>
<a class="sourceLine" id="cb753-2625" title="2625">    <span class="st">&quot;Set3&quot;</span>)[<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">1</span>)], <span class="dt">colorNA=</span><span class="st">&quot;grey95&quot;</span>, <span class="dt">textNA=</span><span class="st">&quot;Not </span><span class="ch">\&quot;</span><span class="st">interesting</span><span class="ch">\&quot;</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb753-2626" title="2626">    <span class="dt">title=</span><span class="st">&quot;First round turnout</span><span class="ch">\n</span><span class="st">Local Geary C&quot;</span>)</a>
<a class="sourceLine" id="cb753-2627" title="2627">m4 &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;hs_C_II&quot;</span>, <span class="dt">palette=</span>RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="dv">4</span>,</a>
<a class="sourceLine" id="cb753-2628" title="2628">    <span class="st">&quot;Set3&quot;</span>)[<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>)], <span class="dt">colorNA=</span><span class="st">&quot;grey95&quot;</span>, <span class="dt">textNA=</span><span class="st">&quot;Not </span><span class="ch">\&quot;</span><span class="st">interesting</span><span class="ch">\&quot;</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb753-2629" title="2629">    <span class="dt">title=</span><span class="st">&quot;Second round turnout</span><span class="ch">\n</span><span class="st">Local Geary C&quot;</span>)</a>
<a class="sourceLine" id="cb753-2630" title="2630">m5 &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;hs_MvC&quot;</span>, <span class="dt">palette=</span>RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="dv">4</span>,</a>
<a class="sourceLine" id="cb753-2631" title="2631">    <span class="st">&quot;Set3&quot;</span>)[<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">1</span>)], <span class="dt">colorNA=</span><span class="st">&quot;grey95&quot;</span>, <span class="dt">textNA=</span><span class="st">&quot;Not </span><span class="ch">\&quot;</span><span class="st">interesting</span><span class="ch">\&quot;</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb753-2632" title="2632">    <span class="dt">title=</span><span class="st">&quot;Both rounds turnout</span><span class="ch">\n</span><span class="st">Local Multivariate Geary C&quot;</span>)</a>
<a class="sourceLine" id="cb753-2633" title="2633"><span class="kw">tmap_arrange</span>(m3, m4, m5, <span class="dt">nrow=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-2634" title="2634"><span class="kw">table</span>(<span class="kw">droplevels</span>(<span class="kw">interaction</span>(<span class="kw">addNA</span>(pol_pres15<span class="op">$</span>hs_C), <span class="kw">addNA</span>(pol_pres15<span class="op">$</span>hs_C_II), <span class="dt">sep=</span><span class="st">&quot;:&quot;</span>)), <span class="kw">addNA</span>(pol_pres15<span class="op">$</span>hs_MvC))</a>
<a class="sourceLine" id="cb753-2635" title="2635"><span class="kw">library</span>(rgeoda)</a>
<a class="sourceLine" id="cb753-2636" title="2636"><span class="kw">system.time</span>(Geoda_w &lt;-<span class="st"> </span><span class="kw">queen_weights</span>(pol_pres15))</a>
<a class="sourceLine" id="cb753-2637" title="2637"><span class="kw">summary</span>(Geoda_w)</a>
<a class="sourceLine" id="cb753-2638" title="2638"><span class="kw">system.time</span>(lisa &lt;-<span class="st"> </span><span class="kw">local_multigeary</span>(Geoda_w, </a>
<a class="sourceLine" id="cb753-2639" title="2639">    pol_pres15[<span class="kw">c</span>(<span class="st">&quot;I_turnout&quot;</span>, <span class="st">&quot;II_turnout&quot;</span>)], </a>
<a class="sourceLine" id="cb753-2640" title="2640">    <span class="dt">cpu_threads =</span> <span class="kw">ifelse</span>(parallel<span class="op">::</span><span class="kw">detectCores</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, parallel<span class="op">::</span><span class="kw">detectCores</span>()<span class="op">-</span>1L),</a>
<a class="sourceLine" id="cb753-2641" title="2641">    <span class="dt">permutations =</span> <span class="dv">99999</span>, <span class="dt">seed =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb753-2642" title="2642"><span class="kw">all.equal</span>(<span class="kw">card</span>(nb_q), <span class="kw">lisa_num_nbrs</span>(lisa), <span class="dt">check.attributes =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2643" title="2643"><span class="kw">all.equal</span>(<span class="kw">lisa_values</span>(lisa), <span class="kw">c</span>(locMvC_p), <span class="dt">check.attributes =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2644" title="2644"><span class="kw">apply</span>(<span class="kw">attr</span>(locMvC_p, <span class="st">&quot;pseudo-p&quot;</span>)[,<span class="kw">c</span>(<span class="st">&quot;Pr(z != E(Ci)) Sim&quot;</span>, <span class="st">&quot;Pr(folded) Sim&quot;</span>)], <span class="dv">2</span>, range)</a>
<a class="sourceLine" id="cb753-2645" title="2645">hs_MvCa &lt;-<span class="st"> </span><span class="kw">attr</span>(locMvC_p, <span class="st">&quot;cluster&quot;</span>)</a>
<a class="sourceLine" id="cb753-2646" title="2646"><span class="kw">is.na</span>(hs_MvCa) &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(<span class="kw">attr</span>(locMvC_p, <span class="st">&quot;pseudo-p&quot;</span>)[,<span class="st">&quot;Pr(folded) Sim&quot;</span>], <span class="st">&quot;fdr&quot;</span>) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.0025</span></a>
<a class="sourceLine" id="cb753-2647" title="2647">pol_pres15<span class="op">$</span>hs_MvCa &lt;-<span class="st"> </span><span class="kw">droplevels</span>(hs_MvCa)</a>
<a class="sourceLine" id="cb753-2648" title="2648">mvc &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">lisa_clusters</span>(lisa), <span class="dt">levels=</span><span class="dv">0</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">labels=</span><span class="kw">lisa_labels</span>(lisa)[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</a>
<a class="sourceLine" id="cb753-2649" title="2649"><span class="kw">is.na</span>(mvc) &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(<span class="kw">lisa_pvalues</span>(lisa), <span class="st">&quot;fdr&quot;</span>) <span class="op">&gt;=</span><span class="st"> </span><span class="fl">0.0025</span></a>
<a class="sourceLine" id="cb753-2650" title="2650">pol_pres15<span class="op">$</span>geoda_mvc &lt;-<span class="st"> </span><span class="kw">droplevels</span>(mvc)</a>
<a class="sourceLine" id="cb753-2651" title="2651"><span class="kw">addmargins</span>(<span class="kw">table</span>(<span class="dt">spdep=</span><span class="kw">addNA</span>(pol_pres15<span class="op">$</span>hs_MvCa), <span class="dt">rgeoda=</span><span class="kw">addNA</span>(pol_pres15<span class="op">$</span>geoda_mvc)))</a>
<a class="sourceLine" id="cb753-2652" title="2652">m5 &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;hs_MvCa&quot;</span>, <span class="dt">palette=</span>RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="dv">4</span>,</a>
<a class="sourceLine" id="cb753-2653" title="2653">    <span class="st">&quot;Set3&quot;</span>)[<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">1</span>)], <span class="dt">colorNA=</span><span class="st">&quot;grey95&quot;</span>, <span class="dt">textNA=</span><span class="st">&quot;Not </span><span class="ch">\&quot;</span><span class="st">interesting</span><span class="ch">\&quot;</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb753-2654" title="2654">    <span class="dt">title=</span><span class="st">&quot;Both rounds turnout (spdep)</span><span class="ch">\n</span><span class="st">Local Multivariate Geary C&quot;</span>)</a>
<a class="sourceLine" id="cb753-2655" title="2655">m6 &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;geoda_mvc&quot;</span>, <span class="dt">palette=</span>RColorBrewer<span class="op">::</span><span class="kw">brewer.pal</span>(<span class="dv">4</span>,</a>
<a class="sourceLine" id="cb753-2656" title="2656">    <span class="st">&quot;Set3&quot;</span>)[<span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">1</span>)], <span class="dt">colorNA=</span><span class="st">&quot;grey95&quot;</span>, <span class="dt">textNA=</span><span class="st">&quot;Not </span><span class="ch">\&quot;</span><span class="st">interesting</span><span class="ch">\&quot;</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb753-2657" title="2657">    <span class="dt">title=</span><span class="st">&quot;Both rounds turnout (rgeoda)</span><span class="ch">\n</span><span class="st">Local Multivariate Geary C&quot;</span>)</a>
<a class="sourceLine" id="cb753-2658" title="2658"><span class="kw">tmap_arrange</span>(m5, m6, <span class="dt">nrow=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb753-2659" title="2659"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-2660" title="2660"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-2661" title="2661"></a>
<a class="sourceLine" id="cb753-2662" title="2662">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-2663" title="2663">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-2664" title="2664">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-2665" title="2665">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-2666" title="2666"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-2667" title="2667">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-2668" title="2668"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-2669" title="2669"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-2670" title="2670"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-2671" title="2671">)</a>
<a class="sourceLine" id="cb753-2672" title="2672"></a>
<a class="sourceLine" id="cb753-2673" title="2673"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-2674" title="2674"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-2675" title="2675">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2676" title="2676"></a>
<a class="sourceLine" id="cb753-2677" title="2677"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-2678" title="2678"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-2679" title="2679"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-2680" title="2680">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-2681" title="2681">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-2682" title="2682">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(<span class="dt">echo =</span> <span class="ot">TRUE</span>, <span class="dt">paged.print =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2683" title="2683"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-2684" title="2684"><span class="kw">library</span>(spData)</a>
<a class="sourceLine" id="cb753-2685" title="2685">boston_<span class="dv">506</span> &lt;-<span class="st"> </span><span class="kw">st_read</span>(<span class="kw">system.file</span>(<span class="st">&quot;shapes/boston_tracts.shp&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;spData&quot;</span>)[<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb753-2686" title="2686">nb_q &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">506</span>)</a>
<a class="sourceLine" id="cb753-2687" title="2687">lw_q &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q, <span class="dt">style =</span> <span class="st">&quot;W&quot;</span>)</a>
<a class="sourceLine" id="cb753-2688" title="2688"><span class="kw">table</span>(boston_<span class="dv">506</span><span class="op">$</span>censored)</a>
<a class="sourceLine" id="cb753-2689" title="2689"><span class="kw">summary</span>(boston_<span class="dv">506</span><span class="op">$</span>median)</a>
<a class="sourceLine" id="cb753-2690" title="2690">boston_<span class="dv">506</span><span class="op">$</span>CHAS &lt;-<span class="st"> </span><span class="kw">as.factor</span>(boston_<span class="dv">506</span><span class="op">$</span>CHAS)</a>
<a class="sourceLine" id="cb753-2691" title="2691">boston_<span class="dv">489</span> &lt;-<span class="st"> </span>boston_<span class="dv">506</span>[<span class="op">!</span><span class="kw">is.na</span>(boston_<span class="dv">506</span><span class="op">$</span>median),]</a>
<a class="sourceLine" id="cb753-2692" title="2692">nb_q_<span class="dv">489</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">489</span>)</a>
<a class="sourceLine" id="cb753-2693" title="2693">lw_q_<span class="dv">489</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">489</span>, <span class="dt">style =</span> <span class="st">&quot;W&quot;</span>, <span class="dt">zero.policy =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-2694" title="2694">agg_<span class="dv">96</span> &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">as.character</span>(boston_<span class="dv">506</span><span class="op">$</span>NOX_ID))</a>
<a class="sourceLine" id="cb753-2695" title="2695">boston_<span class="dv">96</span> &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">506</span>[, <span class="st">&quot;NOX_ID&quot;</span>], <span class="dt">by =</span> agg_<span class="dv">96</span>, unique)</a>
<a class="sourceLine" id="cb753-2696" title="2696">nb_q_<span class="dv">96</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">96</span>)</a>
<a class="sourceLine" id="cb753-2697" title="2697">lw_q_<span class="dv">96</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">96</span>)</a>
<a class="sourceLine" id="cb753-2698" title="2698">boston_<span class="dv">96</span><span class="op">$</span>NOX &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">506</span><span class="op">$</span>NOX, agg_<span class="dv">96</span>, mean)<span class="op">$</span>x</a>
<a class="sourceLine" id="cb753-2699" title="2699">boston_<span class="dv">96</span><span class="op">$</span>CHAS &lt;-<span class="st"> </span><span class="kw">aggregate</span>(<span class="kw">as.integer</span>(boston_<span class="dv">506</span><span class="op">$</span>CHAS)<span class="op">-</span><span class="dv">1</span>, agg_<span class="dv">96</span>, max)<span class="op">$</span>x</a>
<a class="sourceLine" id="cb753-2700" title="2700">nms &lt;-<span class="st"> </span><span class="kw">names</span>(boston_<span class="dv">506</span>)</a>
<a class="sourceLine" id="cb753-2701" title="2701">ccounts &lt;-<span class="st"> </span><span class="dv">23</span><span class="op">:</span><span class="dv">31</span></a>
<a class="sourceLine" id="cb753-2702" title="2702"><span class="cf">for</span> (nm <span class="cf">in</span> nms[<span class="kw">c</span>(<span class="dv">22</span>, ccounts, <span class="dv">36</span>)]) {</a>
<a class="sourceLine" id="cb753-2703" title="2703">  boston_<span class="dv">96</span>[[nm]] &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">506</span>[[nm]], agg_<span class="dv">96</span>, sum)<span class="op">$</span>x</a>
<a class="sourceLine" id="cb753-2704" title="2704">}</a>
<a class="sourceLine" id="cb753-2705" title="2705">br2 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">3.50</span>, <span class="fl">6.25</span>, <span class="fl">8.75</span>, <span class="fl">12.50</span>, <span class="fl">17.50</span>, <span class="fl">22.50</span>, <span class="fl">30.00</span>, <span class="fl">42.50</span>, <span class="fl">60.00</span>)<span class="op">*</span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb753-2706" title="2706">counts &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(boston_<span class="dv">96</span>)[, nms[ccounts]]</a>
<a class="sourceLine" id="cb753-2707" title="2707">f &lt;-<span class="st"> </span><span class="cf">function</span>(x) matrixStats<span class="op">::</span><span class="kw">weightedMedian</span>(<span class="dt">x =</span> br2, <span class="dt">w =</span> x, <span class="dt">interpolate =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-2708" title="2708">boston_<span class="dv">96</span><span class="op">$</span>median &lt;-<span class="st"> </span><span class="kw">apply</span>(counts, <span class="dv">1</span>, f)</a>
<a class="sourceLine" id="cb753-2709" title="2709"><span class="kw">is.na</span>(boston_<span class="dv">96</span><span class="op">$</span>median) &lt;-<span class="st"> </span>boston_<span class="dv">96</span><span class="op">$</span>median <span class="op">&gt;</span><span class="st"> </span><span class="dv">50000</span></a>
<a class="sourceLine" id="cb753-2710" title="2710"><span class="kw">summary</span>(boston_<span class="dv">96</span><span class="op">$</span>median)</a>
<a class="sourceLine" id="cb753-2711" title="2711">POP &lt;-<span class="st"> </span>boston_<span class="dv">506</span><span class="op">$</span>POP</a>
<a class="sourceLine" id="cb753-2712" title="2712">f &lt;-<span class="st"> </span><span class="cf">function</span>(x) matrixStats<span class="op">::</span><span class="kw">weightedMean</span>(x[,<span class="dv">1</span>], x[,<span class="dv">2</span>])</a>
<a class="sourceLine" id="cb753-2713" title="2713"><span class="cf">for</span> (nm <span class="cf">in</span> nms[<span class="kw">c</span>(<span class="dv">9</span><span class="op">:</span><span class="dv">11</span>, <span class="dv">14</span><span class="op">:</span><span class="dv">19</span>, <span class="dv">21</span>, <span class="dv">33</span>)]) {</a>
<a class="sourceLine" id="cb753-2714" title="2714">  s0 &lt;-<span class="st"> </span><span class="kw">split</span>(<span class="kw">data.frame</span>(boston_<span class="dv">506</span>[[nm]], POP), agg_<span class="dv">96</span>)</a>
<a class="sourceLine" id="cb753-2715" title="2715">  boston_<span class="dv">96</span>[[nm]] &lt;-<span class="st"> </span><span class="kw">sapply</span>(s0, f)</a>
<a class="sourceLine" id="cb753-2716" title="2716">}</a>
<a class="sourceLine" id="cb753-2717" title="2717">boston_<span class="dv">94</span> &lt;-<span class="st"> </span>boston_<span class="dv">96</span>[<span class="op">!</span><span class="kw">is.na</span>(boston_<span class="dv">96</span><span class="op">$</span>median),]</a>
<a class="sourceLine" id="cb753-2718" title="2718">nb_q_<span class="dv">94</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">subset.nb</span>(nb_q_<span class="dv">96</span>, <span class="op">!</span><span class="kw">is.na</span>(boston_<span class="dv">96</span><span class="op">$</span>median))</a>
<a class="sourceLine" id="cb753-2719" title="2719">lw_q_<span class="dv">94</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">94</span>, <span class="dt">style=</span><span class="st">&quot;W&quot;</span>)</a>
<a class="sourceLine" id="cb753-2720" title="2720">boston_94a &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">489</span>[,<span class="st">&quot;NOX_ID&quot;</span>], <span class="kw">list</span>(boston_<span class="dv">489</span><span class="op">$</span>NOX_ID), unique)</a>
<a class="sourceLine" id="cb753-2721" title="2721">nb_q_94a &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_94a)</a>
<a class="sourceLine" id="cb753-2722" title="2722">NOX_ID_no_neighs &lt;-<span class="st"> </span>boston_94a<span class="op">$</span>NOX_ID[<span class="kw">which</span>(spdep<span class="op">::</span><span class="kw">card</span>(nb_q_94a) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)]</a>
<a class="sourceLine" id="cb753-2723" title="2723">boston_<span class="dv">487</span> &lt;-<span class="st"> </span>boston_<span class="dv">489</span>[<span class="kw">is.na</span>(<span class="kw">match</span>(boston_<span class="dv">489</span><span class="op">$</span>NOX_ID, NOX_ID_no_neighs)),]</a>
<a class="sourceLine" id="cb753-2724" title="2724">boston_<span class="dv">93</span> &lt;-<span class="st"> </span><span class="kw">aggregate</span>(boston_<span class="dv">487</span>[, <span class="st">&quot;NOX_ID&quot;</span>], <span class="kw">list</span>(<span class="dt">ids =</span> boston_<span class="dv">487</span><span class="op">$</span>NOX_ID), unique)</a>
<a class="sourceLine" id="cb753-2725" title="2725"><span class="kw">row.names</span>(boston_<span class="dv">93</span>) &lt;-<span class="st"> </span><span class="kw">as.character</span>(boston_<span class="dv">93</span><span class="op">$</span>NOX_ID)</a>
<a class="sourceLine" id="cb753-2726" title="2726">nb_q_<span class="dv">93</span> &lt;-<span class="st"> </span>spdep<span class="op">::</span><span class="kw">poly2nb</span>(boston_<span class="dv">93</span>, <span class="dt">row.names=</span><span class="kw">unique</span>(<span class="kw">as.character</span>(boston_<span class="dv">93</span><span class="op">$</span>NOX_ID)))</a>
<a class="sourceLine" id="cb753-2727" title="2727">form &lt;-<span class="st"> </span><span class="kw">formula</span>(<span class="kw">log</span>(median) <span class="op">~</span><span class="st"> </span>CRIM <span class="op">+</span><span class="st"> </span>ZN <span class="op">+</span><span class="st"> </span>INDUS <span class="op">+</span><span class="st"> </span>CHAS <span class="op">+</span><span class="st"> </span><span class="kw">I</span>((NOX<span class="op">*</span><span class="dv">10</span>)<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(RM<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2728" title="2728"><span class="st">                  </span>AGE <span class="op">+</span><span class="st"> </span><span class="kw">log</span>(DIS) <span class="op">+</span><span class="st"> </span><span class="kw">log</span>(RAD) <span class="op">+</span><span class="st"> </span>TAX <span class="op">+</span><span class="st"> </span>PTRATIO <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(BB<span class="op">/</span><span class="dv">100</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2729" title="2729"><span class="st">                  </span><span class="kw">log</span>(<span class="kw">I</span>(LSTAT<span class="op">/</span><span class="dv">100</span>)))</a>
<a class="sourceLine" id="cb753-2730" title="2730"><span class="kw">library</span>(Matrix)</a>
<a class="sourceLine" id="cb753-2731" title="2731"><span class="kw">library</span>(lme4)</a>
<a class="sourceLine" id="cb753-2732" title="2732">MLM &lt;-<span class="st"> </span><span class="kw">lmer</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>NOX_ID)), <span class="dt">data =</span> boston_<span class="dv">487</span>, <span class="dt">REML =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2733" title="2733">boston_<span class="dv">93</span><span class="op">$</span>MLM_re &lt;-<span class="st"> </span><span class="kw">ranef</span>(MLM)[[<span class="dv">1</span>]][,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb753-2734" title="2734"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(hglm))</a>
<a class="sourceLine" id="cb753-2735" title="2735"><span class="kw">suppressWarnings</span>(HGLM_iid &lt;-<span class="st"> </span><span class="kw">hglm</span>(<span class="dt">fixed =</span> form, <span class="dt">random =</span> <span class="op">~</span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>NOX_ID, <span class="dt">data =</span> boston_<span class="dv">487</span>,</a>
<a class="sourceLine" id="cb753-2736" title="2736">    <span class="dt">family =</span> <span class="kw">gaussian</span>()))</a>
<a class="sourceLine" id="cb753-2737" title="2737">boston_<span class="dv">93</span><span class="op">$</span>HGLM_re &lt;-<span class="st"> </span><span class="kw">unname</span>(HGLM_iid<span class="op">$</span>ranef)</a>
<a class="sourceLine" id="cb753-2738" title="2738">W &lt;-<span class="st"> </span><span class="kw">as</span>(spdep<span class="op">::</span><span class="kw">nb2listw</span>(nb_q_<span class="dv">93</span>, <span class="dt">style =</span> <span class="st">&quot;B&quot;</span>), <span class="st">&quot;CsparseMatrix&quot;</span>)</a>
<a class="sourceLine" id="cb753-2739" title="2739"><span class="kw">suppressWarnings</span>(HGLM_car &lt;-<span class="st"> </span><span class="kw">hglm</span>(<span class="dt">fixed =</span> form, <span class="dt">random =</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>NOX_ID, <span class="dt">data =</span> boston_<span class="dv">487</span>,</a>
<a class="sourceLine" id="cb753-2740" title="2740">    <span class="dt">family =</span> <span class="kw">gaussian</span>(), <span class="dt">rand.family =</span> <span class="kw">CAR</span>(<span class="dt">D=</span>W)))</a>
<a class="sourceLine" id="cb753-2741" title="2741">boston_<span class="dv">93</span><span class="op">$</span>HGLM_ss &lt;-<span class="st"> </span>HGLM_car<span class="op">$</span>ranef[,<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb753-2742" title="2742"><span class="kw">library</span>(HSAR)</a>
<a class="sourceLine" id="cb753-2743" title="2743"><span class="kw">library</span>(MatrixModels, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2744" title="2744">Z &lt;-<span class="st"> </span><span class="kw">as</span>(<span class="kw">model.Matrix</span>(<span class="op">~</span><span class="st"> </span><span class="dv">-1</span> <span class="op">+</span><span class="st"> </span><span class="kw">as.factor</span>(NOX_ID), <span class="dt">data =</span> boston_<span class="dv">487</span>, <span class="dt">sparse =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb753-2745" title="2745">    <span class="st">&quot;dgCMatrix&quot;</span>)</a>
<a class="sourceLine" id="cb753-2746" title="2746"><span class="kw">set.seed</span>(<span class="dv">123</span>)</a>
<a class="sourceLine" id="cb753-2747" title="2747"><span class="kw">suppressWarnings</span>(HSAR_ss &lt;-<span class="st"> </span><span class="kw">hsar</span>(form, <span class="dt">data=</span>boston_<span class="dv">487</span>, <span class="dt">W =</span> <span class="ot">NULL</span>, <span class="dt">M =</span> W, <span class="dt">Delta =</span> Z, </a>
<a class="sourceLine" id="cb753-2748" title="2748">                              <span class="dt">burnin =</span> <span class="dv">2000</span>, <span class="dt">Nsim =</span> <span class="dv">12000</span>, <span class="dt">thinning =</span> <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb753-2749" title="2749">boston_<span class="dv">93</span><span class="op">$</span>HSAR_ss &lt;-<span class="st"> </span>HSAR_ss<span class="op">$</span>Mus[<span class="dv">1</span>,]</a>
<a class="sourceLine" id="cb753-2750" title="2750"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(R2BayesX))</a>
<a class="sourceLine" id="cb753-2751" title="2751">BX_iid &lt;-<span class="st"> </span><span class="kw">bayesx</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">sx</span>(NOX_ID, <span class="dt">bs =</span> <span class="st">&quot;re&quot;</span>)), <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span>,</a>
<a class="sourceLine" id="cb753-2752" title="2752">    <span class="dt">data =</span> boston_<span class="dv">487</span>, <span class="dt">method =</span> <span class="st">&quot;MCMC&quot;</span>, <span class="dt">iterations =</span> <span class="dv">12000</span>, <span class="dt">burnin =</span> <span class="dv">2000</span>, <span class="dt">step =</span> <span class="dv">2</span>, <span class="dt">seed =</span> <span class="dv">123</span>)</a>
<a class="sourceLine" id="cb753-2753" title="2753">boston_<span class="dv">93</span><span class="op">$</span>BX_re &lt;-<span class="st"> </span>BX_iid<span class="op">$</span>effects[<span class="st">&quot;sx(NOX_ID):re&quot;</span>][[<span class="dv">1</span>]]<span class="op">$</span>Mean</a>
<a class="sourceLine" id="cb753-2754" title="2754">RBX_gra &lt;-<span class="st"> </span><span class="kw">nb2gra</span>(nb_q_<span class="dv">93</span>)</a>
<a class="sourceLine" id="cb753-2755" title="2755"><span class="kw">all.equal</span>(<span class="kw">row.names</span>(RBX_gra), <span class="kw">attr</span>(nb_q_<span class="dv">93</span>, <span class="st">&quot;region.id&quot;</span>))</a>
<a class="sourceLine" id="cb753-2756" title="2756"><span class="kw">all.equal</span>(<span class="kw">unname</span>(<span class="kw">diag</span>(RBX_gra)), spdep<span class="op">::</span><span class="kw">card</span>(nb_q_<span class="dv">93</span>))</a>
<a class="sourceLine" id="cb753-2757" title="2757">BX_mrf &lt;-<span class="st"> </span><span class="kw">bayesx</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">sx</span>(NOX_ID, <span class="dt">bs =</span> <span class="st">&quot;mrf&quot;</span>, <span class="dt">map =</span> RBX_gra)), </a>
<a class="sourceLine" id="cb753-2758" title="2758">                 <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">data =</span> boston_<span class="dv">487</span>, <span class="dt">method =</span> <span class="st">&quot;MCMC&quot;</span>, </a>
<a class="sourceLine" id="cb753-2759" title="2759">                 <span class="dt">iterations =</span> <span class="dv">12000</span>, <span class="dt">burnin =</span> <span class="dv">2000</span>, <span class="dt">step =</span> <span class="dv">2</span>, <span class="dt">seed =</span> <span class="dv">123</span>)</a>
<a class="sourceLine" id="cb753-2760" title="2760">boston_<span class="dv">93</span><span class="op">$</span>BX_ss &lt;-<span class="st"> </span>BX_mrf<span class="op">$</span>effects[<span class="st">&quot;sx(NOX_ID):mrf&quot;</span>][[<span class="dv">1</span>]]<span class="op">$</span>Mean</a>
<a class="sourceLine" id="cb753-2761" title="2761"><span class="kw">suppressPackageStartupMessages</span>(<span class="kw">library</span>(INLA))</a>
<a class="sourceLine" id="cb753-2762" title="2762">INLA_iid &lt;-<span class="st"> </span><span class="kw">inla</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">f</span>(NOX_ID, <span class="dt">model =</span> <span class="st">&quot;iid&quot;</span>)), <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span>, </a>
<a class="sourceLine" id="cb753-2763" title="2763">    <span class="dt">data =</span> boston_<span class="dv">487</span>)</a>
<a class="sourceLine" id="cb753-2764" title="2764">boston_<span class="dv">93</span><span class="op">$</span>INLA_re &lt;-<span class="st"> </span>INLA_iid<span class="op">$</span>summary.random<span class="op">$</span>NOX_ID<span class="op">$</span>mean</a>
<a class="sourceLine" id="cb753-2765" title="2765">ID2 &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">as.factor</span>(boston_<span class="dv">487</span><span class="op">$</span>NOX_ID))</a>
<a class="sourceLine" id="cb753-2766" title="2766">INLA_ss &lt;-<span class="st"> </span><span class="kw">inla</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">f</span>(ID2, <span class="dt">model =</span> <span class="st">&quot;besag&quot;</span>, <span class="dt">graph =</span> W)), <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span>,</a>
<a class="sourceLine" id="cb753-2767" title="2767">    <span class="dt">data =</span> boston_<span class="dv">487</span>)</a>
<a class="sourceLine" id="cb753-2768" title="2768">boston_<span class="dv">93</span><span class="op">$</span>INLA_ss &lt;-<span class="st"> </span>INLA_ss<span class="op">$</span>summary.random<span class="op">$</span>ID2<span class="op">$</span>mean</a>
<a class="sourceLine" id="cb753-2769" title="2769">M &lt;-<span class="st"> </span><span class="kw">Diagonal</span>(<span class="kw">nrow</span>(W), <span class="kw">rowSums</span>(W)) <span class="op">-</span><span class="st"> </span>W</a>
<a class="sourceLine" id="cb753-2770" title="2770">Cmatrix &lt;-<span class="st"> </span><span class="kw">Diagonal</span>(<span class="kw">nrow</span>(M), <span class="dv">1</span>) <span class="op">-</span><span class="st">  </span>M</a>
<a class="sourceLine" id="cb753-2771" title="2771">INLA_lr &lt;-<span class="st"> </span><span class="kw">inla</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">f</span>(ID2, <span class="dt">model =</span> <span class="st">&quot;generic1&quot;</span>, <span class="dt">Cmatrix =</span> Cmatrix)),</a>
<a class="sourceLine" id="cb753-2772" title="2772">    <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">data =</span> boston_<span class="dv">487</span>)</a>
<a class="sourceLine" id="cb753-2773" title="2773">boston_<span class="dv">93</span><span class="op">$</span>INLA_lr &lt;-<span class="st"> </span>INLA_lr<span class="op">$</span>summary.random<span class="op">$</span>ID2<span class="op">$</span>mean</a>
<a class="sourceLine" id="cb753-2774" title="2774"><span class="kw">library</span>(mgcv)</a>
<a class="sourceLine" id="cb753-2775" title="2775"><span class="kw">names</span>(nb_q_<span class="dv">93</span>) &lt;-<span class="st"> </span><span class="kw">attr</span>(nb_q_<span class="dv">93</span>, <span class="st">&quot;region.id&quot;</span>)</a>
<a class="sourceLine" id="cb753-2776" title="2776">boston_<span class="dv">487</span><span class="op">$</span>NOX_ID &lt;-<span class="st"> </span><span class="kw">as.factor</span>(boston_<span class="dv">487</span><span class="op">$</span>NOX_ID)</a>
<a class="sourceLine" id="cb753-2777" title="2777">GAM_MRF &lt;-<span class="st"> </span><span class="kw">gam</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(NOX_ID, <span class="dt">bs =</span> <span class="st">&quot;mrf&quot;</span>, <span class="dt">xt =</span> <span class="kw">list</span>(<span class="dt">nb =</span> nb_q_<span class="dv">93</span>))),</a>
<a class="sourceLine" id="cb753-2778" title="2778">               <span class="dt">data =</span> boston_<span class="dv">487</span>, <span class="dt">method =</span> <span class="st">&quot;REML&quot;</span>)</a>
<a class="sourceLine" id="cb753-2779" title="2779">ssre &lt;-<span class="st"> </span><span class="kw">predict</span>(GAM_MRF, <span class="dt">type =</span> <span class="st">&quot;terms&quot;</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>)[, <span class="st">&quot;s(NOX_ID)&quot;</span>]</a>
<a class="sourceLine" id="cb753-2780" title="2780"><span class="kw">all</span>(<span class="kw">sapply</span>(<span class="kw">tapply</span>(ssre, <span class="kw">list</span>(boston_<span class="dv">487</span><span class="op">$</span>NOX_ID), c), <span class="cf">function</span>(x) <span class="kw">length</span>(<span class="kw">unique</span>(x)) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb753-2781" title="2781">boston_<span class="dv">93</span><span class="op">$</span>GAM_ss &lt;-<span class="st"> </span><span class="kw">aggregate</span>(ssre, <span class="kw">list</span>(boston_<span class="dv">487</span><span class="op">$</span>NOX_ID), head, <span class="dt">n=</span><span class="dv">1</span>)<span class="op">$</span>x</a>
<a class="sourceLine" id="cb753-2782" title="2782"><span class="kw">library</span>(tmap, <span class="dt">warn.conflicts=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2783" title="2783"><span class="kw">tm_shape</span>(boston_<span class="dv">93</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;MLM_re&quot;</span>, <span class="st">&quot;HGLM_re&quot;</span>, <span class="st">&quot;INLA_re&quot;</span>, <span class="st">&quot;BX_re&quot;</span>), <span class="dt">midpoint =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb753-2784" title="2784">    <span class="dt">title =</span> <span class="st">&quot;IID&quot;</span>)  <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">free.scales =</span> <span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_borders</span>(<span class="dt">lwd =</span> <span class="fl">0.3</span>, <span class="dt">alpha =</span> <span class="fl">0.4</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2785" title="2785"><span class="st">    </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels =</span> <span class="kw">c</span>(<span class="st">&quot;lmer&quot;</span>, <span class="st">&quot;hglm&quot;</span>, <span class="st">&quot;inla&quot;</span>, <span class="st">&quot;bayesx&quot;</span>))</a>
<a class="sourceLine" id="cb753-2786" title="2786"><span class="kw">tm_shape</span>(boston_<span class="dv">93</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;HGLM_ss&quot;</span>, <span class="st">&quot;HSAR_ss&quot;</span>, <span class="st">&quot;INLA_lr&quot;</span>, <span class="st">&quot;INLA_ss&quot;</span>, <span class="st">&quot;BX_ss&quot;</span>,</a>
<a class="sourceLine" id="cb753-2787" title="2787">    <span class="st">&quot;GAM_ss&quot;</span>), <span class="dt">midpoint =</span> <span class="dv">0</span>, <span class="dt">title =</span> <span class="st">&quot;SSRE&quot;</span>)  <span class="op">+</span><span class="st"> </span><span class="kw">tm_facets</span>(<span class="dt">free.scales =</span> <span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb753-2788" title="2788"><span class="st">    </span><span class="kw">tm_borders</span>(<span class="dt">lwd =</span> <span class="fl">0.3</span>, <span class="dt">alpha =</span> <span class="fl">0.4</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels =</span> <span class="kw">c</span>(<span class="st">&quot;hglm CAR&quot;</span>, <span class="st">&quot;hsar SAR&quot;</span>,</a>
<a class="sourceLine" id="cb753-2789" title="2789">        <span class="st">&quot;inla Leroux&quot;</span>, <span class="st">&quot;inla ICAR&quot;</span>, <span class="st">&quot;bayesx ICAR&quot;</span>, <span class="st">&quot;gam ICAR&quot;</span>))</a>
<a class="sourceLine" id="cb753-2790" title="2790"><span class="kw">library</span>(spatialreg)</a>
<a class="sourceLine" id="cb753-2791" title="2791">eigs_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">eigenw</span>(lw_q_<span class="dv">489</span>)</a>
<a class="sourceLine" id="cb753-2792" title="2792">SDEM_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data =</span> boston_<span class="dv">489</span>, <span class="dt">listw =</span> lw_q_<span class="dv">489</span>, <span class="dt">Durbin =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb753-2793" title="2793">                       <span class="dt">zero.policy =</span> <span class="ot">TRUE</span>, <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">pre_eig =</span> eigs_<span class="dv">489</span>))</a>
<a class="sourceLine" id="cb753-2794" title="2794">SEM_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data =</span> boston_<span class="dv">489</span>, <span class="dt">listw =</span> lw_q_<span class="dv">489</span>, </a>
<a class="sourceLine" id="cb753-2795" title="2795">                      <span class="dt">zero.policy =</span> <span class="ot">TRUE</span>, <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">pre_eig =</span> eigs_<span class="dv">489</span>))</a>
<a class="sourceLine" id="cb753-2796" title="2796"><span class="kw">cbind</span>(<span class="kw">data.frame</span>(<span class="dt">model=</span><span class="kw">c</span>(<span class="st">&quot;SEM&quot;</span>, <span class="st">&quot;SDEM&quot;</span>)), </a>
<a class="sourceLine" id="cb753-2797" title="2797">      <span class="kw">rbind</span>(broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">Hausman.test</span>(SEM_<span class="dv">489</span>)), </a>
<a class="sourceLine" id="cb753-2798" title="2798">            broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">Hausman.test</span>(SDEM_<span class="dv">489</span>))))[,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</a>
<a class="sourceLine" id="cb753-2799" title="2799">eigs_<span class="dv">94</span> &lt;-<span class="st"> </span><span class="kw">eigenw</span>(lw_q_<span class="dv">94</span>)</a>
<a class="sourceLine" id="cb753-2800" title="2800">SDEM_<span class="dv">94</span> &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>, <span class="dt">Durbin=</span><span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-2801" title="2801">                      <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">pre_eig=</span>eigs_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb753-2802" title="2802">SEM_<span class="dv">94</span> &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data=</span>boston_<span class="dv">94</span>, <span class="dt">listw=</span>lw_q_<span class="dv">94</span>, <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">pre_eig=</span>eigs_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb753-2803" title="2803"><span class="kw">cbind</span>(<span class="kw">data.frame</span>(<span class="dt">model=</span><span class="kw">c</span>(<span class="st">&quot;SEM&quot;</span>, <span class="st">&quot;SDEM&quot;</span>)), </a>
<a class="sourceLine" id="cb753-2804" title="2804">      <span class="kw">rbind</span>(broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">Hausman.test</span>(SEM_<span class="dv">94</span>)), </a>
<a class="sourceLine" id="cb753-2805" title="2805">            broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">Hausman.test</span>(SDEM_<span class="dv">94</span>))))[, <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</a>
<a class="sourceLine" id="cb753-2806" title="2806"><span class="kw">cbind</span>(<span class="kw">data.frame</span>(<span class="dt">model=</span><span class="kw">c</span>(<span class="st">&quot;SEM&quot;</span>, <span class="st">&quot;SDEM&quot;</span>)), <span class="kw">rbind</span>(broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">LR1.Sarlm</span>(SEM_<span class="dv">94</span>)),</a>
<a class="sourceLine" id="cb753-2807" title="2807">    broom<span class="op">::</span><span class="kw">tidy</span>(<span class="kw">LR1.Sarlm</span>(SDEM_<span class="dv">94</span>))))[,<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">4</span><span class="op">:</span><span class="dv">6</span>)]</a>
<a class="sourceLine" id="cb753-2808" title="2808">broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SEM_<span class="dv">489</span>, SDEM_<span class="dv">489</span>))</a>
<a class="sourceLine" id="cb753-2809" title="2809">broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SEM_<span class="dv">94</span>, SDEM_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb753-2810" title="2810">SLX_<span class="dv">489</span> &lt;-<span class="st"> </span><span class="kw">lmSLX</span>(form, <span class="dt">data =</span> boston_<span class="dv">489</span>, <span class="dt">listw =</span> lw_q_<span class="dv">489</span>, <span class="dt">zero.policy =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-2811" title="2811">broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SLX_<span class="dv">489</span>, SDEM_<span class="dv">489</span>))</a>
<a class="sourceLine" id="cb753-2812" title="2812">SLX_<span class="dv">94</span> &lt;-<span class="st"> </span><span class="kw">lmSLX</span>(form, <span class="dt">data =</span> boston_<span class="dv">94</span>, <span class="dt">listw =</span> lw_q_<span class="dv">94</span>)</a>
<a class="sourceLine" id="cb753-2813" title="2813">broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SLX_<span class="dv">94</span>, SDEM_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb753-2814" title="2814">SLX_489w &lt;-<span class="st"> </span><span class="kw">lmSLX</span>(form, <span class="dt">data =</span> boston_<span class="dv">489</span>, <span class="dt">listw =</span> lw_q_<span class="dv">489</span>, <span class="dt">weights =</span> units, <span class="dt">zero.policy =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-2815" title="2815">SDEM_489w &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data =</span> boston_<span class="dv">489</span>, <span class="dt">listw =</span> lw_q_<span class="dv">489</span>, <span class="dt">Durbin  =</span><span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-2816" title="2816">    <span class="dt">weights =</span> units, <span class="dt">zero.policy =</span> <span class="ot">TRUE</span>, <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">pre_eig =</span> eigs_<span class="dv">489</span>))</a>
<a class="sourceLine" id="cb753-2817" title="2817">broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SLX_489w, SDEM_489w))</a>
<a class="sourceLine" id="cb753-2818" title="2818">SLX_94w &lt;-<span class="st"> </span><span class="kw">lmSLX</span>(form, <span class="dt">data =</span> boston_<span class="dv">94</span>, <span class="dt">listw =</span> lw_q_<span class="dv">94</span>, <span class="dt">weights =</span> units)</a>
<a class="sourceLine" id="cb753-2819" title="2819">SDEM_94w &lt;-<span class="st"> </span><span class="kw">errorsarlm</span>(form, <span class="dt">data =</span> boston_<span class="dv">94</span>, <span class="dt">listw =</span> lw_q_<span class="dv">94</span>, <span class="dt">Durbin =</span> <span class="ot">TRUE</span>, <span class="dt">weights =</span> units,</a>
<a class="sourceLine" id="cb753-2820" title="2820">                       <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">pre_eig =</span> eigs_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb753-2821" title="2821">broom<span class="op">::</span><span class="kw">tidy</span>(lmtest<span class="op">::</span><span class="kw">lrtest</span>(SLX_94w, SDEM_94w))</a>
<a class="sourceLine" id="cb753-2822" title="2822">sum_imp_<span class="dv">94</span>_SDEM &lt;-<span class="st"> </span><span class="kw">summary</span>(<span class="kw">impacts</span>(SDEM_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb753-2823" title="2823"><span class="kw">rbind</span>(<span class="dt">Impacts =</span> sum_imp_<span class="dv">94</span>_SDEM<span class="op">$</span>mat[<span class="dv">5</span>,], <span class="dt">SE =</span> sum_imp_<span class="dv">94</span>_SDEM<span class="op">$</span>semat[<span class="dv">5</span>,])</a>
<a class="sourceLine" id="cb753-2824" title="2824">sum_imp_<span class="dv">94</span>_SLX &lt;-<span class="st"> </span><span class="kw">summary</span>(<span class="kw">impacts</span>(SLX_<span class="dv">94</span>))</a>
<a class="sourceLine" id="cb753-2825" title="2825"><span class="kw">rbind</span>(<span class="dt">Impacts =</span> sum_imp_<span class="dv">94</span>_SLX<span class="op">$</span>mat[<span class="dv">5</span>,], <span class="dt">SE =</span> sum_imp_<span class="dv">94</span>_SLX<span class="op">$</span>semat[<span class="dv">5</span>,])</a>
<a class="sourceLine" id="cb753-2826" title="2826">sum_imp_<span class="dv">94</span>_SDEMw &lt;-<span class="st"> </span><span class="kw">summary</span>(<span class="kw">impacts</span>(SDEM_94w))</a>
<a class="sourceLine" id="cb753-2827" title="2827"><span class="kw">rbind</span>(<span class="dt">Impacts =</span> sum_imp_<span class="dv">94</span>_SDEMw<span class="op">$</span>mat[<span class="dv">5</span>,], <span class="dt">SE =</span> sum_imp_<span class="dv">94</span>_SDEMw<span class="op">$</span>semat[<span class="dv">5</span>,])</a>
<a class="sourceLine" id="cb753-2828" title="2828">sum_imp_<span class="dv">94</span>_SLXw &lt;-<span class="st"> </span><span class="kw">summary</span>(<span class="kw">impacts</span>(SLX_94w))</a>
<a class="sourceLine" id="cb753-2829" title="2829"><span class="kw">rbind</span>(<span class="dt">Impacts =</span> sum_imp_<span class="dv">94</span>_SLXw<span class="op">$</span>mat[<span class="dv">5</span>,], <span class="dt">SE =</span> sum_imp_<span class="dv">94</span>_SLXw<span class="op">$</span>semat[<span class="dv">5</span>,])</a>
<a class="sourceLine" id="cb753-2830" title="2830">nd &lt;-<span class="st"> </span>boston_<span class="dv">506</span>[<span class="kw">is.na</span>(boston_<span class="dv">506</span><span class="op">$</span>median),]</a>
<a class="sourceLine" id="cb753-2831" title="2831">t0 &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">predict</span>(SDEM_<span class="dv">489</span>, <span class="dt">newdata =</span> nd, <span class="dt">listw =</span> lw_q, <span class="dt">pred.type =</span> <span class="st">&quot;TS&quot;</span>, <span class="dt">zero.policy  =</span><span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb753-2832" title="2832"><span class="kw">suppressWarnings</span>(t1  &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">predict</span>(SDEM_<span class="dv">489</span>, <span class="dt">newdata =</span> nd, <span class="dt">listw =</span> lw_q, <span class="dt">pred.type =</span> <span class="st">&quot;KP2&quot;</span>,</a>
<a class="sourceLine" id="cb753-2833" title="2833">                                    <span class="dt">zero.policy =</span> <span class="ot">TRUE</span>)))</a>
<a class="sourceLine" id="cb753-2834" title="2834"><span class="kw">suppressWarnings</span>(t2  &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">predict</span>(SDEM_<span class="dv">489</span>, <span class="dt">newdata =</span> nd, <span class="dt">listw =</span> lw_q, <span class="dt">pred.type =</span> <span class="st">&quot;KP5&quot;</span>,</a>
<a class="sourceLine" id="cb753-2835" title="2835">                                    <span class="dt">zero.policy =</span> <span class="ot">TRUE</span>)))</a>
<a class="sourceLine" id="cb753-2836" title="2836"><span class="kw">library</span>(INLA)</a>
<a class="sourceLine" id="cb753-2837" title="2837">W &lt;-<span class="st"> </span><span class="kw">as</span>(lw_q, <span class="st">&quot;CsparseMatrix&quot;</span>)</a>
<a class="sourceLine" id="cb753-2838" title="2838">n &lt;-<span class="st"> </span><span class="kw">nrow</span>(W)</a>
<a class="sourceLine" id="cb753-2839" title="2839">e &lt;-<span class="st"> </span><span class="kw">eigenw</span>(lw_q)</a>
<a class="sourceLine" id="cb753-2840" title="2840">re.idx &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">abs</span>(<span class="kw">Im</span>(e)) <span class="op">&lt;</span><span class="st"> </span><span class="fl">1e-6</span>)</a>
<a class="sourceLine" id="cb753-2841" title="2841">rho.max &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">/</span><span class="kw">max</span>(<span class="kw">Re</span>(e[re.idx]))</a>
<a class="sourceLine" id="cb753-2842" title="2842">rho.min &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">/</span><span class="kw">min</span>(<span class="kw">Re</span>(e[re.idx]))</a>
<a class="sourceLine" id="cb753-2843" title="2843">rho &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">c</span>(rho.min, rho.max))</a>
<a class="sourceLine" id="cb753-2844" title="2844">boston_<span class="dv">506</span><span class="op">$</span>idx &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span>n</a>
<a class="sourceLine" id="cb753-2845" title="2845">zero.variance =<span class="st"> </span><span class="kw">list</span>(<span class="dt">prec=</span><span class="kw">list</span>(<span class="dt">initial =</span> <span class="dv">25</span>, <span class="dt">fixed =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb753-2846" title="2846">args.slm &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">rho.min =</span> rho.min, <span class="dt">rho.max =</span> rho.max, <span class="dt">W =</span> W, <span class="dt">X =</span> <span class="kw">matrix</span>(<span class="dv">0</span>, n, <span class="dv">0</span>),</a>
<a class="sourceLine" id="cb753-2847" title="2847">    <span class="dt">Q.beta =</span> <span class="kw">matrix</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb753-2848" title="2848">hyper.slm &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">prec =</span> <span class="kw">list</span>(<span class="dt">prior =</span> <span class="st">&quot;loggamma&quot;</span>, <span class="dt">param =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="fl">0.01</span>)),</a>
<a class="sourceLine" id="cb753-2849" title="2849">    <span class="dt">rho =</span> <span class="kw">list</span>(<span class="dt">initial =</span> <span class="dv">0</span>, <span class="dt">prior =</span> <span class="st">&quot;logitbeta&quot;</span>, <span class="dt">param =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)))</a>
<a class="sourceLine" id="cb753-2850" title="2850">WX &lt;-<span class="st"> </span><span class="kw">create_WX</span>(<span class="kw">model.matrix</span>(<span class="kw">update</span>(form, CMEDV <span class="op">~</span><span class="st"> </span>.), <span class="dt">data=</span>boston_<span class="dv">506</span>), lw_q)</a>
<a class="sourceLine" id="cb753-2851" title="2851">SDEM_<span class="dv">506</span>_slm &lt;-<span class="st"> </span><span class="kw">inla</span>(<span class="kw">update</span>(form, . <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span>WX <span class="op">+</span><span class="st"> </span><span class="kw">f</span>(idx, <span class="dt">model =</span> <span class="st">&quot;slm&quot;</span>, <span class="dt">args.slm =</span> args.slm,</a>
<a class="sourceLine" id="cb753-2852" title="2852">    <span class="dt">hyper =</span> hyper.slm)), <span class="dt">data =</span> boston_<span class="dv">506</span>, <span class="dt">family =</span> <span class="st">&quot;gaussian&quot;</span>, <span class="dt">control.family =</span> </a>
<a class="sourceLine" id="cb753-2853" title="2853">        <span class="kw">list</span>(<span class="dt">hyper =</span> zero.variance), <span class="dt">control.compute =</span> <span class="kw">list</span>(<span class="dt">dic =</span> <span class="ot">TRUE</span>, <span class="dt">cpo =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb753-2854" title="2854">mvs &lt;-<span class="st"> </span>SDEM_<span class="dv">506</span>_slm<span class="op">$</span>marginals.fitted.values[<span class="kw">which</span>(<span class="kw">is.na</span>(boston_<span class="dv">506</span><span class="op">$</span>median))]</a>
<a class="sourceLine" id="cb753-2855" title="2855">mv_mean &lt;-<span class="st"> </span><span class="kw">sapply</span>(mvs, <span class="cf">function</span>(x) <span class="kw">mean</span>(<span class="kw">exp</span>(x[, <span class="dv">1</span>]), ))</a>
<a class="sourceLine" id="cb753-2856" title="2856">mv_sd &lt;-<span class="st"> </span><span class="kw">sapply</span>(mvs, <span class="cf">function</span>(x) <span class="kw">sd</span>(<span class="kw">exp</span>(x[, <span class="dv">1</span>])))</a>
<a class="sourceLine" id="cb753-2857" title="2857"><span class="kw">data.frame</span>(<span class="dt">fit_TS =</span> t0[,<span class="dv">1</span>], <span class="dt">fit_KP2 =</span> <span class="kw">c</span>(t1), <span class="dt">fit_KP5 =</span> <span class="kw">c</span>(t2), <span class="dt">INLA_slm =</span> mv_mean,</a>
<a class="sourceLine" id="cb753-2858" title="2858">    <span class="dt">INLA_slm_sd =</span> mv_sd, <span class="dt">censored =</span> boston_<span class="dv">506</span><span class="op">$</span>censored[<span class="kw">as.integer</span>(<span class="kw">attr</span>(t0, <span class="st">&quot;region.id&quot;</span>))])</a>
<a class="sourceLine" id="cb753-2859" title="2859"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-2860" title="2860"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-2861" title="2861"></a>
<a class="sourceLine" id="cb753-2862" title="2862">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-2863" title="2863">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-2864" title="2864">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-2865" title="2865">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-2866" title="2866"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-2867" title="2867">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-2868" title="2868"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-2869" title="2869"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-2870" title="2870"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-2871" title="2871">)</a>
<a class="sourceLine" id="cb753-2872" title="2872"></a>
<a class="sourceLine" id="cb753-2873" title="2873"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-2874" title="2874"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-2875" title="2875">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2876" title="2876"></a>
<a class="sourceLine" id="cb753-2877" title="2877"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-2878" title="2878"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-2879" title="2879"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-2880" title="2880">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-2881" title="2881">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-2882" title="2882"><span class="kw">library</span>(sp)</a>
<a class="sourceLine" id="cb753-2883" title="2883">y =<span class="st"> </span><span class="kw">as</span>(x, <span class="st">&quot;Spatial&quot;</span>)</a>
<a class="sourceLine" id="cb753-2884" title="2884">x0 =<span class="st"> </span><span class="kw">st_as_sf</span>(y)</a>
<a class="sourceLine" id="cb753-2885" title="2885">x =<span class="st"> </span><span class="kw">as</span>(sf<span class="op">::</span><span class="kw">read_sf</span>(<span class="st">&quot;file&quot;</span>), <span class="st">&quot;Spatial&quot;</span>)</a>
<a class="sourceLine" id="cb753-2886" title="2886"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-2887" title="2887"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-2888" title="2888"></a>
<a class="sourceLine" id="cb753-2889" title="2889">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-2890" title="2890">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-2891" title="2891">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-2892" title="2892">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-2893" title="2893"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-2894" title="2894">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-2895" title="2895"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-2896" title="2896"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-2897" title="2897"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-2898" title="2898">)</a>
<a class="sourceLine" id="cb753-2899" title="2899"></a>
<a class="sourceLine" id="cb753-2900" title="2900"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-2901" title="2901"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-2902" title="2902">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2903" title="2903"></a>
<a class="sourceLine" id="cb753-2904" title="2904"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-2905" title="2905"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-2906" title="2906"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-2907" title="2907">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-2908" title="2908">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-2909" title="2909"><span class="co"># All R code in this book {-}</span></a>
<a class="sourceLine" id="cb753-2910" title="2910"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-2911" title="2911"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-2912" title="2912"></a>
<a class="sourceLine" id="cb753-2913" title="2913">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-2914" title="2914">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-2915" title="2915">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-2916" title="2916">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-2917" title="2917"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-2918" title="2918">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-2919" title="2919"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-2920" title="2920"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-2921" title="2921"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-2922" title="2922">)</a>
<a class="sourceLine" id="cb753-2923" title="2923"></a>
<a class="sourceLine" id="cb753-2924" title="2924"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-2925" title="2925"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-2926" title="2926">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2927" title="2927"></a>
<a class="sourceLine" id="cb753-2928" title="2928"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-2929" title="2929"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-2930" title="2930"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-2931" title="2931">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-2932" title="2932">    <span class="co">#options(width = 72)</span></a>
<a class="sourceLine" id="cb753-2933" title="2933">a <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">b</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">c</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">d</span>(<span class="dt">n =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb753-2934" title="2934"><span class="kw">d</span>(<span class="kw">c</span>(<span class="kw">b</span>(a)), <span class="dt">n =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb753-2935" title="2935">tmp1 &lt;-<span class="st"> </span><span class="kw">b</span>(a)</a>
<a class="sourceLine" id="cb753-2936" title="2936">tmp2 &lt;-<span class="st"> </span><span class="kw">c</span>(tmp1)</a>
<a class="sourceLine" id="cb753-2937" title="2937">tmp3 &lt;-<span class="st"> </span><span class="kw">d</span>(tmp2, <span class="dt">n =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb753-2938" title="2938"><span class="kw">typeof</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb753-2939" title="2939"><span class="kw">length</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb753-2940" title="2940"><span class="kw">typeof</span>(<span class="fl">1.0</span>)</a>
<a class="sourceLine" id="cb753-2941" title="2941"><span class="kw">length</span>(<span class="fl">1.0</span>)</a>
<a class="sourceLine" id="cb753-2942" title="2942"><span class="kw">typeof</span>(<span class="kw">c</span>(<span class="st">&quot;foo&quot;</span>, <span class="st">&quot;bar&quot;</span>))</a>
<a class="sourceLine" id="cb753-2943" title="2943"><span class="kw">length</span>(<span class="kw">c</span>(<span class="st">&quot;foo&quot;</span>, <span class="st">&quot;bar&quot;</span>))</a>
<a class="sourceLine" id="cb753-2944" title="2944"><span class="kw">typeof</span>(<span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb753-2945" title="2945">i =<span class="st"> </span><span class="kw">integer</span>(<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb753-2946" title="2946"><span class="kw">typeof</span>(i)</a>
<a class="sourceLine" id="cb753-2947" title="2947">i</a>
<a class="sourceLine" id="cb753-2948" title="2948"><span class="kw">length</span>(i)</a>
<a class="sourceLine" id="cb753-2949" title="2949">a =<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-2950" title="2950">a[<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb753-2951" title="2951">a[[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb753-2952" title="2952">a[<span class="dv">2</span><span class="op">:</span><span class="dv">3</span>]</a>
<a class="sourceLine" id="cb753-2953" title="2953">a[<span class="dv">2</span><span class="op">:</span><span class="dv">3</span>] =<span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-2954" title="2954">a</a>
<a class="sourceLine" id="cb753-2955" title="2955">a[[<span class="dv">3</span>]] =<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb753-2956" title="2956">a</a>
<a class="sourceLine" id="cb753-2957" title="2957">l &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dv">3</span>, <span class="ot">TRUE</span>, <span class="st">&quot;foo&quot;</span>)</a>
<a class="sourceLine" id="cb753-2958" title="2958"><span class="kw">typeof</span>(l)</a>
<a class="sourceLine" id="cb753-2959" title="2959"><span class="kw">length</span>(l)</a>
<a class="sourceLine" id="cb753-2960" title="2960">l[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb753-2961" title="2961">l[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb753-2962" title="2962">l[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>] =<span class="st"> </span><span class="kw">list</span>(<span class="dv">4</span>, <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-2963" title="2963">l</a>
<a class="sourceLine" id="cb753-2964" title="2964">l[[<span class="dv">3</span>]] =<span class="st"> &quot;bar&quot;</span></a>
<a class="sourceLine" id="cb753-2965" title="2965">l</a>
<a class="sourceLine" id="cb753-2966" title="2966">l =<span class="st"> </span><span class="kw">list</span>(<span class="dt">first =</span> <span class="dv">3</span>, <span class="dt">second =</span> <span class="ot">TRUE</span>, <span class="dt">third =</span> <span class="st">&quot;foo&quot;</span>)</a>
<a class="sourceLine" id="cb753-2967" title="2967">l</a>
<a class="sourceLine" id="cb753-2968" title="2968">l<span class="op">$</span>second</a>
<a class="sourceLine" id="cb753-2969" title="2969">l<span class="op">$</span>second =<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb753-2970" title="2970">l</a>
<a class="sourceLine" id="cb753-2971" title="2971"><span class="dv">3</span> <span class="op">==</span><span class="st"> </span><span class="ot">NULL</span> <span class="co"># not FALSE!</span></a>
<a class="sourceLine" id="cb753-2972" title="2972"><span class="ot">NULL</span> <span class="op">==</span><span class="st"> </span><span class="ot">NULL</span> <span class="co"># not even TRUE!</span></a>
<a class="sourceLine" id="cb753-2973" title="2973"><span class="kw">is.null</span>(<span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb753-2974" title="2974">l =<span class="st"> </span>l[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)] <span class="co"># remove second, implicitly</span></a>
<a class="sourceLine" id="cb753-2975" title="2975">l</a>
<a class="sourceLine" id="cb753-2976" title="2976">l<span class="op">$</span>second =<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb753-2977" title="2977">l</a>
<a class="sourceLine" id="cb753-2978" title="2978">a =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span></a>
<a class="sourceLine" id="cb753-2979" title="2979"><span class="kw">attr</span>(a, <span class="st">&quot;some_meta_data&quot;</span>) =<span class="st"> &quot;foo&quot;</span></a>
<a class="sourceLine" id="cb753-2980" title="2980">a</a>
<a class="sourceLine" id="cb753-2981" title="2981"><span class="kw">attr</span>(a, <span class="st">&quot;some_meta_data&quot;</span>)</a>
<a class="sourceLine" id="cb753-2982" title="2982"><span class="kw">attr</span>(a, <span class="st">&quot;some_meta_data&quot;</span>) =<span class="st"> &quot;bar&quot;</span></a>
<a class="sourceLine" id="cb753-2983" title="2983"><span class="kw">attr</span>(a, <span class="st">&quot;some_meta_data&quot;</span>)</a>
<a class="sourceLine" id="cb753-2984" title="2984"><span class="kw">attributes</span>(a)</a>
<a class="sourceLine" id="cb753-2985" title="2985"><span class="kw">attributes</span>(a) =<span class="st"> </span><span class="kw">list</span>(<span class="dt">some_meta_data =</span> <span class="st">&quot;foo&quot;</span>)</a>
<a class="sourceLine" id="cb753-2986" title="2986"><span class="kw">attributes</span>(a)</a>
<a class="sourceLine" id="cb753-2987" title="2987"><span class="kw">class</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-2988" title="2988"><span class="kw">class</span>(<span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb753-2989" title="2989"><span class="kw">class</span>(<span class="kw">c</span>(<span class="st">&quot;TRUE&quot;</span>, <span class="st">&quot;FALSE&quot;</span>))</a>
<a class="sourceLine" id="cb753-2990" title="2990">a =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span></a>
<a class="sourceLine" id="cb753-2991" title="2991"><span class="kw">class</span>(a) =<span class="st"> &quot;foo&quot;</span></a>
<a class="sourceLine" id="cb753-2992" title="2992">a</a>
<a class="sourceLine" id="cb753-2993" title="2993"><span class="kw">class</span>(a)</a>
<a class="sourceLine" id="cb753-2994" title="2994"><span class="kw">attributes</span>(a)</a>
<a class="sourceLine" id="cb753-2995" title="2995">print.foo =<span class="st"> </span><span class="cf">function</span>(x, ...) <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;an object of class foo with length&quot;</span>, <span class="kw">length</span>(x)))</a>
<a class="sourceLine" id="cb753-2996" title="2996"><span class="kw">print</span>(a)</a>
<a class="sourceLine" id="cb753-2997" title="2997"><span class="kw">unclass</span>(a)</a>
<a class="sourceLine" id="cb753-2998" title="2998"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-2999" title="2999">p =<span class="st"> </span><span class="kw">st_polygon</span>(<span class="kw">list</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))))</a>
<a class="sourceLine" id="cb753-3000" title="3000">p</a>
<a class="sourceLine" id="cb753-3001" title="3001"><span class="kw">unclass</span>(p)</a>
<a class="sourceLine" id="cb753-3002" title="3002">a =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">8</span></a>
<a class="sourceLine" id="cb753-3003" title="3003"><span class="kw">class</span>(a)</a>
<a class="sourceLine" id="cb753-3004" title="3004"><span class="kw">attr</span>(a, <span class="st">&quot;dim&quot;</span>) =<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>) <span class="co"># or: dim(a) = c(2,4)</span></a>
<a class="sourceLine" id="cb753-3005" title="3005"><span class="kw">class</span>(a)</a>
<a class="sourceLine" id="cb753-3006" title="3006">a</a>
<a class="sourceLine" id="cb753-3007" title="3007"><span class="kw">attr</span>(a, <span class="st">&quot;dim&quot;</span>) =<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>) <span class="co"># or: dim(a) = c(2,2,2)</span></a>
<a class="sourceLine" id="cb753-3008" title="3008"><span class="kw">class</span>(a)</a>
<a class="sourceLine" id="cb753-3009" title="3009">a</a>
<a class="sourceLine" id="cb753-3010" title="3010">a =<span class="st"> </span><span class="kw">c</span>(<span class="dt">first =</span> <span class="dv">3</span>, <span class="dt">second =</span> <span class="dv">4</span>, <span class="dt">last =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb753-3011" title="3011">a[<span class="st">&quot;second&quot;</span>]</a>
<a class="sourceLine" id="cb753-3012" title="3012"><span class="kw">attributes</span>(a)</a>
<a class="sourceLine" id="cb753-3013" title="3013">a =<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb753-3014" title="3014"><span class="kw">dimnames</span>(a) =<span class="st"> </span><span class="kw">list</span>(<span class="dt">rows =</span> <span class="kw">c</span>(<span class="st">&quot;row1&quot;</span>, <span class="st">&quot;row2&quot;</span>), <span class="dt">cols =</span> <span class="kw">c</span>(<span class="st">&quot;col1&quot;</span>, <span class="st">&quot;col2&quot;</span>))</a>
<a class="sourceLine" id="cb753-3015" title="3015">a</a>
<a class="sourceLine" id="cb753-3016" title="3016"><span class="kw">attributes</span>(a)</a>
<a class="sourceLine" id="cb753-3017" title="3017">df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">a =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">b =</span> <span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>, <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb753-3018" title="3018"><span class="kw">attributes</span>(df)</a>
<a class="sourceLine" id="cb753-3019" title="3019">f =<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb753-3020" title="3020">   a =<span class="st"> </span><span class="kw">create_obj</span>(x) <span class="co"># call some other function</span></a>
<a class="sourceLine" id="cb753-3021" title="3021">   <span class="kw">attributes</span>(a) =<span class="st"> </span><span class="kw">list</span>(<span class="dt">class =</span> <span class="st">&quot;foo&quot;</span>, <span class="dt">meta =</span> <span class="dv">33</span>)</a>
<a class="sourceLine" id="cb753-3022" title="3022">   a</a>
<a class="sourceLine" id="cb753-3023" title="3023">}</a>
<a class="sourceLine" id="cb753-3024" title="3024">f =<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb753-3025" title="3025">   a =<span class="st"> </span><span class="kw">create_obj</span>(x) <span class="co"># call some other function</span></a>
<a class="sourceLine" id="cb753-3026" title="3026">   <span class="kw">structure</span>(a, <span class="dt">class =</span> <span class="st">&quot;foo&quot;</span>, <span class="dt">meta =</span> <span class="dv">33</span>)</a>
<a class="sourceLine" id="cb753-3027" title="3027">}</a>
<a class="sourceLine" id="cb753-3028" title="3028"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb753-3029" title="3029"><span class="kw">system.file</span>(<span class="st">&quot;gpkg/nc.gpkg&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb753-3030" title="3030"><span class="st">    </span><span class="kw">read_sf</span>() -&gt;<span class="st"> </span>nc</a>
<a class="sourceLine" id="cb753-3031" title="3031"><span class="kw">attributes</span>(nc)</a>
<a class="sourceLine" id="cb753-3032" title="3032">nc<span class="op">$</span>geom</a>
<a class="sourceLine" id="cb753-3033" title="3033"><span class="kw">attributes</span>(nc<span class="op">$</span>geom)</a>
<a class="sourceLine" id="cb753-3034" title="3034">nc<span class="op">$</span>geom[[<span class="dv">4</span>]]</a>
<a class="sourceLine" id="cb753-3035" title="3035"><span class="kw">typeof</span>(nc<span class="op">$</span>geom[[<span class="dv">4</span>]])</a>
<a class="sourceLine" id="cb753-3036" title="3036"><span class="kw">attributes</span>(nc<span class="op">$</span>geom[[<span class="dv">4</span>]])</a>
<a class="sourceLine" id="cb753-3037" title="3037"><span class="kw">length</span>(nc<span class="op">$</span>geom[[<span class="dv">4</span>]])</a>
<a class="sourceLine" id="cb753-3038" title="3038"><span class="kw">lengths</span>(nc<span class="op">$</span>geom)</a>
<a class="sourceLine" id="cb753-3039" title="3039"><span class="kw">typeof</span>(nc<span class="op">$</span>geom[[<span class="dv">4</span>]])</a>
<a class="sourceLine" id="cb753-3040" title="3040"><span class="kw">typeof</span>(nc<span class="op">$</span>geom[[<span class="dv">4</span>]][[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb753-3041" title="3041"><span class="kw">length</span>(nc<span class="op">$</span>geom[[<span class="dv">4</span>]][[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb753-3042" title="3042"><span class="kw">typeof</span>(nc<span class="op">$</span>geom[[<span class="dv">4</span>]][[<span class="dv">1</span>]][[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb753-3043" title="3043"><span class="kw">dim</span>(nc<span class="op">$</span>geom[[<span class="dv">4</span>]][[<span class="dv">1</span>]][[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb753-3044" title="3044"><span class="kw">head</span>(nc<span class="op">$</span>geom[[<span class="dv">4</span>]][[<span class="dv">1</span>]][[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb753-3045" title="3045">nc<span class="op">$</span>geom[[<span class="dv">4</span>]][[<span class="dv">1</span>]][[<span class="dv">1</span>]][<span class="dv">3</span>,<span class="dv">2</span>] =<span class="st"> </span><span class="fl">36.5</span></a>
<a class="sourceLine" id="cb753-3046" title="3046"><span class="kw">set.seed</span>(<span class="dv">1014</span>)</a>
<a class="sourceLine" id="cb753-3047" title="3047"><span class="kw">options</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb753-3048" title="3048"></a>
<a class="sourceLine" id="cb753-3049" title="3049">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(</a>
<a class="sourceLine" id="cb753-3050" title="3050">  <span class="dt">comment =</span> <span class="st">&quot;#&quot;</span>,</a>
<a class="sourceLine" id="cb753-3051" title="3051">  <span class="dt">collapse =</span> knitr<span class="op">::</span><span class="kw">is_latex_output</span>(),</a>
<a class="sourceLine" id="cb753-3052" title="3052">  <span class="dt">cache =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb753-3053" title="3053"><span class="co">#  out.width = &quot;70%&quot;,</span></a>
<a class="sourceLine" id="cb753-3054" title="3054">  <span class="dt">fig.align =</span> <span class="st">&#39;center&#39;</span></a>
<a class="sourceLine" id="cb753-3055" title="3055"><span class="co">#  fig.width = 6,</span></a>
<a class="sourceLine" id="cb753-3056" title="3056"><span class="co">#  fig.asp = 0.618,  # 1 / phi</span></a>
<a class="sourceLine" id="cb753-3057" title="3057"><span class="co">#  fig.show = &quot;hold&quot;</span></a>
<a class="sourceLine" id="cb753-3058" title="3058">)</a>
<a class="sourceLine" id="cb753-3059" title="3059"></a>
<a class="sourceLine" id="cb753-3060" title="3060"><span class="kw">options</span>(<span class="dt">dplyr.print_min =</span> <span class="dv">6</span>, <span class="dt">dplyr.print_max =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb753-3061" title="3061"><span class="kw">options</span>(<span class="dt">stars.crs =</span> <span class="dv">17</span>)</a>
<a class="sourceLine" id="cb753-3062" title="3062">mapview<span class="op">::</span><span class="kw">mapviewOptions</span>(<span class="dt">fgb =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb753-3063" title="3063"></a>
<a class="sourceLine" id="cb753-3064" title="3064"><span class="co"># for units: (?)</span></a>
<a class="sourceLine" id="cb753-3065" title="3065"><span class="kw">Sys.setenv</span>(<span class="dt">UDUNITS2_XML_PATH=</span><span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb753-3066" title="3066"><span class="cf">if</span> (knitr<span class="op">::</span><span class="kw">is_latex_output</span>())</a>
<a class="sourceLine" id="cb753-3067" title="3067">    <span class="kw">options</span>(<span class="dt">width =</span> <span class="dv">66</span>)</a>
<a class="sourceLine" id="cb753-3068" title="3068">    <span class="co">#options(width = 72)</span></a></code></pre></div>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="older.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="r-basics.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/edzer/sdsr/edit/master/97-allcode.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
