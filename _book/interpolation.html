<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 12 Spatial Interpolation | Spatial Data Science</title>
  <meta name="description" content="description_xx" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 12 Spatial Interpolation | Spatial Data Science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="description_xx" />
  <meta name="github-repo" content="edzer/sdsr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 12 Spatial Interpolation | Spatial Data Science" />
  
  <meta name="twitter:description" content="description_xx" />
  

<meta name="author" content="Edzer Pebesma, Roger Bivand" />


<meta name="date" content="2022-04-07" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="pointpatterns.html"/>
<link rel="next" href="stgeostatistics.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />

<script>
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan');
  rCodeBlocks.each(function() {

    // if code block has been labeled with class `fold-show`, show the code on init!
    var classList = $(this).attr('class').split(/\s+/);
    for (var i = 0; i < classList.length; i++) {
    if (classList[i] === 'fold-show') {
        show = true;
      }
    }

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // hack: return show to false, otherwise all next codeBlocks will be shown!
    show = false;

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<script>
/* ========================================================================
 * Bootstrap: dropdown.js v3.3.7
 * http://getbootstrap.com/javascript/#dropdowns
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // DROPDOWN CLASS DEFINITION
  // =========================

  var backdrop = '.dropdown-backdrop'
  var toggle   = '[data-toggle="dropdown"]'
  var Dropdown = function (element) {
    $(element).on('click.bs.dropdown', this.toggle)
  }

  Dropdown.VERSION = '3.3.7'

  function getParent($this) {
    var selector = $this.attr('data-target')

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7
    }

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  }

  function clearMenus(e) {
    if (e && e.which === 3) return
    $(backdrop).remove()
    $(toggle).each(function () {
      var $this         = $(this)
      var $parent       = getParent($this)
      var relatedTarget = { relatedTarget: this }

      if (!$parent.hasClass('open')) return

      if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

      $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this.attr('aria-expanded', 'false')
      $parent.removeClass('open').trigger($.Event('hidden.bs.dropdown', relatedTarget))
    })
  }

  Dropdown.prototype.toggle = function (e) {
    var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    clearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $(document.createElement('div'))
          .addClass('dropdown-backdrop')
          .insertAfter($(this))
          .on('click', clearMenus)
      }

      var relatedTarget = { relatedTarget: this }
      $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this
        .trigger('focus')
        .attr('aria-expanded', 'true')

      $parent
        .toggleClass('open')
        .trigger($.Event('shown.bs.dropdown', relatedTarget))
    }

    return false
  }

  Dropdown.prototype.keydown = function (e) {
    if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName)) return

    var $this = $(this)

    e.preventDefault()
    e.stopPropagation()

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    if (!isActive && e.which != 27 || isActive && e.which == 27) {
      if (e.which == 27) $parent.find(toggle).trigger('focus')
      return $this.trigger('click')
    }

    var desc = ' li:not(.disabled):visible a'
    var $items = $parent.find('.dropdown-menu' + desc)

    if (!$items.length) return

    var index = $items.index(e.target)

    if (e.which == 38 && index > 0)                 index--         // up
    if (e.which == 40 && index < $items.length - 1) index++         // down
    if (!~index)                                    index = 0

    $items.eq(index).trigger('focus')
  }


  // DROPDOWN PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this = $(this)
      var data  = $this.data('bs.dropdown')

      if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  var old = $.fn.dropdown

  $.fn.dropdown             = Plugin
  $.fn.dropdown.Constructor = Dropdown


  // DROPDOWN NO CONFLICT
  // ====================

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  // APPLY TO STANDARD DROPDOWN ELEMENTS
  // ===================================

  $(document)
    .on('click.bs.dropdown.data-api', clearMenus)
    .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
    .on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown)
    .on('keydown.bs.dropdown.data-api', '.dropdown-menu', Dropdown.prototype.keydown)

}(jQuery);
</script>
<style type="text/css">
.code-folding-btn {
  margin-bottom: 4px;
}

.row { display: flex; }
.collapse { display: none; }
.in { display:block }
.pull-right > .dropdown-menu {
    right: 0;
    left: auto;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    font-size: 14px;
    text-align: left;
    list-style: none;
    background-color: #fff;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    border: 1px solid #ccc;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
    box-shadow: 0 6px 12px rgba(0,0,0,.175);
}

.open > .dropdown-menu {
    display: block;
    color: #ffffff;
    background-color: #ffffff;
    background-image: none;
    border-color: #92897e;
}

.dropdown-menu > li > a {
  display: block;
  padding: 3px 20px;
  clear: both;
  font-weight: 400;
  line-height: 1.42857143;
  color: #000000;
  white-space: nowrap;
}

.dropdown-menu > li > a:hover,
.dropdown-menu > li > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
}

.dropdown-menu > .active > a,
.dropdown-menu > .active > a:hover,
.dropdown-menu > .active > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
  outline: 0;
}
.dropdown-menu > .disabled > a,
.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  color: #aea79f;
}

.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  text-decoration: none;
  cursor: not-allowed;
  background-color: transparent;
  background-image: none;
  filter: progid:DXImageTransform.Microsoft.gradient(enabled = false);
}

.btn {
  display: inline-block;
  margin-bottom: 1;
  font-weight: normal;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  -ms-touch-action: manipulation;
      touch-action: manipulation;
  cursor: pointer;
  background-image: none;
  border: 1px solid transparent;
  padding: 4px 8px;
  font-size: 14px;
  line-height: 1.42857143;
  border-radius: 4px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.btn:focus,
.btn:active:focus,
.btn.active:focus,
.btn.focus,
.btn:active.focus,
.btn.active.focus {
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px;
}
.btn:hover,
.btn:focus,
.btn.focus {
  color: #ffffff;
  text-decoration: none;
}
.btn:active,
.btn.active {
  background-image: none;
  outline: 0;
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn.disabled,
.btn[disabled],
fieldset[disabled] .btn {
  cursor: not-allowed;
  filter: alpha(opacity=65);
  opacity: 0.65;
  box-shadow: none;
}
a.btn.disabled,
fieldset[disabled] a.btn {
  pointer-events: none;
}
.btn-default {
  color: #ffffff;
  background-color: #aea79f; #important
  border-color: #aea79f;
}

.btn-default:focus,
.btn-default.focus {
  color: #ffffff;
  background-color: #978e83;
  border-color: #6f675e;
}

.btn-default:hover {
  color: #ffffff;
  background-color: #978e83;
  border-color: #92897e;
}
.btn-default:active,
.btn-default.active,
.btn-group > .btn:not(:first-child):not(:last-child):not(.dropdown-toggle) {
  border-radius: 0;
}
.btn-group > .btn:first-child {
  margin-left: 0;
}
.btn-group > .btn:first-child:not(:last-child):not(.dropdown-toggle) {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn:last-child:not(:first-child),
.btn-group > .dropdown-toggle:not(:first-child) {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group > .btn-group {
  float: left;
}
.btn-group > .btn-group:not(:first-child):not(:last-child) > .btn {
  border-radius: 0;
}
.btn-group > .btn-group:first-child:not(:last-child) > .btn:last-child,
.btn-group > .btn-group:first-child:not(:last-child) > .dropdown-toggle {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn-group:last-child:not(:first-child) > .btn:first-child {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group .dropdown-toggle:active,
.btn-group.open .dropdown-toggle {
  outline: 0;
}
.btn-group > .btn + .dropdown-toggle {
  padding-right: 8px;
  padding-left: 8px;
}
.btn-group > .btn-lg + .dropdown-toggle {
  padding-right: 12px;
  padding-left: 12px;
}
.btn-group.open .dropdown-toggle {
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn-group.open .dropdown-toggle.btn-link {
  box-shadow: none;
}

</style>
<script>
var str = '<div class="btn-group pull-right" style="position: fixed; right: 50px; top: 10px; z-index: 200"><button type="button" class="btn btn-default btn-xs dropdown-toggle" id="allCodeButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast=""><span>Code</span> <span class="caret"></span></button><ul class="dropdown-menu" style="min-width: 50px;"><li><a id="rmd-show-all-code" href="#">Show All Code</a></li><li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li></ul></div>';
document.write(str);
</script>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatial Data Science</a></li>

<li class="divider"></li>
<li><a href="index.html#preface">Preface<span></span></a><ul>
<li><a href="index.html#acknowledgements">Acknowledgements<span></span></a></li>
</ul></li>
<li class="part"><span><b>I Spatial Data<span></span></b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Getting Started<span></span></a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#a-first-map"><i class="fa fa-check"></i><b>1.1</b> A first map<span></span></a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#coordinate-reference-systems"><i class="fa fa-check"></i><b>1.2</b> Coordinate reference systems<span></span></a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#rasterize"><i class="fa fa-check"></i><b>1.3</b> Raster and vector data<span></span></a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#raster-types"><i class="fa fa-check"></i><b>1.4</b> Raster types<span></span></a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#time-series-arrays-data-cubes"><i class="fa fa-check"></i><b>1.5</b> Time series, arrays, data cubes<span></span></a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#support"><i class="fa fa-check"></i><b>1.6</b> Support<span></span></a></li>
<li class="chapter" data-level="1.7" data-path="intro.html"><a href="intro.html#spatial-data-science-software"><i class="fa fa-check"></i><b>1.7</b> Spatial data science software<span></span></a></li>
<li class="chapter" data-level="1.8" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>1.8</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cs.html"><a href="cs.html"><i class="fa fa-check"></i><b>2</b> Coordinates<span></span></a><ul>
<li class="chapter" data-level="2.1" data-path="cs.html"><a href="cs.html#units"><i class="fa fa-check"></i><b>2.1</b> Quantities, units, datum<span></span></a></li>
<li class="chapter" data-level="2.2" data-path="cs.html"><a href="cs.html#ellipsoidal-coordinates"><i class="fa fa-check"></i><b>2.2</b> Ellipsoidal coordinates<span></span></a></li>
<li class="chapter" data-level="2.3" data-path="cs.html"><a href="cs.html#crs"><i class="fa fa-check"></i><b>2.3</b> Coordinate Reference Systems<span></span></a></li>
<li class="chapter" data-level="2.4" data-path="cs.html"><a href="cs.html#projlib"><i class="fa fa-check"></i><b>2.4</b> PROJ and mapping accuracy<span></span></a></li>
<li class="chapter" data-level="2.5" data-path="cs.html"><a href="cs.html#wkt2"><i class="fa fa-check"></i><b>2.5</b> WKT-2<span></span></a></li>
<li class="chapter" data-level="2.6" data-path="cs.html"><a href="cs.html#exercises-1"><i class="fa fa-check"></i><b>2.6</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="geometries.html"><a href="geometries.html"><i class="fa fa-check"></i><b>3</b> Geometries<span></span></a><ul>
<li class="chapter" data-level="3.1" data-path="geometries.html"><a href="geometries.html#simplefeatures"><i class="fa fa-check"></i><b>3.1</b> Simple feature geometries<span></span></a></li>
<li class="chapter" data-level="3.2" data-path="geometries.html"><a href="geometries.html#opgeom"><i class="fa fa-check"></i><b>3.2</b> Operations on geometries<span></span></a></li>
<li class="chapter" data-level="3.3" data-path="geometries.html"><a href="geometries.html#precision"><i class="fa fa-check"></i><b>3.3</b> Precision<span></span></a></li>
<li class="chapter" data-level="3.4" data-path="geometries.html"><a href="geometries.html#coverages"><i class="fa fa-check"></i><b>3.4</b> Coverages: tessellations and rasters<span></span></a></li>
<li class="chapter" data-level="3.5" data-path="geometries.html"><a href="geometries.html#networks"><i class="fa fa-check"></i><b>3.5</b> Networks<span></span></a></li>
<li class="chapter" data-level="3.6" data-path="geometries.html"><a href="geometries.html#exercises-2"><i class="fa fa-check"></i><b>3.6</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spherical.html"><a href="spherical.html"><i class="fa fa-check"></i><b>4</b> Spherical Geometries<span></span></a><ul>
<li class="chapter" data-level="4.1" data-path="spherical.html"><a href="spherical.html#straight-lines"><i class="fa fa-check"></i><b>4.1</b> Straight lines<span></span></a></li>
<li class="chapter" data-level="4.2" data-path="spherical.html"><a href="spherical.html#ring-direction"><i class="fa fa-check"></i><b>4.2</b> Ring direction<span></span></a></li>
<li class="chapter" data-level="4.3" data-path="spherical.html"><a href="spherical.html#full-polygon"><i class="fa fa-check"></i><b>4.3</b> Full polygon<span></span></a></li>
<li class="chapter" data-level="4.4" data-path="spherical.html"><a href="spherical.html#bounding-box-rectangle-and-cap"><i class="fa fa-check"></i><b>4.4</b> Bounding box, rectangle, and cap<span></span></a></li>
<li class="chapter" data-level="4.5" data-path="spherical.html"><a href="spherical.html#validity-on-the-sphere"><i class="fa fa-check"></i><b>4.5</b> Validity on the sphere<span></span></a></li>
<li class="chapter" data-level="4.6" data-path="spherical.html"><a href="spherical.html#exercises-3"><i class="fa fa-check"></i><b>4.6</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="featureattributes.html"><a href="featureattributes.html"><i class="fa fa-check"></i><b>5</b> Attributes and Support<span></span></a><ul>
<li class="chapter" data-level="5.1" data-path="featureattributes.html"><a href="featureattributes.html#agr"><i class="fa fa-check"></i><b>5.1</b> Attribute-geometry relationships and support<span></span></a></li>
<li class="chapter" data-level="5.2" data-path="featureattributes.html"><a href="featureattributes.html#aggregating-and-summarising"><i class="fa fa-check"></i><b>5.2</b> Aggregating and summarising<span></span></a></li>
<li class="chapter" data-level="5.3" data-path="featureattributes.html"><a href="featureattributes.html#area-weighted"><i class="fa fa-check"></i><b>5.3</b> Area-weighted interpolation<span></span></a></li>
<li class="chapter" data-level="5.4" data-path="featureattributes.html"><a href="featureattributes.html#updownscaling"><i class="fa fa-check"></i><b>5.4</b> Up- and Downscaling<span></span></a></li>
<li class="chapter" data-level="5.5" data-path="featureattributes.html"><a href="featureattributes.html#exercises-4"><i class="fa fa-check"></i><b>5.5</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="datacube.html"><a href="datacube.html"><i class="fa fa-check"></i><b>6</b> Data Cubes<span></span></a><ul>
<li class="chapter" data-level="6.1" data-path="datacube.html"><a href="datacube.html#a-four-dimensional-data-cube"><i class="fa fa-check"></i><b>6.1</b> A four-dimensional data cube<span></span></a></li>
<li class="chapter" data-level="6.2" data-path="datacube.html"><a href="datacube.html#dimensions-attributes-and-support"><i class="fa fa-check"></i><b>6.2</b> Dimensions, attributes, and support<span></span></a></li>
<li class="chapter" data-level="6.3" data-path="datacube.html"><a href="datacube.html#dcoperations"><i class="fa fa-check"></i><b>6.3</b> Operations on data cubes<span></span></a></li>
<li class="chapter" data-level="6.4" data-path="datacube.html"><a href="datacube.html#vectordatacubes"><i class="fa fa-check"></i><b>6.4</b> Aggregating raster to vector cubes<span></span></a></li>
<li class="chapter" data-level="6.5" data-path="datacube.html"><a href="datacube.html#switching"><i class="fa fa-check"></i><b>6.5</b> Switching dimension with attributes<span></span></a></li>
<li class="chapter" data-level="6.6" data-path="datacube.html"><a href="datacube.html#otherdynamic"><i class="fa fa-check"></i><b>6.6</b> Other dynamic spatial data<span></span></a></li>
<li class="chapter" data-level="6.7" data-path="datacube.html"><a href="datacube.html#exercises-5"><i class="fa fa-check"></i><b>6.7</b> Exercises<span></span></a></li>
</ul></li>
<li class="part"><span><b>II R for Spatial Data Science<span></span></b></span></li>
<li class="chapter" data-level="7" data-path="sf.html"><a href="sf.html"><i class="fa fa-check"></i><b>7</b> Introduction to sf and stars<span></span></a><ul>
<li class="chapter" data-level="7.1" data-path="sf.html"><a href="sf.html#sfintro"><i class="fa fa-check"></i><b>7.1</b> Package <code>sf</code><span></span></a></li>
<li class="chapter" data-level="7.2" data-path="sf.html"><a href="sf.html#spatial-joins"><i class="fa fa-check"></i><b>7.2</b> Spatial joins<span></span></a></li>
<li class="chapter" data-level="7.3" data-path="sf.html"><a href="sf.html#package-stars"><i class="fa fa-check"></i><b>7.3</b> Package <code>stars</code><span></span></a></li>
<li class="chapter" data-level="7.4" data-path="sf.html"><a href="sf.html#vector-data-cube-examples"><i class="fa fa-check"></i><b>7.4</b> Vector data cube examples<span></span></a></li>
<li class="chapter" data-level="7.5" data-path="sf.html"><a href="sf.html#raster-to-vector"><i class="fa fa-check"></i><b>7.5</b> raster-to-vector, vector-to-raster<span></span></a></li>
<li class="chapter" data-level="7.6" data-path="sf.html"><a href="sf.html#projsf"><i class="fa fa-check"></i><b>7.6</b> Coordinate transformations and conversions<span></span></a></li>
<li class="chapter" data-level="7.7" data-path="sf.html"><a href="sf.html#warp"><i class="fa fa-check"></i><b>7.7</b> Transforming and warping rasters<span></span></a></li>
<li class="chapter" data-level="7.8" data-path="sf.html"><a href="sf.html#exercises-6"><i class="fa fa-check"></i><b>7.8</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="large.html"><a href="large.html"><i class="fa fa-check"></i><b>8</b> Large data sets<span></span></a><ul>
<li class="chapter" data-level="8.1" data-path="large.html"><a href="large.html#largesf"><i class="fa fa-check"></i><b>8.1</b> Vector data: <code>sf</code><span></span></a></li>
<li class="chapter" data-level="8.2" data-path="large.html"><a href="large.html#raster-data-stars"><i class="fa fa-check"></i><b>8.2</b> Raster data: <code>stars</code><span></span></a></li>
<li class="chapter" data-level="8.3" data-path="large.html"><a href="large.html#very-large-data-cubes"><i class="fa fa-check"></i><b>8.3</b> Very large data cubes<span></span></a></li>
<li class="chapter" data-level="8.4" data-path="large.html"><a href="large.html#exercises-7"><i class="fa fa-check"></i><b>8.4</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>9</b> Plotting spatial data<span></span></a><ul>
<li class="chapter" data-level="9.1" data-path="plotting.html"><a href="plotting.html#transform"><i class="fa fa-check"></i><b>9.1</b> Every plot is a projection<span></span></a></li>
<li class="chapter" data-level="9.2" data-path="plotting.html"><a href="plotting.html#plotting-points-lines-polygons-grid-cells"><i class="fa fa-check"></i><b>9.2</b> Plotting points, lines, polygons, grid cells<span></span></a></li>
<li class="chapter" data-level="9.3" data-path="plotting.html"><a href="plotting.html#base-plot"><i class="fa fa-check"></i><b>9.3</b> Base <code>plot</code><span></span></a></li>
<li class="chapter" data-level="9.4" data-path="plotting.html"><a href="plotting.html#geomsf"><i class="fa fa-check"></i><b>9.4</b> Maps with <code>ggplot2</code><span></span></a></li>
<li class="chapter" data-level="9.5" data-path="plotting.html"><a href="plotting.html#tmap"><i class="fa fa-check"></i><b>9.5</b> Maps with <code>tmap</code><span></span></a></li>
<li class="chapter" data-level="9.6" data-path="plotting.html"><a href="plotting.html#interactive-maps-leaflet-mapview-tmap"><i class="fa fa-check"></i><b>9.6</b> Interactive maps: <code>leaflet</code>, <code>mapview</code>, <code>tmap</code><span></span></a></li>
<li class="chapter" data-level="9.7" data-path="plotting.html"><a href="plotting.html#exercises-8"><i class="fa fa-check"></i><b>9.7</b> Exercises<span></span></a></li>
</ul></li>
<li class="part"><span><b>III Models for Spatial Data<span></span></b></span></li>
<li class="chapter" data-level="10" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html"><i class="fa fa-check"></i><b>10</b> Statistical modelling of spatial data<span></span></a><ul>
<li class="chapter" data-level="10.1" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#design"><i class="fa fa-check"></i><b>10.1</b> Design-based and model-based inference<span></span></a></li>
<li class="chapter" data-level="10.2" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#predictive-models-with-coordinates"><i class="fa fa-check"></i><b>10.2</b> Predictive models with coordinates<span></span></a></li>
<li class="chapter" data-level="10.3" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#further-reading"><i class="fa fa-check"></i><b>10.3</b> Further reading<span></span></a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="pointpatterns.html"><a href="pointpatterns.html"><i class="fa fa-check"></i><b>11</b> Point Pattern Analysis<span></span></a><ul>
<li class="chapter" data-level="11.1" data-path="pointpatterns.html"><a href="pointpatterns.html#observation-window"><i class="fa fa-check"></i><b>11.1</b> Observation window<span></span></a></li>
<li class="chapter" data-level="11.2" data-path="pointpatterns.html"><a href="pointpatterns.html#coordinate-reference-systems-1"><i class="fa fa-check"></i><b>11.2</b> Coordinate reference systems<span></span></a></li>
<li class="chapter" data-level="11.3" data-path="pointpatterns.html"><a href="pointpatterns.html#marked-point-patterns-points-on-linear-networks"><i class="fa fa-check"></i><b>11.3</b> Marked point patterns, points on linear networks<span></span></a></li>
<li class="chapter" data-level="11.4" data-path="pointpatterns.html"><a href="pointpatterns.html#spatial-sampling-and-simulating-a-point-process"><i class="fa fa-check"></i><b>11.4</b> Spatial sampling and simulating a point process<span></span></a></li>
<li class="chapter" data-level="11.5" data-path="pointpatterns.html"><a href="pointpatterns.html#simulating-points-on-the-globe"><i class="fa fa-check"></i><b>11.5</b> Simulating points on the globe<span></span></a></li>
<li class="chapter" data-level="11.6" data-path="pointpatterns.html"><a href="pointpatterns.html#exercises-9"><i class="fa fa-check"></i><b>11.6</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="interpolation.html"><a href="interpolation.html"><i class="fa fa-check"></i><b>12</b> Spatial Interpolation<span></span></a><ul>
<li class="chapter" data-level="12.1" data-path="interpolation.html"><a href="interpolation.html#a-first-dataset"><i class="fa fa-check"></i><b>12.1</b> A first dataset<span></span></a></li>
<li class="chapter" data-level="12.2" data-path="interpolation.html"><a href="interpolation.html#sample-variogram"><i class="fa fa-check"></i><b>12.2</b> Sample variogram<span></span></a></li>
<li class="chapter" data-level="12.3" data-path="interpolation.html"><a href="interpolation.html#fitting-variogram-models"><i class="fa fa-check"></i><b>12.3</b> Fitting variogram models<span></span></a></li>
<li class="chapter" data-level="12.4" data-path="interpolation.html"><a href="interpolation.html#kriging"><i class="fa fa-check"></i><b>12.4</b> Kriging interpolation<span></span></a></li>
<li class="chapter" data-level="12.5" data-path="interpolation.html"><a href="interpolation.html#blockkriging"><i class="fa fa-check"></i><b>12.5</b> Areal means: block kriging<span></span></a></li>
<li class="chapter" data-level="12.6" data-path="interpolation.html"><a href="interpolation.html#conditional-simulation"><i class="fa fa-check"></i><b>12.6</b> Conditional simulation<span></span></a></li>
<li class="chapter" data-level="12.7" data-path="interpolation.html"><a href="interpolation.html#trend-models"><i class="fa fa-check"></i><b>12.7</b> Trend models<span></span></a></li>
<li class="chapter" data-level="12.8" data-path="interpolation.html"><a href="interpolation.html#exercises-10"><i class="fa fa-check"></i><b>12.8</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="stgeostatistics.html"><a href="stgeostatistics.html"><i class="fa fa-check"></i><b>13</b> Multivariate and Spatiotemporal Geostatistics<span></span></a><ul>
<li class="chapter" data-level="13.1" data-path="stgeostatistics.html"><a href="stgeostatistics.html#preparing"><i class="fa fa-check"></i><b>13.1</b> Preparing the air quality dataset<span></span></a></li>
<li class="chapter" data-level="13.2" data-path="stgeostatistics.html"><a href="stgeostatistics.html#cokriging"><i class="fa fa-check"></i><b>13.2</b> Multivariable geostatistics<span></span></a></li>
<li class="chapter" data-level="13.3" data-path="stgeostatistics.html"><a href="stgeostatistics.html#spatiotemporal-geostatistics"><i class="fa fa-check"></i><b>13.3</b> Spatiotemporal geostatistics<span></span></a></li>
<li class="chapter" data-level="13.4" data-path="stgeostatistics.html"><a href="stgeostatistics.html#exercises-11"><i class="fa fa-check"></i><b>13.4</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="area.html"><a href="area.html"><i class="fa fa-check"></i><b>14</b> Proximity and Areal Data<span></span></a><ul>
<li class="chapter" data-level="14.1" data-path="area.html"><a href="area.html#representing-proximity-in-spdep"><i class="fa fa-check"></i><b>14.1</b> Representing proximity in <strong>spdep</strong><span></span></a></li>
<li class="chapter" data-level="14.2" data-path="area.html"><a href="area.html#contiguous-neighbours"><i class="fa fa-check"></i><b>14.2</b> Contiguous neighbours<span></span></a></li>
<li class="chapter" data-level="14.3" data-path="area.html"><a href="area.html#graph-based-neighbours"><i class="fa fa-check"></i><b>14.3</b> Graph-based neighbours<span></span></a></li>
<li class="chapter" data-level="14.4" data-path="area.html"><a href="area.html#distance-based-neighbours"><i class="fa fa-check"></i><b>14.4</b> Distance-based neighbours<span></span></a></li>
<li class="chapter" data-level="14.5" data-path="area.html"><a href="area.html#weights-specification"><i class="fa fa-check"></i><b>14.5</b> Weights specification<span></span></a></li>
<li class="chapter" data-level="14.6" data-path="area.html"><a href="area.html#higher-order-neighbours"><i class="fa fa-check"></i><b>14.6</b> Higher order neighbours<span></span></a></li>
<li class="chapter" data-level="14.7" data-path="area.html"><a href="area.html#exercises-12"><i class="fa fa-check"></i><b>14.7</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="spatautocorr.html"><a href="spatautocorr.html"><i class="fa fa-check"></i><b>15</b> Measures of spatial autocorrelation<span></span></a><ul>
<li class="chapter" data-level="15.1" data-path="spatautocorr.html"><a href="spatautocorr.html#measures-and-process-mis-specification"><i class="fa fa-check"></i><b>15.1</b> Measures and process mis-specification<span></span></a></li>
<li class="chapter" data-level="15.2" data-path="spatautocorr.html"><a href="spatautocorr.html#global-measures"><i class="fa fa-check"></i><b>15.2</b> Global measures<span></span></a></li>
<li class="chapter" data-level="15.3" data-path="spatautocorr.html"><a href="spatautocorr.html#local-measures"><i class="fa fa-check"></i><b>15.3</b> Local measures<span></span></a></li>
<li class="chapter" data-level="15.4" data-path="spatautocorr.html"><a href="spatautocorr.html#exercises-13"><i class="fa fa-check"></i><b>15.4</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="spatglmm.html"><a href="spatglmm.html"><i class="fa fa-check"></i><b>16</b> Spatial Regression<span></span></a><ul>
<li class="chapter" data-level="16.1" data-path="spatglmm.html"><a href="spatglmm.html#markov-random-field-and-multilevel-models-with-spatial-weights"><i class="fa fa-check"></i><b>16.1</b> Markov random field and multilevel models with spatial weights<span></span></a></li>
<li class="chapter" data-level="16.2" data-path="spatglmm.html"><a href="spatglmm.html#multilevel-models-of-the-boston-data-set"><i class="fa fa-check"></i><b>16.2</b> Multilevel models of the Boston data set<span></span></a></li>
<li class="chapter" data-level="16.3" data-path="spatglmm.html"><a href="spatglmm.html#exercises-14"><i class="fa fa-check"></i><b>16.3</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="spatecon.html"><a href="spatecon.html"><i class="fa fa-check"></i><b>17</b> Spatial econometrics models<span></span></a><ul>
<li class="chapter" data-level="17.1" data-path="spatecon.html"><a href="spatecon.html#spatial-econometric-models-definitions"><i class="fa fa-check"></i><b>17.1</b> Spatial econometric models: definitions<span></span></a></li>
<li class="chapter" data-level="17.2" data-path="spatecon.html"><a href="spatecon.html#maximum-likelihood-estimation-in-spatialreg"><i class="fa fa-check"></i><b>17.2</b> Maximum likelihood estimation in <strong>spatialreg</strong><span></span></a></li>
<li class="chapter" data-level="17.3" data-path="spatecon.html"><a href="spatecon.html#impacts"><i class="fa fa-check"></i><b>17.3</b> Impacts<span></span></a></li>
<li class="chapter" data-level="17.4" data-path="spatecon.html"><a href="spatecon.html#spateconpred"><i class="fa fa-check"></i><b>17.4</b> Predictions<span></span></a></li>
<li class="chapter" data-level="17.5" data-path="spatecon.html"><a href="spatecon.html#exercises-15"><i class="fa fa-check"></i><b>17.5</b> Exercises<span></span></a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="older.html"><a href="older.html"><i class="fa fa-check"></i><b>18</b> Older R Spatial Packages<span></span></a><ul>
<li class="chapter" data-level="18.1" data-path="older.html"><a href="older.html#retire"><i class="fa fa-check"></i><b>18.1</b> Retiring <code>rgdal</code> and <code>rgeos</code><span></span></a></li>
<li class="chapter" data-level="18.2" data-path="older.html"><a href="older.html#links-and-differences-between-sf-and-sp"><i class="fa fa-check"></i><b>18.2</b> Links and differences between sf and sp<span></span></a></li>
<li class="chapter" data-level="18.3" data-path="older.html"><a href="older.html#migration-code-and-packages"><i class="fa fa-check"></i><b>18.3</b> Migration code and packages<span></span></a></li>
<li class="chapter" data-level="18.4" data-path="older.html"><a href="older.html#package-raster-and-terra"><i class="fa fa-check"></i><b>18.4</b> Package raster and terra<span></span></a></li>
</ul></li>
<li><a href="all-r-code-in-this-book.html#all-r-code-in-this-book">All R code in this book<span></span></a></li>
<li><a href="r-basics.html#r-basics">R basics<span></span></a><ul>
<li><a href="r-basics.html#pipes">Pipes<span></span></a></li>
<li><a href="r-basics.html#data-structures">Data structures<span></span></a></li>
<li><a href="r-basics.html#dissecting-a-multipolygon">dissecting a <code>MULTIPOLYGON</code><span></span></a></li>
</ul></li>
<li><a href="references.html#references">References<span></span></a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="interpolation" class="section level1 hasAnchor">
<h1><span class="header-section-number">Chapter 12</span> Spatial Interpolation<a href="interpolation.html#interpolation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Spatial interpolation is the activity of estimating values spatially
continuous variables for spatial locations where they have not
been observed, based on observations. The statistical methodology
for spatial interpolation, called geostatistics, is concerned with
the modelling, prediction and simulation of spatially continuous
phenomena. The typical problem is a missing value problem: we
observe a property of a phenomenon <span class="math inline">\(Z(s)\)</span> at a limited number
of sample locations <span class="math inline">\(s_i, i = 1,...,n\)</span>, and are interested in
the property value at all locations <span class="math inline">\(s_0\)</span> covering an area of
interest, so we have to predict it for unobserved locations. This
is also called <em>kriging</em>, or Gaussian Process prediction.
In case <span class="math inline">\(Z(s)\)</span> contains a white noise component <span class="math inline">\(\epsilon\)</span>, as in
<span class="math inline">\(Z(s)=S(s)+\epsilon(s)\)</span> (possibly reflecting measurement error)
an alternative but similar goal is to predict <span class="math inline">\(S(s)\)</span>, which may be
called spatial filtering or smoothing.</p>
<p>In this chapter we will show simple approaches for handling
geostatistical data, will demonstrate simple interpolation methods,
explore modelling spatial correlation, spatial prediction and
simulation. We will use package <code>gstat</code> <span class="citation">(E. Pebesma and Graeler <a href="#ref-R-gstat">2021</a>; Pebesma <a href="#ref-gstatcg">2004</a>)</span>,
which offers a fairly wide palette of models and options for
non-Bayesian geostatistical analysis. Bayesian methods with
R implementations are found in e.g. <span class="citation">Diggle, Tawn, and Moyeed (<a href="#ref-DiggleTawnMoyeed:98">1998</a>)</span>,
<span class="citation">Diggle and Ribeiro Jr. (<a href="#ref-Diggle:2007">2007</a>)</span>, <span class="citation">Blangiardo and Cameletti (<a href="#ref-blangiardo2015spatial">2015</a>)</span>, and <span class="citation">Wikle, Zammit-Mangion, and Cressie (<a href="#ref-wikle2019spatio">2019</a>)</span>. An overview
and comparisons of methods for large datasets is given in
<span class="citation">Heaton et al. (<a href="#ref-Heaton2018">2018</a>)</span>.</p>
<div id="a-first-dataset" class="section level2 hasAnchor">
<h2><span class="header-section-number">12.1</span> A first dataset<a href="interpolation.html#a-first-dataset" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We can read NO<span class="math inline">\(_2\)</span> data, which is prepared in chapter <a href="stgeostatistics.html#stgeostatistics">13</a>, from
package <code>gstat</code> using</p>
<div class="sourceCode" id="cb371"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb371-1" title="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb371-2" title="2">no2 =<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">system.file</span>(<span class="st">&quot;external/no2.csv&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;gstat&quot;</span>))</a></code></pre></div>
<p>and convert it into an <code>sf</code> object using</p>
<div class="sourceCode" id="cb372"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb372-1" title="1"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb372-2" title="2">crs =<span class="st"> </span><span class="kw">st_crs</span>(<span class="st">&quot;EPSG:32632&quot;</span>)</a>
<a class="sourceLine" id="cb372-3" title="3">no2.sf =<span class="st"> </span><span class="kw">st_as_sf</span>(no2, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;station_longitude_deg&quot;</span>, <span class="st">&quot;station_latitude_deg&quot;</span>), <span class="dt">crs =</span> <span class="st">&quot;OGC:CRS84&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb372-4" title="4"><span class="st">    </span><span class="kw">st_transform</span>(crs)</a></code></pre></div>
<p>Next, we can load country boundaries and plot these data using <code>ggplot</code>, shown
in figure <a href="interpolation.html#fig:plotDE">12.1</a>.</p>
<div class="sourceCode" id="cb373"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb373-1" title="1"><span class="kw">data</span>(air, <span class="dt">package =</span> <span class="st">&quot;spacetime&quot;</span>) <span class="co"># this loads German boundaries into DE_NUTS1</span></a>
<a class="sourceLine" id="cb373-2" title="2">de &lt;-<span class="st"> </span><span class="kw">st_transform</span>(<span class="kw">st_as_sf</span>(DE_NUTS1), crs)</a></code></pre></div>

<div class="sourceCode" id="cb374"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb374-1" title="1"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> de) <span class="op">+</span><span class="st">  </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">col =</span> NO2))</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:plotDE"></span>
<img src="sds_files/figure-html/plotDE-1.png" alt="Mean NO\(_2\) concentrations in air for rural background stations in Germany over 2017" width="672" />
<p class="caption">
Figure 12.1: Mean NO<span class="math inline">\(_2\)</span> concentrations in air for rural background stations in Germany over 2017
</p>
</div>
<p>If we want to interpolate, we first need to decide where. This
is typically done on a regular grid covering the area of
interest. Starting with the country outline <code>de</code> we can create a
regular grid with 10 km grid cells (pixels) over Germany by</p>
<div class="sourceCode" id="cb375"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb375-1" title="1"><span class="kw">library</span>(stars)</a>
<a class="sourceLine" id="cb375-2" title="2"><span class="kw">st_bbox</span>(de) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb375-3" title="3"><span class="st">  </span><span class="kw">st_as_stars</span>(<span class="dt">dx =</span> <span class="dv">10000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb375-4" title="4"><span class="st">  </span><span class="kw">st_crop</span>(de) -&gt;<span class="st"> </span>grd</a>
<a class="sourceLine" id="cb375-5" title="5">grd</a></code></pre></div>
<pre><code># stars object with 2 dimensions and 1 attribute
# attribute(s):
#         Min. 1st Qu. Median Mean 3rd Qu. Max. NA&#39;s
# values     0       0      0    0       0    0 1989
# dimension(s):
#   from to  offset  delta            refsys point values x/y
# x    1 64  280741  10000 WGS 84 / UTM z...    NA   NULL [x]
# y    1 87 6101239 -10000 WGS 84 / UTM z...    NA   NULL [y]</code></pre>
<p>Here, we chose grid cells to be not too fine, so that we still see
them in plots.</p>
<p>Perhaps the simplest interpolation method is inverse distance weighted
interpolation, which is a weighted average, using weights inverse
proportional to distances from the interpolation location:</p>
<p><span class="math display">\[
\hat{z}(s_0) = \frac{\sum_{i=1}^{n} w_i z(s_i)}{\sum_{i=1}^n w_i}
\]</span></p>
<p>with <span class="math inline">\(w_i = |s_0-s_i|^p\)</span>, and the inverse distance power typically
taken as 2, or optimized using cross validation. We can compute
inverse distance interpolated values using <code>gstat::idw</code>,</p>
<div class="sourceCode" id="cb377"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb377-1" title="1"><span class="kw">library</span>(gstat)</a>
<a class="sourceLine" id="cb377-2" title="2">i =<span class="st"> </span><span class="kw">idw</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, grd)</a></code></pre></div>
<pre><code># [inverse distance weighted interpolation]</code></pre>
<p>and plot them in figure <a href="interpolation.html#fig:idw">12.2</a>.</p>

<div class="sourceCode" id="cb379"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb379-1" title="1"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> i, <span class="kw">aes</span>(<span class="dt">fill =</span> var1.pred, <span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb379-2" title="2"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_cast</span>(de, <span class="st">&quot;MULTILINESTRING&quot;</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb379-3" title="3"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:idw"></span>
<img src="sds_files/figure-html/idw-1.png" alt="Inverse distance weighted interpolated values for NO\(_2\) over Germany" width="672" />
<p class="caption">
Figure 12.2: Inverse distance weighted interpolated values for NO<span class="math inline">\(_2\)</span> over Germany
</p>
</div>
</div>
<div id="sample-variogram" class="section level2 hasAnchor">
<h2><span class="header-section-number">12.2</span> Sample variogram<a href="interpolation.html#sample-variogram" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In order to make spatial predictions using geostatistical methods, we first need to identify a model for the mean and for the spatial correlation. In the simplest model, <span class="math inline">\(Z(s) = m + e(s)\)</span>, the mean is an unknown constant <span class="math inline">\(m\)</span>, and in this case the spatial correlation can be modelled using the variogram, <span class="math inline">\(\gamma(h) = 0.5 E (Z(s)-Z(s+h))^2\)</span>. For processes with a finite variance <span class="math inline">\(C(0)\)</span>, the variogram is related to the covariogram or covariance function through <span class="math inline">\(\gamma(h) = C(0)-C(h)\)</span>.</p>
<p>The sample variogram is obtained by computing estimates of <span class="math inline">\(\gamma(h)\)</span> for distance intervals, <span class="math inline">\(h_i = [h_{i,0},h_{i,1}]\)</span>:
<span class="math display">\[
\hat{\gamma}(h_i) = \frac{1}{2N(h_i)}\sum_{j=1}^{N(h_i)}(z(s_i)-z(s_i+h&#39;))^2, \ \ h_{i,0} \le h&#39; &lt; h_{i,1}
\]</span></p>
<p>with <span class="math inline">\(N(h_i)\)</span> the number of sample pairs available for distance interval <span class="math inline">\(h_i\)</span>.
Function <code>gstat::variogram</code> computes sample variograms,</p>
<div class="sourceCode" id="cb380"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb380-1" title="1">v =<span class="st"> </span><span class="kw">variogram</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf)</a></code></pre></div>
<p>and the result of plotting this is shown in figure <a href="interpolation.html#fig:vgm">12.3</a>.</p>
<div class="sourceCode" id="cb381"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb381-1" title="1"><span class="kw">plot</span>(v, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:vgm"></span>
<img src="sds_files/figure-html/vgm-1.png" alt="Sample variogram plot" width="672" />
<p class="caption">
Figure 12.3: Sample variogram plot
</p>
</div>
<p>Function <code>variogram</code> chooses default for maximum distance (<code>cutoff</code>: one third of the length of the bounding box diagonal) and (constant) interval widths (<code>width</code>: cutoff divided by 15). These defaults can be changed, e.g. by</p>
<div class="sourceCode" id="cb382"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb382-1" title="1"><span class="kw">library</span>(gstat)</a>
<a class="sourceLine" id="cb382-2" title="2">v0 =<span class="st"> </span><span class="kw">variogram</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, <span class="dt">cutoff =</span> <span class="dv">100000</span>, <span class="dt">width =</span> <span class="dv">10000</span>)</a></code></pre></div>
<p>shown in figure <a href="interpolation.html#fig:vgm2">12.4</a>.</p>
<div class="sourceCode" id="cb383"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb383-1" title="1"><span class="kw">plot</span>(v0, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:vgm2"></span>
<img src="sds_files/figure-html/vgm2-1.png" alt="Sample variogram plot with adjusted cutoff and lag width" width="672" />
<p class="caption">
Figure 12.4: Sample variogram plot with adjusted cutoff and lag width
</p>
</div>
<p>Note that the formula <code>NO2~1</code> is used to select the variable of interest from the data file (<code>NO2</code>), and to specify the mean model: <code>~1</code> refers to an intercept-only (unknown, constant mean) model.</p>
</div>
<div id="fitting-variogram-models" class="section level2 hasAnchor">
<h2><span class="header-section-number">12.3</span> Fitting variogram models<a href="interpolation.html#fitting-variogram-models" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In order to progress toward spatial predictions, we need a variogram <em>model</em> <span class="math inline">\(\gamma(h)\)</span> for (potentially) all distances <span class="math inline">\(h\)</span>, rather than the set of estimates derived above: in case we would for instance connect these estimates with straight lines, or assume they reflect constant values over their respective distance intervals, this would lead to statistical models with non-positive covariance matrices, which is a complicated way of expressing that you are in a lot of trouble.</p>
<p>To avoid these troubles we fit parametric models <span class="math inline">\(\gamma(h)\)</span> to the estimates <span class="math inline">\(\hat{\gamma}(h_i)\)</span>, where we take <span class="math inline">\(h_i\)</span> as the mean value of all the <span class="math inline">\(h&#39;\)</span> values involved in estimating <span class="math inline">\(\hat{\gamma}(h_i)\)</span>. For this, when we fit a model like the exponential variogram, fitted by</p>
<div class="sourceCode" id="cb384"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb384-1" title="1">v.m =<span class="st"> </span><span class="kw">fit.variogram</span>(v, <span class="kw">vgm</span>(<span class="dv">1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">50000</span>, <span class="dv">1</span>))</a></code></pre></div>
<p>and shown in figure <a href="interpolation.html#fig:fitvariogrammodel">12.5</a>.</p>
<div class="sourceCode" id="cb385"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb385-1" title="1"><span class="kw">plot</span>(v, v.m, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:fitvariogrammodel"></span>
<img src="sds_files/figure-html/fitvariogrammodel-1.png" alt="Sample variogram with fitted model" width="672" />
<p class="caption">
Figure 12.5: Sample variogram with fitted model
</p>
</div>
<p>The fitting is done by weighted least squares, minimizing
<span class="math inline">\(\sum_{i=1}^{n}w_i(\gamma(h_i)-\hat{\gamma}(h_i))^2\)</span>, with <span class="math inline">\(w_i\)</span> by
default equal to <span class="math inline">\(N(h_i)/h^2\)</span>, other fitting schemes are available
through argument <code>fit.method</code>.</p>
</div>
<div id="kriging" class="section level2 hasAnchor">
<h2><span class="header-section-number">12.4</span> Kriging interpolation<a href="interpolation.html#kriging" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Typically, when we interpolate a variable, we do that on
points on a regular grid covering the target area. We first create
a <code>stars</code> object with a raster covering the target area, and NA’s
outside it.</p>
<p>Kriging involves the prediction of <span class="math inline">\(Z(s_0)\)</span> at arbitrary locations
<span class="math inline">\(s_0\)</span>. We can krige NO<span class="math inline">\(_2\)</span> by using <code>gstat::krige</code>, with the model for the
trend, the data, the prediction grid, and the variogram model (figure <a href="interpolation.html#fig:krigeovergermany">12.6</a>):</p>
<div class="sourceCode" id="cb386"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb386-1" title="1">k =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, grd, v.m)</a></code></pre></div>
<pre><code># [using ordinary kriging]</code></pre>

<div class="sourceCode" id="cb388"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb388-1" title="1"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> k, <span class="kw">aes</span>(<span class="dt">fill =</span> var1.pred, <span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-2" title="2"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_cast</span>(de, <span class="st">&quot;MULTILINESTRING&quot;</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb388-3" title="3"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf) <span class="op">+</span></a>
<a class="sourceLine" id="cb388-4" title="4"><span class="st">    </span><span class="kw">coord_sf</span>(<span class="dt">lims_method =</span> <span class="st">&quot;geometry_bbox&quot;</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:krigeovergermany"></span>
<img src="sds_files/figure-html/krigeovergermany-1.png" alt="Kriged NO\(_2\) concentrations over Germany" width="672" />
<p class="caption">
Figure 12.6: Kriged NO<span class="math inline">\(_2\)</span> concentrations over Germany
</p>
</div>
</div>
<div id="blockkriging" class="section level2 hasAnchor">
<h2><span class="header-section-number">12.5</span> Areal means: block kriging<a href="interpolation.html#blockkriging" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Computing areal means can be done in several ways. The simples is to take
the average of point samples falling inside the target polygons:</p>
<div class="sourceCode" id="cb389"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb389-1" title="1">a =<span class="st"> </span><span class="kw">aggregate</span>(no2.sf[<span class="st">&quot;NO2&quot;</span>], <span class="dt">by =</span> de, <span class="dt">FUN =</span> mean)</a></code></pre></div>
<p>A more complicated way is to use <em>block kriging</em> <span class="citation">(Journel and Huijbregts <a href="#ref-jh78">1978</a>)</span>, which
uses <em>all</em> the data to estimate the mean of the variable over the
target area. With <code>krige</code>, this can be done by giving the target
areas (polygons) as the <code>newdata</code> argument:</p>
<div class="sourceCode" id="cb390"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb390-1" title="1">b =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, de, v.m)</a></code></pre></div>
<pre><code># [using ordinary kriging]</code></pre>
<p>we can now merge the two maps into a single object to create a single plot (figure <a href="interpolation.html#fig:aggregations">12.7</a>):</p>
<div class="sourceCode" id="cb392"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb392-1" title="1">b<span class="op">$</span>sample =<span class="st"> </span>a<span class="op">$</span>NO2</a>
<a class="sourceLine" id="cb392-2" title="2">b<span class="op">$</span>kriging =<span class="st"> </span>b<span class="op">$</span>var1.pred</a></code></pre></div>

<div class="sourceCode" id="cb393"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb393-1" title="1">b <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(sample, kriging) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb393-2" title="2"><span class="st">        </span><span class="kw">pivot_longer</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">names_to =</span> <span class="st">&quot;var&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;NO2&quot;</span>) -&gt;<span class="st"> </span>b2</a>
<a class="sourceLine" id="cb393-3" title="3">b2<span class="op">$</span>var =<span class="st"> </span><span class="kw">factor</span>(b2<span class="op">$</span>var, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;sample&quot;</span>, <span class="st">&quot;kriging&quot;</span>))</a>
<a class="sourceLine" id="cb393-4" title="4"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> b2, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">fill =</span> NO2)) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>var) <span class="op">+</span></a>
<a class="sourceLine" id="cb393-5" title="5"><span class="st">     </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors =</span> <span class="kw">sf.colors</span>(<span class="dv">20</span>))</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:aggregations"></span>
<img src="sds_files/figure-html/aggregations-1.png" alt="Aggregated NO\(_2\) values from simple averaging (left) and block kriging (right)" width="672" />
<p class="caption">
Figure 12.7: Aggregated NO<span class="math inline">\(_2\)</span> values from simple averaging (left) and block kriging (right)
</p>
</div>
<p>We see that the signal is similar, but that the simple means are
more variable than the block kriging values; this may be due to
the smoothing effect of kriging: data points outside the target
area are weighted, too.</p>
<p>To compare the standard errors of means, for the sample mean we
can get a rough guess of the standard error by <span class="math inline">\(\sqrt{(\sigma^2/n)}\)</span>:</p>
<div class="sourceCode" id="cb394"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb394-1" title="1">SE =<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">sqrt</span>(<span class="kw">var</span>(x)<span class="op">/</span><span class="kw">length</span>(x))</a>
<a class="sourceLine" id="cb394-2" title="2">a =<span class="st"> </span><span class="kw">aggregate</span>(no2.sf[<span class="st">&quot;NO2&quot;</span>], de, SE)</a></code></pre></div>
<p>which would have been the actual estimate in design-based inference
if the sample was obtained by spatially random sampling.
The block kriging variance is the model-based estimate, and is
a by-product of kriging. We combine and rename the two:</p>
<div class="sourceCode" id="cb395"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb395-1" title="1">b<span class="op">$</span>sample =<span class="st"> </span>a<span class="op">$</span>NO2</a>
<a class="sourceLine" id="cb395-2" title="2">b<span class="op">$</span>kriging =<span class="st"> </span><span class="kw">sqrt</span>(b<span class="op">$</span>var1.var)</a></code></pre></div>

<div class="sourceCode" id="cb396"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb396-1" title="1">b <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(sample, kriging) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb396-2" title="2"><span class="st">        </span><span class="kw">pivot_longer</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dt">names_to =</span> <span class="st">&quot;var&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;Standard_error&quot;</span>) -&gt;<span class="st"> </span>b2</a>
<a class="sourceLine" id="cb396-3" title="3">b2<span class="op">$</span>var =<span class="st"> </span><span class="kw">factor</span>(b2<span class="op">$</span>var, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;sample&quot;</span>, <span class="st">&quot;kriging&quot;</span>))</a>
<a class="sourceLine" id="cb396-4" title="4"><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> b2, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">fill =</span> Standard_error)) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>var, <span class="dt">as.table =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb396-5" title="5"><span class="st">     </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colors =</span> <span class="kw">sf.colors</span>(<span class="dv">20</span>))</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:aggrSE"></span>
<img src="sds_files/figure-html/aggrSE-1.png" alt="Standard errors for mean NO\(_2\) values obtained by simple averaging (left) and block kriging (right)" width="672" />
<p class="caption">
Figure 12.8: Standard errors for mean NO<span class="math inline">\(_2\)</span> values obtained by simple averaging (left) and block kriging (right)
</p>
</div>
<p>where we see that the simple approach gives clearly more variability
and mostly larger values for prediction errors of areal means,
compared to block kriging.</p>
</div>
<div id="conditional-simulation" class="section level2 hasAnchor">
<h2><span class="header-section-number">12.6</span> Conditional simulation<a href="interpolation.html#conditional-simulation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In case one or more conditional realisation of the field <span class="math inline">\(Z(s)\)</span>
are needed rather than their conditional mean, we can obtain this
by <em>conditional simulation</em>. A reason for wanting this may be the
need to estimate areal mean values of <span class="math inline">\(g(Z(s))\)</span> with <span class="math inline">\(g(\cdot)\)</span>
a non-linear function; a simple example is the areal fraction where
<span class="math inline">\(Z(s)\)</span> exceeds a threshold.</p>
<p>The standard approach used by <code>gstat</code> is to use the sequential
simulation algorithm for this. This is a simple algorithm that randomly
steps through the prediction locations and at each location:</p>
<ul>
<li>carries out a kriging prediction</li>
<li>draws a random variable from the normal distribution with mean and variance equal to the kriging variance</li>
<li>adds this value to the conditioning dataset</li>
<li>finds a new random simulation location</li>
</ul>
<p>until all locations have been visited.</p>
<p>This is carried out by <code>gstat::krige</code> when <code>nsim</code> is set to a positive
value. In addition, it is good to constrain <code>nmax</code>, the (maximum)
number of nearest neigbours to include in kriging estimation,
because the dataset grows each step, leading otherwise quickly to
very long computing times and large memory requirements (figure
<a href="interpolation.html#fig:plotkrigingvalues">12.9</a>):</p>
<div class="sourceCode" id="cb397"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb397-1" title="1">s =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="dv">1</span>, no2.sf, grd, v.m, <span class="dt">nmax =</span> <span class="dv">30</span>, <span class="dt">nsim =</span> <span class="dv">6</span>)</a></code></pre></div>
<pre><code># drawing 6 GLS realisations of beta...
# [using conditional Gaussian simulation]</code></pre>

<div class="sourceCode" id="cb399"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb399-1" title="1"><span class="kw">library</span>(viridis)</a>
<a class="sourceLine" id="cb399-2" title="2">g =<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span><span class="st"> </span><span class="kw">coord_equal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb399-3" title="3"><span class="st">    </span><span class="kw">scale_fill_viridis</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb399-4" title="4"><span class="st">    </span><span class="kw">theme_void</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb399-5" title="5"><span class="st">    </span><span class="kw">scale_x_discrete</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb399-6" title="6"><span class="st">    </span><span class="kw">scale_y_discrete</span>(<span class="dt">expand=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb399-7" title="7">g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> s[,,,<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>]) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>sample)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:plotkrigingvalues"></span>
<img src="sds_files/figure-html/plotkrigingvalues-1.png" alt="Six conditional simulations for NO\(_2\) values" width="672" />
<p class="caption">
Figure 12.9: Six conditional simulations for NO<span class="math inline">\(_2\)</span> values
</p>
</div>
<p>Alternative methods for conditional simulation have recently been
added to <code>gstat</code>, and include <code>krigeSimCE</code> implementing the circular
embedding method <span class="citation">(Davies and Bryant <a href="#ref-JSSv055i09">2013</a>)</span>, and <code>krigeSTSimTB</code> implementing
the turning bands method <span class="citation">(Schlather <a href="#ref-schlather">2011</a>)</span>. These are of particular
of interest for larger datasets or conditional simulations of
spatiotemporal data.</p>
</div>
<div id="trend-models" class="section level2 hasAnchor">
<h2><span class="header-section-number">12.7</span> Trend models<a href="interpolation.html#trend-models" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Kriging and conditional simulation, as used so far in this
chapter, assume that all spatial variability is a random process,
characterized by a spatial covariance model. In case we have other
variables that are meaningfully correlated with the target variable,
we can use them in a linear regression model for the trend,
<span class="math display">\[
Z(s) = \sum_{j=0}^p \beta_j X_p(s) + e(s)
\]</span>
with <span class="math inline">\(X_0(s) = 1\)</span> and <span class="math inline">\(\beta_0\)</span> an intercept, but with the other
<span class="math inline">\(\beta_j\)</span> regression coefficients. This typically reduces both the
spatial correlation in the residual <span class="math inline">\(e(s)\)</span>, as well as its variance,
and leads to more accurate predictions and more similar conditional
simulations.</p>
<div id="a-population-grid" class="section level3 hasAnchor">
<h3><span class="header-section-number">12.7.1</span> A population grid<a href="interpolation.html#a-population-grid" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As a potential predictor for NO2 in the air, we use population
density. NO2 is mostly caused by traffic, and traffic is stronger
in more densely populated areas.
Population density is obtained from the <a href="https://www.zensus2011.de/DE/Home/Aktuelles/DemografischeGrunddaten.html">2011 census</a>, and is downloaded as a csv file with the number of inhabitants per 100 m grid cell. We can aggregate these data to the target grid cells by summing the inhabitants:</p>
<div class="sourceCode" id="cb400"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb400-1" title="1">v =<span class="st"> </span>vroom<span class="op">::</span><span class="kw">vroom</span>(<span class="st">&quot;aq/pop/Zensus_Bevoelkerung_100m-Gitter.csv&quot;</span>)</a>
<a class="sourceLine" id="cb400-2" title="2">v <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Einwohner <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb400-3" title="3"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>Gitter_ID_100m) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb400-4" title="4"><span class="st">    </span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;x_mp_100m&quot;</span>, <span class="st">&quot;y_mp_100m&quot;</span>), <span class="dt">crs =</span> <span class="dv">3035</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb400-5" title="5"><span class="st">    </span><span class="kw">st_transform</span>(<span class="kw">st_crs</span>(grd)) -&gt;<span class="st"> </span>b</a>
<a class="sourceLine" id="cb400-6" title="6">a =<span class="st"> </span><span class="kw">aggregate</span>(b, <span class="kw">st_as_sf</span>(grd, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>), sum)</a></code></pre></div>
<p>Now we have the population counts per grid cell in <code>a</code>. To get to
population density, we need to find the area of each cell; for cells
crossing the country border, this will be less than 10 x 10 km:</p>
<div class="sourceCode" id="cb401"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb401-1" title="1">grd<span class="op">$</span>ID =<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">prod</span>(<span class="kw">dim</span>(grd)) <span class="co"># so we can find out later which grid cell we have</span></a>
<a class="sourceLine" id="cb401-2" title="2">ii =<span class="st"> </span><span class="kw">st_intersects</span>(grd[<span class="st">&quot;ID&quot;</span>], <span class="kw">st_cast</span>(<span class="kw">st_union</span>(de), <span class="st">&quot;MULTILINESTRING&quot;</span>))</a></code></pre></div>
<pre><code># Warning in st_intersects.stars(grd[&quot;ID&quot;], st_cast(st_union(de),
# &quot;MULTILINESTRING&quot;)): as_points is NA: assuming here that raster cells are small
# polygons, not points</code></pre>
<div class="sourceCode" id="cb403"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb403-1" title="1">grd_sf =<span class="st"> </span><span class="kw">st_as_sf</span>(grd[<span class="st">&quot;ID&quot;</span>], <span class="dt">na.rm =</span> <span class="ot">FALSE</span>)[<span class="kw">lengths</span>(ii) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>,]</a>
<a class="sourceLine" id="cb403-2" title="2">iii =<span class="st"> </span><span class="kw">st_intersection</span>(grd_sf, <span class="kw">st_union</span>(de))</a></code></pre></div>
<pre><code># Warning: attribute variables are assumed to be spatially constant throughout all
# geometries</code></pre>
<div class="sourceCode" id="cb405"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb405-1" title="1">grd<span class="op">$</span>area =<span class="st"> </span><span class="kw">st_area</span>(grd)[[<span class="dv">1</span>]] <span class="op">+</span><span class="st"> </span>units<span class="op">::</span><span class="kw">set_units</span>(grd<span class="op">$</span>values, m<span class="op">^</span><span class="dv">2</span>) <span class="co"># NA&#39;s</span></a>
<a class="sourceLine" id="cb405-2" title="2">grd<span class="op">$</span>area[iii<span class="op">$</span>ID] =<span class="st"> </span><span class="kw">st_area</span>(iii)</a></code></pre></div>
<p>Instead of doing the two-stage procedure above: first finding cells that
have a border crossing it, then computing its area, we could also directly
use <code>st_intersection</code> on all cells, but that takes considerably longer.
From the counts and areas we can compute densities, and verify totals (figure <a href="interpolation.html#fig:popdens">12.10</a>):</p>
<div class="sourceCode" id="cb406"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb406-1" title="1">grd<span class="op">$</span>pop_dens =<span class="st"> </span>a<span class="op">$</span>Einwohner <span class="op">/</span><span class="st"> </span>grd<span class="op">$</span>area</a>
<a class="sourceLine" id="cb406-2" title="2"><span class="kw">sum</span>(grd<span class="op">$</span>pop_dens <span class="op">*</span><span class="st"> </span>grd<span class="op">$</span>area, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="co"># verify</span></a></code></pre></div>
<pre><code># 80323301 [1]</code></pre>
<div class="sourceCode" id="cb408"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb408-1" title="1"><span class="kw">sum</span>(b<span class="op">$</span>Einwohner)</a></code></pre></div>
<pre><code># [1] 80324282</code></pre>
<div class="sourceCode" id="cb410"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb410-1" title="1">g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> grd, <span class="kw">aes</span>(<span class="dt">fill =</span> <span class="kw">sqrt</span>(pop_dens), <span class="dt">x =</span> x, <span class="dt">y =</span> y))</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:popdens"></span>
<img src="sds_files/figure-html/popdens-1.png" alt="Population density for 100 m x 100 m grid cells" width="672" />
<p class="caption">
Figure 12.10: Population density for 100 m x 100 m grid cells
</p>
</div>
<p>We need to divide the number of inhabitants by the number of 100
m grid points contributing to it, in order to convert population
counts into population density.</p>
<p>To obtain population density values at monitoring network stations,
we can use</p>
<div class="sourceCode" id="cb411"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb411-1" title="1">(<span class="dt">a =</span> <span class="kw">aggregate</span>(grd[<span class="st">&quot;pop_dens&quot;</span>], no2.sf, mean))</a></code></pre></div>
<pre><code># stars object with 1 dimensions and 1 attribute
# attribute(s):
#                      Min.  1st Qu.   Median     Mean  3rd Qu.    Max. NA&#39;s
# pop_dens [1/m^2] 3.37e-06 4.98e-05 8.93e-05 0.000195 0.000237 0.00224    1
# dimension(s):
#          from to offset delta            refsys point
# geometry    1 74     NA    NA WGS 84 / UTM z...  TRUE
#                                                     values
# geometry POINT (545414 5930802),...,POINT (835252 5630738)</code></pre>
<div class="sourceCode" id="cb413"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb413-1" title="1">no2.sf<span class="op">$</span>pop_dens =<span class="st"> </span><span class="kw">st_as_sf</span>(a)[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb413-2" title="2"><span class="kw">summary</span>(<span class="kw">lm</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf))</a></code></pre></div>
<pre><code># 
# Call:
# lm(formula = NO2 ~ sqrt(pop_dens), data = no2.sf)
# 
# Residuals:
#    Min     1Q Median     3Q    Max 
#  -7.96  -2.15  -0.50   1.60   8.10 
# 
# Coefficients:
#                Estimate Std. Error t value Pr(&gt;|t|)    
# (Intercept)       4.561      0.697    6.54  8.0e-09 ***
# sqrt(pop_dens)  325.006     49.927    6.51  9.2e-09 ***
# ---
# Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
# 
# Residual standard error: 3.15 on 71 degrees of freedom
#   (1 observation deleted due to missingness)
# Multiple R-squared:  0.374,   Adjusted R-squared:  0.365 
# F-statistic: 42.4 on 1 and 71 DF,  p-value: 9.19e-09</code></pre>
<p>and the corresponding scatterplot is shown in <a href="interpolation.html#fig:no2scat">12.11</a>.</p>
<div class="sourceCode" id="cb415"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb415-1" title="1"><span class="kw">plot</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf)</a>
<a class="sourceLine" id="cb415-2" title="2"><span class="kw">abline</span>(<span class="kw">lm</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf))</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:no2scat"></span>
<img src="sds_files/figure-html/no2scat-1.png" alt="Scatter plot of 2017 annual mean NO2 concentration against population density, for rural background air quality stations" width="70%" />
<p class="caption">
Figure 12.11: Scatter plot of 2017 annual mean NO2 concentration against population density, for rural background air quality stations
</p>
</div>
<p>Prediction under this new model involves first modelling a residual
variogram (figure <a href="interpolation.html#fig:predictusingpopulationdensity">12.12</a>):</p>
<div class="sourceCode" id="cb416"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb416-1" title="1">no2.sf =<span class="st"> </span>no2.sf[<span class="op">!</span><span class="kw">is.na</span>(no2.sf<span class="op">$</span>pop_dens),]</a>
<a class="sourceLine" id="cb416-2" title="2">vr =<span class="st"> </span><span class="kw">variogram</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf)</a>
<a class="sourceLine" id="cb416-3" title="3">vr.m =<span class="st"> </span><span class="kw">fit.variogram</span>(vr, <span class="kw">vgm</span>(<span class="dv">1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">50000</span>, <span class="dv">1</span>))</a></code></pre></div>
<div class="sourceCode" id="cb417"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb417-1" title="1"><span class="kw">plot</span>(vr, vr.m, <span class="dt">plot.numbers =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:predictusingpopulationdensity"></span>
<img src="sds_files/figure-html/predictusingpopulationdensity-1.png" alt="Residual variogram after subtracting population density trend" width="672" />
<p class="caption">
Figure 12.12: Residual variogram after subtracting population density trend
</p>
</div>
<p>and subsequently, kriging prediction is done by (figure <a href="interpolation.html#fig:residualkriging">12.13</a>)</p>
<div class="sourceCode" id="cb418"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb418-1" title="1">kr =<span class="st"> </span><span class="kw">krige</span>(NO2<span class="op">~</span><span class="kw">sqrt</span>(pop_dens), no2.sf, grd[<span class="st">&quot;pop_dens&quot;</span>], vr.m)</a></code></pre></div>
<pre><code># [using universal kriging]</code></pre>
<div class="sourceCode" id="cb420"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb420-1" title="1">k<span class="op">$</span>kr1 =<span class="st"> </span>k<span class="op">$</span>var1.pred</a>
<a class="sourceLine" id="cb420-2" title="2">k<span class="op">$</span>kr2 =<span class="st"> </span>kr<span class="op">$</span>var1.pred</a>
<a class="sourceLine" id="cb420-3" title="3"><span class="kw">st_redimension</span>(k[<span class="kw">c</span>(<span class="st">&quot;kr1&quot;</span>, <span class="st">&quot;kr2&quot;</span>)], </a>
<a class="sourceLine" id="cb420-4" title="4">    <span class="dt">along =</span> <span class="kw">list</span>(<span class="dt">what =</span> <span class="kw">c</span>(<span class="st">&quot;kriging&quot;</span>, <span class="st">&quot;residual kriging&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb420-5" title="5"><span class="st">    </span><span class="kw">setNames</span>(<span class="st">&quot;NO2&quot;</span>) -&gt;<span class="st"> </span>km</a></code></pre></div>

<div class="sourceCode" id="cb421"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb421-1" title="1">g <span class="op">+</span><span class="st"> </span><span class="kw">geom_stars</span>(<span class="dt">data =</span> km, <span class="kw">aes</span>(<span class="dt">fill =</span> NO2, <span class="dt">x =</span> x, <span class="dt">y =</span> y)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb421-2" title="2"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> <span class="kw">st_cast</span>(de, <span class="st">&quot;MULTILINESTRING&quot;</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb421-3" title="3"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">data =</span> no2.sf) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>what) <span class="op">+</span></a>
<a class="sourceLine" id="cb421-4" title="4"><span class="st">    </span><span class="kw">coord_sf</span>(<span class="dt">lims_method =</span> <span class="st">&quot;geometry_bbox&quot;</span>)</a></code></pre></div>
<pre><code># Coordinate system already present. Adding new coordinate system, which will replace the existing one.</code></pre>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:residualkriging"></span>
<img src="sds_files/figure-html/residualkriging-1.png" alt="Kriging NO\(_2\) values using population density as a trend variable" width="672" />
<p class="caption">
Figure 12.13: Kriging NO<span class="math inline">\(_2\)</span> values using population density as a trend variable
</p>
</div>
<p>where, critically, the <code>pop_dens</code> values are now available for
prediction locations in object <code>grd</code>. We see some clear differences:
the map with population density in the trend follows the extremes of
the population density rather than those of the measurement stations,
and has a range that extends that of the former. It should be taken
with a large grain of salt however, since the stations used were
filtered for the category “rural background”, indicating that they
represent conditions of lower populations density. The scatter plot
of Figure <a href="interpolation.html#fig:no2scat">12.11</a> reveals that the the population density
at the locations of stations is much more limited than that in the
population density map, and hence the right-hand side map is based on
strongly extrapolating the relationship shown in <a href="interpolation.html#fig:no2scat">12.11</a>.</p>
</div>
</div>
<div id="exercises-10" class="section level2 hasAnchor">
<h2><span class="header-section-number">12.8</span> Exercises<a href="interpolation.html#exercises-10" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ol style="list-style-type: decimal">
<li>Create a plot like the one in figure <a href="interpolation.html#fig:residualkriging">12.13</a>
that has the inverse distance interpolated map of figure
<a href="interpolation.html#fig:idw">12.2</a> added on left side.</li>
<li>Create a scatter plot of the map values of the idw and kriging
map, and a scatter plot of map values of idw and residual kriging.</li>
<li>Carry out a <em>block kriging</em>, predicting block averages for blocks
centered over grid cells, by setting the <code>block</code> argument in
<code>krige()</code>, and do this for block sizes of 10 km (the grid cell size),
50 km and 200 km. Compare the resulting maps of estimates for these
three blocks sizes with those obtained by point kriging, and
do the same thing for all associated kriging standard errors.</li>
<li>Based on the residual kriging results obtained above, compute
maps of the lower and upper boundary of a 95% confidence interval,
when assuming that the kriging error is normally distributed,
and show them in a plot with a single (joint) legend</li>
<li>Compute and show the map with the probabilities that NO2 point
values exceed the level of 15 ppm, assuming normally distributed
kriging errors.</li>
</ol>

</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references">
<div id="ref-blangiardo2015spatial">
<p>Blangiardo, Marta, and Michela Cameletti. 2015. <em>Spatial and Spatio-Temporal Bayesian Models with R-Inla</em>. John Wiley &amp; Sons.</p>
</div>
<div id="ref-JSSv055i09">
<p>Davies, Tilman, and David Bryant. 2013. “On Circulant Embedding for Gaussian Random Fields in R.” <em>Journal of Statistical Software, Articles</em> 55 (9): 1–21. <a href="https://doi.org/10.18637/jss.v055.i09">https://doi.org/10.18637/jss.v055.i09</a>.</p>
</div>
<div id="ref-Diggle:2007">
<p>Diggle, P. J., and P. J. Ribeiro Jr. 2007. <em>Model-Based Geostatistics</em>. New York: Springer.</p>
</div>
<div id="ref-DiggleTawnMoyeed:98">
<p>Diggle, P. J., J. A. Tawn, and R. A. Moyeed. 1998. “Model-Based Geostatistics.” <em>Applied Statistics</em>, no. 3: 299–350.</p>
</div>
<div id="ref-Heaton2018">
<p>Heaton, Matthew J., Abhirup Datta, Andrew O. Finley, Reinhard Furrer, Joseph Guinness, Rajarshi Guhaniyogi, Florian Gerber, et al. 2018. “A Case Study Competition Among Methods for Analyzing Large Spatial Data.” <em>Journal of Agricultural, Biological and Environmental Statistics</em>, December. <a href="https://doi.org/10.1007/s13253-018-00348-w">https://doi.org/10.1007/s13253-018-00348-w</a>.</p>
</div>
<div id="ref-jh78">
<p>Journel, Andre G, and Charles J Huijbregts. 1978. <em>Mining Geostatistics</em>. Academic press London.</p>
</div>
<div id="ref-R-gstat">
<p>Pebesma, Edzer, and Benedikt Graeler. 2021. <em>Gstat: Spatial and Spatio-Temporal Geostatistical Modelling, Prediction and Simulation</em>. <a href="https://github.com/r-spatial/gstat/">https://github.com/r-spatial/gstat/</a>.</p>
</div>
<div id="ref-gstatcg">
<p>Pebesma, Edzer J. 2004. “Multivariable Geostatistics in S: The Gstat Package.” <em>Computers &amp; Geosciences</em> 30: 683–91.</p>
</div>
<div id="ref-schlather">
<p>Schlather, Martin. 2011. “Construction of Covariance Functions and Unconditional Simulation of Random Fields.” In <em>Porcu, E., Montero, J.m. And Schlather, M., Space-Time Processes and Challenges Related to Environmental Problems</em>. New York: Springer.</p>
</div>
<div id="ref-wikle2019spatio">
<p>Wikle, Christopher K, Andrew Zammit-Mangion, and Noel Cressie. 2019. <em>Spatio-Temporal Statistics with R</em>. CRC Press.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="pointpatterns.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="stgeostatistics.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/edzer/sdsr/edit/master/14-Interpolation.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
