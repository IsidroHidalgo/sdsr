<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.38">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Spatial Data Science - 8&nbsp; Large data and cloud native</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./09-Plotting.html" rel="next">
<link href="./07-Introsf.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Data Science</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./00-part-1.html" class="sidebar-item-text sidebar-link">Spatial Data</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-hello.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting Started</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-Spaces.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Coordinates</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-Geometries.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Geometries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-Spherical.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Spherical Geometries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-Attributes.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Attributes and Support</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./06-part-2.html" class="sidebar-item-text sidebar-link">R for Spatial Data Science</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-Cubes.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Cubes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-Introsf.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-Large.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-Plotting.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Plotting spatial data</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./10-part-3.html" class="sidebar-item-text sidebar-link">Models for Spatial Data</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-Models.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Statistical modelling of spatial data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-PointPattern.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Point Pattern Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-Interpolation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatial Interpolation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-Geostatistics.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Multivariate and Spatiotemporal Geostatistics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-Areal.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Proximity and Areal Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18-SpatialRegression.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Spatial Regression</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30-sp-raster.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Older R Spatial Packages</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./97-allcode.html" class="sidebar-item-text sidebar-link">All R code in this book</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./98-rbascis.html" class="sidebar-item-text sidebar-link">R basics</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">Index</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-largesf" id="toc-sec-largesf" class="nav-link active" data-scroll-target="#sec-largesf"> <span class="header-section-number">8.1</span> Vector data: <code>sf</code></a>
  <ul class="collapse">
  <li><a href="#reading-from-local-disk" id="toc-reading-from-local-disk" class="nav-link" data-scroll-target="#reading-from-local-disk">Reading from local disk</a></li>
  <li><a href="#reading-from-databases-dbplyr" id="toc-reading-from-databases-dbplyr" class="nav-link" data-scroll-target="#reading-from-databases-dbplyr">Reading from databases, dbplyr</a></li>
  <li><a href="#sec-vsi" id="toc-sec-vsi" class="nav-link" data-scroll-target="#sec-vsi">Reading from online resources or web services</a></li>
  <li><a href="#apis-openstreetmap" id="toc-apis-openstreetmap" class="nav-link" data-scroll-target="#apis-openstreetmap">API’s, OpenStreetMap</a></li>
  <li><a href="#cloud-native-geoparquet-and-geoarrow" id="toc-cloud-native-geoparquet-and-geoarrow" class="nav-link" data-scroll-target="#cloud-native-geoparquet-and-geoarrow">Cloud native: GeoParquet and GeoArrow</a></li>
  </ul></li>
  <li><a href="#raster-data-stars" id="toc-raster-data-stars" class="nav-link" data-scroll-target="#raster-data-stars"> <span class="header-section-number">8.2</span> Raster data: <code>stars</code></a>
  <ul class="collapse">
  <li><a href="#stars-proxy-objects" id="toc-stars-proxy-objects" class="nav-link" data-scroll-target="#stars-proxy-objects"><code>stars</code> proxy objects</a></li>
  <li><a href="#operations-on-proxy-objects" id="toc-operations-on-proxy-objects" class="nav-link" data-scroll-target="#operations-on-proxy-objects">Operations on proxy objects</a></li>
  <li><a href="#remote-raster-resources" id="toc-remote-raster-resources" class="nav-link" data-scroll-target="#remote-raster-resources">Remote raster resources</a></li>
  </ul></li>
  <li><a href="#very-large-data-cubes" id="toc-very-large-data-cubes" class="nav-link" data-scroll-target="#very-large-data-cubes"> <span class="header-section-number">8.3</span> Very large data cubes</a>
  <ul class="collapse">
  <li><a href="#finding-and-processing-assets" id="toc-finding-and-processing-assets" class="nav-link" data-scroll-target="#finding-and-processing-assets">Finding and processing assets</a></li>
  <li><a href="#cloud-native-storage-zarr" id="toc-cloud-native-storage-zarr" class="nav-link" data-scroll-target="#cloud-native-storage-zarr">Cloud native storage: Zarr</a></li>
  <li><a href="#apis-for-data-gee-openeo" id="toc-apis-for-data-gee-openeo" class="nav-link" data-scroll-target="#apis-for-data-gee-openeo">APIs for data: GEE, openEO</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"> <span class="header-section-number">8.4</span> Exercises</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-large" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Large data and cloud native</span></span></h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>This chapter describes how large spatial and spatiotemporal datasets can be handled with R, with a focus on packages <code>sf</code> and <code>stars</code>. For practical use, we classify large data sets as either:</p>
<ul>
<li>too large to fit in working memory, or</li>
<li>also too large to fit on the local hard drive, or</li>
<li>also too large to download it to locally managed compute infrastructure (such as network attached storage)</li>
</ul>
<p>These three categories correspond very roughly to Gigabyte-, Terabyte- and Petabyte-sized data sets. Besides size considerations, considerations of access and processing speed also play a role, in particular by larger datasets or interactive applications. Cloud native geospatial formats are formats optimised with processing on cloud infrastructure in mind, where costs of computing and storage need to be considered and optimised. Such costs can be reduced by</p>
<ul>
<li>using better compression, such as the LERC (Limited Error Raster Compression) algorithm used for cloud-optimized GeoTIFF, or the BLOSC compressor used for ZARR array data</li>
<li>fast access to spatial sub-regions, e.g.&nbsp;by ways of http range request enabled for cloud-optimised geotiffs, or column-oriented data access in the GeoParquet and GeoArrow formats</li>
<li>accessing/viewing data at incremental resolution (low resolution images are available before or without the full resolution being read), implemented natively by progressive JPEG formats or by using image pyramids (or overviews) in other raster formats</li>
<li>optimizing data access with particular cloud storage or object storage protocols in mind.</li>
</ul>
<p>It should be noted that there are no silver bullets in this area: optimizing storage for one particular access way will lead to slow access for other ways: for instance if raster data is stored for optimal access of spatial regions at different spatial resolutions, reading the data as pixel time series may be very slow. Compression leads to low storage costs but to higher processing costs when reading, because of the decompression involved.</p>
<section id="sec-largesf" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="sec-largesf"><span class="header-section-number">8.1</span> Vector data: <code>sf</code></h2>
<section id="reading-from-local-disk" class="level3">
<h3 class="anchored" data-anchor-id="reading-from-local-disk">Reading from local disk</h3>
<p>Function <code>st_read</code> reads vector data from disk, using GDAL, and then keeps the data read in working memory. In case the file is too large to be read in working memory, several options exist to read parts of the file. The first is to set argument <code>wkt_filter</code> with a WKT text string containing a geometry; only geometries from the target file that intersect with this geometry will be returned. An example is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Linking to GEOS 3.10.2, GDAL 3.4.3, PROJ 8.2.0; sf_use_s2() is TRUE</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>(file <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"gpkg/nc.gpkg"</span>, <span class="at">package =</span> <span class="st">"sf"</span>))</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "/home/edzer/R/x86_64-pc-linux-gnu-library/4.0/sf/gpkg/nc.gpkg"</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>(<span class="fu">st_bbox</span>(<span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="fl">81.7</span>,<span class="at">ymin =</span> <span class="fl">36.2</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="fl">80.4</span>, <span class="at">ymax =</span> <span class="fl">36.5</span>)) <span class="sc">|&gt;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sfc</span>() <span class="sc">|&gt;</span> <span class="fu">st_as_text</span>() <span class="ot">-&gt;</span> bb)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "POLYGON ((-81.7 36.2, -80.4 36.2, -80.4 36.5, -81.7 36.5, -81.7 36.2))"</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>nc<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">st_read</span>(file, <span class="at">wkt_filter =</span> bb)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading layer `nc.gpkg' from data source </span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   `/home/edzer/R/x86_64-pc-linux-gnu-library/4.0/sf/gpkg/nc.gpkg' </span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   using driver `GPKG'</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple feature collection with 8 features and 14 fields</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimension:     XY</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Bounding box:  xmin: -81.9 ymin: 36 xmax: -80 ymax: 36.6</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Geodetic CRS:  NAD27</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The second option is to use the <code>query</code> argument to <code>st_read</code>, which can be any query in “OGR SQL” dialect, which can be used to select features from a layer, and limit fields. An example is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"select BIR74,SID74,geom from 'nc.gpkg' where BIR74 &gt; 1500"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>nc<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">st_read</span>(file, <span class="at">query =</span> q)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading query `select BIR74,SID74,geom from 'nc.gpkg' where BIR74 &gt; 1500'</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># from data source `/home/edzer/R/x86_64-pc-linux-gnu-library/4.0/sf/gpkg/nc.gpkg' </span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   using driver `GPKG'</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple feature collection with 61 features and 2 fields</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimension:     XY</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Bounding box:  xmin: -83.3 ymin: 33.9 xmax: -76.1 ymax: 36.6</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Geodetic CRS:  NAD27</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that <code>nc.gpkg</code> is the <em>layer name</em>, which can be obtained from <code>file</code> using <code>st_layers</code>. Sequences of records can be read using <code>LIMIT</code> and <code>OFFSET</code>, to read records 51-60 use</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"select BIR74,SID74,geom from 'nc.gpkg' LIMIT 10 OFFSET 50"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>nc<span class="fl">.2</span> <span class="ot">&lt;-</span> <span class="fu">st_read</span>(file, <span class="at">query =</span> q)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading query `select BIR74,SID74,geom from 'nc.gpkg' LIMIT 10 OFFSET 50'</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># from data source `/home/edzer/R/x86_64-pc-linux-gnu-library/4.0/sf/gpkg/nc.gpkg' </span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   using driver `GPKG'</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple feature collection with 10 features and 2 fields</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimension:     XY</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Bounding box:  xmin: -84 ymin: 35.2 xmax: -75.5 ymax: 36.2</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Geodetic CRS:  NAD27</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Further query options include selection on geometry type, polygon area. When the dataset queried is a spatial database, then the query is passed on to the database and not interpreted by GDAL; this means that more powerful features will be available. Further information is found in the GDAL documentation under “OGR SQL dialect”.</p>
<p>Very large files or directories that are zipped can be read without the need to unzip them, using the <code>/vsizip</code> (for zip), <code>/vsigzip</code> (for gzip) or <code>/vsitar</code> (for tar files) prefix to files; this is followed by the path to the zip file, and then followed by the file inside this zip file. Reading files this way may come at some computational cost.</p>
</section>
<section id="reading-from-databases-dbplyr" class="level3">
<h3 class="anchored" data-anchor-id="reading-from-databases-dbplyr">Reading from databases, dbplyr</h3>
<div class="cell">

</div>
<div class="cell">

</div>
<p>Although GDAL has support for several spatial databases, and as mentioned above it passes on SQL in the <code>query</code> argument to the database, it is sometimes beneficial to directly read from and write to a spatial database using the R database drivers for this. An example of this is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>pg <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    RPostgres<span class="sc">::</span><span class="fu">Postgres</span>(),</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">host =</span> <span class="st">"localhost"</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">dbname =</span> <span class="st">"postgis"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">st_read</span>(pg, <span class="at">query =</span> <span class="st">"select BIR74,wkb_geometry from nc limit 3"</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple feature collection with 3 features and 1 field</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimension:     XY</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Bounding box:  xmin: -81.7 ymin: 36.2 xmax: -80.4 ymax: 36.6</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Geodetic CRS:  NAD27</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   bir74                   wkb_geometry</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 1  1091 MULTIPOLYGON (((-81.5 36.2,...</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 2   487 MULTIPOLYGON (((-81.2 36.4,...</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 3  3188 MULTIPOLYGON (((-80.5 36.2,...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A spatial query might look like</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="st">"SELECT BIR74,wkb_geometry FROM nc WHERE \</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="st">  ST_Intersects(wkb_geometry, 'SRID=4267;POINT (-81.50 36.43)');"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">st_read</span>(pg, <span class="at">query =</span> q)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple feature collection with 1 feature and 1 field</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Geometry type: MULTIPOLYGON</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Dimension:     XY</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Bounding box:  xmin: -81.7 ymin: 36.2 xmax: -81.2 ymax: 36.6</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Geodetic CRS:  NAD27</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   bir74                   wkb_geometry</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 1  1091 MULTIPOLYGON (((-81.5 36.2,...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, the intersection is done in the database, and uses the spatial index typically present.</p>
<p>The same mechanism works when using <code>dplyr</code> with a database backend:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>nc_db <span class="ot">&lt;-</span> <span class="fu">tbl</span>(pg, <span class="st">"nc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Spatial queries can be formulated and are passed on to the database:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>nc_db <span class="sc">|&gt;</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>     <span class="fu">filter</span>(<span class="fu">ST_Intersects</span>(wkb_geometry, </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                          <span class="st">'SRID=4267;POINT (-81.50 36.43)'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">collect</span>()</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # A tibble: 1 × 16</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   ogc_fid  area perimeter cnty_ cnty_id name  fips  fipsno</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     &lt;int&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 1       1 0.114      1.44  1825    1825 Ashe  37009  37009</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># # … with 8 more variables: cress_id &lt;int&gt;, bir74 &lt;dbl&gt;,</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># #   sid74 &lt;dbl&gt;, nwbir74 &lt;dbl&gt;, bir79 &lt;dbl&gt;, sid79 &lt;dbl&gt;,</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># #   nwbir79 &lt;dbl&gt;, wkb_geometry &lt;pq_gmtry&gt;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>nc_db <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">ST_Area</span>(wkb_geometry) <span class="sc">&gt;</span> <span class="fl">0.1</span>) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">3</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"># # Source:   SQL [3 x 16]</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># # Database: postgres  [edzer@localhost:5432/postgis]</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   ogc_fid  area perimeter cnty_ cnty_id name        fips  fipsno</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     &lt;int&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;  &lt;dbl&gt;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 1       1 0.114      1.44  1825    1825 Ashe        37009  37009</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2       3 0.143      1.63  1828    1828 Surry       37171  37171</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 3       5 0.153      2.21  1832    1832 Northampton 37131  37131</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="co"># # … with 8 more variables: cress_id &lt;int&gt;, bir74 &lt;dbl&gt;,</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="co"># #   sid74 &lt;dbl&gt;, nwbir74 &lt;dbl&gt;, bir79 &lt;dbl&gt;, sid79 &lt;dbl&gt;,</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="co"># #   nwbir79 &lt;dbl&gt;, wkb_geometry &lt;pq_gmtry&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It should be noted that PostGIS’ <code>ST_Area</code> computes the same area as the <code>AREA</code> field in <code>nc</code>, which is the meaningless value obtained by assuming the coordinates are projected, although they are ellipsoidal.</p>
</section>
<section id="sec-vsi" class="level3">
<h3 class="anchored" data-anchor-id="sec-vsi">Reading from online resources or web services</h3>
<p>GDAL drivers support reading from online resources, by prepending <code>/vsicurl/</code> before the URL starting with e.g.&nbsp;<code>https://</code>. A number of similar drivers specialized for particular clouds include <code>/vsis3/</code> for Amazon S3, <code>/vsigs/</code> for Google Cloud Storage, <code>/vsiaz/</code> for Azure, <code>/vsioss/</code> for Alibaba Cloud, or <code>/vsiswift/</code> for OpenStack Swift Object Storage. These prepositions can be combined e.g.&nbsp;with <code>/vsizip/</code> to read a zipped online resource. Depending on the file format used, reading information this way may always involve reading the entire file, or reading it multiple times, and may not always be the most efficient way of handling resources.</p>
</section>
<section id="apis-openstreetmap" class="level3">
<h3 class="anchored" data-anchor-id="apis-openstreetmap">API’s, OpenStreetMap</h3>
<p>Although online resource do not have to be stored files but could be created server-side on the fly, typical web services for geospatial data create data on the fly, and give access to this through an API. As an example, data from <a href="https://openstreetmap.org/">OpenStreetMap</a> can be bulk downloaded and read locally, e.g.&nbsp;using the GDAL vector driver, but more typical a user wants to obtain a small subset of the data or use the data for a small query. Several R packages exist that query OpenStreetMap data:</p>
<ul>
<li>Package <code>OpenStreetMap</code> downloads data as raster tiles, typically used as backdrop or reference for plotting other features</li>
<li>Package <code>osmdata</code> downloads vector data as points, lines or polygons in <code>sf</code> or <code>sp</code> format</li>
<li>Package <code>osmar</code> returns vector data, but in addition the network topology (as an <code>igraph</code> object) that contains how road elements form a network, and has functions that compute the shortest route</li>
</ul>
<p>When provided with a correctly formulated API call in the URL the highly configurable GDAL OSM driver (in <code>st_read</code>) can read an “.osm” file (xml) and returns a dataset with five layers: <code>points</code> that have significant tags, <code>lines</code> with non-area “way” features, <code>multilinestrings</code> with “relation” features, <code>multipolygons</code> with “relation” features and <code>other_relations</code>. A simple and very small bounding box query to OpenStreetMap could look like</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="st">"https://openstreetmap.org/api/0.6/map?bbox=7.595,51.969,7.598,51.970"</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="st">"data/ms.osm"</span>, <span class="at">method =</span> <span class="st">"auto"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and from this file we can read the layer <code>lines</code>, and plot its first attribute by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>o <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"data/ms.osm"</span>, <span class="st">"lines"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">"data/ms.osm"</span>, <span class="st">"multipolygons"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>bb <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(<span class="fu">c</span>(<span class="at">xmin =</span> <span class="fl">7.595</span>, <span class="at">ymin =</span> <span class="fl">51.969</span>, </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">xmax =</span> <span class="fl">7.598</span>, <span class="at">ymax =</span> <span class="fl">51.970</span>), <span class="at">crs =</span> <span class="st">'OGC:CRS84'</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_as_sfc</span>(bb), <span class="at">axes =</span> <span class="cn">TRUE</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">cex.axis =</span> .<span class="dv">5</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(o[,<span class="dv">1</span>], <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(p), <span class="at">border =</span> <span class="cn">NA</span>, <span class="at">col =</span> <span class="st">'#88888888'</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-overpass" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="08-Large_files/figure-html/fig-overpass-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 8.1: OpenStreetMap vector data</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>the result of which is shown in <a href="#fig-overpass">Figure&nbsp;<span>8.1</span></a> . The overpass API provides a more generic and powerful query functionality to OpenStreetMap data.</p>
</section>
<section id="cloud-native-geoparquet-and-geoarrow" class="level3">
<h3 class="anchored" data-anchor-id="cloud-native-geoparquet-and-geoarrow">Cloud native: GeoParquet and GeoArrow</h3>
<p>Two formats dedicated to cloud native analysis are derived from the Apache projects Parquet and Arrow. Both provide column oriented storage of tabular data, meaning that the reading of a single fields for many records is fast, compared to record oriented storage of most other databases. The Geo- extensions of both involve</p>
<ul>
<li>a way of storing a geometry column, either in a well-known binary or text form, or in a more efficient form where sub-geometries are indexed up front</li>
<li>storage of a coordinate reference system.</li>
</ul>
<p>At the time of writing this book, both formats are under active development but drivers for reading or creating them are available in GDAL starting from version 3.5. Both formats allow for compressed storage; the difference seems to be that (Geo)Parquet is more oriented towards persistent storage, where (Geo)Arrow is more oriented to fast access and fast computation; Arrow can for instance be both an in-memory and an on-disk format.</p>
</section>
</section>
<section id="raster-data-stars" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="raster-data-stars"><span class="header-section-number">8.2</span> Raster data: <code>stars</code></h2>
<p>A common challenge with raster datasets is not only that they come in large files (single Sentinel-2 tiles are around 1 GB), but that many of these files, potentially thousands, are needed to address the area and time period of interest. At time of writing this, the Copernicus program that runs all Sentinel satellites publishes 160 TB of images per day. This means that a classic pattern in using R, consisting of:</p>
<ul>
<li>downloading data to local disc,</li>
<li>loading the data in memory,</li>
<li>analysing it</li>
</ul>
<p>is not going to work.</p>
<p>Cloud-based Earth Observation processing platforms like Google Earth Engine <span class="citation" data-cites="gorelick">(<a href="references.html#ref-gorelick" role="doc-biblioref">Gorelick et al. 2017</a>)</span> or <a href="https://www.sentinel-hub.com/">Sentinel Hub</a> recognize this and let users work with datasets up to the petabyte range rather easily and with a great deal of interactivity. They share the following properties:</p>
<ul>
<li>computations are postponed as long as possible (lazy evaluation)</li>
<li>only the data you ask for are being computed and returned, and nothing more</li>
<li>storing intermediate results is avoided in favour of on-the-fly computations</li>
<li>maps with useful results are generated and shown quickly to allow for interactive model development</li>
</ul>
<p>This is similar to the <code>dbplyr</code> interface to databases and cloud-based analytics environments, but differs in the aspect of <em>what</em> we want to see quickly: rather than the first <span class="math inline">\(n\)</span> records of a <code>dbplyr</code> table, we want a quick <em>overview</em> of the results, in the form of a map covering the whole area, or part of it, but at screen resolution rather than native (observation) resolution.</p>
<p>If for instance we want to “see” results for the United States on screen with 1000 x 1000 pixels, we only need to compute results for this many pixels, which corresponds roughly to data on a grid with 3000 m x 3000 m grid cells. For Sentinel-2 data with 10 m resolution, this means we can subsample with a factor 300, giving 3 km x 3 km resolution. Processing, storage and network requirements then drop a factor <span class="math inline">\(300^2 \approx 10^5\)</span>, compared to working on the native 10 m x 10 m resolution. On the platforms mentioned, zooming in the map triggers further computations on a finer resolution and smaller extent.</p>
<p>A simple optimisation that follows these lines is how stars’ plot method works: in the case of plotting large rasters, it subsamples the array before it plots, drastically saving time. The degree of subsampling is derived from the plotting region size and the plotting resolution (pixel density). For vector devices, such as pdf, R sets plot resolution to 75 dpi, corresponding to 0.3 mm per pixel. Enlarging plots may reveal this, but replotting to an enlarged devices will create a plot at target density.</p>
<section id="stars-proxy-objects" class="level3">
<h3 class="anchored" data-anchor-id="stars-proxy-objects"><code>stars</code> proxy objects</h3>
<p>To handle datasets that are too large to fit in memory, <code>stars</code> provides <code>stars_proxy</code> objects. To demonstrate its use, we will use the <code>starsdata</code> package, an R data package with larger datasets (around 1 GB total). It can be installed by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">timeout =</span> <span class="dv">600</span>) <span class="co"># or large in case of slow network</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"starsdata"</span>, <span class="at">repos =</span> <span class="st">"http://pebesma.staff.ifgi.de"</span>, </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"source"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can “load” a Sentinel-2 image from it by</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Loading required package: abind</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"sentinel/S2A_MSIL1C_20180220T105051_N0206"</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>           <span class="st">"_R051_T32ULE_20180221T134037.zip"</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>granule <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="at">file =</span> f, <span class="at">package =</span> <span class="st">"starsdata"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">file.size</span>(granule)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 7.69e+08</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>base_name <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(<span class="fu">basename</span>(granule), <span class="st">".zip"</span>)[[<span class="dv">1</span>]]</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>s2 <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"SENTINEL2_L1C:/vsizip/"</span>, granule, <span class="st">"/"</span>, base_name, </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">".SAFE/MTD_MSIL1C.xml:10m:EPSG_32632"</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>(p <span class="ot">&lt;-</span> <span class="fu">read_stars</span>(s2, <span class="at">proxy =</span> <span class="cn">TRUE</span>))</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co"># stars_proxy object with 1 attribute in 1 file(s):</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># $EPSG_32632</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] "[...]/MTD_MSIL1C.xml:10m:EPSG_32632"</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension(s):</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co">#      from    to offset delta            refsys point    values</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co"># x       1 10980  3e+05    10 WGS 84 / UTM z...    NA      NULL</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co"># y       1 10980  6e+06   -10 WGS 84 / UTM z...    NA      NULL</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co"># band    1     4     NA    NA                NA    NA B4,...,B8</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co">#      x/y</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co"># x    [x]</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co"># y    [y]</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co"># band</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="fu">object.size</span>(p)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 11808 bytes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and we see that this does not actually load <em>any</em> of the pixel values, but keeps the reference to the dataset and fills the dimensions table. (The convoluted <code>s2</code> name is needed to point GDAL to the right file inside the <code>.zip</code> file containing 115 files in total).</p>
<p>The idea of a proxy object is that we can build expressions like</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> p <span class="sc">*</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>but that the computations for this are postponed. Only when we really need the data, e.g.&nbsp;because we want to plot it, is <code>p * 2</code> evaluated. We need data when either:</p>
<ul>
<li>we want to <code>plot</code> data, or</li>
<li>we want to write an object to disk, with <code>write_stars</code>, or</li>
<li>we want to explicitly load an object in memory, with <code>st_as_stars</code></li>
</ul>
<p>In case the entire object does not fit in memory, <code>plot</code> and <code>write_stars</code> choose different strategies to deal with this:</p>
<ul>
<li><code>plot</code> fetches only the pixels that can be seen, rather than all pixels available</li>
<li><code>write_stars</code> reads, processes, and writes data chunk by chunk</li>
</ul>
<p>Downsampling and chunking is implemented for spatially dense images, not e.g.&nbsp;for dense time series, or other dense dimensions.</p>
<p>As an example, the output of <code>plot(p)</code>, shown in <a href="#fig-plotp">Figure&nbsp;<span>8.2</span></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-plotp" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="08-Large_files/figure-html/fig-plotp-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 8.2: downsampled 10 m bands of a Sentinel-2 scene</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>only fetches the pixels that can be seen on the plot device, rather than the 10980 x 10980 pixels available in each band. The downsampling ratio taken is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>(ds <span class="ot">&lt;-</span> <span class="fu">floor</span>(<span class="fu">sqrt</span>(<span class="fu">prod</span>(<span class="fu">dim</span>(p)) <span class="sc">/</span> <span class="fu">prod</span>(<span class="fu">dev.size</span>(<span class="st">"px"</span>)))))</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 19</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>meaning that for every 19 <span class="math inline">\(\times\)</span> 19 sub-image in the original image, only one pixel is read, and plotted. This value is still a bit too low as it ignores the white space and space for the key on the plotting device.</p>
</section>
<section id="operations-on-proxy-objects" class="level3">
<h3 class="anchored" data-anchor-id="operations-on-proxy-objects">Operations on proxy objects</h3>
<p>Several dedicated methods are available for <code>stars_proxy</code> objects:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">methods</span>(<span class="at">class =</span> <span class="st">"stars_proxy"</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  [1] [               [[&lt;-            [&lt;-            </span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  [4] adrop           aggregate       aperm          </span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  [7] as.data.frame   c               coerce         </span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># [10] dim             droplevels      filter         </span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># [13] hist            initialize      is.na          </span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># [16] Math            merge           mutate         </span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># [19] Ops             plot            predict        </span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># [22] print           pull            rename         </span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co"># [25] select          show            slice          </span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co"># [28] slotsFromS3     split           st_apply       </span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co"># [31] st_as_sf        st_as_stars     st_crop        </span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># [34] st_dimensions&lt;- st_downsample   st_mosaic      </span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co"># [37] st_redimension  st_sample       st_set_bbox    </span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co"># [40] transmute       write_stars    </span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co"># see '?methods' for accessing help and source code</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have seen <code>plot</code> and <code>print</code> in action; <code>dim</code> reads out the dimension from the dimensions metadata table.</p>
<p>The three methods that actually fetch data are <code>st_as_stars</code>, <code>plot</code> and <code>write_stars</code>. <code>st_as_stars</code> reads the actual data into a <code>stars</code> object, its argument <code>downsample</code> controls the downsampling rate. <code>plot</code> does this too, choosing an appropriate <code>downsample</code> value from the device resolution, and plots the object. <code>write_stars</code> writes a <code>stars_proxy</code> object to disk.</p>
<p>All other methods for <code>stars_proxy</code> objects do not actually operate on the raster data but add the operations to a <em>to do</em> list, attached to the object. Only when actual raster data are fetched, e.g.&nbsp;by calling <code>plot</code> or <code>st_as_stars</code>, the commands in this list are executed.</p>
<p><code>st_crop</code> limits the extent (area) of the raster that will be read. <code>c</code> combines <code>stars_proxy</code> objects, but still doesn’t read any data. <code>adrop</code> drops empty dimensions, <code>aperm</code> changes dimension order.</p>
<p><code>write_stars</code> reads and processes its input chunk-wise; it has an argument <code>chunk_size</code> that lets users control the size of spatial chunks.</p>
</section>
<section id="remote-raster-resources" class="level3">
<h3 class="anchored" data-anchor-id="remote-raster-resources">Remote raster resources</h3>
<p>A format like “cloud-optimized GeoTIFF” (COG) has been specially designed to be efficient and resource-friendly in many cases, e.g.&nbsp;for only reading the metadata, or for only reading overviews (low-resolutions versions of the full imagery) or spatial regions using the <code>/vsixxx/</code> mechanisms (<a href="#sec-vsi"><span>Section&nbsp;8.1.3</span></a>). COGs can also be created using the GeoTIFF driver of GDAL, and setting the right dataset creation options in a <code>write_stars</code> call.</p>
</section>
</section>
<section id="very-large-data-cubes" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="very-large-data-cubes"><span class="header-section-number">8.3</span> Very large data cubes</h2>
<p>At some stage, data sets need to be analysed that are so large that downloading them is no longer feasible; even when local storage would be sufficient, network bandwidth may become limiting. Examples are satellite image archives such as those from Landsat and Copernicus (Sentinel-x), or model computations such as the ERA5 <span class="citation" data-cites="era5">(<a href="references.html#ref-era5" role="doc-biblioref">Hersbach et al. 2020</a>)</span>, a model reanalysis of the global atmosphere, land surface and ocean waves from 1950 onwards. In such cases it may be most helpful to gain access to virtual machines in a cloud that has these data available, or to use a system that lets the user carry out computations without having to worry about virtual machines and storage. Both options will be discussed.</p>
<section id="finding-and-processing-assets" class="level3">
<h3 class="anchored" data-anchor-id="finding-and-processing-assets">Finding and processing assets</h3>
<p>When working on a virtual machine on a cloud, a first task is usually to find the assets (files) to work on. It looks attractive to obtain a file listing, and then parse file names such as</p>
<pre><code>S2A_MSIL1C_20180220T105051_N0206_R051_T32ULE_20180221T134037.zip</code></pre>
<p>for their metadata including the date of acquisition and the code of the spatial tile covered. Obtaining such a file listing however is usually computationally very demanding, as is the processing of the result, when the number of tiles runs in the many millions.</p>
<p>A solution to this is to use a catalogue. The recently developed and increasingly deployed STAC, short for <em>spatiotemporal asset catalogue</em>, provides an API that can be used to query image collections by properties like bounding box, date, band, and cloud coverage. The R package <code>rstac</code> <span class="citation" data-cites="R-rstac">(<a href="references.html#ref-R-rstac" role="doc-biblioref">Brazil Data Cube Team 2021</a>)</span> provides an R interface to create queries, and manage the information returned.</p>
<p>Processing the resulting files may involve creating a data cube at a lower spatial and/or temporal resolution, from images that may span a range of coordinate reference systems (e.g., several UTM zones). An R package that can do that is gdalcubes <span class="citation" data-cites="R-gdalcubes appel2019demand">(<a href="references.html#ref-R-gdalcubes" role="doc-biblioref">Appel 2022</a>; <a href="references.html#ref-appel2019demand" role="doc-biblioref">Appel and Pebesma 2019</a>)</span>, which can also directly use STAC output <span class="citation" data-cites="appelblog">(<a href="references.html#ref-appelblog" role="doc-biblioref">Appel, Pebesma, and Mohr 2021</a>)</span>.</p>
</section>
<section id="cloud-native-storage-zarr" class="level3">
<h3 class="anchored" data-anchor-id="cloud-native-storage-zarr">Cloud native storage: Zarr</h3>
<p>Where COG provides cloud native storage for raster imagery, Zarr is a format for cloud native storage of large multidimensional arrays. It can be seen as a successor of NetCDF and seems to follow similar conventions, being used by the climate and forecast communities. Zarr “files” are really directories with subdirectories containing compressed chunks of the data. The compression algorithm and the chunking strategy will have an effect on how fast particular sub-cubes can be read. Function <code>stars::read_mdim</code> has options for reading sub-cubes by specifying offset and size of the index in each dimension, and a step size to read one or more dimensions at a lower resolution. Similarly, <code>stars::write_mdim</code> can write multidimensional arrays to Zarr (or NetCDF) files. Both use the GDAL C++ multidimensional array API for this.</p>
</section>
<section id="apis-for-data-gee-openeo" class="level3">
<h3 class="anchored" data-anchor-id="apis-for-data-gee-openeo">APIs for data: GEE, openEO</h3>
<p>Platforms that do not require the management and programming of virtual machines <em>in</em> the cloud but provide direct access to the imagery managed include GEE, openEO, and the climate data store.</p>
<p>Google Earth Engine (GEE) is a cloud platform that allows users to compute on large amounts of Earth Observation data as well as modelling products <span class="citation" data-cites="gorelick">(<a href="references.html#ref-gorelick" role="doc-biblioref">Gorelick et al. 2017</a>)</span>. It has powerful analysis capabilities, including most of the data cube operations explained in <a href="06-Cubes.html#sec-dcoperations"><span>Section&nbsp;6.3</span></a>. It has an IDE where scripts can be written in JavaScript, and a Python interface to the same functionality. The code of GEE is not open source, and cannot be extended by arbitrary user-defined functions in languages like Python or R. R package <code>rgee</code> <span class="citation" data-cites="R-rgee">(<a href="references.html#ref-R-rgee" role="doc-biblioref">Aybar 2022</a>)</span> provides an R client interface to GEE.</p>
<p>Cloud-based data cube processing platforms built entirely around open source software are emerging, several of which using the openEO API <span class="citation" data-cites="openEO">(<a href="references.html#ref-openEO" role="doc-biblioref">Schramm et al. 2021</a>)</span>. This API allows for user-defined functions (UDFs) written in Python or R that are being passed on through the API and executed at the pixel level, e.g.&nbsp;to aggregate or reduce dimensions. UDFs in R represent the data chunk to be processed as a <code>stars</code> object, in Python <code>xarray</code> objects are used.</p>
<p>Other platforms include the Copernicus climate data store <span class="citation" data-cites="cds">(<a href="references.html#ref-cds" role="doc-biblioref">Raoult et al. 2017</a>)</span> or atmosphere data store, which allow processing of atmospheric or climate data from ECMWF, including ERA5. An R package with an interface to both data stores is <code>ecmwfr</code> <span class="citation" data-cites="R-ecmwfr">(<a href="references.html#ref-R-ecmwfr" role="doc-biblioref">Hufkens 2020</a>)</span>.</p>
</section>
</section>
<section id="exercises" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="exercises"><span class="header-section-number">8.4</span> Exercises</h2>
<p>Use R to solve the following exercises.</p>
<ol type="1">
<li>For the S2 image (above), find out in which order the bands are by using <code>st_get_dimension_values()</code>, and try to find out (e.g.&nbsp;by internet search) which spectral bands / colors they correspond to.</li>
<li>Compute NDVI for the S2 image, using <code>st_apply</code> and an an appropriate <code>ndvi</code> function. Plot the result to screen, and then write the result to a GeoTIFF. Explain the difference in runtime between plotting and writing.</li>
<li>Plot an RGB composite of the S2 image, using the <code>rgb</code> argument to <code>plot()</code>, and then by using <code>st_rgb()</code> first.</li>
<li>Select five random points from the bounding box of <code>S2</code>, and extract the band values at these points; convert the object returned to an <code>sf</code> object.</li>
<li>For the 10 km radius circle around <code>POINT(390000  5940000)</code>, use <code>aggregate</code> to compute the mean pixel values of the S2 image when downsampling the images with factor 30, and on the original resolution. Compute the relative difference between the results.</li>
<li>Use <code>hist</code> to compute the histogram on the downsampled S2 image. Also do this for each of the bands. Use <code>ggplot2</code> to compute a single plot with all four histograms.</li>
<li>Use <code>st_crop</code> to crop the S2 image to the area covered by the 10 km circle. Plot the results. Explore the effect of setting argument <code>crop = FALSE</code></li>
<li>With the downsampled image, compute the logical layer where all four bands have pixel values higher than 1000. Use a raster algebra expression on the four bands (use <code>split</code> first), or use <code>st_apply</code> for this.</li>
</ol>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-R-gdalcubes" class="csl-entry" role="doc-biblioentry">
Appel, Marius. 2022. <em>Gdalcubes: Earth Observation Data Cubes from Satellite Image Collections</em>. <a href="https://github.com/appelmar/gdalcubes_R">https://github.com/appelmar/gdalcubes_R</a>.
</div>
<div id="ref-appel2019demand" class="csl-entry" role="doc-biblioentry">
Appel, Marius, and Edzer Pebesma. 2019. <span>“On-Demand Processing of Data Cubes from Satellite Image Collections with the Gdalcubes Library.”</span> <em>Data</em> 4 (3): 92. <a href="https://www.mdpi.com/2306-5729/4/3/92">https://www.mdpi.com/2306-5729/4/3/92</a>.
</div>
<div id="ref-appelblog" class="csl-entry" role="doc-biblioentry">
Appel, Marius, Edzer Pebesma, and Matthias Mohr. 2021. <em>Cloud-Based Processing of Satellite Image Collections in r Using STAC, COGs, and on-Demand Data Cubes</em>. <a href="https://r-spatial.org/r/2021/04/23/cloud-based-cubes.html">https://r-spatial.org/r/2021/04/23/cloud-based-cubes.html</a>.
</div>
<div id="ref-R-rgee" class="csl-entry" role="doc-biblioentry">
Aybar, Cesar. 2022. <em>Rgee: R Bindings for Calling the Earth Engine API</em>. <a href="https://CRAN.R-project.org/package=rgee">https://CRAN.R-project.org/package=rgee</a>.
</div>
<div id="ref-R-rstac" class="csl-entry" role="doc-biblioentry">
Brazil Data Cube Team. 2021. <em>Rstac: Client Library for SpatioTemporal Asset Catalog</em>. <a href="https://github.com/brazil-data-cube/rstac">https://github.com/brazil-data-cube/rstac</a>.
</div>
<div id="ref-gorelick" class="csl-entry" role="doc-biblioentry">
Gorelick, Noel, Matt Hancher, Mike Dixon, Simon Ilyushchenko, David Thau, and Rebecca Moore. 2017. <span>“Google Earth Engine: Planetary-Scale Geospatial Analysis for Everyone.”</span> <em>Remote Sensing of Environment</em> 202: 18–27. <a href="https://doi.org/10.1016/j.rse.2017.06.031">https://doi.org/10.1016/j.rse.2017.06.031</a>.
</div>
<div id="ref-era5" class="csl-entry" role="doc-biblioentry">
Hersbach, Hans, Bill Bell, Paul Berrisford, Shoji Hirahara, András Horányi, Joaquín Muñoz-Sabater, Julien Nicolas, et al. 2020. <span>“The Era5 Global Reanalysis.”</span> <em>Quarterly Journal of the Royal Meteorological Society</em> 146 (730): 1999–2049. https://doi.org/<a href="https://doi.org/10.1002/qj.3803">https://doi.org/10.1002/qj.3803</a>.
</div>
<div id="ref-R-ecmwfr" class="csl-entry" role="doc-biblioentry">
Hufkens, Koen. 2020. <em>Ecmwfr: Interface to ECMWF and CDS Data Web Services</em>. <a href="https://github.com/bluegreen-labs/ecmwfr">https://github.com/bluegreen-labs/ecmwfr</a>.
</div>
<div id="ref-cds" class="csl-entry" role="doc-biblioentry">
Raoult, Baudouin, Cedric Bergeron, Angel López Alós, Jean-Noël Thépaut, and Dick Dee. 2017. <span>“Climate Service Develops User-Friendly Data Store.”</span> <em>ECMWF Newsletter</em> 151: 22–27.
</div>
<div id="ref-openEO" class="csl-entry" role="doc-biblioentry">
Schramm, Matthias, Edzer Pebesma, Milutin Milenković, Luca Foresta, Jeroen Dries, Alexander Jacob, Wolfgang Wagner, et al. 2021. <span>“The <span class="nocase">openEO</span> <span>API</span>–Harmonising the Use of Earth Observation Cloud Services Using Virtual Data Cube Functionalities.”</span> <em>Remote Sensing</em> 13 (6). <a href="https://doi.org/10.3390/rs13061125">https://doi.org/10.3390/rs13061125</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./07-Introsf.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Introduction to sf and stars</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./09-Plotting.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Plotting spatial data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>