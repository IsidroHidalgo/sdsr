<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 15 Measures of spatial autocorrelation | Spatial Data Science</title>
  <meta name="description" content="description_xx" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 15 Measures of spatial autocorrelation | Spatial Data Science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="description_xx" />
  <meta name="github-repo" content="edzer/sdsr" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 15 Measures of spatial autocorrelation | Spatial Data Science" />
  
  <meta name="twitter:description" content="description_xx" />
  

<meta name="author" content="Edzer Pebesma, Roger Bivand" />


<meta name="date" content="2022-02-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="area.html"/>
<link rel="next" href="spatglmm.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />

<script>
/* ========================================================================
 * Bootstrap: transition.js v3.3.7
 * http://getbootstrap.com/javascript/#transitions
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // CSS TRANSITION SUPPORT (Shoutout: http://www.modernizr.com/)
  // ============================================================

  function transitionEnd() {
    var el = document.createElement('bootstrap')

    var transEndEventNames = {
      WebkitTransition : 'webkitTransitionEnd',
      MozTransition    : 'transitionend',
      OTransition      : 'oTransitionEnd otransitionend',
      transition       : 'transitionend'
    }

    for (var name in transEndEventNames) {
      if (el.style[name] !== undefined) {
        return { end: transEndEventNames[name] }
      }
    }

    return false // explicit for ie8 (  ._.)
  }

  // http://blog.alexmaccaw.com/css-transitions
  $.fn.emulateTransitionEnd = function (duration) {
    var called = false
    var $el = this
    $(this).one('bsTransitionEnd', function () { called = true })
    var callback = function () { if (!called) $($el).trigger($.support.transition.end) }
    setTimeout(callback, duration)
    return this
  }

  $(function () {
    $.support.transition = transitionEnd()

    if (!$.support.transition) return

    $.event.special.bsTransitionEnd = {
      bindType: $.support.transition.end,
      delegateType: $.support.transition.end,
      handle: function (e) {
        if ($(e.target).is(this)) return e.handleObj.handler.apply(this, arguments)
      }
    }
  })

}(jQuery);
</script>
<script>
/* ========================================================================
 * Bootstrap: collapse.js v3.3.7
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */

/* jshint latedef: false */

+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $('[data-toggle="collapse"][href="#' + element.id + '"],' +
                           '[data-toggle="collapse"][data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.7'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.children('.panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && /show|hide/.test(option)) options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $this.data()

    Plugin.call($target, option)
  })

}(jQuery);
</script>
<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    // close the dropdown menu when an option is clicked
    $("#allCodeButton").dropdown("toggle");
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.sourceCode, pre.r, pre.python, pre.bash, pre.sql, pre.cpp, pre.stan');
  rCodeBlocks.each(function() {

    // if code block has been labeled with class `fold-show`, show the code on init!
    var classList = $(this).attr('class').split(/\s+/);
    for (var i = 0; i < classList.length; i++) {
    if (classList[i] === 'fold-show') {
        show = true;
      }
    }

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above
    var showCodeText = $('<span>' + (show ? 'Hide' : 'Code') + '</span>');
    var showCodeButton = $('<button type="button" class="btn btn-default btn-xs code-folding-btn pull-right"></button>');
    showCodeButton.append(showCodeText);
    showCodeButton
        .attr('data-toggle', 'collapse')
        .attr('data-target', '#' + id)
        .attr('aria-expanded', show)
        .attr('aria-controls', id);

    var buttonRow = $('<div class="row"></div>');
    var buttonCol = $('<div class="col-md-12"></div>');

    buttonCol.append(showCodeButton);
    buttonRow.append(buttonCol);

    div.before(buttonRow);

    // hack: return show to false, otherwise all next codeBlocks will be shown!
    show = false;

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide');
    });
  });

}
</script>
<script>
/* ========================================================================
 * Bootstrap: dropdown.js v3.3.7
 * http://getbootstrap.com/javascript/#dropdowns
 * ========================================================================
 * Copyright 2011-2016 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // DROPDOWN CLASS DEFINITION
  // =========================

  var backdrop = '.dropdown-backdrop'
  var toggle   = '[data-toggle="dropdown"]'
  var Dropdown = function (element) {
    $(element).on('click.bs.dropdown', this.toggle)
  }

  Dropdown.VERSION = '3.3.7'

  function getParent($this) {
    var selector = $this.attr('data-target')

    if (!selector) {
      selector = $this.attr('href')
      selector = selector && /#[A-Za-z]/.test(selector) && selector.replace(/.*(?=#[^\s]*$)/, '') // strip for ie7
    }

    var $parent = selector && $(selector)

    return $parent && $parent.length ? $parent : $this.parent()
  }

  function clearMenus(e) {
    if (e && e.which === 3) return
    $(backdrop).remove()
    $(toggle).each(function () {
      var $this         = $(this)
      var $parent       = getParent($this)
      var relatedTarget = { relatedTarget: this }

      if (!$parent.hasClass('open')) return

      if (e && e.type == 'click' && /input|textarea/i.test(e.target.tagName) && $.contains($parent[0], e.target)) return

      $parent.trigger(e = $.Event('hide.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this.attr('aria-expanded', 'false')
      $parent.removeClass('open').trigger($.Event('hidden.bs.dropdown', relatedTarget))
    })
  }

  Dropdown.prototype.toggle = function (e) {
    var $this = $(this)

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    clearMenus()

    if (!isActive) {
      if ('ontouchstart' in document.documentElement && !$parent.closest('.navbar-nav').length) {
        // if mobile we use a backdrop because click events don't delegate
        $(document.createElement('div'))
          .addClass('dropdown-backdrop')
          .insertAfter($(this))
          .on('click', clearMenus)
      }

      var relatedTarget = { relatedTarget: this }
      $parent.trigger(e = $.Event('show.bs.dropdown', relatedTarget))

      if (e.isDefaultPrevented()) return

      $this
        .trigger('focus')
        .attr('aria-expanded', 'true')

      $parent
        .toggleClass('open')
        .trigger($.Event('shown.bs.dropdown', relatedTarget))
    }

    return false
  }

  Dropdown.prototype.keydown = function (e) {
    if (!/(38|40|27|32)/.test(e.which) || /input|textarea/i.test(e.target.tagName)) return

    var $this = $(this)

    e.preventDefault()
    e.stopPropagation()

    if ($this.is('.disabled, :disabled')) return

    var $parent  = getParent($this)
    var isActive = $parent.hasClass('open')

    if (!isActive && e.which != 27 || isActive && e.which == 27) {
      if (e.which == 27) $parent.find(toggle).trigger('focus')
      return $this.trigger('click')
    }

    var desc = ' li:not(.disabled):visible a'
    var $items = $parent.find('.dropdown-menu' + desc)

    if (!$items.length) return

    var index = $items.index(e.target)

    if (e.which == 38 && index > 0)                 index--         // up
    if (e.which == 40 && index < $items.length - 1) index++         // down
    if (!~index)                                    index = 0

    $items.eq(index).trigger('focus')
  }


  // DROPDOWN PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this = $(this)
      var data  = $this.data('bs.dropdown')

      if (!data) $this.data('bs.dropdown', (data = new Dropdown(this)))
      if (typeof option == 'string') data[option].call($this)
    })
  }

  var old = $.fn.dropdown

  $.fn.dropdown             = Plugin
  $.fn.dropdown.Constructor = Dropdown


  // DROPDOWN NO CONFLICT
  // ====================

  $.fn.dropdown.noConflict = function () {
    $.fn.dropdown = old
    return this
  }


  // APPLY TO STANDARD DROPDOWN ELEMENTS
  // ===================================

  $(document)
    .on('click.bs.dropdown.data-api', clearMenus)
    .on('click.bs.dropdown.data-api', '.dropdown form', function (e) { e.stopPropagation() })
    .on('click.bs.dropdown.data-api', toggle, Dropdown.prototype.toggle)
    .on('keydown.bs.dropdown.data-api', toggle, Dropdown.prototype.keydown)
    .on('keydown.bs.dropdown.data-api', '.dropdown-menu', Dropdown.prototype.keydown)

}(jQuery);
</script>
<style type="text/css">
.code-folding-btn {
  margin-bottom: 4px;
}

.row { display: flex; }
.collapse { display: none; }
.in { display:block }
.pull-right > .dropdown-menu {
    right: 0;
    left: auto;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    font-size: 14px;
    text-align: left;
    list-style: none;
    background-color: #fff;
    -webkit-background-clip: padding-box;
    background-clip: padding-box;
    border: 1px solid #ccc;
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0,0,0,.175);
    box-shadow: 0 6px 12px rgba(0,0,0,.175);
}

.open > .dropdown-menu {
    display: block;
    color: #ffffff;
    background-color: #ffffff;
    background-image: none;
    border-color: #92897e;
}

.dropdown-menu > li > a {
  display: block;
  padding: 3px 20px;
  clear: both;
  font-weight: 400;
  line-height: 1.42857143;
  color: #000000;
  white-space: nowrap;
}

.dropdown-menu > li > a:hover,
.dropdown-menu > li > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
}

.dropdown-menu > .active > a,
.dropdown-menu > .active > a:hover,
.dropdown-menu > .active > a:focus {
  color: #ffffff;
  text-decoration: none;
  background-color: #e95420;
  outline: 0;
}
.dropdown-menu > .disabled > a,
.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  color: #aea79f;
}

.dropdown-menu > .disabled > a:hover,
.dropdown-menu > .disabled > a:focus {
  text-decoration: none;
  cursor: not-allowed;
  background-color: transparent;
  background-image: none;
  filter: progid:DXImageTransform.Microsoft.gradient(enabled = false);
}

.btn {
  display: inline-block;
  margin-bottom: 1;
  font-weight: normal;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  -ms-touch-action: manipulation;
      touch-action: manipulation;
  cursor: pointer;
  background-image: none;
  border: 1px solid transparent;
  padding: 4px 8px;
  font-size: 14px;
  line-height: 1.42857143;
  border-radius: 4px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.btn:focus,
.btn:active:focus,
.btn.active:focus,
.btn.focus,
.btn:active.focus,
.btn.active.focus {
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px;
}
.btn:hover,
.btn:focus,
.btn.focus {
  color: #ffffff;
  text-decoration: none;
}
.btn:active,
.btn.active {
  background-image: none;
  outline: 0;
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn.disabled,
.btn[disabled],
fieldset[disabled] .btn {
  cursor: not-allowed;
  filter: alpha(opacity=65);
  opacity: 0.65;
  box-shadow: none;
}
a.btn.disabled,
fieldset[disabled] a.btn {
  pointer-events: none;
}
.btn-default {
  color: #ffffff;
  background-color: #aea79f; #important
  border-color: #aea79f;
}

.btn-default:focus,
.btn-default.focus {
  color: #ffffff;
  background-color: #978e83;
  border-color: #6f675e;
}

.btn-default:hover {
  color: #ffffff;
  background-color: #978e83;
  border-color: #92897e;
}
.btn-default:active,
.btn-default.active,
.btn-group > .btn:not(:first-child):not(:last-child):not(.dropdown-toggle) {
  border-radius: 0;
}
.btn-group > .btn:first-child {
  margin-left: 0;
}
.btn-group > .btn:first-child:not(:last-child):not(.dropdown-toggle) {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn:last-child:not(:first-child),
.btn-group > .dropdown-toggle:not(:first-child) {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group > .btn-group {
  float: left;
}
.btn-group > .btn-group:not(:first-child):not(:last-child) > .btn {
  border-radius: 0;
}
.btn-group > .btn-group:first-child:not(:last-child) > .btn:last-child,
.btn-group > .btn-group:first-child:not(:last-child) > .dropdown-toggle {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn-group:last-child:not(:first-child) > .btn:first-child {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.btn-group .dropdown-toggle:active,
.btn-group.open .dropdown-toggle {
  outline: 0;
}
.btn-group > .btn + .dropdown-toggle {
  padding-right: 8px;
  padding-left: 8px;
}
.btn-group > .btn-lg + .dropdown-toggle {
  padding-right: 12px;
  padding-left: 12px;
}
.btn-group.open .dropdown-toggle {
  box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}
.btn-group.open .dropdown-toggle.btn-link {
  box-shadow: none;
}

</style>
<script>
var str = '<div class="btn-group pull-right" style="position: fixed; right: 50px; top: 10px; z-index: 200"><button type="button" class="btn btn-default btn-xs dropdown-toggle" id="allCodeButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" data-_extension-text-contrast=""><span>Code</span> <span class="caret"></span></button><ul class="dropdown-menu" style="min-width: 50px;"><li><a id="rmd-show-all-code" href="#">Show All Code</a></li><li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li></ul></div>';
document.write(str);
</script>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "hide");
});
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatial Data Science</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="part"><span><b>I Spatial Data</b></span></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Getting Started</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#a-first-map"><i class="fa fa-check"></i><b>1.1</b> A first map</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#coordinate-reference-systems"><i class="fa fa-check"></i><b>1.2</b> Coordinate reference systems</a></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#rasterize"><i class="fa fa-check"></i><b>1.3</b> Raster and vector data</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#raster-types"><i class="fa fa-check"></i><b>1.4</b> Raster types</a></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#time-series-arrays-data-cubes"><i class="fa fa-check"></i><b>1.5</b> Time series, arrays, data cubes</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#support"><i class="fa fa-check"></i><b>1.6</b> Support</a></li>
<li class="chapter" data-level="1.7" data-path="intro.html"><a href="intro.html#spatial-data-science-software"><i class="fa fa-check"></i><b>1.7</b> Spatial data science software</a></li>
<li class="chapter" data-level="1.8" data-path="intro.html"><a href="intro.html#exercises"><i class="fa fa-check"></i><b>1.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cs.html"><a href="cs.html"><i class="fa fa-check"></i><b>2</b> Coordinates</a><ul>
<li class="chapter" data-level="2.1" data-path="cs.html"><a href="cs.html#units"><i class="fa fa-check"></i><b>2.1</b> Quantities, units, datum</a></li>
<li class="chapter" data-level="2.2" data-path="cs.html"><a href="cs.html#ellipsoidal-coordinates"><i class="fa fa-check"></i><b>2.2</b> Ellipsoidal coordinates</a></li>
<li class="chapter" data-level="2.3" data-path="cs.html"><a href="cs.html#crs"><i class="fa fa-check"></i><b>2.3</b> Coordinate Reference Systems</a></li>
<li class="chapter" data-level="2.4" data-path="cs.html"><a href="cs.html#projlib"><i class="fa fa-check"></i><b>2.4</b> PROJ and mapping accuracy</a></li>
<li class="chapter" data-level="2.5" data-path="cs.html"><a href="cs.html#wkt2"><i class="fa fa-check"></i><b>2.5</b> WKT-2</a></li>
<li class="chapter" data-level="2.6" data-path="cs.html"><a href="cs.html#exercises-1"><i class="fa fa-check"></i><b>2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="geometries.html"><a href="geometries.html"><i class="fa fa-check"></i><b>3</b> Geometries</a><ul>
<li class="chapter" data-level="3.1" data-path="geometries.html"><a href="geometries.html#simplefeatures"><i class="fa fa-check"></i><b>3.1</b> Simple feature geometries</a></li>
<li class="chapter" data-level="3.2" data-path="geometries.html"><a href="geometries.html#opgeom"><i class="fa fa-check"></i><b>3.2</b> Operations on geometries</a></li>
<li class="chapter" data-level="3.3" data-path="geometries.html"><a href="geometries.html#precision"><i class="fa fa-check"></i><b>3.3</b> Precision</a></li>
<li class="chapter" data-level="3.4" data-path="geometries.html"><a href="geometries.html#coverages"><i class="fa fa-check"></i><b>3.4</b> Coverages: tessellations and rasters</a></li>
<li class="chapter" data-level="3.5" data-path="geometries.html"><a href="geometries.html#networks"><i class="fa fa-check"></i><b>3.5</b> Networks</a></li>
<li class="chapter" data-level="3.6" data-path="geometries.html"><a href="geometries.html#exercises-2"><i class="fa fa-check"></i><b>3.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spherical.html"><a href="spherical.html"><i class="fa fa-check"></i><b>4</b> Spherical Geometries</a><ul>
<li class="chapter" data-level="4.1" data-path="spherical.html"><a href="spherical.html#straight-lines"><i class="fa fa-check"></i><b>4.1</b> Straight lines</a></li>
<li class="chapter" data-level="4.2" data-path="spherical.html"><a href="spherical.html#ring-direction"><i class="fa fa-check"></i><b>4.2</b> Ring direction</a></li>
<li class="chapter" data-level="4.3" data-path="spherical.html"><a href="spherical.html#full-polygon"><i class="fa fa-check"></i><b>4.3</b> Full polygon</a></li>
<li class="chapter" data-level="4.4" data-path="spherical.html"><a href="spherical.html#bounding-box-rectangle-and-cap"><i class="fa fa-check"></i><b>4.4</b> Bounding box, rectangle, and cap</a></li>
<li class="chapter" data-level="4.5" data-path="spherical.html"><a href="spherical.html#validity-on-the-sphere"><i class="fa fa-check"></i><b>4.5</b> Validity on the sphere</a></li>
<li class="chapter" data-level="4.6" data-path="spherical.html"><a href="spherical.html#exercises-3"><i class="fa fa-check"></i><b>4.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="featureattributes.html"><a href="featureattributes.html"><i class="fa fa-check"></i><b>5</b> Attributes and Support</a><ul>
<li class="chapter" data-level="5.1" data-path="featureattributes.html"><a href="featureattributes.html#agr"><i class="fa fa-check"></i><b>5.1</b> Attribute-geometry relationships and support</a></li>
<li class="chapter" data-level="5.2" data-path="featureattributes.html"><a href="featureattributes.html#aggregating-and-summarising"><i class="fa fa-check"></i><b>5.2</b> Aggregating and summarising</a></li>
<li class="chapter" data-level="5.3" data-path="featureattributes.html"><a href="featureattributes.html#area-weighted"><i class="fa fa-check"></i><b>5.3</b> Area-weighted interpolation</a></li>
<li class="chapter" data-level="5.4" data-path="featureattributes.html"><a href="featureattributes.html#updownscaling"><i class="fa fa-check"></i><b>5.4</b> Up- and Downscaling</a></li>
<li class="chapter" data-level="5.5" data-path="featureattributes.html"><a href="featureattributes.html#exercises-4"><i class="fa fa-check"></i><b>5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="datacube.html"><a href="datacube.html"><i class="fa fa-check"></i><b>6</b> Data Cubes</a><ul>
<li class="chapter" data-level="6.1" data-path="datacube.html"><a href="datacube.html#a-four-dimensional-data-cube"><i class="fa fa-check"></i><b>6.1</b> A four-dimensional data cube</a></li>
<li class="chapter" data-level="6.2" data-path="datacube.html"><a href="datacube.html#dimensions-attributes-and-support"><i class="fa fa-check"></i><b>6.2</b> Dimensions, attributes, and support</a></li>
<li class="chapter" data-level="6.3" data-path="datacube.html"><a href="datacube.html#dcoperations"><i class="fa fa-check"></i><b>6.3</b> Operations on data cubes</a></li>
<li class="chapter" data-level="6.4" data-path="datacube.html"><a href="datacube.html#vectordatacubes"><i class="fa fa-check"></i><b>6.4</b> Aggregating raster to vector cubes</a></li>
<li class="chapter" data-level="6.5" data-path="datacube.html"><a href="datacube.html#switching"><i class="fa fa-check"></i><b>6.5</b> Switching dimension with attributes</a></li>
<li class="chapter" data-level="6.6" data-path="datacube.html"><a href="datacube.html#otherdynamic"><i class="fa fa-check"></i><b>6.6</b> Other dynamic spatial data</a></li>
<li class="chapter" data-level="6.7" data-path="datacube.html"><a href="datacube.html#exercises-5"><i class="fa fa-check"></i><b>6.7</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>II R for Spatial Data Science</b></span></li>
<li class="chapter" data-level="7" data-path="sf.html"><a href="sf.html"><i class="fa fa-check"></i><b>7</b> Introduction to sf and stars</a><ul>
<li class="chapter" data-level="7.1" data-path="sf.html"><a href="sf.html#sfintro"><i class="fa fa-check"></i><b>7.1</b> Package <code>sf</code></a></li>
<li class="chapter" data-level="7.2" data-path="sf.html"><a href="sf.html#spatial-joins"><i class="fa fa-check"></i><b>7.2</b> Spatial joins</a></li>
<li class="chapter" data-level="7.3" data-path="sf.html"><a href="sf.html#package-stars"><i class="fa fa-check"></i><b>7.3</b> Package <code>stars</code></a></li>
<li class="chapter" data-level="7.4" data-path="sf.html"><a href="sf.html#vector-data-cube-examples"><i class="fa fa-check"></i><b>7.4</b> Vector data cube examples</a></li>
<li class="chapter" data-level="7.5" data-path="sf.html"><a href="sf.html#raster-to-vector"><i class="fa fa-check"></i><b>7.5</b> raster-to-vector, vector-to-raster</a></li>
<li class="chapter" data-level="7.6" data-path="sf.html"><a href="sf.html#projsf"><i class="fa fa-check"></i><b>7.6</b> Coordinate transformations and conversions</a></li>
<li class="chapter" data-level="7.7" data-path="sf.html"><a href="sf.html#warp"><i class="fa fa-check"></i><b>7.7</b> Transforming and warping rasters</a></li>
<li class="chapter" data-level="7.8" data-path="sf.html"><a href="sf.html#exercises-6"><i class="fa fa-check"></i><b>7.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="large.html"><a href="large.html"><i class="fa fa-check"></i><b>8</b> Large data sets</a><ul>
<li class="chapter" data-level="8.1" data-path="large.html"><a href="large.html#largesf"><i class="fa fa-check"></i><b>8.1</b> Vector data: <code>sf</code></a></li>
<li class="chapter" data-level="8.2" data-path="large.html"><a href="large.html#raster-data-stars"><i class="fa fa-check"></i><b>8.2</b> Raster data: <code>stars</code></a></li>
<li class="chapter" data-level="8.3" data-path="large.html"><a href="large.html#very-large-data-cubes"><i class="fa fa-check"></i><b>8.3</b> Very large data cubes</a></li>
<li class="chapter" data-level="8.4" data-path="large.html"><a href="large.html#exercises-7"><i class="fa fa-check"></i><b>8.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="plotting.html"><a href="plotting.html"><i class="fa fa-check"></i><b>9</b> Plotting spatial data</a><ul>
<li class="chapter" data-level="9.1" data-path="plotting.html"><a href="plotting.html#transform"><i class="fa fa-check"></i><b>9.1</b> Every plot is a projection</a></li>
<li class="chapter" data-level="9.2" data-path="plotting.html"><a href="plotting.html#plotting-points-lines-polygons-grid-cells"><i class="fa fa-check"></i><b>9.2</b> Plotting points, lines, polygons, grid cells</a></li>
<li class="chapter" data-level="9.3" data-path="plotting.html"><a href="plotting.html#base-plot"><i class="fa fa-check"></i><b>9.3</b> Base <code>plot</code></a></li>
<li class="chapter" data-level="9.4" data-path="plotting.html"><a href="plotting.html#geomsf"><i class="fa fa-check"></i><b>9.4</b> Maps with <code>ggplot2</code></a></li>
<li class="chapter" data-level="9.5" data-path="plotting.html"><a href="plotting.html#tmap"><i class="fa fa-check"></i><b>9.5</b> Maps with <code>tmap</code></a></li>
<li class="chapter" data-level="9.6" data-path="plotting.html"><a href="plotting.html#interactive-maps-leaflet-mapview-tmap"><i class="fa fa-check"></i><b>9.6</b> Interactive maps: <code>leaflet</code>, <code>mapview</code>, <code>tmap</code></a></li>
<li class="chapter" data-level="9.7" data-path="plotting.html"><a href="plotting.html#exercises-8"><i class="fa fa-check"></i><b>9.7</b> Exercises</a></li>
</ul></li>
<li class="part"><span><b>III Models for Spatial Data</b></span></li>
<li class="chapter" data-level="10" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html"><i class="fa fa-check"></i><b>10</b> Statistical modelling of spatial data</a><ul>
<li class="chapter" data-level="10.1" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#design"><i class="fa fa-check"></i><b>10.1</b> Design-based and model-based inference</a></li>
<li class="chapter" data-level="10.2" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#predictive-models-with-coordinates"><i class="fa fa-check"></i><b>10.2</b> Predictive models with coordinates</a></li>
<li class="chapter" data-level="10.3" data-path="statistical-modelling-of-spatial-data.html"><a href="statistical-modelling-of-spatial-data.html#further-reading"><i class="fa fa-check"></i><b>10.3</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="pointpatterns.html"><a href="pointpatterns.html"><i class="fa fa-check"></i><b>11</b> Point Pattern Analysis</a><ul>
<li class="chapter" data-level="11.1" data-path="pointpatterns.html"><a href="pointpatterns.html#observation-window"><i class="fa fa-check"></i><b>11.1</b> Observation window</a></li>
<li class="chapter" data-level="11.2" data-path="pointpatterns.html"><a href="pointpatterns.html#coordinate-reference-systems-1"><i class="fa fa-check"></i><b>11.2</b> Coordinate reference systems</a></li>
<li class="chapter" data-level="11.3" data-path="pointpatterns.html"><a href="pointpatterns.html#marked-point-patterns-points-on-linear-networks"><i class="fa fa-check"></i><b>11.3</b> Marked point patterns, points on linear networks</a></li>
<li class="chapter" data-level="11.4" data-path="pointpatterns.html"><a href="pointpatterns.html#spatial-sampling-and-simulating-a-point-process"><i class="fa fa-check"></i><b>11.4</b> Spatial sampling and simulating a point process</a></li>
<li class="chapter" data-level="11.5" data-path="pointpatterns.html"><a href="pointpatterns.html#simulating-points-on-the-globe"><i class="fa fa-check"></i><b>11.5</b> Simulating points on the globe</a></li>
<li class="chapter" data-level="11.6" data-path="pointpatterns.html"><a href="pointpatterns.html#exercises-9"><i class="fa fa-check"></i><b>11.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="interpolation.html"><a href="interpolation.html"><i class="fa fa-check"></i><b>12</b> Spatial Interpolation</a><ul>
<li class="chapter" data-level="12.1" data-path="interpolation.html"><a href="interpolation.html#a-first-dataset"><i class="fa fa-check"></i><b>12.1</b> A first dataset</a></li>
<li class="chapter" data-level="12.2" data-path="interpolation.html"><a href="interpolation.html#sample-variogram"><i class="fa fa-check"></i><b>12.2</b> Sample variogram</a></li>
<li class="chapter" data-level="12.3" data-path="interpolation.html"><a href="interpolation.html#fitting-variogram-models"><i class="fa fa-check"></i><b>12.3</b> Fitting variogram models</a></li>
<li class="chapter" data-level="12.4" data-path="interpolation.html"><a href="interpolation.html#kriging"><i class="fa fa-check"></i><b>12.4</b> Kriging interpolation</a></li>
<li class="chapter" data-level="12.5" data-path="interpolation.html"><a href="interpolation.html#blockkriging"><i class="fa fa-check"></i><b>12.5</b> Areal means: block kriging</a></li>
<li class="chapter" data-level="12.6" data-path="interpolation.html"><a href="interpolation.html#conditional-simulation"><i class="fa fa-check"></i><b>12.6</b> Conditional simulation</a></li>
<li class="chapter" data-level="12.7" data-path="interpolation.html"><a href="interpolation.html#trend-models"><i class="fa fa-check"></i><b>12.7</b> Trend models</a></li>
<li class="chapter" data-level="12.8" data-path="interpolation.html"><a href="interpolation.html#exercises-10"><i class="fa fa-check"></i><b>12.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="stgeostatistics.html"><a href="stgeostatistics.html"><i class="fa fa-check"></i><b>13</b> Multivariate and Spatiotemporal Geostatistics</a><ul>
<li class="chapter" data-level="13.1" data-path="stgeostatistics.html"><a href="stgeostatistics.html#preparing"><i class="fa fa-check"></i><b>13.1</b> Preparing the air quality dataset</a></li>
<li class="chapter" data-level="13.2" data-path="stgeostatistics.html"><a href="stgeostatistics.html#cokriging"><i class="fa fa-check"></i><b>13.2</b> Multivariable geostatistics</a></li>
<li class="chapter" data-level="13.3" data-path="stgeostatistics.html"><a href="stgeostatistics.html#spatiotemporal-geostatistics"><i class="fa fa-check"></i><b>13.3</b> Spatiotemporal geostatistics</a></li>
<li class="chapter" data-level="13.4" data-path="stgeostatistics.html"><a href="stgeostatistics.html#exercises-11"><i class="fa fa-check"></i><b>13.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="area.html"><a href="area.html"><i class="fa fa-check"></i><b>14</b> Proximity and Areal Data</a><ul>
<li class="chapter" data-level="14.1" data-path="area.html"><a href="area.html#representing-proximity-in-spdep"><i class="fa fa-check"></i><b>14.1</b> Representing proximity in <strong>spdep</strong></a></li>
<li class="chapter" data-level="14.2" data-path="area.html"><a href="area.html#contiguous-neighbours"><i class="fa fa-check"></i><b>14.2</b> Contiguous neighbours</a></li>
<li class="chapter" data-level="14.3" data-path="area.html"><a href="area.html#graph-based-neighbours"><i class="fa fa-check"></i><b>14.3</b> Graph-based neighbours</a></li>
<li class="chapter" data-level="14.4" data-path="area.html"><a href="area.html#distance-based-neighbours"><i class="fa fa-check"></i><b>14.4</b> Distance-based neighbours</a></li>
<li class="chapter" data-level="14.5" data-path="area.html"><a href="area.html#weights-specification"><i class="fa fa-check"></i><b>14.5</b> Weights specification</a></li>
<li class="chapter" data-level="14.6" data-path="area.html"><a href="area.html#higher-order-neighbours"><i class="fa fa-check"></i><b>14.6</b> Higher order neighbours</a></li>
<li class="chapter" data-level="14.7" data-path="area.html"><a href="area.html#exercises-12"><i class="fa fa-check"></i><b>14.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="spatautocorr.html"><a href="spatautocorr.html"><i class="fa fa-check"></i><b>15</b> Measures of spatial autocorrelation</a><ul>
<li class="chapter" data-level="15.1" data-path="spatautocorr.html"><a href="spatautocorr.html#measures-and-process-mis-specification"><i class="fa fa-check"></i><b>15.1</b> Measures and process mis-specification</a></li>
<li class="chapter" data-level="15.2" data-path="spatautocorr.html"><a href="spatautocorr.html#global-measures"><i class="fa fa-check"></i><b>15.2</b> Global measures</a></li>
<li class="chapter" data-level="15.3" data-path="spatautocorr.html"><a href="spatautocorr.html#local-measures"><i class="fa fa-check"></i><b>15.3</b> Local measures</a></li>
<li class="chapter" data-level="15.4" data-path="spatautocorr.html"><a href="spatautocorr.html#exercises-13"><i class="fa fa-check"></i><b>15.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="spatglmm.html"><a href="spatglmm.html"><i class="fa fa-check"></i><b>16</b> Spatial Regression</a><ul>
<li class="chapter" data-level="16.1" data-path="spatglmm.html"><a href="spatglmm.html#markov-random-field-and-multilevel-models-with-spatial-weights"><i class="fa fa-check"></i><b>16.1</b> Markov random field and multilevel models with spatial weights</a></li>
<li class="chapter" data-level="16.2" data-path="spatglmm.html"><a href="spatglmm.html#multilevel-models-of-the-boston-data-set"><i class="fa fa-check"></i><b>16.2</b> Multilevel models of the Boston data set</a></li>
<li class="chapter" data-level="16.3" data-path="spatglmm.html"><a href="spatglmm.html#exercises-14"><i class="fa fa-check"></i><b>16.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="spatecon.html"><a href="spatecon.html"><i class="fa fa-check"></i><b>17</b> Spatial econometrics models</a><ul>
<li class="chapter" data-level="17.1" data-path="spatecon.html"><a href="spatecon.html#spatial-econometric-models-definitions"><i class="fa fa-check"></i><b>17.1</b> Spatial econometric models: definitions</a></li>
<li class="chapter" data-level="17.2" data-path="spatecon.html"><a href="spatecon.html#maximum-likelihood-estimation-in-spatialreg"><i class="fa fa-check"></i><b>17.2</b> Maximum likelihood estimation in <strong>spatialreg</strong></a></li>
<li class="chapter" data-level="17.3" data-path="spatecon.html"><a href="spatecon.html#impacts"><i class="fa fa-check"></i><b>17.3</b> Impacts</a></li>
<li class="chapter" data-level="17.4" data-path="spatecon.html"><a href="spatecon.html#spateconpred"><i class="fa fa-check"></i><b>17.4</b> Predictions</a></li>
<li class="chapter" data-level="17.5" data-path="spatecon.html"><a href="spatecon.html#exercises-15"><i class="fa fa-check"></i><b>17.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="older.html"><a href="older.html"><i class="fa fa-check"></i><b>18</b> Older R Spatial Packages</a><ul>
<li class="chapter" data-level="18.1" data-path="older.html"><a href="older.html#retire"><i class="fa fa-check"></i><b>18.1</b> Retiring <code>rgdal</code> and <code>rgeos</code></a></li>
<li class="chapter" data-level="18.2" data-path="older.html"><a href="older.html#links-and-differences-between-sf-and-sp"><i class="fa fa-check"></i><b>18.2</b> Links and differences between sf and sp</a></li>
<li class="chapter" data-level="18.3" data-path="older.html"><a href="older.html#migration-code-and-packages"><i class="fa fa-check"></i><b>18.3</b> Migration code and packages</a></li>
<li class="chapter" data-level="18.4" data-path="older.html"><a href="older.html#package-raster-and-terra"><i class="fa fa-check"></i><b>18.4</b> Package raster and terra</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="all-r-code-in-this-book.html"><a href="all-r-code-in-this-book.html"><i class="fa fa-check"></i>All R code in this book</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html"><i class="fa fa-check"></i>R basics</a><ul>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#pipes"><i class="fa fa-check"></i>Pipes</a></li>
<li class="chapter" data-level="" data-path="r-basics.html"><a href="r-basics.html#data-structures"><i class="fa fa-check"></i>Data structures</a></li>
<li><a href="r-basics.html#dissecting-a-multipolygon">dissecting a <code>MULTIPOLYGON</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Data Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="spatautocorr" class="section level1">
<h1><span class="header-section-number">Chapter 15</span> Measures of spatial autocorrelation</h1>
<p>When analysing areal data, it has long been recognised that, if present, spatial autocorrelation changes how we may infer, relative to the default position of independent observations. In the presence of spatial autocorrelation, we can predict the values of observation <span class="math inline">\(i\)</span> from the values observed at <span class="math inline">\(j \in N_i\)</span>, the set of its proximate neighbours. Early results <span class="citation">(Moran <a href="#ref-moran48">1948</a>; Geary <a href="#ref-geary:54">1954</a>)</span>, entered into research practice gradually, for example the social sciences <span class="citation">(Duncan, Cuzzort, and Duncan <a href="#ref-duncanetal61">1961</a>)</span>. These results were then collated and extended to yield a set of basic tools of analysis <span class="citation">(Cliff and Ord <a href="#ref-cliff+ord:73">1973</a>, <a href="#ref-cliff+ord:81">1981</a>)</span>.</p>
<p>Cliff and Ord <span class="citation">(<a href="#ref-cliff+ord:73">1973</a>)</span> generalised and extended the expression of the spatial weights matrix representation as part of the framework for establishing the distribution theory for join count, Moran’s <span class="math inline">\(I\)</span> and Geary’s <span class="math inline">\(C\)</span> statistics. This development of what have become known as global measures, returning a single value of autocorrelation for the total study area, has been supplemented by local measures returning values for each areal unit <span class="citation">(Getis and Ord <a href="#ref-getis+ord:92">1992</a>; Anselin <a href="#ref-anselin:95">1995</a>)</span>.</p>
<div id="measures-and-process-mis-specification" class="section level2">
<h2><span class="header-section-number">15.1</span> Measures and process mis-specification</h2>
<p>It is not and has never been the case that Tobler’s first law of geography: “Everything is related to everything else, but near things are more related than distant things” always holds absolutely. This is and has always been an oversimplification, disguising the underlying entitation, support and other mis-specification problems. Are the units of observation appropriate for the scale of the underlying spatial process? Could the spatial patterning of the variable of interest for the chosen entitation be accounted for by another variable?</p>
<p><span class="citation">Tobler (<a href="#ref-10.2307/143141">1970</a>)</span> was published in the same special issue of <em>Economic Geography</em> as <span class="citation">Olsson (<a href="#ref-10.2307/143140">1970</a>)</span>, but Olsson does grasp the important point that spatial autocorrelation is not inherent in spatial phenomena, but often is engendered by inappropriate entitation, by omitted variables and/or inappropriate functional form. The key quote from Olsson is on p. 228:</p>
<blockquote>
<p>The existence of such autocorrelations makes it tempting to agree with Tobler (1970, 236 [the original refers to the pagination of a conference paper]) that ‘everything is related to everything else, but near things are more related than distant things.’ On the other hand, the fact that the autocorrelations seem to hide systematic specification errors suggests that the elevation of this statement to the status of ‘the first law of geography’ is at best premature. At worst, the statement may represent the spatial variant of the post hoc fallacy, which would mean that coincidence has been mistaken for a causal relation.</p>
</blockquote>
<p>The status of the “first law” is very similar to the belief that John Snow induced the cause of cholera as water-borne from a map. It may be a good way of selling GIS, but it is inaccurate; Snow had a strong working hypothesis prior to visiting Soho, and the map was prepared after the Broad street pump was disabled as documentation that the hypothesis held <span class="citation">(Brody et al. <a href="#ref-BRODY200064">2000</a>)</span>.</p>
<p>Measures of spatial autocorrelation unfortunately pick up other mis-specifications in the way that we model data <span class="citation">(Schabenberger and Gotway <a href="#ref-schabenberger+gotway:2005">2005</a>; McMillen <a href="#ref-McMillen:2003">2003</a>)</span>. For reference, Moran’s <span class="math inline">\(I\)</span> is given as <span class="citation">(Cliff and Ord <a href="#ref-cliff+ord:81">1981</a>, 17)</span>:</p>
<p><span class="math display">\[
I = \frac{n \sum_{(2)} w_{ij} z_i z_j}{S_0 \sum_{i=1}^{n} z_i^2}
\]</span>
where <span class="math inline">\(x_i, i=1, \ldots, n\)</span> are <span class="math inline">\(n\)</span> observations on the numeric variable of interest, <span class="math inline">\(z_i = x_i - \bar{x}\)</span>, <span class="math inline">\(\bar{x} = \sum_{i=1}^{n} x_i / n\)</span>, <span class="math inline">\(\sum_{(2)} = \stackrel{\sum_{i=1}^{n} \sum_{j=1}^{n}}{i \neq j}\)</span>, <span class="math inline">\(w_{ij}\)</span> are the spatial weights, and <span class="math inline">\(S_0 = \sum_{(2)} w_{ij}\)</span>.
First we test a random variable using the Moran test, here under the normality assumption (argument <code>randomisation=FALSE</code>, default <code>TRUE</code>). Inference is made on the statistic <span class="math inline">\(Z(I) = \frac{I - E(I)}{\sqrt{\mathrm{Var}(I)}}\)</span>, the z-value compared with the Normal distribution for <span class="math inline">\(E(I)\)</span> and <span class="math inline">\(\mathrm{Var}(I)\)</span> for the chosen assumptions; this <code>x</code> does not show spatial autocorrelation with these spatial weights:</p>
<div class="sourceCode" id="cb548"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb548-1" title="1">glance_htest &lt;-<span class="st"> </span><span class="cf">function</span>(ht) <span class="kw">c</span>(ht<span class="op">$</span>estimate, </a>
<a class="sourceLine" id="cb548-2" title="2">    <span class="st">&quot;Std deviate&quot;</span> =<span class="st"> </span><span class="kw">unname</span>(ht<span class="op">$</span>statistic), </a>
<a class="sourceLine" id="cb548-3" title="3">    <span class="st">&quot;p.value&quot;</span> =<span class="st"> </span><span class="kw">unname</span>(ht<span class="op">$</span>p.value))</a>
<a class="sourceLine" id="cb548-4" title="4"><span class="kw">set.seed</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb548-5" title="5">(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb548-6" title="6"><span class="st">        </span><span class="kw">nrow</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb548-7" title="7"><span class="st">        </span><span class="kw">rnorm</span>() -&gt;<span class="st"> </span>x) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb548-8" title="8"><span class="st">    </span><span class="kw">moran.test</span>(lw_q_B, <span class="dt">randomisation =</span> <span class="ot">FALSE</span>, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb548-9" title="9"><span class="st">    </span><span class="kw">glance_htest</span>()</a></code></pre></div>
<pre><code># Moran I statistic       Expectation          Variance       Std deviate 
#         -0.004772         -0.000401          0.000140         -0.369320 
#           p.value 
#          0.711889</code></pre>
<p>The test however detects quite strong positive spatial autocorrelation when we insert a gentle trend into the data, but omit to include it in the mean model, thus creating a missing variable problem but finding spatial autocorrelation instead:</p>
<div class="sourceCode" id="cb550"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb550-1" title="1">beta &lt;-<span class="st"> </span><span class="fl">0.0015</span></a>
<a class="sourceLine" id="cb550-2" title="2">coords <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb550-3" title="3"><span class="st">    </span><span class="kw">st_coordinates</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb550-4" title="4"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select =</span> <span class="dv">1</span>, <span class="dt">drop =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb550-5" title="5"><span class="st">    </span>(<span class="cf">function</span>(x) x<span class="op">/</span><span class="dv">1000</span>)() -&gt;<span class="st"> </span>t</a>
<a class="sourceLine" id="cb550-6" title="6">(x <span class="op">+</span><span class="st"> </span>beta <span class="op">*</span><span class="st"> </span>t -&gt;<span class="st"> </span>x_t) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb550-7" title="7"><span class="st">    </span><span class="kw">moran.test</span>(lw_q_B, <span class="dt">randomisation =</span> <span class="ot">FALSE</span>, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb550-8" title="8"><span class="st">    </span><span class="kw">glance_htest</span>()</a></code></pre></div>
<pre><code># Moran I statistic       Expectation          Variance       Std deviate 
#          0.043403         -0.000401          0.000140          3.701491 
#           p.value 
#          0.000214</code></pre>
<p>If we test the residuals of a linear model including the trend, the apparent spatial autocorrelation disappears:</p>
<div class="sourceCode" id="cb552"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb552-1" title="1"><span class="kw">lm</span>(x_t <span class="op">~</span><span class="st"> </span>t) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb552-2" title="2"><span class="st">    </span><span class="kw">lm.morantest</span>(lw_q_B, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb552-3" title="3"><span class="st">    </span><span class="kw">glance_htest</span>()</a></code></pre></div>
<pre><code># Observed Moran I      Expectation         Variance      Std deviate 
#        -0.004777        -0.000789         0.000140        -0.337306 
#          p.value 
#         0.735886</code></pre>
<p>A comparison of implementations of measures of spatial autocorrelation shows that a wide range of measures is available in R in a number of packages, chiefly in the <strong>spdep</strong> package <span class="citation">(R. Bivand <a href="#ref-R-spdep">2021</a><a href="#ref-R-spdep">b</a>)</span>, and that differences from other implementations can be attributed to design decisions <span class="citation">(Bivand and Wong <a href="#ref-Bivand2018">2018</a>)</span>. The <strong>spdep</strong> package also includes the only implementations of exact and saddlepoint approximations to global and local Moran’s I for regression residuals <span class="citation">(Tiefelsdorf <a href="#ref-tiefelsdorf:02">2002</a>; Bivand, Müller, and Reder <a href="#ref-bivandetal:09">2009</a>)</span>.</p>
</div>
<div id="global-measures" class="section level2">
<h2><span class="header-section-number">15.2</span> Global measures</h2>
<p>Global measures consider the average level of spatial autocorrelation across all observations; they can of course be biassed (as most spatial statistics) by edge effects where important spatial process components fall outside the study area.</p>
<div id="join-count-tests-for-categorical-data" class="section level3">
<h3><span class="header-section-number">15.2.1</span> Join-count tests for categorical data</h3>
<p>We will begin by examining join count statistics, where <code>joincount.test()</code> takes a <code>"factor"</code> vector of values <code>fx=</code> and a <code>listw</code> object, and returns a list of <code>htest</code> (hypothesis test) objects defined in the <strong>stats</strong> package, one <code>htest</code> object for each level of the <code>fx=</code> argument. The observed counts are of neighbours with the same factor levels, known as same-colour joins.</p>
<div class="sourceCode" id="cb554"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb554-1" title="1"><span class="kw">args</span>(joincount.test)</a></code></pre></div>
<pre><code># function (fx, listw, zero.policy = NULL, alternative = &quot;greater&quot;, 
#     sampling = &quot;nonfree&quot;, spChk = NULL, adjust.n = TRUE) 
# NULL</code></pre>
<p>The function takes an <code>alternative=</code> argument for hypothesis testing, a <code>sampling=</code> argument showing the basis for the construction of the variance of the measure, where the default <code>"nonfree"</code> choice corresponds to analytical permutation; the <code>spChk=</code> argument is retained for backward compatibility. For reference, the counts of factor levels for the type of municipality or Warsaw borough are:</p>
<div class="sourceCode" id="cb556"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb556-1" title="1">(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb556-2" title="2"><span class="st">        </span><span class="kw">st_drop_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb556-3" title="3"><span class="st">        </span><span class="kw">subset</span>(<span class="dt">select =</span> types, <span class="dt">drop =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>Types) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb556-4" title="4"><span class="st">    </span><span class="kw">table</span>()</a></code></pre></div>
<pre><code># .
#          Rural          Urban    Urban/rural Warsaw Borough 
#           1563            303            611             18</code></pre>
<p>Since there are four levels, we re-arrange the list of <code>htest</code> objects to give a matrix of estimated results. The observed same-colour join counts are tabulated with their expectations based on the counts of levels of the input factor, so that few joins would be expected between for example Warsaw boroughs, because there are very few of them. The variance calculation uses the underlying constants of the chosen <code>listw</code> object and the counts of levels of the input factor. The z-value is obtained in the usual way by dividing the difference between the observed and expected join counts by the square root of the variance.</p>
<p>The join count test was subsequently adapted for multi-colour join counts <span class="citation">(Upton and Fingleton <a href="#ref-upton+fingleton:85">1985</a>)</span>. The implementation as <code>joincount.mult()</code> in <strong>spdep</strong> returns a table based on nonfree sampling, and does not report p-values.</p>
<div class="sourceCode" id="cb558"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb558-1" title="1">Types <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">joincount.multi</span>(<span class="dt">listw =</span> lw_q_B)</a></code></pre></div>
<pre><code>#                               Joincount Expected Variance z-value
# Rural:Rural                    3087.000 2793.920 1126.534    8.73
# Urban:Urban                     110.000  104.719   93.299    0.55
# Urban/rural:Urban/rural         656.000  426.526  331.759   12.60
# Warsaw Borough:Warsaw Borough    41.000    0.350    0.347   68.96
# Urban:Rural                     668.000 1083.941  708.209  -15.63
# Urban/rural:Rural              2359.000 2185.769 1267.131    4.87
# Urban/rural:Urban               171.000  423.729  352.190  -13.47
# Warsaw Borough:Rural             12.000   64.393   46.460   -7.69
# Warsaw Borough:Urban              9.000   12.483   11.758   -1.02
# Warsaw Borough:Urban/rural        8.000   25.172   22.354   -3.63
# Jtot                           3227.000 3795.486 1496.398  -14.70</code></pre>
<p>So far, we have used binary weights, so the sum of join counts multiplied by the weight on that join remains integer. If we change to row standardised weights, where the weights are almost always fractions of 1, the counts, expectations and variances change, but there are few major changes in the z-values.</p>
<p>Using an inverse distance based <code>listw</code> object does, however, change the z-values markedly, because closer centroids are upweighted relatively strongly:</p>
<div class="sourceCode" id="cb560"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb560-1" title="1">Types <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">joincount.multi</span>(<span class="dt">listw =</span> lw_d183_idw_B)</a></code></pre></div>
<pre><code>#                               Joincount Expected Variance z-value
# Rural:Rural                    3.46e+02 3.61e+02 4.93e+01   -2.10
# Urban:Urban                    2.90e+01 1.35e+01 2.23e+00   10.39
# Urban/rural:Urban/rural        4.65e+01 5.51e+01 9.61e+00   -2.79
# Warsaw Borough:Warsaw Borough  1.68e+01 4.53e-02 6.61e-03  206.38
# Urban:Rural                    2.02e+02 1.40e+02 2.36e+01   12.73
# Urban/rural:Rural              2.25e+02 2.83e+02 3.59e+01   -9.59
# Urban/rural:Urban              3.65e+01 5.48e+01 8.86e+00   -6.14
# Warsaw Borough:Rural           5.65e+00 8.33e+00 1.73e+00   -2.04
# Warsaw Borough:Urban           9.18e+00 1.61e+00 2.54e-01   15.01
# Warsaw Borough:Urban/rural     3.27e+00 3.25e+00 5.52e-01    0.02
# Jtot                           4.82e+02 4.91e+02 4.16e+01   -1.38</code></pre>
</div>
<div id="morans-i" class="section level3">
<h3><span class="header-section-number">15.2.2</span> Moran’s <span class="math inline">\(I\)</span></h3>
<p>The implementation of Moran’s <span class="math inline">\(I\)</span> in <strong>spdep</strong> in the <code>moran.test()</code> function has similar arguments to those of <code>joincount.test()</code>, but <code>sampling=</code> is replaced by <code>randomisation=</code> to indicate the underlying analytical approach used for calculating the variance of the measure. It is also possible to use ranks rather than numerical values <span class="citation">(Cliff and Ord <a href="#ref-cliff+ord:81">1981</a>, 46)</span>. The <code>drop.EI2=</code> argument may be used to reproduce results where the final component of the variance term is omitted as found in some legacy software implementations.</p>
<div class="sourceCode" id="cb562"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb562-1" title="1"><span class="kw">args</span>(moran.test)</a></code></pre></div>
<pre><code># function (x, listw, randomisation = TRUE, zero.policy = NULL, 
#     alternative = &quot;greater&quot;, rank = FALSE, na.action = na.fail, 
#     spChk = NULL, adjust.n = TRUE, drop.EI2 = FALSE) 
# NULL</code></pre>
<p>The default for the <code>randomisation=</code> argument is <code>TRUE</code>, but here we will simply show that the test under normality is the same as a test of least squares residuals with only the intercept used in the mean model; the analysed variable is first round turnout proportion of registered voters in municipalities and Warsaw burroughs in the 2015 Polish presidential election. The spelling of randomisation is that of Cliff and Ord <span class="citation">(<a href="#ref-cliff+ord:73">1973</a>)</span>.</p>
<div class="sourceCode" id="cb564"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb564-1" title="1">(pol_pres15 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb564-2" title="2"><span class="st">        </span><span class="kw">st_drop_geometry</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb564-3" title="3"><span class="st">        </span><span class="kw">subset</span>(<span class="dt">select =</span> I_turnout, <span class="dt">drop =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>z) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb564-4" title="4"><span class="st">    </span><span class="kw">moran.test</span>(<span class="dt">listw =</span> lw_q_B, <span class="dt">randomisation =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb564-5" title="5"><span class="st">    </span><span class="kw">glance_htest</span>()</a></code></pre></div>
<pre><code># Moran I statistic       Expectation          Variance       Std deviate 
#          0.691434         -0.000401          0.000140         58.461349 
#           p.value 
#          0.000000</code></pre>
<p>The <code>lm.morantest()</code> function also takes a <code>resfun=</code> argument to set the function used to extract the residuals used for testing, and clearly lets us model other salient features of the response variable <span class="citation">(Cliff and Ord <a href="#ref-cliff+ord:81">1981</a>, 203)</span>. To compare with the standard test, we are only using the intercept here and, as can be seen, the results are the same.</p>
<div class="sourceCode" id="cb566"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb566-1" title="1"><span class="kw">lm</span>(I_turnout <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, pol_pres15) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb566-2" title="2"><span class="st">    </span><span class="kw">lm.morantest</span>(<span class="dt">listw =</span> lw_q_B) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb566-3" title="3"><span class="st">    </span><span class="kw">glance_htest</span>()</a></code></pre></div>
<pre><code># Observed Moran I      Expectation         Variance      Std deviate 
#         0.691434        -0.000401         0.000140        58.461349 
#          p.value 
#         0.000000</code></pre>
<p>The only difference between tests under normality and randomisation is that an extra term is added if the kurtosis of the variable of interest indicates a flatter or more peaked distribution, where the measure used is the classical measure of kurtosis. Under the default randomisation assumption of analytical randomisation, the results are largely unchanged.</p>
<div class="sourceCode" id="cb568"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb568-1" title="1">(z <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb568-2" title="2"><span class="st">    </span><span class="kw">moran.test</span>(<span class="dt">listw =</span> lw_q_B) -&gt;<span class="st"> </span>mtr) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb568-3" title="3"><span class="st">    </span><span class="kw">glance_htest</span>()</a></code></pre></div>
<pre><code># Moran I statistic       Expectation          Variance       Std deviate 
#          0.691434         -0.000401          0.000140         58.459835 
#           p.value 
#          0.000000</code></pre>
<p>From the very beginning in the early 1970s, interest was shown in Monte Carlo tests, also known as Hope-type tests and as permutation bootstrap. By default, <code>moran.mc()</code> returns a <code>"htest"</code> object, but may simply use <code>boot::boot()</code> internally and return a <code>"boot"</code> object when <code>return_boot=TRUE</code>. In addition the number of simulations needs to be given as <code>nsim=</code>; that is the number of times the values of the observations are shuffled at random.</p>
<div class="sourceCode" id="cb570"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb570-1" title="1"><span class="kw">set.seed</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb570-2" title="2">z <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb570-3" title="3"><span class="st">    </span><span class="kw">moran.mc</span>(<span class="dt">listw =</span> lw_q_B, <span class="dt">nsim =</span> <span class="dv">999</span>, <span class="dt">return_boot =</span> <span class="ot">TRUE</span>) -&gt;<span class="st"> </span>mmc</a></code></pre></div>
<p>The bootstrap permutation retains the outcomes of each of the random permutations, reporting the observed value of the statistic, here Moran’s <span class="math inline">\(I\)</span>, the difference between this value and the mean of the simulations under randomisation (equivalent to <span class="math inline">\(E(I)\)</span>), and the standard deviation of the simulations under randomisation.</p>
<p>If we compare the Monte Carlo and analytical variances of <span class="math inline">\(I\)</span> under randomisation, we typically see few differences, arguably rendering Monte Carlo testing unnecessary.</p>
<div class="sourceCode" id="cb571"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb571-1" title="1"><span class="kw">c</span>(<span class="st">&quot;Permutation bootstrap&quot;</span> =<span class="st"> </span><span class="kw">var</span>(mmc<span class="op">$</span>t), </a>
<a class="sourceLine" id="cb571-2" title="2">  <span class="st">&quot;Analytical randomisation&quot;</span> =<span class="st"> </span><span class="kw">unname</span>(mtr<span class="op">$</span>estimate[<span class="dv">3</span>]))</a></code></pre></div>
<pre><code>#    Permutation bootstrap Analytical randomisation 
#                 0.000144                 0.000140</code></pre>
<p>Geary’s global <span class="math inline">\(C\)</span> is implemented in <code>geary.test()</code> largely following the same argument structure as <code>moran.test()</code>. The Getis-Ord <span class="math inline">\(G\)</span> test includes extra arguments to accommodate differences between implementations, as Bivand and Wong <span class="citation">(<a href="#ref-Bivand2018">2018</a>)</span> found multiple divergences from the original definitions, often to omit no-neighbour observations generated when using distance band neighbours. It is given by <span class="citation">(Getis and Ord <a href="#ref-getis+ord:92">1992</a>, 194)</span>. For <span class="math inline">\(G^*\)</span>, the <span class="math inline">\(\sum_{(2)}\)</span> constraint is relaxed by including <span class="math inline">\(i\)</span> as a neighbour of itself (thereby also removing the no-neighbour problem, because all observations have at least one neighbour).</p>
<p>Finally, the empirical Bayes Moran’s <span class="math inline">\(I\)</span> takes account of the denominator in assessing spatial autocorrelation in rates data <span class="citation">(Assunção and Reis <a href="#ref-assuncao+reis:99">1999</a>)</span>. Until now, we have considered the proportion of valid votes cast in relation to the numbers entitled to vote by spatial entity, but using <code>EBImoran.mc()</code> we can try to accommodate uncertainty in extreme rates in entities with small numbers entitled to vote. There is, however, little impact on the outcome in this case.</p>
<p>Global measures of spatial autocorrelation using spatial weights objects based on graphs of neighbours are, as we have seen, rather blunt tools, which for interpretation depend critically on a reasoned mean model of the variable in question. If the mean model is just the intercept, the global measures will respond to all kinds of mis-specification, not only spatial autocorrelation. The choice of entities for aggregation of data will typically be a key source of mis-specification.</p>
</div>
</div>
<div id="local-measures" class="section level2">
<h2><span class="header-section-number">15.3</span> Local measures</h2>
<p>Building on insights from the weaknesses of global measures, local indicators of spatial association began to appear in the first half of the 1990s <span class="citation">(Anselin <a href="#ref-anselin:95">1995</a>; Getis and Ord <a href="#ref-getis+ord:92">1992</a>, <a href="#ref-getis+ord:96">1996</a>)</span>.</p>
<p>In addition, the Moran plot was introduced, plotting the values of the variable of interest against their spatially lagged values, typically using row-standardised weights to make the axes more directly comparable <span class="citation">(Anselin <a href="#ref-anselin:96">1996</a>)</span>. The <code>moran.plot()</code> function also returns an influence measures object used to label observations exerting more than proportional influence on the slope of the line representing global Moran’s <span class="math inline">\(I\)</span>. In figure <a href="spatautocorr.html#fig:moranplot">15.1</a>, we can see that there are many spatial entities exerting such influence. These pairs of observed and lagged observed values make up in aggregate the global measure, but can also be explored in detail. The quadrants of the Moran plot also show low-low pairs in the lower left quadrant, high-high in the upper right quadrant, and fewer low-high and high-low pairs in the upper left and lower right quadrants.</p>

<div class="sourceCode" id="cb573"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb573-1" title="1">z <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb573-2" title="2"><span class="st">    </span><span class="kw">moran.plot</span>(<span class="dt">listw =</span> lw_q_W, <span class="dt">labels =</span> pol_pres15<span class="op">$</span>TERYT, <span class="dt">cex =</span> <span class="dv">1</span>, <span class="dt">pch =</span> <span class="st">&quot;.&quot;</span>,</a>
<a class="sourceLine" id="cb573-3" title="3">        <span class="dt">xlab =</span> <span class="st">&quot;I round turnout&quot;</span>, <span class="dt">ylab =</span> <span class="st">&quot;lagged turnout&quot;</span>) -&gt;<span class="st"> </span>infl_W</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:moranplot"></span>
<img src="sds_files/figure-html/moranplot-1.png" alt="Moran plot of I round turnout, row standardised weights" width="100%" />
<p class="caption">
Figure 15.1: Moran plot of I round turnout, row standardised weights
</p>
</div>
<p>If we extract the hat value influence measure from the returned object, Figure <a href="spatautocorr.html#fig:moranhat">15.2</a> suggests that some edge entities exert more than proportional influence (perhaps because of row standardisation), as do entities in or near larger urban areas.</p>

<div class="sourceCode" id="cb574"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb574-1" title="1">pol_pres15<span class="op">$</span>hat_value &lt;-<span class="st"> </span>infl_W<span class="op">$</span>hat</a>
<a class="sourceLine" id="cb574-2" title="2"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="st">&quot;hat_value&quot;</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:moranhat"></span>
<img src="sds_files/figure-html/moranhat-1.png" alt="Moran plot hat values, row standardised neighbours" width="100%" />
<p class="caption">
Figure 15.2: Moran plot hat values, row standardised neighbours
</p>
</div>
<div id="local-morans-i_i" class="section level3">
<h3><span class="header-section-number">15.3.1</span> Local Moran’s <span class="math inline">\(I_i\)</span></h3>
<p>Bivand and Wong <span class="citation">(<a href="#ref-Bivand2018">2018</a>)</span> discuss issues impacting the use of local indicators, such as local Moran’s <span class="math inline">\(I_i\)</span> and local Getis-Ord <span class="math inline">\(G_i\)</span>. Some issues affect the calculation of the local indicators, others inference from their values. Because <span class="math inline">\(n\)</span> statistics may be being calculated from the same number of observations, there are multiple comparison problems that need to be addressed. Although the apparent detection of hotspots from values of local indicators has been quite widely adopted, it remains fraught with difficulty because adjustment of the inferential basis to accommodate multiple comparisons is not often chosen, and as in the global case, mis-specification also remains a source of confusion. Further, interpreting local spatial autocorrelation in the presence of global spatial autocorrelation is challenging <span class="citation">(Ord and Getis <a href="#ref-ord+getis:01">2001</a>; Tiefelsdorf <a href="#ref-tiefelsdorf:02">2002</a>; Bivand, Müller, and Reder <a href="#ref-bivandetal:09">2009</a>)</span>.</p>
<div class="sourceCode" id="cb575"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb575-1" title="1"><span class="kw">args</span>(localmoran)</a></code></pre></div>
<pre><code># function (x, listw, zero.policy = NULL, na.action = na.fail, 
#     conditional = TRUE, alternative = &quot;two.sided&quot;, p.adjust.method = &quot;none&quot;, 
#     mlvar = TRUE, spChk = NULL, adjust.x = FALSE) 
# NULL</code></pre>
<p>The <code>mlvar=</code> and <code>adjust.x=</code> arguments to <code>localmoran()</code> are discussed in Bivand and Wong <span class="citation">(<a href="#ref-Bivand2018">2018</a>)</span>, and permit matching with other implementations. The <code>p.adjust.method=</code> argument uses an untested speculation implemented in <code>p.adjustSP()</code> that adjustment should only take into account the cardinality of the neighbour set of each observation when adjusting for multiple comparisons; using <code>stats::p.adjust()</code> is preferable.</p>
<p>Taking <code>"two.sided"</code> p-values, we obtain:</p>
<div class="sourceCode" id="cb577"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb577-1" title="1">z <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb577-2" title="2"><span class="st">    </span><span class="kw">localmoran</span>(<span class="dt">listw =</span> lw_q_W, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>) -&gt;<span class="st"> </span>locm</a></code></pre></div>
<p>The <span class="math inline">\(I_i\)</span> local indicators when summed and divided by the sum of the spatial weights equal global Moran’s <span class="math inline">\(I\)</span>, showing the possible presence of positive and negative local spatial autocorrelation:</p>
<div class="sourceCode" id="cb578"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb578-1" title="1"><span class="kw">all.equal</span>(<span class="kw">sum</span>(locm[,<span class="dv">1</span>])<span class="op">/</span><span class="kw">Szero</span>(lw_q_W), <span class="kw">unname</span>(<span class="kw">moran.test</span>(z, lw_q_W)<span class="op">$</span>estimate[<span class="dv">1</span>]))</a></code></pre></div>
<pre><code># [1] TRUE</code></pre>
<p>Using <code>stats::p.adjust()</code> to adjust for multiple comparisons, we see that almost 29% of the 2495 local measures have p-values &lt; 0.05 if no adjustment is applied, but only 12% using Bonferroni adjustment to control the familywise error rate, with two other choices shown: <code>fdr</code> is the <span class="citation">Benjamini and Hochberg (<a href="#ref-fdr-BH">1995</a>)</span> false discovery rate and <code>BY</code> <span class="citation">(Benjamini and Yekutieli <a href="#ref-10.1214/aos/1013699998">2001</a>)</span>, another false discovery rate adjustment:</p>
<div class="sourceCode" id="cb580"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb580-1" title="1">pva &lt;-<span class="st"> </span><span class="cf">function</span>(pv) <span class="kw">cbind</span>(<span class="st">&quot;none&quot;</span> =<span class="st"> </span>pv, <span class="st">&quot;bonferroni&quot;</span> =<span class="st"> </span><span class="kw">p.adjust</span>(pv, <span class="st">&quot;bonferroni&quot;</span>),</a>
<a class="sourceLine" id="cb580-2" title="2">    <span class="st">&quot;fdr&quot;</span> =<span class="st"> </span><span class="kw">p.adjust</span>(pv, <span class="st">&quot;fdr&quot;</span>), <span class="st">&quot;BY&quot;</span> =<span class="st"> </span><span class="kw">p.adjust</span>(pv, <span class="st">&quot;BY&quot;</span>))</a>
<a class="sourceLine" id="cb580-3" title="3">locm <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb580-4" title="4"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select =</span> <span class="st">&quot;Pr(z != E(Ii))&quot;</span>, <span class="dt">drop =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb580-5" title="5"><span class="st">    </span><span class="kw">pva</span>() -&gt;<span class="st"> </span>pvsp</a>
<a class="sourceLine" id="cb580-6" title="6">f &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">sum</span>(x <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>)</a>
<a class="sourceLine" id="cb580-7" title="7"><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, f)</a></code></pre></div>
<pre><code>#       none bonferroni        fdr         BY 
#        789         69        468        156</code></pre>
<p>In the global measure case, bootstrap permutations may be used as an alternative to analytical methods for possible inference, where both the theoretical development of the analytical variance of the measure, and the permutation scheme, shuffle all of the observed values. In the local case, conditional permutation may be used, fixing the value at observation <span class="math inline">\(i\)</span> and randomly sampling from the remaining <span class="math inline">\(n-1\)</span> values to find randomised values at neighbours, and is provided as <code>localmoran_perm()</code>, which may use multiple nodes to sample in parallel if provided, and permits the setting of a seed for the random number generator across the compute nodes:</p>
<div class="sourceCode" id="cb582"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb582-1" title="1"><span class="kw">library</span>(parallel)</a>
<a class="sourceLine" id="cb582-2" title="2"><span class="kw">set.coresOption</span>(<span class="kw">ifelse</span>(<span class="kw">detectCores</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="kw">detectCores</span>()<span class="op">-</span>1L))</a></code></pre></div>
<pre><code># NULL</code></pre>
<div class="sourceCode" id="cb584"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb584-1" title="1"><span class="kw">system.time</span>(z <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb584-2" title="2"><span class="st">        </span><span class="kw">localmoran_perm</span>(<span class="dt">listw =</span> lw_q_W, <span class="dt">nsim =</span> <span class="dv">499</span>, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>,</a>
<a class="sourceLine" id="cb584-3" title="3">            <span class="dt">iseed =</span> <span class="dv">1</span>) -&gt;<span class="st"> </span>locm_p)</a></code></pre></div>
<pre><code>#    user  system elapsed 
#   2.010   0.373   0.528</code></pre>
<p>The outcome is that almost 32% of observations have two sided p-values &lt; 0.05 without multiple comparison adjustment, and under 3% with Bonferroni adjustment.</p>
<div class="sourceCode" id="cb586"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb586-1" title="1">locm_p <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb586-2" title="2"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select =</span> <span class="st">&quot;Pr(z != E(Ii))&quot;</span>, <span class="dt">drop =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb586-3" title="3"><span class="st">    </span><span class="kw">pva</span>() -&gt;<span class="st"> </span>pvsp</a>
<a class="sourceLine" id="cb586-4" title="4"><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, f)</a></code></pre></div>
<pre><code>#       none bonferroni        fdr         BY 
#        797         76        463        161</code></pre>
<p>We can see what is happening by tabulating counts of the standard deviate of local Moran’s <span class="math inline">\(I\)</span>, where the two-sided <span class="math inline">\(\alpha=0.05\)</span> bounds would be <span class="math inline">\(0.025\)</span> and <span class="math inline">\(0.975\)</span>, but Bonferroni adjustment is close to <span class="math inline">\(0.00001\)</span> and <span class="math inline">\(0.99999\)</span>. Without adjustment, almost 800 observations are significant, with Bonferroni adjustment, only almost 70 in the conditional permutation case:</p>
<div class="sourceCode" id="cb588"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb588-1" title="1">brks &lt;-<span class="st"> </span><span class="kw">qnorm</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.00001</span>, <span class="fl">0.0001</span>, <span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>, <span class="fl">0.99</span>, <span class="fl">0.999</span>, <span class="fl">0.9999</span>,</a>
<a class="sourceLine" id="cb588-2" title="2">    <span class="fl">0.99999</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb588-3" title="3">(locm_p <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb588-4" title="4"><span class="st">        </span><span class="kw">subset</span>(<span class="dt">select =</span> Z.Ii, <span class="dt">drop =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb588-5" title="5"><span class="st">        </span><span class="kw">cut</span>(brks) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb588-6" title="6"><span class="st">        </span><span class="kw">table</span>()-&gt;<span class="st"> </span>tab)</a></code></pre></div>
<pre><code># .
#  (-Inf,-4.26] (-4.26,-3.72] (-3.72,-3.09] (-3.09,-2.33] (-2.33,-1.96] 
#             0             0             1             4             5 
#     (-1.96,0]      (0,1.96]   (1.96,2.33]   (2.33,3.09]   (3.09,3.72] 
#           459          1239           195           316           145 
#   (3.72,4.26]   (4.26, Inf] 
#            55            76</code></pre>
<div class="sourceCode" id="cb590"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb590-1" title="1"><span class="kw">sum</span>(tab[<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">8</span><span class="op">:</span><span class="dv">12</span>)])</a></code></pre></div>
<pre><code># [1] 797</code></pre>
<div class="sourceCode" id="cb592"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb592-1" title="1"><span class="kw">sum</span>(tab[<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">12</span>)])</a></code></pre></div>
<pre><code># [1] 76</code></pre>
<p>In an important clarification, <span class="citation">Sauer et al. (<a href="#ref-sauer_oshan_rey_wolf_2021">2021</a>)</span> show that the comparison of standard deviates for local Moran’s <span class="math inline">\(I_i\)</span> based on analytical formulae and conditional permutation in <span class="citation">Bivand and Wong (<a href="#ref-Bivand2018">2018</a>)</span> was based on a misunderstanding. <span class="citation">Sokal, Oden, and Thomson (<a href="#ref-sokaletal:98">1998</a>)</span> provide alternative analytical formulae for standard deviates of local Moran’s <span class="math inline">\(I_i\)</span> based either on total or conditional permutation, but the analytical formulae used in <span class="citation">Bivand and Wong (<a href="#ref-Bivand2018">2018</a>)</span>, based on earlier practice, only use total permutation, and consequently do not match the simulation conditional permutations. Thanks to a timely pull request, <code>localmoran()</code> now has a <code>conditional=</code> argument using alternative formulae from the appendix of <span class="citation">Sokal, Oden, and Thomson (<a href="#ref-sokaletal:98">1998</a>)</span>:</p>
<div class="sourceCode" id="cb594"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb594-1" title="1">z <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb594-2" title="2"><span class="st">    </span><span class="kw">localmoran</span>(<span class="dt">listw =</span> lw_q_W, <span class="dt">conditional =</span> <span class="ot">TRUE</span>, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>) -&gt;<span class="st"> </span>locm_c</a></code></pre></div>
<p>yielding standard deviates that correspond closely to those from simulation:</p>
<div class="sourceCode" id="cb595"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb595-1" title="1">locm_c <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb595-2" title="2"><span class="st">    </span><span class="kw">subset</span>(<span class="dt">select =</span> <span class="st">&quot;Pr(z != E(Ii))&quot;</span>, <span class="dt">drop =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb595-3" title="3"><span class="st">    </span><span class="kw">pva</span>() -&gt;<span class="st"> </span>pvsp</a>
<a class="sourceLine" id="cb595-4" title="4"><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, f)</a></code></pre></div>
<pre><code>#       none bonferroni        fdr         BY 
#        789         69        468        156</code></pre>

<div class="sourceCode" id="cb597"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb597-1" title="1">pol_pres15<span class="op">$</span>locm_Z &lt;-<span class="st"> </span>locm[, <span class="st">&quot;Z.Ii&quot;</span>]</a>
<a class="sourceLine" id="cb597-2" title="2">pol_pres15<span class="op">$</span>locm_c_Z &lt;-<span class="st"> </span>locm_c[, <span class="st">&quot;Z.Ii&quot;</span>]</a>
<a class="sourceLine" id="cb597-3" title="3">pol_pres15<span class="op">$</span>locm_p_Z &lt;-<span class="st"> </span>locm_p[, <span class="st">&quot;Z.Ii&quot;</span>]</a>
<a class="sourceLine" id="cb597-4" title="4"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;locm_Z&quot;</span>, <span class="st">&quot;locm_c_Z&quot;</span>, <span class="st">&quot;locm_p_Z&quot;</span>), <span class="dt">breaks =</span> brks,</a>
<a class="sourceLine" id="cb597-5" title="5">    <span class="dt">midpoint =</span> <span class="dv">0</span>, <span class="dt">title =</span> <span class="st">&quot;Standard deviates of</span><span class="ch">\n</span><span class="st">Local Moran&#39;s I&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb597-6" title="6"><span class="st">    </span><span class="kw">tm_facets</span>(<span class="dt">free.scales =</span> <span class="ot">FALSE</span>, <span class="dt">ncol =</span> <span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels =</span> <span class="kw">c</span>(<span class="st">&quot;Analytical total&quot;</span>,</a>
<a class="sourceLine" id="cb597-7" title="7">        <span class="st">&quot;Analytical conditional&quot;</span>, <span class="st">&quot;Conditional permutation&quot;</span>))</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:localmoranZ"></span>
<img src="sds_files/figure-html/localmoranZ-1.png" alt="Analytical total and conditional permutation, and bootstrap conditional permutation standard deviates of local Moran’s I for first round turnout, row-standardised neighbours" width="100%" />
<p class="caption">
Figure 15.3: Analytical total and conditional permutation, and bootstrap conditional permutation standard deviates of local Moran’s I for first round turnout, row-standardised neighbours
</p>
</div>
<p>Figure <a href="spatautocorr.html#fig:localmoranZ">15.3</a> shows that conditional permutation scales back the proportion of standard deviate values taking extreme values, especially positive values. The analytical total standard deviates of local Moran’s <span class="math inline">\(I\)</span> should probably not be used since alternatives are available, not least thanks to the clarification by <span class="citation">Sauer et al. (<a href="#ref-sauer_oshan_rey_wolf_2021">2021</a>)</span>.</p>
<p>In presenting local Moran’s <span class="math inline">\(I\)</span>, use is often made of “hotspot” maps. Because <span class="math inline">\(I_i\)</span> takes high values both for strong positive autocorrelation of low and high values of the input variable, it is hard to show where “clusters” of similar neighbours with low or high values of the input variable occur. The quadrants of the Moran plot are used, by creating a categorical quadrant variable interacting the input variable and its spatial lag split at their means. The quadrant categories are then set to NA if, for the chosen standard deviate and adjustment, <span class="math inline">\(I_i\)</span> would be considered insignificant. Here, for the Bonferroni adjusted conditional analytical standard deviates, 14 observations belong to “Low-Low clusters”, and 55 to “High-High clusters”:</p>
<div class="sourceCode" id="cb598"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb598-1" title="1">quadr &lt;-<span class="st"> </span><span class="kw">interaction</span>(</a>
<a class="sourceLine" id="cb598-2" title="2">    <span class="kw">cut</span>(infl_W<span class="op">$</span>x, <span class="kw">c</span>(<span class="op">-</span><span class="ot">Inf</span>, <span class="kw">mean</span>(infl_W<span class="op">$</span>x), <span class="ot">Inf</span>), <span class="dt">labels=</span><span class="kw">c</span>(<span class="st">&quot;Low X&quot;</span>, <span class="st">&quot;High X&quot;</span>)),</a>
<a class="sourceLine" id="cb598-3" title="3">    <span class="kw">cut</span>(infl_W<span class="op">$</span>wx, <span class="kw">c</span>(<span class="op">-</span><span class="ot">Inf</span>, <span class="kw">mean</span>(infl_W<span class="op">$</span>wx), <span class="ot">Inf</span>), <span class="dt">labels=</span><span class="kw">c</span>(<span class="st">&quot;Low WX&quot;</span>, <span class="st">&quot;High WX&quot;</span>)),</a>
<a class="sourceLine" id="cb598-4" title="4">    <span class="dt">sep=</span><span class="st">&quot; : &quot;</span>)</a>
<a class="sourceLine" id="cb598-5" title="5">a &lt;-<span class="st"> </span><span class="kw">table</span>(quadr)</a>
<a class="sourceLine" id="cb598-6" title="6">pol_pres15<span class="op">$</span>hs_an_q &lt;-<span class="st"> </span>quadr</a>
<a class="sourceLine" id="cb598-7" title="7"><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>hs_an_q) &lt;-<span class="st"> </span><span class="op">!</span>(pol_pres15<span class="op">$</span>locm_Z <span class="op">&lt;</span><span class="st"> </span>brks[<span class="dv">6</span>] <span class="op">|</span><span class="st"> </span></a>
<a class="sourceLine" id="cb598-8" title="8"><span class="st">        </span>pol_pres15<span class="op">$</span>locm_Z <span class="op">&gt;</span><span class="st"> </span>brks[<span class="dv">8</span>])</a>
<a class="sourceLine" id="cb598-9" title="9">b &lt;-<span class="st"> </span><span class="kw">table</span>(pol_pres15<span class="op">$</span>hs_an_q)</a>
<a class="sourceLine" id="cb598-10" title="10">pol_pres15<span class="op">$</span>hs_ac_q &lt;-<span class="st"> </span>quadr</a>
<a class="sourceLine" id="cb598-11" title="11"><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>hs_ac_q) &lt;-<span class="st"> </span><span class="op">!</span>(pol_pres15<span class="op">$</span>locm_c_Z <span class="op">&lt;</span><span class="st"> </span>brks[<span class="dv">2</span>] <span class="op">|</span><span class="st"> </span></a>
<a class="sourceLine" id="cb598-12" title="12"><span class="st">        </span>pol_pres15<span class="op">$</span>locm_c_Z <span class="op">&gt;</span><span class="st"> </span>brks[<span class="dv">12</span>])</a>
<a class="sourceLine" id="cb598-13" title="13">c &lt;-<span class="st"> </span><span class="kw">table</span>(pol_pres15<span class="op">$</span>hs_ac_q)</a>
<a class="sourceLine" id="cb598-14" title="14">pol_pres15<span class="op">$</span>hs_cp_q &lt;-<span class="st"> </span>quadr</a>
<a class="sourceLine" id="cb598-15" title="15"><span class="kw">is.na</span>(pol_pres15<span class="op">$</span>hs_cp_q) &lt;-<span class="st"> </span><span class="op">!</span>(pol_pres15<span class="op">$</span>locm_p_Z <span class="op">&lt;</span><span class="st"> </span>brks[<span class="dv">2</span>] <span class="op">|</span><span class="st"> </span></a>
<a class="sourceLine" id="cb598-16" title="16"><span class="st">        </span>pol_pres15<span class="op">$</span>locm_p_Z <span class="op">&gt;</span><span class="st"> </span>brks[<span class="dv">12</span>])</a>
<a class="sourceLine" id="cb598-17" title="17">d &lt;-<span class="st"> </span><span class="kw">table</span>(pol_pres15<span class="op">$</span>hs_cp_q)</a>
<a class="sourceLine" id="cb598-18" title="18"><span class="kw">t</span>(<span class="kw">rbind</span>(<span class="st">&quot;Moran plot quadrants&quot;</span> =<span class="st"> </span>a, <span class="st">&quot;Unadjusted analytical total&quot;</span> =<span class="st"> </span>b, </a>
<a class="sourceLine" id="cb598-19" title="19">    <span class="st">&quot;Bonferroni analytical cond.&quot;</span> =<span class="st"> </span>c, <span class="st">&quot;Bonferroni cond. perm.&quot;</span> =<span class="st"> </span>d))</a></code></pre></div>
<pre><code>#                  Moran plot quadrants Unadjusted analytical total
# Low X : Low WX                   1040                         402
# High X : Low WX                   264                           7
# Low X : High WX                   213                           2
# High X : High WX                  978                         378
#                  Bonferroni analytical cond. Bonferroni cond. perm.
# Low X : Low WX                            14                     18
# High X : Low WX                            0                      0
# Low X : High WX                            0                      0
# High X : High WX                          55                     58</code></pre>

<div class="sourceCode" id="cb600"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb600-1" title="1"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;hs_an_q&quot;</span>, <span class="st">&quot;hs_ac_q&quot;</span>, <span class="st">&quot;hs_cp_q&quot;</span>), <span class="dt">colorNA=</span><span class="st">&quot;grey95&quot;</span>,</a>
<a class="sourceLine" id="cb600-2" title="2">    <span class="dt">textNA=</span><span class="st">&quot;Not significant&quot;</span>, <span class="dt">title=</span><span class="st">&quot;Turnout hotspot status</span><span class="ch">\n</span><span class="st">Local Moran&#39;s I&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb600-3" title="3"><span class="st">    </span><span class="kw">tm_facets</span>(<span class="dt">free.scales=</span><span class="ot">FALSE</span>, <span class="dt">ncol=</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels=</span></a>
<a class="sourceLine" id="cb600-4" title="4">            <span class="kw">c</span>(<span class="st">&quot;Unadjusted analytical total&quot;</span>, <span class="st">&quot;Bonferroni analytical cond.&quot;</span>, </a>
<a class="sourceLine" id="cb600-5" title="5">              <span class="st">&quot;Cond. perm. with Bonferroni&quot;</span>))</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:Iihotspots"></span>
<img src="sds_files/figure-html/Iihotspots-1.png" alt="Local Moran’s I hotspot maps \(\alpha = 0.05\): left panel upper: unadjusted analytical standard deviates; right upper panel: Bonferroni adjusted analytical conditional standard deviates; left lower panel: Bonferroni adjusted bootstrap conditional permutation standard deviates, first round turnout, row-standardised neighbours" width="100%" />
<p class="caption">
Figure 15.4: Local Moran’s I hotspot maps <span class="math inline">\(\alpha = 0.05\)</span>: left panel upper: unadjusted analytical standard deviates; right upper panel: Bonferroni adjusted analytical conditional standard deviates; left lower panel: Bonferroni adjusted bootstrap conditional permutation standard deviates, first round turnout, row-standardised neighbours
</p>
</div>
<p>Figure <a href="spatautocorr.html#fig:Iihotspots">15.4</a> shows the impact of using analytical or conditional permutation standard deviates, and no or Bonferroni adjustment, reducing the counts of observations in “Low-Low clusters” from 370 to 14, and “High-High clusters” from 342 to 54; the “High-High clusters” are metropolitan areas.</p>
<p><span class="citation">Tiefelsdorf (<a href="#ref-tiefelsdorf:02">2002</a>)</span> argues that standard approaches to the calculation of the standard deviates of local Moran’s <span class="math inline">\(I_i\)</span> should be supplemented by numerical estimates, and shows that Saddlepoint approximations are a computationally efficient way of achieving this goal. The <code>localmoran.sad()</code> function takes a fitted linear model as its first argument, so we first fit a null (intercept only) model, but use case weights because the numbers entitled to vote vary greatly between observations:</p>
<div class="sourceCode" id="cb601"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb601-1" title="1"><span class="kw">lm</span>(z <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">weights =</span> pol_pres15<span class="op">$</span>I_entitled_to_vote) -&gt;<span class="st"> </span>lm_null</a></code></pre></div>
<p>Saddlepoint approximation is much more computationally intensive than conditional permutation:</p>
<div class="sourceCode" id="cb602"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb602-1" title="1"><span class="kw">system.time</span>(lm_null <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">localmoran.sad</span>(<span class="dt">nb =</span> nb_q, <span class="dt">style =</span> <span class="st">&quot;W&quot;</span>, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb602-2" title="2"><span class="st">        </span><span class="kw">summary</span>() -&gt;<span class="st"> </span>locm_sad_null)</a></code></pre></div>
<pre><code>#    user  system elapsed 
#  10.987   0.036  11.029</code></pre>
<p>However, standard approaches do not permit richer mean models with covariates or case weights. Next we add the categorical variable distinguishing between rural, urban and other types of observational unit:</p>
<div class="sourceCode" id="cb604"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb604-1" title="1"><span class="kw">lm</span>(z <span class="op">~</span><span class="st"> </span>Types, <span class="dt">weights=</span>pol_pres15<span class="op">$</span>I_entitled_to_vote) -&gt;<span class="st"> </span>lm_types</a></code></pre></div>
<div class="sourceCode" id="cb605"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb605-1" title="1"><span class="kw">system.time</span>(lm_types <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">localmoran.sad</span>(<span class="dt">nb =</span> nb_q, <span class="dt">style =</span> <span class="st">&quot;W&quot;</span>, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb605-2" title="2"><span class="st">        </span><span class="kw">summary</span>() -&gt;<span class="st"> </span>locm_sad_types)</a></code></pre></div>
<pre><code>#    user  system elapsed 
#  11.358   0.016  11.385</code></pre>
<p>To conclude, we add the spatially lagged categories, although the spatial lag of a categorical variable, represented by dummies in the model matrix, is not well defined:</p>
<div class="sourceCode" id="cb607"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb607-1" title="1">spatialreg<span class="op">::</span><span class="kw">lmSLX</span>(z <span class="op">~</span><span class="st"> </span>Types, <span class="dt">listw =</span> lw_q_W, </a>
<a class="sourceLine" id="cb607-2" title="2">    <span class="dt">weights =</span> pol_pres15<span class="op">$</span>I_entitled_to_vote) -&gt;<span class="st"> </span>lm_Dtypes</a></code></pre></div>
<div class="sourceCode" id="cb608"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb608-1" title="1"><span class="kw">system.time</span>(lm_Dtypes <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">localmoran.sad</span>(<span class="dt">nb =</span> nb_q, <span class="dt">style =</span> <span class="st">&quot;W&quot;</span>, <span class="dt">alternative =</span> <span class="st">&quot;two.sided&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb608-2" title="2"><span class="st">        </span><span class="kw">summary</span>() -&gt;<span class="st"> </span>locm_sad_Dtypes)</a></code></pre></div>
<pre><code>#    user  system elapsed 
#  12.590   0.012  12.604</code></pre>

<div class="sourceCode" id="cb610"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb610-1" title="1">pol_pres15<span class="op">$</span>locm_sad_null_Z &lt;-<span class="st"> </span>locm_sad_null[, <span class="st">&quot;Saddlepoint&quot;</span>]</a>
<a class="sourceLine" id="cb610-2" title="2">pol_pres15<span class="op">$</span>locm_sad_types_Z &lt;-<span class="st"> </span>locm_sad_types[, <span class="st">&quot;Saddlepoint&quot;</span>]</a>
<a class="sourceLine" id="cb610-3" title="3">pol_pres15<span class="op">$</span>locm_sad_Dtypes_Z &lt;-<span class="st"> </span>locm_sad_Dtypes[, <span class="st">&quot;Saddlepoint&quot;</span>]</a>
<a class="sourceLine" id="cb610-4" title="4"><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;locm_sad_null_Z&quot;</span>, <span class="st">&quot;locm_sad_types_Z&quot;</span>,</a>
<a class="sourceLine" id="cb610-5" title="5">    <span class="st">&quot;locm_sad_Dtypes_Z&quot;</span>, <span class="st">&quot;locm_c_Z&quot;</span>), <span class="dt">breaks =</span> brks, <span class="dt">midpoint=</span><span class="dv">0</span>,</a>
<a class="sourceLine" id="cb610-6" title="6">    <span class="dt">title=</span><span class="st">&quot;Standard deviates of</span><span class="ch">\n</span><span class="st">Local Moran&#39;s I&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb610-7" title="7"><span class="st">    </span><span class="kw">tm_facets</span>(<span class="dt">free.scales =</span> <span class="ot">FALSE</span>, <span class="dt">ncol =</span> <span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb610-8" title="8">        <span class="st">&quot;Saddlepoint weighted null&quot;</span>,</a>
<a class="sourceLine" id="cb610-9" title="9">        <span class="st">&quot;Saddlepoint weighted types&quot;</span>,</a>
<a class="sourceLine" id="cb610-10" title="10">        <span class="st">&quot;Saddlepoint weighted Durbin types&quot;</span>,</a>
<a class="sourceLine" id="cb610-11" title="11">        <span class="st">&quot;Analytical conditional&quot;</span>))</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:localmoranZsad"></span>
<img src="sds_files/figure-html/localmoranZsad-1.png" alt="Saddlepoint weighted null model, weighted types model, weighted Durbin types model, and analytical conditional standard deviates of local Moran’s I for first round turnout, row-standardised neighbours" width="100%" />
<p class="caption">
Figure 15.5: Saddlepoint weighted null model, weighted types model, weighted Durbin types model, and analytical conditional standard deviates of local Moran’s I for first round turnout, row-standardised neighbours
</p>
</div>
<p>Figure <a href="spatautocorr.html#fig:localmoranZsad">15.5</a> includes the analytical conditional standard deviates for comparison (lower right panel), but in general it can be seen that the Saddlepoint approximation standard deviates lie closer to zero, possibly because some of the mis-specification in the mean model has been removed by using richer versions, and possibly because the approximation approach is inherently local, relating regression residual values at <span class="math inline">\(i\)</span> to those of its neighbours. It is also possible to use Saddlepoint approximation where the global spatial process has been incorporated, removing the conflation of global and local spatial autocorrelation in standard approaches. The same can also be accomplished using exact methods <span class="citation">(Bivand, Müller, and Reder <a href="#ref-bivandetal:09">2009</a>)</span>.</p>
</div>
<div id="local-getis-ord-g_i" class="section level3">
<h3><span class="header-section-number">15.3.2</span> Local Getis-Ord <span class="math inline">\(G_i\)</span></h3>
<p>The local Getis-Ord <span class="math inline">\(G\)</span> measure is reported as a standard deviate, and may also take the <span class="math inline">\(G^*_i\)</span> form where self-neighbours are inserted into the neighbour object using <code>include.self()</code>. The observed and expected values of local <span class="math inline">\(G\)</span> with their analytical variances may also be returned if <code>return_internals=TRUE</code>.</p>
<div class="sourceCode" id="cb611"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb611-1" title="1"><span class="kw">system.time</span>(z <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb611-2" title="2"><span class="st">        </span><span class="kw">localG</span>(lw_q_W) -&gt;<span class="st"> </span>locG)</a></code></pre></div>
<pre><code>#    user  system elapsed 
#   0.007   0.000   0.006</code></pre>
<div class="sourceCode" id="cb613"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb613-1" title="1"><span class="kw">system.time</span>(z <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb613-2" title="2"><span class="st">        </span><span class="kw">localG_perm</span>(lw_q_W, <span class="dt">nsim =</span> <span class="dv">499</span>, <span class="dt">iseed =</span> <span class="dv">1</span>) -&gt;<span class="st"> </span>locG_p)</a></code></pre></div>
<pre><code>#    user  system elapsed 
#   0.486   0.000   0.486</code></pre>
<p>Once again we face the problem of multiple comparisons, with the count of areal unit p-values &lt; 0.05 being reduced by an order of magnitude when employing Bonferroni correction:</p>
<div class="sourceCode" id="cb615"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb615-1" title="1">locG <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb615-2" title="2"><span class="st">    </span><span class="kw">c</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb615-3" title="3"><span class="st">    </span><span class="kw">abs</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb615-4" title="4"><span class="st">    </span><span class="kw">pnorm</span>(<span class="dt">lower.tail =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb615-5" title="5"><span class="st">    </span>(<span class="cf">function</span>(x) x<span class="op">*</span><span class="dv">2</span>)() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb615-6" title="6"><span class="st">    </span><span class="kw">pva</span>() -&gt;<span class="st"> </span>pvsp</a>
<a class="sourceLine" id="cb615-7" title="7"><span class="kw">apply</span>(pvsp, <span class="dv">2</span>, f)</a></code></pre></div>
<pre><code>#       none bonferroni        fdr         BY 
#        789         69        468        156</code></pre>

<div class="sourceCode" id="cb617"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb617-1" title="1"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb617-2" title="2">p1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">data.frame</span>(<span class="dt">Zi=</span>locm_c[,<span class="dv">4</span>], <span class="dt">Zi_perm=</span>locm_p[,<span class="dv">4</span>])) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Zi,</a>
<a class="sourceLine" id="cb617-3" title="3">    <span class="dt">y=</span>Zi_perm), <span class="dt">alpha=</span><span class="fl">0.2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Analytical conditional&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb617-4" title="4"><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Bootstrap conditional&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">coord_fixed</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Local Moran&#39;s I&quot;</span>)</a>
<a class="sourceLine" id="cb617-5" title="5">p2 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">data.frame</span>(<span class="dt">Zi=</span><span class="kw">c</span>(locG), <span class="dt">Zi_perm=</span><span class="kw">c</span>(locG_p))) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Zi, </a>
<a class="sourceLine" id="cb617-6" title="6">    <span class="dt">y=</span>Zi_perm), <span class="dt">alpha=</span><span class="fl">0.2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Analytical conditional&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb617-7" title="7"><span class="st">    </span><span class="kw">ylab</span>(<span class="st">&quot;Bootstrap conditional&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">coord_fixed</span>() <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;Local G&quot;</span>)</a>
<a class="sourceLine" id="cb617-8" title="8">gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(p1, p2, <span class="dt">nrow=</span><span class="dv">1</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:localZvalues"></span>
<img src="sds_files/figure-html/localZvalues-1.png" alt="Plots of analytical conditional against bootstrap standard deviates; left: local Moran’s I; right: local G; first round turnout, row-standardised neighbours" width="100%" />
<p class="caption">
Figure 15.6: Plots of analytical conditional against bootstrap standard deviates; left: local Moran’s I; right: local G; first round turnout, row-standardised neighbours
</p>
</div>
<p>Figure <a href="spatautocorr.html#fig:localZvalues">15.6</a> shows that, when using analytical conditional standard deviates, the values from analytical and bootstrap estimates coincide for both <span class="math inline">\(I_i\)</span> and <span class="math inline">\(G_i\)</span>. In both cases, one may argue that the bootstrap approach is superfluous in exploratory spatial data analysis.</p>
<div class="sourceCode" id="cb618"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb618-1" title="1">pol_pres15<span class="op">$</span>locG_Z &lt;-<span class="st"> </span><span class="kw">c</span>(locG)</a>
<a class="sourceLine" id="cb618-2" title="2">pol_pres15<span class="op">$</span>hs_G &lt;-<span class="st"> </span><span class="kw">cut</span>(<span class="kw">c</span>(locG), <span class="kw">c</span>(<span class="op">-</span><span class="ot">Inf</span>, brks[<span class="dv">2</span>], brks[<span class="dv">12</span>], <span class="ot">Inf</span>), </a>
<a class="sourceLine" id="cb618-3" title="3">    <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;Low&quot;</span>, <span class="st">&quot;Not significant&quot;</span>, <span class="st">&quot;High&quot;</span>))</a>
<a class="sourceLine" id="cb618-4" title="4"><span class="kw">table</span>(pol_pres15<span class="op">$</span>hs_G)</a></code></pre></div>
<pre><code># 
#             Low Not significant            High 
#              14            2426              55</code></pre>

<div class="sourceCode" id="cb620"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb620-1" title="1">m1 &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;locG_Z&quot;</span>), <span class="dt">midpoint =</span> <span class="dv">0</span>, <span class="dt">title =</span> <span class="st">&quot;Standard</span><span class="ch">\n</span><span class="st">deviate&quot;</span>)</a>
<a class="sourceLine" id="cb620-2" title="2">m2 &lt;-<span class="st"> </span><span class="kw">tm_shape</span>(pol_pres15) <span class="op">+</span><span class="st"> </span><span class="kw">tm_fill</span>(<span class="kw">c</span>(<span class="st">&quot;hs_G&quot;</span>), </a>
<a class="sourceLine" id="cb620-3" title="3">    <span class="dt">title=</span><span class="st">&quot;Local G Bonferroni</span><span class="ch">\n</span><span class="st">adjusted hotspot status&quot;</span>)</a>
<a class="sourceLine" id="cb620-4" title="4"><span class="kw">tmap_arrange</span>(m1, m2, <span class="dt">nrow=</span><span class="dv">1</span>)</a></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:localG"></span>
<img src="sds_files/figure-html/localG-1.png" alt="Left: analytical standard deviates of local G; right: Bonferroni hotspots; first round turnout, row-standardised neighbours" width="100%" />
<p class="caption">
Figure 15.7: Left: analytical standard deviates of local G; right: Bonferroni hotspots; first round turnout, row-standardised neighbours
</p>
</div>
<p>As can be seen from Figure <a href="spatautocorr.html#fig:localZvalues">15.6</a>, we do not need to contrast the two estimation methods, and showing the mapped standard deviate is as informative as the “hotspot” status for the chosen adjustment (Figure <a href="spatautocorr.html#fig:localG">15.7</a>). In the case of <span class="math inline">\(G_i\)</span>, the values taken by the measure reflect the values of the input variable, so a “High cluster” is found for observations with high values of the input variable, here high turnout in metropolitan areas.</p>
<p>Very recently, Geoda has been wrapped for R as <strong>rgeoda</strong> <span class="citation">(Li and Anselin <a href="#ref-R-rgeoda">2021</a>)</span>, and will provide very similar functionalities for the exploration of spatial autocorrelation in areal data as <strong>spdep</strong>. The active objects are kept as pointers to a compiled code workspace; using compiled code for all operations (as in Geoda itself) makes <strong>rgeoda</strong> perform fast, but leaves less flexible when modifications or enhancements are desired.</p>
<p>The contiguity neighbours it constructs are the same as those found by <code>poly2nb()</code>, as almost are the <span class="math inline">\(I_i\)</span> measures. The difference is as established by <span class="citation">Bivand and Wong (<a href="#ref-Bivand2018">2018</a>)</span>, that <code>localmoran()</code> calculates the input variable variance divinding by <span class="math inline">\(n\)</span>, but Geoda uses <span class="math inline">\((n-1)\)</span>, as can be reproduced by setting <code>mlvar=FALSE</code>:</p>
<div class="sourceCode" id="cb621"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb621-1" title="1"><span class="kw">library</span>(rgeoda)</a>
<a class="sourceLine" id="cb621-2" title="2"><span class="kw">system.time</span>(Geoda_w &lt;-<span class="st"> </span><span class="kw">queen_weights</span>(pol_pres15))</a></code></pre></div>
<pre><code>#    user  system elapsed 
#   0.103   0.000   0.109</code></pre>
<div class="sourceCode" id="cb623"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb623-1" title="1"><span class="kw">summary</span>(Geoda_w)</a></code></pre></div>
<pre><code>#                      name               value
# 1 number of observations:                2495
# 2          is symmetric:                 TRUE
# 3               sparsity: 0.00228786229774178
# 4        # min neighbors:                   1
# 5        # max neighbors:                  13
# 6       # mean neighbors:    5.70821643286573
# 7     # median neighbors:                   6
# 8           has isolates:               FALSE</code></pre>
<div class="sourceCode" id="cb625"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb625-1" title="1"><span class="kw">system.time</span>(lisa &lt;-<span class="st"> </span><span class="kw">local_moran</span>(Geoda_w, pol_pres15[<span class="st">&quot;I_turnout&quot;</span>], </a>
<a class="sourceLine" id="cb625-2" title="2">    <span class="dt">cpu_threads =</span> <span class="kw">ifelse</span>(parallel<span class="op">::</span><span class="kw">detectCores</span>() <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, parallel<span class="op">::</span><span class="kw">detectCores</span>()<span class="op">-</span>1L),</a>
<a class="sourceLine" id="cb625-3" title="3">    <span class="dt">permutations =</span> <span class="dv">499</span>, <span class="dt">seed =</span> <span class="dv">1</span>))</a></code></pre></div>
<pre><code>#    user  system elapsed 
#   0.333   0.000   0.087</code></pre>
<div class="sourceCode" id="cb627"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb627-1" title="1"><span class="kw">all.equal</span>(<span class="kw">card</span>(nb_q), <span class="kw">lisa_num_nbrs</span>(lisa), <span class="dt">check.attributes =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code># [1] TRUE</code></pre>
<div class="sourceCode" id="cb629"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb629-1" title="1"><span class="kw">all.equal</span>(<span class="kw">lisa_values</span>(lisa), <span class="kw">localmoran</span>(pol_pres15<span class="op">$</span>I_turnout, </a>
<a class="sourceLine" id="cb629-2" title="2">    <span class="dt">listw=</span>lw_q_W, <span class="dt">mlvar =</span> <span class="ot">FALSE</span>)[,<span class="dv">1</span>], <span class="dt">check.attributes =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code># [1] TRUE</code></pre>
</div>
</div>
<div id="exercises-13" class="section level2">
<h2><span class="header-section-number">15.4</span> Exercises</h2>
<ol style="list-style-type: decimal">
<li>Why are join-count measures on a chessboard so different between <code>rook</code> and <code>queen</code> neighbours?</li>
<li>Please repeat the simulation shown in section 15.1 using the chessboard polygons and the row-standardized <code>queen</code> contiguity neighbours. Why is it important to understand that spatial autocorrelation usually signals (unavoidable) mis-specification in our data?</li>
<li>Do we need to use conditional permutation in inference for local measures of spatial autocorrelation?</li>
<li>Why is false discovery rate adjustment recommended for local measures of spatial autocorrelation?</li>
<li>Compare the local Moran’s <span class="math inline">\(I_i\)</span> standard deviate values for the simulated data from exercise 15.2 for the analytical conditional approach, and Saddlepoint approximation. Consider the advantages and disadvantages of the Saddlepoint approximation approach.</li>
</ol>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-anselin:95">
<p>Anselin, L. 1995. “Local indicators of spatial association - LISA.” <em>Geographical Analysis</em> 27 (2): 93–115.</p>
</div>
<div id="ref-anselin:96">
<p>Anselin, L. 1996. “The Moran Scatterplot as an ESDA Tool to Assess Local Instability in Spatial Association.” In <em>Spatial Analytical Perspectives on GIS</em>, edited by M. M. Fischer, H. J. Scholten, and D. Unwin, 111–25. London: Taylor &amp; Francis.</p>
</div>
<div id="ref-assuncao+reis:99">
<p>Assunção, R.M., and E. A. Reis. 1999. “A New Proposal to Adjust Moran’s <span class="math inline">\(I\)</span> for Population Density.” <em>Statistics in Medicine</em> 18: 2147–62.</p>
</div>
<div id="ref-fdr-BH">
<p>Benjamini, Yoav, and Yosef Hochberg. 1995. “Controlling the False Discovery Rate: A Practical and Powerful Approach to Multiple Testing.” <em>Journal of the Royal Statistical Society. Series B (Methodological)</em> 57 (1): 289–300. <a href="https://doi.org/10.1111/j.2517-6161.1995.tb02031.x">https://doi.org/10.1111/j.2517-6161.1995.tb02031.x</a>.</p>
</div>
<div id="ref-10.1214/aos/1013699998">
<p>Benjamini, Yoav, and Daniel Yekutieli. 2001. “The control of the false discovery rate in multiple testing under dependency.” <em>The Annals of Statistics</em> 29 (4): 1165–88. <a href="https://doi.org/10.1214/aos/1013699998">https://doi.org/10.1214/aos/1013699998</a>.</p>
</div>
<div id="ref-R-spdep">
<p>Bivand, Roger. 2021b. <em>Spdep: Spatial Dependence: Weighting Schemes, Statistics</em>. <a href="https://CRAN.R-project.org/package=spdep">https://CRAN.R-project.org/package=spdep</a>.</p>
</div>
<div id="ref-Bivand2018">
<p>Bivand, Roger S., and David W. S. Wong. 2018. “Comparing Implementations of Global and Local Indicators of Spatial Association.” <em>TEST</em> 27 (3): 716–48. <a href="https://doi.org/10.1007/s11749-018-0599-x">https://doi.org/10.1007/s11749-018-0599-x</a>.</p>
</div>
<div id="ref-bivandetal:09">
<p>Bivand, R. S., W. Müller, and M. Reder. 2009. “Power Calculations for Global and Local Moran’s <span class="math inline">\(I\)</span>.” <em>Computational Statistics and Data Analysis</em> 53: 2859–72.</p>
</div>
<div id="ref-BRODY200064">
<p>Brody, Howard, Michael Russell Rip, Peter Vinten-Johansen, Nigel Paneth, and Stephen Rachman. 2000. “Map-Making and Myth-Making in Broad Street: The London Cholera Epidemic, 1854.” <em>The Lancet</em> 356 (9223): 64–68. <a href="https://doi.org/https://doi.org/10.1016/S0140-6736(00)02442-9">https://doi.org/https://doi.org/10.1016/S0140-6736(00)02442-9</a>.</p>
</div>
<div id="ref-cliff+ord:73">
<p>Cliff, A. D., and J. K. Ord. 1973. <em>Spatial Autocorrelation</em>. London: Pion.</p>
</div>
<div id="ref-cliff+ord:81">
<p>Cliff, A. 1981. <em>Spatial Processes</em>. London: Pion.</p>
</div>
<div id="ref-duncanetal61">
<p>Duncan, O. D., R. P. Cuzzort, and B. Duncan. 1961. <em>Statistical Geography: Problems in Analyzing Areal Data</em>. Glencoe, IL: Free Press.</p>
</div>
<div id="ref-geary:54">
<p>Geary, R. C. 1954. “The Contiguity Ratio and Statistical Mapping.” <em>The Incorporated Statistician</em> 5: 115–45.</p>
</div>
<div id="ref-getis+ord:92">
<p>Getis, A., and J. K. Ord. 1992. “The Analysis of Spatial Association by the Use of Distance Statistics.” <em>Geographical Analysis</em> 24 (2): 189–206.</p>
</div>
<div id="ref-getis+ord:96">
<p>Getis, A., and J. K. Ord. 1992. “The Analysis of Spatial Association by the Use of Distance Statistics.” <em>Geographical Analysis</em> 24 (2): 189–206.</p> 1996. “Local Spatial Statistics: An Overview.” In <em>Spatial Analysis: Modelling in a Gis Environment</em>, edited by P. Longley and M Batty, 261–77. Cambridge: GeoInformation International.</p>
</div>
<div id="ref-R-rgeoda">
<p>Li, Xun, and Luc Anselin. 2021. <em>Rgeoda: R Library for Spatial Data Analysis</em>. <a href="https://CRAN.R-project.org/package=rgeoda">https://CRAN.R-project.org/package=rgeoda</a>.</p>
</div>
<div id="ref-McMillen:2003">
<p>McMillen, Daniel P. 2003. “Spatial Autocorrelation or Model Misspecification?” <em>International Regional Science Review</em> 26: 208–17.</p>
</div>
<div id="ref-moran48">
<p>Moran, P. A. P. 1948. “The Interpretation of Statistical Maps.” <em>Journal of the Royal Statistical Society, Series B (Methodological)</em> 10 (2): 243–51.</p>
</div>
<div id="ref-10.2307/143140">
<p>Olsson, Gunnar. 1970. “Explanation, Prediction, and Meaning Variance: An Assessment of Distance Interaction Models.” <em>Economic Geography</em> 46: 223–33. <a href="https://doi.org/10.2307/143140">https://doi.org/10.2307/143140</a>.</p>
</div>
<div id="ref-ord+getis:01">
<p>Ord, J. K., and A. Getis. 2001. “Testing for Local Spatial Autocorrelation in the Presence of Global Autocorrelation.” <em>Journal of Regional Science</em> 41 (3): 411–32.</p>
</div>
<div id="ref-sauer_oshan_rey_wolf_2021">
<p>Sauer, Jeffery, Taylor M Oshan, Sergio Rey, and Levi J Wolf. 2021. “On Null Hypotheses and Heteroskedasticity.” OSF Preprints. <a href="https://doi.org/10.31219/osf.io/ugkhp">https://doi.org/10.31219/osf.io/ugkhp</a>.</p>
</div>
<div id="ref-schabenberger+gotway:2005">
<p>Schabenberger, O., and C. A. Gotway. 2005. <em>Statistical Methods for Spatial Data Analysis</em>. Boca Raton/London: Chapman &amp; Hall/CRC.</p>
</div>
<div id="ref-sokaletal:98">
<p>Sokal, R. R, N. L. Oden, and B. A. Thomson. 1998. “Local Spatial Autocorrelation in a Biological Model.” <em>Geographical Analysis</em> 30: 331–54.</p>
</div>
<div id="ref-tiefelsdorf:02">
<p>Tiefelsdorf, M. 2002. “The Saddlepoint Approximation of Moran’s I and Local Moran’s <span class="math inline">\({I}_i\)</span> Reference Distributions and Their Numerical Evaluation.” <em>Geographical Analysis</em> 34: 187–206.</p>
</div>
<div id="ref-10.2307/143141">
<p>Tobler, W. R. 1970. “A Computer Movie Simulating Urban Growth in the Detroit Region.” <em>Economic Geography</em> 46: 234–40. <a href="https://doi.org/10.2307/143141">https://doi.org/10.2307/143141</a>.</p>
</div>
<div id="ref-upton+fingleton:85">
<p>Upton, G., and B. Fingleton. 1985. <em>Spatial Data Analysis by Example: Point Pattern and Qualitative Data</em>. New York: Wiley.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="area.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="spatglmm.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/edzer/sdsr/edit/master/17-Areal.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
